<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
	 
	 <meta name="description" content="<p>Pure Fortran (2003+) library to write and read data conforming the VTK standard</p>">
    
    <meta name="author" content="Chris MacMackin" >
    <link rel="icon" href="../favicon.png">

    <title>Lib_VTK_IO.f90 &ndash; Lib_VTK_IO</title>

    <link href="../css/bootstrap.min.css" rel="stylesheet">
    <link href="../css/pygments.css" rel="stylesheet">
    <link href="../css/font-awesome.min.css" rel="stylesheet">
    <link href="../css/local.css" rel="stylesheet">
    

    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
      <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
    
    <script src="../js/jquery-2.1.3.min.js"></script>
    <script src="../tipuesearch/tipuesearch_content.js"></script>
    <link  href="../tipuesearch/tipuesearch.css" rel="stylesheet">
    <script src="../tipuesearch/tipuesearch_set.js"></script>
    <script src="../tipuesearch/tipuesearch.js"></script>

  </head>

  <body>

    <!-- Fixed navbar -->
    <nav class="navbar navbar-inverse navbar-fixed-top" role="navigation">
      <div class="container">
        <div class="navbar-header">
          <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
          <a class="navbar-brand" href="../index.html">Lib_VTK_IO </a>
        </div>
        <div id="navbar" class="navbar-collapse collapse">
          <ul class="nav navbar-nav">
            
            <li><a href="../lists/files.html">Source Files</a></li>
				
				
            <li><a href="../lists/modules.html">Modules</a></li>
				
				
            <li><a href="../lists/procedures.html">Procedures</a></li>
				
				
            <li><a href="../lists/types.html">Derived Types</a></li>
				
				
            <li><a href="../program/test_driver.html">Program</a></li>
								
          </ul>
        <form action="../search.html" class="navbar-form navbar-right" role="search">
        <div class="form-group">
          <input type="text" class="form-control" placeholder="Search" name="q" id="tipue_search_input" autocomplete="off" required>
        </div>
<!--
        <button type="submit" class="btn btn-default">Submit</button>
-->
        </form>
        </div><!--/.nav-collapse -->
      </div>
    </nav>

    <div class="container">
    
  
  <div class="row">
    <h1>Lib_VTK_IO.f90
    <small>Source File</small>
    
    </h1>
	 
<div class="row">
<div class="col-lg-7">
<div class="well well-sm">
  <ul class="list-inline" style="margin-bottom:0px">
     
     
     
     
    
    
    <li><i class="fa fa-code"></i><a href="../src/Lib_VTK_IO.f90"> Source File</a></li>
     
  </ul>
  </div>
  </div>
  <div class="col-lg-5">
  <ol class="breadcrumb hierarchy text-right">
  
     <li class="active">Lib_VTK_IO.f90</li>
  </ol>
  </div>
</div>
    
  </div>
  <div class="row">
    <div class="col-lg-3">
    
  
  
  
  
  <div class="panel panel-primary">
    <div class="panel-heading text-left"><h3 class="panel-title">Modules</h3></div>
    <div class="list-group">
      
      <a class="list-group-item" href="../sourcefile/lib_vtk_io.f90.html#mod-Lib_VTK_IO">Lib_VTK_IO</a>
      
    </div>
  </div>
  
  
  
  
  
  
  
  
  <hr>
  
  <div class="panel panel-default">
    <div class="panel-heading text-left"><h3 class="panel-title">All Source Files</h3></div>
    <div class="list-group">
      
      <a class="list-group-item" href="../sourcefile/ir_precision.f90.html">IR_Precision.f90</a>
      
      <a class="list-group-item" href="../sourcefile/lib_base64.f90.html">Lib_Base64.f90</a>
      
      <a class="list-group-item" href="../sourcefile/lib_vtk_io.f90.html">Lib_VTK_IO.f90</a>
      
      <a class="list-group-item" href="../sourcefile/test_driver.f90.html">Test_Driver.f90</a>
      
    </div>
  </div>
  
  
    </div>
    <div class="col-lg-9" id='text'>
    
    
    <div class="highlight"><pre><span class="c">!&gt; @addtogroup PrivateVarPar Private Variables and Parameters</span>
<span class="c">!&gt; List of private variables and parameters.</span>
<span class="c">!&gt; @addtogroup Interface Interfaces</span>
<span class="c">!&gt; List of explicitly defined interface.</span>
<span class="c">!&gt; @addtogroup Library Modules Libraries</span>
<span class="c">!&gt; List of modules containing libraries of procedures.</span>
<span class="c">!&gt; @addtogroup PublicProcedure Public Procedures</span>
<span class="c">!&gt; List of public procedures.</span>
<span class="c">!&gt; @addtogroup PrivateProcedure Private Procedures</span>
<span class="c">!&gt; List of private procedures.</span>

<span class="c">!&gt; @ingroup Library</span>
<span class="c">!&gt; @{</span>
<span class="c">!&gt; @defgroup Lib_VTK_IOLibrary Lib_VTK_IO</span>
<span class="c">!&gt; @}</span>

<span class="c">!&gt; @ingroup Interface</span>
<span class="c">!&gt; @{</span>
<span class="c">!&gt; @defgroup Lib_VTK_IOInterface Lib_VTK_IO</span>
<span class="c">!&gt; @}</span>

<span class="c">!&gt; @ingroup PrivateVarPar</span>
<span class="c">!&gt; @{</span>
<span class="c">!&gt; @defgroup Lib_VTK_IOPrivateVarPar Lib_VTK_IO</span>
<span class="c">!&gt; @}</span>

<span class="c">!&gt; @ingroup PublicProcedure</span>
<span class="c">!&gt; @{</span>
<span class="c">!&gt; @defgroup Lib_VTK_IOPublicProcedure Lib_VTK_IO</span>
<span class="c">!&gt; @}</span>

<span class="c">!&gt; @ingroup PrivateProcedure</span>
<span class="c">!&gt; @{</span>
<span class="c">!&gt; @defgroup Lib_VTK_IOPrivateProcedure Lib_VTK_IO</span>
<span class="c">!&gt; @}</span>

<span class="c">!&gt; @brief   This is a library of functions for Input and Output pure Fortran data in VTK format.</span>
<span class="c">!&gt; @details It is useful for Paraview visualization tool. Even though there are many wrappers/porting of the VTK source</span>
<span class="c">!&gt;          code (C++ code), there is not a Fortran one. This library is not a porting or a wrapper of the VTK code,</span>
<span class="c">!&gt;          but it only an exporter/importer of the VTK data format written in pure Fortran language (standard Fortran 2003 or</span>
<span class="c">!&gt;          higher) that can be used by Fortran coders (yes, there are still a lot of these brave coders...) without mixing Fortran</span>
<span class="c">!&gt;          with C++ language. Fortran is still the best language for high performance computing for scientific purpose, like CFD</span>
<span class="c">!&gt;          computing. It is necessary a tool to deal with VTK standard directly by Fortran code. The library was made to fill</span>
<span class="c">!&gt;          this empty: it is a simple Fortran module able to export native Fortran data into VTK data format and to import VTK</span>
<span class="c">!&gt;          data into a Fortran code, both in ascii and binary file format.</span>
<span class="c">!&gt;</span>
<span class="c">!&gt;          The library provides an automatic way to deal with VTK data format: all the formatting processes is nested into the</span>
<span class="c">!&gt;          library and users communicate with it by a simple API passing only native Fortran data (Fortran scalars and arrays).</span>
<span class="c">!&gt;</span>
<span class="c">!&gt;          The library is still in developing and testing, this is first usable release, but there are not all the features of</span>
<span class="c">!&gt;          the stable release (the importer is totally absent and the exporter is not complete). Surely there are a lot of bugs</span>
<span class="c">!&gt;          and the programming style is not the best, but the exporters are far-complete.</span>
<span class="c">!&gt;</span>
<span class="c">!&gt;          The supported VTK features are:</span>
<span class="c">!&gt;          - Exporters:</span>
<span class="c">!&gt;            - Legacy standard:</span>
<span class="c">!&gt;              - Structured Points;</span>
<span class="c">!&gt;              - Structured Grid;</span>
<span class="c">!&gt;              - Unstructured Grid;</span>
<span class="c">!&gt;              - Polydata (\b missing);</span>
<span class="c">!&gt;              - Rectilinear Grid;</span>
<span class="c">!&gt;              - Field (\b missing);</span>
<span class="c">!&gt;            - XML standard:</span>
<span class="c">!&gt;              - serial dataset:</span>
<span class="c">!&gt;                - Image Data (\b missing);</span>
<span class="c">!&gt;                - Polydata (\b missing);</span>
<span class="c">!&gt;                - Rectilinear Grid;</span>
<span class="c">!&gt;                - Structured Grid;</span>
<span class="c">!&gt;                - Unstructured Grid;</span>
<span class="c">!&gt;              - parallel (partitioned) dataset:</span>
<span class="c">!&gt;                - Image Data (\b missing);</span>
<span class="c">!&gt;                - Polydata (\b missing);</span>
<span class="c">!&gt;                - Rectilinear Grid;</span>
<span class="c">!&gt;                - Structured Grid;</span>
<span class="c">!&gt;                - Unstructured Grid;</span>
<span class="c">!&gt;              - composite dataset:</span>
<span class="c">!&gt;                - vtkMultiBlockDataSet;</span>
<span class="c">!&gt;          - Importers are \b missing.</span>
<span class="c">!&gt;</span>
<span class="c">!&gt;          @libvtk can handle multiple concurrent files and it is \b thread/processor-safe (meaning that can be safely used into</span>
<span class="c">!&gt;          parallel frameworks as OpenMP or MPI, see \ref SpeedUP &quot;Parallel Frameworks Benchmarks&quot;).</span>
<span class="c">!&gt;</span>
<span class="c">!&gt;          The library is an open source project, it is distributed under the GPL v3. Anyone is interest to use, to develop or</span>
<span class="c">!&gt;          to contribute to @libvtk is welcome.</span>
<span class="c">!&gt;</span>
<span class="c">!&gt;          It can be found at: https://github.com/szaghi/Lib_VTK_IO</span>
<span class="c">!&gt;</span>
<span class="c">!&gt; @par VTK_Standard</span>
<span class="c">!&gt;      VTK, Visualization Toolkit, is an open source software that provides a powerful framework for the computer graphic, for</span>
<span class="c">!&gt;      the images processing and for 3D rendering. It is widely used in the world and so it has a very large community of users,</span>
<span class="c">!&gt;      besides the Kitware (The Kitware homepage can be found here: http://public.kitware.com) company provides professional</span>
<span class="c">!&gt;      support. The toolkit is written in C++ and a lot of porting/wrappers for Tcl/Tk, Java and Python are provided, unlucky</span>
<span class="c">!&gt;      there aren&#39;t wrappers for Fortran.</span>
<span class="c">!&gt;</span>
<span class="c">!&gt;      Because of its good features the VTK toolkit has been used to develop a large set of open source programs. For my work</span>
<span class="c">!&gt;      the most important family of programs is the scientific visualization programs. A lot of high-quality scientific</span>
<span class="c">!&gt;      visualization tool are available on the web but for me the best is ParaView: I think that it is one of the best</span>
<span class="c">!&gt;      scientific visualization program in the world and it is open source! Paraview is based on VTK.</span>
<span class="c">!&gt; @par Paraview</span>
<span class="c">!&gt;      ParaView (The ParaView homepage can be found here: http://www.paraview.org) is an open source software voted to scientific</span>
<span class="c">!&gt;      visualization and able to use the power of parallel architectures. It has an architecture client-server in order to make</span>
<span class="c">!&gt;      easy the remote visualization of very large set of data. Because it is based on VTK it inherits all VTK features. ParaView</span>
<span class="c">!&gt;      is very useful for Computational Fluid Dynamics visualizations because it provides powerful post-processing tools, it</span>
<span class="c">!&gt;      provides a very large set of importers for the most used format like Plot3D and HDF (the list is very large). It is easy to</span>
<span class="c">!&gt;      extend ParaView because it supports all the scripting language supported by VTK.</span>
<span class="c">!&gt; @note All the @libvtk functions are &lt;b&gt;I4P integer functions&lt;/b&gt;: the returned integer output is 0 if the function calling has</span>
<span class="c">!&gt; been completed right while it is &gt;0  if some errors occur (the error handling is only at its embryonic phase). Therefore the</span>
<span class="c">!&gt; functions calling must be done in the following way: \n</span>
<span class="c">!&gt; @code</span>
<span class="c">!&gt; ...</span>
<span class="c">!&gt; integer(I4P):: E_IO</span>
<span class="c">!&gt; ...</span>
<span class="c">!&gt; E_IO = VTK_INI(....</span>
<span class="c">!&gt; ... @endcode</span>
<span class="c">!&gt; @libvtk programming style is based on two main principles: &lt;em&gt;portable kind-precision&lt;/em&gt; of reals and integers</span>
<span class="c">!&gt; variables and &lt;em&gt;dynamic dispatching&lt;/em&gt;. Using &lt;em&gt;dynamic dispatching&lt;/em&gt; @libvtk has a simple API. The user calls</span>
<span class="c">!&gt; a generic procedure (VTK_INI, VTK_GEO,...) and the library, depending on the type and number of the inputs passed, calls the</span>
<span class="c">!&gt; correct internal function (i.e. VTK_GEO for R8P real type if the input passed is R8P real type). By this interface only few</span>
<span class="c">!&gt; functions are used without the necessity of calling a different function for each different input type.</span>
<span class="c">!&gt; Dynamic dispatching is based on the internal kind-precision/rank selecting convention: Fortran 90/95 standard has introduced some</span>
<span class="c">!&gt; useful functions to achieve the portability of reals and integers precision and @libvtk uses these functions to define portable</span>
<span class="c">!&gt; kind-precision; to this aim @libvtk uses IR_Precision module.</span>
<span class="c">!&gt; @author    Stefano Zaghi</span>
<span class="c">!&gt; @version   1.1</span>
<span class="c">!&gt; @date      2013-05-23</span>
<span class="c">!&gt; @par News</span>
<span class="c">!&gt; - Added packed API and 3D(or higher) arrays for VTK_VAR_XML function: this avoids the necessity of explicit reshape of</span>
<span class="c">!&gt;   multi-dimensional arrays containing saved variables in VAR callings; the following inputs are now available:</span>
<span class="c">!&gt;   - scalar input:</span>
<span class="c">!&gt;     - input is 1D-rank array: var[1:NC_NN];</span>
<span class="c">!&gt;     - input is 3D-rank array: var[nx1:nx2,ny1:ny2,nz1:nz2];</span>
<span class="c">!&gt;   - vectorial inputs:</span>
<span class="c">!&gt;     - inputs are 1D-rank arrays: varX[1:NC_NN],varY[1:NC_NN],varZ[1:NC_NN];</span>
<span class="c">!&gt;     - inputs are 3D-rank arrays: varX[nx1:nx2,ny1:ny2,nz1:nz2],varY[nx1:nx2,ny1:ny2,nz1:nz2],varX[nx1:nx2,ny1:ny2,nz1:nz2];</span>
<span class="c">!&gt;   - 3D(or higher) vectorial inputs:</span>
<span class="c">!&gt;     - input is 1D-rank (packed API): var[1:N_COL,1:NC_NN];</span>
<span class="c">!&gt;     - input is 3D-rank (packed API): var[1:N_COL,nx1:nx2,ny1:ny2,nz1:nz2].</span>
<span class="c">!&gt; - Added packed API and 3D arrays for VTK_GEO and VTK_GEO_XML function: this avoids the necessity of explicit reshape of</span>
<span class="c">!&gt;   multi-dimensional arrays containing X, Y and Z coordinates in GEO callings; the following inputs are now available:</span>
<span class="c">!&gt;   - StructuredGrid (NN is the number of grid points, n\#1-n\#2, \#x,y,z are the domain extents):</span>
<span class="c">!&gt;     - 1D arrays of size NN: X[1:NN],Y[1:NN],Z[1:NN];</span>
<span class="c">!&gt;     - 3D arrays of size NN: X[nx1:nx2,ny1:ny2,nz1:nz2],Y[nx1:nx2,ny1:ny2,nz1:nz2],Z[nx1:nx2,ny1:ny2,nz1:nz2];</span>
<span class="c">!&gt;     - 1D array of size 3*NN (packed API): XYZ[1:3,1:NN];</span>
<span class="c">!&gt;     - 3D array of size 3*NN (packed API): XYZ[1:3,nx1:nx2,ny1:ny2,nz1:nz2].</span>
<span class="c">!&gt;   - UnStructuredGrid (NN is the number of grid points):</span>
<span class="c">!&gt;     - 1D arrays of size NN: X[1:NN],Y[1:NN],Z[1:NN];</span>
<span class="c">!&gt;     - 1D array of size 3*NN (packed API): XYZ[1:3,1:NN].</span>
<span class="c">!&gt; - Added base64 encoding format: the output format specifier of VTK_INI_XML has been changed:</span>
<span class="c">!&gt;   - output_format = &#39;ascii&#39; means \b ascii data, the same as the previous version;</span>
<span class="c">!&gt;   - output_format = &#39;binary&#39; means \b base64 encoded data, different from the previous version where it meant appended</span>
<span class="c">!&gt;     raw-binary data; base64 encoding was missing in the previous version;</span>
<span class="c">!&gt;   - output_format = &#39;raw&#39; means \b appended \b raw-binary data, as &#39;binary&#39; of the previous version;</span>
<span class="c">!&gt; - Added support for OpenMP multi-threads framework;</span>
<span class="c">!&gt; - Correct bug affecting binary output;</span>
<span class="c">!&gt; - implement concurrent multiple files IO capability;</span>
<span class="c">!&gt; - implement FieldData tag for XML files, useful for tagging dataset with global auxiliary data, e.g. time, time step, ecc;</span>
<span class="c">!&gt; - implement Parallel (Partitioned) XML files support (.pvtu,.pvts,.pvtr);</span>
<span class="c">!&gt; - implement Driver testing program for providing practical examples of @libvtk usage;</span>
<span class="c">!&gt; - added support for parallel framework, namely OpenMP (thread-safe) and MPI (process-safe).</span>
<span class="c">!&gt; @copyright GNU Public License version 3.</span>
<span class="c">!&gt; @note The supported compilers are GNU gfortran 4.7.x (or higher) and Intel Fortran 12.x (or higher). @libvtk needs a modern</span>
<span class="c">!&gt; compiler providing support for some Fortran standard 2003 features.</span>
<span class="c">!&gt; @todo \b CompleteExporter: Complete the exporters</span>
<span class="c">!&gt; @todo \b CompleteImporter: Complete the importers</span>
<span class="c">!&gt; @todo \b DocExamples: Complete the documentation of examples</span>
<span class="c">!&gt; @todo \b g95_test: Test g95 compiler</span>
<span class="c">!&gt; @bug &lt;b&gt;XML-Efficiency&lt;/b&gt;: \n This is not properly a bug. There is an inefficiency when saving XML raw (binary) file. To write</span>
<span class="c">!&gt;                             raw data into XML file @libvtk uses a temporary scratch file to save binary data while saving all</span>
<span class="c">!&gt;                             formatting data to the final XML file. Only when all XML formatting data have been written the</span>
<span class="c">!&gt;                             scratch file is rewind and the binary data is saved in the final tag of XML file as \b raw</span>
<span class="c">!&gt;                             \b appended data. This approach is not efficient.</span>
<span class="c">!&gt; @ingroup Lib_VTK_IOLibrary</span>
<span class="k">module </span><span class="n">Lib_VTK_IO</span>
<span class="c">!-----------------------------------------------------------------------------------------------------------------------------------</span>
<span class="k">USE </span><span class="n">IR_Precision</span>                                                                <span class="c">! Integers and reals precision definition.</span>
<span class="k">USE </span><span class="n">Lib_Base64</span>                                                                  <span class="c">! Base64 encoding/decoding procedures.</span>
<span class="k">USE</span><span class="p">,</span> <span class="k">intrinsic</span><span class="kd">::</span> <span class="n">ISO_FORTRAN_ENV</span><span class="p">,</span> <span class="n">only</span><span class="p">:</span> <span class="n">stdout</span><span class="o">=&gt;</span><span class="n">OUTPUT_UNIT</span><span class="p">,</span> <span class="n">stderr</span><span class="o">=&gt;</span><span class="n">ERROR_UNIT</span> <span class="c">! Standard output/error logical units.</span>
<span class="c">!-----------------------------------------------------------------------------------------------------------------------------------</span>

<span class="c">!-----------------------------------------------------------------------------------------------------------------------------------</span>
<span class="k">implicit none</span>
<span class="k">private</span>
<span class="k">save</span>
<span class="c">! functions for VTK XML</span>
<span class="k">public</span><span class="kd">::</span> <span class="n">VTK_INI_XML</span>
<span class="k">public</span><span class="kd">::</span> <span class="n">VTK_FLD_XML</span>
<span class="k">public</span><span class="kd">::</span> <span class="n">VTK_GEO_XML</span>
<span class="k">public</span><span class="kd">::</span> <span class="n">VTK_CON_XML</span>
<span class="k">public</span><span class="kd">::</span> <span class="n">VTK_DAT_XML</span>
<span class="k">public</span><span class="kd">::</span> <span class="n">VTK_VAR_XML</span>
<span class="k">public</span><span class="kd">::</span> <span class="n">VTK_END_XML</span>
<span class="c">! functions for VTM XML</span>
<span class="k">public</span><span class="kd">::</span> <span class="n">VTM_INI_XML</span>
<span class="k">public</span><span class="kd">::</span> <span class="n">VTM_BLK_XML</span>
<span class="k">public</span><span class="kd">::</span> <span class="n">VTM_WRF_XML</span>
<span class="k">public</span><span class="kd">::</span> <span class="n">VTM_END_XML</span>
<span class="c">! functions for PVTK XML</span>
<span class="k">public</span><span class="kd">::</span> <span class="n">PVTK_INI_XML</span>
<span class="k">public</span><span class="kd">::</span> <span class="n">PVTK_GEO_XML</span>
<span class="k">public</span><span class="kd">::</span> <span class="n">PVTK_DAT_XML</span>
<span class="k">public</span><span class="kd">::</span> <span class="n">PVTK_VAR_XML</span>
<span class="k">public</span><span class="kd">::</span> <span class="n">PVTK_END_XML</span>
<span class="c">! functions for VTK LEGACY</span>
<span class="k">public</span><span class="kd">::</span> <span class="n">VTK_INI</span>
<span class="k">public</span><span class="kd">::</span> <span class="n">VTK_GEO</span>
<span class="k">public</span><span class="kd">::</span> <span class="n">VTK_CON</span>
<span class="k">public</span><span class="kd">::</span> <span class="n">VTK_DAT</span>
<span class="k">public</span><span class="kd">::</span> <span class="n">VTK_VAR</span>
<span class="k">public</span><span class="kd">::</span> <span class="n">VTK_END</span>
<span class="c">!-----------------------------------------------------------------------------------------------------------------------------------</span>

<span class="c">!-----------------------------------------------------------------------------------------------------------------------------------</span>
<span class="c">!&gt; @brief Function for saving field data (global auxiliary data, eg time, step number, dataset name, etc).</span>
<span class="c">!&gt; VTK_FLD_XML is an interface to 7 different functions, there are 2 functions for real field data, 4 functions for integer one</span>
<span class="c">!&gt; and one function for open and close field data tag.</span>
<span class="c">!&gt; @remark VTK_FLD_XML must be called after VTK_INI_XML and before VTK_GEO_XML. It must always called three times at least: 1) for</span>
<span class="c">!&gt; opening the FieldData tag, 2) for saving at least one FieldData entry and 3) for closing the FieldData tag.</span>
<span class="c">!&gt; Examples of usage are: \n</span>
<span class="c">!&gt; \b saving the time and step cicle counter of current dataset: \n</span>
<span class="c">!&gt; @code ...</span>
<span class="c">!&gt; real(R8P)::    time</span>
<span class="c">!&gt; integer(I4P):: step</span>
<span class="c">!&gt; ...</span>
<span class="c">!&gt; E_IO=VTK_FLD_XML(fld_action=&#39;open&#39;)</span>
<span class="c">!&gt; E_IO=VTK_FLD_XML(fld=time,fname=&#39;TIME&#39;)</span>
<span class="c">!&gt; E_IO=VTK_FLD_XML(fld=step,fname=&#39;CYCLE&#39;)</span>
<span class="c">!&gt; E_IO=VTK_FLD_XML(fld_action=&#39;close&#39;)</span>
<span class="c">!&gt; ... @endcode</span>
<span class="c">!&gt; @ingroup Lib_VTK_IOInterface</span>
<span class="k">interface </span><span class="n">VTK_FLD_XML</span>
  <span class="k">module procedure </span><span class="n">VTK_FLD_XML_OC</span><span class="p">,</span> <span class="p">&amp;</span> <span class="c">! open/close field data tag</span>
                   <span class="n">VTK_FLD_XML_R8</span><span class="p">,</span> <span class="p">&amp;</span> <span class="c">! real(R8P)    scalar</span>
                   <span class="n">VTK_FLD_XML_R4</span><span class="p">,</span> <span class="p">&amp;</span> <span class="c">! real(R4P)    scalar</span>
                   <span class="n">VTK_FLD_XML_I8</span><span class="p">,</span> <span class="p">&amp;</span> <span class="c">! integer(I8P) scalar</span>
                   <span class="n">VTK_FLD_XML_I4</span><span class="p">,</span> <span class="p">&amp;</span> <span class="c">! integer(I4P) scalar</span>
                   <span class="n">VTK_FLD_XML_I2</span><span class="p">,</span> <span class="p">&amp;</span> <span class="c">! integer(I2P) scalar</span>
                   <span class="n">VTK_FLD_XML_I1</span>    <span class="c">! integer(I1P) scalar</span>
<span class="n">endinterface</span>
<span class="c">!&gt; @brief Function for saving mesh with different topologies in VTK-XML standard.</span>
<span class="c">!&gt; VTK_GEO_XML is an interface to 15 different functions; there are 2 functions for each of 3 topologies supported and a function</span>
<span class="c">!&gt; for closing XML pieces: one function for mesh coordinates with R8P precision and one for mesh coordinates with R4P precision.</span>
<span class="c">!&gt; @remark 1D/3D-rank arrays and packed API for any kinds \n</span>
<span class="c">!&gt; - For StructuredGrid there are 4 functions for each real kinds:</span>
<span class="c">!&gt;   - inputs are 1D-rank arrays: X[1:NN],Y[1:NN],Z[1:NN];</span>
<span class="c">!&gt;   - inputs are 3D-rank arrays: X[nx1:nx2,ny1:ny2,nz1:nz2],Y[nx1:nx2,ny1:ny2,nz1:nz2],Z[nx1:nx2,ny1:ny2,nz1:nz2];</span>
<span class="c">!&gt;   - input is 1D-rank array (packed API): XYZ[1:3,1:NN];</span>
<span class="c">!&gt;   - input is 3D-rank array (packed API): XYZ[1:3,nx1:nx2,ny1:ny2,nz1:nz2].</span>
<span class="c">!&gt; - For UnStructuredGrid there are 2 functions for each real kinds:</span>
<span class="c">!&gt;   - inputs are 1D arrays: X[1:NN],Y[1:NN],Z[1:NN];</span>
<span class="c">!&gt;   - input is 1D array (packed API): XYZ[1:3,1:NN].</span>
<span class="c">!&gt;</span>
<span class="c">!&gt; @remark VTK_GEO_XML must be called after VTK_INI_XML. It saves the mesh geometry. The inputs that must be passed</span>
<span class="c">!&gt; change depending on the topologies chosen. Not all VTK topologies have been implemented (\em polydata topologies are absent).</span>
<span class="c">!&gt; @note The XML standard is more powerful than legacy. XML file can contain more than 1 mesh with its</span>
<span class="c">!&gt; associated variables. Thus there is the necessity to close each \em pieces that compose the data-set saved in the</span>
<span class="c">!&gt; XML file. The VTK_GEO_XML called in the &lt;em&gt;close piece&lt;/em&gt; format is used just to close the</span>
<span class="c">!&gt; current piece before saving another piece or closing the file. \n</span>
<span class="c">!&gt; Examples of usage are: \n</span>
<span class="c">!&gt; \b Structured grid calling: \n</span>
<span class="c">!&gt; @code ...</span>
<span class="c">!&gt; integer(I4P):: nx1,nx2,ny1,ny2,nz1,nz2,NN</span>
<span class="c">!&gt; real(R8P)::    X(1:NN),Y(1:NN),Z(1:NN)</span>
<span class="c">!&gt; ...</span>
<span class="c">!&gt; E_IO=VTK_GEO_XML(nx1,nx2,ny1,ny2,nz1,nz2,Nn,X,Y,Z)</span>
<span class="c">!&gt; ... @endcode</span>
<span class="c">!&gt; \b Rectilinear grid calling: \n</span>
<span class="c">!&gt; @code ...</span>
<span class="c">!&gt; integer(I4P):: nx1,nx2,ny1,ny2,nz1,nz2</span>
<span class="c">!&gt; real(R8P)::    X(nx1:nx2),Y(ny1:ny2),Z(nz1:nz2)</span>
<span class="c">!&gt; ...</span>
<span class="c">!&gt; E_IO=VTK_GEO_XML(nx1,nx2,ny1,ny2,nz1,nz2,X,Y,Z)</span>
<span class="c">!&gt; ... @endcode</span>
<span class="c">!&gt; \b Unstructured grid calling: \n</span>
<span class="c">!&gt; @code ...</span>
<span class="c">!&gt; integer(I4P):: Nn,Nc</span>
<span class="c">!&gt; real(R8P)::    X(1:Nn),Y(1:Nn),Z(1:Nn)</span>
<span class="c">!&gt; ...</span>
<span class="c">!&gt; E_IO=VTK_GEO_XML(Nn,Nc,X,Y,Z)</span>
<span class="c">!&gt; ... @endcode</span>
<span class="c">!&gt; \b Closing piece calling: 1n</span>
<span class="c">!&gt; @code ...</span>
<span class="c">!&gt; E_IO=VTK_GEO_XML()</span>
<span class="c">!&gt; ... @endcode</span>
<span class="c">!&gt; @ingroup Lib_VTK_IOInterface</span>
<span class="k">interface </span><span class="n">VTK_GEO_XML</span>
  <span class="k">module procedure </span><span class="n">VTK_GEO_XML_STRG_1DA_R8</span><span class="p">,</span> <span class="n">VTK_GEO_XML_STRG_3DA_R8</span><span class="p">,</span>  <span class="p">&amp;</span> <span class="c">! real(R8P) StructuredGrid, 1D/3D Arrays</span>
                   <span class="n">VTK_GEO_XML_STRG_1DAP_R8</span><span class="p">,</span><span class="n">VTK_GEO_XML_STRG_3DAP_R8</span><span class="p">,</span> <span class="p">&amp;</span> <span class="c">! real(R8P) StructuredGrid, 1D/3D Arrays packed API</span>
                   <span class="n">VTK_GEO_XML_STRG_1DA_R4</span><span class="p">,</span> <span class="n">VTK_GEO_XML_STRG_3DA_R4</span><span class="p">,</span>  <span class="p">&amp;</span> <span class="c">! real(R4P) StructuredGrid, 1D/3D Arrays</span>
                   <span class="n">VTK_GEO_XML_STRG_1DAP_R4</span><span class="p">,</span><span class="n">VTK_GEO_XML_STRG_3DAP_R4</span><span class="p">,</span> <span class="p">&amp;</span> <span class="c">! real(R4P) StructuredGrid, 1D/3D Arrays packed API</span>
                   <span class="n">VTK_GEO_XML_RECT_R8</span><span class="p">,</span>                               <span class="p">&amp;</span> <span class="c">! real(R8P) RectilinearGrid</span>
                   <span class="n">VTK_GEO_XML_RECT_R4</span><span class="p">,</span>                               <span class="p">&amp;</span> <span class="c">! real(R4P) RectilinearGrid</span>
                   <span class="n">VTK_GEO_XML_UNST_R8</span><span class="p">,</span><span class="n">VTK_GEO_XML_UNST_PACK_R4</span><span class="p">,</span>      <span class="p">&amp;</span> <span class="c">! real(R8P) UnstructuredGrid, standard and packed API</span>
                   <span class="n">VTK_GEO_XML_UNST_R4</span><span class="p">,</span><span class="n">VTK_GEO_XML_UNST_PACK_R8</span><span class="p">,</span>      <span class="p">&amp;</span> <span class="c">! real(R4P) UnstructuredGrid, standard and packed API</span>
                   <span class="n">VTK_GEO_XML_CLOSEP</span>                                   <span class="c">! closing tag &quot;Piece&quot; function</span>
<span class="n">endinterface</span>
<span class="c">!&gt; @brief Function for saving data variable(s) in VTK-XML standard.</span>
<span class="c">!&gt; VTK_VAR_XML is an interface to 36 different functions, there are 6 functions for scalar variables, 6 functions for vectorial</span>
<span class="c">!&gt; variables and 6 functions for 3D(or higher) vectorial variables: for all of types the precision can be R8P, R4P, I8P, I4P, I2P</span>
<span class="c">!&gt; and I1P. This function saves the data variables related (cell-centered or node-centered) to geometric mesh.</span>
<span class="c">!&gt; @remark 1D/3D-rank arrays and packed API for any kinds \n</span>
<span class="c">!&gt; The inputs arrays can be passed as 1D-rank or 3D-rank and the vectorial variables can be component-separated (one for each of</span>
<span class="c">!&gt; the 3 components) or packed into one multidimensional array:</span>
<span class="c">!&gt; - scalar input:</span>
<span class="c">!&gt;   - input is 1D-rank array: var[1:NC_NN];</span>
<span class="c">!&gt;   - input is 3D-rank array: var[nx1:nx2,ny1:ny2,nz1:nz2];</span>
<span class="c">!&gt; - vectorial inputs:</span>
<span class="c">!&gt;   - inputs are 1D-rank arrays: varX[1:NC_NN],varY[1:NC_NN],varZ[1:NC_NN];</span>
<span class="c">!&gt;   - inputs are 3D-rank arrays: varX[nx1:nx2,ny1:ny2,nz1:nz2],varY[nx1:nx2,ny1:ny2,nz1:nz2],varX[nx1:nx2,ny1:ny2,nz1:nz2];</span>
<span class="c">!&gt; - 3D(or higher) vectorial inputs:</span>
<span class="c">!&gt;   - input is 1D-rank (packed API): var[1:N_COL,1:NC_NN];</span>
<span class="c">!&gt;   - input is 3D-rank (packed API): var[1:N_COL,nx1:nx2,ny1:ny2,nz1:nz2].</span>
<span class="c">!&gt;</span>
<span class="c">!&gt; @remark Note that the inputs that must be passed change depending on the data variables type.</span>
<span class="c">!&gt;</span>
<span class="c">!&gt; @note Examples of usage are: \n</span>
<span class="c">!&gt; \b Scalar data calling: \n</span>
<span class="c">!&gt; @code ...</span>
<span class="c">!&gt; integer(I4P):: NN</span>
<span class="c">!&gt; real(R8P)::    var(1:NN)</span>
<span class="c">!&gt; ...</span>
<span class="c">!&gt; E_IO=VTK_VAR_XML(NN,&#39;Sca&#39;,var)</span>
<span class="c">!&gt; ... @endcode</span>
<span class="c">!&gt; \b Vectorial data calling: \n</span>
<span class="c">!&gt; @code ...</span>
<span class="c">!&gt; integer(I4P):: NN</span>
<span class="c">!&gt; real(R8P)::    varX(1:NN),varY(1:NN),varZ(1:NN),</span>
<span class="c">!&gt; ...</span>
<span class="c">!&gt; E_IO=VTK_VAR_XML(NN,&#39;Vec&#39;,varX,varY,varZ)</span>
<span class="c">!&gt; ... @endcode</span>
<span class="c">!&gt; @ingroup Lib_VTK_IOInterface</span>
<span class="k">interface </span><span class="n">VTK_VAR_XML</span>
  <span class="k">module procedure </span><span class="n">VTK_VAR_XML_SCAL_1DA_R8</span><span class="p">,</span><span class="n">VTK_VAR_XML_SCAL_3DA_R8</span><span class="p">,</span> <span class="p">&amp;</span> <span class="c">! real(R8P)    scalar    1D/3D array</span>
                   <span class="n">VTK_VAR_XML_SCAL_1DA_R4</span><span class="p">,</span><span class="n">VTK_VAR_XML_SCAL_3DA_R4</span><span class="p">,</span> <span class="p">&amp;</span> <span class="c">! real(R4P)    scalar    1D/3D array</span>
                   <span class="n">VTK_VAR_XML_SCAL_1DA_I8</span><span class="p">,</span><span class="n">VTK_VAR_XML_SCAL_3DA_I8</span><span class="p">,</span> <span class="p">&amp;</span> <span class="c">! integer(I8P) scalar    1D/3D array</span>
                   <span class="n">VTK_VAR_XML_SCAL_1DA_I4</span><span class="p">,</span><span class="n">VTK_VAR_XML_SCAL_3DA_I4</span><span class="p">,</span> <span class="p">&amp;</span> <span class="c">! integer(I4P) scalar    1D/3D array</span>
                   <span class="n">VTK_VAR_XML_SCAL_1DA_I2</span><span class="p">,</span><span class="n">VTK_VAR_XML_SCAL_3DA_I2</span><span class="p">,</span> <span class="p">&amp;</span> <span class="c">! integer(I2P) scalar    1D/3D array</span>
                   <span class="n">VTK_VAR_XML_SCAL_1DA_I1</span><span class="p">,</span><span class="n">VTK_VAR_XML_SCAL_3DA_I1</span><span class="p">,</span> <span class="p">&amp;</span> <span class="c">! integer(I1P) scalar    1D/3D array</span>
                   <span class="n">VTK_VAR_XML_VECT_1DA_R8</span><span class="p">,</span><span class="n">VTK_VAR_XML_VECT_3DA_R8</span><span class="p">,</span> <span class="p">&amp;</span> <span class="c">! real(R8P)    vectorial 1D/3D arrays</span>
                   <span class="n">VTK_VAR_XML_VECT_1DA_R4</span><span class="p">,</span><span class="n">VTK_VAR_XML_VECT_3DA_R4</span><span class="p">,</span> <span class="p">&amp;</span> <span class="c">! real(R4P)    vectorial 1D/3D arrays</span>
                   <span class="n">VTK_VAR_XML_VECT_1DA_I8</span><span class="p">,</span><span class="n">VTK_VAR_XML_VECT_3DA_I8</span><span class="p">,</span> <span class="p">&amp;</span> <span class="c">! integer(I8P) vectorial 1D/3D arrays</span>
                   <span class="n">VTK_VAR_XML_VECT_1DA_I4</span><span class="p">,</span><span class="n">VTK_VAR_XML_VECT_3DA_I4</span><span class="p">,</span> <span class="p">&amp;</span> <span class="c">! integer(I4P) vectorial 1D/3D arrays</span>
                   <span class="n">VTK_VAR_XML_VECT_1DA_I2</span><span class="p">,</span><span class="n">VTK_VAR_XML_VECT_3DA_I2</span><span class="p">,</span> <span class="p">&amp;</span> <span class="c">! integer(I2P) vectorial 1D/3D arrays</span>
                   <span class="n">VTK_VAR_XML_VECT_1DA_I1</span><span class="p">,</span><span class="n">VTK_VAR_XML_VECT_3DA_I1</span><span class="p">,</span> <span class="p">&amp;</span> <span class="c">! integer(I1P) vectorial 1D/3D arrays</span>
                   <span class="n">VTK_VAR_XML_LIST_1DA_R8</span><span class="p">,</span><span class="n">VTK_VAR_XML_LIST_3DA_R8</span><span class="p">,</span> <span class="p">&amp;</span> <span class="c">! real(R8P)    list      1D/3D array</span>
                   <span class="n">VTK_VAR_XML_LIST_1DA_R4</span><span class="p">,</span><span class="n">VTK_VAR_XML_LIST_3DA_R4</span><span class="p">,</span> <span class="p">&amp;</span> <span class="c">! real(R4P)    list      1D/3D array</span>
                   <span class="n">VTK_VAR_XML_LIST_1DA_I8</span><span class="p">,</span><span class="n">VTK_VAR_XML_LIST_3DA_I8</span><span class="p">,</span> <span class="p">&amp;</span> <span class="c">! integer(I4P) list      1D/3D array</span>
                   <span class="n">VTK_VAR_XML_LIST_1DA_I4</span><span class="p">,</span><span class="n">VTK_VAR_XML_LIST_3DA_I4</span><span class="p">,</span> <span class="p">&amp;</span> <span class="c">! integer(I4P) list      1D/3D array</span>
                   <span class="n">VTK_VAR_XML_LIST_1DA_I2</span><span class="p">,</span><span class="n">VTK_VAR_XML_LIST_3DA_I2</span><span class="p">,</span> <span class="p">&amp;</span> <span class="c">! integer(I2P) list      1D/3D array</span>
                   <span class="n">VTK_VAR_XML_LIST_1DA_I1</span><span class="p">,</span><span class="n">VTK_VAR_XML_LIST_3DA_I1</span>    <span class="c">! integer(I1P) list      1D/3D array</span>
<span class="n">endinterface</span>
<span class="c">!&gt; @brief Function for saving mesh with different topologies in VTK-legacy standard.</span>
<span class="c">!&gt; VTK_GEO is an interface to 16 different functions, there are 2 functions for each of 4 different topologies actually supported:</span>
<span class="c">!&gt; one function for mesh coordinates with R8P precision and one for mesh coordinates with R4P precision.</span>
<span class="c">!&gt; @remark This function must be called after VTK_INI. It saves the mesh geometry. The inputs that must be passed change depending</span>
<span class="c">!&gt; on the topologies chosen. Not all VTK topologies have been implemented (\em polydata topologies are absent).</span>
<span class="c">!&gt; @note Examples of usage are: \n</span>
<span class="c">!&gt; \b Structured points calling: \n</span>
<span class="c">!&gt; @code ...</span>
<span class="c">!&gt; integer(I4P):: Nx,Ny,Nz</span>
<span class="c">!&gt; real(I8P)::    X0,Y0,Z0,Dx,Dy,Dz</span>
<span class="c">!&gt; ...</span>
<span class="c">!&gt; E_IO=VTK_GEO(Nx,Ny,Nz,X0,Y0,Z0,Dx,Dy,Dz)</span>
<span class="c">!&gt; ... @endcode</span>
<span class="c">!&gt; \b Structured grid calling: \n</span>
<span class="c">!&gt; @code ...</span>
<span class="c">!&gt; integer(I4P):: Nx,Ny,Nz,Nnodes</span>
<span class="c">!&gt; real(R8P)::    X(1:Nnodes),Y(1:Nnodes),Z(1:Nnodes)</span>
<span class="c">!&gt; ...</span>
<span class="c">!&gt; E_IO=VTK_GEO(Nx,Ny,Nz,Nnodes,X,Y,Z)</span>
<span class="c">!&gt; ... @endcode</span>
<span class="c">!&gt; \b Rectilinear grid calling: \n</span>
<span class="c">!&gt; @code ...</span>
<span class="c">!&gt; integer(I4P):: Nx,Ny,Nz</span>
<span class="c">!&gt; real(R8P)::    X(1:Nx),Y(1:Ny),Z(1:Nz)</span>
<span class="c">!&gt; ...</span>
<span class="c">!&gt; E_IO=VTK_GEO(Nx,Ny,Nz,X,Y,Z)</span>
<span class="c">!&gt; ... @endcode</span>
<span class="c">!&gt; \b Unstructured grid calling: \n</span>
<span class="c">!&gt; @code ...</span>
<span class="c">!&gt; integer(I4P):: NN</span>
<span class="c">!&gt; real(R4P)::    X(1:NN),Y(1:NN),Z(1:NN)</span>
<span class="c">!&gt; ...</span>
<span class="c">!&gt; E_IO=VTK_GEO(NN,X,Y,Z)</span>
<span class="c">!&gt; ... @endcode</span>
<span class="c">!&gt; @ingroup Lib_VTK_IOInterface</span>
<span class="k">interface </span><span class="n">VTK_GEO</span>
  <span class="k">module procedure </span><span class="n">VTK_GEO_UNST_R8</span><span class="p">,</span><span class="n">VTK_GEO_UNST_P_R8</span><span class="p">,</span>         <span class="p">&amp;</span> <span class="c">! real(R8P) UNSTRUCTURED_GRID, standard and packed API</span>
                   <span class="n">VTK_GEO_UNST_R4</span><span class="p">,</span><span class="n">VTK_GEO_UNST_P_R4</span><span class="p">,</span>         <span class="p">&amp;</span> <span class="c">! real(R4P) UNSTRUCTURED_GRID, standard and packed API</span>
                   <span class="n">VTK_GEO_STRP_R8</span><span class="p">,</span>                           <span class="p">&amp;</span> <span class="c">! real(R8P) STRUCTURED_POINTS</span>
                   <span class="n">VTK_GEO_STRP_R4</span><span class="p">,</span>                           <span class="p">&amp;</span> <span class="c">! real(R4P) STRUCTURED_POINTS</span>
                   <span class="n">VTK_GEO_STRG_1DA_R8</span><span class="p">,</span> <span class="n">VTK_GEO_STRG_3DA_R8</span><span class="p">,</span>  <span class="p">&amp;</span> <span class="c">! real(R8P) STRUCTURED_GRID 1D/3D arrays</span>
                   <span class="n">VTK_GEO_STRG_1DAP_R8</span><span class="p">,</span><span class="n">VTK_GEO_STRG_3DAP_R8</span><span class="p">,</span> <span class="p">&amp;</span> <span class="c">! real(R8P) STRUCTURED_GRID 1D/3D arrays, packed API</span>
                   <span class="n">VTK_GEO_STRG_1DA_R4</span><span class="p">,</span> <span class="n">VTK_GEO_STRG_3DA_R4</span><span class="p">,</span>  <span class="p">&amp;</span> <span class="c">! real(R4P) STRUCTURED_GRID 1D/3D arrays</span>
                   <span class="n">VTK_GEO_STRG_1DAP_R4</span><span class="p">,</span><span class="n">VTK_GEO_STRG_3DAP_R4</span><span class="p">,</span> <span class="p">&amp;</span> <span class="c">! real(R4P) STRUCTURED_GRID 1D/3D arrays, packed API</span>
                   <span class="n">VTK_GEO_RECT_R8</span><span class="p">,</span>                           <span class="p">&amp;</span> <span class="c">! real(R8P) RECTILINEAR_GRID</span>
                   <span class="n">VTK_GEO_RECT_R4</span>                              <span class="c">! real(R4P) RECTILINEAR_GRID</span>
<span class="n">endinterface</span>
<span class="c">!&gt; @brief Function for saving data variable(s) in VTK-legacy standard.</span>
<span class="c">!&gt; VTK_VAR is an interface to 8 different functions, there are 3 functions for scalar variables, 3 functions for vectorial</span>
<span class="c">!&gt; variables and 2 functions texture variables: scalar and vectorial data can be R8P, R4P and I4P data while texture variables can</span>
<span class="c">!&gt; be only R8P or R4P.</span>
<span class="c">!&gt; This function saves the data variables related to geometric mesh.</span>
<span class="c">!&gt; @remark The inputs that must be passed change depending on the data</span>
<span class="c">!&gt; variables type.</span>
<span class="c">!&gt; @note Examples of usage are: \n</span>
<span class="c">!&gt; \b Scalar data calling: \n</span>
<span class="c">!&gt; @code ...</span>
<span class="c">!&gt; integer(I4P):: NN</span>
<span class="c">!&gt; real(R4P)::    var(1:NN)</span>
<span class="c">!&gt; ...</span>
<span class="c">!&gt; E_IO=VTK_VAR(NN,&#39;Sca&#39;,var)</span>
<span class="c">!&gt; ... @endcode</span>
<span class="c">!&gt; \b Vectorial data calling: \n</span>
<span class="c">!&gt; @code ...</span>
<span class="c">!&gt; integer(I4P):: NN</span>
<span class="c">!&gt; real(R4P)::    varX(1:NN),varY(1:NN),varZ(1:NN)</span>
<span class="c">!&gt; ...</span>
<span class="c">!&gt; E_IO=VTK_VAR(&#39;vect&#39;,NN,&#39;Vec&#39;,varX,varY,varZ)</span>
<span class="c">!&gt; ... @endcode</span>
<span class="c">!&gt; @ingroup Lib_VTK_IOInterface</span>
<span class="k">interface </span><span class="n">VTK_VAR</span>
  <span class="k">module procedure </span><span class="n">VTK_VAR_SCAL_R8</span><span class="p">,</span> <span class="p">&amp;</span> <span class="c">! real(R8P)    scalar</span>
                   <span class="n">VTK_VAR_SCAL_R4</span><span class="p">,</span> <span class="p">&amp;</span> <span class="c">! real(R4P)    scalar</span>
                   <span class="n">VTK_VAR_SCAL_I4</span><span class="p">,</span> <span class="p">&amp;</span> <span class="c">! integer(I4P) scalar</span>
                   <span class="n">VTK_VAR_VECT_R8</span><span class="p">,</span> <span class="p">&amp;</span> <span class="c">! real(R8P)    vectorial</span>
                   <span class="n">VTK_VAR_VECT_R4</span><span class="p">,</span> <span class="p">&amp;</span> <span class="c">! real(R4P)    vectorial</span>
                   <span class="n">VTK_VAR_VECT_I4</span><span class="p">,</span> <span class="p">&amp;</span> <span class="c">! integer(I4P) vectorial</span>
                   <span class="n">VTK_VAR_TEXT_R8</span><span class="p">,</span> <span class="p">&amp;</span> <span class="c">! real(R8P)    vectorial (texture)</span>
                   <span class="n">VTK_VAR_TEXT_R4</span>    <span class="c">! real(R4P)    vectorial (texture)</span>
<span class="n">endinterface</span>
<span class="c">!-----------------------------------------------------------------------------------------------------------------------------------</span>

<span class="c">!-----------------------------------------------------------------------------------------------------------------------------------</span>
<span class="c">!&gt; @ingroup Lib_VTK_IOPrivateVarPar</span>
<span class="c">!&gt; @{</span>
<span class="c">! The library uses a small set of internal variables that are private (not accessible from the outside). The following are</span>
<span class="c">! private variables.</span>
<span class="c">! Parameters:</span>
<span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">),</span> <span class="k">parameter</span><span class="kd">::</span> <span class="n">maxlen</span>  <span class="o">=</span> <span class="mi">500</span>      <span class="c">!&lt; Max number of characters of static string.</span>
<span class="kt">character</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="k">parameter</span><span class="kd">::</span> <span class="n">end_rec</span> <span class="o">=</span> <span class="nb">char</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span> <span class="c">!&lt; End-character for binary-record finalize.</span>
<span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">),</span> <span class="k">parameter</span><span class="kd">::</span> <span class="n">ascii</span>   <span class="o">=</span> <span class="mi">0</span>        <span class="c">!&lt; Ascii-output-format parameter identifier.</span>
<span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">),</span> <span class="k">parameter</span><span class="kd">::</span> <span class="n">binary</span>  <span class="o">=</span> <span class="mi">1</span>        <span class="c">!&lt; Base64-output-format parameter identifier.</span>
<span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">),</span> <span class="k">parameter</span><span class="kd">::</span> <span class="n">raw</span>     <span class="o">=</span> <span class="mi">2</span>        <span class="c">!&lt; Raw-appended-binary-output-format parameter identifier.</span>
<span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">),</span> <span class="k">parameter</span><span class="kd">::</span> <span class="n">bin_app</span> <span class="o">=</span> <span class="mi">3</span>        <span class="c">!&lt; Base64-appended-output-format parameter identifier.</span>
<span class="c">! VTK file data:</span>
<span class="k">type</span><span class="kd">::</span> <span class="n">Type_VTK_File</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">)</span><span class="kd">::</span>          <span class="n">f</span>        <span class="o">=</span> <span class="n">ascii</span> <span class="c">!&lt; Current output-format (initialized to ascii format).</span>
  <span class="kt">character</span><span class="p">(</span><span class="nb">len</span><span class="o">=</span><span class="n">maxlen</span><span class="p">)</span><span class="kd">::</span> <span class="n">topology</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>    <span class="c">!&lt; Mesh topology.</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">)</span><span class="kd">::</span>          <span class="n">u</span>        <span class="o">=</span> <span class="mi">0_I4P</span> <span class="c">!&lt; Logical unit.</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">)</span><span class="kd">::</span>          <span class="n">ua</span>       <span class="o">=</span> <span class="mi">0_I4P</span> <span class="c">!&lt; Logical unit for raw binary XML append file.</span>
<span class="cp">#ifdef HUGE</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I8P</span><span class="p">)</span><span class="kd">::</span>          <span class="n">N_Byte</span>   <span class="o">=</span> <span class="mi">0_I8P</span> <span class="c">!&lt; Number of byte to be written/read.</span>
<span class="cp">#else</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">)</span><span class="kd">::</span>          <span class="n">N_Byte</span>   <span class="o">=</span> <span class="mi">0_I4P</span> <span class="c">!&lt; Number of byte to be written/read.</span>
<span class="cp">#endif</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I8P</span><span class="p">)</span><span class="kd">::</span>          <span class="n">ioffset</span>  <span class="o">=</span> <span class="mi">0_I8P</span> <span class="c">!&lt; Offset pointer.</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">)</span><span class="kd">::</span>          <span class="n">indent</span>   <span class="o">=</span> <span class="mi">0_I4P</span> <span class="c">!&lt; Indent pointer.</span>
  <span class="k">contains</span>
<span class="k">    procedure</span><span class="kd">::</span> <span class="n">byte_update</span> <span class="c">! Procedure for updating N_Byte and ioffset pointer.</span>
<span class="n">endtype</span> <span class="n">Type_VTK_File</span>
<span class="k">type</span><span class="p">(</span><span class="n">Type_VTK_File</span><span class="p">),</span> <span class="k">allocatable</span><span class="kd">::</span> <span class="n">vtk</span><span class="p">(:)</span>       <span class="c">!&lt; Global data of VTK files [1:Nvtk].</span>
<span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">)</span><span class="kd">::</span>                     <span class="n">Nvtk</span> <span class="o">=</span> <span class="mi">0_I4P</span> <span class="c">!&lt; Number of (concurrent) VTK files.</span>
<span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">)</span><span class="kd">::</span>                     <span class="n">f</span>    <span class="o">=</span> <span class="mi">0_I4P</span> <span class="c">!&lt; Current VTK file index.</span>
<span class="c">! VTM file data:</span>
<span class="k">type</span><span class="kd">::</span> <span class="n">Type_VTM_File</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">)</span><span class="kd">::</span> <span class="n">u</span>      <span class="o">=</span> <span class="mi">0_I4P</span> <span class="c">!&lt; Logical unit.</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">)</span><span class="kd">::</span> <span class="n">blk</span>    <span class="o">=</span> <span class="mi">0_I4P</span> <span class="c">!&lt; Block index.</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">)</span><span class="kd">::</span> <span class="n">indent</span> <span class="o">=</span> <span class="mi">0_I4P</span> <span class="c">!&lt; Indent pointer.</span>
<span class="n">endtype</span> <span class="n">Type_VTM_File</span>
<span class="k">type</span><span class="p">(</span><span class="n">Type_VTM_File</span><span class="p">)</span><span class="kd">::</span> <span class="n">vtm</span> <span class="c">!&lt; Global data of VTM files.</span>
<span class="c">!&gt; @}</span>
<span class="c">!-----------------------------------------------------------------------------------------------------------------------------------</span>
<span class="k">contains</span>
  <span class="c">! The library uses five auxiliary procedures that are private thus they cannot be called outside the library.</span>
  <span class="c">!&gt; @ingroup Lib_VTK_IOPrivateProcedure</span>
  <span class="c">!&gt; @{</span>
  <span class="c">!&gt; @brief Function for getting a free logic unit. The users of @libvtk does not know which is the logical</span>
  <span class="c">!&gt;        unit: @libvtk uses this information without boring the users. The logical unit used is safe-free: if the program</span>
  <span class="c">!&gt;        calling @libvtk has others logical units used @libvtk will never use these units, but will choice one that is free.</span>
  <span class="c">!&gt;@return Free_Unit</span>
  <span class="kt">integer </span><span class="k">function </span><span class="n">Get_Unit</span><span class="p">(</span><span class="n">Free_Unit</span><span class="p">)</span>
  <span class="c">!---------------------------------------------------------------------------------------------------------------------------------</span>
  <span class="k">implicit none</span>
<span class="k">  </span><span class="kt">integer</span><span class="p">,</span> <span class="k">intent</span><span class="p">(</span><span class="n">OUT</span><span class="p">),</span> <span class="k">optional</span><span class="kd">::</span> <span class="n">Free_Unit</span> <span class="c">!&lt; Free logic unit.</span>
  <span class="kt">integer</span><span class="kd">::</span>                        <span class="n">n1</span>        <span class="c">!&lt; Counter.</span>
  <span class="kt">integer</span><span class="kd">::</span>                        <span class="n">ios</span>       <span class="c">!&lt; Inquiring flag.</span>
  <span class="kt">logical</span><span class="kd">::</span>                        <span class="n">lopen</span>     <span class="c">!&lt; Inquiring flag.</span>
  <span class="c">!---------------------------------------------------------------------------------------------------------------------------------</span>

  <span class="c">!---------------------------------------------------------------------------------------------------------------------------------</span>
  <span class="n">Get_Unit</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
  <span class="n">n1</span><span class="o">=</span><span class="mi">1</span>
  <span class="k">do</span>
<span class="k">    if</span> <span class="p">((</span><span class="n">n1</span><span class="o">/=</span><span class="n">stdout</span><span class="p">).</span><span class="nb">AND</span><span class="p">.(</span><span class="n">n1</span><span class="o">/=</span><span class="n">stderr</span><span class="p">))</span> <span class="k">then</span>
<span class="k">      inquire</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">n1</span><span class="p">,</span><span class="n">opened</span><span class="o">=</span><span class="n">lopen</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">ios</span><span class="p">)</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">ios</span><span class="o">==</span><span class="mi">0</span><span class="p">)</span> <span class="k">then</span>
<span class="k">        if</span> <span class="p">(.</span><span class="nb">NOT</span><span class="p">.</span><span class="n">lopen</span><span class="p">)</span> <span class="k">then</span>
<span class="k">          </span><span class="n">Get_Unit</span> <span class="o">=</span> <span class="n">n1</span> <span class="p">;</span> <span class="k">if</span> <span class="p">(</span><span class="nb">present</span><span class="p">(</span><span class="n">Free_Unit</span><span class="p">))</span> <span class="n">Free_Unit</span> <span class="o">=</span> <span class="n">Get_Unit</span>
          <span class="k">return</span>
<span class="k">        </span><span class="n">endif</span>
      <span class="n">endif</span>
    <span class="n">endif</span>
    <span class="n">n1</span><span class="o">=</span><span class="n">n1</span><span class="o">+</span><span class="mi">1</span>
  <span class="n">enddo</span>
  <span class="k">return</span>
  <span class="c">!---------------------------------------------------------------------------------------------------------------------------------</span>
  <span class="n">endfunction</span> <span class="n">Get_Unit</span>

  <span class="c">!&gt; @brief Function for converting lower case characters of a string to upper case ones. @libvtk uses this function in</span>
  <span class="c">!&gt;        order to achieve case-insensitive: all character variables used within @libvtk functions are pre-processed by</span>
  <span class="c">!&gt;        Uppper_Case function before these variables are used. So the users can call @libvtk functions without pay attention of</span>
  <span class="c">!&gt;        the case of the keywords passed to the functions: calling the function VTK_INI with the string</span>
  <span class="c">!&gt;        &lt;em&gt;E_IO = VTK_INI(&#39;Ascii&#39;,...)&lt;/em&gt; is equivalent to &lt;em&gt;E_IO = VTK_INI(&#39;ASCII&#39;,...)&lt;/em&gt;.</span>
  <span class="c">!&gt;@return Upper_Case</span>
  <span class="k">elemental function </span><span class="n">Upper_Case</span><span class="p">(</span><span class="n">string</span><span class="p">)</span>
  <span class="c">!---------------------------------------------------------------------------------------------------------------------------------</span>
  <span class="k">implicit none</span>
<span class="k">  </span><span class="kt">character</span><span class="p">(</span><span class="nb">len</span><span class="o">=*</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span><span class="kd">::</span> <span class="n">string</span>     <span class="c">!&lt; String to be converted.</span>
  <span class="kt">character</span><span class="p">(</span><span class="nb">len</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">string</span><span class="p">))</span><span class="kd">::</span>   <span class="n">Upper_Case</span> <span class="c">!&lt; Converted string.</span>
  <span class="kt">integer</span><span class="kd">::</span>                      <span class="n">n1</span>         <span class="c">!&lt; Characters counter.</span>
  <span class="c">!---------------------------------------------------------------------------------------------------------------------------------</span>

  <span class="c">!---------------------------------------------------------------------------------------------------------------------------------</span>
  <span class="n">Upper_Case</span> <span class="o">=</span> <span class="n">string</span>
  <span class="k">do </span><span class="n">n1</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">string</span><span class="p">)</span>
    <span class="k">select case</span><span class="p">(</span><span class="nb">ichar</span><span class="p">(</span><span class="n">string</span><span class="p">(</span><span class="n">n1</span><span class="p">:</span><span class="n">n1</span><span class="p">)))</span>
    <span class="k">case</span><span class="p">(</span><span class="mi">97</span><span class="p">:</span><span class="mi">122</span><span class="p">)</span>
      <span class="n">Upper_Case</span><span class="p">(</span><span class="n">n1</span><span class="p">:</span><span class="n">n1</span><span class="p">)</span><span class="o">=</span><span class="nb">char</span><span class="p">(</span><span class="nb">ichar</span><span class="p">(</span><span class="n">string</span><span class="p">(</span><span class="n">n1</span><span class="p">:</span><span class="n">n1</span><span class="p">))</span><span class="o">-</span><span class="mi">32</span><span class="p">)</span> <span class="c">! Upper case conversion</span>
    <span class="n">endselect</span>
  <span class="n">enddo</span>
  <span class="k">return</span>
  <span class="c">!---------------------------------------------------------------------------------------------------------------------------------</span>
  <span class="n">endfunction</span> <span class="n">Upper_Case</span>

  <span class="c">!&gt; @brief Subroutine for updating N_Byte and ioffset pointer.</span>
  <span class="k">elemental subroutine </span><span class="n">byte_update</span><span class="p">(</span><span class="n">vtk</span><span class="p">,</span><span class="n">N_Byte</span><span class="p">)</span>
  <span class="c">!---------------------------------------------------------------------------------------------------------------------------------</span>
  <span class="k">implicit none</span>
<span class="k">  class</span><span class="p">(</span><span class="n">Type_VTK_File</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">INOUT</span><span class="p">)</span><span class="kd">::</span> <span class="n">vtk</span>    <span class="c">!&lt; Global data of VTK file.</span>
<span class="cp">#ifdef HUGE</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I8P</span><span class="p">),</span>         <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span><span class="kd">::</span>    <span class="n">N_Byte</span> <span class="c">!&lt; Number of bytes saved.</span>
<span class="cp">#else</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">),</span>         <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span><span class="kd">::</span>    <span class="n">N_Byte</span> <span class="c">!&lt; Number of bytes saved.</span>
<span class="cp">#endif</span>
  <span class="c">!---------------------------------------------------------------------------------------------------------------------------------</span>

  <span class="c">!---------------------------------------------------------------------------------------------------------------------------------</span>
  <span class="n">vtk</span><span class="p">%</span><span class="n">N_Byte</span> <span class="o">=</span> <span class="n">N_Byte</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">vtk</span><span class="p">%</span><span class="n">f</span><span class="o">==</span><span class="n">raw</span><span class="p">)</span> <span class="k">then</span>
<span class="cp">#ifdef HUGE</span>
    <span class="n">vtk</span><span class="p">%</span><span class="n">ioffset</span> <span class="o">=</span> <span class="n">vtk</span><span class="p">%</span><span class="n">ioffset</span> <span class="o">+</span> <span class="n">BYI8P</span> <span class="o">+</span> <span class="n">N_Byte</span>
<span class="cp">#else</span>
    <span class="n">vtk</span><span class="p">%</span><span class="n">ioffset</span> <span class="o">=</span> <span class="n">vtk</span><span class="p">%</span><span class="n">ioffset</span> <span class="o">+</span> <span class="n">BYI4P</span> <span class="o">+</span> <span class="n">N_Byte</span>
<span class="cp">#endif</span>
  <span class="k">else</span>
<span class="cp">#ifdef HUGE</span>
    <span class="n">vtk</span><span class="p">%</span><span class="n">ioffset</span> <span class="o">=</span> <span class="n">vtk</span><span class="p">%</span><span class="n">ioffset</span> <span class="o">+</span> <span class="p">((</span><span class="n">N_Byte</span> <span class="o">+</span> <span class="n">BYI8P</span> <span class="o">+</span> <span class="mi">2_I8P</span><span class="p">)</span><span class="o">/</span><span class="mi">3_I8P</span><span class="p">)</span><span class="o">*</span><span class="mi">4_I8P</span>
<span class="cp">#else</span>
    <span class="n">vtk</span><span class="p">%</span><span class="n">ioffset</span> <span class="o">=</span> <span class="n">vtk</span><span class="p">%</span><span class="n">ioffset</span> <span class="o">+</span> <span class="p">((</span><span class="n">N_Byte</span> <span class="o">+</span> <span class="n">BYI4P</span> <span class="o">+</span> <span class="mi">2_I4P</span><span class="p">)</span><span class="o">/</span><span class="mi">3_I4P</span><span class="p">)</span><span class="o">*</span><span class="mi">4_I4P</span>
<span class="cp">#endif</span>
  <span class="n">endif</span>
  <span class="k">return</span>
  <span class="c">!---------------------------------------------------------------------------------------------------------------------------------</span>
  <span class="n">endsubroutine</span> <span class="n">byte_update</span>

  <span class="c">!&gt; @brief Subroutine for updating (adding and removing elements into) vtk array.</span>
  <span class="k">pure subroutine </span><span class="n">vtk_update</span><span class="p">(</span><span class="n">act</span><span class="p">,</span><span class="n">cf</span><span class="p">,</span><span class="n">Nvtk</span><span class="p">,</span><span class="n">vtk</span><span class="p">)</span>
  <span class="c">!---------------------------------------------------------------------------------------------------------------------------------</span>
  <span class="k">implicit none</span>
<span class="k">  </span><span class="kt">character</span><span class="p">(</span><span class="o">*</span><span class="p">),</span>                     <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span><span class="kd">::</span>    <span class="n">act</span>        <span class="c">!&lt; Action: &#39;ADD&#39; one more element, &#39;REMOVE&#39; current element file.</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">),</span>                     <span class="k">intent</span><span class="p">(</span><span class="n">INOUT</span><span class="p">)</span><span class="kd">::</span> <span class="n">cf</span>         <span class="c">!&lt; Current file index (for concurrent files IO).</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">),</span>                     <span class="k">intent</span><span class="p">(</span><span class="n">INOUT</span><span class="p">)</span><span class="kd">::</span> <span class="n">Nvtk</span>       <span class="c">!&lt; Number of (concurrent) VTK files.</span>
  <span class="k">type</span><span class="p">(</span><span class="n">Type_VTK_File</span><span class="p">),</span> <span class="k">allocatable</span><span class="p">,</span> <span class="k">intent</span><span class="p">(</span><span class="n">INOUT</span><span class="p">)</span><span class="kd">::</span> <span class="n">vtk</span><span class="p">(:)</span>     <span class="c">!&lt; VTK files data.</span>
  <span class="k">type</span><span class="p">(</span><span class="n">Type_VTK_File</span><span class="p">),</span> <span class="k">allocatable</span><span class="kd">::</span>                <span class="n">vtk_tmp</span><span class="p">(:)</span> <span class="c">!&lt; Temporary array of VTK files data.</span>
  <span class="c">!---------------------------------------------------------------------------------------------------------------------------------</span>

  <span class="c">!---------------------------------------------------------------------------------------------------------------------------------</span>
  <span class="k">select case</span><span class="p">(</span><span class="n">Upper_Case</span><span class="p">(</span><span class="nb">trim</span><span class="p">(</span><span class="n">act</span><span class="p">)))</span>
  <span class="k">case</span><span class="p">(</span><span class="s1">&#39;ADD&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">Nvtk</span><span class="o">&gt;</span><span class="mi">0_I4P</span><span class="p">)</span> <span class="k">then</span>
<span class="k">      allocate</span><span class="p">(</span><span class="n">vtk_tmp</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">Nvtk</span><span class="p">))</span>
      <span class="n">vtk_tmp</span> <span class="o">=</span> <span class="n">vtk</span>
      <span class="k">deallocate</span><span class="p">(</span><span class="n">vtk</span><span class="p">)</span>
      <span class="n">Nvtk</span> <span class="o">=</span> <span class="n">Nvtk</span> <span class="o">+</span> <span class="mi">1</span>
      <span class="k">allocate</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">Nvtk</span><span class="p">))</span>
      <span class="n">vtk</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">Nvtk</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="n">vtk_tmp</span>
      <span class="k">deallocate</span><span class="p">(</span><span class="n">vtk_tmp</span><span class="p">)</span>
      <span class="n">cf</span> <span class="o">=</span> <span class="n">Nvtk</span>
    <span class="k">else</span>
<span class="k">      </span><span class="n">Nvtk</span> <span class="o">=</span> <span class="mi">1_I4P</span>
      <span class="k">allocate</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">Nvtk</span><span class="p">))</span>
      <span class="n">cf</span> <span class="o">=</span> <span class="n">Nvtk</span>
    <span class="n">endif</span>
  <span class="k">case </span><span class="n">default</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">Nvtk</span><span class="o">&gt;</span><span class="mi">1_I4P</span><span class="p">)</span> <span class="k">then</span>
<span class="k">      allocate</span><span class="p">(</span><span class="n">vtk_tmp</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">Nvtk</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">cf</span><span class="o">==</span><span class="n">Nvtk</span><span class="p">)</span> <span class="k">then</span>
<span class="k">        </span><span class="n">vtk_tmp</span> <span class="o">=</span> <span class="n">vtk</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">Nvtk</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
      <span class="k">else</span>
<span class="k">        </span><span class="n">vtk_tmp</span><span class="p">(</span><span class="mi">1</span> <span class="p">:</span><span class="n">cf</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="n">vtk</span><span class="p">(</span><span class="mi">1</span>   <span class="p">:</span><span class="n">cf</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">vtk_tmp</span><span class="p">(</span><span class="n">cf</span><span class="p">:</span>    <span class="p">)</span> <span class="o">=</span> <span class="n">vtk</span><span class="p">(</span><span class="n">cf</span><span class="o">+</span><span class="mi">1</span><span class="p">:</span>    <span class="p">)</span>
      <span class="n">endif</span>
      <span class="k">deallocate</span><span class="p">(</span><span class="n">vtk</span><span class="p">)</span>
      <span class="n">Nvtk</span> <span class="o">=</span> <span class="n">Nvtk</span> <span class="o">-</span> <span class="mi">1</span>
      <span class="k">allocate</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">Nvtk</span><span class="p">))</span>
      <span class="n">vtk</span> <span class="o">=</span> <span class="n">vtk_tmp</span>
      <span class="k">deallocate</span><span class="p">(</span><span class="n">vtk_tmp</span><span class="p">)</span>
      <span class="n">cf</span> <span class="o">=</span> <span class="mi">1_I4P</span>
    <span class="k">else</span>
<span class="k">      </span><span class="n">Nvtk</span> <span class="o">=</span> <span class="mi">0_I4P</span>
      <span class="k">if</span> <span class="p">(</span><span class="nb">allocated</span><span class="p">(</span><span class="n">vtk</span><span class="p">))</span> <span class="k">deallocate</span><span class="p">(</span><span class="n">vtk</span><span class="p">)</span>
      <span class="n">cf</span> <span class="o">=</span> <span class="n">Nvtk</span>
    <span class="n">endif</span>
  <span class="n">endselect</span>
  <span class="k">return</span>
  <span class="c">!---------------------------------------------------------------------------------------------------------------------------------</span>
  <span class="n">endsubroutine</span> <span class="n">vtk_update</span>

  <span class="c">!&gt; @brief Function for converting array of 1 character to a string of characters. It is used for writing the stream of base64</span>
  <span class="c">!&gt; encoded data.</span>
  <span class="k">pure function </span><span class="n">tochar</span><span class="p">(</span><span class="n">string</span><span class="p">)</span> <span class="k">result</span> <span class="p">(</span><span class="n">char_string</span><span class="p">)</span>
  <span class="c">!---------------------------------------------------------------------------------------------------------------------------------</span>
  <span class="k">implicit none</span>
<span class="k">  </span><span class="kt">character</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span><span class="kd">::</span>      <span class="n">string</span><span class="p">(</span><span class="mi">1</span><span class="p">:)</span>  <span class="c">!&lt; Array of 1 character.</span>
  <span class="kt">character</span><span class="p">(</span><span class="n">size</span><span class="p">(</span><span class="n">string</span><span class="p">,</span><span class="nb">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span><span class="kd">::</span> <span class="n">char_string</span> <span class="c">!&lt; String of characters.</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">)</span><span class="kd">::</span>                  <span class="n">i</span>           <span class="c">!&lt; Counter.</span>
  <span class="c">!---------------------------------------------------------------------------------------------------------------------------------</span>

  <span class="c">!---------------------------------------------------------------------------------------------------------------------------------</span>
  <span class="k">forall</span><span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">:</span><span class="n">size</span><span class="p">(</span><span class="n">string</span><span class="p">,</span><span class="nb">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
     <span class="n">char_string</span><span class="p">(</span><span class="n">i</span><span class="p">:</span><span class="n">i</span><span class="p">)</span> <span class="o">=</span> <span class="n">string</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
  <span class="n">endforall</span>
  <span class="k">return</span>
  <span class="c">!---------------------------------------------------------------------------------------------------------------------------------</span>
  <span class="n">endfunction</span> <span class="n">tochar</span>
  <span class="c">!&gt; @}</span>

  <span class="c">!&gt; @brief Function for initializing VTK-XML file.</span>
  <span class="c">!&gt; The XML standard is more powerful than legacy one. It is flexible but on the other hand is (but not so more using a library</span>
  <span class="c">!&gt; like @libvtk...) complex than legacy standard. The output of XML functions is a well-formated valid XML file, at least for the</span>
  <span class="c">!&gt; ascii, binary and binary appended formats (in the raw-binary format @libvtk uses raw-binary-appended format that is not a valid</span>
  <span class="c">!&gt; XML file).</span>
  <span class="c">!&gt; Note that the XML functions have the same name of legacy functions with the suffix \em XML.</span>
  <span class="c">!&gt; @remark This function must be the first to be called.</span>
  <span class="c">!&gt; @note Supported output formats are (the passed specifier value is case insensitive):</span>
  <span class="c">!&gt; - ASCII: data are saved in ASCII format;</span>
  <span class="c">!&gt; - BINARY: data are saved in base64 encoded format;</span>
  <span class="c">!&gt; - RAW: data are saved in raw-binary format in the appended tag of the XML file;</span>
  <span class="c">!&gt; - BINARY-APPENDED: data are saved in base64 encoded format in the appended tag of the XML file.</span>
  <span class="c">!&gt; @note Supported topologies are:</span>
  <span class="c">!&gt; - RectilinearGrid;</span>
  <span class="c">!&gt; - StructuredGrid;</span>
  <span class="c">!&gt; - UnstructuredGrid.</span>
  <span class="c">!&gt; @note An example of usage is: \n</span>
  <span class="c">!&gt; @code ...</span>
  <span class="c">!&gt; integer(I4P):: nx1,nx2,ny1,ny2,nz1,nz2</span>
  <span class="c">!&gt; ...</span>
  <span class="c">!&gt; E_IO = VTK_INI_XML(&#39;BINARY&#39;,&#39;XML_RECT_BINARY.vtr&#39;,&#39;RectilinearGrid&#39;,nx1=nx1,nx2=nx2,ny1=ny1,ny2=ny2,nz1=nz1,nz2=nz2)</span>
  <span class="c">!&gt; ... @endcode</span>
  <span class="c">!&gt; Note that the file extension is necessary in the file name. The XML standard has different extensions for each</span>
  <span class="c">!&gt; different topologies (e.g. \em vtr for rectilinear topology). See the VTK-standard file for more information.</span>
  <span class="c">!&gt; @return E_IO: integer(I4P) error flag</span>
  <span class="k">function </span><span class="n">VTK_INI_XML</span><span class="p">(</span><span class="n">output_format</span><span class="p">,</span><span class="n">filename</span><span class="p">,</span><span class="n">mesh_topology</span><span class="p">,</span><span class="n">cf</span><span class="p">,</span><span class="n">nx1</span><span class="p">,</span><span class="n">nx2</span><span class="p">,</span><span class="n">ny1</span><span class="p">,</span><span class="n">ny2</span><span class="p">,</span><span class="n">nz1</span><span class="p">,</span><span class="n">nz2</span><span class="p">)</span> <span class="k">result</span><span class="p">(</span><span class="n">E_IO</span><span class="p">)</span>
  <span class="c">!---------------------------------------------------------------------------------------------------------------------------------</span>
  <span class="k">implicit none</span>
<span class="k">  </span><span class="kt">character</span><span class="p">(</span><span class="o">*</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span><span class="kd">::</span>            <span class="n">output_format</span> <span class="c">!&lt; Output format: ASCII, BINARY, RAW or BINARY-APPENDED.</span>
  <span class="kt">character</span><span class="p">(</span><span class="o">*</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span><span class="kd">::</span>            <span class="n">filename</span>      <span class="c">!&lt; File name.</span>
  <span class="kt">character</span><span class="p">(</span><span class="o">*</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span><span class="kd">::</span>            <span class="n">mesh_topology</span> <span class="c">!&lt; Mesh topology.</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">OUT</span><span class="p">),</span> <span class="k">optional</span><span class="kd">::</span> <span class="n">cf</span>            <span class="c">!&lt; Current file index (for concurrent files IO).</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">),</span>  <span class="k">optional</span><span class="kd">::</span> <span class="n">nx1</span>           <span class="c">!&lt; Initial node of x axis.</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">),</span>  <span class="k">optional</span><span class="kd">::</span> <span class="n">nx2</span>           <span class="c">!&lt; Final node of x axis.</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">),</span>  <span class="k">optional</span><span class="kd">::</span> <span class="n">ny1</span>           <span class="c">!&lt; Initial node of y axis.</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">),</span>  <span class="k">optional</span><span class="kd">::</span> <span class="n">ny2</span>           <span class="c">!&lt; Final node of y axis.</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">),</span>  <span class="k">optional</span><span class="kd">::</span> <span class="n">nz1</span>           <span class="c">!&lt; Initial node of z axis.</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">),</span>  <span class="k">optional</span><span class="kd">::</span> <span class="n">nz2</span>           <span class="c">!&lt; Final node of z axis.</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">)</span><span class="kd">::</span>                        <span class="n">E_IO</span>          <span class="c">!&lt; Input/Output inquiring flag: $0$ if IO is done, $&gt; 0$ if IO is not done.</span>
  <span class="kt">character</span><span class="p">(</span><span class="nb">len</span><span class="o">=</span><span class="n">maxlen</span><span class="p">)</span><span class="kd">::</span>               <span class="n">s_buffer</span>      <span class="c">!&lt; Buffer string.</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">)</span><span class="kd">::</span>                        <span class="n">rf</span>            <span class="c">!&lt; Real file index.</span>
  <span class="c">!---------------------------------------------------------------------------------------------------------------------------------</span>

  <span class="c">!---------------------------------------------------------------------------------------------------------------------------------</span>
  <span class="n">E_IO</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1_I4P</span>
  <span class="k">if</span> <span class="p">(.</span><span class="nb">not</span><span class="p">.</span><span class="n">ir_initialized</span><span class="p">)</span> <span class="k">call </span><span class="n">IR_Init</span>
  <span class="k">call </span><span class="n">vtk_update</span><span class="p">(</span><span class="n">act</span><span class="o">=</span><span class="s1">&#39;add&#39;</span><span class="p">,</span><span class="n">cf</span><span class="o">=</span><span class="n">rf</span><span class="p">,</span><span class="n">Nvtk</span><span class="o">=</span><span class="n">Nvtk</span><span class="p">,</span><span class="n">vtk</span><span class="o">=</span><span class="n">vtk</span><span class="p">)</span>
  <span class="n">f</span> <span class="o">=</span> <span class="n">rf</span>
  <span class="k">if</span> <span class="p">(</span><span class="nb">present</span><span class="p">(</span><span class="n">cf</span><span class="p">))</span> <span class="n">cf</span> <span class="o">=</span> <span class="n">rf</span>
  <span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">topology</span> <span class="o">=</span> <span class="nb">trim</span><span class="p">(</span><span class="n">mesh_topology</span><span class="p">)</span>
  <span class="k">select case</span><span class="p">(</span><span class="nb">trim</span><span class="p">(</span><span class="n">Upper_Case</span><span class="p">(</span><span class="n">output_format</span><span class="p">)))</span>
  <span class="k">case</span><span class="p">(</span><span class="s1">&#39;ASCII&#39;</span><span class="p">)</span>
    <span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">f</span> <span class="o">=</span> <span class="n">ascii</span>
    <span class="k">open</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">Get_Unit</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">),</span><span class="k">file</span><span class="o">=</span><span class="nb">trim</span><span class="p">(</span><span class="n">filename</span><span class="p">),</span><span class="n">form</span><span class="o">=</span><span class="s1">&#39;FORMATTED&#39;</span><span class="p">,&amp;</span>
         <span class="nb">access</span><span class="o">=</span><span class="s1">&#39;SEQUENTIAL&#39;</span><span class="p">,</span><span class="n">action</span><span class="o">=</span><span class="s1">&#39;WRITE&#39;</span><span class="p">,</span><span class="n">status</span><span class="o">=</span><span class="s1">&#39;REPLACE&#39;</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span>
    <span class="c">! writing header of file</span>
    <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;(A)&#39;</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="s1">&#39;&lt;?xml version=&quot;1.0&quot;?&gt;&#39;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">endian</span><span class="o">==</span><span class="n">endianL</span><span class="p">)</span> <span class="k">then</span>
<span class="k">      </span><span class="n">s_buffer</span> <span class="o">=</span> <span class="s1">&#39;&lt;VTKFile type=&quot;&#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">topology</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&quot; version=&quot;0.1&quot; byte_order=&quot;LittleEndian&quot;&gt;&#39;</span>
    <span class="k">else</span>
<span class="k">      </span><span class="n">s_buffer</span> <span class="o">=</span> <span class="s1">&#39;&lt;VTKFile type=&quot;&#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">topology</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&quot; version=&quot;0.1&quot; byte_order=&quot;BigEndian&quot;&gt;&#39;</span>
    <span class="n">endif</span>
    <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;(A)&#39;</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">trim</span><span class="p">(</span><span class="n">s_buffer</span><span class="p">)</span> <span class="p">;</span> <span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span> <span class="o">=</span> <span class="mi">2</span>
    <span class="k">select case</span><span class="p">(</span><span class="nb">trim</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">topology</span><span class="p">))</span>
    <span class="k">case</span><span class="p">(</span><span class="s1">&#39;RectilinearGrid&#39;</span><span class="p">,</span><span class="s1">&#39;StructuredGrid&#39;</span><span class="p">)</span>
      <span class="n">s_buffer</span> <span class="o">=</span> <span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;&#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">topology</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39; WholeExtent=&quot;&#39;</span><span class="o">//</span><span class="p">&amp;</span>
                 <span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">nx1</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39; &#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">nx2</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39; &#39;</span><span class="o">//</span>                             <span class="p">&amp;</span>
                 <span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">ny1</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39; &#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">ny2</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39; &#39;</span><span class="o">//</span>                             <span class="p">&amp;</span>
                 <span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">nz1</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39; &#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">nz2</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39;&quot;&gt;&#39;</span>
    <span class="k">case</span><span class="p">(</span><span class="s1">&#39;UnstructuredGrid&#39;</span><span class="p">)</span>
      <span class="n">s_buffer</span> <span class="o">=</span> <span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;&#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">topology</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&gt;&#39;</span>
    <span class="n">endselect</span>
    <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;(A)&#39;</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">trim</span><span class="p">(</span><span class="n">s_buffer</span><span class="p">)</span> <span class="p">;</span> <span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span> <span class="o">=</span> <span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span> <span class="o">+</span> <span class="mi">2</span>
  <span class="k">case</span><span class="p">(</span><span class="s1">&#39;RAW&#39;</span><span class="p">,</span><span class="s1">&#39;BINARY-APPENDED&#39;</span><span class="p">)</span>
    <span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">f</span> <span class="o">=</span> <span class="n">raw</span>
    <span class="k">if</span> <span class="p">(</span><span class="nb">trim</span><span class="p">(</span><span class="n">Upper_Case</span><span class="p">(</span><span class="n">output_format</span><span class="p">))</span><span class="o">==</span><span class="s1">&#39;BINARY-APPENDED&#39;</span><span class="p">)</span> <span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">f</span> <span class="o">=</span> <span class="n">bin_app</span>
    <span class="k">open</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">Get_Unit</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">),</span><span class="k">file</span><span class="o">=</span><span class="nb">trim</span><span class="p">(</span><span class="n">filename</span><span class="p">),&amp;</span>
         <span class="n">form</span><span class="o">=</span><span class="s1">&#39;UNFORMATTED&#39;</span><span class="p">,</span><span class="nb">access</span><span class="o">=</span><span class="s1">&#39;STREAM&#39;</span><span class="p">,</span><span class="n">action</span><span class="o">=</span><span class="s1">&#39;WRITE&#39;</span><span class="p">,</span><span class="n">status</span><span class="o">=</span><span class="s1">&#39;REPLACE&#39;</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span>
    <span class="c">! writing header of file</span>
    <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="s1">&#39;&lt;?xml version=&quot;1.0&quot;?&gt;&#39;</span><span class="o">//</span><span class="n">end_rec</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">endian</span><span class="o">==</span><span class="n">endianL</span><span class="p">)</span> <span class="k">then</span>
<span class="k">      </span><span class="n">s_buffer</span> <span class="o">=</span> <span class="s1">&#39;&lt;VTKFile type=&quot;&#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">topology</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&quot; version=&quot;0.1&quot; byte_order=&quot;LittleEndian&quot;&gt;&#39;</span>
    <span class="k">else</span>
<span class="k">      </span><span class="n">s_buffer</span> <span class="o">=</span> <span class="s1">&#39;&lt;VTKFile type=&quot;&#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">topology</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&quot; version=&quot;0.1&quot; byte_order=&quot;BigEndian&quot;&gt;&#39;</span>
    <span class="n">endif</span>
    <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">trim</span><span class="p">(</span><span class="n">s_buffer</span><span class="p">)</span><span class="o">//</span><span class="n">end_rec</span> <span class="p">;</span> <span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span> <span class="o">=</span> <span class="mi">2</span>
    <span class="k">select case</span><span class="p">(</span><span class="nb">trim</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">topology</span><span class="p">))</span>
    <span class="k">case</span><span class="p">(</span><span class="s1">&#39;RectilinearGrid&#39;</span><span class="p">,</span><span class="s1">&#39;StructuredGrid&#39;</span><span class="p">)</span>
      <span class="n">s_buffer</span> <span class="o">=</span> <span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;&#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">topology</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39; WholeExtent=&quot;&#39;</span><span class="o">//</span><span class="p">&amp;</span>
                 <span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">nx1</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39; &#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">nx2</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39; &#39;</span><span class="o">//</span>                             <span class="p">&amp;</span>
                 <span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">ny1</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39; &#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">ny2</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39; &#39;</span><span class="o">//</span>                             <span class="p">&amp;</span>
                 <span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">nz1</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39; &#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">nz2</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39;&quot;&gt;&#39;</span>
    <span class="k">case</span><span class="p">(</span><span class="s1">&#39;UnstructuredGrid&#39;</span><span class="p">)</span>
      <span class="n">s_buffer</span> <span class="o">=</span> <span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;&#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">topology</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&gt;&#39;</span>
    <span class="n">endselect</span>
    <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">trim</span><span class="p">(</span><span class="n">s_buffer</span><span class="p">)</span><span class="o">//</span><span class="n">end_rec</span> <span class="p">;</span> <span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span> <span class="o">=</span> <span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span> <span class="o">+</span> <span class="mi">2</span>
    <span class="c">! opening the SCRATCH file used for appending raw binary data</span>
    <span class="k">open</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">Get_Unit</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">ua</span><span class="p">),</span> <span class="n">form</span><span class="o">=</span><span class="s1">&#39;UNFORMATTED&#39;</span><span class="p">,</span> <span class="nb">access</span><span class="o">=</span><span class="s1">&#39;STREAM&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;READWRITE&#39;</span><span class="p">,</span> <span class="n">status</span><span class="o">=</span><span class="s1">&#39;SCRATCH&#39;</span><span class="p">,</span> <span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span>
    <span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">ioffset</span> <span class="o">=</span> <span class="mi">0</span> <span class="c">! initializing offset pointer</span>
  <span class="k">case</span><span class="p">(</span><span class="s1">&#39;BINARY&#39;</span><span class="p">)</span>
    <span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">f</span> <span class="o">=</span> <span class="n">binary</span>
    <span class="k">open</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">Get_Unit</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">),</span><span class="k">file</span><span class="o">=</span><span class="nb">trim</span><span class="p">(</span><span class="n">filename</span><span class="p">),&amp;</span>
         <span class="n">form</span><span class="o">=</span><span class="s1">&#39;UNFORMATTED&#39;</span><span class="p">,</span><span class="nb">access</span><span class="o">=</span><span class="s1">&#39;STREAM&#39;</span><span class="p">,</span><span class="n">action</span><span class="o">=</span><span class="s1">&#39;WRITE&#39;</span><span class="p">,</span><span class="n">status</span><span class="o">=</span><span class="s1">&#39;REPLACE&#39;</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span>
    <span class="c">! writing header of file</span>
    <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="s1">&#39;&lt;?xml version=&quot;1.0&quot;?&gt;&#39;</span><span class="o">//</span><span class="n">end_rec</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">endian</span><span class="o">==</span><span class="n">endianL</span><span class="p">)</span> <span class="k">then</span>
<span class="k">      </span><span class="n">s_buffer</span> <span class="o">=</span> <span class="s1">&#39;&lt;VTKFile type=&quot;&#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">topology</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&quot; version=&quot;0.1&quot; byte_order=&quot;LittleEndian&quot;&gt;&#39;</span>
    <span class="k">else</span>
<span class="k">      </span><span class="n">s_buffer</span> <span class="o">=</span> <span class="s1">&#39;&lt;VTKFile type=&quot;&#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">topology</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&quot; version=&quot;0.1&quot; byte_order=&quot;BigEndian&quot;&gt;&#39;</span>
    <span class="n">endif</span>
    <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">trim</span><span class="p">(</span><span class="n">s_buffer</span><span class="p">)</span><span class="o">//</span><span class="n">end_rec</span> <span class="p">;</span> <span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span> <span class="o">=</span> <span class="mi">2</span>
    <span class="k">select case</span><span class="p">(</span><span class="nb">trim</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">topology</span><span class="p">))</span>
    <span class="k">case</span><span class="p">(</span><span class="s1">&#39;RectilinearGrid&#39;</span><span class="p">,</span><span class="s1">&#39;StructuredGrid&#39;</span><span class="p">)</span>
      <span class="n">s_buffer</span> <span class="o">=</span> <span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;&#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">topology</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39; WholeExtent=&quot;&#39;</span><span class="o">//</span><span class="p">&amp;</span>
                 <span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">nx1</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39; &#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">nx2</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39; &#39;</span><span class="o">//</span>                             <span class="p">&amp;</span>
                 <span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">ny1</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39; &#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">ny2</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39; &#39;</span><span class="o">//</span>                             <span class="p">&amp;</span>
                 <span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">nz1</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39; &#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">nz2</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39;&quot;&gt;&#39;</span>
    <span class="k">case</span><span class="p">(</span><span class="s1">&#39;UnstructuredGrid&#39;</span><span class="p">)</span>
      <span class="n">s_buffer</span> <span class="o">=</span> <span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;&#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">topology</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&gt;&#39;</span>
    <span class="n">endselect</span>
    <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">trim</span><span class="p">(</span><span class="n">s_buffer</span><span class="p">)</span><span class="o">//</span><span class="n">end_rec</span> <span class="p">;</span> <span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span> <span class="o">=</span> <span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span> <span class="o">+</span> <span class="mi">2</span>
  <span class="n">endselect</span>
  <span class="k">return</span>
  <span class="c">!---------------------------------------------------------------------------------------------------------------------------------</span>
  <span class="n">endfunction</span> <span class="n">VTK_INI_XML</span>

  <span class="c">!&gt; @ingroup Lib_VTK_IOPrivateProcedure</span>
  <span class="c">!&gt; @{</span>
  <span class="c">!&gt; Function for open/close field data tag.</span>
  <span class="c">!&gt; @return E_IO: integer(I4P) error flag</span>
  <span class="k">function </span><span class="n">VTK_FLD_XML_OC</span><span class="p">(</span><span class="n">fld_action</span><span class="p">,</span><span class="n">cf</span><span class="p">)</span> <span class="k">result</span><span class="p">(</span><span class="n">E_IO</span><span class="p">)</span>
  <span class="c">!---------------------------------------------------------------------------------------------------------------------------------</span>
  <span class="k">implicit none</span>
<span class="k">  </span><span class="kt">character</span><span class="p">(</span><span class="o">*</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span><span class="kd">::</span>           <span class="n">fld_action</span> <span class="c">!&lt; Field data tag action: OPEN or CLOSE tag.</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">),</span> <span class="k">optional</span><span class="kd">::</span> <span class="n">cf</span>         <span class="c">!&lt; Current file index (for concurrent files IO).</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">)</span><span class="kd">::</span>                       <span class="n">E_IO</span>       <span class="c">!&lt; Input/Output inquiring flag: $0$ if IO is done, $&gt; 0$ if IO is not done.</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">)</span><span class="kd">::</span>                       <span class="n">rf</span>         <span class="c">!&lt; Real file index.</span>
  <span class="c">!---------------------------------------------------------------------------------------------------------------------------------</span>

  <span class="c">!---------------------------------------------------------------------------------------------------------------------------------</span>
  <span class="n">E_IO</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1_I4P</span>
  <span class="n">rf</span> <span class="o">=</span> <span class="n">f</span>
  <span class="k">if</span> <span class="p">(</span><span class="nb">present</span><span class="p">(</span><span class="n">cf</span><span class="p">))</span> <span class="k">then</span>
<span class="k">    </span><span class="n">rf</span> <span class="o">=</span> <span class="n">cf</span> <span class="p">;</span> <span class="n">f</span> <span class="o">=</span> <span class="n">cf</span>
  <span class="n">endif</span>
  <span class="k">select case</span><span class="p">(</span><span class="nb">trim</span><span class="p">(</span><span class="n">Upper_Case</span><span class="p">(</span><span class="n">fld_action</span><span class="p">)))</span>
  <span class="k">case</span><span class="p">(</span><span class="s1">&#39;OPEN&#39;</span><span class="p">)</span>
    <span class="k">select case</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">f</span><span class="p">)</span>
    <span class="k">case</span><span class="p">(</span><span class="n">ascii</span><span class="p">)</span>
      <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;(A)&#39;</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;FieldData&gt;&#39;</span> <span class="p">;</span> <span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span> <span class="o">=</span> <span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span> <span class="o">+</span> <span class="mi">2</span>
    <span class="k">case</span><span class="p">(</span><span class="n">raw</span><span class="p">,</span><span class="n">binary</span><span class="p">,</span><span class="n">bin_app</span><span class="p">)</span>
      <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;FieldData&gt;&#39;</span><span class="o">//</span><span class="n">end_rec</span> <span class="p">;</span> <span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span> <span class="o">=</span> <span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span> <span class="o">+</span> <span class="mi">2</span>
    <span class="n">endselect</span>
  <span class="k">case</span><span class="p">(</span><span class="s1">&#39;CLOSE&#39;</span><span class="p">)</span>
    <span class="k">select case</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">f</span><span class="p">)</span>
    <span class="k">case</span><span class="p">(</span><span class="n">ascii</span><span class="p">)</span>
      <span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span> <span class="o">=</span> <span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span> <span class="o">-</span> <span class="mi">2</span> <span class="p">;</span> <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;(A)&#39;</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;/FieldData&gt;&#39;</span>
    <span class="k">case</span><span class="p">(</span><span class="n">raw</span><span class="p">,</span><span class="n">binary</span><span class="p">,</span><span class="n">bin_app</span><span class="p">)</span>
      <span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span> <span class="o">=</span> <span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span> <span class="o">-</span> <span class="mi">2</span> <span class="p">;</span> <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;/FieldData&gt;&#39;</span><span class="o">//</span><span class="n">end_rec</span>
    <span class="n">endselect</span>
  <span class="n">endselect</span>
  <span class="k">return</span>
  <span class="c">!---------------------------------------------------------------------------------------------------------------------------------</span>
  <span class="n">endfunction</span> <span class="n">VTK_FLD_XML_OC</span>

  <span class="c">!&gt; Function for saving field data (global auxiliary data, e.g. time, step number, data set name...) (R8P).</span>
  <span class="c">!&gt; @return E_IO: integer(I4P) error flag</span>
  <span class="k">function </span><span class="n">VTK_FLD_XML_R8</span><span class="p">(</span><span class="n">fld</span><span class="p">,</span><span class="n">fname</span><span class="p">,</span><span class="n">cf</span><span class="p">)</span> <span class="k">result</span><span class="p">(</span><span class="n">E_IO</span><span class="p">)</span>
  <span class="c">!---------------------------------------------------------------------------------------------------------------------------------</span>
  <span class="k">implicit none</span>
<span class="k">  </span><span class="kt">real</span><span class="p">(</span><span class="n">R8P</span><span class="p">),</span>    <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span><span class="kd">::</span>           <span class="n">fld</span>      <span class="c">!&lt; Field data value.</span>
  <span class="kt">character</span><span class="p">(</span><span class="o">*</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span><span class="kd">::</span>           <span class="n">fname</span>    <span class="c">!&lt; Field data name.</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">),</span> <span class="k">optional</span><span class="kd">::</span> <span class="n">cf</span>       <span class="c">!&lt; Current file index (for concurrent files IO).</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">)</span><span class="kd">::</span>                       <span class="n">E_IO</span>     <span class="c">!&lt; Input/Output inquiring flag: $0$ if IO is done, $&gt; 0$ if IO is not done.</span>
  <span class="kt">character</span><span class="p">(</span><span class="nb">len</span><span class="o">=</span><span class="n">maxlen</span><span class="p">)</span><span class="kd">::</span>              <span class="n">s_buffer</span> <span class="c">!&lt; Buffer string.</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I1P</span><span class="p">),</span> <span class="k">allocatable</span><span class="kd">::</span>          <span class="n">fldp</span><span class="p">(:)</span>  <span class="c">!&lt; Packed field data.</span>
  <span class="kt">character</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="k">allocatable</span><span class="kd">::</span>          <span class="n">fld64</span><span class="p">(:)</span> <span class="c">!&lt; Field data encoded in base64.</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">)</span><span class="kd">::</span>                       <span class="n">rf</span>       <span class="c">!&lt; Real file index.</span>
  <span class="c">!---------------------------------------------------------------------------------------------------------------------------------</span>

  <span class="c">!---------------------------------------------------------------------------------------------------------------------------------</span>
  <span class="n">E_IO</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1_I4P</span>
  <span class="n">rf</span> <span class="o">=</span> <span class="n">f</span>
  <span class="k">if</span> <span class="p">(</span><span class="nb">present</span><span class="p">(</span><span class="n">cf</span><span class="p">))</span> <span class="k">then</span>
<span class="k">    </span><span class="n">rf</span> <span class="o">=</span> <span class="n">cf</span> <span class="p">;</span> <span class="n">f</span> <span class="o">=</span> <span class="n">cf</span>
  <span class="n">endif</span>
  <span class="k">select case</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">f</span><span class="p">)</span>
  <span class="k">case</span><span class="p">(</span><span class="n">ascii</span><span class="p">)</span>
    <span class="n">s_buffer</span><span class="o">=</span><span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;DataArray type=&quot;Float64&quot; NumberOfTuples=&quot;1&quot; Name=&quot;&#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&quot; format=&quot;ascii&quot;&gt;&#39;</span><span class="o">//</span><span class="p">&amp;</span>
             <span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">fld</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39;&lt;/DataArray&gt;&#39;</span>
    <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;(A)&#39;</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">trim</span><span class="p">(</span><span class="n">s_buffer</span><span class="p">)</span>
  <span class="k">case</span><span class="p">(</span><span class="n">raw</span><span class="p">,</span><span class="n">bin_app</span><span class="p">)</span>
    <span class="n">s_buffer</span><span class="o">=</span><span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;DataArray type=&quot;Float64&quot; NumberOfTuples=&quot;1&quot; Name=&quot;&#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span><span class="o">//</span> <span class="p">&amp;</span>
             <span class="s1">&#39;&quot; format=&quot;appended&quot; offset=&quot;&#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(.</span><span class="n">true</span><span class="p">.,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">ioffset</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39;&quot;/&gt;&#39;</span>
    <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">trim</span><span class="p">(</span><span class="n">s_buffer</span><span class="p">)</span><span class="o">//</span><span class="n">end_rec</span>
    <span class="k">call </span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">byte_update</span><span class="p">(</span><span class="n">N_Byte</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">BYR8P</span><span class="p">,</span><span class="n">I4P</span><span class="p">))</span>
    <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">ua</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">N_Byte</span><span class="p">,</span><span class="s1">&#39;R8&#39;</span><span class="p">,</span><span class="mi">1_I4P</span>
    <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">ua</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="n">fld</span>
  <span class="k">case</span><span class="p">(</span><span class="n">binary</span><span class="p">)</span>
    <span class="n">s_buffer</span><span class="o">=</span><span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;DataArray type=&quot;Float64&quot; NumberOfTuples=&quot;1&quot; Name=&quot;&#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&quot; format=&quot;binary&quot;&gt;&#39;</span>
    <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">trim</span><span class="p">(</span><span class="n">s_buffer</span><span class="p">)</span><span class="o">//</span><span class="n">end_rec</span>
    <span class="k">call </span><span class="n">pack_data</span><span class="p">(</span><span class="n">a1</span><span class="o">=</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">BYR8P</span><span class="p">,</span><span class="n">I4P</span><span class="p">)],</span><span class="n">a2</span><span class="o">=</span><span class="p">[</span><span class="n">fld</span><span class="p">],</span><span class="n">packed</span><span class="o">=</span><span class="n">fldp</span><span class="p">)</span>
    <span class="k">call </span><span class="n">b64_encode</span><span class="p">(</span><span class="n">nB</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">BYI1P</span><span class="p">,</span><span class="n">I4P</span><span class="p">),</span><span class="n">n</span><span class="o">=</span><span class="n">fldp</span><span class="p">,</span><span class="n">code</span><span class="o">=</span><span class="n">fld64</span><span class="p">)</span> <span class="p">;</span> <span class="k">deallocate</span><span class="p">(</span><span class="n">fldp</span><span class="p">)</span>
    <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="o">+</span><span class="mi">2</span><span class="p">)</span><span class="o">//</span><span class="n">tochar</span><span class="p">(</span><span class="n">fld64</span><span class="p">)</span><span class="o">//</span><span class="n">end_rec</span> <span class="p">;</span> <span class="k">deallocate</span><span class="p">(</span><span class="n">fld64</span><span class="p">)</span>
    <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;/DataArray&gt;&#39;</span><span class="o">//</span><span class="n">end_rec</span>
  <span class="n">endselect</span>
  <span class="k">return</span>
  <span class="c">!---------------------------------------------------------------------------------------------------------------------------------</span>
  <span class="n">endfunction</span> <span class="n">VTK_FLD_XML_R8</span>

  <span class="c">!&gt; Function for saving field data (global auxiliary data, e.g. time, step number, data set name...) (R4P).</span>
  <span class="c">!&gt; @return E_IO: integer(I4P) error flag</span>
  <span class="k">function </span><span class="n">VTK_FLD_XML_R4</span><span class="p">(</span><span class="n">fld</span><span class="p">,</span><span class="n">fname</span><span class="p">,</span><span class="n">cf</span><span class="p">)</span> <span class="k">result</span><span class="p">(</span><span class="n">E_IO</span><span class="p">)</span>
  <span class="c">!---------------------------------------------------------------------------------------------------------------------------------</span>
  <span class="k">implicit none</span>
<span class="k">  </span><span class="kt">real</span><span class="p">(</span><span class="n">R4P</span><span class="p">),</span>    <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span><span class="kd">::</span>           <span class="n">fld</span>      <span class="c">!&lt; Field data value.</span>
  <span class="kt">character</span><span class="p">(</span><span class="o">*</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span><span class="kd">::</span>           <span class="n">fname</span>    <span class="c">!&lt; Field data name.</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">),</span> <span class="k">optional</span><span class="kd">::</span> <span class="n">cf</span>       <span class="c">!&lt; Current file index (for concurrent files IO).</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">)</span><span class="kd">::</span>                       <span class="n">E_IO</span>     <span class="c">!&lt; Input/Output inquiring flag: $0$ if IO is done, $&gt; 0$ if IO is not done.</span>
  <span class="kt">character</span><span class="p">(</span><span class="nb">len</span><span class="o">=</span><span class="n">maxlen</span><span class="p">)</span><span class="kd">::</span>              <span class="n">s_buffer</span> <span class="c">!&lt; Buffer string.</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I1P</span><span class="p">),</span> <span class="k">allocatable</span><span class="kd">::</span>          <span class="n">fldp</span><span class="p">(:)</span>  <span class="c">!&lt; Packed field data.</span>
  <span class="kt">character</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="k">allocatable</span><span class="kd">::</span>          <span class="n">fld64</span><span class="p">(:)</span> <span class="c">!&lt; Field data encoded in base64.</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">)</span><span class="kd">::</span>                       <span class="n">rf</span>       <span class="c">!&lt; Real file index.</span>
  <span class="c">!---------------------------------------------------------------------------------------------------------------------------------</span>

  <span class="c">!---------------------------------------------------------------------------------------------------------------------------------</span>
  <span class="n">E_IO</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1_I4P</span>
  <span class="n">rf</span> <span class="o">=</span> <span class="n">f</span>
  <span class="k">if</span> <span class="p">(</span><span class="nb">present</span><span class="p">(</span><span class="n">cf</span><span class="p">))</span> <span class="k">then</span>
<span class="k">    </span><span class="n">rf</span> <span class="o">=</span> <span class="n">cf</span> <span class="p">;</span> <span class="n">f</span> <span class="o">=</span> <span class="n">cf</span>
  <span class="n">endif</span>
  <span class="k">select case</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">f</span><span class="p">)</span>
  <span class="k">case</span><span class="p">(</span><span class="n">ascii</span><span class="p">)</span>
    <span class="n">s_buffer</span><span class="o">=</span><span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;DataArray type=&quot;Float32&quot; NumberOfTuples=&quot;1&quot; Name=&quot;&#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&quot; format=&quot;ascii&quot;&gt;&#39;</span><span class="o">//</span><span class="p">&amp;</span>
             <span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">fld</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39;&lt;/DataArray&gt;&#39;</span>
    <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;(A)&#39;</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">trim</span><span class="p">(</span><span class="n">s_buffer</span><span class="p">)</span>
  <span class="k">case</span><span class="p">(</span><span class="n">raw</span><span class="p">,</span><span class="n">bin_app</span><span class="p">)</span>
    <span class="n">s_buffer</span><span class="o">=</span><span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;DataArray type=&quot;Float32&quot; NumberOfTuples=&quot;1&quot; Name=&quot;&#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span><span class="o">//</span> <span class="p">&amp;</span>
             <span class="s1">&#39;&quot; format=&quot;appended&quot; offset=&quot;&#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(.</span><span class="n">true</span><span class="p">.,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">ioffset</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39;&quot;/&gt;&#39;</span>
    <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">trim</span><span class="p">(</span><span class="n">s_buffer</span><span class="p">)</span><span class="o">//</span><span class="n">end_rec</span>
    <span class="k">call </span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">byte_update</span><span class="p">(</span><span class="n">N_Byte</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">BYR4P</span><span class="p">,</span><span class="n">I4P</span><span class="p">))</span>
    <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">ua</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">N_Byte</span><span class="p">,</span><span class="s1">&#39;R4&#39;</span><span class="p">,</span><span class="mi">1_I4P</span>
    <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">ua</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="n">fld</span>
  <span class="k">case</span><span class="p">(</span><span class="n">binary</span><span class="p">)</span>
    <span class="n">s_buffer</span><span class="o">=</span><span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;DataArray type=&quot;Float32&quot; NumberOfTuples=&quot;1&quot; Name=&quot;&#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&quot; format=&quot;binary&quot;&gt;&#39;</span>
    <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">trim</span><span class="p">(</span><span class="n">s_buffer</span><span class="p">)</span><span class="o">//</span><span class="n">end_rec</span>
    <span class="k">call </span><span class="n">pack_data</span><span class="p">(</span><span class="n">a1</span><span class="o">=</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">BYR4P</span><span class="p">,</span><span class="n">I4P</span><span class="p">)],</span><span class="n">a2</span><span class="o">=</span><span class="p">[</span><span class="n">fld</span><span class="p">],</span><span class="n">packed</span><span class="o">=</span><span class="n">fldp</span><span class="p">)</span>
    <span class="k">call </span><span class="n">b64_encode</span><span class="p">(</span><span class="n">nB</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">BYI1P</span><span class="p">,</span><span class="n">I4P</span><span class="p">),</span><span class="n">n</span><span class="o">=</span><span class="n">fldp</span><span class="p">,</span><span class="n">code</span><span class="o">=</span><span class="n">fld64</span><span class="p">)</span> <span class="p">;</span> <span class="k">deallocate</span><span class="p">(</span><span class="n">fldp</span><span class="p">)</span>
    <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="o">+</span><span class="mi">2</span><span class="p">)</span><span class="o">//</span><span class="n">tochar</span><span class="p">(</span><span class="n">fld64</span><span class="p">)</span><span class="o">//</span><span class="n">end_rec</span> <span class="p">;</span> <span class="k">deallocate</span><span class="p">(</span><span class="n">fld64</span><span class="p">)</span>
    <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;/DataArray&gt;&#39;</span><span class="o">//</span><span class="n">end_rec</span>
  <span class="n">endselect</span>
  <span class="k">return</span>
  <span class="c">!---------------------------------------------------------------------------------------------------------------------------------</span>
  <span class="n">endfunction</span> <span class="n">VTK_FLD_XML_R4</span>

  <span class="c">!&gt; Function for saving field data (global auxiliary data, e.g. time, step number, data set name...) (I8P).</span>
  <span class="c">!&gt; @return E_IO: integer(I4P) error flag</span>
  <span class="k">function </span><span class="n">VTK_FLD_XML_I8</span><span class="p">(</span><span class="n">fld</span><span class="p">,</span><span class="n">fname</span><span class="p">,</span><span class="n">cf</span><span class="p">)</span> <span class="k">result</span><span class="p">(</span><span class="n">E_IO</span><span class="p">)</span>
  <span class="c">!---------------------------------------------------------------------------------------------------------------------------------</span>
  <span class="k">implicit none</span>
<span class="k">  </span><span class="kt">integer</span><span class="p">(</span><span class="n">I8P</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span><span class="kd">::</span>           <span class="n">fld</span>      <span class="c">!&lt; Field data value.</span>
  <span class="kt">character</span><span class="p">(</span><span class="o">*</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span><span class="kd">::</span>           <span class="n">fname</span>    <span class="c">!&lt; Field data name.</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">),</span> <span class="k">optional</span><span class="kd">::</span> <span class="n">cf</span>       <span class="c">!&lt; Current file index (for concurrent files IO).</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">)</span><span class="kd">::</span>                       <span class="n">E_IO</span>     <span class="c">!&lt; Input/Output inquiring flag: $0$ if IO is done, $&gt; 0$ if IO is not done.</span>
  <span class="kt">character</span><span class="p">(</span><span class="nb">len</span><span class="o">=</span><span class="n">maxlen</span><span class="p">)</span><span class="kd">::</span>              <span class="n">s_buffer</span> <span class="c">!&lt; Buffer string.</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I1P</span><span class="p">),</span> <span class="k">allocatable</span><span class="kd">::</span>          <span class="n">fldp</span><span class="p">(:)</span>  <span class="c">!&lt; Packed field data.</span>
  <span class="kt">character</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="k">allocatable</span><span class="kd">::</span>          <span class="n">fld64</span><span class="p">(:)</span> <span class="c">!&lt; Field data encoded in base64.</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">)</span><span class="kd">::</span>                       <span class="n">rf</span>       <span class="c">!&lt; Real file index.</span>
  <span class="c">!---------------------------------------------------------------------------------------------------------------------------------</span>

  <span class="c">!---------------------------------------------------------------------------------------------------------------------------------</span>
  <span class="n">E_IO</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1_I4P</span>
  <span class="n">rf</span> <span class="o">=</span> <span class="n">f</span>
  <span class="k">if</span> <span class="p">(</span><span class="nb">present</span><span class="p">(</span><span class="n">cf</span><span class="p">))</span> <span class="k">then</span>
<span class="k">    </span><span class="n">rf</span> <span class="o">=</span> <span class="n">cf</span> <span class="p">;</span> <span class="n">f</span> <span class="o">=</span> <span class="n">cf</span>
  <span class="n">endif</span>
  <span class="k">select case</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">f</span><span class="p">)</span>
  <span class="k">case</span><span class="p">(</span><span class="n">ascii</span><span class="p">)</span>
    <span class="n">s_buffer</span> <span class="o">=</span> <span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;DataArray type=&quot;Int64&quot; NumberOfTuples=&quot;1&quot; Name=&quot;&#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&quot; format=&quot;ascii&quot;&gt;&#39;</span><span class="o">//</span> <span class="p">&amp;</span>
               <span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">fld</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39;&lt;/DataArray&gt;&#39;</span>
    <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;(A)&#39;</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">trim</span><span class="p">(</span><span class="n">s_buffer</span><span class="p">)</span>
  <span class="k">case</span><span class="p">(</span><span class="n">raw</span><span class="p">,</span><span class="n">bin_app</span><span class="p">)</span>
    <span class="n">s_buffer</span> <span class="o">=</span> <span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;DataArray type=&quot;Int64&quot; NumberOfTuples=&quot;1&quot; Name=&quot;&#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span><span class="o">//</span> <span class="p">&amp;</span>
               <span class="s1">&#39;&quot; format=&quot;appended&quot; offset=&quot;&#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(.</span><span class="n">true</span><span class="p">.,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">ioffset</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39;&quot;/&gt;&#39;</span>
    <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">trim</span><span class="p">(</span><span class="n">s_buffer</span><span class="p">)</span><span class="o">//</span><span class="n">end_rec</span>
    <span class="k">call </span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">byte_update</span><span class="p">(</span><span class="n">N_Byte</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">BYI8P</span><span class="p">,</span><span class="n">I4P</span><span class="p">))</span>
    <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">ua</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">N_Byte</span><span class="p">,</span><span class="s1">&#39;I8&#39;</span><span class="p">,</span><span class="mi">1_I4P</span>
    <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">ua</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="n">fld</span>
  <span class="k">case</span><span class="p">(</span><span class="n">binary</span><span class="p">)</span>
    <span class="n">s_buffer</span><span class="o">=</span><span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;DataArray type=&quot;Int64&quot; NumberOfTuples=&quot;1&quot; Name=&quot;&#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&quot; format=&quot;binary&quot;&gt;&#39;</span>
    <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">trim</span><span class="p">(</span><span class="n">s_buffer</span><span class="p">)</span><span class="o">//</span><span class="n">end_rec</span>
    <span class="k">call </span><span class="n">pack_data</span><span class="p">(</span><span class="n">a1</span><span class="o">=</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">BYI8P</span><span class="p">,</span><span class="n">I4P</span><span class="p">)],</span><span class="n">a2</span><span class="o">=</span><span class="p">[</span><span class="n">fld</span><span class="p">],</span><span class="n">packed</span><span class="o">=</span><span class="n">fldp</span><span class="p">)</span>
    <span class="k">call </span><span class="n">b64_encode</span><span class="p">(</span><span class="n">nB</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">BYI1P</span><span class="p">,</span><span class="n">I4P</span><span class="p">),</span><span class="n">n</span><span class="o">=</span><span class="n">fldp</span><span class="p">,</span><span class="n">code</span><span class="o">=</span><span class="n">fld64</span><span class="p">)</span> <span class="p">;</span> <span class="k">deallocate</span><span class="p">(</span><span class="n">fldp</span><span class="p">)</span>
    <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="o">+</span><span class="mi">2</span><span class="p">)</span><span class="o">//</span><span class="n">tochar</span><span class="p">(</span><span class="n">fld64</span><span class="p">)</span><span class="o">//</span><span class="n">end_rec</span> <span class="p">;</span> <span class="k">deallocate</span><span class="p">(</span><span class="n">fld64</span><span class="p">)</span>
    <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;/DataArray&gt;&#39;</span><span class="o">//</span><span class="n">end_rec</span>
  <span class="n">endselect</span>
  <span class="k">return</span>
  <span class="c">!---------------------------------------------------------------------------------------------------------------------------------</span>
  <span class="n">endfunction</span> <span class="n">VTK_FLD_XML_I8</span>

  <span class="c">!&gt; Function for saving field data (global auxiliary data, e.g. time, step number, data set name...) (I4P).</span>
  <span class="c">!&gt; @return E_IO: integer(I4P) error flag</span>
  <span class="k">function </span><span class="n">VTK_FLD_XML_I4</span><span class="p">(</span><span class="n">fld</span><span class="p">,</span><span class="n">fname</span><span class="p">,</span><span class="n">cf</span><span class="p">)</span> <span class="k">result</span><span class="p">(</span><span class="n">E_IO</span><span class="p">)</span>
  <span class="c">!---------------------------------------------------------------------------------------------------------------------------------</span>
  <span class="k">implicit none</span>
<span class="k">  </span><span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span><span class="kd">::</span>           <span class="n">fld</span>      <span class="c">!&lt; Field data value.</span>
  <span class="kt">character</span><span class="p">(</span><span class="o">*</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span><span class="kd">::</span>           <span class="n">fname</span>    <span class="c">!&lt; Field data name.</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">),</span> <span class="k">optional</span><span class="kd">::</span> <span class="n">cf</span>       <span class="c">!&lt; Current file index (for concurrent files IO).</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">)</span><span class="kd">::</span>                       <span class="n">E_IO</span>     <span class="c">!&lt; Input/Output inquiring flag: $0$ if IO is done, $&gt; 0$ if IO is not done.</span>
  <span class="kt">character</span><span class="p">(</span><span class="nb">len</span><span class="o">=</span><span class="n">maxlen</span><span class="p">)</span><span class="kd">::</span>              <span class="n">s_buffer</span> <span class="c">!&lt; Buffer string.</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I1P</span><span class="p">),</span> <span class="k">allocatable</span><span class="kd">::</span>          <span class="n">fldp</span><span class="p">(:)</span>  <span class="c">!&lt; Packed field data.</span>
  <span class="kt">character</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="k">allocatable</span><span class="kd">::</span>          <span class="n">fld64</span><span class="p">(:)</span> <span class="c">!&lt; Field data encoded in base64.</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">)</span><span class="kd">::</span>                       <span class="n">rf</span>       <span class="c">!&lt; Real file index.</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I8P</span><span class="p">)</span><span class="kd">::</span>                       <span class="n">Nfldp</span>    <span class="c">!&lt; Dimension of fldp, packed data.</span>
  <span class="c">!---------------------------------------------------------------------------------------------------------------------------------</span>

  <span class="c">!---------------------------------------------------------------------------------------------------------------------------------</span>
  <span class="n">E_IO</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1_I4P</span>
  <span class="n">rf</span> <span class="o">=</span> <span class="n">f</span>
  <span class="k">if</span> <span class="p">(</span><span class="nb">present</span><span class="p">(</span><span class="n">cf</span><span class="p">))</span> <span class="k">then</span>
<span class="k">    </span><span class="n">rf</span> <span class="o">=</span> <span class="n">cf</span> <span class="p">;</span> <span class="n">f</span> <span class="o">=</span> <span class="n">cf</span>
  <span class="n">endif</span>
  <span class="k">select case</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">f</span><span class="p">)</span>
  <span class="k">case</span><span class="p">(</span><span class="n">ascii</span><span class="p">)</span>
    <span class="n">s_buffer</span> <span class="o">=</span> <span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;DataArray type=&quot;Int32&quot; NumberOfTuples=&quot;1&quot; Name=&quot;&#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&quot; format=&quot;ascii&quot;&gt;&#39;</span><span class="o">//</span> <span class="p">&amp;</span>
               <span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">fld</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39;&lt;/DataArray&gt;&#39;</span>
    <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;(A)&#39;</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">trim</span><span class="p">(</span><span class="n">s_buffer</span><span class="p">)</span>
  <span class="k">case</span><span class="p">(</span><span class="n">raw</span><span class="p">,</span><span class="n">bin_app</span><span class="p">)</span>
    <span class="n">s_buffer</span> <span class="o">=</span> <span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;DataArray type=&quot;Int32&quot; NumberOfTuples=&quot;1&quot; Name=&quot;&#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span><span class="o">//</span> <span class="p">&amp;</span>
               <span class="s1">&#39;&quot; format=&quot;appended&quot; offset=&quot;&#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(.</span><span class="n">true</span><span class="p">.,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">ioffset</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39;&quot;/&gt;&#39;</span>
    <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">trim</span><span class="p">(</span><span class="n">s_buffer</span><span class="p">)</span><span class="o">//</span><span class="n">end_rec</span>
    <span class="k">call </span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">byte_update</span><span class="p">(</span><span class="n">N_Byte</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">BYI4P</span><span class="p">,</span><span class="n">I4P</span><span class="p">))</span>
    <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">ua</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">N_Byte</span><span class="p">,</span><span class="s1">&#39;I4&#39;</span><span class="p">,</span><span class="mi">1_I4P</span>
    <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">ua</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="n">fld</span>
  <span class="k">case</span><span class="p">(</span><span class="n">binary</span><span class="p">)</span>
    <span class="n">s_buffer</span><span class="o">=</span><span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;DataArray type=&quot;Int32&quot; NumberOfTuples=&quot;1&quot; Name=&quot;&#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&quot; format=&quot;binary&quot;&gt;&#39;</span>
    <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">trim</span><span class="p">(</span><span class="n">s_buffer</span><span class="p">)</span><span class="o">//</span><span class="n">end_rec</span>
    <span class="n">Nfldp</span><span class="o">=</span><span class="n">size</span><span class="p">(</span><span class="nb">transfer</span><span class="p">([</span><span class="nb">int</span><span class="p">(</span><span class="n">BYI4P</span><span class="p">,</span><span class="n">I4P</span><span class="p">),</span><span class="n">fld</span><span class="p">],</span><span class="n">fldp</span><span class="p">),</span><span class="nb">kind</span><span class="o">=</span><span class="n">I8P</span><span class="p">)</span> <span class="p">;</span> <span class="k">if</span> <span class="p">(</span><span class="nb">allocated</span><span class="p">(</span><span class="n">fldp</span><span class="p">))</span> <span class="k">deallocate</span><span class="p">(</span><span class="n">fldp</span><span class="p">)</span> <span class="p">;</span> <span class="k">allocate</span><span class="p">(</span><span class="n">fldp</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">Nfldp</span><span class="p">))</span>
    <span class="n">fldp</span> <span class="o">=</span> <span class="nb">transfer</span><span class="p">([</span><span class="nb">int</span><span class="p">(</span><span class="n">BYI4P</span><span class="p">,</span><span class="n">I4P</span><span class="p">),</span><span class="n">fld</span><span class="p">],</span><span class="n">fldp</span><span class="p">)</span>
    <span class="k">call </span><span class="n">b64_encode</span><span class="p">(</span><span class="n">nB</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">BYI1P</span><span class="p">,</span><span class="n">I4P</span><span class="p">),</span><span class="n">n</span><span class="o">=</span><span class="n">fldp</span><span class="p">,</span><span class="n">code</span><span class="o">=</span><span class="n">fld64</span><span class="p">)</span> <span class="p">;</span> <span class="k">deallocate</span><span class="p">(</span><span class="n">fldp</span><span class="p">)</span>
    <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="o">+</span><span class="mi">2</span><span class="p">)</span><span class="o">//</span><span class="n">tochar</span><span class="p">(</span><span class="n">fld64</span><span class="p">)</span><span class="o">//</span><span class="n">end_rec</span> <span class="p">;</span> <span class="k">deallocate</span><span class="p">(</span><span class="n">fld64</span><span class="p">)</span>
    <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;/DataArray&gt;&#39;</span><span class="o">//</span><span class="n">end_rec</span>
  <span class="n">endselect</span>
  <span class="k">return</span>
  <span class="c">!---------------------------------------------------------------------------------------------------------------------------------</span>
  <span class="n">endfunction</span> <span class="n">VTK_FLD_XML_I4</span>

  <span class="c">!&gt; Function for saving field data (global auxiliary data, e.g. time, step number, data set name...) (I2P).</span>
  <span class="c">!&gt; @return E_IO: integer(I4P) error flag</span>
  <span class="k">function </span><span class="n">VTK_FLD_XML_I2</span><span class="p">(</span><span class="n">fld</span><span class="p">,</span><span class="n">fname</span><span class="p">,</span><span class="n">cf</span><span class="p">)</span> <span class="k">result</span><span class="p">(</span><span class="n">E_IO</span><span class="p">)</span>
  <span class="c">!---------------------------------------------------------------------------------------------------------------------------------</span>
  <span class="k">implicit none</span>
<span class="k">  </span><span class="kt">integer</span><span class="p">(</span><span class="n">I2P</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span><span class="kd">::</span>           <span class="n">fld</span>      <span class="c">!&lt; Field data value.</span>
  <span class="kt">character</span><span class="p">(</span><span class="o">*</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span><span class="kd">::</span>           <span class="n">fname</span>    <span class="c">!&lt; Field data name.</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">),</span> <span class="k">optional</span><span class="kd">::</span> <span class="n">cf</span>       <span class="c">!&lt; Current file index (for concurrent files IO).</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">)</span><span class="kd">::</span>                       <span class="n">E_IO</span>     <span class="c">!&lt; Input/Output inquiring flag: $0$ if IO is done, $&gt; 0$ if IO is not done.</span>
  <span class="kt">character</span><span class="p">(</span><span class="nb">len</span><span class="o">=</span><span class="n">maxlen</span><span class="p">)</span><span class="kd">::</span>              <span class="n">s_buffer</span> <span class="c">!&lt; Buffer string.</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I1P</span><span class="p">),</span> <span class="k">allocatable</span><span class="kd">::</span>          <span class="n">fldp</span><span class="p">(:)</span>  <span class="c">!&lt; Packed field data.</span>
  <span class="kt">character</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="k">allocatable</span><span class="kd">::</span>          <span class="n">fld64</span><span class="p">(:)</span> <span class="c">!&lt; Field data encoded in base64.</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">)</span><span class="kd">::</span>                       <span class="n">rf</span>       <span class="c">!&lt; Real file index.</span>
  <span class="c">!---------------------------------------------------------------------------------------------------------------------------------</span>

  <span class="c">!---------------------------------------------------------------------------------------------------------------------------------</span>
  <span class="n">E_IO</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1_I4P</span>
  <span class="n">rf</span> <span class="o">=</span> <span class="n">f</span>
  <span class="k">if</span> <span class="p">(</span><span class="nb">present</span><span class="p">(</span><span class="n">cf</span><span class="p">))</span> <span class="k">then</span>
<span class="k">    </span><span class="n">rf</span> <span class="o">=</span> <span class="n">cf</span> <span class="p">;</span> <span class="n">f</span> <span class="o">=</span> <span class="n">cf</span>
  <span class="n">endif</span>
  <span class="k">select case</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">f</span><span class="p">)</span>
  <span class="k">case</span><span class="p">(</span><span class="n">ascii</span><span class="p">)</span>
    <span class="n">s_buffer</span> <span class="o">=</span> <span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;DataArray type=&quot;Int16&quot; NumberOfTuples=&quot;1&quot; Name=&quot;&#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&quot; format=&quot;ascii&quot;&gt;&#39;</span><span class="o">//</span> <span class="p">&amp;</span>
               <span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">fld</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39;&lt;/DataArray&gt;&#39;</span>
    <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;(A)&#39;</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">trim</span><span class="p">(</span><span class="n">s_buffer</span><span class="p">)</span>
  <span class="k">case</span><span class="p">(</span><span class="n">raw</span><span class="p">,</span><span class="n">bin_app</span><span class="p">)</span>
    <span class="n">s_buffer</span> <span class="o">=</span> <span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;DataArray type=&quot;Int16&quot; NumberOfTuples=&quot;1&quot; Name=&quot;&#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span><span class="o">//</span> <span class="p">&amp;</span>
               <span class="s1">&#39;&quot; format=&quot;appended&quot; offset=&quot;&#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(.</span><span class="n">true</span><span class="p">.,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">ioffset</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39;&quot;/&gt;&#39;</span>
    <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">trim</span><span class="p">(</span><span class="n">s_buffer</span><span class="p">)</span><span class="o">//</span><span class="n">end_rec</span>
    <span class="k">call </span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">byte_update</span><span class="p">(</span><span class="n">N_Byte</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">BYI2P</span><span class="p">,</span><span class="n">I4P</span><span class="p">))</span>
    <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">ua</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">N_Byte</span><span class="p">,</span><span class="s1">&#39;I2&#39;</span><span class="p">,</span><span class="mi">1_I4P</span>
    <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">ua</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="n">fld</span>
  <span class="k">case</span><span class="p">(</span><span class="n">binary</span><span class="p">)</span>
    <span class="n">s_buffer</span><span class="o">=</span><span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;DataArray type=&quot;Int16&quot; NumberOfTuples=&quot;1&quot; Name=&quot;&#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&quot; format=&quot;binary&quot;&gt;&#39;</span>
    <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">trim</span><span class="p">(</span><span class="n">s_buffer</span><span class="p">)</span><span class="o">//</span><span class="n">end_rec</span>
    <span class="k">call </span><span class="n">pack_data</span><span class="p">(</span><span class="n">a1</span><span class="o">=</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">BYI2P</span><span class="p">,</span><span class="n">I4P</span><span class="p">)],</span><span class="n">a2</span><span class="o">=</span><span class="p">[</span><span class="n">fld</span><span class="p">],</span><span class="n">packed</span><span class="o">=</span><span class="n">fldp</span><span class="p">)</span>
    <span class="k">call </span><span class="n">b64_encode</span><span class="p">(</span><span class="n">nB</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">BYI1P</span><span class="p">,</span><span class="n">I4P</span><span class="p">),</span><span class="n">n</span><span class="o">=</span><span class="n">fldp</span><span class="p">,</span><span class="n">code</span><span class="o">=</span><span class="n">fld64</span><span class="p">)</span> <span class="p">;</span> <span class="k">deallocate</span><span class="p">(</span><span class="n">fldp</span><span class="p">)</span>
    <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="o">+</span><span class="mi">2</span><span class="p">)</span><span class="o">//</span><span class="n">tochar</span><span class="p">(</span><span class="n">fld64</span><span class="p">)</span><span class="o">//</span><span class="n">end_rec</span> <span class="p">;</span> <span class="k">deallocate</span><span class="p">(</span><span class="n">fld64</span><span class="p">)</span>
    <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;/DataArray&gt;&#39;</span><span class="o">//</span><span class="n">end_rec</span>
  <span class="n">endselect</span>
  <span class="k">return</span>
  <span class="c">!---------------------------------------------------------------------------------------------------------------------------------</span>
  <span class="n">endfunction</span> <span class="n">VTK_FLD_XML_I2</span>

  <span class="c">!&gt; Function for saving field data (global auxiliary data, e.g. time, step number, data set name...) (I1P).</span>
  <span class="c">!&gt; @return E_IO: integer(I4P) error flag</span>
  <span class="k">function </span><span class="n">VTK_FLD_XML_I1</span><span class="p">(</span><span class="n">fld</span><span class="p">,</span><span class="n">fname</span><span class="p">,</span><span class="n">cf</span><span class="p">)</span> <span class="k">result</span><span class="p">(</span><span class="n">E_IO</span><span class="p">)</span>
  <span class="c">!---------------------------------------------------------------------------------------------------------------------------------</span>
  <span class="k">implicit none</span>
<span class="k">  </span><span class="kt">integer</span><span class="p">(</span><span class="n">I1P</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span><span class="kd">::</span>           <span class="n">fld</span>      <span class="c">!&lt; Field data value.</span>
  <span class="kt">character</span><span class="p">(</span><span class="o">*</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span><span class="kd">::</span>           <span class="n">fname</span>    <span class="c">!&lt; Field data name.</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">),</span> <span class="k">optional</span><span class="kd">::</span> <span class="n">cf</span>       <span class="c">!&lt; Current file index (for concurrent files IO).</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">)</span><span class="kd">::</span>                       <span class="n">E_IO</span>     <span class="c">!&lt; Input/Output inquiring flag: $0$ if IO is done, $&gt; 0$ if IO is not done.</span>
  <span class="kt">character</span><span class="p">(</span><span class="nb">len</span><span class="o">=</span><span class="n">maxlen</span><span class="p">)</span><span class="kd">::</span>              <span class="n">s_buffer</span> <span class="c">!&lt; Buffer string.</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I1P</span><span class="p">),</span> <span class="k">allocatable</span><span class="kd">::</span>          <span class="n">fldp</span><span class="p">(:)</span>  <span class="c">!&lt; Packed field data.</span>
  <span class="kt">character</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="k">allocatable</span><span class="kd">::</span>          <span class="n">fld64</span><span class="p">(:)</span> <span class="c">!&lt; Field data encoded in base64.</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">)</span><span class="kd">::</span>                       <span class="n">rf</span>       <span class="c">!&lt; Real file index.</span>
  <span class="c">!---------------------------------------------------------------------------------------------------------------------------------</span>

  <span class="c">!---------------------------------------------------------------------------------------------------------------------------------</span>
  <span class="n">E_IO</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1_I4P</span>
  <span class="n">rf</span> <span class="o">=</span> <span class="n">f</span>
  <span class="k">if</span> <span class="p">(</span><span class="nb">present</span><span class="p">(</span><span class="n">cf</span><span class="p">))</span> <span class="k">then</span>
<span class="k">    </span><span class="n">rf</span> <span class="o">=</span> <span class="n">cf</span> <span class="p">;</span> <span class="n">f</span> <span class="o">=</span> <span class="n">cf</span>
  <span class="n">endif</span>
  <span class="k">select case</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">f</span><span class="p">)</span>
  <span class="k">case</span><span class="p">(</span><span class="n">ascii</span><span class="p">)</span>
    <span class="n">s_buffer</span> <span class="o">=</span> <span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;DataArray type=&quot;Int8&quot; NumberOfTuples=&quot;1&quot; Name=&quot;&#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&quot; format=&quot;ascii&quot;&gt;&#39;</span><span class="o">//</span> <span class="p">&amp;</span>
               <span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">fld</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39;&lt;/DataArray&gt;&#39;</span>
    <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;(A)&#39;</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">trim</span><span class="p">(</span><span class="n">s_buffer</span><span class="p">)</span>
  <span class="k">case</span><span class="p">(</span><span class="n">raw</span><span class="p">,</span><span class="n">bin_app</span><span class="p">)</span>
    <span class="n">s_buffer</span> <span class="o">=</span> <span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;DataArray type=&quot;Int8&quot; NumberOfTuples=&quot;1&quot; Name=&quot;&#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span><span class="o">//</span> <span class="p">&amp;</span>
               <span class="s1">&#39;&quot; format=&quot;appended&quot; offset=&quot;&#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(.</span><span class="n">true</span><span class="p">.,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">ioffset</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39;&quot;/&gt;&#39;</span>
    <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">trim</span><span class="p">(</span><span class="n">s_buffer</span><span class="p">)</span><span class="o">//</span><span class="n">end_rec</span>
    <span class="k">call </span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">byte_update</span><span class="p">(</span><span class="n">N_Byte</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">BYI1P</span><span class="p">,</span><span class="n">I4P</span><span class="p">))</span>
    <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">ua</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">N_Byte</span><span class="p">,</span><span class="s1">&#39;I1&#39;</span><span class="p">,</span><span class="mi">1_I4P</span>
    <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">ua</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="n">fld</span>
  <span class="k">case</span><span class="p">(</span><span class="n">binary</span><span class="p">)</span>
    <span class="n">s_buffer</span><span class="o">=</span><span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;DataArray type=&quot;Int8&quot; NumberOfTuples=&quot;1&quot; Name=&quot;&#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&quot; format=&quot;binary&quot;&gt;&#39;</span>
    <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">trim</span><span class="p">(</span><span class="n">s_buffer</span><span class="p">)</span><span class="o">//</span><span class="n">end_rec</span>
    <span class="k">call </span><span class="n">pack_data</span><span class="p">(</span><span class="n">a1</span><span class="o">=</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">BYI1P</span><span class="p">,</span><span class="n">I4P</span><span class="p">)],</span><span class="n">a2</span><span class="o">=</span><span class="p">[</span><span class="n">fld</span><span class="p">],</span><span class="n">packed</span><span class="o">=</span><span class="n">fldp</span><span class="p">)</span>
    <span class="k">call </span><span class="n">b64_encode</span><span class="p">(</span><span class="n">nB</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">BYI1P</span><span class="p">,</span><span class="n">I4P</span><span class="p">),</span><span class="n">n</span><span class="o">=</span><span class="n">fldp</span><span class="p">,</span><span class="n">code</span><span class="o">=</span><span class="n">fld64</span><span class="p">)</span> <span class="p">;</span> <span class="k">deallocate</span><span class="p">(</span><span class="n">fldp</span><span class="p">)</span>
    <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="o">+</span><span class="mi">2</span><span class="p">)</span><span class="o">//</span><span class="n">tochar</span><span class="p">(</span><span class="n">fld64</span><span class="p">)</span><span class="o">//</span><span class="n">end_rec</span> <span class="p">;</span> <span class="k">deallocate</span><span class="p">(</span><span class="n">fld64</span><span class="p">)</span>
    <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;/DataArray&gt;&#39;</span><span class="o">//</span><span class="n">end_rec</span>
  <span class="n">endselect</span>
  <span class="k">return</span>
  <span class="c">!---------------------------------------------------------------------------------------------------------------------------------</span>
  <span class="n">endfunction</span> <span class="n">VTK_FLD_XML_I1</span>

  <span class="c">!&gt; Function for saving mesh with \b StructuredGrid topology (R8P, 1D Arrays).</span>
  <span class="c">!&gt; @return E_IO: integer(I4P) error flag</span>
  <span class="k">function </span><span class="n">VTK_GEO_XML_STRG_1DA_R8</span><span class="p">(</span><span class="n">nx1</span><span class="p">,</span><span class="n">nx2</span><span class="p">,</span><span class="n">ny1</span><span class="p">,</span><span class="n">ny2</span><span class="p">,</span><span class="n">nz1</span><span class="p">,</span><span class="n">nz2</span><span class="p">,</span><span class="n">NN</span><span class="p">,</span><span class="n">X</span><span class="p">,</span><span class="n">Y</span><span class="p">,</span><span class="n">Z</span><span class="p">,</span><span class="n">cf</span><span class="p">)</span> <span class="k">result</span><span class="p">(</span><span class="n">E_IO</span><span class="p">)</span>
  <span class="c">!---------------------------------------------------------------------------------------------------------------------------------</span>
  <span class="k">implicit none</span>
<span class="k">  </span><span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span><span class="kd">::</span>           <span class="n">nx1</span>      <span class="c">!&lt; Initial node of x axis.</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span><span class="kd">::</span>           <span class="n">nx2</span>      <span class="c">!&lt; Final node of x axis.</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span><span class="kd">::</span>           <span class="n">ny1</span>      <span class="c">!&lt; Initial node of y axis.</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span><span class="kd">::</span>           <span class="n">ny2</span>      <span class="c">!&lt; Final node of y axis.</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span><span class="kd">::</span>           <span class="n">nz1</span>      <span class="c">!&lt; Initial node of z axis.</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span><span class="kd">::</span>           <span class="n">nz2</span>      <span class="c">!&lt; Final node of z axis.</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span><span class="kd">::</span>           <span class="n">NN</span>       <span class="c">!&lt; Number of all nodes.</span>
  <span class="kt">real</span><span class="p">(</span><span class="n">R8P</span><span class="p">),</span>    <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span><span class="kd">::</span>           <span class="n">X</span><span class="p">(</span><span class="mi">1</span><span class="p">:)</span>    <span class="c">!&lt; X coordinates [1:NN].</span>
  <span class="kt">real</span><span class="p">(</span><span class="n">R8P</span><span class="p">),</span>    <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span><span class="kd">::</span>           <span class="n">Y</span><span class="p">(</span><span class="mi">1</span><span class="p">:)</span>    <span class="c">!&lt; Y coordinates [1:NN].</span>
  <span class="kt">real</span><span class="p">(</span><span class="n">R8P</span><span class="p">),</span>    <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span><span class="kd">::</span>           <span class="n">Z</span><span class="p">(</span><span class="mi">1</span><span class="p">:)</span>    <span class="c">!&lt; Z coordinates [1:NN].</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">),</span> <span class="k">optional</span><span class="kd">::</span> <span class="n">cf</span>       <span class="c">!&lt; Current file index (for concurrent files IO).</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">)</span><span class="kd">::</span>                       <span class="n">E_IO</span>     <span class="c">!&lt; Input/Output inquiring flag: $0$ if IO is done, $&gt; 0$ if IO is not done.</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I1P</span><span class="p">),</span> <span class="k">allocatable</span><span class="kd">::</span>          <span class="n">XYZp</span><span class="p">(:)</span>  <span class="c">!&lt; Packed coordinates data.</span>
  <span class="kt">character</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="k">allocatable</span><span class="kd">::</span>          <span class="n">XYZ64</span><span class="p">(:)</span> <span class="c">!&lt; X, Y, Z coordinates encoded in base64.</span>
  <span class="kt">character</span><span class="p">(</span><span class="nb">len</span><span class="o">=</span><span class="n">maxlen</span><span class="p">)</span><span class="kd">::</span>              <span class="n">s_buffer</span> <span class="c">!&lt; Buffer string.</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">)</span><span class="kd">::</span>                       <span class="n">rf</span>       <span class="c">!&lt; Real file index.</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">)</span><span class="kd">::</span>                       <span class="n">n1</span>       <span class="c">!&lt; Counter.</span>
  <span class="c">!---------------------------------------------------------------------------------------------------------------------------------</span>

  <span class="c">!---------------------------------------------------------------------------------------------------------------------------------</span>
  <span class="n">E_IO</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1_I4P</span>
  <span class="n">rf</span> <span class="o">=</span> <span class="n">f</span>
  <span class="k">if</span> <span class="p">(</span><span class="nb">present</span><span class="p">(</span><span class="n">cf</span><span class="p">))</span> <span class="k">then</span>
<span class="k">    </span><span class="n">rf</span> <span class="o">=</span> <span class="n">cf</span> <span class="p">;</span> <span class="n">f</span> <span class="o">=</span> <span class="n">cf</span>
  <span class="n">endif</span>
  <span class="k">select case</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">f</span><span class="p">)</span>
  <span class="k">case</span><span class="p">(</span><span class="n">ascii</span><span class="p">)</span>
    <span class="n">s_buffer</span> <span class="o">=</span> <span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;Piece Extent=&quot;&#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">nx1</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39; &#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">nx2</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39; &#39;</span><span class="o">//</span> <span class="p">&amp;</span>
                                                              <span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">ny1</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39; &#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">ny2</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39; &#39;</span><span class="o">//</span> <span class="p">&amp;</span>
                                                              <span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">nz1</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39; &#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">nz2</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39;&quot;&gt;&#39;</span>
    <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;(A)&#39;</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">trim</span><span class="p">(</span><span class="n">s_buffer</span><span class="p">)</span> <span class="p">;</span> <span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span> <span class="o">=</span> <span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span> <span class="o">+</span> <span class="mi">2</span>
    <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;(A)&#39;</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;Points&gt;&#39;</span> <span class="p">;</span> <span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span> <span class="o">=</span> <span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span> <span class="o">+</span> <span class="mi">2</span>
    <span class="n">s_buffer</span> <span class="o">=</span> <span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;DataArray type=&quot;Float64&quot; NumberOfComponents=&quot;3&quot; Name=&quot;Points&quot; format=&quot;ascii&quot;&gt;&#39;</span>
    <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;(A)&#39;</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">trim</span><span class="p">(</span><span class="n">s_buffer</span><span class="p">)</span>
    <span class="k">do </span><span class="n">n1</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">NN</span>
      <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;(A)&#39;</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="n">str</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">X</span><span class="p">(</span><span class="n">n1</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39; &#39;</span><span class="o">//</span><span class="n">str</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">Y</span><span class="p">(</span><span class="n">n1</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39; &#39;</span><span class="o">//</span><span class="n">str</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">Z</span><span class="p">(</span><span class="n">n1</span><span class="p">))</span>
    <span class="n">enddo</span>
    <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;(A)&#39;</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;/DataArray&gt;&#39;</span> <span class="p">;</span> <span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span> <span class="o">=</span> <span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span> <span class="o">-</span> <span class="mi">2</span>
    <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;(A)&#39;</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;/Points&gt;&#39;</span>
  <span class="k">case</span><span class="p">(</span><span class="n">raw</span><span class="p">,</span><span class="n">bin_app</span><span class="p">)</span>
    <span class="n">s_buffer</span> <span class="o">=</span> <span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;Piece Extent=&quot;&#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">nx1</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39; &#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">nx2</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39; &#39;</span><span class="o">//</span> <span class="p">&amp;</span>
                                                              <span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">ny1</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39; &#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">ny2</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39; &#39;</span><span class="o">//</span> <span class="p">&amp;</span>
                                                              <span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">nz1</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39; &#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">nz2</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39;&quot;&gt;&#39;</span>
    <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">trim</span><span class="p">(</span><span class="n">s_buffer</span><span class="p">)</span><span class="o">//</span><span class="n">end_rec</span> <span class="p">;</span> <span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span> <span class="o">=</span> <span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span> <span class="o">+</span> <span class="mi">2</span>
    <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;Points&gt;&#39;</span><span class="o">//</span><span class="n">end_rec</span> <span class="p">;</span> <span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span> <span class="o">=</span> <span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span> <span class="o">+</span> <span class="mi">2</span>
    <span class="n">s_buffer</span> <span class="o">=</span> <span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span>                                                                  <span class="p">&amp;</span>
               <span class="s1">&#39;&lt;DataArray type=&quot;Float64&quot; NumberOfComponents=&quot;3&quot; Name=&quot;Points&quot; format=&quot;appended&quot; offset=&quot;&#39;</span><span class="o">//</span> <span class="p">&amp;</span>
               <span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(.</span><span class="n">true</span><span class="p">.,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">ioffset</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39;&quot;/&gt;&#39;</span>
    <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">trim</span><span class="p">(</span><span class="n">s_buffer</span><span class="p">)</span><span class="o">//</span><span class="n">end_rec</span>
    <span class="k">call </span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">byte_update</span><span class="p">(</span><span class="n">N_Byte</span> <span class="o">=</span> <span class="mi">3</span><span class="o">*</span><span class="n">NN</span><span class="o">*</span><span class="n">BYR8P</span><span class="p">)</span>
    <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">ua</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">N_Byte</span><span class="p">,</span><span class="s1">&#39;R8&#39;</span><span class="p">,</span><span class="mi">3</span><span class="o">*</span><span class="n">NN</span>
    <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">ua</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)(</span><span class="n">X</span><span class="p">(</span><span class="n">n1</span><span class="p">),</span><span class="n">Y</span><span class="p">(</span><span class="n">n1</span><span class="p">),</span><span class="n">Z</span><span class="p">(</span><span class="n">n1</span><span class="p">),</span><span class="n">n1</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">NN</span><span class="p">)</span>
    <span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span> <span class="o">=</span> <span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span> <span class="o">-</span> <span class="mi">2</span> <span class="p">;</span> <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;/Points&gt;&#39;</span><span class="o">//</span><span class="n">end_rec</span>
  <span class="k">case</span><span class="p">(</span><span class="n">binary</span><span class="p">)</span>
    <span class="n">s_buffer</span> <span class="o">=</span> <span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;Piece Extent=&quot;&#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">nx1</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39; &#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">nx2</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39; &#39;</span><span class="o">//</span> <span class="p">&amp;</span>
                                                              <span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">ny1</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39; &#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">ny2</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39; &#39;</span><span class="o">//</span> <span class="p">&amp;</span>
                                                              <span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">nz1</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39; &#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">nz2</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39;&quot;&gt;&#39;</span>
    <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">trim</span><span class="p">(</span><span class="n">s_buffer</span><span class="p">)</span><span class="o">//</span><span class="n">end_rec</span> <span class="p">;</span> <span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span> <span class="o">=</span> <span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span> <span class="o">+</span> <span class="mi">2</span>
    <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;Points&gt;&#39;</span><span class="o">//</span><span class="n">end_rec</span> <span class="p">;</span> <span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span> <span class="o">=</span> <span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span> <span class="o">+</span> <span class="mi">2</span>
    <span class="n">s_buffer</span> <span class="o">=</span> <span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;DataArray type=&quot;Float64&quot; NumberOfComponents=&quot;3&quot; Name=&quot;Points&quot; format=&quot;binary&quot;&gt;&#39;</span>
    <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">trim</span><span class="p">(</span><span class="n">s_buffer</span><span class="p">)</span><span class="o">//</span><span class="n">end_rec</span>
    <span class="k">call </span><span class="n">pack_data</span><span class="p">(</span><span class="n">a1</span><span class="o">=</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="mi">3</span><span class="o">*</span><span class="n">NN</span><span class="o">*</span><span class="n">BYR8P</span><span class="p">,</span><span class="n">I4P</span><span class="p">)],</span><span class="n">a2</span><span class="o">=</span><span class="p">[(</span><span class="n">X</span><span class="p">(</span><span class="n">n1</span><span class="p">),</span><span class="n">Y</span><span class="p">(</span><span class="n">n1</span><span class="p">),</span><span class="n">Z</span><span class="p">(</span><span class="n">n1</span><span class="p">),</span><span class="n">n1</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">NN</span><span class="p">)],</span><span class="n">packed</span><span class="o">=</span><span class="n">XYZp</span><span class="p">)</span>
    <span class="k">call </span><span class="n">b64_encode</span><span class="p">(</span><span class="n">nB</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">BYI1P</span><span class="p">,</span><span class="n">I4P</span><span class="p">),</span><span class="n">n</span><span class="o">=</span><span class="n">XYZp</span><span class="p">,</span><span class="n">code</span><span class="o">=</span><span class="n">XYZ64</span><span class="p">)</span> <span class="p">;</span> <span class="k">deallocate</span><span class="p">(</span><span class="n">XYZp</span><span class="p">)</span>
    <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="o">+</span><span class="mi">2</span><span class="p">)</span><span class="o">//</span><span class="n">tochar</span><span class="p">(</span><span class="n">XYZ64</span><span class="p">)</span><span class="o">//</span><span class="n">end_rec</span> <span class="p">;</span> <span class="k">deallocate</span><span class="p">(</span><span class="n">XYZ64</span><span class="p">)</span>
    <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;/DataArray&gt;&#39;</span><span class="o">//</span><span class="n">end_rec</span>
    <span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span> <span class="o">=</span> <span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span> <span class="o">-</span> <span class="mi">2</span> <span class="p">;</span> <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;/Points&gt;&#39;</span><span class="o">//</span><span class="n">end_rec</span>
  <span class="n">endselect</span>
  <span class="k">return</span>
  <span class="c">!---------------------------------------------------------------------------------------------------------------------------------</span>
  <span class="n">endfunction</span> <span class="n">VTK_GEO_XML_STRG_1DA_R8</span>

  <span class="c">!&gt; Function for saving mesh with \b StructuredGrid topology (R8P, 3D Arrays).</span>
  <span class="c">!&gt; @return E_IO: integer(I4P) error flag</span>
  <span class="k">function </span><span class="n">VTK_GEO_XML_STRG_3DA_R8</span><span class="p">(</span><span class="n">nx1</span><span class="p">,</span><span class="n">nx2</span><span class="p">,</span><span class="n">ny1</span><span class="p">,</span><span class="n">ny2</span><span class="p">,</span><span class="n">nz1</span><span class="p">,</span><span class="n">nz2</span><span class="p">,</span><span class="n">NN</span><span class="p">,</span><span class="n">X</span><span class="p">,</span><span class="n">Y</span><span class="p">,</span><span class="n">Z</span><span class="p">,</span><span class="n">cf</span><span class="p">)</span> <span class="k">result</span><span class="p">(</span><span class="n">E_IO</span><span class="p">)</span>
  <span class="c">!---------------------------------------------------------------------------------------------------------------------------------</span>
  <span class="k">implicit none</span>
<span class="k">  </span><span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span><span class="kd">::</span>           <span class="n">nx1</span>               <span class="c">!&lt; Initial node of x axis.</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span><span class="kd">::</span>           <span class="n">nx2</span>               <span class="c">!&lt; Final node of x axis.</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span><span class="kd">::</span>           <span class="n">ny1</span>               <span class="c">!&lt; Initial node of y axis.</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span><span class="kd">::</span>           <span class="n">ny2</span>               <span class="c">!&lt; Final node of y axis.</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span><span class="kd">::</span>           <span class="n">nz1</span>               <span class="c">!&lt; Initial node of z axis.</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span><span class="kd">::</span>           <span class="n">nz2</span>               <span class="c">!&lt; Final node of z axis.</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span><span class="kd">::</span>           <span class="n">NN</span>                <span class="c">!&lt; Number of all nodes.</span>
  <span class="kt">real</span><span class="p">(</span><span class="n">R8P</span><span class="p">),</span>    <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span><span class="kd">::</span>           <span class="n">X</span><span class="p">(</span><span class="n">nx1</span><span class="p">:,</span><span class="n">ny1</span><span class="p">:,</span><span class="n">nz1</span><span class="p">:)</span> <span class="c">!&lt; X coordinates [nx1:nx2,ny1:ny2,nz1:nz2].</span>
  <span class="kt">real</span><span class="p">(</span><span class="n">R8P</span><span class="p">),</span>    <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span><span class="kd">::</span>           <span class="n">Y</span><span class="p">(</span><span class="n">nx1</span><span class="p">:,</span><span class="n">ny1</span><span class="p">:,</span><span class="n">nz1</span><span class="p">:)</span> <span class="c">!&lt; Y coordinates [nx1:nx2,ny1:ny2,nz1:nz2].</span>
  <span class="kt">real</span><span class="p">(</span><span class="n">R8P</span><span class="p">),</span>    <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span><span class="kd">::</span>           <span class="n">Z</span><span class="p">(</span><span class="n">nx1</span><span class="p">:,</span><span class="n">ny1</span><span class="p">:,</span><span class="n">nz1</span><span class="p">:)</span> <span class="c">!&lt; Z coordinates [nx1:nx2,ny1:ny2,nz1:nz2].</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">),</span> <span class="k">optional</span><span class="kd">::</span> <span class="n">cf</span>                <span class="c">!&lt; Current file index (for concurrent files IO).</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">)</span><span class="kd">::</span>                       <span class="n">E_IO</span>              <span class="c">!&lt; Input/Output inquiring flag: $0$ if IO is done, $&gt; 0$ if IO is not done.</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I1P</span><span class="p">),</span> <span class="k">allocatable</span><span class="kd">::</span>          <span class="n">XYZp</span><span class="p">(:)</span>           <span class="c">!&lt; Packed coordinates data.</span>
  <span class="kt">character</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="k">allocatable</span><span class="kd">::</span>          <span class="n">XYZ64</span><span class="p">(:)</span>          <span class="c">!&lt; X, Y, Z coordinates encoded in base64.</span>
  <span class="kt">character</span><span class="p">(</span><span class="nb">len</span><span class="o">=</span><span class="n">maxlen</span><span class="p">)</span><span class="kd">::</span>              <span class="n">s_buffer</span>          <span class="c">!&lt; Buffer string.</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">)</span><span class="kd">::</span>                       <span class="n">rf</span>                <span class="c">!&lt; Real file index.</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">)</span><span class="kd">::</span>                       <span class="n">nx</span><span class="p">,</span><span class="n">ny</span><span class="p">,</span><span class="n">nz</span>          <span class="c">!&lt; Counters.</span>
  <span class="c">!---------------------------------------------------------------------------------------------------------------------------------</span>

  <span class="c">!---------------------------------------------------------------------------------------------------------------------------------</span>
  <span class="n">E_IO</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1_I4P</span>
  <span class="n">rf</span> <span class="o">=</span> <span class="n">f</span>
  <span class="k">if</span> <span class="p">(</span><span class="nb">present</span><span class="p">(</span><span class="n">cf</span><span class="p">))</span> <span class="k">then</span>
<span class="k">    </span><span class="n">rf</span> <span class="o">=</span> <span class="n">cf</span> <span class="p">;</span> <span class="n">f</span> <span class="o">=</span> <span class="n">cf</span>
  <span class="n">endif</span>
  <span class="k">select case</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">f</span><span class="p">)</span>
  <span class="k">case</span><span class="p">(</span><span class="n">ascii</span><span class="p">)</span>
    <span class="n">s_buffer</span> <span class="o">=</span> <span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;Piece Extent=&quot;&#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">nx1</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39; &#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">nx2</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39; &#39;</span><span class="o">//</span> <span class="p">&amp;</span>
                                                              <span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">ny1</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39; &#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">ny2</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39; &#39;</span><span class="o">//</span> <span class="p">&amp;</span>
                                                              <span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">nz1</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39; &#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">nz2</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39;&quot;&gt;&#39;</span>
    <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;(A)&#39;</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">trim</span><span class="p">(</span><span class="n">s_buffer</span><span class="p">)</span> <span class="p">;</span> <span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span> <span class="o">=</span> <span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span> <span class="o">+</span> <span class="mi">2</span>
    <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;(A)&#39;</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;Points&gt;&#39;</span> <span class="p">;</span> <span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span> <span class="o">=</span> <span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span> <span class="o">+</span> <span class="mi">2</span>
    <span class="n">s_buffer</span> <span class="o">=</span> <span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;DataArray type=&quot;Float64&quot; NumberOfComponents=&quot;3&quot; Name=&quot;Points&quot; format=&quot;ascii&quot;&gt;&#39;</span>
    <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;(A)&#39;</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">trim</span><span class="p">(</span><span class="n">s_buffer</span><span class="p">)</span>
    <span class="k">do </span><span class="n">nz</span><span class="o">=</span><span class="n">nz1</span><span class="p">,</span><span class="n">nz2</span>
      <span class="k">do </span><span class="n">ny</span><span class="o">=</span><span class="n">ny1</span><span class="p">,</span><span class="n">ny2</span>
        <span class="k">do </span><span class="n">nx</span><span class="o">=</span><span class="n">nx1</span><span class="p">,</span><span class="n">nx2</span>
          <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;(A)&#39;</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="p">&amp;</span>
                                                     <span class="n">str</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">X</span><span class="p">(</span><span class="n">nx</span><span class="p">,</span><span class="n">ny</span><span class="p">,</span><span class="n">nz</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39; &#39;</span><span class="o">//</span><span class="n">str</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">Y</span><span class="p">(</span><span class="n">nx</span><span class="p">,</span><span class="n">ny</span><span class="p">,</span><span class="n">nz</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39; &#39;</span><span class="o">//</span><span class="n">str</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">Z</span><span class="p">(</span><span class="n">nx</span><span class="p">,</span><span class="n">ny</span><span class="p">,</span><span class="n">nz</span><span class="p">))</span>
        <span class="n">enddo</span>
      <span class="n">enddo</span>
    <span class="n">enddo</span>
    <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;(A)&#39;</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;/DataArray&gt;&#39;</span> <span class="p">;</span> <span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span> <span class="o">=</span> <span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span> <span class="o">-</span> <span class="mi">2</span>
    <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;(A)&#39;</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;/Points&gt;&#39;</span>
  <span class="k">case</span><span class="p">(</span><span class="n">raw</span><span class="p">,</span><span class="n">bin_app</span><span class="p">)</span>
    <span class="n">s_buffer</span> <span class="o">=</span> <span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;Piece Extent=&quot;&#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">nx1</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39; &#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">nx2</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39; &#39;</span><span class="o">//</span> <span class="p">&amp;</span>
                                                              <span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">ny1</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39; &#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">ny2</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39; &#39;</span><span class="o">//</span> <span class="p">&amp;</span>
                                                              <span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">nz1</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39; &#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">nz2</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39;&quot;&gt;&#39;</span>
    <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">trim</span><span class="p">(</span><span class="n">s_buffer</span><span class="p">)</span><span class="o">//</span><span class="n">end_rec</span> <span class="p">;</span> <span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span> <span class="o">=</span> <span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span> <span class="o">+</span> <span class="mi">2</span>
    <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;Points&gt;&#39;</span><span class="o">//</span><span class="n">end_rec</span> <span class="p">;</span> <span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span> <span class="o">=</span> <span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span> <span class="o">+</span> <span class="mi">2</span>
    <span class="n">s_buffer</span> <span class="o">=</span> <span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span>                                                                  <span class="p">&amp;</span>
               <span class="s1">&#39;&lt;DataArray type=&quot;Float64&quot; NumberOfComponents=&quot;3&quot; Name=&quot;Points&quot; format=&quot;appended&quot; offset=&quot;&#39;</span><span class="o">//</span> <span class="p">&amp;</span>
               <span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(.</span><span class="n">true</span><span class="p">.,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">ioffset</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39;&quot;/&gt;&#39;</span>
    <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">trim</span><span class="p">(</span><span class="n">s_buffer</span><span class="p">)</span><span class="o">//</span><span class="n">end_rec</span>
    <span class="k">call </span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">byte_update</span><span class="p">(</span><span class="n">N_Byte</span> <span class="o">=</span> <span class="mi">3</span><span class="o">*</span><span class="n">NN</span><span class="o">*</span><span class="n">BYR8P</span><span class="p">)</span>
    <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">ua</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">N_Byte</span><span class="p">,</span><span class="s1">&#39;R8&#39;</span><span class="p">,</span><span class="mi">3</span><span class="o">*</span><span class="n">NN</span>
    <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">ua</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)(((</span><span class="n">X</span><span class="p">(</span><span class="n">nx</span><span class="p">,</span><span class="n">ny</span><span class="p">,</span><span class="n">nz</span><span class="p">),</span><span class="n">Y</span><span class="p">(</span><span class="n">nx</span><span class="p">,</span><span class="n">ny</span><span class="p">,</span><span class="n">nz</span><span class="p">),</span><span class="n">Z</span><span class="p">(</span><span class="n">nx</span><span class="p">,</span><span class="n">ny</span><span class="p">,</span><span class="n">nz</span><span class="p">),</span><span class="n">nx</span><span class="o">=</span><span class="n">nx1</span><span class="p">,</span><span class="n">nx2</span><span class="p">),</span><span class="n">ny</span><span class="o">=</span><span class="n">ny1</span><span class="p">,</span><span class="n">ny2</span><span class="p">),</span><span class="n">nz</span><span class="o">=</span><span class="n">nz1</span><span class="p">,</span><span class="n">nz2</span><span class="p">)</span>
    <span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span> <span class="o">=</span> <span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span> <span class="o">-</span> <span class="mi">2</span> <span class="p">;</span> <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;/Points&gt;&#39;</span><span class="o">//</span><span class="n">end_rec</span>
  <span class="k">case</span><span class="p">(</span><span class="n">binary</span><span class="p">)</span>
    <span class="n">s_buffer</span> <span class="o">=</span> <span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;Piece Extent=&quot;&#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">nx1</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39; &#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">nx2</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39; &#39;</span><span class="o">//</span> <span class="p">&amp;</span>
                                                              <span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">ny1</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39; &#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">ny2</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39; &#39;</span><span class="o">//</span> <span class="p">&amp;</span>
                                                              <span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">nz1</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39; &#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">nz2</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39;&quot;&gt;&#39;</span>
    <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">trim</span><span class="p">(</span><span class="n">s_buffer</span><span class="p">)</span><span class="o">//</span><span class="n">end_rec</span> <span class="p">;</span> <span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span> <span class="o">=</span> <span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span> <span class="o">+</span> <span class="mi">2</span>
    <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;Points&gt;&#39;</span><span class="o">//</span><span class="n">end_rec</span> <span class="p">;</span> <span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span> <span class="o">=</span> <span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span> <span class="o">+</span> <span class="mi">2</span>
    <span class="n">s_buffer</span> <span class="o">=</span> <span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;DataArray type=&quot;Float64&quot; NumberOfComponents=&quot;3&quot; Name=&quot;Points&quot; format=&quot;binary&quot;&gt;&#39;</span>
    <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">trim</span><span class="p">(</span><span class="n">s_buffer</span><span class="p">)</span><span class="o">//</span><span class="n">end_rec</span>
    <span class="k">call </span><span class="n">pack_data</span><span class="p">(</span><span class="n">a1</span><span class="o">=</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="mi">3</span><span class="o">*</span><span class="n">NN</span><span class="o">*</span><span class="n">BYR8P</span><span class="p">,</span><span class="n">I4P</span><span class="p">)],</span><span class="n">a2</span><span class="o">=</span><span class="p">[(((</span><span class="n">X</span><span class="p">(</span><span class="n">nx</span><span class="p">,</span><span class="n">ny</span><span class="p">,</span><span class="n">nz</span><span class="p">),</span><span class="n">Y</span><span class="p">(</span><span class="n">nx</span><span class="p">,</span><span class="n">ny</span><span class="p">,</span><span class="n">nz</span><span class="p">),</span><span class="n">Z</span><span class="p">(</span><span class="n">nx</span><span class="p">,</span><span class="n">ny</span><span class="p">,</span><span class="n">nz</span><span class="p">),</span><span class="n">nx</span><span class="o">=</span><span class="n">nx1</span><span class="p">,</span><span class="n">nx2</span><span class="p">),</span><span class="n">ny</span><span class="o">=</span><span class="n">ny1</span><span class="p">,</span><span class="n">ny2</span><span class="p">),</span><span class="n">nz</span><span class="o">=</span><span class="n">nz1</span><span class="p">,</span><span class="n">nz2</span><span class="p">)],&amp;</span>
                   <span class="n">packed</span><span class="o">=</span><span class="n">XYZp</span><span class="p">)</span>
    <span class="k">call </span><span class="n">b64_encode</span><span class="p">(</span><span class="n">nB</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">BYI1P</span><span class="p">,</span><span class="n">I4P</span><span class="p">),</span><span class="n">n</span><span class="o">=</span><span class="n">XYZp</span><span class="p">,</span><span class="n">code</span><span class="o">=</span><span class="n">XYZ64</span><span class="p">)</span> <span class="p">;</span> <span class="k">deallocate</span><span class="p">(</span><span class="n">XYZp</span><span class="p">)</span>
    <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="o">+</span><span class="mi">2</span><span class="p">)</span><span class="o">//</span><span class="n">tochar</span><span class="p">(</span><span class="n">XYZ64</span><span class="p">)</span><span class="o">//</span><span class="n">end_rec</span> <span class="p">;</span> <span class="k">deallocate</span><span class="p">(</span><span class="n">XYZ64</span><span class="p">)</span>
    <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;/DataArray&gt;&#39;</span><span class="o">//</span><span class="n">end_rec</span>
    <span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span> <span class="o">=</span> <span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span> <span class="o">-</span> <span class="mi">2</span> <span class="p">;</span> <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;/Points&gt;&#39;</span><span class="o">//</span><span class="n">end_rec</span>
  <span class="n">endselect</span>
  <span class="k">return</span>
  <span class="c">!---------------------------------------------------------------------------------------------------------------------------------</span>
  <span class="n">endfunction</span> <span class="n">VTK_GEO_XML_STRG_3DA_R8</span>

  <span class="c">!&gt; Function for saving mesh with \b StructuredGrid topology (R8P, 1D Arrays, packed API).</span>
  <span class="c">!&gt; @return E_IO: integer(I4P) error flag</span>
  <span class="k">function </span><span class="n">VTK_GEO_XML_STRG_1DAP_R8</span><span class="p">(</span><span class="n">nx1</span><span class="p">,</span><span class="n">nx2</span><span class="p">,</span><span class="n">ny1</span><span class="p">,</span><span class="n">ny2</span><span class="p">,</span><span class="n">nz1</span><span class="p">,</span><span class="n">nz2</span><span class="p">,</span><span class="n">NN</span><span class="p">,</span><span class="n">XYZ</span><span class="p">,</span><span class="n">cf</span><span class="p">)</span> <span class="k">result</span><span class="p">(</span><span class="n">E_IO</span><span class="p">)</span>
  <span class="c">!---------------------------------------------------------------------------------------------------------------------------------</span>
  <span class="k">implicit none</span>
<span class="k">  </span><span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span><span class="kd">::</span>           <span class="n">nx1</span>        <span class="c">!&lt; Initial node of x axis.</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span><span class="kd">::</span>           <span class="n">nx2</span>        <span class="c">!&lt; Final node of x axis.</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span><span class="kd">::</span>           <span class="n">ny1</span>        <span class="c">!&lt; Initial node of y axis.</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span><span class="kd">::</span>           <span class="n">ny2</span>        <span class="c">!&lt; Final node of y axis.</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span><span class="kd">::</span>           <span class="n">nz1</span>        <span class="c">!&lt; Initial node of z axis.</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span><span class="kd">::</span>           <span class="n">nz2</span>        <span class="c">!&lt; Final node of z axis.</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span><span class="kd">::</span>           <span class="n">NN</span>         <span class="c">!&lt; Number of all nodes.</span>
  <span class="kt">real</span><span class="p">(</span><span class="n">R8P</span><span class="p">),</span>    <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span><span class="kd">::</span>           <span class="n">XYZ</span><span class="p">(</span><span class="mi">1</span><span class="p">:,</span><span class="mi">1</span><span class="p">:)</span> <span class="c">!&lt; X, Y, Z coordinates (packed API) [1:3,1:NN].</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">),</span> <span class="k">optional</span><span class="kd">::</span> <span class="n">cf</span>         <span class="c">!&lt; Current file index (for concurrent files IO).</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">)</span><span class="kd">::</span>                       <span class="n">E_IO</span>       <span class="c">!&lt; Input/Output inquiring flag: $0$ if IO is done, $&gt; 0$ if IO is not done.</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I1P</span><span class="p">),</span> <span class="k">allocatable</span><span class="kd">::</span>          <span class="n">XYZp</span><span class="p">(:)</span>    <span class="c">!&lt; Packed coordinates data.</span>
  <span class="kt">character</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="k">allocatable</span><span class="kd">::</span>          <span class="n">XYZ64</span><span class="p">(:)</span>   <span class="c">!&lt; X, Y, Z coordinates encoded in base64.</span>
  <span class="kt">character</span><span class="p">(</span><span class="nb">len</span><span class="o">=</span><span class="n">maxlen</span><span class="p">)</span><span class="kd">::</span>              <span class="n">s_buffer</span>   <span class="c">!&lt; Buffer string.</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">)</span><span class="kd">::</span>                       <span class="n">rf</span>         <span class="c">!&lt; Real file index.</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">)</span><span class="kd">::</span>                       <span class="n">n1</span>         <span class="c">!&lt; Counter.</span>
  <span class="c">!---------------------------------------------------------------------------------------------------------------------------------</span>

  <span class="c">!---------------------------------------------------------------------------------------------------------------------------------</span>
  <span class="n">E_IO</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1_I4P</span>
  <span class="n">rf</span> <span class="o">=</span> <span class="n">f</span>
  <span class="k">if</span> <span class="p">(</span><span class="nb">present</span><span class="p">(</span><span class="n">cf</span><span class="p">))</span> <span class="k">then</span>
<span class="k">    </span><span class="n">rf</span> <span class="o">=</span> <span class="n">cf</span> <span class="p">;</span> <span class="n">f</span> <span class="o">=</span> <span class="n">cf</span>
  <span class="n">endif</span>
  <span class="k">select case</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">f</span><span class="p">)</span>
  <span class="k">case</span><span class="p">(</span><span class="n">ascii</span><span class="p">)</span>
    <span class="n">s_buffer</span> <span class="o">=</span> <span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;Piece Extent=&quot;&#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">nx1</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39; &#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">nx2</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39; &#39;</span><span class="o">//</span> <span class="p">&amp;</span>
                                                              <span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">ny1</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39; &#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">ny2</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39; &#39;</span><span class="o">//</span> <span class="p">&amp;</span>
                                                              <span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">nz1</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39; &#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">nz2</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39;&quot;&gt;&#39;</span>
    <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;(A)&#39;</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">trim</span><span class="p">(</span><span class="n">s_buffer</span><span class="p">)</span> <span class="p">;</span> <span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span> <span class="o">=</span> <span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span> <span class="o">+</span> <span class="mi">2</span>
    <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;(A)&#39;</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;Points&gt;&#39;</span> <span class="p">;</span> <span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span> <span class="o">=</span> <span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span> <span class="o">+</span> <span class="mi">2</span>
    <span class="n">s_buffer</span> <span class="o">=</span> <span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;DataArray type=&quot;Float64&quot; NumberOfComponents=&quot;3&quot; Name=&quot;Points&quot; format=&quot;ascii&quot;&gt;&#39;</span>
    <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;(A)&#39;</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">trim</span><span class="p">(</span><span class="n">s_buffer</span><span class="p">)</span>
    <span class="k">do </span><span class="n">n1</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">NN</span>
      <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;(A)&#39;</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="p">&amp;</span>
                                                 <span class="n">str</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">XYZ</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">n1</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39; &#39;</span><span class="o">//</span><span class="n">str</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">XYZ</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="n">n1</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39; &#39;</span><span class="o">//</span><span class="n">str</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">XYZ</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="n">n1</span><span class="p">))</span>
    <span class="n">enddo</span>
    <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;(A)&#39;</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;/DataArray&gt;&#39;</span> <span class="p">;</span> <span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span> <span class="o">=</span> <span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span> <span class="o">-</span> <span class="mi">2</span>
    <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;(A)&#39;</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;/Points&gt;&#39;</span>
  <span class="k">case</span><span class="p">(</span><span class="n">raw</span><span class="p">,</span><span class="n">bin_app</span><span class="p">)</span>
    <span class="n">s_buffer</span> <span class="o">=</span> <span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;Piece Extent=&quot;&#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">nx1</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39; &#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">nx2</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39; &#39;</span><span class="o">//</span> <span class="p">&amp;</span>
                                                              <span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">ny1</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39; &#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">ny2</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39; &#39;</span><span class="o">//</span> <span class="p">&amp;</span>
                                                              <span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">nz1</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39; &#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">nz2</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39;&quot;&gt;&#39;</span>
    <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">trim</span><span class="p">(</span><span class="n">s_buffer</span><span class="p">)</span><span class="o">//</span><span class="n">end_rec</span> <span class="p">;</span> <span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span> <span class="o">=</span> <span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span> <span class="o">+</span> <span class="mi">2</span>
    <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;Points&gt;&#39;</span><span class="o">//</span><span class="n">end_rec</span> <span class="p">;</span> <span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span> <span class="o">=</span> <span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span> <span class="o">+</span> <span class="mi">2</span>
    <span class="n">s_buffer</span> <span class="o">=</span> <span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span>                                                                  <span class="p">&amp;</span>
               <span class="s1">&#39;&lt;DataArray type=&quot;Float64&quot; NumberOfComponents=&quot;3&quot; Name=&quot;Points&quot; format=&quot;appended&quot; offset=&quot;&#39;</span><span class="o">//</span> <span class="p">&amp;</span>
               <span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(.</span><span class="n">true</span><span class="p">.,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">ioffset</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39;&quot;/&gt;&#39;</span>
    <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">trim</span><span class="p">(</span><span class="n">s_buffer</span><span class="p">)</span><span class="o">//</span><span class="n">end_rec</span>
    <span class="k">call </span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">byte_update</span><span class="p">(</span><span class="n">N_Byte</span> <span class="o">=</span> <span class="mi">3</span><span class="o">*</span><span class="n">NN</span><span class="o">*</span><span class="n">BYR8P</span><span class="p">)</span>
    <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">ua</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">N_Byte</span><span class="p">,</span><span class="s1">&#39;R8&#39;</span><span class="p">,</span><span class="mi">3</span><span class="o">*</span><span class="n">NN</span>
    <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">ua</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="n">XYZ</span>
    <span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span> <span class="o">=</span> <span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span> <span class="o">-</span> <span class="mi">2</span> <span class="p">;</span> <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;/Points&gt;&#39;</span><span class="o">//</span><span class="n">end_rec</span>
  <span class="k">case</span><span class="p">(</span><span class="n">binary</span><span class="p">)</span>
    <span class="n">s_buffer</span> <span class="o">=</span> <span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;Piece Extent=&quot;&#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">nx1</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39; &#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">nx2</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39; &#39;</span><span class="o">//</span> <span class="p">&amp;</span>
                                                              <span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">ny1</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39; &#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">ny2</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39; &#39;</span><span class="o">//</span> <span class="p">&amp;</span>
                                                              <span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">nz1</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39; &#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">nz2</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39;&quot;&gt;&#39;</span>
    <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">trim</span><span class="p">(</span><span class="n">s_buffer</span><span class="p">)</span><span class="o">//</span><span class="n">end_rec</span> <span class="p">;</span> <span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span> <span class="o">=</span> <span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span> <span class="o">+</span> <span class="mi">2</span>
    <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;Points&gt;&#39;</span><span class="o">//</span><span class="n">end_rec</span> <span class="p">;</span> <span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span> <span class="o">=</span> <span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span> <span class="o">+</span> <span class="mi">2</span>
    <span class="n">s_buffer</span> <span class="o">=</span> <span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;DataArray type=&quot;Float64&quot; NumberOfComponents=&quot;3&quot; Name=&quot;Points&quot; format=&quot;binary&quot;&gt;&#39;</span>
    <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">trim</span><span class="p">(</span><span class="n">s_buffer</span><span class="p">)</span><span class="o">//</span><span class="n">end_rec</span>
    <span class="k">call </span><span class="n">pack_data</span><span class="p">(</span><span class="n">a1</span><span class="o">=</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="mi">3</span><span class="o">*</span><span class="n">NN</span><span class="o">*</span><span class="n">BYR8P</span><span class="p">,</span><span class="n">I4P</span><span class="p">)],</span><span class="n">a2</span><span class="o">=</span><span class="nb">reshape</span><span class="p">(</span><span class="n">XYZ</span><span class="p">,[</span><span class="mi">3</span><span class="o">*</span><span class="n">NN</span><span class="p">]),</span><span class="n">packed</span><span class="o">=</span><span class="n">XYZp</span><span class="p">)</span>
    <span class="k">call </span><span class="n">b64_encode</span><span class="p">(</span><span class="n">nB</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">BYI1P</span><span class="p">,</span><span class="n">I4P</span><span class="p">),</span><span class="n">n</span><span class="o">=</span><span class="n">XYZp</span><span class="p">,</span><span class="n">code</span><span class="o">=</span><span class="n">XYZ64</span><span class="p">)</span> <span class="p">;</span> <span class="k">deallocate</span><span class="p">(</span><span class="n">XYZp</span><span class="p">)</span>
    <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="o">+</span><span class="mi">2</span><span class="p">)</span><span class="o">//</span><span class="n">tochar</span><span class="p">(</span><span class="n">XYZ64</span><span class="p">)</span><span class="o">//</span><span class="n">end_rec</span> <span class="p">;</span> <span class="k">deallocate</span><span class="p">(</span><span class="n">XYZ64</span><span class="p">)</span>
    <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;/DataArray&gt;&#39;</span><span class="o">//</span><span class="n">end_rec</span>
    <span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span> <span class="o">=</span> <span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span> <span class="o">-</span> <span class="mi">2</span> <span class="p">;</span> <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;/Points&gt;&#39;</span><span class="o">//</span><span class="n">end_rec</span>
  <span class="n">endselect</span>
  <span class="k">return</span>
  <span class="c">!---------------------------------------------------------------------------------------------------------------------------------</span>
  <span class="n">endfunction</span> <span class="n">VTK_GEO_XML_STRG_1DAP_R8</span>

  <span class="c">!&gt; Function for saving mesh with \b StructuredGrid topology (R8P, 3D Arrays, packed API).</span>
  <span class="c">!&gt; @return E_IO: integer(I4P) error flag</span>
  <span class="k">function </span><span class="n">VTK_GEO_XML_STRG_3DAP_R8</span><span class="p">(</span><span class="n">nx1</span><span class="p">,</span><span class="n">nx2</span><span class="p">,</span><span class="n">ny1</span><span class="p">,</span><span class="n">ny2</span><span class="p">,</span><span class="n">nz1</span><span class="p">,</span><span class="n">nz2</span><span class="p">,</span><span class="n">NN</span><span class="p">,</span><span class="n">XYZ</span><span class="p">,</span><span class="n">cf</span><span class="p">)</span> <span class="k">result</span><span class="p">(</span><span class="n">E_IO</span><span class="p">)</span>
  <span class="c">!---------------------------------------------------------------------------------------------------------------------------------</span>
  <span class="k">implicit none</span>
<span class="k">  </span><span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span><span class="kd">::</span>           <span class="n">nx1</span>                    <span class="c">!&lt; Initial node of x axis.</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span><span class="kd">::</span>           <span class="n">nx2</span>                    <span class="c">!&lt; Final node of x axis.</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span><span class="kd">::</span>           <span class="n">ny1</span>                    <span class="c">!&lt; Initial node of y axis.</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span><span class="kd">::</span>           <span class="n">ny2</span>                    <span class="c">!&lt; Final node of y axis.</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span><span class="kd">::</span>           <span class="n">nz1</span>                    <span class="c">!&lt; Initial node of z axis.</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span><span class="kd">::</span>           <span class="n">nz2</span>                    <span class="c">!&lt; Final node of z axis.</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span><span class="kd">::</span>           <span class="n">NN</span>                     <span class="c">!&lt; Number of all nodes.</span>
  <span class="kt">real</span><span class="p">(</span><span class="n">R8P</span><span class="p">),</span>    <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span><span class="kd">::</span>           <span class="n">XYZ</span><span class="p">(</span><span class="mi">1</span><span class="p">:,</span><span class="n">nx1</span><span class="p">:,</span><span class="n">ny1</span><span class="p">:,</span><span class="n">nz1</span><span class="p">:)</span> <span class="c">!&lt; X, Y, Z coordinates (packed API).</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">),</span> <span class="k">optional</span><span class="kd">::</span> <span class="n">cf</span>                     <span class="c">!&lt; Current file index (for concurrent files IO).</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">)</span><span class="kd">::</span>                       <span class="n">E_IO</span>              <span class="c">!&lt; Input/Output inquiring flag: $0$ if IO is done, $&gt; 0$ if IO is not done.</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I1P</span><span class="p">),</span> <span class="k">allocatable</span><span class="kd">::</span>          <span class="n">XYZp</span><span class="p">(:)</span>                <span class="c">!&lt; Packed coordinates data.</span>
  <span class="kt">character</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="k">allocatable</span><span class="kd">::</span>          <span class="n">XYZ64</span><span class="p">(:)</span>               <span class="c">!&lt; X, Y, Z coordinates encoded in base64.</span>
  <span class="kt">character</span><span class="p">(</span><span class="nb">len</span><span class="o">=</span><span class="n">maxlen</span><span class="p">)</span><span class="kd">::</span>              <span class="n">s_buffer</span>               <span class="c">!&lt; Buffer string.</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">)</span><span class="kd">::</span>                       <span class="n">rf</span>                     <span class="c">!&lt; Real file index.</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">)</span><span class="kd">::</span>                       <span class="n">nx</span><span class="p">,</span><span class="n">ny</span><span class="p">,</span><span class="n">nz</span>               <span class="c">!&lt; Counters.</span>
  <span class="c">!---------------------------------------------------------------------------------------------------------------------------------</span>

  <span class="c">!---------------------------------------------------------------------------------------------------------------------------------</span>
  <span class="n">E_IO</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1_I4P</span>
  <span class="n">rf</span> <span class="o">=</span> <span class="n">f</span>
  <span class="k">if</span> <span class="p">(</span><span class="nb">present</span><span class="p">(</span><span class="n">cf</span><span class="p">))</span> <span class="k">then</span>
<span class="k">    </span><span class="n">rf</span> <span class="o">=</span> <span class="n">cf</span> <span class="p">;</span> <span class="n">f</span> <span class="o">=</span> <span class="n">cf</span>
  <span class="n">endif</span>
  <span class="k">select case</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">f</span><span class="p">)</span>
  <span class="k">case</span><span class="p">(</span><span class="n">ascii</span><span class="p">)</span>
    <span class="n">s_buffer</span> <span class="o">=</span> <span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;Piece Extent=&quot;&#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">nx1</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39; &#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">nx2</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39; &#39;</span><span class="o">//</span> <span class="p">&amp;</span>
                                                              <span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">ny1</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39; &#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">ny2</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39; &#39;</span><span class="o">//</span> <span class="p">&amp;</span>
                                                              <span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">nz1</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39; &#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">nz2</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39;&quot;&gt;&#39;</span>
    <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;(A)&#39;</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">trim</span><span class="p">(</span><span class="n">s_buffer</span><span class="p">)</span> <span class="p">;</span> <span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span> <span class="o">=</span> <span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span> <span class="o">+</span> <span class="mi">2</span>
    <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;(A)&#39;</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;Points&gt;&#39;</span> <span class="p">;</span> <span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span> <span class="o">=</span> <span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span> <span class="o">+</span> <span class="mi">2</span>
    <span class="n">s_buffer</span> <span class="o">=</span> <span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;DataArray type=&quot;Float64&quot; NumberOfComponents=&quot;3&quot; Name=&quot;Points&quot; format=&quot;ascii&quot;&gt;&#39;</span>
    <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;(A)&#39;</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">trim</span><span class="p">(</span><span class="n">s_buffer</span><span class="p">)</span>
    <span class="k">do </span><span class="n">nz</span><span class="o">=</span><span class="n">nz1</span><span class="p">,</span><span class="n">nz2</span>
      <span class="k">do </span><span class="n">ny</span><span class="o">=</span><span class="n">ny1</span><span class="p">,</span><span class="n">ny2</span>
        <span class="k">do </span><span class="n">nx</span><span class="o">=</span><span class="n">nx1</span><span class="p">,</span><span class="n">nx2</span>
          <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;(A)&#39;</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="p">&amp;</span>
                                                    <span class="n">str</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">XYZ</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">nx</span><span class="p">,</span><span class="n">ny</span><span class="p">,</span><span class="n">nz</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39; &#39;</span><span class="o">//</span><span class="n">str</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">XYZ</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="n">nx</span><span class="p">,</span><span class="n">ny</span><span class="p">,</span><span class="n">nz</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39; &#39;</span><span class="o">//</span><span class="n">str</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">XYZ</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="n">nx</span><span class="p">,</span><span class="n">ny</span><span class="p">,</span><span class="n">nz</span><span class="p">))</span>
        <span class="n">enddo</span>
      <span class="n">enddo</span>
    <span class="n">enddo</span>
    <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;(A)&#39;</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;/DataArray&gt;&#39;</span> <span class="p">;</span> <span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span> <span class="o">=</span> <span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span> <span class="o">-</span> <span class="mi">2</span>
    <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;(A)&#39;</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;/Points&gt;&#39;</span>
  <span class="k">case</span><span class="p">(</span><span class="n">raw</span><span class="p">,</span><span class="n">bin_app</span><span class="p">)</span>
    <span class="n">s_buffer</span> <span class="o">=</span> <span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;Piece Extent=&quot;&#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">nx1</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39; &#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">nx2</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39; &#39;</span><span class="o">//</span> <span class="p">&amp;</span>
                                                              <span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">ny1</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39; &#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">ny2</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39; &#39;</span><span class="o">//</span> <span class="p">&amp;</span>
                                                              <span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">nz1</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39; &#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">nz2</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39;&quot;&gt;&#39;</span>
    <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">trim</span><span class="p">(</span><span class="n">s_buffer</span><span class="p">)</span><span class="o">//</span><span class="n">end_rec</span> <span class="p">;</span> <span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span> <span class="o">=</span> <span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span> <span class="o">+</span> <span class="mi">2</span>
    <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;Points&gt;&#39;</span><span class="o">//</span><span class="n">end_rec</span> <span class="p">;</span> <span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span> <span class="o">=</span> <span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span> <span class="o">+</span> <span class="mi">2</span>
    <span class="n">s_buffer</span> <span class="o">=</span> <span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span>                                                                  <span class="p">&amp;</span>
               <span class="s1">&#39;&lt;DataArray type=&quot;Float64&quot; NumberOfComponents=&quot;3&quot; Name=&quot;Points&quot; format=&quot;appended&quot; offset=&quot;&#39;</span><span class="o">//</span> <span class="p">&amp;</span>
               <span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(.</span><span class="n">true</span><span class="p">.,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">ioffset</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39;&quot;/&gt;&#39;</span>
    <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">trim</span><span class="p">(</span><span class="n">s_buffer</span><span class="p">)</span><span class="o">//</span><span class="n">end_rec</span>
    <span class="k">call </span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">byte_update</span><span class="p">(</span><span class="n">N_Byte</span> <span class="o">=</span> <span class="mi">3</span><span class="o">*</span><span class="n">NN</span><span class="o">*</span><span class="n">BYR8P</span><span class="p">)</span>
    <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">ua</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">N_Byte</span><span class="p">,</span><span class="s1">&#39;R8&#39;</span><span class="p">,</span><span class="mi">3</span><span class="o">*</span><span class="n">NN</span>
    <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">ua</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="n">XYZ</span>
    <span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span> <span class="o">=</span> <span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span> <span class="o">-</span> <span class="mi">2</span> <span class="p">;</span> <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;/Points&gt;&#39;</span><span class="o">//</span><span class="n">end_rec</span>
  <span class="k">case</span><span class="p">(</span><span class="n">binary</span><span class="p">)</span>
    <span class="n">s_buffer</span> <span class="o">=</span> <span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;Piece Extent=&quot;&#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">nx1</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39; &#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">nx2</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39; &#39;</span><span class="o">//</span> <span class="p">&amp;</span>
                                                              <span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">ny1</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39; &#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">ny2</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39; &#39;</span><span class="o">//</span> <span class="p">&amp;</span>
                                                              <span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">nz1</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39; &#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">nz2</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39;&quot;&gt;&#39;</span>
    <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">trim</span><span class="p">(</span><span class="n">s_buffer</span><span class="p">)</span><span class="o">//</span><span class="n">end_rec</span> <span class="p">;</span> <span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span> <span class="o">=</span> <span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span> <span class="o">+</span> <span class="mi">2</span>
    <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;Points&gt;&#39;</span><span class="o">//</span><span class="n">end_rec</span> <span class="p">;</span> <span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span> <span class="o">=</span> <span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span> <span class="o">+</span> <span class="mi">2</span>
    <span class="n">s_buffer</span> <span class="o">=</span> <span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;DataArray type=&quot;Float64&quot; NumberOfComponents=&quot;3&quot; Name=&quot;Points&quot; format=&quot;binary&quot;&gt;&#39;</span>
    <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">trim</span><span class="p">(</span><span class="n">s_buffer</span><span class="p">)</span><span class="o">//</span><span class="n">end_rec</span>
    <span class="k">call </span><span class="n">pack_data</span><span class="p">(</span><span class="n">a1</span><span class="o">=</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="mi">3</span><span class="o">*</span><span class="n">NN</span><span class="o">*</span><span class="n">BYR8P</span><span class="p">,</span><span class="n">I4P</span><span class="p">)],</span><span class="n">a2</span><span class="o">=</span><span class="nb">reshape</span><span class="p">(</span><span class="n">XYZ</span><span class="p">,[</span><span class="mi">3</span><span class="o">*</span><span class="n">NN</span><span class="p">]),</span><span class="n">packed</span><span class="o">=</span><span class="n">XYZp</span><span class="p">)</span>
    <span class="k">call </span><span class="n">b64_encode</span><span class="p">(</span><span class="n">nB</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">BYI1P</span><span class="p">,</span><span class="n">I4P</span><span class="p">),</span><span class="n">n</span><span class="o">=</span><span class="n">XYZp</span><span class="p">,</span><span class="n">code</span><span class="o">=</span><span class="n">XYZ64</span><span class="p">)</span> <span class="p">;</span> <span class="k">deallocate</span><span class="p">(</span><span class="n">XYZp</span><span class="p">)</span>
    <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="o">+</span><span class="mi">2</span><span class="p">)</span><span class="o">//</span><span class="n">tochar</span><span class="p">(</span><span class="n">XYZ64</span><span class="p">)</span><span class="o">//</span><span class="n">end_rec</span> <span class="p">;</span> <span class="k">deallocate</span><span class="p">(</span><span class="n">XYZ64</span><span class="p">)</span>
    <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;/DataArray&gt;&#39;</span><span class="o">//</span><span class="n">end_rec</span>
    <span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span> <span class="o">=</span> <span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span> <span class="o">-</span> <span class="mi">2</span> <span class="p">;</span> <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;/Points&gt;&#39;</span><span class="o">//</span><span class="n">end_rec</span>
  <span class="n">endselect</span>
  <span class="k">return</span>
  <span class="c">!---------------------------------------------------------------------------------------------------------------------------------</span>
  <span class="n">endfunction</span> <span class="n">VTK_GEO_XML_STRG_3DAP_R8</span>

  <span class="c">!&gt; Function for saving mesh with \b StructuredGrid topology (R4P, 1D Arrays).</span>
  <span class="c">!&gt; @return E_IO: integer(I4P) error flag</span>
  <span class="k">function </span><span class="n">VTK_GEO_XML_STRG_1DA_R4</span><span class="p">(</span><span class="n">nx1</span><span class="p">,</span><span class="n">nx2</span><span class="p">,</span><span class="n">ny1</span><span class="p">,</span><span class="n">ny2</span><span class="p">,</span><span class="n">nz1</span><span class="p">,</span><span class="n">nz2</span><span class="p">,</span><span class="n">NN</span><span class="p">,</span><span class="n">X</span><span class="p">,</span><span class="n">Y</span><span class="p">,</span><span class="n">Z</span><span class="p">,</span><span class="n">cf</span><span class="p">)</span> <span class="k">result</span><span class="p">(</span><span class="n">E_IO</span><span class="p">)</span>
  <span class="c">!---------------------------------------------------------------------------------------------------------------------------------</span>
  <span class="k">implicit none</span>
<span class="k">  </span><span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span><span class="kd">::</span>           <span class="n">nx1</span>      <span class="c">!&lt; Initial node of x axis.</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span><span class="kd">::</span>           <span class="n">nx2</span>      <span class="c">!&lt; Final node of x axis.</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span><span class="kd">::</span>           <span class="n">ny1</span>      <span class="c">!&lt; Initial node of y axis.</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span><span class="kd">::</span>           <span class="n">ny2</span>      <span class="c">!&lt; Final node of y axis.</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span><span class="kd">::</span>           <span class="n">nz1</span>      <span class="c">!&lt; Initial node of z axis.</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span><span class="kd">::</span>           <span class="n">nz2</span>      <span class="c">!&lt; Final node of z axis.</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span><span class="kd">::</span>           <span class="n">NN</span>       <span class="c">!&lt; Number of all nodes.</span>
  <span class="kt">real</span><span class="p">(</span><span class="n">R4P</span><span class="p">),</span>    <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span><span class="kd">::</span>           <span class="n">X</span><span class="p">(</span><span class="mi">1</span><span class="p">:)</span>    <span class="c">!&lt; X coordinates [1:NN].</span>
  <span class="kt">real</span><span class="p">(</span><span class="n">R4P</span><span class="p">),</span>    <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span><span class="kd">::</span>           <span class="n">Y</span><span class="p">(</span><span class="mi">1</span><span class="p">:)</span>    <span class="c">!&lt; Y coordinates [1:NN].</span>
  <span class="kt">real</span><span class="p">(</span><span class="n">R4P</span><span class="p">),</span>    <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span><span class="kd">::</span>           <span class="n">Z</span><span class="p">(</span><span class="mi">1</span><span class="p">:)</span>    <span class="c">!&lt; Z coordinates [1:NN].</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">),</span> <span class="k">optional</span><span class="kd">::</span> <span class="n">cf</span>       <span class="c">!&lt; Current file index (for concurrent files IO).</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">)</span><span class="kd">::</span>                       <span class="n">E_IO</span>     <span class="c">!&lt; Input/Output inquiring flag: $0$ if IO is done, $&gt; 0$ if IO is not done.</span>
  <span class="kt">character</span><span class="p">(</span><span class="nb">len</span><span class="o">=</span><span class="n">maxlen</span><span class="p">)</span><span class="kd">::</span>              <span class="n">s_buffer</span> <span class="c">!&lt; Buffer string.</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I1P</span><span class="p">),</span> <span class="k">allocatable</span><span class="kd">::</span>          <span class="n">XYZp</span><span class="p">(:)</span>  <span class="c">!&lt; Packed data.</span>
  <span class="kt">character</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="k">allocatable</span><span class="kd">::</span>          <span class="n">XYZ64</span><span class="p">(:)</span> <span class="c">!&lt; X, Y, Z coordinates encoded in base64.</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">)</span><span class="kd">::</span>                       <span class="n">rf</span>       <span class="c">!&lt; Real file index.</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">)</span><span class="kd">::</span>                       <span class="n">n1</span>       <span class="c">!&lt; Counter.</span>
  <span class="c">!---------------------------------------------------------------------------------------------------------------------------------</span>

  <span class="c">!---------------------------------------------------------------------------------------------------------------------------------</span>
  <span class="n">E_IO</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1_I4P</span>
  <span class="n">rf</span> <span class="o">=</span> <span class="n">f</span>
  <span class="k">if</span> <span class="p">(</span><span class="nb">present</span><span class="p">(</span><span class="n">cf</span><span class="p">))</span> <span class="k">then</span>
<span class="k">    </span><span class="n">rf</span> <span class="o">=</span> <span class="n">cf</span> <span class="p">;</span> <span class="n">f</span> <span class="o">=</span> <span class="n">cf</span>
  <span class="n">endif</span>
  <span class="k">select case</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">f</span><span class="p">)</span>
  <span class="k">case</span><span class="p">(</span><span class="n">ascii</span><span class="p">)</span>
    <span class="n">s_buffer</span> <span class="o">=</span> <span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;Piece Extent=&quot;&#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">nx1</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39; &#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">nx2</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39; &#39;</span><span class="o">//</span> <span class="p">&amp;</span>
                                                              <span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">ny1</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39; &#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">ny2</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39; &#39;</span><span class="o">//</span> <span class="p">&amp;</span>
                                                              <span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">nz1</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39; &#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">nz2</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39;&quot;&gt;&#39;</span>
    <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;(A)&#39;</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">trim</span><span class="p">(</span><span class="n">s_buffer</span><span class="p">)</span> <span class="p">;</span> <span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span> <span class="o">=</span> <span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span> <span class="o">+</span> <span class="mi">2</span>
    <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;(A)&#39;</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;Points&gt;&#39;</span> <span class="p">;</span> <span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span> <span class="o">=</span> <span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span> <span class="o">+</span> <span class="mi">2</span>
    <span class="n">s_buffer</span> <span class="o">=</span> <span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;DataArray type=&quot;Float32&quot; NumberOfComponents=&quot;3&quot; Name=&quot;Points&quot; format=&quot;ascii&quot;&gt;&#39;</span>
    <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;(A)&#39;</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">trim</span><span class="p">(</span><span class="n">s_buffer</span><span class="p">)</span>
    <span class="k">do </span><span class="n">n1</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">NN</span>
      <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;(A)&#39;</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="n">str</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">X</span><span class="p">(</span><span class="n">n1</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39; &#39;</span><span class="o">//</span><span class="n">str</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">Y</span><span class="p">(</span><span class="n">n1</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39; &#39;</span><span class="o">//</span><span class="n">str</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">Z</span><span class="p">(</span><span class="n">n1</span><span class="p">))</span>
    <span class="n">enddo</span>
    <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;(A)&#39;</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;/DataArray&gt;&#39;</span> <span class="p">;</span> <span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span> <span class="o">=</span> <span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span> <span class="o">-</span> <span class="mi">2</span>
    <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;(A)&#39;</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;/Points&gt;&#39;</span>
  <span class="k">case</span><span class="p">(</span><span class="n">raw</span><span class="p">,</span><span class="n">bin_app</span><span class="p">)</span>
    <span class="n">s_buffer</span> <span class="o">=</span> <span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;Piece Extent=&quot;&#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">nx1</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39; &#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">nx2</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39; &#39;</span><span class="o">//</span> <span class="p">&amp;</span>
                                                              <span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">ny1</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39; &#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">ny2</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39; &#39;</span><span class="o">//</span> <span class="p">&amp;</span>
                                                              <span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">nz1</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39; &#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">nz2</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39;&quot;&gt;&#39;</span>
    <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">trim</span><span class="p">(</span><span class="n">s_buffer</span><span class="p">)</span><span class="o">//</span><span class="n">end_rec</span> <span class="p">;</span> <span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span> <span class="o">=</span> <span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span> <span class="o">+</span> <span class="mi">2</span>
    <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;Points&gt;&#39;</span><span class="o">//</span><span class="n">end_rec</span> <span class="p">;</span> <span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span> <span class="o">=</span> <span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span> <span class="o">+</span> <span class="mi">2</span>
    <span class="n">s_buffer</span> <span class="o">=</span> <span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span>                                                                  <span class="p">&amp;</span>
               <span class="s1">&#39;&lt;DataArray type=&quot;Float32&quot; NumberOfComponents=&quot;3&quot; Name=&quot;Points&quot; format=&quot;appended&quot; offset=&quot;&#39;</span><span class="o">//</span> <span class="p">&amp;</span>
               <span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(.</span><span class="n">true</span><span class="p">.,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">ioffset</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39;&quot;/&gt;&#39;</span>
    <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">trim</span><span class="p">(</span><span class="n">s_buffer</span><span class="p">)</span><span class="o">//</span><span class="n">end_rec</span>
    <span class="k">call </span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">byte_update</span><span class="p">(</span><span class="n">N_Byte</span> <span class="o">=</span> <span class="mi">3</span><span class="o">*</span><span class="n">NN</span><span class="o">*</span><span class="n">BYR4P</span><span class="p">)</span>
    <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">ua</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">N_Byte</span><span class="p">,</span><span class="s1">&#39;R4&#39;</span><span class="p">,</span><span class="mi">3</span><span class="o">*</span><span class="n">NN</span>
    <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">ua</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)(</span><span class="n">X</span><span class="p">(</span><span class="n">n1</span><span class="p">),</span><span class="n">Y</span><span class="p">(</span><span class="n">n1</span><span class="p">),</span><span class="n">Z</span><span class="p">(</span><span class="n">n1</span><span class="p">),</span><span class="n">n1</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">NN</span><span class="p">)</span>
    <span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span> <span class="o">=</span> <span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span> <span class="o">-</span> <span class="mi">2</span> <span class="p">;</span> <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;/Points&gt;&#39;</span><span class="o">//</span><span class="n">end_rec</span>
  <span class="k">case</span><span class="p">(</span><span class="n">binary</span><span class="p">)</span>
    <span class="n">s_buffer</span> <span class="o">=</span> <span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;Piece Extent=&quot;&#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">nx1</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39; &#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">nx2</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39; &#39;</span><span class="o">//</span> <span class="p">&amp;</span>
                                                              <span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">ny1</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39; &#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">ny2</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39; &#39;</span><span class="o">//</span> <span class="p">&amp;</span>
                                                              <span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">nz1</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39; &#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">nz2</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39;&quot;&gt;&#39;</span>
    <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">trim</span><span class="p">(</span><span class="n">s_buffer</span><span class="p">)</span><span class="o">//</span><span class="n">end_rec</span> <span class="p">;</span> <span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span> <span class="o">=</span> <span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span> <span class="o">+</span> <span class="mi">2</span>
    <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;Points&gt;&#39;</span><span class="o">//</span><span class="n">end_rec</span> <span class="p">;</span> <span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span> <span class="o">=</span> <span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span> <span class="o">+</span> <span class="mi">2</span>
    <span class="n">s_buffer</span> <span class="o">=</span> <span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;DataArray type=&quot;Float32&quot; NumberOfComponents=&quot;3&quot; Name=&quot;Points&quot; format=&quot;binary&quot;&gt;&#39;</span>
    <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">trim</span><span class="p">(</span><span class="n">s_buffer</span><span class="p">)</span><span class="o">//</span><span class="n">end_rec</span>
    <span class="k">call </span><span class="n">pack_data</span><span class="p">(</span><span class="n">a1</span><span class="o">=</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="mi">3</span><span class="o">*</span><span class="n">NN</span><span class="o">*</span><span class="n">BYR4P</span><span class="p">,</span><span class="n">I4P</span><span class="p">)],</span><span class="n">a2</span><span class="o">=</span><span class="p">[(</span><span class="n">X</span><span class="p">(</span><span class="n">n1</span><span class="p">),</span><span class="n">Y</span><span class="p">(</span><span class="n">n1</span><span class="p">),</span><span class="n">Z</span><span class="p">(</span><span class="n">n1</span><span class="p">),</span><span class="n">n1</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">NN</span><span class="p">)],</span><span class="n">packed</span><span class="o">=</span><span class="n">XYZp</span><span class="p">)</span>
    <span class="k">call </span><span class="n">b64_encode</span><span class="p">(</span><span class="n">nB</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">BYI1P</span><span class="p">,</span><span class="n">I4P</span><span class="p">),</span><span class="n">n</span><span class="o">=</span><span class="n">XYZp</span><span class="p">,</span><span class="n">code</span><span class="o">=</span><span class="n">XYZ64</span><span class="p">)</span> <span class="p">;</span> <span class="k">deallocate</span><span class="p">(</span><span class="n">XYZp</span><span class="p">)</span>
    <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="o">+</span><span class="mi">2</span><span class="p">)</span><span class="o">//</span><span class="n">tochar</span><span class="p">(</span><span class="n">XYZ64</span><span class="p">)</span><span class="o">//</span><span class="n">end_rec</span> <span class="p">;</span> <span class="k">deallocate</span><span class="p">(</span><span class="n">XYZ64</span><span class="p">)</span>
    <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;/DataArray&gt;&#39;</span><span class="o">//</span><span class="n">end_rec</span>
    <span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span> <span class="o">=</span> <span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span> <span class="o">-</span> <span class="mi">2</span> <span class="p">;</span> <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;/Points&gt;&#39;</span><span class="o">//</span><span class="n">end_rec</span>
  <span class="n">endselect</span>
  <span class="k">return</span>
  <span class="c">!---------------------------------------------------------------------------------------------------------------------------------</span>
  <span class="n">endfunction</span> <span class="n">VTK_GEO_XML_STRG_1DA_R4</span>

  <span class="c">!&gt; Function for saving mesh with \b StructuredGrid topology (R4P, 3D Arrays).</span>
  <span class="c">!&gt; @return E_IO: integer(I4P) error flag</span>
  <span class="k">function </span><span class="n">VTK_GEO_XML_STRG_3DA_R4</span><span class="p">(</span><span class="n">nx1</span><span class="p">,</span><span class="n">nx2</span><span class="p">,</span><span class="n">ny1</span><span class="p">,</span><span class="n">ny2</span><span class="p">,</span><span class="n">nz1</span><span class="p">,</span><span class="n">nz2</span><span class="p">,</span><span class="n">NN</span><span class="p">,</span><span class="n">X</span><span class="p">,</span><span class="n">Y</span><span class="p">,</span><span class="n">Z</span><span class="p">,</span><span class="n">cf</span><span class="p">)</span> <span class="k">result</span><span class="p">(</span><span class="n">E_IO</span><span class="p">)</span>
  <span class="c">!---------------------------------------------------------------------------------------------------------------------------------</span>
  <span class="k">implicit none</span>
<span class="k">  </span><span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span><span class="kd">::</span>           <span class="n">nx1</span>               <span class="c">!&lt; Initial node of x axis.</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span><span class="kd">::</span>           <span class="n">nx2</span>               <span class="c">!&lt; Final node of x axis.</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span><span class="kd">::</span>           <span class="n">ny1</span>               <span class="c">!&lt; Initial node of y axis.</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span><span class="kd">::</span>           <span class="n">ny2</span>               <span class="c">!&lt; Final node of y axis.</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span><span class="kd">::</span>           <span class="n">nz1</span>               <span class="c">!&lt; Initial node of z axis.</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span><span class="kd">::</span>           <span class="n">nz2</span>               <span class="c">!&lt; Final node of z axis.</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span><span class="kd">::</span>           <span class="n">NN</span>                <span class="c">!&lt; Number of all nodes.</span>
  <span class="kt">real</span><span class="p">(</span><span class="n">R4P</span><span class="p">),</span>    <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span><span class="kd">::</span>           <span class="n">X</span><span class="p">(</span><span class="n">nx1</span><span class="p">:,</span><span class="n">ny1</span><span class="p">:,</span><span class="n">nz1</span><span class="p">:)</span> <span class="c">!&lt; X coordinates [nx1:nx2,ny1:ny2,nz1:nz2].</span>
  <span class="kt">real</span><span class="p">(</span><span class="n">R4P</span><span class="p">),</span>    <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span><span class="kd">::</span>           <span class="n">Y</span><span class="p">(</span><span class="n">nx1</span><span class="p">:,</span><span class="n">ny1</span><span class="p">:,</span><span class="n">nz1</span><span class="p">:)</span> <span class="c">!&lt; Y coordinates [nx1:nx2,ny1:ny2,nz1:nz2].</span>
  <span class="kt">real</span><span class="p">(</span><span class="n">R4P</span><span class="p">),</span>    <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span><span class="kd">::</span>           <span class="n">Z</span><span class="p">(</span><span class="n">nx1</span><span class="p">:,</span><span class="n">ny1</span><span class="p">:,</span><span class="n">nz1</span><span class="p">:)</span> <span class="c">!&lt; Z coordinates [nx1:nx2,ny1:ny2,nz1:nz2].</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">),</span> <span class="k">optional</span><span class="kd">::</span> <span class="n">cf</span>                <span class="c">!&lt; Current file index (for concurrent files IO).</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">)</span><span class="kd">::</span>                       <span class="n">E_IO</span>              <span class="c">!&lt; Input/Output inquiring flag: $0$ if IO is done, $&gt; 0$ if IO is not done.</span>
  <span class="kt">character</span><span class="p">(</span><span class="nb">len</span><span class="o">=</span><span class="n">maxlen</span><span class="p">)</span><span class="kd">::</span>              <span class="n">s_buffer</span>          <span class="c">!&lt; Buffer string.</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I1P</span><span class="p">),</span> <span class="k">allocatable</span><span class="kd">::</span>          <span class="n">XYZp</span><span class="p">(:)</span>           <span class="c">!&lt; Packed data.</span>
  <span class="kt">character</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="k">allocatable</span><span class="kd">::</span>          <span class="n">XYZ64</span><span class="p">(:)</span>          <span class="c">!&lt; X, Y, Z coordinates encoded in base64.</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">)</span><span class="kd">::</span>                       <span class="n">rf</span>                <span class="c">!&lt; Real file index.</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">)</span><span class="kd">::</span>                       <span class="n">nx</span><span class="p">,</span><span class="n">ny</span><span class="p">,</span><span class="n">nz</span>          <span class="c">!&lt; Counters.</span>
  <span class="c">!---------------------------------------------------------------------------------------------------------------------------------</span>

  <span class="c">!---------------------------------------------------------------------------------------------------------------------------------</span>
  <span class="n">E_IO</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1_I4P</span>
  <span class="n">rf</span> <span class="o">=</span> <span class="n">f</span>
  <span class="k">if</span> <span class="p">(</span><span class="nb">present</span><span class="p">(</span><span class="n">cf</span><span class="p">))</span> <span class="k">then</span>
<span class="k">    </span><span class="n">rf</span> <span class="o">=</span> <span class="n">cf</span> <span class="p">;</span> <span class="n">f</span> <span class="o">=</span> <span class="n">cf</span>
  <span class="n">endif</span>
  <span class="k">select case</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">f</span><span class="p">)</span>
  <span class="k">case</span><span class="p">(</span><span class="n">ascii</span><span class="p">)</span>
    <span class="n">s_buffer</span> <span class="o">=</span> <span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;Piece Extent=&quot;&#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">nx1</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39; &#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">nx2</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39; &#39;</span><span class="o">//</span> <span class="p">&amp;</span>
                                                              <span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">ny1</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39; &#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">ny2</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39; &#39;</span><span class="o">//</span> <span class="p">&amp;</span>
                                                              <span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">nz1</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39; &#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">nz2</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39;&quot;&gt;&#39;</span>
    <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;(A)&#39;</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">trim</span><span class="p">(</span><span class="n">s_buffer</span><span class="p">)</span> <span class="p">;</span> <span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span> <span class="o">=</span> <span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span> <span class="o">+</span> <span class="mi">2</span>
    <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;(A)&#39;</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;Points&gt;&#39;</span> <span class="p">;</span> <span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span> <span class="o">=</span> <span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span> <span class="o">+</span> <span class="mi">2</span>
    <span class="n">s_buffer</span> <span class="o">=</span> <span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;DataArray type=&quot;Float32&quot; NumberOfComponents=&quot;3&quot; Name=&quot;Points&quot; format=&quot;ascii&quot;&gt;&#39;</span>
    <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;(A)&#39;</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">trim</span><span class="p">(</span><span class="n">s_buffer</span><span class="p">)</span>
    <span class="k">do </span><span class="n">nz</span><span class="o">=</span><span class="n">nz1</span><span class="p">,</span><span class="n">nz2</span>
      <span class="k">do </span><span class="n">ny</span><span class="o">=</span><span class="n">ny1</span><span class="p">,</span><span class="n">ny2</span>
        <span class="k">do </span><span class="n">nx</span><span class="o">=</span><span class="n">nx1</span><span class="p">,</span><span class="n">nx2</span>
          <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;(A)&#39;</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="p">&amp;</span>
                                                     <span class="n">str</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">X</span><span class="p">(</span><span class="n">nx</span><span class="p">,</span><span class="n">ny</span><span class="p">,</span><span class="n">nz</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39; &#39;</span><span class="o">//</span><span class="n">str</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">Y</span><span class="p">(</span><span class="n">nx</span><span class="p">,</span><span class="n">ny</span><span class="p">,</span><span class="n">nz</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39; &#39;</span><span class="o">//</span><span class="n">str</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">Z</span><span class="p">(</span><span class="n">nx</span><span class="p">,</span><span class="n">ny</span><span class="p">,</span><span class="n">nz</span><span class="p">))</span>
        <span class="n">enddo</span>
      <span class="n">enddo</span>
    <span class="n">enddo</span>
    <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;(A)&#39;</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;/DataArray&gt;&#39;</span> <span class="p">;</span> <span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span> <span class="o">=</span> <span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span> <span class="o">-</span> <span class="mi">2</span>
    <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;(A)&#39;</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;/Points&gt;&#39;</span>
  <span class="k">case</span><span class="p">(</span><span class="n">raw</span><span class="p">,</span><span class="n">bin_app</span><span class="p">)</span>
    <span class="n">s_buffer</span> <span class="o">=</span> <span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;Piece Extent=&quot;&#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">nx1</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39; &#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">nx2</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39; &#39;</span><span class="o">//</span> <span class="p">&amp;</span>
                                                              <span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">ny1</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39; &#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">ny2</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39; &#39;</span><span class="o">//</span> <span class="p">&amp;</span>
                                                              <span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">nz1</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39; &#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">nz2</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39;&quot;&gt;&#39;</span>
    <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">trim</span><span class="p">(</span><span class="n">s_buffer</span><span class="p">)</span><span class="o">//</span><span class="n">end_rec</span> <span class="p">;</span> <span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span> <span class="o">=</span> <span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span> <span class="o">+</span> <span class="mi">2</span>
    <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;Points&gt;&#39;</span><span class="o">//</span><span class="n">end_rec</span> <span class="p">;</span> <span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span> <span class="o">=</span> <span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span> <span class="o">+</span> <span class="mi">2</span>
    <span class="n">s_buffer</span> <span class="o">=</span> <span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span>                                                                  <span class="p">&amp;</span>
               <span class="s1">&#39;&lt;DataArray type=&quot;Float32&quot; NumberOfComponents=&quot;3&quot; Name=&quot;Points&quot; format=&quot;appended&quot; offset=&quot;&#39;</span><span class="o">//</span> <span class="p">&amp;</span>
               <span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(.</span><span class="n">true</span><span class="p">.,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">ioffset</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39;&quot;/&gt;&#39;</span>
    <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">trim</span><span class="p">(</span><span class="n">s_buffer</span><span class="p">)</span><span class="o">//</span><span class="n">end_rec</span>
    <span class="k">call </span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">byte_update</span><span class="p">(</span><span class="n">N_Byte</span> <span class="o">=</span> <span class="mi">3</span><span class="o">*</span><span class="n">NN</span><span class="o">*</span><span class="n">BYR4P</span><span class="p">)</span>
    <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">ua</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">N_Byte</span><span class="p">,</span><span class="s1">&#39;R4&#39;</span><span class="p">,</span><span class="mi">3</span><span class="o">*</span><span class="n">NN</span>
    <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">ua</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)(((</span><span class="n">X</span><span class="p">(</span><span class="n">nx</span><span class="p">,</span><span class="n">ny</span><span class="p">,</span><span class="n">nz</span><span class="p">),</span><span class="n">Y</span><span class="p">(</span><span class="n">nx</span><span class="p">,</span><span class="n">ny</span><span class="p">,</span><span class="n">nz</span><span class="p">),</span><span class="n">Z</span><span class="p">(</span><span class="n">nx</span><span class="p">,</span><span class="n">ny</span><span class="p">,</span><span class="n">nz</span><span class="p">),</span><span class="n">nx</span><span class="o">=</span><span class="n">nx1</span><span class="p">,</span><span class="n">nx2</span><span class="p">),</span><span class="n">ny</span><span class="o">=</span><span class="n">ny1</span><span class="p">,</span><span class="n">ny2</span><span class="p">),</span><span class="n">nz</span><span class="o">=</span><span class="n">nz1</span><span class="p">,</span><span class="n">nz2</span><span class="p">)</span>
    <span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span> <span class="o">=</span> <span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span> <span class="o">-</span> <span class="mi">2</span> <span class="p">;</span> <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;/Points&gt;&#39;</span><span class="o">//</span><span class="n">end_rec</span>
  <span class="k">case</span><span class="p">(</span><span class="n">binary</span><span class="p">)</span>
    <span class="n">s_buffer</span> <span class="o">=</span> <span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;Piece Extent=&quot;&#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">nx1</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39; &#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">nx2</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39; &#39;</span><span class="o">//</span> <span class="p">&amp;</span>
                                                              <span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">ny1</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39; &#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">ny2</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39; &#39;</span><span class="o">//</span> <span class="p">&amp;</span>
                                                              <span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">nz1</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39; &#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">nz2</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39;&quot;&gt;&#39;</span>
    <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">trim</span><span class="p">(</span><span class="n">s_buffer</span><span class="p">)</span><span class="o">//</span><span class="n">end_rec</span> <span class="p">;</span> <span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span> <span class="o">=</span> <span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span> <span class="o">+</span> <span class="mi">2</span>
    <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;Points&gt;&#39;</span><span class="o">//</span><span class="n">end_rec</span> <span class="p">;</span> <span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span> <span class="o">=</span> <span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span> <span class="o">+</span> <span class="mi">2</span>
    <span class="n">s_buffer</span> <span class="o">=</span> <span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;DataArray type=&quot;Float32&quot; NumberOfComponents=&quot;3&quot; Name=&quot;Points&quot; format=&quot;binary&quot;&gt;&#39;</span>
    <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">trim</span><span class="p">(</span><span class="n">s_buffer</span><span class="p">)</span><span class="o">//</span><span class="n">end_rec</span>
    <span class="k">call </span><span class="n">pack_data</span><span class="p">(</span><span class="n">a1</span><span class="o">=</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="mi">3</span><span class="o">*</span><span class="n">NN</span><span class="o">*</span><span class="n">BYR4P</span><span class="p">,</span><span class="n">I4P</span><span class="p">)],</span><span class="n">a2</span><span class="o">=</span><span class="p">[(((</span><span class="n">X</span><span class="p">(</span><span class="n">nx</span><span class="p">,</span><span class="n">ny</span><span class="p">,</span><span class="n">nz</span><span class="p">),</span><span class="n">Y</span><span class="p">(</span><span class="n">nx</span><span class="p">,</span><span class="n">ny</span><span class="p">,</span><span class="n">nz</span><span class="p">),</span><span class="n">Z</span><span class="p">(</span><span class="n">nx</span><span class="p">,</span><span class="n">ny</span><span class="p">,</span><span class="n">nz</span><span class="p">),</span><span class="n">nx</span><span class="o">=</span><span class="n">nx1</span><span class="p">,</span><span class="n">nx2</span><span class="p">),</span><span class="n">ny</span><span class="o">=</span><span class="n">ny1</span><span class="p">,</span><span class="n">ny2</span><span class="p">),</span><span class="n">nz</span><span class="o">=</span><span class="n">nz1</span><span class="p">,</span><span class="n">nz2</span><span class="p">)],</span> <span class="p">&amp;</span>
                   <span class="n">packed</span><span class="o">=</span><span class="n">XYZp</span><span class="p">)</span>
    <span class="k">call </span><span class="n">b64_encode</span><span class="p">(</span><span class="n">nB</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">BYI1P</span><span class="p">,</span><span class="n">I4P</span><span class="p">),</span><span class="n">n</span><span class="o">=</span><span class="n">XYZp</span><span class="p">,</span><span class="n">code</span><span class="o">=</span><span class="n">XYZ64</span><span class="p">)</span> <span class="p">;</span> <span class="k">deallocate</span><span class="p">(</span><span class="n">XYZp</span><span class="p">)</span>
    <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="o">+</span><span class="mi">2</span><span class="p">)</span><span class="o">//</span><span class="n">tochar</span><span class="p">(</span><span class="n">XYZ64</span><span class="p">)</span><span class="o">//</span><span class="n">end_rec</span> <span class="p">;</span> <span class="k">deallocate</span><span class="p">(</span><span class="n">XYZ64</span><span class="p">)</span>
    <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;/DataArray&gt;&#39;</span><span class="o">//</span><span class="n">end_rec</span>
    <span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span> <span class="o">=</span> <span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span> <span class="o">-</span> <span class="mi">2</span> <span class="p">;</span> <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;/Points&gt;&#39;</span><span class="o">//</span><span class="n">end_rec</span>
  <span class="n">endselect</span>
  <span class="k">return</span>
  <span class="c">!---------------------------------------------------------------------------------------------------------------------------------</span>
  <span class="n">endfunction</span> <span class="n">VTK_GEO_XML_STRG_3DA_R4</span>

  <span class="c">!&gt; Function for saving mesh with \b StructuredGrid topology (R4P, 1D Arrays, packed API).</span>
  <span class="c">!&gt; @return E_IO: integer(I4P) error flag</span>
  <span class="k">function </span><span class="n">VTK_GEO_XML_STRG_1DAP_R4</span><span class="p">(</span><span class="n">nx1</span><span class="p">,</span><span class="n">nx2</span><span class="p">,</span><span class="n">ny1</span><span class="p">,</span><span class="n">ny2</span><span class="p">,</span><span class="n">nz1</span><span class="p">,</span><span class="n">nz2</span><span class="p">,</span><span class="n">NN</span><span class="p">,</span><span class="n">XYZ</span><span class="p">,</span><span class="n">cf</span><span class="p">)</span> <span class="k">result</span><span class="p">(</span><span class="n">E_IO</span><span class="p">)</span>
  <span class="c">!---------------------------------------------------------------------------------------------------------------------------------</span>
  <span class="k">implicit none</span>
<span class="k">  </span><span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span><span class="kd">::</span>           <span class="n">nx1</span>        <span class="c">!&lt; Initial node of x axis.</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span><span class="kd">::</span>           <span class="n">nx2</span>        <span class="c">!&lt; Final node of x axis.</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span><span class="kd">::</span>           <span class="n">ny1</span>        <span class="c">!&lt; Initial node of y axis.</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span><span class="kd">::</span>           <span class="n">ny2</span>        <span class="c">!&lt; Final node of y axis.</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span><span class="kd">::</span>           <span class="n">nz1</span>        <span class="c">!&lt; Initial node of z axis.</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span><span class="kd">::</span>           <span class="n">nz2</span>        <span class="c">!&lt; Final node of z axis.</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span><span class="kd">::</span>           <span class="n">NN</span>         <span class="c">!&lt; Number of all nodes.</span>
  <span class="kt">real</span><span class="p">(</span><span class="n">R4P</span><span class="p">),</span>    <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span><span class="kd">::</span>           <span class="n">XYZ</span><span class="p">(</span><span class="mi">1</span><span class="p">:,</span><span class="mi">1</span><span class="p">:)</span> <span class="c">!&lt; X, Y, Z coordinates (packed API) [1:3,1:NN].</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">),</span> <span class="k">optional</span><span class="kd">::</span> <span class="n">cf</span>         <span class="c">!&lt; Current file index (for concurrent files IO).</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">)</span><span class="kd">::</span>                       <span class="n">E_IO</span>       <span class="c">!&lt; Input/Output inquiring flag: $0$ if IO is done, $&gt; 0$ if IO is not done.</span>
  <span class="kt">character</span><span class="p">(</span><span class="nb">len</span><span class="o">=</span><span class="n">maxlen</span><span class="p">)</span><span class="kd">::</span>              <span class="n">s_buffer</span>   <span class="c">!&lt; Buffer string.</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I1P</span><span class="p">),</span> <span class="k">allocatable</span><span class="kd">::</span>          <span class="n">XYZp</span><span class="p">(:)</span>    <span class="c">!&lt; Packed data.</span>
  <span class="kt">character</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="k">allocatable</span><span class="kd">::</span>          <span class="n">XYZ64</span><span class="p">(:)</span>   <span class="c">!&lt; X, Y, Z coordinates encoded in base64.</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">)</span><span class="kd">::</span>                       <span class="n">rf</span>         <span class="c">!&lt; Real file index.</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">)</span><span class="kd">::</span>                       <span class="n">n1</span>         <span class="c">!&lt; Counter.</span>
  <span class="c">!---------------------------------------------------------------------------------------------------------------------------------</span>

  <span class="c">!---------------------------------------------------------------------------------------------------------------------------------</span>
  <span class="n">E_IO</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1_I4P</span>
  <span class="n">rf</span> <span class="o">=</span> <span class="n">f</span>
  <span class="k">if</span> <span class="p">(</span><span class="nb">present</span><span class="p">(</span><span class="n">cf</span><span class="p">))</span> <span class="k">then</span>
<span class="k">    </span><span class="n">rf</span> <span class="o">=</span> <span class="n">cf</span> <span class="p">;</span> <span class="n">f</span> <span class="o">=</span> <span class="n">cf</span>
  <span class="n">endif</span>
  <span class="k">select case</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">f</span><span class="p">)</span>
  <span class="k">case</span><span class="p">(</span><span class="n">ascii</span><span class="p">)</span>
    <span class="n">s_buffer</span> <span class="o">=</span> <span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;Piece Extent=&quot;&#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">nx1</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39; &#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">nx2</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39; &#39;</span><span class="o">//</span> <span class="p">&amp;</span>
                                                              <span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">ny1</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39; &#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">ny2</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39; &#39;</span><span class="o">//</span> <span class="p">&amp;</span>
                                                              <span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">nz1</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39; &#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">nz2</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39;&quot;&gt;&#39;</span>
    <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;(A)&#39;</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">trim</span><span class="p">(</span><span class="n">s_buffer</span><span class="p">)</span> <span class="p">;</span> <span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span> <span class="o">=</span> <span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span> <span class="o">+</span> <span class="mi">2</span>
    <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;(A)&#39;</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;Points&gt;&#39;</span> <span class="p">;</span> <span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span> <span class="o">=</span> <span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span> <span class="o">+</span> <span class="mi">2</span>
    <span class="n">s_buffer</span> <span class="o">=</span> <span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;DataArray type=&quot;Float32&quot; NumberOfComponents=&quot;3&quot; Name=&quot;Points&quot; format=&quot;ascii&quot;&gt;&#39;</span>
    <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;(A)&#39;</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">trim</span><span class="p">(</span><span class="n">s_buffer</span><span class="p">)</span>
    <span class="k">do </span><span class="n">n1</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">NN</span>
      <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;(A)&#39;</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="p">&amp;</span>
                                                 <span class="n">str</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">XYZ</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">n1</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39; &#39;</span><span class="o">//</span><span class="n">str</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">XYZ</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="n">n1</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39; &#39;</span><span class="o">//</span><span class="n">str</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">XYZ</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="n">n1</span><span class="p">))</span>
    <span class="n">enddo</span>
    <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;(A)&#39;</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;/DataArray&gt;&#39;</span> <span class="p">;</span> <span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span> <span class="o">=</span> <span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span> <span class="o">-</span> <span class="mi">2</span>
    <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;(A)&#39;</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;/Points&gt;&#39;</span>
  <span class="k">case</span><span class="p">(</span><span class="n">raw</span><span class="p">,</span><span class="n">bin_app</span><span class="p">)</span>
    <span class="n">s_buffer</span> <span class="o">=</span> <span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;Piece Extent=&quot;&#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">nx1</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39; &#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">nx2</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39; &#39;</span><span class="o">//</span> <span class="p">&amp;</span>
                                                              <span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">ny1</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39; &#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">ny2</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39; &#39;</span><span class="o">//</span> <span class="p">&amp;</span>
                                                              <span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">nz1</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39; &#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">nz2</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39;&quot;&gt;&#39;</span>
    <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">trim</span><span class="p">(</span><span class="n">s_buffer</span><span class="p">)</span><span class="o">//</span><span class="n">end_rec</span> <span class="p">;</span> <span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span> <span class="o">=</span> <span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span> <span class="o">+</span> <span class="mi">2</span>
    <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;Points&gt;&#39;</span><span class="o">//</span><span class="n">end_rec</span> <span class="p">;</span> <span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span> <span class="o">=</span> <span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span> <span class="o">+</span> <span class="mi">2</span>
    <span class="n">s_buffer</span> <span class="o">=</span> <span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span>                                                                  <span class="p">&amp;</span>
               <span class="s1">&#39;&lt;DataArray type=&quot;Float32&quot; NumberOfComponents=&quot;3&quot; Name=&quot;Points&quot; format=&quot;appended&quot; offset=&quot;&#39;</span><span class="o">//</span> <span class="p">&amp;</span>
               <span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(.</span><span class="n">true</span><span class="p">.,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">ioffset</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39;&quot;/&gt;&#39;</span>
    <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">trim</span><span class="p">(</span><span class="n">s_buffer</span><span class="p">)</span><span class="o">//</span><span class="n">end_rec</span>
    <span class="k">call </span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">byte_update</span><span class="p">(</span><span class="n">N_Byte</span> <span class="o">=</span> <span class="mi">3</span><span class="o">*</span><span class="n">NN</span><span class="o">*</span><span class="n">BYR4P</span><span class="p">)</span>
    <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">ua</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">N_Byte</span><span class="p">,</span><span class="s1">&#39;R4&#39;</span><span class="p">,</span><span class="mi">3</span><span class="o">*</span><span class="n">NN</span>
    <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">ua</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="n">XYZ</span>
    <span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span> <span class="o">=</span> <span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span> <span class="o">-</span> <span class="mi">2</span> <span class="p">;</span> <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;/Points&gt;&#39;</span><span class="o">//</span><span class="n">end_rec</span>
  <span class="k">case</span><span class="p">(</span><span class="n">binary</span><span class="p">)</span>
    <span class="n">s_buffer</span> <span class="o">=</span> <span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;Piece Extent=&quot;&#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">nx1</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39; &#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">nx2</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39; &#39;</span><span class="o">//</span> <span class="p">&amp;</span>
                                                              <span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">ny1</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39; &#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">ny2</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39; &#39;</span><span class="o">//</span> <span class="p">&amp;</span>
                                                              <span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">nz1</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39; &#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">nz2</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39;&quot;&gt;&#39;</span>
    <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">trim</span><span class="p">(</span><span class="n">s_buffer</span><span class="p">)</span><span class="o">//</span><span class="n">end_rec</span> <span class="p">;</span> <span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span> <span class="o">=</span> <span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span> <span class="o">+</span> <span class="mi">2</span>
    <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;Points&gt;&#39;</span><span class="o">//</span><span class="n">end_rec</span> <span class="p">;</span> <span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span> <span class="o">=</span> <span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span> <span class="o">+</span> <span class="mi">2</span>
    <span class="n">s_buffer</span> <span class="o">=</span> <span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;DataArray type=&quot;Float32&quot; NumberOfComponents=&quot;3&quot; Name=&quot;Points&quot; format=&quot;binary&quot;&gt;&#39;</span>
    <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">trim</span><span class="p">(</span><span class="n">s_buffer</span><span class="p">)</span><span class="o">//</span><span class="n">end_rec</span>
    <span class="k">call </span><span class="n">pack_data</span><span class="p">(</span><span class="n">a1</span><span class="o">=</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="mi">3</span><span class="o">*</span><span class="n">NN</span><span class="o">*</span><span class="n">BYR4P</span><span class="p">,</span><span class="n">I4P</span><span class="p">)],</span><span class="n">a2</span><span class="o">=</span><span class="nb">reshape</span><span class="p">(</span><span class="n">XYZ</span><span class="p">,[</span><span class="mi">3</span><span class="o">*</span><span class="n">NN</span><span class="p">]),</span><span class="n">packed</span><span class="o">=</span><span class="n">XYZp</span><span class="p">)</span>
    <span class="k">call </span><span class="n">b64_encode</span><span class="p">(</span><span class="n">nB</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">BYI1P</span><span class="p">,</span><span class="n">I4P</span><span class="p">),</span><span class="n">n</span><span class="o">=</span><span class="n">XYZp</span><span class="p">,</span><span class="n">code</span><span class="o">=</span><span class="n">XYZ64</span><span class="p">)</span> <span class="p">;</span> <span class="k">deallocate</span><span class="p">(</span><span class="n">XYZp</span><span class="p">)</span>
    <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="o">+</span><span class="mi">2</span><span class="p">)</span><span class="o">//</span><span class="n">tochar</span><span class="p">(</span><span class="n">XYZ64</span><span class="p">)</span><span class="o">//</span><span class="n">end_rec</span> <span class="p">;</span> <span class="k">deallocate</span><span class="p">(</span><span class="n">XYZ64</span><span class="p">)</span>
    <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;/DataArray&gt;&#39;</span><span class="o">//</span><span class="n">end_rec</span>
    <span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span> <span class="o">=</span> <span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span> <span class="o">-</span> <span class="mi">2</span> <span class="p">;</span> <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;/Points&gt;&#39;</span><span class="o">//</span><span class="n">end_rec</span>
  <span class="n">endselect</span>
  <span class="k">return</span>
  <span class="c">!---------------------------------------------------------------------------------------------------------------------------------</span>
  <span class="n">endfunction</span> <span class="n">VTK_GEO_XML_STRG_1DAP_R4</span>

  <span class="c">!&gt; Function for saving mesh with \b StructuredGrid topology (R4P, 3D Arrays, packed API).</span>
  <span class="c">!&gt; @return E_IO: integer(I4P) error flag</span>
  <span class="k">function </span><span class="n">VTK_GEO_XML_STRG_3DAP_R4</span><span class="p">(</span><span class="n">nx1</span><span class="p">,</span><span class="n">nx2</span><span class="p">,</span><span class="n">ny1</span><span class="p">,</span><span class="n">ny2</span><span class="p">,</span><span class="n">nz1</span><span class="p">,</span><span class="n">nz2</span><span class="p">,</span><span class="n">NN</span><span class="p">,</span><span class="n">XYZ</span><span class="p">,</span><span class="n">cf</span><span class="p">)</span> <span class="k">result</span><span class="p">(</span><span class="n">E_IO</span><span class="p">)</span>
  <span class="c">!---------------------------------------------------------------------------------------------------------------------------------</span>
  <span class="k">implicit none</span>
<span class="k">  </span><span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span><span class="kd">::</span>           <span class="n">nx1</span>                    <span class="c">!&lt; Initial node of x axis.</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span><span class="kd">::</span>           <span class="n">nx2</span>                    <span class="c">!&lt; Final node of x axis.</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span><span class="kd">::</span>           <span class="n">ny1</span>                    <span class="c">!&lt; Initial node of y axis.</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span><span class="kd">::</span>           <span class="n">ny2</span>                    <span class="c">!&lt; Final node of y axis.</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span><span class="kd">::</span>           <span class="n">nz1</span>                    <span class="c">!&lt; Initial node of z axis.</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span><span class="kd">::</span>           <span class="n">nz2</span>                    <span class="c">!&lt; Final node of z axis.</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span><span class="kd">::</span>           <span class="n">NN</span>                     <span class="c">!&lt; Number of all nodes.</span>
  <span class="kt">real</span><span class="p">(</span><span class="n">R4P</span><span class="p">),</span>    <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span><span class="kd">::</span>           <span class="n">XYZ</span><span class="p">(</span><span class="mi">1</span><span class="p">:,</span><span class="n">nx1</span><span class="p">:,</span><span class="n">ny1</span><span class="p">:,</span><span class="n">nz1</span><span class="p">:)</span> <span class="c">!&lt; X, Y, Z coordinates (packed API) [1:3,nx1:nx2,ny1:ny2,nz1:nz2].</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">),</span> <span class="k">optional</span><span class="kd">::</span> <span class="n">cf</span>                     <span class="c">!&lt; Current file index (for concurrent files IO).</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">)</span><span class="kd">::</span>                       <span class="n">E_IO</span>             <span class="c">!&lt; Input/Output inquiring flag: $0$ if IO is done, $&gt; 0$ if IO is not done.</span>
  <span class="kt">character</span><span class="p">(</span><span class="nb">len</span><span class="o">=</span><span class="n">maxlen</span><span class="p">)</span><span class="kd">::</span>              <span class="n">s_buffer</span>               <span class="c">!&lt; Buffer string.</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I1P</span><span class="p">),</span> <span class="k">allocatable</span><span class="kd">::</span>          <span class="n">XYZp</span><span class="p">(:)</span>                <span class="c">!&lt; Packed data.</span>
  <span class="kt">character</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="k">allocatable</span><span class="kd">::</span>          <span class="n">XYZ64</span><span class="p">(:)</span>               <span class="c">!&lt; X, Y, Z coordinates encoded in base64.</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">)</span><span class="kd">::</span>                       <span class="n">rf</span>                     <span class="c">!&lt; Real file index.</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">)</span><span class="kd">::</span>                       <span class="n">nx</span><span class="p">,</span><span class="n">ny</span><span class="p">,</span><span class="n">nz</span>               <span class="c">!&lt; Counters.</span>
  <span class="c">!---------------------------------------------------------------------------------------------------------------------------------</span>

  <span class="c">!---------------------------------------------------------------------------------------------------------------------------------</span>
  <span class="n">E_IO</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1_I4P</span>
  <span class="n">rf</span> <span class="o">=</span> <span class="n">f</span>
  <span class="k">if</span> <span class="p">(</span><span class="nb">present</span><span class="p">(</span><span class="n">cf</span><span class="p">))</span> <span class="k">then</span>
<span class="k">    </span><span class="n">rf</span> <span class="o">=</span> <span class="n">cf</span> <span class="p">;</span> <span class="n">f</span> <span class="o">=</span> <span class="n">cf</span>
  <span class="n">endif</span>
  <span class="k">select case</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">f</span><span class="p">)</span>
  <span class="k">case</span><span class="p">(</span><span class="n">ascii</span><span class="p">)</span>
    <span class="n">s_buffer</span> <span class="o">=</span> <span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;Piece Extent=&quot;&#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">nx1</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39; &#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">nx2</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39; &#39;</span><span class="o">//</span> <span class="p">&amp;</span>
                                                              <span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">ny1</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39; &#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">ny2</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39; &#39;</span><span class="o">//</span> <span class="p">&amp;</span>
                                                              <span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">nz1</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39; &#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">nz2</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39;&quot;&gt;&#39;</span>
    <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;(A)&#39;</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">trim</span><span class="p">(</span><span class="n">s_buffer</span><span class="p">)</span> <span class="p">;</span> <span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span> <span class="o">=</span> <span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span> <span class="o">+</span> <span class="mi">2</span>
    <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;(A)&#39;</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;Points&gt;&#39;</span> <span class="p">;</span> <span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span> <span class="o">=</span> <span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span> <span class="o">+</span> <span class="mi">2</span>
    <span class="n">s_buffer</span> <span class="o">=</span> <span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;DataArray type=&quot;Float32&quot; NumberOfComponents=&quot;3&quot; Name=&quot;Points&quot; format=&quot;ascii&quot;&gt;&#39;</span>
    <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;(A)&#39;</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">trim</span><span class="p">(</span><span class="n">s_buffer</span><span class="p">)</span>
    <span class="k">do </span><span class="n">nz</span><span class="o">=</span><span class="n">nz1</span><span class="p">,</span><span class="n">nz2</span>
      <span class="k">do </span><span class="n">ny</span><span class="o">=</span><span class="n">ny1</span><span class="p">,</span><span class="n">ny2</span>
        <span class="k">do </span><span class="n">nx</span><span class="o">=</span><span class="n">nx1</span><span class="p">,</span><span class="n">nx2</span>
          <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;(A)&#39;</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="p">&amp;</span>
                                                    <span class="n">str</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">XYZ</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">nx</span><span class="p">,</span><span class="n">ny</span><span class="p">,</span><span class="n">nz</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39; &#39;</span><span class="o">//</span><span class="n">str</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">XYZ</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="n">nx</span><span class="p">,</span><span class="n">ny</span><span class="p">,</span><span class="n">nz</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39; &#39;</span><span class="o">//</span><span class="n">str</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">XYZ</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="n">nx</span><span class="p">,</span><span class="n">ny</span><span class="p">,</span><span class="n">nz</span><span class="p">))</span>
        <span class="n">enddo</span>
      <span class="n">enddo</span>
    <span class="n">enddo</span>
    <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;(A)&#39;</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;/DataArray&gt;&#39;</span> <span class="p">;</span> <span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span> <span class="o">=</span> <span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span> <span class="o">-</span> <span class="mi">2</span>
    <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;(A)&#39;</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;/Points&gt;&#39;</span>
  <span class="k">case</span><span class="p">(</span><span class="n">raw</span><span class="p">,</span><span class="n">bin_app</span><span class="p">)</span>
    <span class="n">s_buffer</span> <span class="o">=</span> <span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;Piece Extent=&quot;&#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">nx1</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39; &#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">nx2</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39; &#39;</span><span class="o">//</span> <span class="p">&amp;</span>
                                                              <span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">ny1</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39; &#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">ny2</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39; &#39;</span><span class="o">//</span> <span class="p">&amp;</span>
                                                              <span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">nz1</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39; &#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">nz2</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39;&quot;&gt;&#39;</span>
    <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">trim</span><span class="p">(</span><span class="n">s_buffer</span><span class="p">)</span><span class="o">//</span><span class="n">end_rec</span> <span class="p">;</span> <span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span> <span class="o">=</span> <span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span> <span class="o">+</span> <span class="mi">2</span>
    <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;Points&gt;&#39;</span><span class="o">//</span><span class="n">end_rec</span> <span class="p">;</span> <span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span> <span class="o">=</span> <span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span> <span class="o">+</span> <span class="mi">2</span>
    <span class="n">s_buffer</span> <span class="o">=</span> <span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span>                                                                  <span class="p">&amp;</span>
               <span class="s1">&#39;&lt;DataArray type=&quot;Float32&quot; NumberOfComponents=&quot;3&quot; Name=&quot;Points&quot; format=&quot;appended&quot; offset=&quot;&#39;</span><span class="o">//</span> <span class="p">&amp;</span>
               <span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(.</span><span class="n">true</span><span class="p">.,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">ioffset</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39;&quot;/&gt;&#39;</span>
    <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">trim</span><span class="p">(</span><span class="n">s_buffer</span><span class="p">)</span><span class="o">//</span><span class="n">end_rec</span>
    <span class="k">call </span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">byte_update</span><span class="p">(</span><span class="n">N_Byte</span> <span class="o">=</span> <span class="mi">3</span><span class="o">*</span><span class="n">NN</span><span class="o">*</span><span class="n">BYR4P</span><span class="p">)</span>
    <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">ua</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">N_Byte</span><span class="p">,</span><span class="s1">&#39;R4&#39;</span><span class="p">,</span><span class="mi">3</span><span class="o">*</span><span class="n">NN</span>
    <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">ua</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="n">XYZ</span>
    <span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span> <span class="o">=</span> <span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span> <span class="o">-</span> <span class="mi">2</span> <span class="p">;</span> <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;/Points&gt;&#39;</span><span class="o">//</span><span class="n">end_rec</span>
  <span class="k">case</span><span class="p">(</span><span class="n">binary</span><span class="p">)</span>
    <span class="n">s_buffer</span> <span class="o">=</span> <span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;Piece Extent=&quot;&#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">nx1</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39; &#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">nx2</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39; &#39;</span><span class="o">//</span> <span class="p">&amp;</span>
                                                              <span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">ny1</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39; &#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">ny2</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39; &#39;</span><span class="o">//</span> <span class="p">&amp;</span>
                                                              <span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">nz1</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39; &#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">nz2</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39;&quot;&gt;&#39;</span>
    <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">trim</span><span class="p">(</span><span class="n">s_buffer</span><span class="p">)</span><span class="o">//</span><span class="n">end_rec</span> <span class="p">;</span> <span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span> <span class="o">=</span> <span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span> <span class="o">+</span> <span class="mi">2</span>
    <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;Points&gt;&#39;</span><span class="o">//</span><span class="n">end_rec</span> <span class="p">;</span> <span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span> <span class="o">=</span> <span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span> <span class="o">+</span> <span class="mi">2</span>
    <span class="n">s_buffer</span> <span class="o">=</span> <span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;DataArray type=&quot;Float32&quot; NumberOfComponents=&quot;3&quot; Name=&quot;Points&quot; format=&quot;binary&quot;&gt;&#39;</span>
    <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">trim</span><span class="p">(</span><span class="n">s_buffer</span><span class="p">)</span><span class="o">//</span><span class="n">end_rec</span>
    <span class="k">call </span><span class="n">pack_data</span><span class="p">(</span><span class="n">a1</span><span class="o">=</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="mi">3</span><span class="o">*</span><span class="n">NN</span><span class="o">*</span><span class="n">BYR4P</span><span class="p">,</span><span class="n">I4P</span><span class="p">)],</span><span class="n">a2</span><span class="o">=</span><span class="nb">reshape</span><span class="p">(</span><span class="n">XYZ</span><span class="p">,[</span><span class="mi">3</span><span class="o">*</span><span class="n">NN</span><span class="p">]),</span><span class="n">packed</span><span class="o">=</span><span class="n">XYZp</span><span class="p">)</span>
    <span class="k">call </span><span class="n">b64_encode</span><span class="p">(</span><span class="n">nB</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">BYI1P</span><span class="p">,</span><span class="n">I4P</span><span class="p">),</span><span class="n">n</span><span class="o">=</span><span class="n">XYZp</span><span class="p">,</span><span class="n">code</span><span class="o">=</span><span class="n">XYZ64</span><span class="p">)</span> <span class="p">;</span> <span class="k">deallocate</span><span class="p">(</span><span class="n">XYZp</span><span class="p">)</span>
    <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="o">+</span><span class="mi">2</span><span class="p">)</span><span class="o">//</span><span class="n">tochar</span><span class="p">(</span><span class="n">XYZ64</span><span class="p">)</span><span class="o">//</span><span class="n">end_rec</span> <span class="p">;</span> <span class="k">deallocate</span><span class="p">(</span><span class="n">XYZ64</span><span class="p">)</span>
    <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;/DataArray&gt;&#39;</span><span class="o">//</span><span class="n">end_rec</span>
    <span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span> <span class="o">=</span> <span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span> <span class="o">-</span> <span class="mi">2</span> <span class="p">;</span> <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;/Points&gt;&#39;</span><span class="o">//</span><span class="n">end_rec</span>
  <span class="n">endselect</span>
  <span class="k">return</span>
  <span class="c">!---------------------------------------------------------------------------------------------------------------------------------</span>
  <span class="n">endfunction</span> <span class="n">VTK_GEO_XML_STRG_3DAP_R4</span>

  <span class="c">!&gt; Function for saving mesh with \b RectilinearGrid topology (R8P).</span>
  <span class="c">!&gt; @return E_IO: integer(I4P) error flag</span>
  <span class="k">function </span><span class="n">VTK_GEO_XML_RECT_R8</span><span class="p">(</span><span class="n">nx1</span><span class="p">,</span><span class="n">nx2</span><span class="p">,</span><span class="n">ny1</span><span class="p">,</span><span class="n">ny2</span><span class="p">,</span><span class="n">nz1</span><span class="p">,</span><span class="n">nz2</span><span class="p">,</span><span class="n">X</span><span class="p">,</span><span class="n">Y</span><span class="p">,</span><span class="n">Z</span><span class="p">,</span><span class="n">cf</span><span class="p">)</span> <span class="k">result</span><span class="p">(</span><span class="n">E_IO</span><span class="p">)</span>
  <span class="c">!---------------------------------------------------------------------------------------------------------------------------------</span>
  <span class="k">implicit none</span>
<span class="k">  </span><span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span><span class="kd">::</span>             <span class="n">nx1</span>        <span class="c">!&lt; Initial node of x axis.</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span><span class="kd">::</span>             <span class="n">nx2</span>        <span class="c">!&lt; Final node of x axis.</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span><span class="kd">::</span>             <span class="n">ny1</span>        <span class="c">!&lt; Initial node of y axis.</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span><span class="kd">::</span>             <span class="n">ny2</span>        <span class="c">!&lt; Final node of y axis.</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span><span class="kd">::</span>             <span class="n">nz1</span>        <span class="c">!&lt; Initial node of z axis.</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span><span class="kd">::</span>             <span class="n">nz2</span>        <span class="c">!&lt; Final node of z axis.</span>
  <span class="kt">real</span><span class="p">(</span><span class="n">R8P</span><span class="p">),</span>    <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span><span class="kd">::</span>             <span class="n">X</span><span class="p">(</span><span class="n">nx1</span><span class="p">:</span><span class="n">nx2</span><span class="p">)</span> <span class="c">!&lt; X coordinates.</span>
  <span class="kt">real</span><span class="p">(</span><span class="n">R8P</span><span class="p">),</span>    <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span><span class="kd">::</span>             <span class="n">Y</span><span class="p">(</span><span class="n">ny1</span><span class="p">:</span><span class="n">ny2</span><span class="p">)</span> <span class="c">!&lt; Y coordinates.</span>
  <span class="kt">real</span><span class="p">(</span><span class="n">R8P</span><span class="p">),</span>    <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span><span class="kd">::</span>             <span class="n">Z</span><span class="p">(</span><span class="n">nz1</span><span class="p">:</span><span class="n">nz2</span><span class="p">)</span> <span class="c">!&lt; Z coordinates.</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">),</span> <span class="k">optional</span><span class="kd">::</span>   <span class="n">cf</span>         <span class="c">!&lt; Current file index (for concurrent files IO).</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">)</span><span class="kd">::</span>                         <span class="n">E_IO</span>       <span class="c">!&lt; Input/Output inquiring flag: $0$ if IO is done, $&gt; 0$ if IO is not done.</span>
  <span class="kt">character</span><span class="p">(</span><span class="nb">len</span><span class="o">=</span><span class="n">maxlen</span><span class="p">)</span><span class="kd">::</span>                <span class="n">s_buffer</span>   <span class="c">!&lt; Buffer string.</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I1P</span><span class="p">),</span> <span class="k">allocatable</span><span class="kd">::</span>            <span class="n">XYZp</span><span class="p">(:)</span>    <span class="c">!&lt; Packed data.</span>
  <span class="kt">character</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="k">allocatable</span><span class="kd">::</span>            <span class="n">XYZ64</span><span class="p">(:)</span>   <span class="c">!&lt; X, Y, Z coordinates encoded in base64.</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">)</span><span class="kd">::</span>                         <span class="n">rf</span>         <span class="c">!&lt; Real file index.</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">)</span><span class="kd">::</span>                         <span class="n">n1</span>         <span class="c">!&lt; Counter.</span>
  <span class="c">!---------------------------------------------------------------------------------------------------------------------------------</span>

  <span class="c">!---------------------------------------------------------------------------------------------------------------------------------</span>
  <span class="n">E_IO</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1_I4P</span>
  <span class="n">rf</span> <span class="o">=</span> <span class="n">f</span>
  <span class="k">if</span> <span class="p">(</span><span class="nb">present</span><span class="p">(</span><span class="n">cf</span><span class="p">))</span> <span class="k">then</span>
<span class="k">    </span><span class="n">rf</span> <span class="o">=</span> <span class="n">cf</span> <span class="p">;</span> <span class="n">f</span> <span class="o">=</span> <span class="n">cf</span>
  <span class="n">endif</span>
  <span class="k">select case</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">f</span><span class="p">)</span>
  <span class="k">case</span><span class="p">(</span><span class="n">ascii</span><span class="p">)</span>
    <span class="n">s_buffer</span> <span class="o">=</span> <span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;Piece Extent=&quot;&#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">nx1</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39; &#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">nx2</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39; &#39;</span><span class="o">//</span> <span class="p">&amp;</span>
                                                              <span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">ny1</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39; &#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">ny2</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39; &#39;</span><span class="o">//</span> <span class="p">&amp;</span>
                                                              <span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">nz1</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39; &#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">nz2</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39;&quot;&gt;&#39;</span>
    <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;(A)&#39;</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">trim</span><span class="p">(</span><span class="n">s_buffer</span><span class="p">)</span> <span class="p">;</span> <span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span> <span class="o">=</span> <span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span> <span class="o">+</span> <span class="mi">2</span>
    <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;(A)&#39;</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;Coordinates&gt;&#39;</span> <span class="p">;</span> <span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span> <span class="o">=</span> <span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span> <span class="o">+</span> <span class="mi">2</span>
    <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;(A)&#39;</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;DataArray type=&quot;Float64&quot; Name=&quot;X&quot; format=&quot;ascii&quot;&gt;&#39;</span>
    <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">fmt</span><span class="o">=</span><span class="n">FR8P</span><span class="p">,</span> <span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)(</span><span class="n">X</span><span class="p">(</span><span class="n">n1</span><span class="p">),</span><span class="n">n1</span><span class="o">=</span><span class="n">nx1</span><span class="p">,</span><span class="n">nx2</span><span class="p">)</span>
    <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;(A)&#39;</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;/DataArray&gt;&#39;</span>
    <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;(A)&#39;</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;DataArray type=&quot;Float64&quot; Name=&quot;Y&quot; format=&quot;ascii&quot;&gt;&#39;</span>
    <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">fmt</span><span class="o">=</span><span class="n">FR8P</span><span class="p">,</span> <span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)(</span><span class="n">Y</span><span class="p">(</span><span class="n">n1</span><span class="p">),</span><span class="n">n1</span><span class="o">=</span><span class="n">ny1</span><span class="p">,</span><span class="n">ny2</span><span class="p">)</span>
    <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;(A)&#39;</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;/DataArray&gt;&#39;</span>
    <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;(A)&#39;</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;DataArray type=&quot;Float64&quot; Name=&quot;Z&quot; format=&quot;ascii&quot;&gt;&#39;</span>
    <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">fmt</span><span class="o">=</span><span class="n">FR8P</span><span class="p">,</span> <span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)(</span><span class="n">Z</span><span class="p">(</span><span class="n">n1</span><span class="p">),</span><span class="n">n1</span><span class="o">=</span><span class="n">nz1</span><span class="p">,</span><span class="n">nz2</span><span class="p">)</span>
    <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;(A)&#39;</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;/DataArray&gt;&#39;</span> <span class="p">;</span> <span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span> <span class="o">=</span> <span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span> <span class="o">-</span> <span class="mi">2</span>
    <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;(A)&#39;</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;/Coordinates&gt;&#39;</span>
  <span class="k">case</span><span class="p">(</span><span class="n">raw</span><span class="p">,</span><span class="n">bin_app</span><span class="p">)</span>
    <span class="n">s_buffer</span> <span class="o">=</span> <span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;Piece Extent=&quot;&#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">nx1</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39; &#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">nx2</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39; &#39;</span><span class="o">//</span> <span class="p">&amp;</span>
                                                              <span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">ny1</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39; &#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">ny2</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39; &#39;</span><span class="o">//</span> <span class="p">&amp;</span>
                                                              <span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">nz1</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39; &#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">nz2</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39;&quot;&gt;&#39;</span>
    <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">trim</span><span class="p">(</span><span class="n">s_buffer</span><span class="p">)</span><span class="o">//</span><span class="n">end_rec</span> <span class="p">;</span> <span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span> <span class="o">=</span> <span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span> <span class="o">+</span> <span class="mi">2</span>
    <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;Coordinates&gt;&#39;</span><span class="o">//</span><span class="n">end_rec</span> <span class="p">;</span> <span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span> <span class="o">=</span> <span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span> <span class="o">+</span> <span class="mi">2</span>
    <span class="n">s_buffer</span> <span class="o">=</span> <span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;DataArray type=&quot;Float64&quot; Name=&quot;X&quot; format=&quot;appended&quot; offset=&quot;&#39;</span><span class="o">//</span><span class="p">&amp;</span>
               <span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(.</span><span class="n">true</span><span class="p">.,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">ioffset</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39;&quot;/&gt;&#39;</span>
    <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">trim</span><span class="p">(</span><span class="n">s_buffer</span><span class="p">)</span><span class="o">//</span><span class="n">end_rec</span>
    <span class="k">call </span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">byte_update</span><span class="p">(</span><span class="n">N_Byte</span> <span class="o">=</span> <span class="p">(</span><span class="n">nx2</span><span class="o">-</span><span class="n">nx1</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">BYR8P</span><span class="p">)</span>
    <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">ua</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">N_Byte</span><span class="p">,</span><span class="s1">&#39;R8&#39;</span><span class="p">,(</span><span class="n">nx2</span><span class="o">-</span><span class="n">nx1</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">ua</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)(</span><span class="n">X</span><span class="p">(</span><span class="n">n1</span><span class="p">),</span><span class="n">n1</span><span class="o">=</span><span class="n">nx1</span><span class="p">,</span><span class="n">nx2</span><span class="p">)</span>
    <span class="n">s_buffer</span> <span class="o">=</span> <span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;DataArray type=&quot;Float64&quot; Name=&quot;Y&quot; format=&quot;appended&quot; offset=&quot;&#39;</span><span class="o">//</span><span class="p">&amp;</span>
               <span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(.</span><span class="n">true</span><span class="p">.,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">ioffset</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39;&quot;/&gt;&#39;</span>
    <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">trim</span><span class="p">(</span><span class="n">s_buffer</span><span class="p">)</span><span class="o">//</span><span class="n">end_rec</span>
    <span class="k">call </span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">byte_update</span><span class="p">(</span><span class="n">N_Byte</span> <span class="o">=</span> <span class="p">(</span><span class="n">ny2</span><span class="o">-</span><span class="n">ny1</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">BYR8P</span><span class="p">)</span>
    <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">ua</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">N_Byte</span><span class="p">,</span><span class="s1">&#39;R8&#39;</span><span class="p">,(</span><span class="n">ny2</span><span class="o">-</span><span class="n">ny1</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">ua</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)(</span><span class="n">Y</span><span class="p">(</span><span class="n">n1</span><span class="p">),</span><span class="n">n1</span><span class="o">=</span><span class="n">ny1</span><span class="p">,</span><span class="n">ny2</span><span class="p">)</span>
    <span class="n">s_buffer</span> <span class="o">=</span> <span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;DataArray type=&quot;Float64&quot; Name=&quot;Z&quot; format=&quot;appended&quot; offset=&quot;&#39;</span><span class="o">//</span><span class="p">&amp;</span>
               <span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(.</span><span class="n">true</span><span class="p">.,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">ioffset</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39;&quot;/&gt;&#39;</span>
    <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">trim</span><span class="p">(</span><span class="n">s_buffer</span><span class="p">)</span><span class="o">//</span><span class="n">end_rec</span>
    <span class="k">call </span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">byte_update</span><span class="p">(</span><span class="n">N_Byte</span> <span class="o">=</span> <span class="p">(</span><span class="n">nz2</span><span class="o">-</span><span class="n">nz1</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">BYR8P</span><span class="p">)</span>
    <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">ua</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">N_Byte</span><span class="p">,</span><span class="s1">&#39;R8&#39;</span><span class="p">,(</span><span class="n">nz2</span><span class="o">-</span><span class="n">nz1</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">ua</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)(</span><span class="n">Z</span><span class="p">(</span><span class="n">n1</span><span class="p">),</span><span class="n">n1</span><span class="o">=</span><span class="n">nz1</span><span class="p">,</span><span class="n">nz2</span><span class="p">)</span>
    <span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span> <span class="o">=</span> <span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span> <span class="o">-</span> <span class="mi">2</span> <span class="p">;</span> <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;/Coordinates&gt;&#39;</span><span class="o">//</span><span class="n">end_rec</span>
  <span class="k">case</span><span class="p">(</span><span class="n">binary</span><span class="p">)</span>
    <span class="n">s_buffer</span> <span class="o">=</span> <span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;Piece Extent=&quot;&#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">nx1</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39; &#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">nx2</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39; &#39;</span><span class="o">//</span> <span class="p">&amp;</span>
                                                              <span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">ny1</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39; &#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">ny2</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39; &#39;</span><span class="o">//</span> <span class="p">&amp;</span>
                                                              <span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">nz1</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39; &#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">nz2</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39;&quot;&gt;&#39;</span>
    <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">trim</span><span class="p">(</span><span class="n">s_buffer</span><span class="p">)</span><span class="o">//</span><span class="n">end_rec</span> <span class="p">;</span> <span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span> <span class="o">=</span> <span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span> <span class="o">+</span> <span class="mi">2</span>
    <span class="n">s_buffer</span> <span class="o">=</span> <span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;Coordinates&gt;&#39;</span>
    <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">trim</span><span class="p">(</span><span class="n">s_buffer</span><span class="p">)</span><span class="o">//</span><span class="n">end_rec</span> <span class="p">;</span> <span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span> <span class="o">=</span> <span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span> <span class="o">+</span> <span class="mi">2</span>
    <span class="n">s_buffer</span> <span class="o">=</span> <span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;DataArray type=&quot;Float64&quot; Name=&quot;X&quot; format=&quot;binary&quot;&gt;&#39;</span>
    <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">trim</span><span class="p">(</span><span class="n">s_buffer</span><span class="p">)</span><span class="o">//</span><span class="n">end_rec</span>
    <span class="k">call </span><span class="n">pack_data</span><span class="p">(</span><span class="n">a1</span><span class="o">=</span><span class="p">[</span><span class="nb">int</span><span class="p">((</span><span class="n">nx2</span><span class="o">-</span><span class="n">nx1</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">BYR8P</span><span class="p">,</span><span class="n">I4P</span><span class="p">)],</span><span class="n">a2</span><span class="o">=</span><span class="n">X</span><span class="p">,</span><span class="n">packed</span><span class="o">=</span><span class="n">XYZp</span><span class="p">)</span>
    <span class="k">call </span><span class="n">b64_encode</span><span class="p">(</span><span class="n">nB</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">BYI1P</span><span class="p">,</span><span class="n">I4P</span><span class="p">),</span><span class="n">n</span><span class="o">=</span><span class="n">XYZp</span><span class="p">,</span><span class="n">code</span><span class="o">=</span><span class="n">XYZ64</span><span class="p">)</span>
    <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="o">+</span><span class="mi">2</span><span class="p">)</span><span class="o">//</span><span class="n">tochar</span><span class="p">(</span><span class="n">XYZ64</span><span class="p">)</span><span class="o">//</span><span class="n">end_rec</span>
    <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;/DataArray&gt;&#39;</span><span class="o">//</span><span class="n">end_rec</span>
    <span class="n">s_buffer</span> <span class="o">=</span> <span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;DataArray type=&quot;Float64&quot; Name=&quot;Y&quot; format=&quot;binary&quot;&gt;&#39;</span>
    <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">trim</span><span class="p">(</span><span class="n">s_buffer</span><span class="p">)</span><span class="o">//</span><span class="n">end_rec</span>
    <span class="k">call </span><span class="n">pack_data</span><span class="p">(</span><span class="n">a1</span><span class="o">=</span><span class="p">[</span><span class="nb">int</span><span class="p">((</span><span class="n">ny2</span><span class="o">-</span><span class="n">ny1</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">BYR8P</span><span class="p">,</span><span class="n">I4P</span><span class="p">)],</span><span class="n">a2</span><span class="o">=</span><span class="n">Y</span><span class="p">,</span><span class="n">packed</span><span class="o">=</span><span class="n">XYZp</span><span class="p">)</span>
    <span class="k">call </span><span class="n">b64_encode</span><span class="p">(</span><span class="n">nB</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">BYI1P</span><span class="p">,</span><span class="n">I4P</span><span class="p">),</span><span class="n">n</span><span class="o">=</span><span class="n">XYZp</span><span class="p">,</span><span class="n">code</span><span class="o">=</span><span class="n">XYZ64</span><span class="p">)</span>
    <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="o">+</span><span class="mi">2</span><span class="p">)</span><span class="o">//</span><span class="n">tochar</span><span class="p">(</span><span class="n">XYZ64</span><span class="p">)</span><span class="o">//</span><span class="n">end_rec</span>
    <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;/DataArray&gt;&#39;</span><span class="o">//</span><span class="n">end_rec</span>
    <span class="n">s_buffer</span> <span class="o">=</span> <span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;DataArray type=&quot;Float64&quot; Name=&quot;Z&quot; format=&quot;binary&quot;&gt;&#39;</span>
    <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">trim</span><span class="p">(</span><span class="n">s_buffer</span><span class="p">)</span><span class="o">//</span><span class="n">end_rec</span>
    <span class="k">call </span><span class="n">pack_data</span><span class="p">(</span><span class="n">a1</span><span class="o">=</span><span class="p">[</span><span class="nb">int</span><span class="p">((</span><span class="n">nz2</span><span class="o">-</span><span class="n">nz1</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">BYR8P</span><span class="p">,</span><span class="n">I4P</span><span class="p">)],</span><span class="n">a2</span><span class="o">=</span><span class="n">Z</span><span class="p">,</span><span class="n">packed</span><span class="o">=</span><span class="n">XYZp</span><span class="p">)</span>
    <span class="k">call </span><span class="n">b64_encode</span><span class="p">(</span><span class="n">nB</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">BYI1P</span><span class="p">,</span><span class="n">I4P</span><span class="p">),</span><span class="n">n</span><span class="o">=</span><span class="n">XYZp</span><span class="p">,</span><span class="n">code</span><span class="o">=</span><span class="n">XYZ64</span><span class="p">)</span> <span class="p">;</span> <span class="k">deallocate</span><span class="p">(</span><span class="n">XYZp</span><span class="p">)</span>
    <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="o">+</span><span class="mi">2</span><span class="p">)</span><span class="o">//</span><span class="n">tochar</span><span class="p">(</span><span class="n">XYZ64</span><span class="p">)</span><span class="o">//</span><span class="n">end_rec</span> <span class="p">;</span> <span class="k">deallocate</span><span class="p">(</span><span class="n">XYZ64</span><span class="p">)</span>
    <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;/DataArray&gt;&#39;</span><span class="o">//</span><span class="n">end_rec</span>
    <span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span> <span class="o">=</span> <span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span> <span class="o">-</span> <span class="mi">2</span>
    <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;/Coordinates&gt;&#39;</span><span class="o">//</span><span class="n">end_rec</span>
  <span class="n">endselect</span>
  <span class="k">return</span>
  <span class="c">!---------------------------------------------------------------------------------------------------------------------------------</span>
  <span class="n">endfunction</span> <span class="n">VTK_GEO_XML_RECT_R8</span>

  <span class="c">!&gt; Function for saving mesh with \b RectilinearGrid topology (R4P).</span>
  <span class="c">!&gt; @return E_IO: integer(I4P) error flag</span>
  <span class="k">function </span><span class="n">VTK_GEO_XML_RECT_R4</span><span class="p">(</span><span class="n">nx1</span><span class="p">,</span><span class="n">nx2</span><span class="p">,</span><span class="n">ny1</span><span class="p">,</span><span class="n">ny2</span><span class="p">,</span><span class="n">nz1</span><span class="p">,</span><span class="n">nz2</span><span class="p">,</span><span class="n">X</span><span class="p">,</span><span class="n">Y</span><span class="p">,</span><span class="n">Z</span><span class="p">,</span><span class="n">cf</span><span class="p">)</span> <span class="k">result</span><span class="p">(</span><span class="n">E_IO</span><span class="p">)</span>
  <span class="c">!---------------------------------------------------------------------------------------------------------------------------------</span>
  <span class="k">implicit none</span>
<span class="k">  </span><span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span><span class="kd">::</span>             <span class="n">nx1</span>        <span class="c">!&lt; Initial node of x axis.</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span><span class="kd">::</span>             <span class="n">nx2</span>        <span class="c">!&lt; Final node of x axis.</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span><span class="kd">::</span>             <span class="n">ny1</span>        <span class="c">!&lt; Initial node of y axis.</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span><span class="kd">::</span>             <span class="n">ny2</span>        <span class="c">!&lt; Final node of y axis.</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span><span class="kd">::</span>             <span class="n">nz1</span>        <span class="c">!&lt; Initial node of z axis.</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span><span class="kd">::</span>             <span class="n">nz2</span>        <span class="c">!&lt; Final node of z axis.</span>
  <span class="kt">real</span><span class="p">(</span><span class="n">R4P</span><span class="p">),</span>    <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span><span class="kd">::</span>             <span class="n">X</span><span class="p">(</span><span class="n">nx1</span><span class="p">:</span><span class="n">nx2</span><span class="p">)</span> <span class="c">!&lt; X coordinates.</span>
  <span class="kt">real</span><span class="p">(</span><span class="n">R4P</span><span class="p">),</span>    <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span><span class="kd">::</span>             <span class="n">Y</span><span class="p">(</span><span class="n">ny1</span><span class="p">:</span><span class="n">ny2</span><span class="p">)</span> <span class="c">!&lt; Y coordinates.</span>
  <span class="kt">real</span><span class="p">(</span><span class="n">R4P</span><span class="p">),</span>    <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span><span class="kd">::</span>             <span class="n">Z</span><span class="p">(</span><span class="n">nz1</span><span class="p">:</span><span class="n">nz2</span><span class="p">)</span> <span class="c">!&lt; Z coordinates.</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">),</span> <span class="k">optional</span><span class="kd">::</span>   <span class="n">cf</span>         <span class="c">!&lt; Current file index (for concurrent files IO).</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">)</span><span class="kd">::</span>                         <span class="n">E_IO</span>       <span class="c">!&lt; Input/Output inquiring flag: $0$ if IO is done, $&gt; 0$ if IO is not done.</span>
  <span class="kt">character</span><span class="p">(</span><span class="nb">len</span><span class="o">=</span><span class="n">maxlen</span><span class="p">)</span><span class="kd">::</span>                <span class="n">s_buffer</span>   <span class="c">!&lt; Buffer string.</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I1P</span><span class="p">),</span> <span class="k">allocatable</span><span class="kd">::</span>            <span class="n">XYZp</span><span class="p">(:)</span>    <span class="c">!&lt; Packed data.</span>
  <span class="kt">character</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="k">allocatable</span><span class="kd">::</span>            <span class="n">XYZ64</span><span class="p">(:)</span>   <span class="c">!&lt; X, Y, Z coordinates encoded in base64.</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">)</span><span class="kd">::</span>                         <span class="n">rf</span>         <span class="c">!&lt; Real file index.</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">)</span><span class="kd">::</span>                         <span class="n">n1</span>         <span class="c">!&lt; Counter.</span>
  <span class="c">!---------------------------------------------------------------------------------------------------------------------------------</span>

  <span class="c">!---------------------------------------------------------------------------------------------------------------------------------</span>
  <span class="n">E_IO</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1_I4P</span>
  <span class="n">rf</span> <span class="o">=</span> <span class="n">f</span>
  <span class="k">if</span> <span class="p">(</span><span class="nb">present</span><span class="p">(</span><span class="n">cf</span><span class="p">))</span> <span class="k">then</span>
<span class="k">    </span><span class="n">rf</span> <span class="o">=</span> <span class="n">cf</span> <span class="p">;</span> <span class="n">f</span> <span class="o">=</span> <span class="n">cf</span>
  <span class="n">endif</span>
  <span class="k">select case</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">f</span><span class="p">)</span>
  <span class="k">case</span><span class="p">(</span><span class="n">ascii</span><span class="p">)</span>
    <span class="n">s_buffer</span> <span class="o">=</span> <span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;Piece Extent=&quot;&#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">nx1</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39; &#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">nx2</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39; &#39;</span><span class="o">//</span> <span class="p">&amp;</span>
                                                      <span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">ny1</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39; &#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">ny2</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39; &#39;</span><span class="o">//</span> <span class="p">&amp;</span>
                                                      <span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">nz1</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39; &#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">nz2</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39;&quot;&gt;&#39;</span>
    <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;(A)&#39;</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">trim</span><span class="p">(</span><span class="n">s_buffer</span><span class="p">)</span> <span class="p">;</span> <span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span> <span class="o">=</span> <span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span> <span class="o">+</span> <span class="mi">2</span>
    <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;(A)&#39;</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;Coordinates&gt;&#39;</span> <span class="p">;</span> <span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span> <span class="o">=</span> <span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span> <span class="o">+</span> <span class="mi">2</span>
    <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;(A)&#39;</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;DataArray type=&quot;Float32&quot; Name=&quot;X&quot; format=&quot;ascii&quot;&gt;&#39;</span>
    <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">fmt</span><span class="o">=</span><span class="n">FR4P</span><span class="p">,</span> <span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)(</span><span class="n">X</span><span class="p">(</span><span class="n">n1</span><span class="p">),</span><span class="n">n1</span><span class="o">=</span><span class="n">nx1</span><span class="p">,</span><span class="n">nx2</span><span class="p">)</span>
    <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;(A)&#39;</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;/DataArray&gt;&#39;</span>
    <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;(A)&#39;</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;DataArray type=&quot;Float32&quot; Name=&quot;Y&quot; format=&quot;ascii&quot;&gt;&#39;</span>
    <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">fmt</span><span class="o">=</span><span class="n">FR4P</span><span class="p">,</span> <span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)(</span><span class="n">Y</span><span class="p">(</span><span class="n">n1</span><span class="p">),</span><span class="n">n1</span><span class="o">=</span><span class="n">ny1</span><span class="p">,</span><span class="n">ny2</span><span class="p">)</span>
    <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;(A)&#39;</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;/DataArray&gt;&#39;</span>
    <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;(A)&#39;</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;DataArray type=&quot;Float32&quot; Name=&quot;Z&quot; format=&quot;ascii&quot;&gt;&#39;</span>
    <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">fmt</span><span class="o">=</span><span class="n">FR4P</span><span class="p">,</span> <span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)(</span><span class="n">Z</span><span class="p">(</span><span class="n">n1</span><span class="p">),</span><span class="n">n1</span><span class="o">=</span><span class="n">nz1</span><span class="p">,</span><span class="n">nz2</span><span class="p">)</span>
    <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;(A)&#39;</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;/DataArray&gt;&#39;</span> <span class="p">;</span> <span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span> <span class="o">=</span> <span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span> <span class="o">-</span> <span class="mi">2</span>
    <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;(A)&#39;</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;/Coordinates&gt;&#39;</span>
  <span class="k">case</span><span class="p">(</span><span class="n">raw</span><span class="p">,</span><span class="n">bin_app</span><span class="p">)</span>
    <span class="n">s_buffer</span> <span class="o">=</span> <span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;Piece Extent=&quot;&#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">nx1</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39; &#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">nx2</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39; &#39;</span><span class="o">//</span> <span class="p">&amp;</span>
                                                      <span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">ny1</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39; &#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">ny2</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39; &#39;</span><span class="o">//</span> <span class="p">&amp;</span>
                                                      <span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">nz1</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39; &#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">nz2</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39;&quot;&gt;&#39;</span>
    <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">trim</span><span class="p">(</span><span class="n">s_buffer</span><span class="p">)</span><span class="o">//</span><span class="n">end_rec</span> <span class="p">;</span> <span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span> <span class="o">=</span> <span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span> <span class="o">+</span> <span class="mi">2</span>
    <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;Coordinates&gt;&#39;</span><span class="o">//</span><span class="n">end_rec</span> <span class="p">;</span> <span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span> <span class="o">=</span> <span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span> <span class="o">+</span> <span class="mi">2</span>
    <span class="n">s_buffer</span> <span class="o">=</span> <span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;DataArray type=&quot;Float32&quot; Name=&quot;X&quot; format=&quot;appended&quot; offset=&quot;&#39;</span><span class="o">//</span><span class="p">&amp;</span>
               <span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(.</span><span class="n">true</span><span class="p">.,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">ioffset</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39;&quot;/&gt;&#39;</span>
    <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">trim</span><span class="p">(</span><span class="n">s_buffer</span><span class="p">)</span><span class="o">//</span><span class="n">end_rec</span>
    <span class="k">call </span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">byte_update</span><span class="p">(</span><span class="n">N_Byte</span> <span class="o">=</span> <span class="p">(</span><span class="n">nx2</span><span class="o">-</span><span class="n">nx1</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">BYR4P</span><span class="p">)</span>
    <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">ua</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">N_Byte</span><span class="p">,</span><span class="s1">&#39;R4&#39;</span><span class="p">,(</span><span class="n">nx2</span><span class="o">-</span><span class="n">nx1</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">ua</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)(</span><span class="n">X</span><span class="p">(</span><span class="n">n1</span><span class="p">),</span><span class="n">n1</span><span class="o">=</span><span class="n">nx1</span><span class="p">,</span><span class="n">nx2</span><span class="p">)</span>
    <span class="n">s_buffer</span> <span class="o">=</span> <span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;DataArray type=&quot;Float32&quot; Name=&quot;Y&quot; format=&quot;appended&quot; offset=&quot;&#39;</span><span class="o">//</span><span class="p">&amp;</span>
               <span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(.</span><span class="n">true</span><span class="p">.,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">ioffset</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39;&quot;/&gt;&#39;</span>
    <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">trim</span><span class="p">(</span><span class="n">s_buffer</span><span class="p">)</span><span class="o">//</span><span class="n">end_rec</span>
    <span class="k">call </span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">byte_update</span><span class="p">(</span><span class="n">N_Byte</span> <span class="o">=</span> <span class="p">(</span><span class="n">ny2</span><span class="o">-</span><span class="n">ny1</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">BYR4P</span><span class="p">)</span>
    <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">ua</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">N_Byte</span><span class="p">,</span><span class="s1">&#39;R4&#39;</span><span class="p">,(</span><span class="n">ny2</span><span class="o">-</span><span class="n">ny1</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">ua</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)(</span><span class="n">Y</span><span class="p">(</span><span class="n">n1</span><span class="p">),</span><span class="n">n1</span><span class="o">=</span><span class="n">ny1</span><span class="p">,</span><span class="n">ny2</span><span class="p">)</span>
    <span class="n">s_buffer</span> <span class="o">=</span> <span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;DataArray type=&quot;Float32&quot; Name=&quot;Z&quot; format=&quot;appended&quot; offset=&quot;&#39;</span><span class="o">//</span><span class="p">&amp;</span>
               <span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(.</span><span class="n">true</span><span class="p">.,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">ioffset</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39;&quot;/&gt;&#39;</span>
    <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">trim</span><span class="p">(</span><span class="n">s_buffer</span><span class="p">)</span><span class="o">//</span><span class="n">end_rec</span>
    <span class="k">call </span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">byte_update</span><span class="p">(</span><span class="n">N_Byte</span> <span class="o">=</span> <span class="p">(</span><span class="n">nz2</span><span class="o">-</span><span class="n">nz1</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">BYR4P</span><span class="p">)</span>
    <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">ua</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">N_Byte</span><span class="p">,</span><span class="s1">&#39;R4&#39;</span><span class="p">,(</span><span class="n">nz2</span><span class="o">-</span><span class="n">nz1</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">ua</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)(</span><span class="n">Z</span><span class="p">(</span><span class="n">n1</span><span class="p">),</span><span class="n">n1</span><span class="o">=</span><span class="n">nz1</span><span class="p">,</span><span class="n">nz2</span><span class="p">)</span>
    <span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span> <span class="o">=</span> <span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span> <span class="o">-</span> <span class="mi">2</span>  <span class="p">;</span> <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;/Coordinates&gt;&#39;</span><span class="o">//</span><span class="n">end_rec</span>
  <span class="k">case</span><span class="p">(</span><span class="n">binary</span><span class="p">)</span>
    <span class="n">s_buffer</span> <span class="o">=</span> <span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;Piece Extent=&quot;&#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">nx1</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39; &#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">nx2</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39; &#39;</span><span class="o">//</span> <span class="p">&amp;</span>
                                                              <span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">ny1</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39; &#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">ny2</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39; &#39;</span><span class="o">//</span> <span class="p">&amp;</span>
                                                              <span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">nz1</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39; &#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">nz2</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39;&quot;&gt;&#39;</span>
    <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">trim</span><span class="p">(</span><span class="n">s_buffer</span><span class="p">)</span><span class="o">//</span><span class="n">end_rec</span> <span class="p">;</span> <span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span> <span class="o">=</span> <span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span> <span class="o">+</span> <span class="mi">2</span>
    <span class="n">s_buffer</span> <span class="o">=</span> <span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;Coordinates&gt;&#39;</span>
    <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">trim</span><span class="p">(</span><span class="n">s_buffer</span><span class="p">)</span><span class="o">//</span><span class="n">end_rec</span> <span class="p">;</span> <span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span> <span class="o">=</span> <span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span> <span class="o">+</span> <span class="mi">2</span>
    <span class="n">s_buffer</span> <span class="o">=</span> <span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;DataArray type=&quot;Float32&quot; Name=&quot;X&quot; format=&quot;binary&quot;&gt;&#39;</span>
    <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">trim</span><span class="p">(</span><span class="n">s_buffer</span><span class="p">)</span><span class="o">//</span><span class="n">end_rec</span>
    <span class="k">call </span><span class="n">pack_data</span><span class="p">(</span><span class="n">a1</span><span class="o">=</span><span class="p">[</span><span class="nb">int</span><span class="p">((</span><span class="n">nx2</span><span class="o">-</span><span class="n">nx1</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">BYR4P</span><span class="p">,</span><span class="n">I4P</span><span class="p">)],</span><span class="n">a2</span><span class="o">=</span><span class="n">X</span><span class="p">,</span><span class="n">packed</span><span class="o">=</span><span class="n">XYZp</span><span class="p">)</span>
    <span class="k">call </span><span class="n">b64_encode</span><span class="p">(</span><span class="n">nB</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">BYI1P</span><span class="p">,</span><span class="n">I4P</span><span class="p">),</span><span class="n">n</span><span class="o">=</span><span class="n">XYZp</span><span class="p">,</span><span class="n">code</span><span class="o">=</span><span class="n">XYZ64</span><span class="p">)</span>
    <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="o">+</span><span class="mi">2</span><span class="p">)</span><span class="o">//</span><span class="n">tochar</span><span class="p">(</span><span class="n">XYZ64</span><span class="p">)</span><span class="o">//</span><span class="n">end_rec</span>
    <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;/DataArray&gt;&#39;</span><span class="o">//</span><span class="n">end_rec</span>
    <span class="n">s_buffer</span> <span class="o">=</span> <span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;DataArray type=&quot;Float32&quot; Name=&quot;Y&quot; format=&quot;binary&quot;&gt;&#39;</span>
    <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">trim</span><span class="p">(</span><span class="n">s_buffer</span><span class="p">)</span><span class="o">//</span><span class="n">end_rec</span>
    <span class="k">call </span><span class="n">pack_data</span><span class="p">(</span><span class="n">a1</span><span class="o">=</span><span class="p">[</span><span class="nb">int</span><span class="p">((</span><span class="n">ny2</span><span class="o">-</span><span class="n">ny1</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">BYR4P</span><span class="p">,</span><span class="n">I4P</span><span class="p">)],</span><span class="n">a2</span><span class="o">=</span><span class="n">Y</span><span class="p">,</span><span class="n">packed</span><span class="o">=</span><span class="n">XYZp</span><span class="p">)</span>
    <span class="k">call </span><span class="n">b64_encode</span><span class="p">(</span><span class="n">nB</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">BYI1P</span><span class="p">,</span><span class="n">I4P</span><span class="p">),</span><span class="n">n</span><span class="o">=</span><span class="n">XYZp</span><span class="p">,</span><span class="n">code</span><span class="o">=</span><span class="n">XYZ64</span><span class="p">)</span>
    <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="o">+</span><span class="mi">2</span><span class="p">)</span><span class="o">//</span><span class="n">tochar</span><span class="p">(</span><span class="n">XYZ64</span><span class="p">)</span><span class="o">//</span><span class="n">end_rec</span>
    <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;/DataArray&gt;&#39;</span><span class="o">//</span><span class="n">end_rec</span>
    <span class="n">s_buffer</span> <span class="o">=</span> <span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;DataArray type=&quot;Float32&quot; Name=&quot;Z&quot; format=&quot;binary&quot;&gt;&#39;</span>
    <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">trim</span><span class="p">(</span><span class="n">s_buffer</span><span class="p">)</span><span class="o">//</span><span class="n">end_rec</span>
    <span class="k">call </span><span class="n">pack_data</span><span class="p">(</span><span class="n">a1</span><span class="o">=</span><span class="p">[</span><span class="nb">int</span><span class="p">((</span><span class="n">nz2</span><span class="o">-</span><span class="n">nz1</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">BYR4P</span><span class="p">,</span><span class="n">I4P</span><span class="p">)],</span><span class="n">a2</span><span class="o">=</span><span class="n">Z</span><span class="p">,</span><span class="n">packed</span><span class="o">=</span><span class="n">XYZp</span><span class="p">)</span>
    <span class="k">call </span><span class="n">b64_encode</span><span class="p">(</span><span class="n">nB</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">BYI1P</span><span class="p">,</span><span class="n">I4P</span><span class="p">),</span><span class="n">n</span><span class="o">=</span><span class="n">XYZp</span><span class="p">,</span><span class="n">code</span><span class="o">=</span><span class="n">XYZ64</span><span class="p">)</span> <span class="p">;</span> <span class="k">deallocate</span><span class="p">(</span><span class="n">XYZp</span><span class="p">)</span>
    <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="o">+</span><span class="mi">2</span><span class="p">)</span><span class="o">//</span><span class="n">tochar</span><span class="p">(</span><span class="n">XYZ64</span><span class="p">)</span><span class="o">//</span><span class="n">end_rec</span> <span class="p">;</span> <span class="k">deallocate</span><span class="p">(</span><span class="n">XYZ64</span><span class="p">)</span>
    <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;/DataArray&gt;&#39;</span><span class="o">//</span><span class="n">end_rec</span>
    <span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span> <span class="o">=</span> <span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span> <span class="o">-</span> <span class="mi">2</span>
    <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;/Coordinates&gt;&#39;</span><span class="o">//</span><span class="n">end_rec</span>
  <span class="n">endselect</span>
  <span class="k">return</span>
  <span class="c">!---------------------------------------------------------------------------------------------------------------------------------</span>
  <span class="n">endfunction</span> <span class="n">VTK_GEO_XML_RECT_R4</span>

  <span class="c">!&gt; Function for saving mesh with \b UnstructuredGrid topology (R8P).</span>
  <span class="c">!&gt; @return E_IO: integer(I4P) error flag</span>
  <span class="k">function </span><span class="n">VTK_GEO_XML_UNST_R8</span><span class="p">(</span><span class="n">NN</span><span class="p">,</span><span class="n">NC</span><span class="p">,</span><span class="n">X</span><span class="p">,</span><span class="n">Y</span><span class="p">,</span><span class="n">Z</span><span class="p">,</span><span class="n">cf</span><span class="p">)</span> <span class="k">result</span><span class="p">(</span><span class="n">E_IO</span><span class="p">)</span>
  <span class="c">!---------------------------------------------------------------------------------------------------------------------------------</span>
  <span class="k">implicit none</span>
<span class="k">  </span><span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span><span class="kd">::</span>           <span class="n">NN</span>       <span class="c">!&lt; Number of nodes.</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span><span class="kd">::</span>           <span class="n">NC</span>       <span class="c">!&lt; Number of cells.</span>
  <span class="kt">real</span><span class="p">(</span><span class="n">R8P</span><span class="p">),</span>    <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span><span class="kd">::</span>           <span class="n">X</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">NN</span><span class="p">)</span>  <span class="c">!&lt; X coordinates.</span>
  <span class="kt">real</span><span class="p">(</span><span class="n">R8P</span><span class="p">),</span>    <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span><span class="kd">::</span>           <span class="n">Y</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">NN</span><span class="p">)</span>  <span class="c">!&lt; Y coordinates.</span>
  <span class="kt">real</span><span class="p">(</span><span class="n">R8P</span><span class="p">),</span>    <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span><span class="kd">::</span>           <span class="n">Z</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">NN</span><span class="p">)</span>  <span class="c">!&lt; Z coordinates.</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">),</span> <span class="k">optional</span><span class="kd">::</span> <span class="n">cf</span>       <span class="c">!&lt; Current file index (for concurrent files IO).</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">)</span><span class="kd">::</span>                       <span class="n">E_IO</span>     <span class="c">!&lt; Input/Output inquiring flag: $0$ if IO is done, $&gt; 0$ if IO is not done.</span>
  <span class="kt">character</span><span class="p">(</span><span class="nb">len</span><span class="o">=</span><span class="n">maxlen</span><span class="p">)</span><span class="kd">::</span>              <span class="n">s_buffer</span> <span class="c">!&lt; Buffer string.</span>
  <span class="kt">real</span><span class="p">(</span><span class="n">R8P</span><span class="p">),</span> <span class="k">allocatable</span><span class="kd">::</span>             <span class="n">XYZa</span><span class="p">(:)</span>  <span class="c">!&lt; X, Y, Z coordinates.</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I1P</span><span class="p">),</span> <span class="k">allocatable</span><span class="kd">::</span>          <span class="n">XYZp</span><span class="p">(:)</span>  <span class="c">!&lt; Packed data.</span>
  <span class="kt">character</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="k">allocatable</span><span class="kd">::</span>          <span class="n">XYZ64</span><span class="p">(:)</span> <span class="c">!&lt; X, Y, Z coordinates encoded in base64.</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">)</span><span class="kd">::</span>                       <span class="n">rf</span>       <span class="c">!&lt; Real file index.</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">)</span><span class="kd">::</span>                       <span class="n">n1</span>       <span class="c">!&lt; Counter.</span>
  <span class="c">!---------------------------------------------------------------------------------------------------------------------------------</span>

  <span class="c">!---------------------------------------------------------------------------------------------------------------------------------</span>
  <span class="n">E_IO</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1_I4P</span>
  <span class="n">rf</span> <span class="o">=</span> <span class="n">f</span>
  <span class="k">if</span> <span class="p">(</span><span class="nb">present</span><span class="p">(</span><span class="n">cf</span><span class="p">))</span> <span class="k">then</span>
<span class="k">    </span><span class="n">rf</span> <span class="o">=</span> <span class="n">cf</span> <span class="p">;</span> <span class="n">f</span> <span class="o">=</span> <span class="n">cf</span>
  <span class="n">endif</span>
  <span class="k">select case</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">f</span><span class="p">)</span>
  <span class="k">case</span><span class="p">(</span><span class="n">ascii</span><span class="p">)</span>
    <span class="n">s_buffer</span> <span class="o">=</span> <span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;Piece NumberOfPoints=&quot;&#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">NN</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39;&quot; NumberOfCells=&quot;&#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">NC</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39;&quot;&gt;&#39;</span>
    <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;(A)&#39;</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">trim</span><span class="p">(</span><span class="n">s_buffer</span><span class="p">)</span> <span class="p">;</span> <span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span> <span class="o">=</span> <span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span> <span class="o">+</span> <span class="mi">2</span>
    <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;(A)&#39;</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;Points&gt;&#39;</span> <span class="p">;</span> <span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span> <span class="o">=</span> <span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span> <span class="o">+</span> <span class="mi">2</span>
    <span class="n">s_buffer</span> <span class="o">=</span> <span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;DataArray type=&quot;Float64&quot; NumberOfComponents=&quot;3&quot; Name=&quot;Points&quot; format=&quot;ascii&quot;&gt;&#39;</span>
    <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;(A)&#39;</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">trim</span><span class="p">(</span><span class="n">s_buffer</span><span class="p">)</span>
    <span class="k">do </span><span class="n">n1</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">NN</span>
      <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;(A)&#39;</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="n">str</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">X</span><span class="p">(</span><span class="n">n1</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39; &#39;</span><span class="o">//</span><span class="n">str</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">Y</span><span class="p">(</span><span class="n">n1</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39; &#39;</span><span class="o">//</span><span class="n">str</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">Z</span><span class="p">(</span><span class="n">n1</span><span class="p">))</span>
    <span class="n">enddo</span>
    <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;(A)&#39;</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;/DataArray&gt;&#39;</span> <span class="p">;</span> <span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span> <span class="o">=</span> <span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span> <span class="o">-</span> <span class="mi">2</span>
    <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;(A)&#39;</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;/Points&gt;&#39;</span>
  <span class="k">case</span><span class="p">(</span><span class="n">raw</span><span class="p">,</span><span class="n">bin_app</span><span class="p">)</span>
    <span class="n">s_buffer</span> <span class="o">=</span> <span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;Piece NumberOfPoints=&quot;&#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">NN</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39;&quot; NumberOfCells=&quot;&#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">NC</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39;&quot;&gt;&#39;</span>
    <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">trim</span><span class="p">(</span><span class="n">s_buffer</span><span class="p">)</span><span class="o">//</span><span class="n">end_rec</span> <span class="p">;</span> <span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span> <span class="o">=</span> <span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span> <span class="o">+</span> <span class="mi">2</span>
    <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;Points&gt;&#39;</span><span class="o">//</span><span class="n">end_rec</span> <span class="p">;</span> <span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span> <span class="o">=</span> <span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span> <span class="o">+</span> <span class="mi">2</span>
    <span class="n">s_buffer</span> <span class="o">=</span> <span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span>                                                                  <span class="p">&amp;</span>
               <span class="s1">&#39;&lt;DataArray type=&quot;Float64&quot; NumberOfComponents=&quot;3&quot; Name=&quot;Points&quot; format=&quot;appended&quot; offset=&quot;&#39;</span><span class="o">//</span> <span class="p">&amp;</span>
               <span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(.</span><span class="n">true</span><span class="p">.,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">ioffset</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39;&quot;/&gt;&#39;</span>
    <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">trim</span><span class="p">(</span><span class="n">s_buffer</span><span class="p">)</span><span class="o">//</span><span class="n">end_rec</span>
    <span class="k">call </span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">byte_update</span><span class="p">(</span><span class="n">N_Byte</span> <span class="o">=</span> <span class="mi">3</span><span class="o">*</span><span class="n">NN</span><span class="o">*</span><span class="n">BYR8P</span><span class="p">)</span>
    <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">ua</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">N_Byte</span><span class="p">,</span><span class="s1">&#39;R8&#39;</span><span class="p">,</span><span class="mi">3</span><span class="o">*</span><span class="n">NN</span>
    <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">ua</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)(</span><span class="n">X</span><span class="p">(</span><span class="n">n1</span><span class="p">),</span><span class="n">Y</span><span class="p">(</span><span class="n">n1</span><span class="p">),</span><span class="n">Z</span><span class="p">(</span><span class="n">n1</span><span class="p">),</span><span class="n">n1</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">NN</span><span class="p">)</span>
    <span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span> <span class="o">=</span> <span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span> <span class="o">-</span> <span class="mi">2</span> <span class="p">;</span> <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;/Points&gt;&#39;</span><span class="o">//</span><span class="n">end_rec</span>
  <span class="k">case</span><span class="p">(</span><span class="n">binary</span><span class="p">)</span>
    <span class="n">s_buffer</span> <span class="o">=</span> <span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;Piece NumberOfPoints=&quot;&#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">NN</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39;&quot; NumberOfCells=&quot;&#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">NC</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39;&quot;&gt;&#39;</span>
    <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">trim</span><span class="p">(</span><span class="n">s_buffer</span><span class="p">)</span><span class="o">//</span><span class="n">end_rec</span> <span class="p">;</span> <span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span> <span class="o">=</span> <span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span> <span class="o">+</span> <span class="mi">2</span>
    <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;Points&gt;&#39;</span><span class="o">//</span><span class="n">end_rec</span> <span class="p">;</span> <span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span> <span class="o">=</span> <span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span> <span class="o">+</span> <span class="mi">2</span>
    <span class="n">s_buffer</span> <span class="o">=</span> <span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;DataArray type=&quot;Float64&quot; NumberOfComponents=&quot;3&quot; Name=&quot;Points&quot; format=&quot;binary&quot;&gt;&#39;</span>
    <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">trim</span><span class="p">(</span><span class="n">s_buffer</span><span class="p">)</span><span class="o">//</span><span class="n">end_rec</span>
    <span class="k">allocate</span><span class="p">(</span><span class="n">XYZa</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="o">*</span><span class="n">NN</span><span class="p">))</span>
    <span class="k">do </span><span class="n">n1</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span><span class="n">NN</span>
      <span class="n">XYZa</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="p">(</span><span class="n">n1</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="mi">3</span><span class="p">:</span><span class="mi">1</span><span class="o">+</span><span class="p">(</span><span class="n">n1</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="mi">3</span><span class="o">+</span><span class="mi">2</span><span class="p">)</span><span class="o">=</span><span class="p">[</span><span class="n">X</span><span class="p">(</span><span class="n">n1</span><span class="p">),</span><span class="n">Y</span><span class="p">(</span><span class="n">n1</span><span class="p">),</span><span class="n">Z</span><span class="p">(</span><span class="n">n1</span><span class="p">)]</span>
    <span class="n">enddo</span>
    <span class="k">call </span><span class="n">pack_data</span><span class="p">(</span><span class="n">a1</span><span class="o">=</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="mi">3</span><span class="o">*</span><span class="n">NN</span><span class="o">*</span><span class="n">BYR8P</span><span class="p">,</span><span class="n">I4P</span><span class="p">)],</span><span class="n">a2</span><span class="o">=</span><span class="n">XYZa</span><span class="p">,</span><span class="n">packed</span><span class="o">=</span><span class="n">XYZp</span><span class="p">)</span> <span class="p">;</span> <span class="k">deallocate</span><span class="p">(</span><span class="n">XYZa</span><span class="p">)</span>
    <span class="k">call </span><span class="n">b64_encode</span><span class="p">(</span><span class="n">nB</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">BYI1P</span><span class="p">,</span><span class="n">I4P</span><span class="p">),</span><span class="n">n</span><span class="o">=</span><span class="n">XYZp</span><span class="p">,</span><span class="n">code</span><span class="o">=</span><span class="n">XYZ64</span><span class="p">)</span> <span class="p">;</span> <span class="k">deallocate</span><span class="p">(</span><span class="n">XYZp</span><span class="p">)</span>
    <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="o">+</span><span class="mi">2</span><span class="p">)</span><span class="o">//</span><span class="n">tochar</span><span class="p">(</span><span class="n">XYZ64</span><span class="p">)</span><span class="o">//</span><span class="n">end_rec</span> <span class="p">;</span> <span class="k">deallocate</span><span class="p">(</span><span class="n">XYZ64</span><span class="p">)</span>
    <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;/DataArray&gt;&#39;</span><span class="o">//</span><span class="n">end_rec</span>
    <span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span> <span class="o">=</span> <span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span> <span class="o">-</span> <span class="mi">2</span> <span class="p">;</span> <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;/Points&gt;&#39;</span><span class="o">//</span><span class="n">end_rec</span>
  <span class="n">endselect</span>
  <span class="k">return</span>
  <span class="c">!---------------------------------------------------------------------------------------------------------------------------------</span>
  <span class="n">endfunction</span> <span class="n">VTK_GEO_XML_UNST_R8</span>

  <span class="c">!&gt; Function for saving mesh with \b UnstructuredGrid topology (R8P, packed API).</span>
  <span class="c">!&gt; @return E_IO: integer(I4P) error flag</span>
  <span class="k">function </span><span class="n">VTK_GEO_XML_UNST_PACK_R8</span><span class="p">(</span><span class="n">NN</span><span class="p">,</span><span class="n">NC</span><span class="p">,</span><span class="n">XYZ</span><span class="p">,</span><span class="n">cf</span><span class="p">)</span> <span class="k">result</span><span class="p">(</span><span class="n">E_IO</span><span class="p">)</span>
  <span class="c">!---------------------------------------------------------------------------------------------------------------------------------</span>
  <span class="k">implicit none</span>
<span class="k">  </span><span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span><span class="kd">::</span>           <span class="n">NN</span>            <span class="c">!&lt; Number of nodes.</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span><span class="kd">::</span>           <span class="n">NC</span>            <span class="c">!&lt; Number of cells.</span>
  <span class="kt">real</span><span class="p">(</span><span class="n">R8P</span><span class="p">),</span>    <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span><span class="kd">::</span>           <span class="n">XYZ</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">,</span><span class="mi">1</span><span class="p">:</span><span class="n">NN</span><span class="p">)</span> <span class="c">!&lt; X, Y, Z coordinates (packed API).</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">),</span> <span class="k">optional</span><span class="kd">::</span> <span class="n">cf</span>            <span class="c">!&lt; Current file index (for concurrent files IO).</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">)</span><span class="kd">::</span>                       <span class="n">E_IO</span>          <span class="c">!&lt; Input/Output inquiring flag: $0$ if IO is done, $&gt; 0$ if IO is not done.</span>
  <span class="kt">character</span><span class="p">(</span><span class="nb">len</span><span class="o">=</span><span class="n">maxlen</span><span class="p">)</span><span class="kd">::</span>              <span class="n">s_buffer</span>      <span class="c">!&lt; Buffer string.</span>
  <span class="kt">real</span><span class="p">(</span><span class="n">R8P</span><span class="p">),</span> <span class="k">allocatable</span><span class="kd">::</span>             <span class="n">XYZa</span><span class="p">(:)</span>       <span class="c">!&lt; X, Y, Z coordinates.</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I1P</span><span class="p">),</span> <span class="k">allocatable</span><span class="kd">::</span>          <span class="n">XYZp</span><span class="p">(:)</span>       <span class="c">!&lt; Packed data.</span>
  <span class="kt">character</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="k">allocatable</span><span class="kd">::</span>          <span class="n">XYZ64</span><span class="p">(:)</span>      <span class="c">!&lt; X, Y, Z coordinates encoded in base64.</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">)</span><span class="kd">::</span>                       <span class="n">rf</span>            <span class="c">!&lt; Real file index.</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">)</span><span class="kd">::</span>                       <span class="n">n1</span>            <span class="c">!&lt; Counter.</span>
  <span class="c">!---------------------------------------------------------------------------------------------------------------------------------</span>

  <span class="c">!---------------------------------------------------------------------------------------------------------------------------------</span>
  <span class="n">E_IO</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1_I4P</span>
  <span class="n">rf</span> <span class="o">=</span> <span class="n">f</span>
  <span class="k">if</span> <span class="p">(</span><span class="nb">present</span><span class="p">(</span><span class="n">cf</span><span class="p">))</span> <span class="k">then</span>
<span class="k">    </span><span class="n">rf</span> <span class="o">=</span> <span class="n">cf</span> <span class="p">;</span> <span class="n">f</span> <span class="o">=</span> <span class="n">cf</span>
  <span class="n">endif</span>
  <span class="k">select case</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">f</span><span class="p">)</span>
  <span class="k">case</span><span class="p">(</span><span class="n">ascii</span><span class="p">)</span>
    <span class="n">s_buffer</span> <span class="o">=</span> <span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;Piece NumberOfPoints=&quot;&#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">NN</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39;&quot; NumberOfCells=&quot;&#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">NC</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39;&quot;&gt;&#39;</span>
    <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;(A)&#39;</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">trim</span><span class="p">(</span><span class="n">s_buffer</span><span class="p">)</span> <span class="p">;</span> <span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span> <span class="o">=</span> <span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span> <span class="o">+</span> <span class="mi">2</span>
    <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;(A)&#39;</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;Points&gt;&#39;</span> <span class="p">;</span> <span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span> <span class="o">=</span> <span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span> <span class="o">+</span> <span class="mi">2</span>
    <span class="n">s_buffer</span> <span class="o">=</span> <span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;DataArray type=&quot;Float64&quot; NumberOfComponents=&quot;3&quot; Name=&quot;Points&quot; format=&quot;ascii&quot;&gt;&#39;</span>
    <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;(A)&#39;</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">trim</span><span class="p">(</span><span class="n">s_buffer</span><span class="p">)</span>
    <span class="k">do </span><span class="n">n1</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">NN</span>
      <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;(A)&#39;</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="p">&amp;</span>
                                                 <span class="n">str</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">XYZ</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">n1</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39; &#39;</span><span class="o">//</span><span class="n">str</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">XYZ</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="n">n1</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39; &#39;</span><span class="o">//</span><span class="n">str</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">XYZ</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="n">n1</span><span class="p">))</span>
    <span class="n">enddo</span>
    <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;(A)&#39;</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;/DataArray&gt;&#39;</span> <span class="p">;</span> <span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span> <span class="o">=</span> <span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span> <span class="o">-</span> <span class="mi">2</span>
    <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;(A)&#39;</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;/Points&gt;&#39;</span>
  <span class="k">case</span><span class="p">(</span><span class="n">raw</span><span class="p">,</span><span class="n">bin_app</span><span class="p">)</span>
    <span class="n">s_buffer</span> <span class="o">=</span> <span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;Piece NumberOfPoints=&quot;&#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">NN</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39;&quot; NumberOfCells=&quot;&#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">NC</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39;&quot;&gt;&#39;</span>
    <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">trim</span><span class="p">(</span><span class="n">s_buffer</span><span class="p">)</span><span class="o">//</span><span class="n">end_rec</span> <span class="p">;</span> <span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span> <span class="o">=</span> <span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span> <span class="o">+</span> <span class="mi">2</span>
    <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;Points&gt;&#39;</span><span class="o">//</span><span class="n">end_rec</span> <span class="p">;</span> <span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span> <span class="o">=</span> <span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span> <span class="o">+</span> <span class="mi">2</span>
    <span class="n">s_buffer</span> <span class="o">=</span> <span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span>                                                                  <span class="p">&amp;</span>
               <span class="s1">&#39;&lt;DataArray type=&quot;Float64&quot; NumberOfComponents=&quot;3&quot; Name=&quot;Points&quot; format=&quot;appended&quot; offset=&quot;&#39;</span><span class="o">//</span> <span class="p">&amp;</span>
               <span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(.</span><span class="n">true</span><span class="p">.,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">ioffset</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39;&quot;/&gt;&#39;</span>
    <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">trim</span><span class="p">(</span><span class="n">s_buffer</span><span class="p">)</span><span class="o">//</span><span class="n">end_rec</span>
    <span class="k">call </span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">byte_update</span><span class="p">(</span><span class="n">N_Byte</span> <span class="o">=</span> <span class="mi">3</span><span class="o">*</span><span class="n">NN</span><span class="o">*</span><span class="n">BYR8P</span><span class="p">)</span>
    <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">ua</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">N_Byte</span><span class="p">,</span><span class="s1">&#39;R8&#39;</span><span class="p">,</span><span class="mi">3</span><span class="o">*</span><span class="n">NN</span>
    <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">ua</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="n">XYZ</span>
    <span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span> <span class="o">=</span> <span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span> <span class="o">-</span> <span class="mi">2</span> <span class="p">;</span> <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;/Points&gt;&#39;</span><span class="o">//</span><span class="n">end_rec</span>
  <span class="k">case</span><span class="p">(</span><span class="n">binary</span><span class="p">)</span>
    <span class="n">s_buffer</span> <span class="o">=</span> <span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;Piece NumberOfPoints=&quot;&#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">NN</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39;&quot; NumberOfCells=&quot;&#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">NC</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39;&quot;&gt;&#39;</span>
    <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">trim</span><span class="p">(</span><span class="n">s_buffer</span><span class="p">)</span><span class="o">//</span><span class="n">end_rec</span> <span class="p">;</span> <span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span> <span class="o">=</span> <span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span> <span class="o">+</span> <span class="mi">2</span>
    <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;Points&gt;&#39;</span><span class="o">//</span><span class="n">end_rec</span> <span class="p">;</span> <span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span> <span class="o">=</span> <span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span> <span class="o">+</span> <span class="mi">2</span>
    <span class="n">s_buffer</span> <span class="o">=</span> <span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;DataArray type=&quot;Float64&quot; NumberOfComponents=&quot;3&quot; Name=&quot;Points&quot; format=&quot;binary&quot;&gt;&#39;</span>
    <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">trim</span><span class="p">(</span><span class="n">s_buffer</span><span class="p">)</span><span class="o">//</span><span class="n">end_rec</span>
    <span class="k">allocate</span><span class="p">(</span><span class="n">XYZa</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="o">*</span><span class="n">NN</span><span class="p">))</span>
    <span class="k">do </span><span class="n">n1</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span><span class="n">NN</span>
      <span class="n">XYZa</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="p">(</span><span class="n">n1</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="mi">3</span><span class="p">:</span><span class="mi">1</span><span class="o">+</span><span class="p">(</span><span class="n">n1</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="mi">3</span><span class="o">+</span><span class="mi">2</span><span class="p">)</span><span class="o">=</span><span class="n">XYZ</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">,</span><span class="n">n1</span><span class="p">)</span>
    <span class="n">enddo</span>
    <span class="k">call </span><span class="n">pack_data</span><span class="p">(</span><span class="n">a1</span><span class="o">=</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="mi">3</span><span class="o">*</span><span class="n">NN</span><span class="o">*</span><span class="n">BYR8P</span><span class="p">,</span><span class="n">I4P</span><span class="p">)],</span><span class="n">a2</span><span class="o">=</span><span class="n">XYZa</span><span class="p">,</span><span class="n">packed</span><span class="o">=</span><span class="n">XYZp</span><span class="p">)</span> <span class="p">;</span> <span class="k">deallocate</span><span class="p">(</span><span class="n">XYZa</span><span class="p">)</span>
    <span class="k">call </span><span class="n">b64_encode</span><span class="p">(</span><span class="n">nB</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">BYI1P</span><span class="p">,</span><span class="n">I4P</span><span class="p">),</span><span class="n">n</span><span class="o">=</span><span class="n">XYZp</span><span class="p">,</span><span class="n">code</span><span class="o">=</span><span class="n">XYZ64</span><span class="p">)</span> <span class="p">;</span> <span class="k">deallocate</span><span class="p">(</span><span class="n">XYZp</span><span class="p">)</span>
    <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="o">+</span><span class="mi">2</span><span class="p">)</span><span class="o">//</span><span class="n">tochar</span><span class="p">(</span><span class="n">XYZ64</span><span class="p">)</span><span class="o">//</span><span class="n">end_rec</span> <span class="p">;</span> <span class="k">deallocate</span><span class="p">(</span><span class="n">XYZ64</span><span class="p">)</span>
    <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;/DataArray&gt;&#39;</span><span class="o">//</span><span class="n">end_rec</span>
    <span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span> <span class="o">=</span> <span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span> <span class="o">-</span> <span class="mi">2</span> <span class="p">;</span> <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;/Points&gt;&#39;</span><span class="o">//</span><span class="n">end_rec</span>
  <span class="n">endselect</span>
  <span class="k">return</span>
  <span class="c">!---------------------------------------------------------------------------------------------------------------------------------</span>
  <span class="n">endfunction</span> <span class="n">VTK_GEO_XML_UNST_PACK_R8</span>

  <span class="c">!&gt; Function for saving mesh with \b UnstructuredGrid topology (R4P).</span>
  <span class="c">!&gt; @return E_IO: integer(I4P) error flag</span>
  <span class="k">function </span><span class="n">VTK_GEO_XML_UNST_R4</span><span class="p">(</span><span class="n">NN</span><span class="p">,</span><span class="n">NC</span><span class="p">,</span><span class="n">X</span><span class="p">,</span><span class="n">Y</span><span class="p">,</span><span class="n">Z</span><span class="p">,</span><span class="n">cf</span><span class="p">)</span> <span class="k">result</span><span class="p">(</span><span class="n">E_IO</span><span class="p">)</span>
  <span class="c">!---------------------------------------------------------------------------------------------------------------------------------</span>
  <span class="k">implicit none</span>
<span class="k">  </span><span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span><span class="kd">::</span>           <span class="n">NN</span>       <span class="c">!&lt; Number of nodes.</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span><span class="kd">::</span>           <span class="n">NC</span>       <span class="c">!&lt; Number of cells.</span>
  <span class="kt">real</span><span class="p">(</span><span class="n">R4P</span><span class="p">),</span>    <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span><span class="kd">::</span>           <span class="n">X</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">NN</span><span class="p">)</span>  <span class="c">!&lt; X coordinates.</span>
  <span class="kt">real</span><span class="p">(</span><span class="n">R4P</span><span class="p">),</span>    <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span><span class="kd">::</span>           <span class="n">Y</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">NN</span><span class="p">)</span>  <span class="c">!&lt; Y coordinates.</span>
  <span class="kt">real</span><span class="p">(</span><span class="n">R4P</span><span class="p">),</span>    <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span><span class="kd">::</span>           <span class="n">Z</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">NN</span><span class="p">)</span>  <span class="c">!&lt; Z coordinates.</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">),</span> <span class="k">optional</span><span class="kd">::</span> <span class="n">cf</span>       <span class="c">!&lt; Current file index (for concurrent files IO).</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">)</span><span class="kd">::</span>                       <span class="n">E_IO</span>     <span class="c">!&lt; Input/Output inquiring flag: $0$ if IO is done, $&gt; 0$ if IO is not done.</span>
  <span class="kt">character</span><span class="p">(</span><span class="nb">len</span><span class="o">=</span><span class="n">maxlen</span><span class="p">)</span><span class="kd">::</span>              <span class="n">s_buffer</span> <span class="c">!&lt; Buffer string.</span>
  <span class="kt">real</span><span class="p">(</span><span class="n">R4P</span><span class="p">),</span> <span class="k">allocatable</span><span class="kd">::</span>             <span class="n">XYZa</span><span class="p">(:)</span>  <span class="c">!&lt; X, Y, Z coordinates.</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I1P</span><span class="p">),</span> <span class="k">allocatable</span><span class="kd">::</span>          <span class="n">XYZp</span><span class="p">(:)</span>  <span class="c">!&lt; Packed data.</span>
  <span class="kt">character</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="k">allocatable</span><span class="kd">::</span>          <span class="n">XYZ64</span><span class="p">(:)</span> <span class="c">!&lt; X, Y, Z coordinates encoded in base64.</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">)</span><span class="kd">::</span>                       <span class="n">rf</span>       <span class="c">!&lt; Real file index.</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">)</span><span class="kd">::</span>                       <span class="n">n1</span>       <span class="c">!&lt; Counter.</span>
  <span class="c">!---------------------------------------------------------------------------------------------------------------------------------</span>

  <span class="c">!---------------------------------------------------------------------------------------------------------------------------------</span>
  <span class="n">E_IO</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1_I4P</span>
  <span class="n">rf</span> <span class="o">=</span> <span class="n">f</span>
  <span class="k">if</span> <span class="p">(</span><span class="nb">present</span><span class="p">(</span><span class="n">cf</span><span class="p">))</span> <span class="k">then</span>
<span class="k">    </span><span class="n">rf</span> <span class="o">=</span> <span class="n">cf</span> <span class="p">;</span> <span class="n">f</span> <span class="o">=</span> <span class="n">cf</span>
  <span class="n">endif</span>
  <span class="k">select case</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">f</span><span class="p">)</span>
  <span class="k">case</span><span class="p">(</span><span class="n">ascii</span><span class="p">)</span>
    <span class="n">s_buffer</span> <span class="o">=</span> <span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;Piece NumberOfPoints=&quot;&#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">NN</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39;&quot; NumberOfCells=&quot;&#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">NC</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39;&quot;&gt;&#39;</span>
    <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;(A)&#39;</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">trim</span><span class="p">(</span><span class="n">s_buffer</span><span class="p">)</span> <span class="p">;</span> <span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span> <span class="o">=</span> <span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span> <span class="o">+</span> <span class="mi">2</span>
    <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;(A)&#39;</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;Points&gt;&#39;</span> <span class="p">;</span> <span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span> <span class="o">=</span> <span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span> <span class="o">+</span> <span class="mi">2</span>
    <span class="n">s_buffer</span> <span class="o">=</span> <span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;DataArray type=&quot;Float32&quot; NumberOfComponents=&quot;3&quot; Name=&quot;Points&quot; format=&quot;ascii&quot;&gt;&#39;</span>
    <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;(A)&#39;</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">trim</span><span class="p">(</span><span class="n">s_buffer</span><span class="p">)</span>
    <span class="k">do </span><span class="n">n1</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">NN</span>
      <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;(A)&#39;</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="n">str</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">X</span><span class="p">(</span><span class="n">n1</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39; &#39;</span><span class="o">//</span><span class="n">str</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">Y</span><span class="p">(</span><span class="n">n1</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39; &#39;</span><span class="o">//</span><span class="n">str</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">Z</span><span class="p">(</span><span class="n">n1</span><span class="p">))</span>
    <span class="n">enddo</span>
    <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;(A)&#39;</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;/DataArray&gt;&#39;</span> <span class="p">;</span> <span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span> <span class="o">=</span> <span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span> <span class="o">-</span> <span class="mi">2</span>
    <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;(A)&#39;</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;/Points&gt;&#39;</span>
  <span class="k">case</span><span class="p">(</span><span class="n">raw</span><span class="p">,</span><span class="n">bin_app</span><span class="p">)</span>
    <span class="n">s_buffer</span> <span class="o">=</span> <span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;Piece NumberOfPoints=&quot;&#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">NN</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39;&quot; NumberOfCells=&quot;&#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">NC</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39;&quot;&gt;&#39;</span>
    <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">trim</span><span class="p">(</span><span class="n">s_buffer</span><span class="p">)</span><span class="o">//</span><span class="n">end_rec</span> <span class="p">;</span> <span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span> <span class="o">=</span> <span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span> <span class="o">+</span> <span class="mi">2</span>
    <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;Points&gt;&#39;</span><span class="o">//</span><span class="n">end_rec</span> <span class="p">;</span> <span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span> <span class="o">=</span> <span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span> <span class="o">+</span> <span class="mi">2</span>
    <span class="n">s_buffer</span> <span class="o">=</span> <span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span>                                                                  <span class="p">&amp;</span>
               <span class="s1">&#39;&lt;DataArray type=&quot;Float32&quot; NumberOfComponents=&quot;3&quot; Name=&quot;Points&quot; format=&quot;appended&quot; offset=&quot;&#39;</span><span class="o">//</span> <span class="p">&amp;</span>
               <span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(.</span><span class="n">true</span><span class="p">.,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">ioffset</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39;&quot;/&gt;&#39;</span>
    <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">trim</span><span class="p">(</span><span class="n">s_buffer</span><span class="p">)</span><span class="o">//</span><span class="n">end_rec</span>
    <span class="k">call </span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">byte_update</span><span class="p">(</span><span class="n">N_Byte</span> <span class="o">=</span> <span class="mi">3</span><span class="o">*</span><span class="n">NN</span><span class="o">*</span><span class="n">BYR4P</span><span class="p">)</span>
    <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">ua</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">N_Byte</span><span class="p">,</span><span class="s1">&#39;R4&#39;</span><span class="p">,</span><span class="mi">3</span><span class="o">*</span><span class="n">NN</span>
    <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">ua</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)(</span><span class="n">X</span><span class="p">(</span><span class="n">n1</span><span class="p">),</span><span class="n">Y</span><span class="p">(</span><span class="n">n1</span><span class="p">),</span><span class="n">Z</span><span class="p">(</span><span class="n">n1</span><span class="p">),</span><span class="n">n1</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">NN</span><span class="p">)</span>
    <span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span> <span class="o">=</span> <span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span> <span class="o">-</span> <span class="mi">2</span> <span class="p">;</span> <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;/Points&gt;&#39;</span><span class="o">//</span><span class="n">end_rec</span>
  <span class="k">case</span><span class="p">(</span><span class="n">binary</span><span class="p">)</span>
    <span class="n">s_buffer</span> <span class="o">=</span> <span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;Piece NumberOfPoints=&quot;&#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">NN</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39;&quot; NumberOfCells=&quot;&#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">NC</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39;&quot;&gt;&#39;</span>
    <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">trim</span><span class="p">(</span><span class="n">s_buffer</span><span class="p">)</span><span class="o">//</span><span class="n">end_rec</span> <span class="p">;</span> <span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span> <span class="o">=</span> <span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span> <span class="o">+</span> <span class="mi">2</span>
    <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;Points&gt;&#39;</span><span class="o">//</span><span class="n">end_rec</span> <span class="p">;</span> <span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span> <span class="o">=</span> <span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span> <span class="o">+</span> <span class="mi">2</span>
    <span class="n">s_buffer</span> <span class="o">=</span> <span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;DataArray type=&quot;Float32&quot; NumberOfComponents=&quot;3&quot; Name=&quot;Points&quot; format=&quot;binary&quot;&gt;&#39;</span>
    <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">trim</span><span class="p">(</span><span class="n">s_buffer</span><span class="p">)</span><span class="o">//</span><span class="n">end_rec</span>
    <span class="k">allocate</span><span class="p">(</span><span class="n">XYZa</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="o">*</span><span class="n">NN</span><span class="p">))</span>
    <span class="k">do </span><span class="n">n1</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span><span class="n">NN</span>
      <span class="n">XYZa</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="p">(</span><span class="n">n1</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="mi">3</span><span class="p">:</span><span class="mi">1</span><span class="o">+</span><span class="p">(</span><span class="n">n1</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="mi">3</span><span class="o">+</span><span class="mi">2</span><span class="p">)</span><span class="o">=</span><span class="p">[</span><span class="n">X</span><span class="p">(</span><span class="n">n1</span><span class="p">),</span><span class="n">Y</span><span class="p">(</span><span class="n">n1</span><span class="p">),</span><span class="n">Z</span><span class="p">(</span><span class="n">n1</span><span class="p">)]</span>
    <span class="n">enddo</span>
    <span class="k">call </span><span class="n">pack_data</span><span class="p">(</span><span class="n">a1</span><span class="o">=</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="mi">3</span><span class="o">*</span><span class="n">NN</span><span class="o">*</span><span class="n">BYR4P</span><span class="p">,</span><span class="n">I4P</span><span class="p">)],</span><span class="n">a2</span><span class="o">=</span><span class="n">XYZa</span><span class="p">,</span><span class="n">packed</span><span class="o">=</span><span class="n">XYZp</span><span class="p">)</span> <span class="p">;</span> <span class="k">deallocate</span><span class="p">(</span><span class="n">XYZa</span><span class="p">)</span>
    <span class="k">call </span><span class="n">b64_encode</span><span class="p">(</span><span class="n">nB</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">BYI1P</span><span class="p">,</span><span class="n">I4P</span><span class="p">),</span><span class="n">n</span><span class="o">=</span><span class="n">XYZp</span><span class="p">,</span><span class="n">code</span><span class="o">=</span><span class="n">XYZ64</span><span class="p">)</span> <span class="p">;</span> <span class="k">deallocate</span><span class="p">(</span><span class="n">XYZp</span><span class="p">)</span>
    <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="o">+</span><span class="mi">2</span><span class="p">)</span><span class="o">//</span><span class="n">tochar</span><span class="p">(</span><span class="n">XYZ64</span><span class="p">)</span><span class="o">//</span><span class="n">end_rec</span> <span class="p">;</span> <span class="k">deallocate</span><span class="p">(</span><span class="n">XYZ64</span><span class="p">)</span>
    <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;/DataArray&gt;&#39;</span><span class="o">//</span><span class="n">end_rec</span>
    <span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span> <span class="o">=</span> <span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span> <span class="o">-</span> <span class="mi">2</span> <span class="p">;</span> <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;/Points&gt;&#39;</span><span class="o">//</span><span class="n">end_rec</span>
  <span class="n">endselect</span>
  <span class="k">return</span>
  <span class="c">!---------------------------------------------------------------------------------------------------------------------------------</span>
  <span class="n">endfunction</span> <span class="n">VTK_GEO_XML_UNST_R4</span>

  <span class="c">!&gt; Function for saving mesh with \b UnstructuredGrid topology (R4P, packed API).</span>
  <span class="c">!&gt; @return E_IO: integer(I4P) error flag</span>
  <span class="k">function </span><span class="n">VTK_GEO_XML_UNST_PACK_R4</span><span class="p">(</span><span class="n">NN</span><span class="p">,</span><span class="n">NC</span><span class="p">,</span><span class="n">XYZ</span><span class="p">,</span><span class="n">cf</span><span class="p">)</span> <span class="k">result</span><span class="p">(</span><span class="n">E_IO</span><span class="p">)</span>
  <span class="c">!---------------------------------------------------------------------------------------------------------------------------------</span>
  <span class="k">implicit none</span>
<span class="k">  </span><span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span><span class="kd">::</span>           <span class="n">NN</span>            <span class="c">!&lt; Number of nodes.</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span><span class="kd">::</span>           <span class="n">NC</span>            <span class="c">!&lt; Number of cells.</span>
  <span class="kt">real</span><span class="p">(</span><span class="n">R4P</span><span class="p">),</span>    <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span><span class="kd">::</span>           <span class="n">XYZ</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">,</span><span class="mi">1</span><span class="p">:</span><span class="n">NN</span><span class="p">)</span> <span class="c">!&lt; X, Y, Z coordinates (packed API).</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">),</span> <span class="k">optional</span><span class="kd">::</span> <span class="n">cf</span>            <span class="c">!&lt; Current file index (for concurrent files IO).</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">)</span><span class="kd">::</span>                       <span class="n">E_IO</span>          <span class="c">!&lt; Input/Output inquiring flag: $0$ if IO is done, $&gt; 0$ if IO is not done.</span>
  <span class="kt">character</span><span class="p">(</span><span class="nb">len</span><span class="o">=</span><span class="n">maxlen</span><span class="p">)</span><span class="kd">::</span>              <span class="n">s_buffer</span>      <span class="c">!&lt; Buffer string.</span>
  <span class="kt">real</span><span class="p">(</span><span class="n">R4P</span><span class="p">),</span> <span class="k">allocatable</span><span class="kd">::</span>             <span class="n">XYZa</span><span class="p">(:)</span>       <span class="c">!&lt; X, Y, Z coordinates.</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I1P</span><span class="p">),</span> <span class="k">allocatable</span><span class="kd">::</span>          <span class="n">XYZp</span><span class="p">(:)</span>       <span class="c">!&lt; Packed data.</span>
  <span class="kt">character</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="k">allocatable</span><span class="kd">::</span>          <span class="n">XYZ64</span><span class="p">(:)</span>      <span class="c">!&lt; X, Y, Z coordinates encoded in base64.</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">)</span><span class="kd">::</span>                       <span class="n">rf</span>            <span class="c">!&lt; Real file index.</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">)</span><span class="kd">::</span>                       <span class="n">n1</span>            <span class="c">!&lt; Counter.</span>
  <span class="c">!---------------------------------------------------------------------------------------------------------------------------------</span>

  <span class="c">!---------------------------------------------------------------------------------------------------------------------------------</span>
  <span class="n">E_IO</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1_I4P</span>
  <span class="n">rf</span> <span class="o">=</span> <span class="n">f</span>
  <span class="k">if</span> <span class="p">(</span><span class="nb">present</span><span class="p">(</span><span class="n">cf</span><span class="p">))</span> <span class="k">then</span>
<span class="k">    </span><span class="n">rf</span> <span class="o">=</span> <span class="n">cf</span> <span class="p">;</span> <span class="n">f</span> <span class="o">=</span> <span class="n">cf</span>
  <span class="n">endif</span>
  <span class="k">select case</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">f</span><span class="p">)</span>
  <span class="k">case</span><span class="p">(</span><span class="n">ascii</span><span class="p">)</span>
    <span class="n">s_buffer</span> <span class="o">=</span> <span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;Piece NumberOfPoints=&quot;&#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">NN</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39;&quot; NumberOfCells=&quot;&#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">NC</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39;&quot;&gt;&#39;</span>
    <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;(A)&#39;</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">trim</span><span class="p">(</span><span class="n">s_buffer</span><span class="p">)</span> <span class="p">;</span> <span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span> <span class="o">=</span> <span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span> <span class="o">+</span> <span class="mi">2</span>
    <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;(A)&#39;</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;Points&gt;&#39;</span> <span class="p">;</span> <span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span> <span class="o">=</span> <span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span> <span class="o">+</span> <span class="mi">2</span>
    <span class="n">s_buffer</span> <span class="o">=</span> <span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;DataArray type=&quot;Float32&quot; NumberOfComponents=&quot;3&quot; Name=&quot;Points&quot; format=&quot;ascii&quot;&gt;&#39;</span>
    <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;(A)&#39;</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">trim</span><span class="p">(</span><span class="n">s_buffer</span><span class="p">)</span>
    <span class="k">do </span><span class="n">n1</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">NN</span>
      <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;(A)&#39;</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="p">&amp;</span>
                                                 <span class="n">str</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">XYZ</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">n1</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39; &#39;</span><span class="o">//</span><span class="n">str</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">XYZ</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="n">n1</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39; &#39;</span><span class="o">//</span><span class="n">str</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">XYZ</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="n">n1</span><span class="p">))</span>
    <span class="n">enddo</span>
    <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;(A)&#39;</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;/DataArray&gt;&#39;</span> <span class="p">;</span> <span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span> <span class="o">=</span> <span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span> <span class="o">-</span> <span class="mi">2</span>
    <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;(A)&#39;</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;/Points&gt;&#39;</span>
  <span class="k">case</span><span class="p">(</span><span class="n">raw</span><span class="p">,</span><span class="n">bin_app</span><span class="p">)</span>
    <span class="n">s_buffer</span> <span class="o">=</span> <span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;Piece NumberOfPoints=&quot;&#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">NN</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39;&quot; NumberOfCells=&quot;&#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">NC</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39;&quot;&gt;&#39;</span>
    <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">trim</span><span class="p">(</span><span class="n">s_buffer</span><span class="p">)</span><span class="o">//</span><span class="n">end_rec</span> <span class="p">;</span> <span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span> <span class="o">=</span> <span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span> <span class="o">+</span> <span class="mi">2</span>
    <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;Points&gt;&#39;</span><span class="o">//</span><span class="n">end_rec</span> <span class="p">;</span> <span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span> <span class="o">=</span> <span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span> <span class="o">+</span> <span class="mi">2</span>
    <span class="n">s_buffer</span> <span class="o">=</span> <span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span>                                                                  <span class="p">&amp;</span>
               <span class="s1">&#39;&lt;DataArray type=&quot;Float32&quot; NumberOfComponents=&quot;3&quot; Name=&quot;Points&quot; format=&quot;appended&quot; offset=&quot;&#39;</span><span class="o">//</span> <span class="p">&amp;</span>
               <span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(.</span><span class="n">true</span><span class="p">.,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">ioffset</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39;&quot;/&gt;&#39;</span>
    <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">trim</span><span class="p">(</span><span class="n">s_buffer</span><span class="p">)</span><span class="o">//</span><span class="n">end_rec</span>
    <span class="k">call </span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">byte_update</span><span class="p">(</span><span class="n">N_Byte</span> <span class="o">=</span> <span class="mi">3</span><span class="o">*</span><span class="n">NN</span><span class="o">*</span><span class="n">BYR4P</span><span class="p">)</span>
    <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">ua</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">N_Byte</span><span class="p">,</span><span class="s1">&#39;R4&#39;</span><span class="p">,</span><span class="mi">3</span><span class="o">*</span><span class="n">NN</span>
    <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">ua</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="n">XYZ</span>
    <span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span> <span class="o">=</span> <span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span> <span class="o">-</span> <span class="mi">2</span> <span class="p">;</span> <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;/Points&gt;&#39;</span><span class="o">//</span><span class="n">end_rec</span>
  <span class="k">case</span><span class="p">(</span><span class="n">binary</span><span class="p">)</span>
    <span class="n">s_buffer</span> <span class="o">=</span> <span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;Piece NumberOfPoints=&quot;&#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">NN</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39;&quot; NumberOfCells=&quot;&#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">NC</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39;&quot;&gt;&#39;</span>
    <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">trim</span><span class="p">(</span><span class="n">s_buffer</span><span class="p">)</span><span class="o">//</span><span class="n">end_rec</span> <span class="p">;</span> <span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span> <span class="o">=</span> <span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span> <span class="o">+</span> <span class="mi">2</span>
    <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;Points&gt;&#39;</span><span class="o">//</span><span class="n">end_rec</span> <span class="p">;</span> <span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span> <span class="o">=</span> <span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span> <span class="o">+</span> <span class="mi">2</span>
    <span class="n">s_buffer</span> <span class="o">=</span> <span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;DataArray type=&quot;Float32&quot; NumberOfComponents=&quot;3&quot; Name=&quot;Points&quot; format=&quot;binary&quot;&gt;&#39;</span>
    <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">trim</span><span class="p">(</span><span class="n">s_buffer</span><span class="p">)</span><span class="o">//</span><span class="n">end_rec</span>
    <span class="k">allocate</span><span class="p">(</span><span class="n">XYZa</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="o">*</span><span class="n">NN</span><span class="p">))</span>
    <span class="k">do </span><span class="n">n1</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span><span class="n">NN</span>
      <span class="n">XYZa</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="p">(</span><span class="n">n1</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="mi">3</span><span class="p">:</span><span class="mi">1</span><span class="o">+</span><span class="p">(</span><span class="n">n1</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="mi">3</span><span class="o">+</span><span class="mi">2</span><span class="p">)</span><span class="o">=</span><span class="n">XYZ</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">,</span><span class="n">n1</span><span class="p">)</span>
    <span class="n">enddo</span>
    <span class="k">call </span><span class="n">pack_data</span><span class="p">(</span><span class="n">a1</span><span class="o">=</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="mi">3</span><span class="o">*</span><span class="n">NN</span><span class="o">*</span><span class="n">BYR4P</span><span class="p">,</span><span class="n">I4P</span><span class="p">)],</span><span class="n">a2</span><span class="o">=</span><span class="n">XYZa</span><span class="p">,</span><span class="n">packed</span><span class="o">=</span><span class="n">XYZp</span><span class="p">)</span> <span class="p">;</span> <span class="k">deallocate</span><span class="p">(</span><span class="n">XYZa</span><span class="p">)</span>
    <span class="k">call </span><span class="n">b64_encode</span><span class="p">(</span><span class="n">nB</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">BYI1P</span><span class="p">,</span><span class="n">I4P</span><span class="p">),</span><span class="n">n</span><span class="o">=</span><span class="n">XYZp</span><span class="p">,</span><span class="n">code</span><span class="o">=</span><span class="n">XYZ64</span><span class="p">)</span> <span class="p">;</span> <span class="k">deallocate</span><span class="p">(</span><span class="n">XYZp</span><span class="p">)</span>
    <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="o">+</span><span class="mi">2</span><span class="p">)</span><span class="o">//</span><span class="n">tochar</span><span class="p">(</span><span class="n">XYZ64</span><span class="p">)</span><span class="o">//</span><span class="n">end_rec</span> <span class="p">;</span> <span class="k">deallocate</span><span class="p">(</span><span class="n">XYZ64</span><span class="p">)</span>
    <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;/DataArray&gt;&#39;</span><span class="o">//</span><span class="n">end_rec</span>
    <span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span> <span class="o">=</span> <span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span> <span class="o">-</span> <span class="mi">2</span> <span class="p">;</span> <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;/Points&gt;&#39;</span><span class="o">//</span><span class="n">end_rec</span>
  <span class="n">endselect</span>
  <span class="k">return</span>
  <span class="c">!---------------------------------------------------------------------------------------------------------------------------------</span>
  <span class="n">endfunction</span> <span class="n">VTK_GEO_XML_UNST_PACK_R4</span>

  <span class="c">!&gt; @brief Function for closing mesh block data.</span>
  <span class="c">!&gt; @return E_IO: integer(I4P) error flag</span>
  <span class="k">function </span><span class="n">VTK_GEO_XML_CLOSEP</span><span class="p">(</span><span class="n">cf</span><span class="p">)</span> <span class="k">result</span><span class="p">(</span><span class="n">E_IO</span><span class="p">)</span>
  <span class="c">!---------------------------------------------------------------------------------------------------------------------------------</span>
  <span class="k">implicit none</span>
<span class="k">  </span><span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">),</span> <span class="k">optional</span><span class="kd">::</span> <span class="n">cf</span>   <span class="c">!&lt; Current file index (for concurrent files IO).</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">)</span><span class="kd">::</span>                       <span class="n">E_IO</span> <span class="c">!&lt; Input/Output inquiring flag: $0$ if IO is done, $&gt; 0$ if IO is not done.</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">)</span><span class="kd">::</span>                       <span class="n">rf</span>   <span class="c">!&lt; Real file index.</span>
  <span class="c">!---------------------------------------------------------------------------------------------------------------------------------</span>

  <span class="c">!---------------------------------------------------------------------------------------------------------------------------------</span>
  <span class="n">E_IO</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1_I4P</span>
  <span class="n">rf</span> <span class="o">=</span> <span class="n">f</span>
  <span class="k">if</span> <span class="p">(</span><span class="nb">present</span><span class="p">(</span><span class="n">cf</span><span class="p">))</span> <span class="k">then</span>
<span class="k">    </span><span class="n">rf</span> <span class="o">=</span> <span class="n">cf</span> <span class="p">;</span> <span class="n">f</span> <span class="o">=</span> <span class="n">cf</span>
  <span class="n">endif</span>
  <span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span> <span class="o">=</span> <span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span> <span class="o">-</span> <span class="mi">2</span>
  <span class="k">select case</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">f</span><span class="p">)</span>
  <span class="k">case</span><span class="p">(</span><span class="n">ascii</span><span class="p">)</span>
    <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;(A)&#39;</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;/Piece&gt;&#39;</span>
  <span class="k">case</span><span class="p">(</span><span class="n">raw</span><span class="p">,</span><span class="n">binary</span><span class="p">,</span><span class="n">bin_app</span><span class="p">)</span>
    <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;/Piece&gt;&#39;</span><span class="o">//</span><span class="n">end_rec</span>
  <span class="n">endselect</span>
  <span class="k">return</span>
  <span class="c">!---------------------------------------------------------------------------------------------------------------------------------</span>
  <span class="n">endfunction</span> <span class="n">VTK_GEO_XML_CLOSEP</span>
  <span class="c">!&gt; @}</span>

  <span class="c">!&gt; Function that \b must be used when unstructured grid is used, it saves the connectivity of the unstructured gird.</span>
  <span class="c">!&gt; @note The vector \b connect must follow the VTK-legacy standard. It is passed as \em assumed-shape array</span>
  <span class="c">!&gt; because its dimensions is related to the mesh dimensions in a complex way. Its dimensions can be calculated by the following</span>
  <span class="c">!&gt; equation: \f$dc = dc = \sum\limits_{i = 1}^{NC} {nvertex_i }\f$.</span>
  <span class="c">!&gt; Note that this equation is different from the legacy one. The XML connectivity convention is quite different from the</span>
  <span class="c">!&gt; legacy standard. As an example suppose we have a mesh composed by 2 cells, one hexahedron (8 vertices) and one pyramid with</span>
  <span class="c">!&gt; square basis (5 vertices) and suppose that the basis of pyramid is constitute by a face of the hexahedron and so the two cells</span>
  <span class="c">!&gt; share 4 vertices. The above equation gives \f$dc=8+5=13\f$. The connectivity vector for this mesh can be: \n</span>
  <span class="c">!&gt; first cell \n</span>
  <span class="c">!&gt; connect(1)  = 0 identification flag of \f$1^\circ\f$ vertex of 1° cell \n</span>
  <span class="c">!&gt; connect(2)  = 1 identification flag of \f$2^\circ\f$ vertex of 1° cell \n</span>
  <span class="c">!&gt; connect(3)  = 2 identification flag of \f$3^\circ\f$ vertex of 1° cell \n</span>
  <span class="c">!&gt; connect(4)  = 3 identification flag of \f$4^\circ\f$ vertex of 1° cell \n</span>
  <span class="c">!&gt; connect(5)  = 4 identification flag of \f$5^\circ\f$ vertex of 1° cell \n</span>
  <span class="c">!&gt; connect(6)  = 5 identification flag of \f$6^\circ\f$ vertex of 1° cell \n</span>
  <span class="c">!&gt; connect(7)  = 6 identification flag of \f$7^\circ\f$ vertex of 1° cell \n</span>
  <span class="c">!&gt; connect(8)  = 7 identification flag of \f$8^\circ\f$ vertex of 1° cell \n</span>
  <span class="c">!&gt; second cell \n</span>
  <span class="c">!&gt; connect(9 ) = 0 identification flag of \f$1^\circ\f$ vertex of 2° cell \n</span>
  <span class="c">!&gt; connect(10) = 1 identification flag of \f$2^\circ\f$ vertex of 2° cell \n</span>
  <span class="c">!&gt; connect(11) = 2 identification flag of \f$3^\circ\f$ vertex of 2° cell \n</span>
  <span class="c">!&gt; connect(12) = 3 identification flag of \f$4^\circ\f$ vertex of 2° cell \n</span>
  <span class="c">!&gt; connect(13) = 8 identification flag of \f$5^\circ\f$ vertex of 2° cell \n</span>
  <span class="c">!&gt; Therefore this connectivity vector convention is more simple than the legacy convention, now we must create also the</span>
  <span class="c">!&gt; \em offset vector that contains the data now missing in the \em connect vector. The offset</span>
  <span class="c">!&gt; vector for this mesh can be: \n</span>
  <span class="c">!&gt; first cell \n</span>
  <span class="c">!&gt; offset(1) = 8  =&gt; summ of nodes of \f$1^\circ\f$ cell \n</span>
  <span class="c">!&gt; second cell \n</span>
  <span class="c">!&gt; offset(2) = 13 =&gt; summ of nodes of \f$1^\circ\f$ and \f$2^\circ\f$ cells \n</span>
  <span class="c">!&gt; The value of every cell-offset can be calculated by the following equation: \f$offset_c=\sum\limits_{i=1}^{c}{nvertex_i}\f$</span>
  <span class="c">!&gt; where \f$offset_c\f$ is the value of \f$c^{th}\f$ cell and \f$nvertex_i\f$ is the number of vertices of \f$i^{th}\f$ cell.</span>
  <span class="c">!&gt; The function VTK_CON_XML does not calculate the connectivity and offset vectors: it writes the connectivity and offset</span>
  <span class="c">!&gt; vectors conforming the VTK-XML standard, but does not calculate them.</span>
  <span class="c">!&gt; The vector variable \em cell_type must conform the VTK-XML standard (see the file VTK-Standard at the</span>
  <span class="c">!&gt; Kitware homepage) that is the same of the legacy standard. It contains the</span>
  <span class="c">!&gt; \em type of each cells. For the above example this vector is: \n</span>
  <span class="c">!&gt; first cell \n</span>
  <span class="c">!&gt; cell_type(1) = 12 hexahedron type of \f$1^\circ\f$ cell \n</span>
  <span class="c">!&gt; second cell \n</span>
  <span class="c">!&gt; cell_type(2) = 14 pyramid type of \f$2^\circ\f$ cell \n</span>
  <span class="c">!&gt; @return E_IO: integer(I4P) error flag</span>
  <span class="k">function </span><span class="n">VTK_CON_XML</span><span class="p">(</span><span class="n">NC</span><span class="p">,</span><span class="n">connect</span><span class="p">,</span><span class="n">offset</span><span class="p">,</span><span class="n">cell_type</span><span class="p">,</span><span class="n">idx</span><span class="p">,</span><span class="n">cf</span><span class="p">)</span> <span class="k">result</span><span class="p">(</span><span class="n">E_IO</span><span class="p">)</span>
  <span class="c">!---------------------------------------------------------------------------------------------------------------------------------</span>
  <span class="k">implicit none</span>
<span class="k">  </span><span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span><span class="kd">::</span>           <span class="n">NC</span>            <span class="c">!&lt; Number of cells.</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span><span class="kd">::</span>           <span class="n">connect</span><span class="p">(</span><span class="mi">1</span><span class="p">:)</span>   <span class="c">!&lt; Mesh connectivity.</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span><span class="kd">::</span>           <span class="n">offset</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">NC</span><span class="p">)</span>  <span class="c">!&lt; Cell offset.</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I1P</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span><span class="kd">::</span>           <span class="n">cell_type</span><span class="p">(</span><span class="mi">1</span><span class="p">:)</span> <span class="c">!&lt; VTK cell type.</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I1P</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">),</span> <span class="k">optional</span><span class="kd">::</span> <span class="n">idx</span>           <span class="c">!&lt; Id offset to convert Fortran (first id 1) to C (first id 0) standards.</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">),</span> <span class="k">optional</span><span class="kd">::</span> <span class="n">cf</span>            <span class="c">!&lt; Current file index (for concurrent files IO).</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">)</span><span class="kd">::</span>                       <span class="n">E_IO</span>          <span class="c">!&lt; Input/Output inquiring flag: $0$ if IO is done, $&gt; 0$ if IO is not done.</span>
  <span class="kt">character</span><span class="p">(</span><span class="nb">len</span><span class="o">=</span><span class="n">maxlen</span><span class="p">)</span><span class="kd">::</span>              <span class="n">s_buffer</span>      <span class="c">!&lt; Buffer string.</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I1P</span><span class="p">),</span> <span class="k">allocatable</span><span class="kd">::</span>          <span class="n">cocp</span><span class="p">(:)</span>       <span class="c">!&lt; Packed data.</span>
  <span class="kt">character</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="k">allocatable</span><span class="kd">::</span>          <span class="n">coc64</span><span class="p">(:)</span>      <span class="c">!&lt; Data encoded in base64.</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I1P</span><span class="p">)</span><span class="kd">::</span>                       <span class="n">incr</span>          <span class="c">!&lt; Actual id offset increment.</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">)</span><span class="kd">::</span>                       <span class="n">rf</span>            <span class="c">!&lt; Real file index.</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">)</span><span class="kd">::</span>                       <span class="n">n1</span>            <span class="c">!&lt; Counter.</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I8P</span><span class="p">)</span><span class="kd">::</span>                       <span class="n">Ncocp</span>         <span class="c">!&lt; Dimension of cocp, packed data.</span>
  <span class="c">!---------------------------------------------------------------------------------------------------------------------------------</span>

  <span class="c">!---------------------------------------------------------------------------------------------------------------------------------</span>
  <span class="n">E_IO</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1_I4P</span>
  <span class="n">rf</span> <span class="o">=</span> <span class="n">f</span>
  <span class="k">if</span> <span class="p">(</span><span class="nb">present</span><span class="p">(</span><span class="n">cf</span><span class="p">))</span> <span class="k">then</span>
<span class="k">    </span><span class="n">rf</span> <span class="o">=</span> <span class="n">cf</span> <span class="p">;</span> <span class="n">f</span> <span class="o">=</span> <span class="n">cf</span>
  <span class="n">endif</span>
  <span class="n">incr</span> <span class="o">=</span> <span class="mi">0_I1P</span>
  <span class="k">if</span> <span class="p">(</span><span class="nb">present</span><span class="p">(</span><span class="n">idx</span><span class="p">))</span> <span class="k">then</span>
<span class="k">    </span><span class="n">incr</span> <span class="o">=</span> <span class="n">idx</span>
  <span class="n">endif</span>
  <span class="k">select case</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">f</span><span class="p">)</span>
  <span class="k">case</span><span class="p">(</span><span class="n">ascii</span><span class="p">)</span>
    <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;(A)&#39;</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;Cells&gt;&#39;</span> <span class="p">;</span> <span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span> <span class="o">=</span> <span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span> <span class="o">+</span> <span class="mi">2</span>
    <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;(A)&#39;</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="p">&amp;</span>
                                               <span class="s1">&#39;&lt;DataArray type=&quot;Int32&quot; Name=&quot;connectivity&quot; format=&quot;ascii&quot;&gt;&#39;</span>
    <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">fmt</span><span class="o">=</span><span class="n">FI4P</span><span class="p">,</span> <span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)(</span><span class="n">connect</span><span class="p">(</span><span class="n">n1</span><span class="p">)</span><span class="o">+</span><span class="n">incr</span><span class="p">,</span><span class="n">n1</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">offset</span><span class="p">(</span><span class="n">NC</span><span class="p">))</span>
    <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;(A)&#39;</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;/DataArray&gt;&#39;</span>
    <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;(A)&#39;</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;DataArray type=&quot;Int32&quot; Name=&quot;offsets&quot; format=&quot;ascii&quot;&gt;&#39;</span>
    <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">fmt</span><span class="o">=</span><span class="n">FI4P</span><span class="p">,</span> <span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)(</span><span class="n">offset</span><span class="p">(</span><span class="n">n1</span><span class="p">),</span><span class="n">n1</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">NC</span><span class="p">)</span>
    <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;(A)&#39;</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;/DataArray&gt;&#39;</span>
    <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;(A)&#39;</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;DataArray type=&quot;Int8&quot; Name=&quot;types&quot; format=&quot;ascii&quot;&gt;&#39;</span>
    <span class="k">if</span> <span class="p">(</span><span class="nb">lbound</span><span class="p">(</span><span class="n">cell_type</span><span class="p">,</span><span class="nb">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">==</span><span class="nb">ubound</span><span class="p">(</span><span class="n">cell_type</span><span class="p">,</span><span class="nb">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span> <span class="k">then</span>
<span class="k">      write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">fmt</span><span class="o">=</span><span class="n">FI1P</span><span class="p">,</span> <span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)(</span><span class="n">cell_type</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span><span class="n">n1</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">NC</span><span class="p">)</span>
    <span class="k">else</span>
<span class="k">      write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">fmt</span><span class="o">=</span><span class="n">FI1P</span><span class="p">,</span> <span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)(</span><span class="n">cell_type</span><span class="p">(</span><span class="n">n1</span><span class="p">),</span><span class="n">n1</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">NC</span><span class="p">)</span>
    <span class="n">endif</span>
    <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;(A)&#39;</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;/DataArray&gt;&#39;</span> <span class="p">;</span> <span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span> <span class="o">=</span> <span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span> <span class="o">-</span> <span class="mi">2</span>
    <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;(A)&#39;</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;/Cells&gt;&#39;</span>
  <span class="k">case</span><span class="p">(</span><span class="n">raw</span><span class="p">,</span><span class="n">bin_app</span><span class="p">)</span>
    <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;Cells&gt;&#39;</span><span class="o">//</span><span class="n">end_rec</span> <span class="p">;</span> <span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span> <span class="o">=</span> <span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span> <span class="o">+</span> <span class="mi">2</span>
    <span class="n">s_buffer</span> <span class="o">=</span> <span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;DataArray type=&quot;Int32&quot; Name=&quot;connectivity&quot; format=&quot;appended&quot; offset=&quot;&#39;</span><span class="o">//</span> <span class="p">&amp;</span>
               <span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(.</span><span class="n">true</span><span class="p">.,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">ioffset</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39;&quot;/&gt;&#39;</span>
    <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">trim</span><span class="p">(</span><span class="n">s_buffer</span><span class="p">)</span><span class="o">//</span><span class="n">end_rec</span>
    <span class="k">call </span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">byte_update</span><span class="p">(</span><span class="n">N_Byte</span> <span class="o">=</span> <span class="n">offset</span><span class="p">(</span><span class="n">NC</span><span class="p">)</span><span class="o">*</span><span class="n">BYI4P</span><span class="p">)</span>
    <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">ua</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">N_Byte</span><span class="p">,</span><span class="s1">&#39;I4&#39;</span><span class="p">,</span><span class="n">offset</span><span class="p">(</span><span class="n">NC</span><span class="p">)</span>
    <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">ua</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)(</span><span class="n">connect</span><span class="p">(</span><span class="n">n1</span><span class="p">)</span><span class="o">+</span><span class="n">incr</span><span class="p">,</span><span class="n">n1</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">offset</span><span class="p">(</span><span class="n">NC</span><span class="p">))</span>
    <span class="n">s_buffer</span> <span class="o">=</span> <span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;DataArray type=&quot;Int32&quot; Name=&quot;offsets&quot; format=&quot;appended&quot; offset=&quot;&#39;</span><span class="o">//</span> <span class="p">&amp;</span>
               <span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(.</span><span class="n">true</span><span class="p">.,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">ioffset</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39;&quot;/&gt;&#39;</span>
    <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">trim</span><span class="p">(</span><span class="n">s_buffer</span><span class="p">)</span><span class="o">//</span><span class="n">end_rec</span>
    <span class="k">call </span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">byte_update</span><span class="p">(</span><span class="n">N_Byte</span> <span class="o">=</span> <span class="n">NC</span><span class="o">*</span><span class="n">BYI4P</span><span class="p">)</span>
    <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">ua</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">N_Byte</span><span class="p">,</span><span class="s1">&#39;I4&#39;</span><span class="p">,</span><span class="n">NC</span>
    <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">ua</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)(</span><span class="n">offset</span><span class="p">(</span><span class="n">n1</span><span class="p">),</span><span class="n">n1</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">NC</span><span class="p">)</span>
    <span class="n">s_buffer</span> <span class="o">=</span> <span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;DataArray type=&quot;Int8&quot; Name=&quot;types&quot; format=&quot;appended&quot; offset=&quot;&#39;</span><span class="o">//</span> <span class="p">&amp;</span>
               <span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(.</span><span class="n">true</span><span class="p">.,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">ioffset</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39;&quot;/&gt;&#39;</span>
    <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">trim</span><span class="p">(</span><span class="n">s_buffer</span><span class="p">)</span><span class="o">//</span><span class="n">end_rec</span>
    <span class="k">call </span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">byte_update</span><span class="p">(</span><span class="n">N_Byte</span> <span class="o">=</span> <span class="n">NC</span><span class="o">*</span><span class="n">BYI1P</span><span class="p">)</span>
    <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">ua</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">N_Byte</span><span class="p">,</span><span class="s1">&#39;I1&#39;</span><span class="p">,</span><span class="n">NC</span>
    <span class="k">if</span> <span class="p">(</span><span class="nb">lbound</span><span class="p">(</span><span class="n">cell_type</span><span class="p">,</span><span class="nb">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">==</span><span class="nb">ubound</span><span class="p">(</span><span class="n">cell_type</span><span class="p">,</span><span class="nb">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span> <span class="k">then</span>
<span class="k">      write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">ua</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)(</span><span class="n">cell_type</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span><span class="n">n1</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">NC</span><span class="p">)</span>
    <span class="k">else</span>
<span class="k">      write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">ua</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)(</span><span class="n">cell_type</span><span class="p">(</span><span class="n">n1</span><span class="p">),</span><span class="n">n1</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">NC</span><span class="p">)</span>
    <span class="n">endif</span>
    <span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span> <span class="o">=</span> <span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span> <span class="o">-</span> <span class="mi">2</span> <span class="p">;</span> <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;/Cells&gt;&#39;</span><span class="o">//</span><span class="n">end_rec</span>
  <span class="k">case</span><span class="p">(</span><span class="n">binary</span><span class="p">)</span>
    <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;Cells&gt;&#39;</span><span class="o">//</span><span class="n">end_rec</span> <span class="p">;</span> <span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span> <span class="o">=</span> <span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span> <span class="o">+</span> <span class="mi">2</span>
    <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="p">&amp;</span>
                                     <span class="s1">&#39;&lt;DataArray type=&quot;Int32&quot; Name=&quot;connectivity&quot; format=&quot;binary&quot;&gt;&#39;</span><span class="o">//</span><span class="n">end_rec</span>
    <span class="n">Ncocp</span><span class="o">=</span><span class="n">size</span><span class="p">(</span><span class="nb">transfer</span><span class="p">([</span><span class="nb">int</span><span class="p">(</span><span class="n">offset</span><span class="p">(</span><span class="n">NC</span><span class="p">)</span><span class="o">*</span><span class="n">BYI4P</span><span class="p">,</span><span class="n">I4P</span><span class="p">),</span><span class="n">connect</span><span class="p">],</span><span class="n">cocp</span><span class="p">),</span><span class="nb">kind</span><span class="o">=</span><span class="n">I8P</span><span class="p">)</span>
    <span class="k">if</span> <span class="p">(</span><span class="nb">allocated</span><span class="p">(</span><span class="n">cocp</span><span class="p">))</span> <span class="k">deallocate</span><span class="p">(</span><span class="n">cocp</span><span class="p">)</span> <span class="p">;</span> <span class="k">allocate</span><span class="p">(</span><span class="n">cocp</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">Ncocp</span><span class="p">))</span>
    <span class="n">cocp</span> <span class="o">=</span> <span class="nb">transfer</span><span class="p">([</span><span class="nb">int</span><span class="p">(</span><span class="n">offset</span><span class="p">(</span><span class="n">NC</span><span class="p">)</span><span class="o">*</span><span class="n">BYI4P</span><span class="p">,</span><span class="n">I4P</span><span class="p">),</span><span class="n">connect</span><span class="p">],</span><span class="n">cocp</span><span class="p">)</span>
    <span class="k">call </span><span class="n">b64_encode</span><span class="p">(</span><span class="n">nB</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">BYI1P</span><span class="p">,</span><span class="n">I4P</span><span class="p">),</span><span class="n">n</span><span class="o">=</span><span class="n">cocp</span><span class="p">,</span><span class="n">code</span><span class="o">=</span><span class="n">coc64</span><span class="p">)</span>
    <span class="k">deallocate</span><span class="p">(</span><span class="n">cocp</span><span class="p">)</span>
    <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="o">+</span><span class="mi">2</span><span class="p">)</span><span class="o">//</span><span class="n">tochar</span><span class="p">(</span><span class="n">coc64</span><span class="p">)</span><span class="o">//</span><span class="n">end_rec</span>
    <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;/DataArray&gt;&#39;</span><span class="o">//</span><span class="n">end_rec</span>
    <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;DataArray type=&quot;Int32&quot; Name=&quot;offsets&quot; format=&quot;binary&quot;&gt;&#39;</span><span class="o">//</span><span class="n">end_rec</span>
    <span class="n">Ncocp</span><span class="o">=</span><span class="n">size</span><span class="p">(</span><span class="nb">transfer</span><span class="p">([</span><span class="nb">int</span><span class="p">(</span><span class="n">NC</span><span class="o">*</span><span class="n">BYI4P</span><span class="p">,</span><span class="n">I4P</span><span class="p">),</span><span class="n">offset</span><span class="p">],</span><span class="n">cocp</span><span class="p">),</span><span class="nb">kind</span><span class="o">=</span><span class="n">I8P</span><span class="p">)</span> <span class="p">;</span> <span class="k">if</span> <span class="p">(</span><span class="nb">allocated</span><span class="p">(</span><span class="n">cocp</span><span class="p">))</span> <span class="k">deallocate</span><span class="p">(</span><span class="n">cocp</span><span class="p">)</span> <span class="p">;</span> <span class="k">allocate</span><span class="p">(</span><span class="n">cocp</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">Ncocp</span><span class="p">))</span>
    <span class="n">cocp</span> <span class="o">=</span> <span class="nb">transfer</span><span class="p">([</span><span class="nb">int</span><span class="p">(</span><span class="n">NC</span><span class="o">*</span><span class="n">BYI4P</span><span class="p">,</span><span class="n">I4P</span><span class="p">),</span><span class="n">offset</span><span class="p">],</span><span class="n">cocp</span><span class="p">)</span>
    <span class="k">call </span><span class="n">b64_encode</span><span class="p">(</span><span class="n">nB</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">BYI1P</span><span class="p">,</span><span class="n">I4P</span><span class="p">),</span><span class="n">n</span><span class="o">=</span><span class="n">cocp</span><span class="p">,</span><span class="n">code</span><span class="o">=</span><span class="n">coc64</span><span class="p">)</span>
    <span class="k">deallocate</span><span class="p">(</span><span class="n">cocp</span><span class="p">)</span>
    <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="o">+</span><span class="mi">2</span><span class="p">)</span><span class="o">//</span><span class="n">tochar</span><span class="p">(</span><span class="n">coc64</span><span class="p">)</span><span class="o">//</span><span class="n">end_rec</span>
    <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;/DataArray&gt;&#39;</span><span class="o">//</span><span class="n">end_rec</span>
    <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;DataArray type=&quot;Int8&quot; Name=&quot;types&quot; format=&quot;binary&quot;&gt;&#39;</span><span class="o">//</span><span class="n">end_rec</span>
    <span class="k">if</span> <span class="p">(</span><span class="nb">lbound</span><span class="p">(</span><span class="n">cell_type</span><span class="p">,</span><span class="nb">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">==</span><span class="nb">ubound</span><span class="p">(</span><span class="n">cell_type</span><span class="p">,</span><span class="nb">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span> <span class="k">then</span>
<span class="k">      call </span><span class="n">pack_data</span><span class="p">(</span><span class="n">a1</span><span class="o">=</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">NC</span><span class="o">*</span><span class="n">BYI1P</span><span class="p">,</span><span class="n">I4P</span><span class="p">)],</span><span class="n">a2</span><span class="o">=</span><span class="p">[(</span><span class="n">cell_type</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span><span class="n">n1</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">NC</span><span class="p">)],</span><span class="n">packed</span><span class="o">=</span><span class="n">cocp</span><span class="p">)</span>
    <span class="k">else</span>
<span class="k">      call </span><span class="n">pack_data</span><span class="p">(</span><span class="n">a1</span><span class="o">=</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">NC</span><span class="o">*</span><span class="n">BYI1P</span><span class="p">,</span><span class="n">I4P</span><span class="p">)],</span><span class="n">a2</span><span class="o">=</span><span class="n">cell_type</span><span class="p">,</span><span class="n">packed</span><span class="o">=</span><span class="n">cocp</span><span class="p">)</span>
    <span class="n">endif</span>
    <span class="k">call </span><span class="n">b64_encode</span><span class="p">(</span><span class="n">nB</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">BYI1P</span><span class="p">,</span><span class="n">I4P</span><span class="p">),</span><span class="n">n</span><span class="o">=</span><span class="n">cocp</span><span class="p">,</span><span class="n">code</span><span class="o">=</span><span class="n">coc64</span><span class="p">)</span> <span class="p">;</span> <span class="k">deallocate</span><span class="p">(</span><span class="n">cocp</span><span class="p">)</span>
    <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="o">+</span><span class="mi">2</span><span class="p">)</span><span class="o">//</span><span class="n">tochar</span><span class="p">(</span><span class="n">coc64</span><span class="p">)</span><span class="o">//</span><span class="n">end_rec</span> <span class="p">;</span> <span class="k">deallocate</span><span class="p">(</span><span class="n">coc64</span><span class="p">)</span>
    <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;/DataArray&gt;&#39;</span><span class="o">//</span><span class="n">end_rec</span> <span class="p">;</span> <span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span> <span class="o">=</span> <span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span> <span class="o">-</span> <span class="mi">2</span>
    <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;/Cells&gt;&#39;</span><span class="o">//</span><span class="n">end_rec</span>
  <span class="n">endselect</span>
  <span class="k">return</span>
  <span class="c">!---------------------------------------------------------------------------------------------------------------------------------</span>
  <span class="n">endfunction</span> <span class="n">VTK_CON_XML</span>

  <span class="c">!&gt; Function that \b must be called before saving the data related to geometric mesh, this function initializes the</span>
  <span class="c">!&gt; saving of data variables indicating the \em type (node or cell centered) of variables that will be saved.</span>
  <span class="c">!&gt; @note A single file can contain both cell and node centered variables. In this case the VTK_DAT_XML function must be</span>
  <span class="c">!&gt; called two times, before saving cell-centered variables and before saving node-centered variables.</span>
  <span class="c">!&gt; Examples of usage are: \n</span>
  <span class="c">!&gt; \b Opening node piece: \n</span>
  <span class="c">!&gt; @code ...</span>
  <span class="c">!&gt; E_IO=VTK_DAT_XML(&#39;node&#39;,&#39;OPEN&#39;)</span>
  <span class="c">!&gt; ... @endcode</span>
  <span class="c">!&gt; \b Closing node piece: \n</span>
  <span class="c">!&gt; @code ...</span>
  <span class="c">!&gt; E_IO=VTK_DAT_XML(&#39;node&#39;,&#39;CLOSE&#39;)</span>
  <span class="c">!&gt; ... @endcode</span>
  <span class="c">!&gt; @return E_IO: integer(I4P) error flag</span>
  <span class="c">!&gt; @ingroup Lib_VTK_IOPublicProcedure</span>
  <span class="k">function </span><span class="n">VTK_DAT_XML</span><span class="p">(</span><span class="n">var_location</span><span class="p">,</span><span class="n">var_block_action</span><span class="p">,</span><span class="n">cf</span><span class="p">)</span> <span class="k">result</span><span class="p">(</span><span class="n">E_IO</span><span class="p">)</span>
  <span class="c">!---------------------------------------------------------------------------------------------------------------------------------</span>
  <span class="k">implicit none</span>
<span class="k">  </span><span class="kt">character</span><span class="p">(</span><span class="o">*</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span><span class="kd">::</span>           <span class="n">var_location</span>     <span class="c">!&lt; Location of saving variables: CELL or NODE centered.</span>
  <span class="kt">character</span><span class="p">(</span><span class="o">*</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span><span class="kd">::</span>           <span class="n">var_block_action</span> <span class="c">!&lt; Variables block action: OPEN or CLOSE block.</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">),</span> <span class="k">optional</span><span class="kd">::</span> <span class="n">cf</span>               <span class="c">!&lt; Current file index (for concurrent files IO).</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">)</span><span class="kd">::</span>                       <span class="n">E_IO</span>             <span class="c">!&lt; Input/Output inquiring flag: $0$ if IO is done, $&gt; 0$ if IO is not done.</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">)</span><span class="kd">::</span>                       <span class="n">rf</span>               <span class="c">!&lt; Real file index.</span>
  <span class="c">!---------------------------------------------------------------------------------------------------------------------------------</span>

  <span class="c">!---------------------------------------------------------------------------------------------------------------------------------</span>
  <span class="n">E_IO</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1_I4P</span>
  <span class="n">rf</span> <span class="o">=</span> <span class="n">f</span>
  <span class="k">if</span> <span class="p">(</span><span class="nb">present</span><span class="p">(</span><span class="n">cf</span><span class="p">))</span> <span class="k">then</span>
<span class="k">    </span><span class="n">rf</span> <span class="o">=</span> <span class="n">cf</span> <span class="p">;</span> <span class="n">f</span> <span class="o">=</span> <span class="n">cf</span>
  <span class="n">endif</span>
  <span class="k">select case</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">f</span><span class="p">)</span>
  <span class="k">case</span><span class="p">(</span><span class="n">ascii</span><span class="p">)</span>
    <span class="k">select case</span><span class="p">(</span><span class="nb">trim</span><span class="p">(</span><span class="n">Upper_Case</span><span class="p">(</span><span class="n">var_location</span><span class="p">)))</span>
    <span class="k">case</span><span class="p">(</span><span class="s1">&#39;CELL&#39;</span><span class="p">)</span>
      <span class="k">select case</span><span class="p">(</span><span class="nb">trim</span><span class="p">(</span><span class="n">Upper_Case</span><span class="p">(</span><span class="n">var_block_action</span><span class="p">)))</span>
      <span class="k">case</span><span class="p">(</span><span class="s1">&#39;OPEN&#39;</span><span class="p">)</span>
        <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;(A)&#39;</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;CellData&gt;&#39;</span> <span class="p">;</span> <span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span> <span class="o">=</span> <span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span> <span class="o">+</span> <span class="mi">2</span>
      <span class="k">case</span><span class="p">(</span><span class="s1">&#39;CLOSE&#39;</span><span class="p">)</span>
        <span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span> <span class="o">=</span> <span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span> <span class="o">-</span> <span class="mi">2</span> <span class="p">;</span> <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;(A)&#39;</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;/CellData&gt;&#39;</span>
      <span class="n">endselect</span>
    <span class="k">case</span><span class="p">(</span><span class="s1">&#39;NODE&#39;</span><span class="p">)</span>
      <span class="k">select case</span><span class="p">(</span><span class="nb">trim</span><span class="p">(</span><span class="n">Upper_Case</span><span class="p">(</span><span class="n">var_block_action</span><span class="p">)))</span>
      <span class="k">case</span><span class="p">(</span><span class="s1">&#39;OPEN&#39;</span><span class="p">)</span>
        <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;(A)&#39;</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;PointData&gt;&#39;</span> <span class="p">;</span> <span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span> <span class="o">=</span> <span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span> <span class="o">+</span> <span class="mi">2</span>
      <span class="k">case</span><span class="p">(</span><span class="s1">&#39;CLOSE&#39;</span><span class="p">)</span>
        <span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span> <span class="o">=</span> <span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span> <span class="o">-</span> <span class="mi">2</span> <span class="p">;</span> <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;(A)&#39;</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;/PointData&gt;&#39;</span>
      <span class="n">endselect</span>
    <span class="n">endselect</span>
  <span class="k">case</span><span class="p">(</span><span class="n">raw</span><span class="p">,</span><span class="n">binary</span><span class="p">,</span><span class="n">bin_app</span><span class="p">)</span>
    <span class="k">select case</span><span class="p">(</span><span class="nb">trim</span><span class="p">(</span><span class="n">Upper_Case</span><span class="p">(</span><span class="n">var_location</span><span class="p">)))</span>
    <span class="k">case</span><span class="p">(</span><span class="s1">&#39;CELL&#39;</span><span class="p">)</span>
      <span class="k">select case</span><span class="p">(</span><span class="nb">trim</span><span class="p">(</span><span class="n">Upper_Case</span><span class="p">(</span><span class="n">var_block_action</span><span class="p">)))</span>
      <span class="k">case</span><span class="p">(</span><span class="s1">&#39;OPEN&#39;</span><span class="p">)</span>
        <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;CellData&gt;&#39;</span><span class="o">//</span><span class="n">end_rec</span> <span class="p">;</span> <span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span> <span class="o">=</span> <span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span> <span class="o">+</span> <span class="mi">2</span>
      <span class="k">case</span><span class="p">(</span><span class="s1">&#39;CLOSE&#39;</span><span class="p">)</span>
        <span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span> <span class="o">=</span> <span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span> <span class="o">-</span> <span class="mi">2</span> <span class="p">;</span> <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;/CellData&gt;&#39;</span><span class="o">//</span><span class="n">end_rec</span>
      <span class="n">endselect</span>
    <span class="k">case</span><span class="p">(</span><span class="s1">&#39;NODE&#39;</span><span class="p">)</span>
      <span class="k">select case</span><span class="p">(</span><span class="nb">trim</span><span class="p">(</span><span class="n">Upper_Case</span><span class="p">(</span><span class="n">var_block_action</span><span class="p">)))</span>
      <span class="k">case</span><span class="p">(</span><span class="s1">&#39;OPEN&#39;</span><span class="p">)</span>
        <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;PointData&gt;&#39;</span><span class="o">//</span><span class="n">end_rec</span> <span class="p">;</span> <span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span> <span class="o">=</span> <span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span> <span class="o">+</span> <span class="mi">2</span>
      <span class="k">case</span><span class="p">(</span><span class="s1">&#39;CLOSE&#39;</span><span class="p">)</span>
        <span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span> <span class="o">=</span> <span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span> <span class="o">-</span> <span class="mi">2</span> <span class="p">;</span> <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;/PointData&gt;&#39;</span><span class="o">//</span><span class="n">end_rec</span>
      <span class="n">endselect</span>
    <span class="n">endselect</span>
  <span class="n">endselect</span>
  <span class="k">return</span>
  <span class="c">!---------------------------------------------------------------------------------------------------------------------------------</span>
  <span class="n">endfunction</span> <span class="n">VTK_DAT_XML</span>

  <span class="c">!&gt; @ingroup Lib_VTK_IOPrivateProcedure</span>
  <span class="c">!&gt; @{</span>

  <span class="c">!&gt; Function for saving field of scalar variable (R8P, 1D array).</span>
  <span class="c">!&gt; @return E_IO: integer(I4P) error flag</span>
  <span class="k">function </span><span class="n">VTK_VAR_XML_SCAL_1DA_R8</span><span class="p">(</span><span class="n">NC_NN</span><span class="p">,</span><span class="n">varname</span><span class="p">,</span><span class="n">var</span><span class="p">,</span><span class="n">cf</span><span class="p">)</span> <span class="k">result</span><span class="p">(</span><span class="n">E_IO</span><span class="p">)</span>
  <span class="c">!---------------------------------------------------------------------------------------------------------------------------------</span>
  <span class="k">implicit none</span>
<span class="k">  </span><span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span><span class="kd">::</span>           <span class="n">NC_NN</span>    <span class="c">!&lt; Number of cells or nodes.</span>
  <span class="kt">character</span><span class="p">(</span><span class="o">*</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span><span class="kd">::</span>           <span class="n">varname</span>  <span class="c">!&lt; Variable name.</span>
  <span class="kt">real</span><span class="p">(</span><span class="n">R8P</span><span class="p">),</span>    <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span><span class="kd">::</span>           <span class="n">var</span><span class="p">(</span><span class="mi">1</span><span class="p">:)</span>  <span class="c">!&lt; Variable to be saved [1:NC_NN].</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">),</span> <span class="k">optional</span><span class="kd">::</span> <span class="n">cf</span>       <span class="c">!&lt; Current file index (for concurrent files IO).</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">)</span><span class="kd">::</span>                       <span class="n">E_IO</span>     <span class="c">!&lt; Input/Output inquiring flag: $0$ if IO is done, $&gt; 0$ if IO is not done.</span>
  <span class="kt">character</span><span class="p">(</span><span class="nb">len</span><span class="o">=</span><span class="n">maxlen</span><span class="p">)</span><span class="kd">::</span>              <span class="n">s_buffer</span> <span class="c">!&lt; Buffer string.</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I1P</span><span class="p">),</span> <span class="k">allocatable</span><span class="kd">::</span>          <span class="n">varp</span><span class="p">(:)</span>  <span class="c">!&lt; Packed data.</span>
  <span class="kt">character</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="k">allocatable</span><span class="kd">::</span>          <span class="n">var64</span><span class="p">(:)</span> <span class="c">!&lt; Variable encoded in base64.</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">)</span><span class="kd">::</span>                       <span class="n">rf</span>       <span class="c">!&lt; Real file index.</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">)</span><span class="kd">::</span>                       <span class="n">n1</span>       <span class="c">!&lt; Counter.</span>
  <span class="c">!---------------------------------------------------------------------------------------------------------------------------------</span>

  <span class="c">!---------------------------------------------------------------------------------------------------------------------------------</span>
  <span class="n">E_IO</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1_I4P</span>
  <span class="n">rf</span> <span class="o">=</span> <span class="n">f</span>
  <span class="k">if</span> <span class="p">(</span><span class="nb">present</span><span class="p">(</span><span class="n">cf</span><span class="p">))</span> <span class="k">then</span>
<span class="k">    </span><span class="n">rf</span> <span class="o">=</span> <span class="n">cf</span> <span class="p">;</span> <span class="n">f</span> <span class="o">=</span> <span class="n">cf</span>
  <span class="n">endif</span>
  <span class="k">select case</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">f</span><span class="p">)</span>
  <span class="k">case</span><span class="p">(</span><span class="n">ascii</span><span class="p">)</span>
    <span class="n">s_buffer</span> <span class="o">=</span> <span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;DataArray type=&quot;Float64&quot; Name=&quot;&#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">varname</span><span class="p">)</span><span class="o">//</span><span class="p">&amp;</span>
               <span class="s1">&#39;&quot; NumberOfComponents=&quot;1&quot; format=&quot;ascii&quot;&gt;&#39;</span>
    <span class="k">write</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="s1">&#39;(A)&#39;</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">trim</span><span class="p">(</span><span class="n">s_buffer</span><span class="p">)</span>
    <span class="k">write</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="s1">&#39;(&#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(.</span><span class="n">true</span><span class="p">.,</span><span class="n">NC_NN</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39;A)&#39;</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">),(</span><span class="s1">&#39; &#39;</span><span class="o">//</span><span class="n">str</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">var</span><span class="p">(</span><span class="n">n1</span><span class="p">)),</span><span class="n">n1</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">NC_NN</span><span class="p">)</span>
    <span class="k">write</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="s1">&#39;(A)&#39;</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;/DataArray&gt;&#39;</span>
  <span class="k">case</span><span class="p">(</span><span class="n">raw</span><span class="p">,</span><span class="n">bin_app</span><span class="p">)</span>
    <span class="n">s_buffer</span> <span class="o">=</span> <span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;DataArray type=&quot;Float64&quot; Name=&quot;&#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">varname</span><span class="p">)</span><span class="o">//</span><span class="p">&amp;</span>
               <span class="s1">&#39;&quot; NumberOfComponents=&quot;1&quot; format=&quot;appended&quot; offset=&quot;&#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(.</span><span class="n">true</span><span class="p">.,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">ioffset</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39;&quot;/&gt;&#39;</span>
    <span class="k">write</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">trim</span><span class="p">(</span><span class="n">s_buffer</span><span class="p">)</span><span class="o">//</span><span class="n">end_rec</span>
    <span class="k">call </span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">byte_update</span><span class="p">(</span><span class="n">N_Byte</span> <span class="o">=</span> <span class="n">NC_NN</span><span class="o">*</span><span class="n">BYR8P</span><span class="p">)</span>
    <span class="k">write</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">ua</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">N_Byte</span><span class="p">,</span><span class="s1">&#39;R8&#39;</span><span class="p">,</span><span class="n">NC_NN</span>
    <span class="k">write</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">ua</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="n">var</span>
  <span class="k">case</span><span class="p">(</span><span class="n">binary</span><span class="p">)</span>
    <span class="n">s_buffer</span><span class="o">=</span><span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;DataArray type=&quot;Float64&quot; Name=&quot;&#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">varname</span><span class="p">)</span><span class="o">//</span><span class="p">&amp;</span>
             <span class="s1">&#39;&quot; NumberOfComponents=&quot;1&quot; format=&quot;binary&quot;&gt;&#39;</span>
    <span class="k">write</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">trim</span><span class="p">(</span><span class="n">s_buffer</span><span class="p">)</span><span class="o">//</span><span class="n">end_rec</span>
    <span class="k">call </span><span class="n">pack_data</span><span class="p">(</span><span class="n">a1</span><span class="o">=</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">NC_NN</span><span class="o">*</span><span class="n">BYR8P</span><span class="p">,</span><span class="n">I4P</span><span class="p">)],</span><span class="n">a2</span><span class="o">=</span><span class="n">var</span><span class="p">,</span><span class="n">packed</span><span class="o">=</span><span class="n">varp</span><span class="p">)</span>
    <span class="k">call </span><span class="n">b64_encode</span><span class="p">(</span><span class="n">nB</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">BYI1P</span><span class="p">,</span><span class="n">I4P</span><span class="p">),</span><span class="n">n</span><span class="o">=</span><span class="n">varp</span><span class="p">,</span><span class="n">code</span><span class="o">=</span><span class="n">var64</span><span class="p">)</span> <span class="p">;</span> <span class="k">deallocate</span><span class="p">(</span><span class="n">varp</span><span class="p">)</span>
    <span class="k">write</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="o">+</span><span class="mi">2</span><span class="p">)</span><span class="o">//</span><span class="n">tochar</span><span class="p">(</span><span class="n">var64</span><span class="p">)</span><span class="o">//</span><span class="n">end_rec</span> <span class="p">;</span> <span class="k">deallocate</span><span class="p">(</span><span class="n">var64</span><span class="p">)</span>
    <span class="k">write</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;/DataArray&gt;&#39;</span><span class="o">//</span><span class="n">end_rec</span>
  <span class="n">endselect</span>
  <span class="k">return</span>
  <span class="c">!---------------------------------------------------------------------------------------------------------------------------------</span>
  <span class="n">endfunction</span> <span class="n">VTK_VAR_XML_SCAL_1DA_R8</span>

  <span class="c">!&gt; Function for saving field of scalar variable (R8P, 3D array).</span>
  <span class="c">!&gt; @return E_IO: integer(I4P) error flag</span>
  <span class="k">function </span><span class="n">VTK_VAR_XML_SCAL_3DA_R8</span><span class="p">(</span><span class="n">NC_NN</span><span class="p">,</span><span class="n">varname</span><span class="p">,</span><span class="n">var</span><span class="p">,</span><span class="n">cf</span><span class="p">)</span> <span class="k">result</span><span class="p">(</span><span class="n">E_IO</span><span class="p">)</span>
  <span class="c">!---------------------------------------------------------------------------------------------------------------------------------</span>
  <span class="k">implicit none</span>
<span class="k">  </span><span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span><span class="kd">::</span>           <span class="n">NC_NN</span>         <span class="c">!&lt; Number of cells or nodes.</span>
  <span class="kt">character</span><span class="p">(</span><span class="o">*</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span><span class="kd">::</span>           <span class="n">varname</span>       <span class="c">!&lt; Variable name.</span>
  <span class="kt">real</span><span class="p">(</span><span class="n">R8P</span><span class="p">),</span>    <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span><span class="kd">::</span>           <span class="n">var</span><span class="p">(</span><span class="mi">1</span><span class="p">:,</span><span class="mi">1</span><span class="p">:,</span><span class="mi">1</span><span class="p">:)</span> <span class="c">!&lt; Variable to be saved [1:Nx,1:Ny,1:Nz].</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">),</span> <span class="k">optional</span><span class="kd">::</span> <span class="n">cf</span>            <span class="c">!&lt; Current file index (for concurrent files IO).</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">)</span><span class="kd">::</span>                       <span class="n">E_IO</span>          <span class="c">!&lt; Input/Output inquiring flag: $0$ if IO is done, $&gt; 0$ if IO is not done.</span>
  <span class="kt">character</span><span class="p">(</span><span class="nb">len</span><span class="o">=</span><span class="n">maxlen</span><span class="p">)</span><span class="kd">::</span>              <span class="n">s_buffer</span>      <span class="c">!&lt; Buffer string.</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I1P</span><span class="p">),</span> <span class="k">allocatable</span><span class="kd">::</span>          <span class="n">varp</span><span class="p">(:)</span>       <span class="c">!&lt; Packed data.</span>
  <span class="kt">character</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="k">allocatable</span><span class="kd">::</span>          <span class="n">var64</span><span class="p">(:)</span>      <span class="c">!&lt; Variable encoded in base64.</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">)</span><span class="kd">::</span>                       <span class="n">rf</span>            <span class="c">!&lt; Real file index.</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">)</span><span class="kd">::</span>                       <span class="n">nx</span><span class="p">,</span><span class="n">ny</span><span class="p">,</span><span class="n">nz</span>      <span class="c">!&lt; Counters.</span>
  <span class="c">!---------------------------------------------------------------------------------------------------------------------------------</span>

  <span class="c">!---------------------------------------------------------------------------------------------------------------------------------</span>
  <span class="n">E_IO</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1_I4P</span>
  <span class="n">rf</span> <span class="o">=</span> <span class="n">f</span>
  <span class="k">if</span> <span class="p">(</span><span class="nb">present</span><span class="p">(</span><span class="n">cf</span><span class="p">))</span> <span class="k">then</span>
<span class="k">    </span><span class="n">rf</span> <span class="o">=</span> <span class="n">cf</span> <span class="p">;</span> <span class="n">f</span> <span class="o">=</span> <span class="n">cf</span>
  <span class="n">endif</span>
  <span class="k">select case</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">f</span><span class="p">)</span>
  <span class="k">case</span><span class="p">(</span><span class="n">ascii</span><span class="p">)</span>
    <span class="n">s_buffer</span> <span class="o">=</span> <span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;DataArray type=&quot;Float64&quot; Name=&quot;&#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">varname</span><span class="p">)</span><span class="o">//</span><span class="p">&amp;</span>
               <span class="s1">&#39;&quot; NumberOfComponents=&quot;1&quot; format=&quot;ascii&quot;&gt;&#39;</span>
    <span class="k">write</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="s1">&#39;(A)&#39;</span><span class="p">,</span> <span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">trim</span><span class="p">(</span><span class="n">s_buffer</span><span class="p">)</span>
    <span class="k">write</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="s1">&#39;(&#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(.</span><span class="n">true</span><span class="p">.,</span><span class="n">NC_NN</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39;A)&#39;</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">),&amp;</span>
                                      <span class="p">(((</span><span class="s1">&#39; &#39;</span><span class="o">//</span><span class="n">str</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">var</span><span class="p">(</span><span class="n">nx</span><span class="p">,</span><span class="n">ny</span><span class="p">,</span><span class="n">nz</span><span class="p">)),</span><span class="n">nx</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">size</span><span class="p">(</span><span class="n">var</span><span class="p">,</span><span class="nb">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)),</span><span class="n">ny</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">size</span><span class="p">(</span><span class="n">var</span><span class="p">,</span><span class="nb">dim</span><span class="o">=</span><span class="mi">2</span><span class="p">)),</span><span class="n">nz</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">size</span><span class="p">(</span><span class="n">var</span><span class="p">,</span><span class="nb">dim</span><span class="o">=</span><span class="mi">3</span><span class="p">))</span>
    <span class="k">write</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="s1">&#39;(A)&#39;</span><span class="p">,</span> <span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;/DataArray&gt;&#39;</span>
  <span class="k">case</span><span class="p">(</span><span class="n">raw</span><span class="p">,</span><span class="n">bin_app</span><span class="p">)</span>
    <span class="n">s_buffer</span> <span class="o">=</span> <span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;DataArray type=&quot;Float64&quot; Name=&quot;&#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">varname</span><span class="p">)</span><span class="o">//</span><span class="p">&amp;</span>
               <span class="s1">&#39;&quot; NumberOfComponents=&quot;1&quot; format=&quot;appended&quot; offset=&quot;&#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(.</span><span class="n">true</span><span class="p">.,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">ioffset</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39;&quot;/&gt;&#39;</span>
    <span class="k">write</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">trim</span><span class="p">(</span><span class="n">s_buffer</span><span class="p">)</span><span class="o">//</span><span class="n">end_rec</span>
    <span class="k">call </span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">byte_update</span><span class="p">(</span><span class="n">N_Byte</span> <span class="o">=</span> <span class="n">NC_NN</span><span class="o">*</span><span class="n">BYR8P</span><span class="p">)</span>
    <span class="k">write</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">ua</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">N_Byte</span><span class="p">,</span><span class="s1">&#39;R8&#39;</span><span class="p">,</span><span class="n">NC_NN</span>
    <span class="k">write</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">ua</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="n">var</span>
  <span class="k">case</span><span class="p">(</span><span class="n">binary</span><span class="p">)</span>
    <span class="n">s_buffer</span><span class="o">=</span><span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;DataArray type=&quot;Float64&quot; Name=&quot;&#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">varname</span><span class="p">)</span><span class="o">//</span><span class="p">&amp;</span>
             <span class="s1">&#39;&quot; NumberOfComponents=&quot;1&quot; format=&quot;binary&quot;&gt;&#39;</span>
    <span class="k">write</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">trim</span><span class="p">(</span><span class="n">s_buffer</span><span class="p">)</span><span class="o">//</span><span class="n">end_rec</span>
    <span class="k">call </span><span class="n">pack_data</span><span class="p">(</span><span class="n">a1</span><span class="o">=</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">NC_NN</span><span class="o">*</span><span class="n">BYR8P</span><span class="p">,</span><span class="n">I4P</span><span class="p">)],</span><span class="n">a2</span><span class="o">=</span><span class="nb">reshape</span><span class="p">(</span><span class="n">var</span><span class="p">,[</span><span class="n">NC_NN</span><span class="p">]),</span><span class="n">packed</span><span class="o">=</span><span class="n">varp</span><span class="p">)</span>
    <span class="k">call </span><span class="n">b64_encode</span><span class="p">(</span><span class="n">nB</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">BYI1P</span><span class="p">,</span><span class="n">I4P</span><span class="p">),</span><span class="n">n</span><span class="o">=</span><span class="n">varp</span><span class="p">,</span><span class="n">code</span><span class="o">=</span><span class="n">var64</span><span class="p">)</span> <span class="p">;</span> <span class="k">deallocate</span><span class="p">(</span><span class="n">varp</span><span class="p">)</span>
    <span class="k">write</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="o">+</span><span class="mi">2</span><span class="p">)</span><span class="o">//</span><span class="n">tochar</span><span class="p">(</span><span class="n">var64</span><span class="p">)</span><span class="o">//</span><span class="n">end_rec</span> <span class="p">;</span> <span class="k">deallocate</span><span class="p">(</span><span class="n">var64</span><span class="p">)</span>
    <span class="k">write</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;/DataArray&gt;&#39;</span><span class="o">//</span><span class="n">end_rec</span>
  <span class="n">endselect</span>
  <span class="k">return</span>
  <span class="c">!---------------------------------------------------------------------------------------------------------------------------------</span>
  <span class="n">endfunction</span> <span class="n">VTK_VAR_XML_SCAL_3DA_R8</span>

  <span class="c">!&gt; Function for saving field of scalar variable (R4P, 1D array).</span>
  <span class="c">!&gt; @return E_IO: integer(I4P) error flag</span>
  <span class="k">function </span><span class="n">VTK_VAR_XML_SCAL_1DA_R4</span><span class="p">(</span><span class="n">NC_NN</span><span class="p">,</span><span class="n">varname</span><span class="p">,</span><span class="n">var</span><span class="p">,</span><span class="n">cf</span><span class="p">)</span> <span class="k">result</span><span class="p">(</span><span class="n">E_IO</span><span class="p">)</span>
  <span class="c">!---------------------------------------------------------------------------------------------------------------------------------</span>
  <span class="k">implicit none</span>
<span class="k">  </span><span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span><span class="kd">::</span>           <span class="n">NC_NN</span>    <span class="c">!&lt; Number of cells or nodes.</span>
  <span class="kt">character</span><span class="p">(</span><span class="o">*</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span><span class="kd">::</span>           <span class="n">varname</span>  <span class="c">!&lt; Variable name.</span>
  <span class="kt">real</span><span class="p">(</span><span class="n">R4P</span><span class="p">),</span>    <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span><span class="kd">::</span>           <span class="n">var</span><span class="p">(</span><span class="mi">1</span><span class="p">:)</span>  <span class="c">!&lt; Variable to be saved [1:NC_NN].</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">),</span> <span class="k">optional</span><span class="kd">::</span> <span class="n">cf</span>       <span class="c">!&lt; Current file index (for concurrent files IO).</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">)</span><span class="kd">::</span>                       <span class="n">E_IO</span>     <span class="c">!&lt; Input/Output inquiring flag: $0$ if IO is done, $&gt; 0$ if IO is not done.</span>
  <span class="kt">character</span><span class="p">(</span><span class="nb">len</span><span class="o">=</span><span class="n">maxlen</span><span class="p">)</span><span class="kd">::</span>              <span class="n">s_buffer</span> <span class="c">!&lt; Buffer string.</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I1P</span><span class="p">),</span> <span class="k">allocatable</span><span class="kd">::</span>          <span class="n">varp</span><span class="p">(:)</span>  <span class="c">!&lt; Packed data.</span>
  <span class="kt">character</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="k">allocatable</span><span class="kd">::</span>          <span class="n">var64</span><span class="p">(:)</span> <span class="c">!&lt; Variable encoded in base64.</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">)</span><span class="kd">::</span>                       <span class="n">rf</span>       <span class="c">!&lt; Real file index.</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">)</span><span class="kd">::</span>                       <span class="n">n1</span>       <span class="c">!&lt; Counter.</span>
  <span class="c">!---------------------------------------------------------------------------------------------------------------------------------</span>

  <span class="c">!---------------------------------------------------------------------------------------------------------------------------------</span>
  <span class="n">E_IO</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1_I4P</span>
  <span class="n">rf</span> <span class="o">=</span> <span class="n">f</span>
  <span class="k">if</span> <span class="p">(</span><span class="nb">present</span><span class="p">(</span><span class="n">cf</span><span class="p">))</span> <span class="k">then</span>
<span class="k">    </span><span class="n">rf</span> <span class="o">=</span> <span class="n">cf</span> <span class="p">;</span> <span class="n">f</span> <span class="o">=</span> <span class="n">cf</span>
  <span class="n">endif</span>
  <span class="k">select case</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">f</span><span class="p">)</span>
  <span class="k">case</span><span class="p">(</span><span class="n">ascii</span><span class="p">)</span>
    <span class="n">s_buffer</span> <span class="o">=</span> <span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;DataArray type=&quot;Float32&quot; Name=&quot;&#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">varname</span><span class="p">)</span><span class="o">//</span><span class="p">&amp;</span>
               <span class="s1">&#39;&quot; NumberOfComponents=&quot;1&quot; format=&quot;ascii&quot;&gt;&#39;</span>
    <span class="k">write</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="s1">&#39;(A)&#39;</span><span class="p">,</span> <span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">trim</span><span class="p">(</span><span class="n">s_buffer</span><span class="p">)</span>
    <span class="k">write</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="s1">&#39;(&#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(.</span><span class="n">true</span><span class="p">.,</span><span class="n">NC_NN</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39;A)&#39;</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">),(</span><span class="s1">&#39; &#39;</span><span class="o">//</span><span class="n">str</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">var</span><span class="p">(</span><span class="n">n1</span><span class="p">)),</span><span class="n">n1</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">NC_NN</span><span class="p">)</span>
    <span class="k">write</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="s1">&#39;(A)&#39;</span><span class="p">,</span> <span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;/DataArray&gt;&#39;</span>
  <span class="k">case</span><span class="p">(</span><span class="n">raw</span><span class="p">,</span><span class="n">bin_app</span><span class="p">)</span>
    <span class="n">s_buffer</span> <span class="o">=</span> <span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;DataArray type=&quot;Float32&quot; Name=&quot;&#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">varname</span><span class="p">)</span><span class="o">//</span><span class="p">&amp;</span>
               <span class="s1">&#39;&quot; NumberOfComponents=&quot;1&quot; format=&quot;appended&quot; offset=&quot;&#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(.</span><span class="n">true</span><span class="p">.,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">ioffset</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39;&quot;/&gt;&#39;</span>
    <span class="k">write</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">trim</span><span class="p">(</span><span class="n">s_buffer</span><span class="p">)</span><span class="o">//</span><span class="n">end_rec</span>
    <span class="k">call </span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">byte_update</span><span class="p">(</span><span class="n">N_Byte</span> <span class="o">=</span> <span class="n">NC_NN</span><span class="o">*</span><span class="n">BYR4P</span><span class="p">)</span>
    <span class="k">write</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">ua</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">N_Byte</span><span class="p">,</span><span class="s1">&#39;R4&#39;</span><span class="p">,</span><span class="n">NC_NN</span>
    <span class="k">write</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">ua</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="n">var</span>
  <span class="k">case</span><span class="p">(</span><span class="n">binary</span><span class="p">)</span>
    <span class="n">s_buffer</span><span class="o">=</span><span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;DataArray type=&quot;Float32&quot; Name=&quot;&#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">varname</span><span class="p">)</span><span class="o">//</span><span class="p">&amp;</span>
             <span class="s1">&#39;&quot; NumberOfComponents=&quot;1&quot; format=&quot;binary&quot;&gt;&#39;</span>
    <span class="k">write</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">trim</span><span class="p">(</span><span class="n">s_buffer</span><span class="p">)</span><span class="o">//</span><span class="n">end_rec</span>
    <span class="k">call </span><span class="n">pack_data</span><span class="p">(</span><span class="n">a1</span><span class="o">=</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">NC_NN</span><span class="o">*</span><span class="n">BYR4P</span><span class="p">,</span><span class="n">I4P</span><span class="p">)],</span><span class="n">a2</span><span class="o">=</span><span class="n">var</span><span class="p">,</span><span class="n">packed</span><span class="o">=</span><span class="n">varp</span><span class="p">)</span>
    <span class="k">call </span><span class="n">b64_encode</span><span class="p">(</span><span class="n">nB</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">BYI1P</span><span class="p">,</span><span class="n">I4P</span><span class="p">),</span><span class="n">n</span><span class="o">=</span><span class="n">varp</span><span class="p">,</span><span class="n">code</span><span class="o">=</span><span class="n">var64</span><span class="p">)</span> <span class="p">;</span> <span class="k">deallocate</span><span class="p">(</span><span class="n">varp</span><span class="p">)</span>
    <span class="k">write</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="o">+</span><span class="mi">2</span><span class="p">)</span><span class="o">//</span><span class="n">tochar</span><span class="p">(</span><span class="n">var64</span><span class="p">)</span><span class="o">//</span><span class="n">end_rec</span> <span class="p">;</span> <span class="k">deallocate</span><span class="p">(</span><span class="n">var64</span><span class="p">)</span>
    <span class="k">write</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;/DataArray&gt;&#39;</span><span class="o">//</span><span class="n">end_rec</span>
  <span class="n">endselect</span>
  <span class="k">return</span>
  <span class="c">!---------------------------------------------------------------------------------------------------------------------------------</span>
  <span class="n">endfunction</span> <span class="n">VTK_VAR_XML_SCAL_1DA_R4</span>

  <span class="c">!&gt; Function for saving field of scalar variable (R4P, 3D array).</span>
  <span class="c">!&gt; @return E_IO: integer(I4P) error flag</span>
  <span class="k">function </span><span class="n">VTK_VAR_XML_SCAL_3DA_R4</span><span class="p">(</span><span class="n">NC_NN</span><span class="p">,</span><span class="n">varname</span><span class="p">,</span><span class="n">var</span><span class="p">,</span><span class="n">cf</span><span class="p">)</span> <span class="k">result</span><span class="p">(</span><span class="n">E_IO</span><span class="p">)</span>
  <span class="c">!---------------------------------------------------------------------------------------------------------------------------------</span>
  <span class="k">implicit none</span>
<span class="k">  </span><span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span><span class="kd">::</span>           <span class="n">NC_NN</span>         <span class="c">!&lt; Number of cells or nodes.</span>
  <span class="kt">character</span><span class="p">(</span><span class="o">*</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span><span class="kd">::</span>           <span class="n">varname</span>       <span class="c">!&lt; Variable name.</span>
  <span class="kt">real</span><span class="p">(</span><span class="n">R4P</span><span class="p">),</span>    <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span><span class="kd">::</span>           <span class="n">var</span><span class="p">(</span><span class="mi">1</span><span class="p">:,</span><span class="mi">1</span><span class="p">:,</span><span class="mi">1</span><span class="p">:)</span> <span class="c">!&lt; Variable to be saved [1:Nx,1:Ny,1:Nz].</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">),</span> <span class="k">optional</span><span class="kd">::</span> <span class="n">cf</span>            <span class="c">!&lt; Current file index (for concurrent files IO).</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">)</span><span class="kd">::</span>                       <span class="n">E_IO</span>          <span class="c">!&lt; Input/Output inquiring flag: $0$ if IO is done, $&gt; 0$ if IO is not done.</span>
  <span class="kt">character</span><span class="p">(</span><span class="nb">len</span><span class="o">=</span><span class="n">maxlen</span><span class="p">)</span><span class="kd">::</span>              <span class="n">s_buffer</span>      <span class="c">!&lt; Buffer string.</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I1P</span><span class="p">),</span> <span class="k">allocatable</span><span class="kd">::</span>          <span class="n">varp</span><span class="p">(:)</span>       <span class="c">!&lt; Packed data.</span>
  <span class="kt">character</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="k">allocatable</span><span class="kd">::</span>          <span class="n">var64</span><span class="p">(:)</span>      <span class="c">!&lt; Variable encoded in base64.</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">)</span><span class="kd">::</span>                       <span class="n">rf</span>            <span class="c">!&lt; Real file index.</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">)</span><span class="kd">::</span>                       <span class="n">nx</span><span class="p">,</span><span class="n">ny</span><span class="p">,</span><span class="n">nz</span>      <span class="c">!&lt; Counters.</span>
  <span class="c">!---------------------------------------------------------------------------------------------------------------------------------</span>

  <span class="c">!---------------------------------------------------------------------------------------------------------------------------------</span>
  <span class="n">E_IO</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1_I4P</span>
  <span class="n">rf</span> <span class="o">=</span> <span class="n">f</span>
  <span class="k">if</span> <span class="p">(</span><span class="nb">present</span><span class="p">(</span><span class="n">cf</span><span class="p">))</span> <span class="k">then</span>
<span class="k">    </span><span class="n">rf</span> <span class="o">=</span> <span class="n">cf</span> <span class="p">;</span> <span class="n">f</span> <span class="o">=</span> <span class="n">cf</span>
  <span class="n">endif</span>
  <span class="k">select case</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">f</span><span class="p">)</span>
  <span class="k">case</span><span class="p">(</span><span class="n">ascii</span><span class="p">)</span>
    <span class="n">s_buffer</span> <span class="o">=</span> <span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;DataArray type=&quot;Float32&quot; Name=&quot;&#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">varname</span><span class="p">)</span><span class="o">//</span><span class="p">&amp;</span>
               <span class="s1">&#39;&quot; NumberOfComponents=&quot;1&quot; format=&quot;ascii&quot;&gt;&#39;</span>
    <span class="k">write</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="s1">&#39;(A)&#39;</span><span class="p">,</span> <span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">trim</span><span class="p">(</span><span class="n">s_buffer</span><span class="p">)</span>
    <span class="k">write</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="s1">&#39;(&#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(.</span><span class="n">true</span><span class="p">.,</span><span class="n">NC_NN</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39;A)&#39;</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">),&amp;</span>
                                      <span class="p">(((</span><span class="s1">&#39; &#39;</span><span class="o">//</span><span class="n">str</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">var</span><span class="p">(</span><span class="n">nx</span><span class="p">,</span><span class="n">ny</span><span class="p">,</span><span class="n">nz</span><span class="p">)),</span><span class="n">nx</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">size</span><span class="p">(</span><span class="n">var</span><span class="p">,</span><span class="nb">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)),</span><span class="n">ny</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">size</span><span class="p">(</span><span class="n">var</span><span class="p">,</span><span class="nb">dim</span><span class="o">=</span><span class="mi">2</span><span class="p">)),</span><span class="n">nz</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">size</span><span class="p">(</span><span class="n">var</span><span class="p">,</span><span class="nb">dim</span><span class="o">=</span><span class="mi">3</span><span class="p">))</span>
    <span class="k">write</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="s1">&#39;(A)&#39;</span><span class="p">,</span> <span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;/DataArray&gt;&#39;</span>
  <span class="k">case</span><span class="p">(</span><span class="n">raw</span><span class="p">,</span><span class="n">bin_app</span><span class="p">)</span>
    <span class="n">s_buffer</span> <span class="o">=</span> <span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;DataArray type=&quot;Float32&quot; Name=&quot;&#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">varname</span><span class="p">)</span><span class="o">//</span><span class="p">&amp;</span>
               <span class="s1">&#39;&quot; NumberOfComponents=&quot;1&quot; format=&quot;appended&quot; offset=&quot;&#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(.</span><span class="n">true</span><span class="p">.,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">ioffset</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39;&quot;/&gt;&#39;</span>
    <span class="k">write</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">trim</span><span class="p">(</span><span class="n">s_buffer</span><span class="p">)</span><span class="o">//</span><span class="n">end_rec</span>
    <span class="k">call </span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">byte_update</span><span class="p">(</span><span class="n">N_Byte</span> <span class="o">=</span> <span class="n">NC_NN</span><span class="o">*</span><span class="n">BYR4P</span><span class="p">)</span>
    <span class="k">write</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">ua</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">N_Byte</span><span class="p">,</span><span class="s1">&#39;R4&#39;</span><span class="p">,</span><span class="n">NC_NN</span>
    <span class="k">write</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">ua</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="n">var</span>
  <span class="k">case</span><span class="p">(</span><span class="n">binary</span><span class="p">)</span>
    <span class="n">s_buffer</span><span class="o">=</span><span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;DataArray type=&quot;Float32&quot; Name=&quot;&#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">varname</span><span class="p">)</span><span class="o">//</span><span class="p">&amp;</span>
             <span class="s1">&#39;&quot; NumberOfComponents=&quot;1&quot; format=&quot;binary&quot;&gt;&#39;</span>
    <span class="k">write</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">trim</span><span class="p">(</span><span class="n">s_buffer</span><span class="p">)</span><span class="o">//</span><span class="n">end_rec</span>
    <span class="k">call </span><span class="n">pack_data</span><span class="p">(</span><span class="n">a1</span><span class="o">=</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">NC_NN</span><span class="o">*</span><span class="n">BYR4P</span><span class="p">,</span><span class="n">I4P</span><span class="p">)],</span><span class="n">a2</span><span class="o">=</span><span class="nb">reshape</span><span class="p">(</span><span class="n">var</span><span class="p">,[</span><span class="n">NC_NN</span><span class="p">]),</span><span class="n">packed</span><span class="o">=</span><span class="n">varp</span><span class="p">)</span>
    <span class="k">call </span><span class="n">b64_encode</span><span class="p">(</span><span class="n">nB</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">BYI1P</span><span class="p">,</span><span class="n">I4P</span><span class="p">),</span><span class="n">n</span><span class="o">=</span><span class="n">varp</span><span class="p">,</span><span class="n">code</span><span class="o">=</span><span class="n">var64</span><span class="p">)</span> <span class="p">;</span> <span class="k">deallocate</span><span class="p">(</span><span class="n">varp</span><span class="p">)</span>
    <span class="k">write</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="o">+</span><span class="mi">2</span><span class="p">)</span><span class="o">//</span><span class="n">tochar</span><span class="p">(</span><span class="n">var64</span><span class="p">)</span><span class="o">//</span><span class="n">end_rec</span> <span class="p">;</span> <span class="k">deallocate</span><span class="p">(</span><span class="n">var64</span><span class="p">)</span>
    <span class="k">write</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;/DataArray&gt;&#39;</span><span class="o">//</span><span class="n">end_rec</span>
  <span class="n">endselect</span>
  <span class="k">return</span>
  <span class="c">!---------------------------------------------------------------------------------------------------------------------------------</span>
  <span class="n">endfunction</span> <span class="n">VTK_VAR_XML_SCAL_3DA_R4</span>

  <span class="c">!&gt; Function for saving field of scalar variable (I8P, 1D array).</span>
  <span class="c">!&gt; @return E_IO: integer(I4P) error flag</span>
  <span class="k">function </span><span class="n">VTK_VAR_XML_SCAL_1DA_I8</span><span class="p">(</span><span class="n">NC_NN</span><span class="p">,</span><span class="n">varname</span><span class="p">,</span><span class="n">var</span><span class="p">,</span><span class="n">cf</span><span class="p">)</span> <span class="k">result</span><span class="p">(</span><span class="n">E_IO</span><span class="p">)</span>
  <span class="c">!---------------------------------------------------------------------------------------------------------------------------------</span>
  <span class="k">implicit none</span>
<span class="k">  </span><span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span><span class="kd">::</span>           <span class="n">NC_NN</span>    <span class="c">!&lt; Number of cells or nodes.</span>
  <span class="kt">character</span><span class="p">(</span><span class="o">*</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span><span class="kd">::</span>           <span class="n">varname</span>  <span class="c">!&lt; Variable name.</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I8P</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span><span class="kd">::</span>           <span class="n">var</span><span class="p">(</span><span class="mi">1</span><span class="p">:)</span>  <span class="c">!&lt; Variable to be saved [1:NC_NN].</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">),</span> <span class="k">optional</span><span class="kd">::</span> <span class="n">cf</span>       <span class="c">!&lt; Current file index (for concurrent files IO).</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">)</span><span class="kd">::</span>                       <span class="n">E_IO</span>     <span class="c">!&lt; Input/Output inquiring flag: $0$ if IO is done, $&gt; 0$ if IO is not done.</span>
  <span class="kt">character</span><span class="p">(</span><span class="nb">len</span><span class="o">=</span><span class="n">maxlen</span><span class="p">)</span><span class="kd">::</span>              <span class="n">s_buffer</span> <span class="c">!&lt; Buffer string.</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I1P</span><span class="p">),</span> <span class="k">allocatable</span><span class="kd">::</span>          <span class="n">varp</span><span class="p">(:)</span>  <span class="c">!&lt; Packed data.</span>
  <span class="kt">character</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="k">allocatable</span><span class="kd">::</span>          <span class="n">var64</span><span class="p">(:)</span> <span class="c">!&lt; Variable encoded in base64.</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">)</span><span class="kd">::</span>                       <span class="n">rf</span>       <span class="c">!&lt; Real file index.</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">)</span><span class="kd">::</span>                       <span class="n">n1</span>       <span class="c">!&lt; Counter.</span>
  <span class="c">!---------------------------------------------------------------------------------------------------------------------------------</span>

  <span class="c">!---------------------------------------------------------------------------------------------------------------------------------</span>
  <span class="n">E_IO</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1_I4P</span>
  <span class="n">rf</span> <span class="o">=</span> <span class="n">f</span>
  <span class="k">if</span> <span class="p">(</span><span class="nb">present</span><span class="p">(</span><span class="n">cf</span><span class="p">))</span> <span class="k">then</span>
<span class="k">    </span><span class="n">rf</span> <span class="o">=</span> <span class="n">cf</span> <span class="p">;</span> <span class="n">f</span> <span class="o">=</span> <span class="n">cf</span>
  <span class="n">endif</span>
  <span class="k">select case</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">f</span><span class="p">)</span>
  <span class="k">case</span><span class="p">(</span><span class="n">ascii</span><span class="p">)</span>
    <span class="n">s_buffer</span> <span class="o">=</span> <span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;DataArray type=&quot;Int64&quot; Name=&quot;&#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">varname</span><span class="p">)</span><span class="o">//</span><span class="p">&amp;</span>
               <span class="s1">&#39;&quot; NumberOfComponents=&quot;1&quot; format=&quot;ascii&quot;&gt;&#39;</span>
    <span class="k">write</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="s1">&#39;(A)&#39;</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">trim</span><span class="p">(</span><span class="n">s_buffer</span><span class="p">)</span>
    <span class="k">write</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="s1">&#39;(&#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(.</span><span class="n">true</span><span class="p">.,</span><span class="n">NC_NN</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39;A)&#39;</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">),(</span><span class="s1">&#39; &#39;</span><span class="o">//</span><span class="n">str</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">var</span><span class="p">(</span><span class="n">n1</span><span class="p">)),</span><span class="n">n1</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">NC_NN</span><span class="p">)</span>
    <span class="k">write</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="s1">&#39;(A)&#39;</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="s1">&#39;&lt;/DataArray&gt;&#39;</span>
  <span class="k">case</span><span class="p">(</span><span class="n">raw</span><span class="p">,</span><span class="n">bin_app</span><span class="p">)</span>
    <span class="n">s_buffer</span> <span class="o">=</span> <span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;DataArray type=&quot;Int64&quot; Name=&quot;&#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">varname</span><span class="p">)</span><span class="o">//</span><span class="p">&amp;</span>
               <span class="s1">&#39;&quot; NumberOfComponents=&quot;1&quot; format=&quot;appended&quot; offset=&quot;&#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(.</span><span class="n">true</span><span class="p">.,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">ioffset</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39;&quot;/&gt;&#39;</span>
    <span class="k">write</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">trim</span><span class="p">(</span><span class="n">s_buffer</span><span class="p">)</span><span class="o">//</span><span class="n">end_rec</span>
    <span class="k">call </span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">byte_update</span><span class="p">(</span><span class="n">N_Byte</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">NC_NN</span><span class="o">*</span><span class="n">BYI8P</span><span class="p">,</span><span class="n">I4P</span><span class="p">))</span>
    <span class="k">write</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">ua</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">N_Byte</span><span class="p">,</span><span class="s1">&#39;I8&#39;</span><span class="p">,</span><span class="n">NC_NN</span>
    <span class="k">write</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">ua</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="n">var</span>
  <span class="k">case</span><span class="p">(</span><span class="n">binary</span><span class="p">)</span>
    <span class="n">s_buffer</span><span class="o">=</span><span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;DataArray type=&quot;Int64&quot; Name=&quot;&#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">varname</span><span class="p">)</span><span class="o">//</span><span class="p">&amp;</span>
             <span class="s1">&#39;&quot; NumberOfComponents=&quot;1&quot; format=&quot;binary&quot;&gt;&#39;</span>
    <span class="k">write</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">trim</span><span class="p">(</span><span class="n">s_buffer</span><span class="p">)</span><span class="o">//</span><span class="n">end_rec</span>
    <span class="k">call </span><span class="n">pack_data</span><span class="p">(</span><span class="n">a1</span><span class="o">=</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">NC_NN</span><span class="o">*</span><span class="n">BYI8P</span><span class="p">,</span><span class="n">I4P</span><span class="p">)],</span><span class="n">a2</span><span class="o">=</span><span class="n">var</span><span class="p">,</span><span class="n">packed</span><span class="o">=</span><span class="n">varp</span><span class="p">)</span>
    <span class="k">call </span><span class="n">b64_encode</span><span class="p">(</span><span class="n">nB</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">BYI1P</span><span class="p">,</span><span class="n">I4P</span><span class="p">),</span><span class="n">n</span><span class="o">=</span><span class="n">varp</span><span class="p">,</span><span class="n">code</span><span class="o">=</span><span class="n">var64</span><span class="p">)</span> <span class="p">;</span> <span class="k">deallocate</span><span class="p">(</span><span class="n">varp</span><span class="p">)</span>
    <span class="k">write</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="o">+</span><span class="mi">2</span><span class="p">)</span><span class="o">//</span><span class="n">tochar</span><span class="p">(</span><span class="n">var64</span><span class="p">)</span><span class="o">//</span><span class="n">end_rec</span> <span class="p">;</span> <span class="k">deallocate</span><span class="p">(</span><span class="n">var64</span><span class="p">)</span>
    <span class="k">write</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;/DataArray&gt;&#39;</span><span class="o">//</span><span class="n">end_rec</span>
  <span class="n">endselect</span>
  <span class="k">return</span>
  <span class="c">!---------------------------------------------------------------------------------------------------------------------------------</span>
  <span class="n">endfunction</span> <span class="n">VTK_VAR_XML_SCAL_1DA_I8</span>

  <span class="c">!&gt; Function for saving field of scalar variable (I8P, 3D array).</span>
  <span class="c">!&gt; @return E_IO: integer(I4P) error flag</span>
  <span class="k">function </span><span class="n">VTK_VAR_XML_SCAL_3DA_I8</span><span class="p">(</span><span class="n">NC_NN</span><span class="p">,</span><span class="n">varname</span><span class="p">,</span><span class="n">var</span><span class="p">,</span><span class="n">cf</span><span class="p">)</span> <span class="k">result</span><span class="p">(</span><span class="n">E_IO</span><span class="p">)</span>
  <span class="c">!---------------------------------------------------------------------------------------------------------------------------------</span>
  <span class="k">implicit none</span>
<span class="k">  </span><span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span><span class="kd">::</span>           <span class="n">NC_NN</span>         <span class="c">!&lt; Number of cells or nodes.</span>
  <span class="kt">character</span><span class="p">(</span><span class="o">*</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span><span class="kd">::</span>           <span class="n">varname</span>       <span class="c">!&lt; Variable name.</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I8P</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span><span class="kd">::</span>           <span class="n">var</span><span class="p">(</span><span class="mi">1</span><span class="p">:,</span><span class="mi">1</span><span class="p">:,</span><span class="mi">1</span><span class="p">:)</span> <span class="c">!&lt; Variable to be saved [1:Nx,1:Ny,1:Nz].</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">),</span> <span class="k">optional</span><span class="kd">::</span> <span class="n">cf</span>            <span class="c">!&lt; Current file index (for concurrent files IO).</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">)</span><span class="kd">::</span>                       <span class="n">E_IO</span>          <span class="c">!&lt; Input/Output inquiring flag: $0$ if IO is done, $&gt; 0$ if IO is not done.</span>
  <span class="kt">character</span><span class="p">(</span><span class="nb">len</span><span class="o">=</span><span class="n">maxlen</span><span class="p">)</span><span class="kd">::</span>              <span class="n">s_buffer</span>      <span class="c">!&lt; Buffer string.</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I1P</span><span class="p">),</span> <span class="k">allocatable</span><span class="kd">::</span>          <span class="n">varp</span><span class="p">(:)</span>       <span class="c">!&lt; Packed data.</span>
  <span class="kt">character</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="k">allocatable</span><span class="kd">::</span>          <span class="n">var64</span><span class="p">(:)</span>      <span class="c">!&lt; Variable encoded in base64.</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">)</span><span class="kd">::</span>                       <span class="n">rf</span>            <span class="c">!&lt; Real file index.</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">)</span><span class="kd">::</span>                       <span class="n">nx</span><span class="p">,</span><span class="n">ny</span><span class="p">,</span><span class="n">nz</span>      <span class="c">!&lt; Counters.</span>
  <span class="c">!---------------------------------------------------------------------------------------------------------------------------------</span>

  <span class="c">!---------------------------------------------------------------------------------------------------------------------------------</span>
  <span class="n">E_IO</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1_I4P</span>
  <span class="n">rf</span> <span class="o">=</span> <span class="n">f</span>
  <span class="k">if</span> <span class="p">(</span><span class="nb">present</span><span class="p">(</span><span class="n">cf</span><span class="p">))</span> <span class="k">then</span>
<span class="k">    </span><span class="n">rf</span> <span class="o">=</span> <span class="n">cf</span> <span class="p">;</span> <span class="n">f</span> <span class="o">=</span> <span class="n">cf</span>
  <span class="n">endif</span>
  <span class="k">select case</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">f</span><span class="p">)</span>
  <span class="k">case</span><span class="p">(</span><span class="n">ascii</span><span class="p">)</span>
    <span class="n">s_buffer</span> <span class="o">=</span> <span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;DataArray type=&quot;Int64&quot; Name=&quot;&#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">varname</span><span class="p">)</span><span class="o">//</span><span class="p">&amp;</span>
               <span class="s1">&#39;&quot; NumberOfComponents=&quot;1&quot; format=&quot;ascii&quot;&gt;&#39;</span>
    <span class="k">write</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="s1">&#39;(A)&#39;</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">trim</span><span class="p">(</span><span class="n">s_buffer</span><span class="p">)</span>
    <span class="k">write</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="s1">&#39;(&#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(.</span><span class="n">true</span><span class="p">.,</span><span class="n">NC_NN</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39;A)&#39;</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">),&amp;</span>
                                      <span class="p">(((</span><span class="s1">&#39; &#39;</span><span class="o">//</span><span class="n">str</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">var</span><span class="p">(</span><span class="n">nx</span><span class="p">,</span><span class="n">ny</span><span class="p">,</span><span class="n">nz</span><span class="p">)),</span><span class="n">nx</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">size</span><span class="p">(</span><span class="n">var</span><span class="p">,</span><span class="nb">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)),</span><span class="n">ny</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">size</span><span class="p">(</span><span class="n">var</span><span class="p">,</span><span class="nb">dim</span><span class="o">=</span><span class="mi">2</span><span class="p">)),</span><span class="n">nz</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">size</span><span class="p">(</span><span class="n">var</span><span class="p">,</span><span class="nb">dim</span><span class="o">=</span><span class="mi">3</span><span class="p">))</span>
    <span class="k">write</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="s1">&#39;(A)&#39;</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="s1">&#39;&lt;/DataArray&gt;&#39;</span>
  <span class="k">case</span><span class="p">(</span><span class="n">raw</span><span class="p">,</span><span class="n">bin_app</span><span class="p">)</span>
    <span class="n">s_buffer</span> <span class="o">=</span> <span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;DataArray type=&quot;Int64&quot; Name=&quot;&#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">varname</span><span class="p">)</span><span class="o">//</span><span class="p">&amp;</span>
               <span class="s1">&#39;&quot; NumberOfComponents=&quot;1&quot; format=&quot;appended&quot; offset=&quot;&#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(.</span><span class="n">true</span><span class="p">.,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">ioffset</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39;&quot;/&gt;&#39;</span>
    <span class="k">write</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">trim</span><span class="p">(</span><span class="n">s_buffer</span><span class="p">)</span><span class="o">//</span><span class="n">end_rec</span>
    <span class="k">call </span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">byte_update</span><span class="p">(</span><span class="n">N_Byte</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">NC_NN</span><span class="o">*</span><span class="n">BYI8P</span><span class="p">,</span><span class="n">I4P</span><span class="p">))</span>
    <span class="k">write</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">ua</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">N_Byte</span><span class="p">,</span><span class="s1">&#39;I8&#39;</span><span class="p">,</span><span class="n">NC_NN</span>
    <span class="k">write</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">ua</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="n">var</span>
  <span class="k">case</span><span class="p">(</span><span class="n">binary</span><span class="p">)</span>
    <span class="n">s_buffer</span><span class="o">=</span><span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;DataArray type=&quot;Int64&quot; Name=&quot;&#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">varname</span><span class="p">)</span><span class="o">//</span><span class="p">&amp;</span>
             <span class="s1">&#39;&quot; NumberOfComponents=&quot;1&quot; format=&quot;binary&quot;&gt;&#39;</span>
    <span class="k">write</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">trim</span><span class="p">(</span><span class="n">s_buffer</span><span class="p">)</span><span class="o">//</span><span class="n">end_rec</span>
    <span class="k">call </span><span class="n">pack_data</span><span class="p">(</span><span class="n">a1</span><span class="o">=</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">NC_NN</span><span class="o">*</span><span class="n">BYI8P</span><span class="p">,</span><span class="n">I4P</span><span class="p">)],</span><span class="n">a2</span><span class="o">=</span><span class="nb">reshape</span><span class="p">(</span><span class="n">var</span><span class="p">,[</span><span class="n">NC_NN</span><span class="p">]),</span><span class="n">packed</span><span class="o">=</span><span class="n">varp</span><span class="p">)</span>
    <span class="k">call </span><span class="n">b64_encode</span><span class="p">(</span><span class="n">nB</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">BYI1P</span><span class="p">,</span><span class="n">I4P</span><span class="p">),</span><span class="n">n</span><span class="o">=</span><span class="n">varp</span><span class="p">,</span><span class="n">code</span><span class="o">=</span><span class="n">var64</span><span class="p">)</span> <span class="p">;</span> <span class="k">deallocate</span><span class="p">(</span><span class="n">varp</span><span class="p">)</span>
    <span class="k">write</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="o">+</span><span class="mi">2</span><span class="p">)</span><span class="o">//</span><span class="n">tochar</span><span class="p">(</span><span class="n">var64</span><span class="p">)</span><span class="o">//</span><span class="n">end_rec</span> <span class="p">;</span> <span class="k">deallocate</span><span class="p">(</span><span class="n">var64</span><span class="p">)</span>
    <span class="k">write</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;/DataArray&gt;&#39;</span><span class="o">//</span><span class="n">end_rec</span>
  <span class="n">endselect</span>
  <span class="k">return</span>
  <span class="c">!---------------------------------------------------------------------------------------------------------------------------------</span>
  <span class="n">endfunction</span> <span class="n">VTK_VAR_XML_SCAL_3DA_I8</span>

  <span class="c">!&gt; Function for saving field of scalar variable (I4P, 1D array).</span>
  <span class="c">!&gt; @return E_IO: integer(I4P) error flag</span>
  <span class="k">function </span><span class="n">VTK_VAR_XML_SCAL_1DA_I4</span><span class="p">(</span><span class="n">NC_NN</span><span class="p">,</span><span class="n">varname</span><span class="p">,</span><span class="n">var</span><span class="p">,</span><span class="n">cf</span><span class="p">)</span> <span class="k">result</span><span class="p">(</span><span class="n">E_IO</span><span class="p">)</span>
  <span class="c">!---------------------------------------------------------------------------------------------------------------------------------</span>
  <span class="k">implicit none</span>
<span class="k">  </span><span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span><span class="kd">::</span>           <span class="n">NC_NN</span>    <span class="c">!&lt; Number of cells or nodes.</span>
  <span class="kt">character</span><span class="p">(</span><span class="o">*</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span><span class="kd">::</span>           <span class="n">varname</span>  <span class="c">!&lt; Variable name.</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span><span class="kd">::</span>           <span class="n">var</span><span class="p">(</span><span class="mi">1</span><span class="p">:)</span>  <span class="c">!&lt; Variable to be saved [1:NC_NN].</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">),</span> <span class="k">optional</span><span class="kd">::</span> <span class="n">cf</span>       <span class="c">!&lt; Current file index (for concurrent files IO).</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">)</span><span class="kd">::</span>                       <span class="n">E_IO</span>     <span class="c">!&lt; Input/Output inquiring flag: $0$ if IO is done, $&gt; 0$ if IO is not done.</span>
  <span class="kt">character</span><span class="p">(</span><span class="nb">len</span><span class="o">=</span><span class="n">maxlen</span><span class="p">)</span><span class="kd">::</span>              <span class="n">s_buffer</span> <span class="c">!&lt; Buffer string.</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I1P</span><span class="p">),</span> <span class="k">allocatable</span><span class="kd">::</span>          <span class="n">varp</span><span class="p">(:)</span>  <span class="c">!&lt; Packed data.</span>
  <span class="kt">character</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="k">allocatable</span><span class="kd">::</span>          <span class="n">var64</span><span class="p">(:)</span> <span class="c">!&lt; Variable encoded in base64.</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">)</span><span class="kd">::</span>                       <span class="n">rf</span>       <span class="c">!&lt; Real file index.</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">)</span><span class="kd">::</span>                       <span class="n">n1</span>       <span class="c">!&lt; Counter.</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I8P</span><span class="p">)</span><span class="kd">::</span>                       <span class="n">Nvarp</span>    <span class="c">!&lt; Dimension of varp, packed data.</span>
  <span class="c">!---------------------------------------------------------------------------------------------------------------------------------</span>

  <span class="c">!---------------------------------------------------------------------------------------------------------------------------------</span>
  <span class="n">E_IO</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1_I4P</span>
  <span class="n">rf</span> <span class="o">=</span> <span class="n">f</span>
  <span class="k">if</span> <span class="p">(</span><span class="nb">present</span><span class="p">(</span><span class="n">cf</span><span class="p">))</span> <span class="k">then</span>
<span class="k">    </span><span class="n">rf</span> <span class="o">=</span> <span class="n">cf</span> <span class="p">;</span> <span class="n">f</span> <span class="o">=</span> <span class="n">cf</span>
  <span class="n">endif</span>
  <span class="k">select case</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">f</span><span class="p">)</span>
  <span class="k">case</span><span class="p">(</span><span class="n">ascii</span><span class="p">)</span>
    <span class="n">s_buffer</span> <span class="o">=</span> <span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;DataArray type=&quot;Int32&quot; Name=&quot;&#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">varname</span><span class="p">)</span><span class="o">//</span><span class="p">&amp;</span>
               <span class="s1">&#39;&quot; NumberOfComponents=&quot;1&quot; format=&quot;ascii&quot;&gt;&#39;</span>
    <span class="k">write</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="s1">&#39;(A)&#39;</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">trim</span><span class="p">(</span><span class="n">s_buffer</span><span class="p">)</span>
    <span class="k">write</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="s1">&#39;(&#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(.</span><span class="n">true</span><span class="p">.,</span><span class="n">NC_NN</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39;A)&#39;</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">),(</span><span class="s1">&#39; &#39;</span><span class="o">//</span><span class="n">str</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">var</span><span class="p">(</span><span class="n">n1</span><span class="p">)),</span><span class="n">n1</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">NC_NN</span><span class="p">)</span>
    <span class="k">write</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="s1">&#39;(A)&#39;</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;/DataArray&gt;&#39;</span>
  <span class="k">case</span><span class="p">(</span><span class="n">raw</span><span class="p">,</span><span class="n">bin_app</span><span class="p">)</span>
    <span class="n">s_buffer</span> <span class="o">=</span> <span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;DataArray type=&quot;Int32&quot; Name=&quot;&#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">varname</span><span class="p">)</span><span class="o">//</span> <span class="p">&amp;</span>
               <span class="s1">&#39;&quot; NumberOfComponents=&quot;1&quot; format=&quot;appended&quot; offset=&quot;&#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(.</span><span class="n">true</span><span class="p">.,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">ioffset</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39;&quot;/&gt;&#39;</span>
    <span class="k">write</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">trim</span><span class="p">(</span><span class="n">s_buffer</span><span class="p">)</span><span class="o">//</span><span class="n">end_rec</span>
    <span class="k">call </span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">byte_update</span><span class="p">(</span><span class="n">N_Byte</span> <span class="o">=</span> <span class="n">NC_NN</span><span class="o">*</span><span class="n">BYI4P</span><span class="p">)</span>
    <span class="k">write</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">ua</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">N_Byte</span><span class="p">,</span><span class="s1">&#39;I4&#39;</span><span class="p">,</span><span class="n">NC_NN</span>
    <span class="k">write</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">ua</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="n">var</span>
  <span class="k">case</span><span class="p">(</span><span class="n">binary</span><span class="p">)</span>
    <span class="n">s_buffer</span><span class="o">=</span><span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;DataArray type=&quot;Int32&quot; Name=&quot;&#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">varname</span><span class="p">)</span><span class="o">//</span> <span class="p">&amp;</span>
             <span class="s1">&#39;&quot; NumberOfComponents=&quot;1&quot; format=&quot;binary&quot;&gt;&#39;</span>
    <span class="k">write</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">trim</span><span class="p">(</span><span class="n">s_buffer</span><span class="p">)</span><span class="o">//</span><span class="n">end_rec</span>
    <span class="n">Nvarp</span><span class="o">=</span><span class="n">size</span><span class="p">(</span><span class="nb">transfer</span><span class="p">([</span><span class="nb">int</span><span class="p">(</span><span class="n">NC_NN</span><span class="o">*</span><span class="n">BYI4P</span><span class="p">,</span><span class="n">I4P</span><span class="p">),</span><span class="n">var</span><span class="p">],</span><span class="n">varp</span><span class="p">),</span><span class="nb">kind</span><span class="o">=</span><span class="n">I8P</span><span class="p">)</span> <span class="p">;</span> <span class="k">if</span> <span class="p">(</span><span class="nb">allocated</span><span class="p">(</span><span class="n">varp</span><span class="p">))</span> <span class="k">deallocate</span><span class="p">(</span><span class="n">varp</span><span class="p">)</span> <span class="p">;</span> <span class="k">allocate</span><span class="p">(</span><span class="n">varp</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">Nvarp</span><span class="p">))</span>
    <span class="n">varp</span> <span class="o">=</span> <span class="nb">transfer</span><span class="p">([</span><span class="nb">int</span><span class="p">(</span><span class="n">NC_NN</span><span class="o">*</span><span class="n">BYI4P</span><span class="p">,</span><span class="n">I4P</span><span class="p">),</span><span class="n">var</span><span class="p">],</span><span class="n">varp</span><span class="p">)</span>
    <span class="k">call </span><span class="n">b64_encode</span><span class="p">(</span><span class="n">nB</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">BYI1P</span><span class="p">,</span><span class="n">I4P</span><span class="p">),</span><span class="n">n</span><span class="o">=</span><span class="n">varp</span><span class="p">,</span><span class="n">code</span><span class="o">=</span><span class="n">var64</span><span class="p">)</span> <span class="p">;</span> <span class="k">deallocate</span><span class="p">(</span><span class="n">varp</span><span class="p">)</span>
    <span class="k">write</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="o">+</span><span class="mi">2</span><span class="p">)</span><span class="o">//</span><span class="n">tochar</span><span class="p">(</span><span class="n">var64</span><span class="p">)</span><span class="o">//</span><span class="n">end_rec</span> <span class="p">;</span> <span class="k">deallocate</span><span class="p">(</span><span class="n">var64</span><span class="p">)</span>
    <span class="k">write</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;/DataArray&gt;&#39;</span><span class="o">//</span><span class="n">end_rec</span>
  <span class="n">endselect</span>
  <span class="k">return</span>
  <span class="c">!---------------------------------------------------------------------------------------------------------------------------------</span>
  <span class="n">endfunction</span> <span class="n">VTK_VAR_XML_SCAL_1DA_I4</span>

  <span class="c">!&gt; Function for saving field of scalar variable (I4P, 3D array).</span>
  <span class="c">!&gt; @return E_IO: integer(I4P) error flag</span>
  <span class="k">function </span><span class="n">VTK_VAR_XML_SCAL_3DA_I4</span><span class="p">(</span><span class="n">NC_NN</span><span class="p">,</span><span class="n">varname</span><span class="p">,</span><span class="n">var</span><span class="p">,</span><span class="n">cf</span><span class="p">)</span> <span class="k">result</span><span class="p">(</span><span class="n">E_IO</span><span class="p">)</span>
  <span class="c">!---------------------------------------------------------------------------------------------------------------------------------</span>
  <span class="k">implicit none</span>
<span class="k">  </span><span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span><span class="kd">::</span>           <span class="n">NC_NN</span>         <span class="c">!&lt; Number of cells or nodes.</span>
  <span class="kt">character</span><span class="p">(</span><span class="o">*</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span><span class="kd">::</span>           <span class="n">varname</span>       <span class="c">!&lt; Variable name.</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span><span class="kd">::</span>           <span class="n">var</span><span class="p">(</span><span class="mi">1</span><span class="p">:,</span><span class="mi">1</span><span class="p">:,</span><span class="mi">1</span><span class="p">:)</span> <span class="c">!&lt; Variable to be saved [1:Nx,1:Ny,1:Nz].</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">),</span> <span class="k">optional</span><span class="kd">::</span> <span class="n">cf</span>            <span class="c">!&lt; Current file index (for concurrent files IO).</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">)</span><span class="kd">::</span>                       <span class="n">E_IO</span>          <span class="c">!&lt; Input/Output inquiring flag: $0$ if IO is done, $&gt; 0$ if IO is not done.</span>
  <span class="kt">character</span><span class="p">(</span><span class="nb">len</span><span class="o">=</span><span class="n">maxlen</span><span class="p">)</span><span class="kd">::</span>              <span class="n">s_buffer</span>      <span class="c">!&lt; Buffer string.</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I1P</span><span class="p">),</span> <span class="k">allocatable</span><span class="kd">::</span>          <span class="n">varp</span><span class="p">(:)</span>       <span class="c">!&lt; Packed data.</span>
  <span class="kt">character</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="k">allocatable</span><span class="kd">::</span>          <span class="n">var64</span><span class="p">(:)</span>      <span class="c">!&lt; Variable encoded in base64.</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">)</span><span class="kd">::</span>                       <span class="n">rf</span>            <span class="c">!&lt; Real file index.</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">)</span><span class="kd">::</span>                       <span class="n">nx</span><span class="p">,</span><span class="n">ny</span><span class="p">,</span><span class="n">nz</span>      <span class="c">!&lt; Counters.</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I8P</span><span class="p">)</span><span class="kd">::</span>                       <span class="n">Nvarp</span>         <span class="c">!&lt; Dimension of varp, packed data.</span>
  <span class="c">!---------------------------------------------------------------------------------------------------------------------------------</span>

  <span class="c">!---------------------------------------------------------------------------------------------------------------------------------</span>
  <span class="n">E_IO</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1_I4P</span>
  <span class="n">rf</span> <span class="o">=</span> <span class="n">f</span>
  <span class="k">if</span> <span class="p">(</span><span class="nb">present</span><span class="p">(</span><span class="n">cf</span><span class="p">))</span> <span class="k">then</span>
<span class="k">    </span><span class="n">rf</span> <span class="o">=</span> <span class="n">cf</span> <span class="p">;</span> <span class="n">f</span> <span class="o">=</span> <span class="n">cf</span>
  <span class="n">endif</span>
  <span class="k">select case</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">f</span><span class="p">)</span>
  <span class="k">case</span><span class="p">(</span><span class="n">ascii</span><span class="p">)</span>
    <span class="n">s_buffer</span> <span class="o">=</span> <span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;DataArray type=&quot;Int32&quot; Name=&quot;&#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">varname</span><span class="p">)</span><span class="o">//</span><span class="p">&amp;</span>
               <span class="s1">&#39;&quot; NumberOfComponents=&quot;1&quot; format=&quot;ascii&quot;&gt;&#39;</span>
    <span class="k">write</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="s1">&#39;(A)&#39;</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">trim</span><span class="p">(</span><span class="n">s_buffer</span><span class="p">)</span>
    <span class="k">write</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="s1">&#39;(&#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(.</span><span class="n">true</span><span class="p">.,</span><span class="n">NC_NN</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39;A)&#39;</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">),&amp;</span>
                                      <span class="p">(((</span><span class="s1">&#39; &#39;</span><span class="o">//</span><span class="n">str</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">var</span><span class="p">(</span><span class="n">nx</span><span class="p">,</span><span class="n">ny</span><span class="p">,</span><span class="n">nz</span><span class="p">)),</span><span class="n">nx</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">size</span><span class="p">(</span><span class="n">var</span><span class="p">,</span><span class="nb">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)),</span><span class="n">ny</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">size</span><span class="p">(</span><span class="n">var</span><span class="p">,</span><span class="nb">dim</span><span class="o">=</span><span class="mi">2</span><span class="p">)),</span><span class="n">nz</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">size</span><span class="p">(</span><span class="n">var</span><span class="p">,</span><span class="nb">dim</span><span class="o">=</span><span class="mi">3</span><span class="p">))</span>
    <span class="k">write</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="s1">&#39;(A)&#39;</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;/DataArray&gt;&#39;</span>
  <span class="k">case</span><span class="p">(</span><span class="n">raw</span><span class="p">,</span><span class="n">bin_app</span><span class="p">)</span>
    <span class="n">s_buffer</span> <span class="o">=</span> <span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;DataArray type=&quot;Int32&quot; Name=&quot;&#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">varname</span><span class="p">)</span><span class="o">//</span> <span class="p">&amp;</span>
               <span class="s1">&#39;&quot; NumberOfComponents=&quot;1&quot; format=&quot;appended&quot; offset=&quot;&#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(.</span><span class="n">true</span><span class="p">.,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">ioffset</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39;&quot;/&gt;&#39;</span>
    <span class="k">write</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">trim</span><span class="p">(</span><span class="n">s_buffer</span><span class="p">)</span><span class="o">//</span><span class="n">end_rec</span>
    <span class="k">call </span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">byte_update</span><span class="p">(</span><span class="n">N_Byte</span> <span class="o">=</span> <span class="n">NC_NN</span><span class="o">*</span><span class="n">BYI4P</span><span class="p">)</span>
    <span class="k">write</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">ua</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">N_Byte</span><span class="p">,</span><span class="s1">&#39;I4&#39;</span><span class="p">,</span><span class="n">NC_NN</span>
    <span class="k">write</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">ua</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="n">var</span>
  <span class="k">case</span><span class="p">(</span><span class="n">binary</span><span class="p">)</span>
    <span class="n">s_buffer</span><span class="o">=</span><span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;DataArray type=&quot;Int32&quot; Name=&quot;&#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">varname</span><span class="p">)</span><span class="o">//</span> <span class="p">&amp;</span>
             <span class="s1">&#39;&quot; NumberOfComponents=&quot;1&quot; format=&quot;binary&quot;&gt;&#39;</span>
    <span class="k">write</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">trim</span><span class="p">(</span><span class="n">s_buffer</span><span class="p">)</span><span class="o">//</span><span class="n">end_rec</span>
    <span class="n">Nvarp</span><span class="o">=</span><span class="n">size</span><span class="p">(</span><span class="nb">transfer</span><span class="p">([</span><span class="nb">int</span><span class="p">(</span><span class="n">NC_NN</span><span class="o">*</span><span class="n">BYI4P</span><span class="p">,</span><span class="n">I4P</span><span class="p">),</span><span class="nb">reshape</span><span class="p">(</span><span class="n">var</span><span class="p">,[</span><span class="n">NC_NN</span><span class="p">])],</span><span class="n">varp</span><span class="p">),</span><span class="nb">kind</span><span class="o">=</span><span class="n">I8P</span><span class="p">)</span>
    <span class="k">if</span> <span class="p">(</span><span class="nb">allocated</span><span class="p">(</span><span class="n">varp</span><span class="p">))</span> <span class="k">deallocate</span><span class="p">(</span><span class="n">varp</span><span class="p">);</span> <span class="k">allocate</span><span class="p">(</span><span class="n">varp</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">Nvarp</span><span class="p">))</span>
    <span class="n">varp</span> <span class="o">=</span> <span class="nb">transfer</span><span class="p">([</span><span class="nb">int</span><span class="p">(</span><span class="n">NC_NN</span><span class="o">*</span><span class="n">BYI4P</span><span class="p">,</span><span class="n">I4P</span><span class="p">),</span><span class="nb">reshape</span><span class="p">(</span><span class="n">var</span><span class="p">,[</span><span class="n">NC_NN</span><span class="p">])],</span><span class="n">varp</span><span class="p">)</span>
    <span class="k">call </span><span class="n">b64_encode</span><span class="p">(</span><span class="n">nB</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">BYI1P</span><span class="p">,</span><span class="n">I4P</span><span class="p">),</span><span class="n">n</span><span class="o">=</span><span class="n">varp</span><span class="p">,</span><span class="n">code</span><span class="o">=</span><span class="n">var64</span><span class="p">)</span> <span class="p">;</span> <span class="k">deallocate</span><span class="p">(</span><span class="n">varp</span><span class="p">)</span>
    <span class="k">write</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="o">+</span><span class="mi">2</span><span class="p">)</span><span class="o">//</span><span class="n">tochar</span><span class="p">(</span><span class="n">var64</span><span class="p">)</span><span class="o">//</span><span class="n">end_rec</span> <span class="p">;</span> <span class="k">deallocate</span><span class="p">(</span><span class="n">var64</span><span class="p">)</span>
    <span class="k">write</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;/DataArray&gt;&#39;</span><span class="o">//</span><span class="n">end_rec</span>
  <span class="n">endselect</span>
  <span class="k">return</span>
  <span class="c">!---------------------------------------------------------------------------------------------------------------------------------</span>
  <span class="n">endfunction</span> <span class="n">VTK_VAR_XML_SCAL_3DA_I4</span>

  <span class="c">!&gt; Function for saving field of scalar variable (I2P, 1D array).</span>
  <span class="c">!&gt; @return E_IO: integer(I4P) error flag</span>
  <span class="k">function </span><span class="n">VTK_VAR_XML_SCAL_1DA_I2</span><span class="p">(</span><span class="n">NC_NN</span><span class="p">,</span><span class="n">varname</span><span class="p">,</span><span class="n">var</span><span class="p">,</span><span class="n">cf</span><span class="p">)</span> <span class="k">result</span><span class="p">(</span><span class="n">E_IO</span><span class="p">)</span>
  <span class="c">!---------------------------------------------------------------------------------------------------------------------------------</span>
  <span class="k">implicit none</span>
<span class="k">  </span><span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span><span class="kd">::</span>           <span class="n">NC_NN</span>    <span class="c">!&lt; Number of cells or nodes.</span>
  <span class="kt">character</span><span class="p">(</span><span class="o">*</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span><span class="kd">::</span>           <span class="n">varname</span>  <span class="c">!&lt; Variable name.</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I2P</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span><span class="kd">::</span>           <span class="n">var</span><span class="p">(</span><span class="mi">1</span><span class="p">:)</span>  <span class="c">!&lt; Variable to be saved [1:NC_NN].</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">),</span> <span class="k">optional</span><span class="kd">::</span> <span class="n">cf</span>       <span class="c">!&lt; Current file index (for concurrent files IO).</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">)</span><span class="kd">::</span>                       <span class="n">E_IO</span>     <span class="c">!&lt; Input/Output inquiring flag: $0$ if IO is done, $&gt; 0$ if IO is not done.</span>
  <span class="kt">character</span><span class="p">(</span><span class="nb">len</span><span class="o">=</span><span class="n">maxlen</span><span class="p">)</span><span class="kd">::</span>              <span class="n">s_buffer</span> <span class="c">!&lt; Buffer string.</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I1P</span><span class="p">),</span> <span class="k">allocatable</span><span class="kd">::</span>          <span class="n">varp</span><span class="p">(:)</span>  <span class="c">!&lt; Packed data.</span>
  <span class="kt">character</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="k">allocatable</span><span class="kd">::</span>          <span class="n">var64</span><span class="p">(:)</span> <span class="c">!&lt; Variable encoded in base64.</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">)</span><span class="kd">::</span>                       <span class="n">rf</span>       <span class="c">!&lt; Real file index.</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">)</span><span class="kd">::</span>                       <span class="n">n1</span>       <span class="c">!&lt; Counter.</span>
  <span class="c">!---------------------------------------------------------------------------------------------------------------------------------</span>

  <span class="c">!---------------------------------------------------------------------------------------------------------------------------------</span>
  <span class="n">E_IO</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1_I4P</span>
  <span class="n">rf</span> <span class="o">=</span> <span class="n">f</span>
  <span class="k">if</span> <span class="p">(</span><span class="nb">present</span><span class="p">(</span><span class="n">cf</span><span class="p">))</span> <span class="k">then</span>
<span class="k">    </span><span class="n">rf</span> <span class="o">=</span> <span class="n">cf</span> <span class="p">;</span> <span class="n">f</span> <span class="o">=</span> <span class="n">cf</span>
  <span class="n">endif</span>
  <span class="k">select case</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">f</span><span class="p">)</span>
  <span class="k">case</span><span class="p">(</span><span class="n">ascii</span><span class="p">)</span>
    <span class="n">s_buffer</span> <span class="o">=</span> <span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;DataArray type=&quot;Int16&quot; Name=&quot;&#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">varname</span><span class="p">)</span><span class="o">//</span><span class="p">&amp;</span>
               <span class="s1">&#39;&quot; NumberOfComponents=&quot;1&quot; format=&quot;ascii&quot;&gt;&#39;</span>
    <span class="k">write</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="s1">&#39;(A)&#39;</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">trim</span><span class="p">(</span><span class="n">s_buffer</span><span class="p">)</span>
    <span class="k">write</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="s1">&#39;(&#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(.</span><span class="n">true</span><span class="p">.,</span><span class="n">NC_NN</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39;A)&#39;</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">),(</span><span class="s1">&#39; &#39;</span><span class="o">//</span><span class="n">str</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">var</span><span class="p">(</span><span class="n">n1</span><span class="p">)),</span><span class="n">n1</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">NC_NN</span><span class="p">)</span>
    <span class="k">write</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="s1">&#39;(A)&#39;</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;/DataArray&gt;&#39;</span>
  <span class="k">case</span><span class="p">(</span><span class="n">raw</span><span class="p">,</span><span class="n">bin_app</span><span class="p">)</span>
    <span class="n">s_buffer</span> <span class="o">=</span> <span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;DataArray type=&quot;Int16&quot; Name=&quot;&#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">varname</span><span class="p">)</span><span class="o">//</span><span class="p">&amp;</span>
               <span class="s1">&#39;&quot; NumberOfComponents=&quot;1&quot; format=&quot;appended&quot; offset=&quot;&#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(.</span><span class="n">true</span><span class="p">.,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">ioffset</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39;&quot;/&gt;&#39;</span>
    <span class="k">write</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">trim</span><span class="p">(</span><span class="n">s_buffer</span><span class="p">)</span><span class="o">//</span><span class="n">end_rec</span>
    <span class="k">call </span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">byte_update</span><span class="p">(</span><span class="n">N_Byte</span> <span class="o">=</span> <span class="n">NC_NN</span><span class="o">*</span><span class="n">BYI2P</span><span class="p">)</span>
    <span class="k">write</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">ua</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">N_Byte</span><span class="p">,</span><span class="s1">&#39;I2&#39;</span><span class="p">,</span><span class="n">NC_NN</span>
    <span class="k">write</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">ua</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="n">var</span>
  <span class="k">case</span><span class="p">(</span><span class="n">binary</span><span class="p">)</span>
    <span class="n">s_buffer</span><span class="o">=</span><span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;DataArray type=&quot;Int16&quot; Name=&quot;&#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">varname</span><span class="p">)</span><span class="o">//</span><span class="p">&amp;</span>
             <span class="s1">&#39;&quot; NumberOfComponents=&quot;1&quot; format=&quot;binary&quot;&gt;&#39;</span>
    <span class="k">write</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">trim</span><span class="p">(</span><span class="n">s_buffer</span><span class="p">)</span><span class="o">//</span><span class="n">end_rec</span>
    <span class="k">call </span><span class="n">pack_data</span><span class="p">(</span><span class="n">a1</span><span class="o">=</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">NC_NN</span><span class="o">*</span><span class="n">BYI2P</span><span class="p">,</span><span class="n">I4P</span><span class="p">)],</span><span class="n">a2</span><span class="o">=</span><span class="n">var</span><span class="p">,</span><span class="n">packed</span><span class="o">=</span><span class="n">varp</span><span class="p">)</span>
    <span class="k">call </span><span class="n">b64_encode</span><span class="p">(</span><span class="n">nB</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">BYI1P</span><span class="p">,</span><span class="n">I4P</span><span class="p">),</span><span class="n">n</span><span class="o">=</span><span class="n">varp</span><span class="p">,</span><span class="n">code</span><span class="o">=</span><span class="n">var64</span><span class="p">)</span> <span class="p">;</span> <span class="k">deallocate</span><span class="p">(</span><span class="n">varp</span><span class="p">)</span>
    <span class="k">write</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="o">+</span><span class="mi">2</span><span class="p">)</span><span class="o">//</span><span class="n">tochar</span><span class="p">(</span><span class="n">var64</span><span class="p">)</span><span class="o">//</span><span class="n">end_rec</span> <span class="p">;</span> <span class="k">deallocate</span><span class="p">(</span><span class="n">var64</span><span class="p">)</span>
    <span class="k">write</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;/DataArray&gt;&#39;</span><span class="o">//</span><span class="n">end_rec</span>
  <span class="n">endselect</span>
  <span class="k">return</span>
  <span class="c">!---------------------------------------------------------------------------------------------------------------------------------</span>
  <span class="n">endfunction</span> <span class="n">VTK_VAR_XML_SCAL_1DA_I2</span>

  <span class="c">!&gt; Function for saving field of scalar variable (I2P, 3D array).</span>
  <span class="c">!&gt; @return E_IO: integer(I4P) error flag</span>
  <span class="k">function </span><span class="n">VTK_VAR_XML_SCAL_3DA_I2</span><span class="p">(</span><span class="n">NC_NN</span><span class="p">,</span><span class="n">varname</span><span class="p">,</span><span class="n">var</span><span class="p">,</span><span class="n">cf</span><span class="p">)</span> <span class="k">result</span><span class="p">(</span><span class="n">E_IO</span><span class="p">)</span>
  <span class="c">!---------------------------------------------------------------------------------------------------------------------------------</span>
  <span class="k">implicit none</span>
<span class="k">  </span><span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span><span class="kd">::</span>           <span class="n">NC_NN</span>         <span class="c">!&lt; Number of cells or nodes.</span>
  <span class="kt">character</span><span class="p">(</span><span class="o">*</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span><span class="kd">::</span>           <span class="n">varname</span>       <span class="c">!&lt; Variable name.</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I2P</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span><span class="kd">::</span>           <span class="n">var</span><span class="p">(</span><span class="mi">1</span><span class="p">:,</span><span class="mi">1</span><span class="p">:,</span><span class="mi">1</span><span class="p">:)</span> <span class="c">!&lt; Variable to be saved [1:Nx,1:Ny,1:Nz].</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">),</span> <span class="k">optional</span><span class="kd">::</span> <span class="n">cf</span>            <span class="c">!&lt; Current file index (for concurrent files IO).</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">)</span><span class="kd">::</span>                       <span class="n">E_IO</span>          <span class="c">!&lt; Input/Output inquiring flag: $0$ if IO is done, $&gt; 0$ if IO is not done.</span>
  <span class="kt">character</span><span class="p">(</span><span class="nb">len</span><span class="o">=</span><span class="n">maxlen</span><span class="p">)</span><span class="kd">::</span>              <span class="n">s_buffer</span>      <span class="c">!&lt; Buffer string.</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I1P</span><span class="p">),</span> <span class="k">allocatable</span><span class="kd">::</span>          <span class="n">varp</span><span class="p">(:)</span>       <span class="c">!&lt; Packed data.</span>
  <span class="kt">character</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="k">allocatable</span><span class="kd">::</span>          <span class="n">var64</span><span class="p">(:)</span>      <span class="c">!&lt; Variable encoded in base64.</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">)</span><span class="kd">::</span>                       <span class="n">rf</span>            <span class="c">!&lt; Real file index.</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">)</span><span class="kd">::</span>                       <span class="n">nx</span><span class="p">,</span><span class="n">ny</span><span class="p">,</span><span class="n">nz</span>      <span class="c">!&lt; Counters.</span>
  <span class="c">!---------------------------------------------------------------------------------------------------------------------------------</span>

  <span class="c">!---------------------------------------------------------------------------------------------------------------------------------</span>
  <span class="n">E_IO</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1_I4P</span>
  <span class="n">rf</span> <span class="o">=</span> <span class="n">f</span>
  <span class="k">if</span> <span class="p">(</span><span class="nb">present</span><span class="p">(</span><span class="n">cf</span><span class="p">))</span> <span class="k">then</span>
<span class="k">    </span><span class="n">rf</span> <span class="o">=</span> <span class="n">cf</span> <span class="p">;</span> <span class="n">f</span> <span class="o">=</span> <span class="n">cf</span>
  <span class="n">endif</span>
  <span class="k">select case</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">f</span><span class="p">)</span>
  <span class="k">case</span><span class="p">(</span><span class="n">ascii</span><span class="p">)</span>
    <span class="n">s_buffer</span> <span class="o">=</span> <span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;DataArray type=&quot;Int16&quot; Name=&quot;&#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">varname</span><span class="p">)</span><span class="o">//</span><span class="p">&amp;</span>
               <span class="s1">&#39;&quot; NumberOfComponents=&quot;1&quot; format=&quot;ascii&quot;&gt;&#39;</span>
    <span class="k">write</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="s1">&#39;(A)&#39;</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">trim</span><span class="p">(</span><span class="n">s_buffer</span><span class="p">)</span>
    <span class="k">write</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="s1">&#39;(&#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(.</span><span class="n">true</span><span class="p">.,</span><span class="n">NC_NN</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39;A)&#39;</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">),&amp;</span>
                                      <span class="p">(((</span><span class="s1">&#39; &#39;</span><span class="o">//</span><span class="n">str</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">var</span><span class="p">(</span><span class="n">nx</span><span class="p">,</span><span class="n">ny</span><span class="p">,</span><span class="n">nz</span><span class="p">)),</span><span class="n">nx</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">size</span><span class="p">(</span><span class="n">var</span><span class="p">,</span><span class="nb">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)),</span><span class="n">ny</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">size</span><span class="p">(</span><span class="n">var</span><span class="p">,</span><span class="nb">dim</span><span class="o">=</span><span class="mi">2</span><span class="p">)),</span><span class="n">nz</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">size</span><span class="p">(</span><span class="n">var</span><span class="p">,</span><span class="nb">dim</span><span class="o">=</span><span class="mi">3</span><span class="p">))</span>
    <span class="k">write</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="s1">&#39;(A)&#39;</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;/DataArray&gt;&#39;</span>
  <span class="k">case</span><span class="p">(</span><span class="n">raw</span><span class="p">,</span><span class="n">bin_app</span><span class="p">)</span>
    <span class="n">s_buffer</span> <span class="o">=</span> <span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;DataArray type=&quot;Int16&quot; Name=&quot;&#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">varname</span><span class="p">)</span><span class="o">//</span><span class="p">&amp;</span>
               <span class="s1">&#39;&quot; NumberOfComponents=&quot;1&quot; format=&quot;appended&quot; offset=&quot;&#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(.</span><span class="n">true</span><span class="p">.,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">ioffset</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39;&quot;/&gt;&#39;</span>
    <span class="k">write</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">trim</span><span class="p">(</span><span class="n">s_buffer</span><span class="p">)</span><span class="o">//</span><span class="n">end_rec</span>
    <span class="k">call </span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">byte_update</span><span class="p">(</span><span class="n">N_Byte</span> <span class="o">=</span> <span class="n">NC_NN</span><span class="o">*</span><span class="n">BYI2P</span><span class="p">)</span>
    <span class="k">write</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">ua</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">N_Byte</span><span class="p">,</span><span class="s1">&#39;I2&#39;</span><span class="p">,</span><span class="n">NC_NN</span>
    <span class="k">write</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">ua</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="n">var</span>
  <span class="k">case</span><span class="p">(</span><span class="n">binary</span><span class="p">)</span>
    <span class="n">s_buffer</span><span class="o">=</span><span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;DataArray type=&quot;Int16&quot; Name=&quot;&#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">varname</span><span class="p">)</span><span class="o">//</span><span class="p">&amp;</span>
             <span class="s1">&#39;&quot; NumberOfComponents=&quot;1&quot; format=&quot;binary&quot;&gt;&#39;</span>
    <span class="k">write</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">trim</span><span class="p">(</span><span class="n">s_buffer</span><span class="p">)</span><span class="o">//</span><span class="n">end_rec</span>
    <span class="k">call </span><span class="n">pack_data</span><span class="p">(</span><span class="n">a1</span><span class="o">=</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">NC_NN</span><span class="o">*</span><span class="n">BYI2P</span><span class="p">,</span><span class="n">I4P</span><span class="p">)],</span><span class="n">a2</span><span class="o">=</span><span class="nb">reshape</span><span class="p">(</span><span class="n">var</span><span class="p">,[</span><span class="n">NC_NN</span><span class="p">]),</span><span class="n">packed</span><span class="o">=</span><span class="n">varp</span><span class="p">)</span>
    <span class="k">call </span><span class="n">b64_encode</span><span class="p">(</span><span class="n">nB</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">BYI1P</span><span class="p">,</span><span class="n">I4P</span><span class="p">),</span><span class="n">n</span><span class="o">=</span><span class="n">varp</span><span class="p">,</span><span class="n">code</span><span class="o">=</span><span class="n">var64</span><span class="p">)</span> <span class="p">;</span> <span class="k">deallocate</span><span class="p">(</span><span class="n">varp</span><span class="p">)</span>
    <span class="k">write</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="o">+</span><span class="mi">2</span><span class="p">)</span><span class="o">//</span><span class="n">tochar</span><span class="p">(</span><span class="n">var64</span><span class="p">)</span><span class="o">//</span><span class="n">end_rec</span> <span class="p">;</span> <span class="k">deallocate</span><span class="p">(</span><span class="n">var64</span><span class="p">)</span>
    <span class="k">write</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;/DataArray&gt;&#39;</span><span class="o">//</span><span class="n">end_rec</span>
  <span class="n">endselect</span>
  <span class="k">return</span>
  <span class="c">!---------------------------------------------------------------------------------------------------------------------------------</span>
  <span class="n">endfunction</span> <span class="n">VTK_VAR_XML_SCAL_3DA_I2</span>

  <span class="c">!&gt; Function for saving field of scalar variable (I1P, 1D array).</span>
  <span class="c">!&gt; @return E_IO: integer(I4P) error flag</span>
  <span class="k">function </span><span class="n">VTK_VAR_XML_SCAL_1DA_I1</span><span class="p">(</span><span class="n">NC_NN</span><span class="p">,</span><span class="n">varname</span><span class="p">,</span><span class="n">var</span><span class="p">,</span><span class="n">cf</span><span class="p">)</span> <span class="k">result</span><span class="p">(</span><span class="n">E_IO</span><span class="p">)</span>
  <span class="c">!---------------------------------------------------------------------------------------------------------------------------------</span>
  <span class="k">implicit none</span>
<span class="k">  </span><span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span><span class="kd">::</span>           <span class="n">NC_NN</span>    <span class="c">!&lt; Number of cells or nodes.</span>
  <span class="kt">character</span><span class="p">(</span><span class="o">*</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span><span class="kd">::</span>           <span class="n">varname</span>  <span class="c">!&lt; Variable name.</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I1P</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span><span class="kd">::</span>           <span class="n">var</span><span class="p">(</span><span class="mi">1</span><span class="p">:)</span>  <span class="c">!&lt; Variable to be saved [1:NC_NN].</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">),</span> <span class="k">optional</span><span class="kd">::</span> <span class="n">cf</span>       <span class="c">!&lt; Current file index (for concurrent files IO).</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">)</span><span class="kd">::</span>                       <span class="n">E_IO</span>     <span class="c">!&lt; Input/Output inquiring flag: $0$ if IO is done, $&gt; 0$ if IO is not done.</span>
  <span class="kt">character</span><span class="p">(</span><span class="nb">len</span><span class="o">=</span><span class="n">maxlen</span><span class="p">)</span><span class="kd">::</span>              <span class="n">s_buffer</span> <span class="c">!&lt; Buffer string.</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I1P</span><span class="p">),</span> <span class="k">allocatable</span><span class="kd">::</span>          <span class="n">varp</span><span class="p">(:)</span>  <span class="c">!&lt; Packed data.</span>
  <span class="kt">character</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="k">allocatable</span><span class="kd">::</span>          <span class="n">var64</span><span class="p">(:)</span> <span class="c">!&lt; Variable encoded in base64.</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">)</span><span class="kd">::</span>                       <span class="n">rf</span>       <span class="c">!&lt; Real file index.</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">)</span><span class="kd">::</span>                       <span class="n">n1</span>       <span class="c">!&lt; Counter.</span>
  <span class="c">!---------------------------------------------------------------------------------------------------------------------------------</span>

  <span class="c">!---------------------------------------------------------------------------------------------------------------------------------</span>
  <span class="n">E_IO</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1_I4P</span>
  <span class="n">rf</span> <span class="o">=</span> <span class="n">f</span>
  <span class="k">if</span> <span class="p">(</span><span class="nb">present</span><span class="p">(</span><span class="n">cf</span><span class="p">))</span> <span class="k">then</span>
<span class="k">    </span><span class="n">rf</span> <span class="o">=</span> <span class="n">cf</span> <span class="p">;</span> <span class="n">f</span> <span class="o">=</span> <span class="n">cf</span>
  <span class="n">endif</span>
  <span class="k">select case</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">f</span><span class="p">)</span>
  <span class="k">case</span><span class="p">(</span><span class="n">ascii</span><span class="p">)</span>
    <span class="n">s_buffer</span><span class="o">=</span><span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;DataArray type=&quot;Int8&quot; Name=&quot;&#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">varname</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&quot; NumberOfComponents=&quot;1&quot; format=&quot;ascii&quot;&gt;&#39;</span>
    <span class="k">write</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="s1">&#39;(A)&#39;</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">trim</span><span class="p">(</span><span class="n">s_buffer</span><span class="p">)</span>
    <span class="k">write</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="s1">&#39;(&#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(.</span><span class="n">true</span><span class="p">.,</span><span class="n">NC_NN</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39;A)&#39;</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">),(</span><span class="s1">&#39; &#39;</span><span class="o">//</span><span class="n">str</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">var</span><span class="p">(</span><span class="n">n1</span><span class="p">)),</span><span class="n">n1</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">NC_NN</span><span class="p">)</span>
    <span class="k">write</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="s1">&#39;(A)&#39;</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;/DataArray&gt;&#39;</span>
  <span class="k">case</span><span class="p">(</span><span class="n">raw</span><span class="p">,</span><span class="n">bin_app</span><span class="p">)</span>
    <span class="n">s_buffer</span><span class="o">=</span><span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;DataArray type=&quot;Int8&quot; Name=&quot;&#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">varname</span><span class="p">)</span><span class="o">//</span><span class="p">&amp;</span>
             <span class="s1">&#39;&quot; NumberOfComponents=&quot;1&quot; format=&quot;appended&quot; offset=&quot;&#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(.</span><span class="n">true</span><span class="p">.,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">ioffset</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39;&quot;/&gt;&#39;</span>
    <span class="k">write</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">trim</span><span class="p">(</span><span class="n">s_buffer</span><span class="p">)</span><span class="o">//</span><span class="n">end_rec</span>
    <span class="k">call </span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">byte_update</span><span class="p">(</span><span class="n">N_Byte</span> <span class="o">=</span> <span class="n">NC_NN</span><span class="o">*</span><span class="n">BYI1P</span><span class="p">)</span>
    <span class="k">write</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">ua</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">N_Byte</span><span class="p">,</span><span class="s1">&#39;I1&#39;</span><span class="p">,</span><span class="n">NC_NN</span>
    <span class="k">write</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">ua</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="n">var</span>
  <span class="k">case</span><span class="p">(</span><span class="n">binary</span><span class="p">)</span>
    <span class="n">s_buffer</span><span class="o">=</span><span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;DataArray type=&quot;Int8&quot; Name=&quot;&#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">varname</span><span class="p">)</span><span class="o">//</span><span class="p">&amp;</span>
             <span class="s1">&#39;&quot; NumberOfComponents=&quot;1&quot; format=&quot;binary&quot;&gt;&#39;</span>
    <span class="k">write</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">trim</span><span class="p">(</span><span class="n">s_buffer</span><span class="p">)</span><span class="o">//</span><span class="n">end_rec</span>
    <span class="k">call </span><span class="n">pack_data</span><span class="p">(</span><span class="n">a1</span><span class="o">=</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">NC_NN</span><span class="o">*</span><span class="n">BYI1P</span><span class="p">,</span><span class="n">I4P</span><span class="p">)],</span><span class="n">a2</span><span class="o">=</span><span class="n">var</span><span class="p">,</span><span class="n">packed</span><span class="o">=</span><span class="n">varp</span><span class="p">)</span>
    <span class="k">call </span><span class="n">b64_encode</span><span class="p">(</span><span class="n">nB</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">BYI1P</span><span class="p">,</span><span class="n">I4P</span><span class="p">),</span><span class="n">n</span><span class="o">=</span><span class="n">varp</span><span class="p">,</span><span class="n">code</span><span class="o">=</span><span class="n">var64</span><span class="p">)</span> <span class="p">;</span> <span class="k">deallocate</span><span class="p">(</span><span class="n">varp</span><span class="p">)</span>
    <span class="k">write</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="o">+</span><span class="mi">2</span><span class="p">)</span><span class="o">//</span><span class="n">tochar</span><span class="p">(</span><span class="n">var64</span><span class="p">)</span><span class="o">//</span><span class="n">end_rec</span> <span class="p">;</span> <span class="k">deallocate</span><span class="p">(</span><span class="n">var64</span><span class="p">)</span>
    <span class="k">write</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;/DataArray&gt;&#39;</span><span class="o">//</span><span class="n">end_rec</span>
  <span class="n">endselect</span>
  <span class="k">return</span>
  <span class="c">!---------------------------------------------------------------------------------------------------------------------------------</span>
  <span class="n">endfunction</span> <span class="n">VTK_VAR_XML_SCAL_1DA_I1</span>

  <span class="c">!&gt; Function for saving field of scalar variable (I1P, 3D array).</span>
  <span class="c">!&gt; @return E_IO: integer(I4P) error flag</span>
  <span class="k">function </span><span class="n">VTK_VAR_XML_SCAL_3DA_I1</span><span class="p">(</span><span class="n">NC_NN</span><span class="p">,</span><span class="n">varname</span><span class="p">,</span><span class="n">var</span><span class="p">,</span><span class="n">cf</span><span class="p">)</span> <span class="k">result</span><span class="p">(</span><span class="n">E_IO</span><span class="p">)</span>
  <span class="c">!---------------------------------------------------------------------------------------------------------------------------------</span>
  <span class="k">implicit none</span>
<span class="k">  </span><span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span><span class="kd">::</span>           <span class="n">NC_NN</span>         <span class="c">!&lt; Number of cells or nodes.</span>
  <span class="kt">character</span><span class="p">(</span><span class="o">*</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span><span class="kd">::</span>           <span class="n">varname</span>       <span class="c">!&lt; Variable name.</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I1P</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span><span class="kd">::</span>           <span class="n">var</span><span class="p">(</span><span class="mi">1</span><span class="p">:,</span><span class="mi">1</span><span class="p">:,</span><span class="mi">1</span><span class="p">:)</span> <span class="c">!&lt; Variable to be saved [1:Nx,1:ny,1:Nz].</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">),</span> <span class="k">optional</span><span class="kd">::</span> <span class="n">cf</span>            <span class="c">!&lt; Current file index (for concurrent files IO).</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">)</span><span class="kd">::</span>                       <span class="n">E_IO</span>          <span class="c">!&lt; Input/Output inquiring flag: $0$ if IO is done, $&gt; 0$ if IO is not done.</span>
  <span class="kt">character</span><span class="p">(</span><span class="nb">len</span><span class="o">=</span><span class="n">maxlen</span><span class="p">)</span><span class="kd">::</span>              <span class="n">s_buffer</span>      <span class="c">!&lt; Buffer string.</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I1P</span><span class="p">),</span> <span class="k">allocatable</span><span class="kd">::</span>          <span class="n">varp</span><span class="p">(:)</span>       <span class="c">!&lt; Packed data.</span>
  <span class="kt">character</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="k">allocatable</span><span class="kd">::</span>          <span class="n">var64</span><span class="p">(:)</span>      <span class="c">!&lt; Variable encoded in base64.</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">)</span><span class="kd">::</span>                       <span class="n">rf</span>            <span class="c">!&lt; Real file index.</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">)</span><span class="kd">::</span>                       <span class="n">nx</span><span class="p">,</span><span class="n">ny</span><span class="p">,</span><span class="n">nz</span>      <span class="c">!&lt; Counters.</span>
  <span class="c">!---------------------------------------------------------------------------------------------------------------------------------</span>

  <span class="c">!---------------------------------------------------------------------------------------------------------------------------------</span>
  <span class="n">E_IO</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1_I4P</span>
  <span class="n">rf</span> <span class="o">=</span> <span class="n">f</span>
  <span class="k">if</span> <span class="p">(</span><span class="nb">present</span><span class="p">(</span><span class="n">cf</span><span class="p">))</span> <span class="k">then</span>
<span class="k">    </span><span class="n">rf</span> <span class="o">=</span> <span class="n">cf</span> <span class="p">;</span> <span class="n">f</span> <span class="o">=</span> <span class="n">cf</span>
  <span class="n">endif</span>
  <span class="k">select case</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">f</span><span class="p">)</span>
  <span class="k">case</span><span class="p">(</span><span class="n">ascii</span><span class="p">)</span>
    <span class="n">s_buffer</span><span class="o">=</span><span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;DataArray type=&quot;Int8&quot; Name=&quot;&#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">varname</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&quot; NumberOfComponents=&quot;1&quot; format=&quot;ascii&quot;&gt;&#39;</span>
    <span class="k">write</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="s1">&#39;(A)&#39;</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">trim</span><span class="p">(</span><span class="n">s_buffer</span><span class="p">)</span>
    <span class="k">write</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="s1">&#39;(&#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(.</span><span class="n">true</span><span class="p">.,</span><span class="n">NC_NN</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39;A)&#39;</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">),&amp;</span>
                                      <span class="p">(((</span><span class="s1">&#39; &#39;</span><span class="o">//</span><span class="n">str</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">var</span><span class="p">(</span><span class="n">nx</span><span class="p">,</span><span class="n">ny</span><span class="p">,</span><span class="n">nz</span><span class="p">)),</span><span class="n">nx</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">size</span><span class="p">(</span><span class="n">var</span><span class="p">,</span><span class="nb">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)),</span><span class="n">ny</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">size</span><span class="p">(</span><span class="n">var</span><span class="p">,</span><span class="nb">dim</span><span class="o">=</span><span class="mi">2</span><span class="p">)),</span><span class="n">nz</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">size</span><span class="p">(</span><span class="n">var</span><span class="p">,</span><span class="nb">dim</span><span class="o">=</span><span class="mi">3</span><span class="p">))</span>
    <span class="k">write</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="s1">&#39;(A)&#39;</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;/DataArray&gt;&#39;</span>
  <span class="k">case</span><span class="p">(</span><span class="n">raw</span><span class="p">,</span><span class="n">bin_app</span><span class="p">)</span>
    <span class="n">s_buffer</span><span class="o">=</span><span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;DataArray type=&quot;Int8&quot; Name=&quot;&#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">varname</span><span class="p">)</span><span class="o">//</span><span class="p">&amp;</span>
             <span class="s1">&#39;&quot; NumberOfComponents=&quot;1&quot; format=&quot;appended&quot; offset=&quot;&#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(.</span><span class="n">true</span><span class="p">.,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">ioffset</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39;&quot;/&gt;&#39;</span>
    <span class="k">write</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">trim</span><span class="p">(</span><span class="n">s_buffer</span><span class="p">)</span><span class="o">//</span><span class="n">end_rec</span>
    <span class="k">call </span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">byte_update</span><span class="p">(</span><span class="n">N_Byte</span> <span class="o">=</span> <span class="n">NC_NN</span><span class="o">*</span><span class="n">BYI1P</span><span class="p">)</span>
    <span class="k">write</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">ua</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">N_Byte</span><span class="p">,</span><span class="s1">&#39;I1&#39;</span><span class="p">,</span><span class="n">NC_NN</span>
    <span class="k">write</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">ua</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="n">var</span>
  <span class="k">case</span><span class="p">(</span><span class="n">binary</span><span class="p">)</span>
    <span class="n">s_buffer</span><span class="o">=</span><span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;DataArray type=&quot;Int8&quot; Name=&quot;&#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">varname</span><span class="p">)</span><span class="o">//</span><span class="p">&amp;</span>
             <span class="s1">&#39;&quot; NumberOfComponents=&quot;1&quot; format=&quot;binary&quot;&gt;&#39;</span>
    <span class="k">write</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">trim</span><span class="p">(</span><span class="n">s_buffer</span><span class="p">)</span><span class="o">//</span><span class="n">end_rec</span>
    <span class="k">call </span><span class="n">pack_data</span><span class="p">(</span><span class="n">a1</span><span class="o">=</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">NC_NN</span><span class="o">*</span><span class="n">BYI1P</span><span class="p">,</span><span class="n">I4P</span><span class="p">)],</span><span class="n">a2</span><span class="o">=</span><span class="nb">reshape</span><span class="p">(</span><span class="n">var</span><span class="p">,[</span><span class="n">NC_NN</span><span class="p">]),</span><span class="n">packed</span><span class="o">=</span><span class="n">varp</span><span class="p">)</span>
    <span class="k">call </span><span class="n">b64_encode</span><span class="p">(</span><span class="n">nB</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">BYI1P</span><span class="p">,</span><span class="n">I4P</span><span class="p">),</span><span class="n">n</span><span class="o">=</span><span class="n">varp</span><span class="p">,</span><span class="n">code</span><span class="o">=</span><span class="n">var64</span><span class="p">)</span> <span class="p">;</span> <span class="k">deallocate</span><span class="p">(</span><span class="n">varp</span><span class="p">)</span>
    <span class="k">write</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="o">+</span><span class="mi">2</span><span class="p">)</span><span class="o">//</span><span class="n">tochar</span><span class="p">(</span><span class="n">var64</span><span class="p">)</span><span class="o">//</span><span class="n">end_rec</span> <span class="p">;</span> <span class="k">deallocate</span><span class="p">(</span><span class="n">var64</span><span class="p">)</span>
    <span class="k">write</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;/DataArray&gt;&#39;</span><span class="o">//</span><span class="n">end_rec</span>
  <span class="n">endselect</span>
  <span class="k">return</span>
  <span class="c">!---------------------------------------------------------------------------------------------------------------------------------</span>
  <span class="n">endfunction</span> <span class="n">VTK_VAR_XML_SCAL_3DA_I1</span>

  <span class="c">!&gt; Function for saving field of vectorial variable (R8P, 1D arrays).</span>
  <span class="c">!&gt; @return E_IO: integer(I4P) error flag</span>
  <span class="k">function </span><span class="n">VTK_VAR_XML_VECT_1DA_R8</span><span class="p">(</span><span class="n">NC_NN</span><span class="p">,</span><span class="n">varname</span><span class="p">,</span><span class="n">varX</span><span class="p">,</span><span class="n">varY</span><span class="p">,</span><span class="n">varZ</span><span class="p">,</span><span class="n">cf</span><span class="p">)</span> <span class="k">result</span><span class="p">(</span><span class="n">E_IO</span><span class="p">)</span>
  <span class="c">!---------------------------------------------------------------------------------------------------------------------------------</span>
  <span class="k">implicit none</span>
<span class="k">  </span><span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span><span class="kd">::</span>           <span class="n">NC_NN</span>    <span class="c">!&lt; Number of cells or nodes.</span>
  <span class="kt">character</span><span class="p">(</span><span class="o">*</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span><span class="kd">::</span>           <span class="n">varname</span>  <span class="c">!&lt; Variable name.</span>
  <span class="kt">real</span><span class="p">(</span><span class="n">R8P</span><span class="p">),</span>    <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span><span class="kd">::</span>           <span class="n">varX</span><span class="p">(</span><span class="mi">1</span><span class="p">:)</span> <span class="c">!&lt; X component [1:NC_NN].</span>
  <span class="kt">real</span><span class="p">(</span><span class="n">R8P</span><span class="p">),</span>    <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span><span class="kd">::</span>           <span class="n">varY</span><span class="p">(</span><span class="mi">1</span><span class="p">:)</span> <span class="c">!&lt; Y component [1:NC_NN].</span>
  <span class="kt">real</span><span class="p">(</span><span class="n">R8P</span><span class="p">),</span>    <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span><span class="kd">::</span>           <span class="n">varZ</span><span class="p">(</span><span class="mi">1</span><span class="p">:)</span> <span class="c">!&lt; Z component [1:NC_NN].</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">),</span> <span class="k">optional</span><span class="kd">::</span> <span class="n">cf</span>       <span class="c">!&lt; Current file index (for concurrent files IO).</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">)</span><span class="kd">::</span>                       <span class="n">E_IO</span>     <span class="c">!&lt; Input/Output inquiring flag: $0$ if IO is done, $&gt; 0$ if IO is not done.</span>
  <span class="kt">character</span><span class="p">(</span><span class="nb">len</span><span class="o">=</span><span class="n">maxlen</span><span class="p">)</span><span class="kd">::</span>              <span class="n">s_buffer</span> <span class="c">!&lt; Buffer string.</span>
  <span class="kt">real</span><span class="p">(</span><span class="n">R8P</span><span class="p">),</span>    <span class="k">allocatable</span><span class="kd">::</span>          <span class="n">var</span><span class="p">(:)</span>   <span class="c">!&lt; X, Y, Z component.</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I1P</span><span class="p">),</span> <span class="k">allocatable</span><span class="kd">::</span>          <span class="n">varp</span><span class="p">(:)</span>  <span class="c">!&lt; Packed data.</span>
  <span class="kt">character</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="k">allocatable</span><span class="kd">::</span>          <span class="n">var64</span><span class="p">(:)</span> <span class="c">!&lt; Variable encoded in base64.</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">)</span><span class="kd">::</span>                       <span class="n">rf</span>       <span class="c">!&lt; Real file index.</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">)</span><span class="kd">::</span>                       <span class="n">n1</span>       <span class="c">!&lt; Counter.</span>
  <span class="c">!---------------------------------------------------------------------------------------------------------------------------------</span>

  <span class="c">!---------------------------------------------------------------------------------------------------------------------------------</span>
  <span class="n">E_IO</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1_I4P</span>
  <span class="n">rf</span> <span class="o">=</span> <span class="n">f</span>
  <span class="k">if</span> <span class="p">(</span><span class="nb">present</span><span class="p">(</span><span class="n">cf</span><span class="p">))</span> <span class="k">then</span>
<span class="k">    </span><span class="n">rf</span> <span class="o">=</span> <span class="n">cf</span> <span class="p">;</span> <span class="n">f</span> <span class="o">=</span> <span class="n">cf</span>
  <span class="n">endif</span>
  <span class="k">select case</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">f</span><span class="p">)</span>
  <span class="k">case</span><span class="p">(</span><span class="n">ascii</span><span class="p">)</span>
    <span class="n">s_buffer</span> <span class="o">=</span> <span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;DataArray type=&quot;Float64&quot; Name=&quot;&#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">varname</span><span class="p">)</span><span class="o">//</span><span class="p">&amp;</span>
               <span class="s1">&#39;&quot; NumberOfComponents=&quot;3&quot; format=&quot;ascii&quot;&gt;&#39;</span>
    <span class="k">write</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="s1">&#39;(A)&#39;</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">trim</span><span class="p">(</span><span class="n">s_buffer</span><span class="p">)</span>
    <span class="k">do </span><span class="n">n1</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">NC_NN</span>
      <span class="k">write</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="s1">&#39;(A)&#39;</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="n">str</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">varX</span><span class="p">(</span><span class="n">n1</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39; &#39;</span><span class="o">//</span><span class="n">str</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">varY</span><span class="p">(</span><span class="n">n1</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39; &#39;</span><span class="o">//</span><span class="n">str</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">varZ</span><span class="p">(</span><span class="n">n1</span><span class="p">))</span>
    <span class="n">enddo</span>
    <span class="k">write</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="s1">&#39;(A)&#39;</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;/DataArray&gt;&#39;</span>
  <span class="k">case</span><span class="p">(</span><span class="n">raw</span><span class="p">,</span><span class="n">bin_app</span><span class="p">)</span>
    <span class="n">s_buffer</span> <span class="o">=</span> <span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;DataArray type=&quot;Float64&quot; Name=&quot;&#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">varname</span><span class="p">)</span><span class="o">//</span><span class="p">&amp;</span>
               <span class="s1">&#39;&quot; NumberOfComponents=&quot;3&quot; format=&quot;appended&quot; offset=&quot;&#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(.</span><span class="n">true</span><span class="p">.,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">ioffset</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39;&quot;/&gt;&#39;</span>
    <span class="k">write</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">trim</span><span class="p">(</span><span class="n">s_buffer</span><span class="p">)</span><span class="o">//</span><span class="n">end_rec</span>
    <span class="k">call </span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">byte_update</span><span class="p">(</span><span class="n">N_Byte</span> <span class="o">=</span> <span class="mi">3</span><span class="o">*</span><span class="n">NC_NN</span><span class="o">*</span><span class="n">BYR8P</span><span class="p">)</span>
    <span class="k">write</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">ua</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">N_Byte</span><span class="p">,</span><span class="s1">&#39;R8&#39;</span><span class="p">,</span><span class="mi">3</span><span class="o">*</span><span class="n">NC_NN</span>
    <span class="k">write</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">ua</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)(</span><span class="n">varX</span><span class="p">(</span><span class="n">n1</span><span class="p">),</span><span class="n">varY</span><span class="p">(</span><span class="n">n1</span><span class="p">),</span><span class="n">varZ</span><span class="p">(</span><span class="n">n1</span><span class="p">),</span><span class="n">n1</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">NC_NN</span><span class="p">)</span>
  <span class="k">case</span><span class="p">(</span><span class="n">binary</span><span class="p">)</span>
    <span class="n">s_buffer</span> <span class="o">=</span> <span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;DataArray type=&quot;Float64&quot; Name=&quot;&#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">varname</span><span class="p">)</span><span class="o">//</span><span class="p">&amp;</span>
               <span class="s1">&#39;&quot; NumberOfComponents=&quot;3&quot; format=&quot;binary&quot;&gt;&#39;</span>
    <span class="k">write</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">trim</span><span class="p">(</span><span class="n">s_buffer</span><span class="p">)</span><span class="o">//</span><span class="n">end_rec</span>
    <span class="k">allocate</span><span class="p">(</span><span class="n">var</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="o">*</span><span class="n">NC_NN</span><span class="p">))</span>
    <span class="k">do </span><span class="n">n1</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">NC_NN</span>
      <span class="n">var</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="p">(</span><span class="n">n1</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="mi">3</span><span class="p">:</span><span class="mi">1</span><span class="o">+</span><span class="p">(</span><span class="n">n1</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="mi">3</span><span class="o">+</span><span class="mi">2</span><span class="p">)</span><span class="o">=</span><span class="p">[</span><span class="n">varX</span><span class="p">(</span><span class="n">n1</span><span class="p">),</span><span class="n">varY</span><span class="p">(</span><span class="n">n1</span><span class="p">),</span><span class="n">varZ</span><span class="p">(</span><span class="n">n1</span><span class="p">)]</span>
    <span class="n">enddo</span>
    <span class="k">call </span><span class="n">pack_data</span><span class="p">(</span><span class="n">a1</span><span class="o">=</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="mi">3</span><span class="o">*</span><span class="n">NC_NN</span><span class="o">*</span><span class="n">BYR8P</span><span class="p">,</span><span class="n">I4P</span><span class="p">)],</span><span class="n">a2</span><span class="o">=</span><span class="n">var</span><span class="p">,</span><span class="n">packed</span><span class="o">=</span><span class="n">varp</span><span class="p">)</span> <span class="p">;</span> <span class="k">deallocate</span><span class="p">(</span><span class="n">var</span><span class="p">)</span>
    <span class="k">call </span><span class="n">b64_encode</span><span class="p">(</span><span class="n">nB</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">BYI1P</span><span class="p">,</span><span class="n">I4P</span><span class="p">),</span><span class="n">n</span><span class="o">=</span><span class="n">varp</span><span class="p">,</span><span class="n">code</span><span class="o">=</span><span class="n">var64</span><span class="p">)</span> <span class="p">;</span> <span class="k">deallocate</span><span class="p">(</span><span class="n">varp</span><span class="p">)</span>
    <span class="k">write</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="o">+</span><span class="mi">2</span><span class="p">)</span><span class="o">//</span><span class="n">tochar</span><span class="p">(</span><span class="n">var64</span><span class="p">)</span><span class="o">//</span><span class="n">end_rec</span> <span class="p">;</span> <span class="k">deallocate</span><span class="p">(</span><span class="n">var64</span><span class="p">)</span>
    <span class="k">write</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;/DataArray&gt;&#39;</span><span class="o">//</span><span class="n">end_rec</span>
  <span class="n">endselect</span>
  <span class="k">return</span>
  <span class="c">!---------------------------------------------------------------------------------------------------------------------------------</span>
  <span class="n">endfunction</span> <span class="n">VTK_VAR_XML_VECT_1DA_R8</span>

  <span class="c">!&gt; Function for saving field of vectorial variable (R8P, 3D arrays).</span>
  <span class="c">!&gt; @return E_IO: integer(I4P) error flag</span>
  <span class="k">function </span><span class="n">VTK_VAR_XML_VECT_3DA_R8</span><span class="p">(</span><span class="n">NC_NN</span><span class="p">,</span><span class="n">varname</span><span class="p">,</span><span class="n">varX</span><span class="p">,</span><span class="n">varY</span><span class="p">,</span><span class="n">varZ</span><span class="p">,</span><span class="n">cf</span><span class="p">)</span> <span class="k">result</span><span class="p">(</span><span class="n">E_IO</span><span class="p">)</span>
  <span class="c">!---------------------------------------------------------------------------------------------------------------------------------</span>
  <span class="k">implicit none</span>
<span class="k">  </span><span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span><span class="kd">::</span>           <span class="n">NC_NN</span>          <span class="c">!&lt; Number of cells or nodes.</span>
  <span class="kt">character</span><span class="p">(</span><span class="o">*</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span><span class="kd">::</span>           <span class="n">varname</span>        <span class="c">!&lt; Variable name.</span>
  <span class="kt">real</span><span class="p">(</span><span class="n">R8P</span><span class="p">),</span>    <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span><span class="kd">::</span>           <span class="n">varX</span><span class="p">(</span><span class="mi">1</span><span class="p">:,</span><span class="mi">1</span><span class="p">:,</span><span class="mi">1</span><span class="p">:)</span> <span class="c">!&lt; X component [1:Nx,1:Ny,1:Nz].</span>
  <span class="kt">real</span><span class="p">(</span><span class="n">R8P</span><span class="p">),</span>    <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span><span class="kd">::</span>           <span class="n">varY</span><span class="p">(</span><span class="mi">1</span><span class="p">:,</span><span class="mi">1</span><span class="p">:,</span><span class="mi">1</span><span class="p">:)</span> <span class="c">!&lt; Y component [1:Nx,1:Ny,1:Nz].</span>
  <span class="kt">real</span><span class="p">(</span><span class="n">R8P</span><span class="p">),</span>    <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span><span class="kd">::</span>           <span class="n">varZ</span><span class="p">(</span><span class="mi">1</span><span class="p">:,</span><span class="mi">1</span><span class="p">:,</span><span class="mi">1</span><span class="p">:)</span> <span class="c">!&lt; Z component [1:Nx,1:Ny,1:Nz].</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">),</span> <span class="k">optional</span><span class="kd">::</span> <span class="n">cf</span>             <span class="c">!&lt; Current file index (for concurrent files IO).</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">)</span><span class="kd">::</span>                       <span class="n">E_IO</span>           <span class="c">!&lt; Input/Output inquiring flag: $0$ if IO is done, $&gt; 0$ if IO is not done.</span>
  <span class="kt">character</span><span class="p">(</span><span class="nb">len</span><span class="o">=</span><span class="n">maxlen</span><span class="p">)</span><span class="kd">::</span>              <span class="n">s_buffer</span>       <span class="c">!&lt; Buffer string.</span>
  <span class="kt">real</span><span class="p">(</span><span class="n">R8P</span><span class="p">),</span>    <span class="k">allocatable</span><span class="kd">::</span>          <span class="n">var</span><span class="p">(:)</span>         <span class="c">!&lt; X, Y, Z component.</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I1P</span><span class="p">),</span> <span class="k">allocatable</span><span class="kd">::</span>          <span class="n">varp</span><span class="p">(:)</span>        <span class="c">!&lt; Packed data.</span>
  <span class="kt">character</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="k">allocatable</span><span class="kd">::</span>          <span class="n">var64</span><span class="p">(:)</span>       <span class="c">!&lt; Variable encoded in base64.</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">)</span><span class="kd">::</span>                       <span class="n">rf</span>             <span class="c">!&lt; Real file index.</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">)</span><span class="kd">::</span>                       <span class="n">nx</span><span class="p">,</span><span class="n">ny</span><span class="p">,</span><span class="n">nz</span><span class="p">,</span><span class="n">n1</span>    <span class="c">!&lt; Counters.</span>
  <span class="c">!---------------------------------------------------------------------------------------------------------------------------------</span>

  <span class="c">!---------------------------------------------------------------------------------------------------------------------------------</span>
  <span class="n">E_IO</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1_I4P</span>
  <span class="n">rf</span> <span class="o">=</span> <span class="n">f</span>
  <span class="k">if</span> <span class="p">(</span><span class="nb">present</span><span class="p">(</span><span class="n">cf</span><span class="p">))</span> <span class="k">then</span>
<span class="k">    </span><span class="n">rf</span> <span class="o">=</span> <span class="n">cf</span> <span class="p">;</span> <span class="n">f</span> <span class="o">=</span> <span class="n">cf</span>
  <span class="n">endif</span>
  <span class="k">select case</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">f</span><span class="p">)</span>
  <span class="k">case</span><span class="p">(</span><span class="n">ascii</span><span class="p">)</span>
    <span class="n">s_buffer</span> <span class="o">=</span> <span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;DataArray type=&quot;Float64&quot; Name=&quot;&#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">varname</span><span class="p">)</span><span class="o">//</span><span class="p">&amp;</span>
               <span class="s1">&#39;&quot; NumberOfComponents=&quot;3&quot; format=&quot;ascii&quot;&gt;&#39;</span>
    <span class="k">write</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="s1">&#39;(A)&#39;</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">trim</span><span class="p">(</span><span class="n">s_buffer</span><span class="p">)</span>
    <span class="k">do </span><span class="n">nz</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">size</span><span class="p">(</span><span class="n">varX</span><span class="p">,</span><span class="nb">dim</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span> <span class="p">;</span> <span class="k">do </span><span class="n">ny</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">size</span><span class="p">(</span><span class="n">varX</span><span class="p">,</span><span class="nb">dim</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span> <span class="p">;</span> <span class="k">do </span><span class="n">nx</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">size</span><span class="p">(</span><span class="n">varX</span><span class="p">,</span><span class="nb">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
      <span class="k">write</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="s1">&#39;(A)&#39;</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="p">&amp;</span>
                                        <span class="n">str</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">varX</span><span class="p">(</span><span class="n">nx</span><span class="p">,</span><span class="n">ny</span><span class="p">,</span><span class="n">nz</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39; &#39;</span><span class="o">//</span><span class="n">str</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">varY</span><span class="p">(</span><span class="n">nx</span><span class="p">,</span><span class="n">ny</span><span class="p">,</span><span class="n">nz</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39; &#39;</span><span class="o">//</span><span class="n">str</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">varZ</span><span class="p">(</span><span class="n">nx</span><span class="p">,</span><span class="n">ny</span><span class="p">,</span><span class="n">nz</span><span class="p">))</span>
    <span class="n">enddo</span> <span class="p">;</span> <span class="n">enddo</span> <span class="p">;</span> <span class="n">enddo</span>
    <span class="k">write</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="s1">&#39;(A)&#39;</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;/DataArray&gt;&#39;</span>
  <span class="k">case</span><span class="p">(</span><span class="n">raw</span><span class="p">,</span><span class="n">bin_app</span><span class="p">)</span>
    <span class="n">s_buffer</span> <span class="o">=</span> <span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;DataArray type=&quot;Float64&quot; Name=&quot;&#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">varname</span><span class="p">)</span><span class="o">//</span><span class="p">&amp;</span>
               <span class="s1">&#39;&quot; NumberOfComponents=&quot;3&quot; format=&quot;appended&quot; offset=&quot;&#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(.</span><span class="n">true</span><span class="p">.,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">ioffset</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39;&quot;/&gt;&#39;</span>
    <span class="k">write</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">trim</span><span class="p">(</span><span class="n">s_buffer</span><span class="p">)</span><span class="o">//</span><span class="n">end_rec</span>
    <span class="k">call </span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">byte_update</span><span class="p">(</span><span class="n">N_Byte</span> <span class="o">=</span> <span class="mi">3</span><span class="o">*</span><span class="n">NC_NN</span><span class="o">*</span><span class="n">BYR8P</span><span class="p">)</span>
    <span class="k">write</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">ua</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">N_Byte</span><span class="p">,</span><span class="s1">&#39;R8&#39;</span><span class="p">,</span><span class="mi">3</span><span class="o">*</span><span class="n">NC_NN</span>
    <span class="k">write</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">ua</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)(((</span><span class="n">varX</span><span class="p">(</span><span class="n">nx</span><span class="p">,</span><span class="n">ny</span><span class="p">,</span><span class="n">nz</span><span class="p">),</span><span class="n">varY</span><span class="p">(</span><span class="n">nx</span><span class="p">,</span><span class="n">ny</span><span class="p">,</span><span class="n">nz</span><span class="p">),</span><span class="n">varZ</span><span class="p">(</span><span class="n">nx</span><span class="p">,</span><span class="n">ny</span><span class="p">,</span><span class="n">nz</span><span class="p">),&amp;</span>
                                 <span class="n">nx</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">size</span><span class="p">(</span><span class="n">varX</span><span class="p">,</span><span class="nb">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)),</span><span class="n">ny</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">size</span><span class="p">(</span><span class="n">varX</span><span class="p">,</span><span class="nb">dim</span><span class="o">=</span><span class="mi">2</span><span class="p">)),</span><span class="n">nz</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">size</span><span class="p">(</span><span class="n">varX</span><span class="p">,</span><span class="nb">dim</span><span class="o">=</span><span class="mi">3</span><span class="p">))</span>
  <span class="k">case</span><span class="p">(</span><span class="n">binary</span><span class="p">)</span>
    <span class="n">s_buffer</span> <span class="o">=</span> <span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;DataArray type=&quot;Float64&quot; Name=&quot;&#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">varname</span><span class="p">)</span><span class="o">//</span><span class="p">&amp;</span>
               <span class="s1">&#39;&quot; NumberOfComponents=&quot;3&quot; format=&quot;binary&quot;&gt;&#39;</span>
    <span class="k">write</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">trim</span><span class="p">(</span><span class="n">s_buffer</span><span class="p">)</span><span class="o">//</span><span class="n">end_rec</span>
    <span class="k">allocate</span><span class="p">(</span><span class="n">var</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="o">*</span><span class="n">NC_NN</span><span class="p">))</span>
    <span class="n">n1</span> <span class="o">=</span> <span class="mi">0_I4P</span>
    <span class="k">do </span><span class="n">nz</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">size</span><span class="p">(</span><span class="n">varX</span><span class="p">,</span><span class="nb">dim</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span> <span class="p">;</span> <span class="k">do </span><span class="n">ny</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">size</span><span class="p">(</span><span class="n">varX</span><span class="p">,</span><span class="nb">dim</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span> <span class="p">;</span> <span class="k">do </span><span class="n">nx</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">size</span><span class="p">(</span><span class="n">varX</span><span class="p">,</span><span class="nb">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
      <span class="n">n1</span> <span class="o">=</span> <span class="n">n1</span> <span class="o">+</span> <span class="mi">1_I4P</span> <span class="p">;</span> <span class="n">var</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="p">(</span><span class="n">n1</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="mi">3</span><span class="p">:</span><span class="mi">1</span><span class="o">+</span><span class="p">(</span><span class="n">n1</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="mi">3</span><span class="o">+</span><span class="mi">2</span><span class="p">)</span><span class="o">=</span><span class="p">[</span><span class="n">varX</span><span class="p">(</span><span class="n">nx</span><span class="p">,</span><span class="n">ny</span><span class="p">,</span><span class="n">nz</span><span class="p">),</span><span class="n">varY</span><span class="p">(</span><span class="n">nx</span><span class="p">,</span><span class="n">ny</span><span class="p">,</span><span class="n">nz</span><span class="p">),</span><span class="n">varZ</span><span class="p">(</span><span class="n">nx</span><span class="p">,</span><span class="n">ny</span><span class="p">,</span><span class="n">nz</span><span class="p">)]</span>
    <span class="n">enddo</span> <span class="p">;</span> <span class="n">enddo</span> <span class="p">;</span> <span class="n">enddo</span>
    <span class="k">call </span><span class="n">pack_data</span><span class="p">(</span><span class="n">a1</span><span class="o">=</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="mi">3</span><span class="o">*</span><span class="n">NC_NN</span><span class="o">*</span><span class="n">BYR8P</span><span class="p">,</span><span class="n">I4P</span><span class="p">)],</span><span class="n">a2</span><span class="o">=</span><span class="n">var</span><span class="p">,</span><span class="n">packed</span><span class="o">=</span><span class="n">varp</span><span class="p">)</span> <span class="p">;</span> <span class="k">deallocate</span><span class="p">(</span><span class="n">var</span><span class="p">)</span>
    <span class="k">call </span><span class="n">b64_encode</span><span class="p">(</span><span class="n">nB</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">BYI1P</span><span class="p">,</span><span class="n">I4P</span><span class="p">),</span><span class="n">n</span><span class="o">=</span><span class="n">varp</span><span class="p">,</span><span class="n">code</span><span class="o">=</span><span class="n">var64</span><span class="p">)</span> <span class="p">;</span> <span class="k">deallocate</span><span class="p">(</span><span class="n">varp</span><span class="p">)</span>
    <span class="k">write</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="o">+</span><span class="mi">2</span><span class="p">)</span><span class="o">//</span><span class="n">tochar</span><span class="p">(</span><span class="n">var64</span><span class="p">)</span><span class="o">//</span><span class="n">end_rec</span> <span class="p">;</span> <span class="k">deallocate</span><span class="p">(</span><span class="n">var64</span><span class="p">)</span>
    <span class="k">write</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;/DataArray&gt;&#39;</span><span class="o">//</span><span class="n">end_rec</span>
  <span class="n">endselect</span>
  <span class="k">return</span>
  <span class="c">!---------------------------------------------------------------------------------------------------------------------------------</span>
  <span class="n">endfunction</span> <span class="n">VTK_VAR_XML_VECT_3DA_R8</span>

  <span class="c">!&gt; Function for saving field of vectorial variable (R4P, 1D arrays).</span>
  <span class="c">!&gt; @return E_IO: integer(I4P) error flag</span>
  <span class="k">function </span><span class="n">VTK_VAR_XML_VECT_1DA_R4</span><span class="p">(</span><span class="n">NC_NN</span><span class="p">,</span><span class="n">varname</span><span class="p">,</span><span class="n">varX</span><span class="p">,</span><span class="n">varY</span><span class="p">,</span><span class="n">varZ</span><span class="p">,</span><span class="n">cf</span><span class="p">)</span> <span class="k">result</span><span class="p">(</span><span class="n">E_IO</span><span class="p">)</span>
  <span class="c">!---------------------------------------------------------------------------------------------------------------------------------</span>
  <span class="k">implicit none</span>
<span class="k">  </span><span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span><span class="kd">::</span>           <span class="n">NC_NN</span>    <span class="c">!&lt; Number of cells or nodes.</span>
  <span class="kt">character</span><span class="p">(</span><span class="o">*</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span><span class="kd">::</span>           <span class="n">varname</span>  <span class="c">!&lt; Variable name.</span>
  <span class="kt">real</span><span class="p">(</span><span class="n">R4P</span><span class="p">),</span>    <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span><span class="kd">::</span>           <span class="n">varX</span><span class="p">(</span><span class="mi">1</span><span class="p">:)</span> <span class="c">!&lt; X component [1:NC_NN].</span>
  <span class="kt">real</span><span class="p">(</span><span class="n">R4P</span><span class="p">),</span>    <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span><span class="kd">::</span>           <span class="n">varY</span><span class="p">(</span><span class="mi">1</span><span class="p">:)</span> <span class="c">!&lt; Y component [1:NC_NN].</span>
  <span class="kt">real</span><span class="p">(</span><span class="n">R4P</span><span class="p">),</span>    <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span><span class="kd">::</span>           <span class="n">varZ</span><span class="p">(</span><span class="mi">1</span><span class="p">:)</span> <span class="c">!&lt; Z component [1:NC_NN].</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">),</span> <span class="k">optional</span><span class="kd">::</span> <span class="n">cf</span>       <span class="c">!&lt; Current file index (for concurrent files IO).</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">)</span><span class="kd">::</span>                       <span class="n">E_IO</span>     <span class="c">!&lt; Input/Output inquiring flag: $0$ if IO is done, $&gt; 0$ if IO is not done.</span>
  <span class="kt">character</span><span class="p">(</span><span class="nb">len</span><span class="o">=</span><span class="n">maxlen</span><span class="p">)</span><span class="kd">::</span>              <span class="n">s_buffer</span> <span class="c">!&lt; Buffer string.</span>
  <span class="kt">real</span><span class="p">(</span><span class="n">R4P</span><span class="p">),</span>    <span class="k">allocatable</span><span class="kd">::</span>          <span class="n">var</span><span class="p">(:)</span>   <span class="c">!&lt; X, Y, Z component.</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I1P</span><span class="p">),</span> <span class="k">allocatable</span><span class="kd">::</span>          <span class="n">varp</span><span class="p">(:)</span>  <span class="c">!&lt; Packed data.</span>
  <span class="kt">character</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="k">allocatable</span><span class="kd">::</span>          <span class="n">var64</span><span class="p">(:)</span> <span class="c">!&lt; Variable encoded in base64.</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">)</span><span class="kd">::</span>                       <span class="n">rf</span>       <span class="c">!&lt; Real file index.</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">)</span><span class="kd">::</span>                       <span class="n">n1</span>       <span class="c">!&lt; Counter.</span>
  <span class="c">!---------------------------------------------------------------------------------------------------------------------------------</span>

  <span class="c">!---------------------------------------------------------------------------------------------------------------------------------</span>
  <span class="n">E_IO</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1_I4P</span>
  <span class="n">rf</span> <span class="o">=</span> <span class="n">f</span>
  <span class="k">if</span> <span class="p">(</span><span class="nb">present</span><span class="p">(</span><span class="n">cf</span><span class="p">))</span> <span class="k">then</span>
<span class="k">    </span><span class="n">rf</span> <span class="o">=</span> <span class="n">cf</span> <span class="p">;</span> <span class="n">f</span> <span class="o">=</span> <span class="n">cf</span>
  <span class="n">endif</span>
  <span class="k">select case</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">f</span><span class="p">)</span>
  <span class="k">case</span><span class="p">(</span><span class="n">ascii</span><span class="p">)</span>
    <span class="n">s_buffer</span> <span class="o">=</span> <span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;DataArray type=&quot;Float32&quot; Name=&quot;&#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">varname</span><span class="p">)</span><span class="o">//</span><span class="p">&amp;</span>
               <span class="s1">&#39;&quot; NumberOfComponents=&quot;3&quot; format=&quot;ascii&quot;&gt;&#39;</span>
    <span class="k">write</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="s1">&#39;(A)&#39;</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">trim</span><span class="p">(</span><span class="n">s_buffer</span><span class="p">)</span>
    <span class="k">do </span><span class="n">n1</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">NC_NN</span>
      <span class="k">write</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="s1">&#39;(A)&#39;</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="n">str</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">varX</span><span class="p">(</span><span class="n">n1</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39; &#39;</span><span class="o">//</span><span class="n">str</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">varY</span><span class="p">(</span><span class="n">n1</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39; &#39;</span><span class="o">//</span><span class="n">str</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">varZ</span><span class="p">(</span><span class="n">n1</span><span class="p">))</span>
    <span class="n">enddo</span>
    <span class="k">write</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="s1">&#39;(A)&#39;</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;/DataArray&gt;&#39;</span>
  <span class="k">case</span><span class="p">(</span><span class="n">raw</span><span class="p">,</span><span class="n">bin_app</span><span class="p">)</span>
    <span class="n">s_buffer</span> <span class="o">=</span> <span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;DataArray type=&quot;Float32&quot; Name=&quot;&#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">varname</span><span class="p">)</span><span class="o">//</span><span class="p">&amp;</span>
               <span class="s1">&#39;&quot; NumberOfComponents=&quot;3&quot; format=&quot;appended&quot; offset=&quot;&#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(.</span><span class="n">true</span><span class="p">.,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">ioffset</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39;&quot;/&gt;&#39;</span>
    <span class="k">write</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">trim</span><span class="p">(</span><span class="n">s_buffer</span><span class="p">)</span><span class="o">//</span><span class="n">end_rec</span>
    <span class="k">call </span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">byte_update</span><span class="p">(</span><span class="n">N_Byte</span> <span class="o">=</span> <span class="mi">3</span><span class="o">*</span><span class="n">NC_NN</span><span class="o">*</span><span class="n">BYR4P</span><span class="p">)</span>
    <span class="k">write</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">ua</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">N_Byte</span><span class="p">,</span><span class="s1">&#39;R4&#39;</span><span class="p">,</span><span class="mi">3</span><span class="o">*</span><span class="n">NC_NN</span>
    <span class="k">write</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">ua</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)(</span><span class="n">varX</span><span class="p">(</span><span class="n">n1</span><span class="p">),</span><span class="n">varY</span><span class="p">(</span><span class="n">n1</span><span class="p">),</span><span class="n">varZ</span><span class="p">(</span><span class="n">n1</span><span class="p">),</span><span class="n">n1</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">NC_NN</span><span class="p">)</span>
  <span class="k">case</span><span class="p">(</span><span class="n">binary</span><span class="p">)</span>
    <span class="n">s_buffer</span> <span class="o">=</span> <span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;DataArray type=&quot;Float32&quot; Name=&quot;&#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">varname</span><span class="p">)</span><span class="o">//</span><span class="p">&amp;</span>
               <span class="s1">&#39;&quot; NumberOfComponents=&quot;3&quot; format=&quot;binary&quot;&gt;&#39;</span>
    <span class="k">write</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">trim</span><span class="p">(</span><span class="n">s_buffer</span><span class="p">)</span><span class="o">//</span><span class="n">end_rec</span>
    <span class="k">allocate</span><span class="p">(</span><span class="n">var</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="o">*</span><span class="n">NC_NN</span><span class="p">))</span>
    <span class="k">do </span><span class="n">n1</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">NC_NN</span>
      <span class="n">var</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="p">(</span><span class="n">n1</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="mi">3</span><span class="p">:</span><span class="mi">1</span><span class="o">+</span><span class="p">(</span><span class="n">n1</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="mi">3</span><span class="o">+</span><span class="mi">2</span><span class="p">)</span><span class="o">=</span><span class="p">[</span><span class="n">varX</span><span class="p">(</span><span class="n">n1</span><span class="p">),</span><span class="n">varY</span><span class="p">(</span><span class="n">n1</span><span class="p">),</span><span class="n">varZ</span><span class="p">(</span><span class="n">n1</span><span class="p">)]</span>
    <span class="n">enddo</span>
    <span class="k">call </span><span class="n">pack_data</span><span class="p">(</span><span class="n">a1</span><span class="o">=</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="mi">3</span><span class="o">*</span><span class="n">NC_NN</span><span class="o">*</span><span class="n">BYR4P</span><span class="p">,</span><span class="n">I4P</span><span class="p">)],</span><span class="n">a2</span><span class="o">=</span><span class="n">var</span><span class="p">,</span><span class="n">packed</span><span class="o">=</span><span class="n">varp</span><span class="p">)</span> <span class="p">;</span> <span class="k">deallocate</span><span class="p">(</span><span class="n">var</span><span class="p">)</span>
    <span class="k">call </span><span class="n">b64_encode</span><span class="p">(</span><span class="n">nB</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">BYI1P</span><span class="p">,</span><span class="n">I4P</span><span class="p">),</span><span class="n">n</span><span class="o">=</span><span class="n">varp</span><span class="p">,</span><span class="n">code</span><span class="o">=</span><span class="n">var64</span><span class="p">)</span> <span class="p">;</span> <span class="k">deallocate</span><span class="p">(</span><span class="n">varp</span><span class="p">)</span>
    <span class="k">write</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="o">+</span><span class="mi">2</span><span class="p">)</span><span class="o">//</span><span class="n">tochar</span><span class="p">(</span><span class="n">var64</span><span class="p">)</span><span class="o">//</span><span class="n">end_rec</span> <span class="p">;</span> <span class="k">deallocate</span><span class="p">(</span><span class="n">var64</span><span class="p">)</span>
    <span class="k">write</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;/DataArray&gt;&#39;</span><span class="o">//</span><span class="n">end_rec</span>
  <span class="n">endselect</span>
  <span class="k">return</span>
  <span class="c">!---------------------------------------------------------------------------------------------------------------------------------</span>
  <span class="n">endfunction</span> <span class="n">VTK_VAR_XML_VECT_1DA_R4</span>

  <span class="c">!&gt; Function for saving field of vectorial variable (R4P, 3D arrays).</span>
  <span class="c">!&gt; @return E_IO: integer(I4P) error flag</span>
  <span class="k">function </span><span class="n">VTK_VAR_XML_VECT_3DA_R4</span><span class="p">(</span><span class="n">NC_NN</span><span class="p">,</span><span class="n">varname</span><span class="p">,</span><span class="n">varX</span><span class="p">,</span><span class="n">varY</span><span class="p">,</span><span class="n">varZ</span><span class="p">,</span><span class="n">cf</span><span class="p">)</span> <span class="k">result</span><span class="p">(</span><span class="n">E_IO</span><span class="p">)</span>
  <span class="c">!---------------------------------------------------------------------------------------------------------------------------------</span>
  <span class="k">implicit none</span>
<span class="k">  </span><span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span><span class="kd">::</span>           <span class="n">NC_NN</span>          <span class="c">!&lt; Number of cells or nodes.</span>
  <span class="kt">character</span><span class="p">(</span><span class="o">*</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span><span class="kd">::</span>           <span class="n">varname</span>        <span class="c">!&lt; Variable name.</span>
  <span class="kt">real</span><span class="p">(</span><span class="n">R4P</span><span class="p">),</span>    <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span><span class="kd">::</span>           <span class="n">varX</span><span class="p">(</span><span class="mi">1</span><span class="p">:,</span><span class="mi">1</span><span class="p">:,</span><span class="mi">1</span><span class="p">:)</span> <span class="c">!&lt; X component [1:Nx,1:Ny,1:Nz].</span>
  <span class="kt">real</span><span class="p">(</span><span class="n">R4P</span><span class="p">),</span>    <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span><span class="kd">::</span>           <span class="n">varY</span><span class="p">(</span><span class="mi">1</span><span class="p">:,</span><span class="mi">1</span><span class="p">:,</span><span class="mi">1</span><span class="p">:)</span> <span class="c">!&lt; Y component [1:Nx,1:Ny,1:Nz].</span>
  <span class="kt">real</span><span class="p">(</span><span class="n">R4P</span><span class="p">),</span>    <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span><span class="kd">::</span>           <span class="n">varZ</span><span class="p">(</span><span class="mi">1</span><span class="p">:,</span><span class="mi">1</span><span class="p">:,</span><span class="mi">1</span><span class="p">:)</span> <span class="c">!&lt; Z component [1:Nx,1:Ny,1:Nz].</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">),</span> <span class="k">optional</span><span class="kd">::</span> <span class="n">cf</span>             <span class="c">!&lt; Current file index (for concurrent files IO).</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">)</span><span class="kd">::</span>                       <span class="n">E_IO</span>           <span class="c">!&lt; Input/Output inquiring flag: $0$ if IO is done, $&gt; 0$ if IO is not done.</span>
  <span class="kt">character</span><span class="p">(</span><span class="nb">len</span><span class="o">=</span><span class="n">maxlen</span><span class="p">)</span><span class="kd">::</span>              <span class="n">s_buffer</span>       <span class="c">!&lt; Buffer string.</span>
  <span class="kt">real</span><span class="p">(</span><span class="n">R4P</span><span class="p">),</span>    <span class="k">allocatable</span><span class="kd">::</span>          <span class="n">var</span><span class="p">(:)</span>         <span class="c">!&lt; X, Y, Z component.</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I1P</span><span class="p">),</span> <span class="k">allocatable</span><span class="kd">::</span>          <span class="n">varp</span><span class="p">(:)</span>        <span class="c">!&lt; Packed data.</span>
  <span class="kt">character</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="k">allocatable</span><span class="kd">::</span>          <span class="n">var64</span><span class="p">(:)</span>       <span class="c">!&lt; Variable encoded in base64.</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">)</span><span class="kd">::</span>                       <span class="n">rf</span>             <span class="c">!&lt; Real file index.</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">)</span><span class="kd">::</span>                       <span class="n">nx</span><span class="p">,</span><span class="n">ny</span><span class="p">,</span><span class="n">nz</span><span class="p">,</span><span class="n">n1</span>    <span class="c">!&lt; Counters.</span>
  <span class="c">!---------------------------------------------------------------------------------------------------------------------------------</span>

  <span class="c">!---------------------------------------------------------------------------------------------------------------------------------</span>
  <span class="n">E_IO</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1_I4P</span>
  <span class="n">rf</span> <span class="o">=</span> <span class="n">f</span>
  <span class="k">if</span> <span class="p">(</span><span class="nb">present</span><span class="p">(</span><span class="n">cf</span><span class="p">))</span> <span class="k">then</span>
<span class="k">    </span><span class="n">rf</span> <span class="o">=</span> <span class="n">cf</span> <span class="p">;</span> <span class="n">f</span> <span class="o">=</span> <span class="n">cf</span>
  <span class="n">endif</span>
  <span class="k">select case</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">f</span><span class="p">)</span>
  <span class="k">case</span><span class="p">(</span><span class="n">ascii</span><span class="p">)</span>
    <span class="n">s_buffer</span> <span class="o">=</span> <span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;DataArray type=&quot;Float32&quot; Name=&quot;&#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">varname</span><span class="p">)</span><span class="o">//</span><span class="p">&amp;</span>
               <span class="s1">&#39;&quot; NumberOfComponents=&quot;3&quot; format=&quot;ascii&quot;&gt;&#39;</span>
    <span class="k">write</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="s1">&#39;(A)&#39;</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">trim</span><span class="p">(</span><span class="n">s_buffer</span><span class="p">)</span>
    <span class="k">do </span><span class="n">nz</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">size</span><span class="p">(</span><span class="n">varX</span><span class="p">,</span><span class="nb">dim</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span> <span class="p">;</span> <span class="k">do </span><span class="n">ny</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">size</span><span class="p">(</span><span class="n">varX</span><span class="p">,</span><span class="nb">dim</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span> <span class="p">;</span> <span class="k">do </span><span class="n">nx</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">size</span><span class="p">(</span><span class="n">varX</span><span class="p">,</span><span class="nb">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
      <span class="k">write</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="s1">&#39;(A)&#39;</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="p">&amp;</span>
                                        <span class="n">str</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">varX</span><span class="p">(</span><span class="n">nx</span><span class="p">,</span><span class="n">ny</span><span class="p">,</span><span class="n">nz</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39; &#39;</span><span class="o">//</span><span class="n">str</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">varY</span><span class="p">(</span><span class="n">nx</span><span class="p">,</span><span class="n">ny</span><span class="p">,</span><span class="n">nz</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39; &#39;</span><span class="o">//</span><span class="n">str</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">varZ</span><span class="p">(</span><span class="n">nx</span><span class="p">,</span><span class="n">ny</span><span class="p">,</span><span class="n">nz</span><span class="p">))</span>
    <span class="n">enddo</span> <span class="p">;</span> <span class="n">enddo</span> <span class="p">;</span> <span class="n">enddo</span>
    <span class="k">write</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="s1">&#39;(A)&#39;</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;/DataArray&gt;&#39;</span>
  <span class="k">case</span><span class="p">(</span><span class="n">raw</span><span class="p">,</span><span class="n">bin_app</span><span class="p">)</span>
    <span class="n">s_buffer</span> <span class="o">=</span> <span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;DataArray type=&quot;Float32&quot; Name=&quot;&#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">varname</span><span class="p">)</span><span class="o">//</span><span class="p">&amp;</span>
               <span class="s1">&#39;&quot; NumberOfComponents=&quot;3&quot; format=&quot;appended&quot; offset=&quot;&#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(.</span><span class="n">true</span><span class="p">.,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">ioffset</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39;&quot;/&gt;&#39;</span>
    <span class="k">write</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">trim</span><span class="p">(</span><span class="n">s_buffer</span><span class="p">)</span><span class="o">//</span><span class="n">end_rec</span>
    <span class="k">call </span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">byte_update</span><span class="p">(</span><span class="n">N_Byte</span> <span class="o">=</span> <span class="mi">3</span><span class="o">*</span><span class="n">NC_NN</span><span class="o">*</span><span class="n">BYR4P</span><span class="p">)</span>
    <span class="k">write</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">ua</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">N_Byte</span><span class="p">,</span><span class="s1">&#39;R4&#39;</span><span class="p">,</span><span class="mi">3</span><span class="o">*</span><span class="n">NC_NN</span>
    <span class="k">write</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">ua</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)(((</span><span class="n">varX</span><span class="p">(</span><span class="n">nx</span><span class="p">,</span><span class="n">ny</span><span class="p">,</span><span class="n">nz</span><span class="p">),</span><span class="n">varY</span><span class="p">(</span><span class="n">nx</span><span class="p">,</span><span class="n">ny</span><span class="p">,</span><span class="n">nz</span><span class="p">),</span><span class="n">varZ</span><span class="p">(</span><span class="n">nx</span><span class="p">,</span><span class="n">ny</span><span class="p">,</span><span class="n">nz</span><span class="p">),&amp;</span>
                                 <span class="n">nx</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">size</span><span class="p">(</span><span class="n">varX</span><span class="p">,</span><span class="nb">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)),</span><span class="n">ny</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">size</span><span class="p">(</span><span class="n">varX</span><span class="p">,</span><span class="nb">dim</span><span class="o">=</span><span class="mi">2</span><span class="p">)),</span><span class="n">nz</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">size</span><span class="p">(</span><span class="n">varX</span><span class="p">,</span><span class="nb">dim</span><span class="o">=</span><span class="mi">3</span><span class="p">))</span>
  <span class="k">case</span><span class="p">(</span><span class="n">binary</span><span class="p">)</span>
    <span class="n">s_buffer</span> <span class="o">=</span> <span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;DataArray type=&quot;Float32&quot; Name=&quot;&#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">varname</span><span class="p">)</span><span class="o">//</span><span class="p">&amp;</span>
               <span class="s1">&#39;&quot; NumberOfComponents=&quot;3&quot; format=&quot;binary&quot;&gt;&#39;</span>
    <span class="k">write</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">trim</span><span class="p">(</span><span class="n">s_buffer</span><span class="p">)</span><span class="o">//</span><span class="n">end_rec</span>
    <span class="k">allocate</span><span class="p">(</span><span class="n">var</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="o">*</span><span class="n">NC_NN</span><span class="p">))</span>
    <span class="n">n1</span> <span class="o">=</span> <span class="mi">0_I4P</span>
    <span class="k">do </span><span class="n">nz</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">size</span><span class="p">(</span><span class="n">varX</span><span class="p">,</span><span class="nb">dim</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span> <span class="p">;</span> <span class="k">do </span><span class="n">ny</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">size</span><span class="p">(</span><span class="n">varX</span><span class="p">,</span><span class="nb">dim</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span> <span class="p">;</span> <span class="k">do </span><span class="n">nx</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">size</span><span class="p">(</span><span class="n">varX</span><span class="p">,</span><span class="nb">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
      <span class="n">n1</span> <span class="o">=</span> <span class="n">n1</span> <span class="o">+</span> <span class="mi">1_I4P</span> <span class="p">;</span> <span class="n">var</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="p">(</span><span class="n">n1</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="mi">3</span><span class="p">:</span><span class="mi">1</span><span class="o">+</span><span class="p">(</span><span class="n">n1</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="mi">3</span><span class="o">+</span><span class="mi">2</span><span class="p">)</span><span class="o">=</span><span class="p">[</span><span class="n">varX</span><span class="p">(</span><span class="n">nx</span><span class="p">,</span><span class="n">ny</span><span class="p">,</span><span class="n">nz</span><span class="p">),</span><span class="n">varY</span><span class="p">(</span><span class="n">nx</span><span class="p">,</span><span class="n">ny</span><span class="p">,</span><span class="n">nz</span><span class="p">),</span><span class="n">varZ</span><span class="p">(</span><span class="n">nx</span><span class="p">,</span><span class="n">ny</span><span class="p">,</span><span class="n">nz</span><span class="p">)]</span>
    <span class="n">enddo</span> <span class="p">;</span> <span class="n">enddo</span> <span class="p">;</span> <span class="n">enddo</span>
    <span class="k">call </span><span class="n">pack_data</span><span class="p">(</span><span class="n">a1</span><span class="o">=</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="mi">3</span><span class="o">*</span><span class="n">NC_NN</span><span class="o">*</span><span class="n">BYR4P</span><span class="p">,</span><span class="n">I4P</span><span class="p">)],</span><span class="n">a2</span><span class="o">=</span><span class="n">var</span><span class="p">,</span><span class="n">packed</span><span class="o">=</span><span class="n">varp</span><span class="p">)</span> <span class="p">;</span> <span class="k">deallocate</span><span class="p">(</span><span class="n">var</span><span class="p">)</span>
    <span class="k">call </span><span class="n">b64_encode</span><span class="p">(</span><span class="n">nB</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">BYI1P</span><span class="p">,</span><span class="n">I4P</span><span class="p">),</span><span class="n">n</span><span class="o">=</span><span class="n">varp</span><span class="p">,</span><span class="n">code</span><span class="o">=</span><span class="n">var64</span><span class="p">)</span> <span class="p">;</span> <span class="k">deallocate</span><span class="p">(</span><span class="n">varp</span><span class="p">)</span>
    <span class="k">write</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="o">+</span><span class="mi">2</span><span class="p">)</span><span class="o">//</span><span class="n">tochar</span><span class="p">(</span><span class="n">var64</span><span class="p">)</span><span class="o">//</span><span class="n">end_rec</span> <span class="p">;</span> <span class="k">deallocate</span><span class="p">(</span><span class="n">var64</span><span class="p">)</span>
    <span class="k">write</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;/DataArray&gt;&#39;</span><span class="o">//</span><span class="n">end_rec</span>
  <span class="n">endselect</span>
  <span class="k">return</span>
  <span class="c">!---------------------------------------------------------------------------------------------------------------------------------</span>
  <span class="n">endfunction</span> <span class="n">VTK_VAR_XML_VECT_3DA_R4</span>

  <span class="c">!&gt; Function for saving field of vectorial variable (I8P, 1D arrays).</span>
  <span class="c">!&gt; @return E_IO: integer(I4P) error flag</span>
  <span class="k">function </span><span class="n">VTK_VAR_XML_VECT_1DA_I8</span><span class="p">(</span><span class="n">NC_NN</span><span class="p">,</span><span class="n">varname</span><span class="p">,</span><span class="n">varX</span><span class="p">,</span><span class="n">varY</span><span class="p">,</span><span class="n">varZ</span><span class="p">,</span><span class="n">cf</span><span class="p">)</span> <span class="k">result</span><span class="p">(</span><span class="n">E_IO</span><span class="p">)</span>
  <span class="c">!---------------------------------------------------------------------------------------------------------------------------------</span>
  <span class="k">implicit none</span>
<span class="k">  </span><span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span><span class="kd">::</span>           <span class="n">NC_NN</span>    <span class="c">!&lt; Number of cells or nodes.</span>
  <span class="kt">character</span><span class="p">(</span><span class="o">*</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span><span class="kd">::</span>           <span class="n">varname</span>  <span class="c">!&lt; Variable name.</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I8P</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span><span class="kd">::</span>           <span class="n">varX</span><span class="p">(</span><span class="mi">1</span><span class="p">:)</span> <span class="c">!&lt; X component [1:NC_NN].</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I8P</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span><span class="kd">::</span>           <span class="n">varY</span><span class="p">(</span><span class="mi">1</span><span class="p">:)</span> <span class="c">!&lt; Y component [1:NC_NN].</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I8P</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span><span class="kd">::</span>           <span class="n">varZ</span><span class="p">(</span><span class="mi">1</span><span class="p">:)</span> <span class="c">!&lt; Z component [1:NC_NN].</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">),</span> <span class="k">optional</span><span class="kd">::</span> <span class="n">cf</span>       <span class="c">!&lt; Current file index (for concurrent files IO).</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">)</span><span class="kd">::</span>                       <span class="n">E_IO</span>     <span class="c">!&lt; Input/Output inquiring flag: $0$ if IO is done, $&gt; 0$ if IO is not done.</span>
  <span class="kt">character</span><span class="p">(</span><span class="nb">len</span><span class="o">=</span><span class="n">maxlen</span><span class="p">)</span><span class="kd">::</span>              <span class="n">s_buffer</span> <span class="c">!&lt; Buffer string.</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I8P</span><span class="p">),</span> <span class="k">allocatable</span><span class="kd">::</span>          <span class="n">var</span><span class="p">(:)</span>   <span class="c">!&lt; X, Y, Z component.</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I1P</span><span class="p">),</span> <span class="k">allocatable</span><span class="kd">::</span>          <span class="n">varp</span><span class="p">(:)</span>  <span class="c">!&lt; Packed data.</span>
  <span class="kt">character</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="k">allocatable</span><span class="kd">::</span>          <span class="n">var64</span><span class="p">(:)</span> <span class="c">!&lt; Variable encoded in base64.</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">)</span><span class="kd">::</span>                       <span class="n">rf</span>       <span class="c">!&lt; Real file index.</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">)</span><span class="kd">::</span>                       <span class="n">n1</span>       <span class="c">!&lt; Counter.</span>
  <span class="c">!---------------------------------------------------------------------------------------------------------------------------------</span>

  <span class="c">!---------------------------------------------------------------------------------------------------------------------------------</span>
  <span class="n">E_IO</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1_I4P</span>
  <span class="n">rf</span> <span class="o">=</span> <span class="n">f</span>
  <span class="k">if</span> <span class="p">(</span><span class="nb">present</span><span class="p">(</span><span class="n">cf</span><span class="p">))</span> <span class="k">then</span>
<span class="k">    </span><span class="n">rf</span> <span class="o">=</span> <span class="n">cf</span> <span class="p">;</span> <span class="n">f</span> <span class="o">=</span> <span class="n">cf</span>
  <span class="n">endif</span>
  <span class="k">select case</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">f</span><span class="p">)</span>
  <span class="k">case</span><span class="p">(</span><span class="n">ascii</span><span class="p">)</span>
    <span class="n">s_buffer</span> <span class="o">=</span> <span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;DataArray type=&quot;Int64&quot; Name=&quot;&#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">varname</span><span class="p">)</span><span class="o">//</span><span class="p">&amp;</span>
               <span class="s1">&#39;&quot; NumberOfComponents=&quot;3&quot; format=&quot;ascii&quot;&gt;&#39;</span>
    <span class="k">write</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="s1">&#39;(A)&#39;</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">trim</span><span class="p">(</span><span class="n">s_buffer</span><span class="p">)</span>
    <span class="k">do </span><span class="n">n1</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">NC_NN</span>
      <span class="k">write</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="s1">&#39;(A)&#39;</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="n">str</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">varX</span><span class="p">(</span><span class="n">n1</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39; &#39;</span><span class="o">//</span><span class="n">str</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">varY</span><span class="p">(</span><span class="n">n1</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39; &#39;</span><span class="o">//</span><span class="n">str</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">varZ</span><span class="p">(</span><span class="n">n1</span><span class="p">))</span>
    <span class="n">enddo</span>
    <span class="k">write</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="s1">&#39;(A)&#39;</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;/DataArray&gt;&#39;</span>
  <span class="k">case</span><span class="p">(</span><span class="n">raw</span><span class="p">,</span><span class="n">bin_app</span><span class="p">)</span>
    <span class="n">s_buffer</span> <span class="o">=</span> <span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;DataArray type=&quot;Int64&quot; Name=&quot;&#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">varname</span><span class="p">)</span><span class="o">//</span><span class="p">&amp;</span>
               <span class="s1">&#39;&quot; NumberOfComponents=&quot;3&quot; format=&quot;appended&quot; offset=&quot;&#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(.</span><span class="n">true</span><span class="p">.,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">ioffset</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39;&quot;/&gt;&#39;</span>
    <span class="k">write</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">trim</span><span class="p">(</span><span class="n">s_buffer</span><span class="p">)</span><span class="o">//</span><span class="n">end_rec</span>
    <span class="k">call </span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">byte_update</span><span class="p">(</span><span class="n">N_Byte</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="mi">3</span><span class="o">*</span><span class="n">NC_NN</span><span class="o">*</span><span class="n">BYI8P</span><span class="p">,</span><span class="n">I4P</span><span class="p">))</span>
    <span class="k">write</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">ua</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">N_Byte</span><span class="p">,</span><span class="s1">&#39;I8&#39;</span><span class="p">,</span><span class="mi">3</span><span class="o">*</span><span class="n">NC_NN</span>
    <span class="k">write</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">ua</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)(</span><span class="n">varX</span><span class="p">(</span><span class="n">n1</span><span class="p">),</span><span class="n">varY</span><span class="p">(</span><span class="n">n1</span><span class="p">),</span><span class="n">varZ</span><span class="p">(</span><span class="n">n1</span><span class="p">),</span><span class="n">n1</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">NC_NN</span><span class="p">)</span>
  <span class="k">case</span><span class="p">(</span><span class="n">binary</span><span class="p">)</span>
    <span class="n">s_buffer</span> <span class="o">=</span> <span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;DataArray type=&quot;Int64&quot; Name=&quot;&#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">varname</span><span class="p">)</span><span class="o">//</span><span class="p">&amp;</span>
               <span class="s1">&#39;&quot; NumberOfComponents=&quot;3&quot; format=&quot;binary&quot;&gt;&#39;</span>
    <span class="k">write</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">trim</span><span class="p">(</span><span class="n">s_buffer</span><span class="p">)</span><span class="o">//</span><span class="n">end_rec</span>
    <span class="k">allocate</span><span class="p">(</span><span class="n">var</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="o">*</span><span class="n">NC_NN</span><span class="p">))</span>
    <span class="k">do </span><span class="n">n1</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">NC_NN</span>
      <span class="n">var</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="p">(</span><span class="n">n1</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="mi">3</span><span class="p">:</span><span class="mi">1</span><span class="o">+</span><span class="p">(</span><span class="n">n1</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="mi">3</span><span class="o">+</span><span class="mi">2</span><span class="p">)</span><span class="o">=</span><span class="p">[</span><span class="n">varX</span><span class="p">(</span><span class="n">n1</span><span class="p">),</span><span class="n">varY</span><span class="p">(</span><span class="n">n1</span><span class="p">),</span><span class="n">varZ</span><span class="p">(</span><span class="n">n1</span><span class="p">)]</span>
    <span class="n">enddo</span>
    <span class="k">call </span><span class="n">pack_data</span><span class="p">(</span><span class="n">a1</span><span class="o">=</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="mi">3</span><span class="o">*</span><span class="n">NC_NN</span><span class="o">*</span><span class="n">BYI8P</span><span class="p">,</span><span class="n">I4P</span><span class="p">)],</span><span class="n">a2</span><span class="o">=</span><span class="n">var</span><span class="p">,</span><span class="n">packed</span><span class="o">=</span><span class="n">varp</span><span class="p">)</span> <span class="p">;</span> <span class="k">deallocate</span><span class="p">(</span><span class="n">var</span><span class="p">)</span>
    <span class="k">call </span><span class="n">b64_encode</span><span class="p">(</span><span class="n">nB</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">BYI1P</span><span class="p">,</span><span class="n">I4P</span><span class="p">),</span><span class="n">n</span><span class="o">=</span><span class="n">varp</span><span class="p">,</span><span class="n">code</span><span class="o">=</span><span class="n">var64</span><span class="p">)</span> <span class="p">;</span> <span class="k">deallocate</span><span class="p">(</span><span class="n">varp</span><span class="p">)</span>
    <span class="k">write</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="o">+</span><span class="mi">2</span><span class="p">)</span><span class="o">//</span><span class="n">tochar</span><span class="p">(</span><span class="n">var64</span><span class="p">)</span><span class="o">//</span><span class="n">end_rec</span> <span class="p">;</span> <span class="k">deallocate</span><span class="p">(</span><span class="n">var64</span><span class="p">)</span>
    <span class="k">write</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;/DataArray&gt;&#39;</span><span class="o">//</span><span class="n">end_rec</span>
  <span class="n">endselect</span>
  <span class="k">return</span>
  <span class="c">!---------------------------------------------------------------------------------------------------------------------------------</span>
  <span class="n">endfunction</span> <span class="n">VTK_VAR_XML_VECT_1DA_I8</span>

  <span class="c">!&gt; Function for saving field of vectorial variable (I8P, 3D arrays).</span>
  <span class="c">!&gt; @return E_IO: integer(I4P) error flag</span>
  <span class="k">function </span><span class="n">VTK_VAR_XML_VECT_3DA_I8</span><span class="p">(</span><span class="n">NC_NN</span><span class="p">,</span><span class="n">varname</span><span class="p">,</span><span class="n">varX</span><span class="p">,</span><span class="n">varY</span><span class="p">,</span><span class="n">varZ</span><span class="p">,</span><span class="n">cf</span><span class="p">)</span> <span class="k">result</span><span class="p">(</span><span class="n">E_IO</span><span class="p">)</span>
  <span class="c">!---------------------------------------------------------------------------------------------------------------------------------</span>
  <span class="k">implicit none</span>
<span class="k">  </span><span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span><span class="kd">::</span>           <span class="n">NC_NN</span>          <span class="c">!&lt; Number of cells or nodes.</span>
  <span class="kt">character</span><span class="p">(</span><span class="o">*</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span><span class="kd">::</span>           <span class="n">varname</span>        <span class="c">!&lt; Variable name.</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I8P</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span><span class="kd">::</span>           <span class="n">varX</span><span class="p">(</span><span class="mi">1</span><span class="p">:,</span><span class="mi">1</span><span class="p">:,</span><span class="mi">1</span><span class="p">:)</span> <span class="c">!&lt; X component [1:Nx,1:Ny,1:Nz].</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I8P</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span><span class="kd">::</span>           <span class="n">varY</span><span class="p">(</span><span class="mi">1</span><span class="p">:,</span><span class="mi">1</span><span class="p">:,</span><span class="mi">1</span><span class="p">:)</span> <span class="c">!&lt; Y component [1:Nx,1:Ny,1:Nz].</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I8P</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span><span class="kd">::</span>           <span class="n">varZ</span><span class="p">(</span><span class="mi">1</span><span class="p">:,</span><span class="mi">1</span><span class="p">:,</span><span class="mi">1</span><span class="p">:)</span> <span class="c">!&lt; Z component [1:Nx,1:Ny,1:Nz].</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">),</span> <span class="k">optional</span><span class="kd">::</span> <span class="n">cf</span>             <span class="c">!&lt; Current file index (for concurrent files IO).</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">)</span><span class="kd">::</span>                       <span class="n">E_IO</span>           <span class="c">!&lt; Input/Output inquiring flag: $0$ if IO is done, $&gt; 0$ if IO is not done.</span>
  <span class="kt">character</span><span class="p">(</span><span class="nb">len</span><span class="o">=</span><span class="n">maxlen</span><span class="p">)</span><span class="kd">::</span>              <span class="n">s_buffer</span>       <span class="c">!&lt; Buffer string.</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I8P</span><span class="p">),</span> <span class="k">allocatable</span><span class="kd">::</span>          <span class="n">var</span><span class="p">(:)</span>         <span class="c">!&lt; X, Y, Z component.</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I1P</span><span class="p">),</span> <span class="k">allocatable</span><span class="kd">::</span>          <span class="n">varp</span><span class="p">(:)</span>        <span class="c">!&lt; Packed data.</span>
  <span class="kt">character</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="k">allocatable</span><span class="kd">::</span>          <span class="n">var64</span><span class="p">(:)</span>       <span class="c">!&lt; Variable encoded in base64.</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">)</span><span class="kd">::</span>                       <span class="n">rf</span>             <span class="c">!&lt; Real file index.</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">)</span><span class="kd">::</span>                       <span class="n">nx</span><span class="p">,</span><span class="n">ny</span><span class="p">,</span><span class="n">nz</span><span class="p">,</span><span class="n">n1</span>    <span class="c">!&lt; Counters.</span>
  <span class="c">!---------------------------------------------------------------------------------------------------------------------------------</span>

  <span class="c">!---------------------------------------------------------------------------------------------------------------------------------</span>
  <span class="n">E_IO</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1_I4P</span>
  <span class="n">rf</span> <span class="o">=</span> <span class="n">f</span>
  <span class="k">if</span> <span class="p">(</span><span class="nb">present</span><span class="p">(</span><span class="n">cf</span><span class="p">))</span> <span class="k">then</span>
<span class="k">    </span><span class="n">rf</span> <span class="o">=</span> <span class="n">cf</span> <span class="p">;</span> <span class="n">f</span> <span class="o">=</span> <span class="n">cf</span>
  <span class="n">endif</span>
  <span class="k">select case</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">f</span><span class="p">)</span>
  <span class="k">case</span><span class="p">(</span><span class="n">ascii</span><span class="p">)</span>
    <span class="n">s_buffer</span> <span class="o">=</span> <span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;DataArray type=&quot;Int64&quot; Name=&quot;&#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">varname</span><span class="p">)</span><span class="o">//</span><span class="p">&amp;</span>
               <span class="s1">&#39;&quot; NumberOfComponents=&quot;3&quot; format=&quot;ascii&quot;&gt;&#39;</span>
    <span class="k">write</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="s1">&#39;(A)&#39;</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">trim</span><span class="p">(</span><span class="n">s_buffer</span><span class="p">)</span>
    <span class="k">do </span><span class="n">nz</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">size</span><span class="p">(</span><span class="n">varX</span><span class="p">,</span><span class="nb">dim</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span> <span class="p">;</span> <span class="k">do </span><span class="n">ny</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">size</span><span class="p">(</span><span class="n">varX</span><span class="p">,</span><span class="nb">dim</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span> <span class="p">;</span> <span class="k">do </span><span class="n">nx</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">size</span><span class="p">(</span><span class="n">varX</span><span class="p">,</span><span class="nb">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
      <span class="k">write</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="s1">&#39;(A)&#39;</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="p">&amp;</span>
                                        <span class="n">str</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">varX</span><span class="p">(</span><span class="n">nx</span><span class="p">,</span><span class="n">ny</span><span class="p">,</span><span class="n">nz</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39; &#39;</span><span class="o">//</span><span class="n">str</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">varY</span><span class="p">(</span><span class="n">nx</span><span class="p">,</span><span class="n">ny</span><span class="p">,</span><span class="n">nz</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39; &#39;</span><span class="o">//</span><span class="n">str</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">varZ</span><span class="p">(</span><span class="n">nx</span><span class="p">,</span><span class="n">ny</span><span class="p">,</span><span class="n">nz</span><span class="p">))</span>
    <span class="n">enddo</span> <span class="p">;</span> <span class="n">enddo</span> <span class="p">;</span> <span class="n">enddo</span>
    <span class="k">write</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="s1">&#39;(A)&#39;</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;/DataArray&gt;&#39;</span>
  <span class="k">case</span><span class="p">(</span><span class="n">raw</span><span class="p">,</span><span class="n">bin_app</span><span class="p">)</span>
    <span class="n">s_buffer</span> <span class="o">=</span> <span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;DataArray type=&quot;Int64&quot; Name=&quot;&#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">varname</span><span class="p">)</span><span class="o">//</span><span class="p">&amp;</span>
               <span class="s1">&#39;&quot; NumberOfComponents=&quot;3&quot; format=&quot;appended&quot; offset=&quot;&#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(.</span><span class="n">true</span><span class="p">.,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">ioffset</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39;&quot;/&gt;&#39;</span>
    <span class="k">write</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">trim</span><span class="p">(</span><span class="n">s_buffer</span><span class="p">)</span><span class="o">//</span><span class="n">end_rec</span>
    <span class="k">call </span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">byte_update</span><span class="p">(</span><span class="n">N_Byte</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="mi">3</span><span class="o">*</span><span class="n">NC_NN</span><span class="o">*</span><span class="n">BYI8P</span><span class="p">,</span><span class="n">I4P</span><span class="p">))</span>
    <span class="k">write</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">ua</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">N_Byte</span><span class="p">,</span><span class="s1">&#39;I8&#39;</span><span class="p">,</span><span class="mi">3</span><span class="o">*</span><span class="n">NC_NN</span>
    <span class="k">write</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">ua</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)(((</span><span class="n">varX</span><span class="p">(</span><span class="n">nx</span><span class="p">,</span><span class="n">ny</span><span class="p">,</span><span class="n">nz</span><span class="p">),</span><span class="n">varY</span><span class="p">(</span><span class="n">nx</span><span class="p">,</span><span class="n">ny</span><span class="p">,</span><span class="n">nz</span><span class="p">),</span><span class="n">varZ</span><span class="p">(</span><span class="n">nx</span><span class="p">,</span><span class="n">ny</span><span class="p">,</span><span class="n">nz</span><span class="p">),&amp;</span>
                                 <span class="n">nx</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">size</span><span class="p">(</span><span class="n">varX</span><span class="p">,</span><span class="nb">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)),</span><span class="n">ny</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">size</span><span class="p">(</span><span class="n">varX</span><span class="p">,</span><span class="nb">dim</span><span class="o">=</span><span class="mi">2</span><span class="p">)),</span><span class="n">nz</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">size</span><span class="p">(</span><span class="n">varX</span><span class="p">,</span><span class="nb">dim</span><span class="o">=</span><span class="mi">3</span><span class="p">))</span>
  <span class="k">case</span><span class="p">(</span><span class="n">binary</span><span class="p">)</span>
    <span class="n">s_buffer</span> <span class="o">=</span> <span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;DataArray type=&quot;Int64&quot; Name=&quot;&#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">varname</span><span class="p">)</span><span class="o">//</span><span class="p">&amp;</span>
               <span class="s1">&#39;&quot; NumberOfComponents=&quot;3&quot; format=&quot;binary&quot;&gt;&#39;</span>
    <span class="k">write</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">trim</span><span class="p">(</span><span class="n">s_buffer</span><span class="p">)</span><span class="o">//</span><span class="n">end_rec</span>
    <span class="k">allocate</span><span class="p">(</span><span class="n">var</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="o">*</span><span class="n">NC_NN</span><span class="p">))</span>
    <span class="n">n1</span> <span class="o">=</span> <span class="mi">0_I4P</span>
    <span class="k">do </span><span class="n">nz</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">size</span><span class="p">(</span><span class="n">varX</span><span class="p">,</span><span class="nb">dim</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span> <span class="p">;</span> <span class="k">do </span><span class="n">ny</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">size</span><span class="p">(</span><span class="n">varX</span><span class="p">,</span><span class="nb">dim</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span> <span class="p">;</span> <span class="k">do </span><span class="n">nx</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">size</span><span class="p">(</span><span class="n">varX</span><span class="p">,</span><span class="nb">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
      <span class="n">n1</span> <span class="o">=</span> <span class="n">n1</span> <span class="o">+</span> <span class="mi">1_I4P</span> <span class="p">;</span> <span class="n">var</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="p">(</span><span class="n">n1</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="mi">3</span><span class="p">:</span><span class="mi">1</span><span class="o">+</span><span class="p">(</span><span class="n">n1</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="mi">3</span><span class="o">+</span><span class="mi">2</span><span class="p">)</span><span class="o">=</span><span class="p">[</span><span class="n">varX</span><span class="p">(</span><span class="n">nx</span><span class="p">,</span><span class="n">ny</span><span class="p">,</span><span class="n">nz</span><span class="p">),</span><span class="n">varY</span><span class="p">(</span><span class="n">nx</span><span class="p">,</span><span class="n">ny</span><span class="p">,</span><span class="n">nz</span><span class="p">),</span><span class="n">varZ</span><span class="p">(</span><span class="n">nx</span><span class="p">,</span><span class="n">ny</span><span class="p">,</span><span class="n">nz</span><span class="p">)]</span>
    <span class="n">enddo</span> <span class="p">;</span> <span class="n">enddo</span> <span class="p">;</span> <span class="n">enddo</span>
    <span class="k">call </span><span class="n">pack_data</span><span class="p">(</span><span class="n">a1</span><span class="o">=</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="mi">3</span><span class="o">*</span><span class="n">NC_NN</span><span class="o">*</span><span class="n">BYI8P</span><span class="p">,</span><span class="n">I4P</span><span class="p">)],</span><span class="n">a2</span><span class="o">=</span><span class="n">var</span><span class="p">,</span><span class="n">packed</span><span class="o">=</span><span class="n">varp</span><span class="p">)</span> <span class="p">;</span> <span class="k">deallocate</span><span class="p">(</span><span class="n">var</span><span class="p">)</span>
    <span class="k">call </span><span class="n">b64_encode</span><span class="p">(</span><span class="n">nB</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">BYI1P</span><span class="p">,</span><span class="n">I4P</span><span class="p">),</span><span class="n">n</span><span class="o">=</span><span class="n">varp</span><span class="p">,</span><span class="n">code</span><span class="o">=</span><span class="n">var64</span><span class="p">)</span> <span class="p">;</span> <span class="k">deallocate</span><span class="p">(</span><span class="n">varp</span><span class="p">)</span>
    <span class="k">write</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="o">+</span><span class="mi">2</span><span class="p">)</span><span class="o">//</span><span class="n">tochar</span><span class="p">(</span><span class="n">var64</span><span class="p">)</span><span class="o">//</span><span class="n">end_rec</span> <span class="p">;</span> <span class="k">deallocate</span><span class="p">(</span><span class="n">var64</span><span class="p">)</span>
    <span class="k">write</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;/DataArray&gt;&#39;</span><span class="o">//</span><span class="n">end_rec</span>
  <span class="n">endselect</span>
  <span class="k">return</span>
  <span class="c">!---------------------------------------------------------------------------------------------------------------------------------</span>
  <span class="n">endfunction</span> <span class="n">VTK_VAR_XML_VECT_3DA_I8</span>

  <span class="c">!&gt; Function for saving field of vectorial variable (I4P, 1D arrays).</span>
  <span class="c">!&gt; @return E_IO: integer(I4P) error flag</span>
  <span class="k">function </span><span class="n">VTK_VAR_XML_VECT_1DA_I4</span><span class="p">(</span><span class="n">NC_NN</span><span class="p">,</span><span class="n">varname</span><span class="p">,</span><span class="n">varX</span><span class="p">,</span><span class="n">varY</span><span class="p">,</span><span class="n">varZ</span><span class="p">,</span><span class="n">cf</span><span class="p">)</span> <span class="k">result</span><span class="p">(</span><span class="n">E_IO</span><span class="p">)</span>
  <span class="c">!---------------------------------------------------------------------------------------------------------------------------------</span>
  <span class="k">implicit none</span>
<span class="k">  </span><span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span><span class="kd">::</span>           <span class="n">NC_NN</span>    <span class="c">!&lt; Number of cells or nodes.</span>
  <span class="kt">character</span><span class="p">(</span><span class="o">*</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span><span class="kd">::</span>           <span class="n">varname</span>  <span class="c">!&lt; Variable name.</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span><span class="kd">::</span>           <span class="n">varX</span><span class="p">(</span><span class="mi">1</span><span class="p">:)</span> <span class="c">!&lt; X component [1:NC_NN].</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span><span class="kd">::</span>           <span class="n">varY</span><span class="p">(</span><span class="mi">1</span><span class="p">:)</span> <span class="c">!&lt; Y component [1:NC_NN].</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span><span class="kd">::</span>           <span class="n">varZ</span><span class="p">(</span><span class="mi">1</span><span class="p">:)</span> <span class="c">!&lt; Z component [1:NC_NN].</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">),</span> <span class="k">optional</span><span class="kd">::</span> <span class="n">cf</span>       <span class="c">!&lt; Current file index (for concurrent files IO).</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">)</span><span class="kd">::</span>                       <span class="n">E_IO</span>     <span class="c">!&lt; Input/Output inquiring flag: $0$ if IO is done, $&gt; 0$ if IO is not done.</span>
  <span class="kt">character</span><span class="p">(</span><span class="nb">len</span><span class="o">=</span><span class="n">maxlen</span><span class="p">)</span><span class="kd">::</span>              <span class="n">s_buffer</span> <span class="c">!&lt; Buffer string.</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">),</span> <span class="k">allocatable</span><span class="kd">::</span>          <span class="n">var</span><span class="p">(:)</span>   <span class="c">!&lt; X, Y, Z component.</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I1P</span><span class="p">),</span> <span class="k">allocatable</span><span class="kd">::</span>          <span class="n">varp</span><span class="p">(:)</span>  <span class="c">!&lt; Packed data.</span>
  <span class="kt">character</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="k">allocatable</span><span class="kd">::</span>          <span class="n">var64</span><span class="p">(:)</span> <span class="c">!&lt; Variable encoded in base64.</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">)</span><span class="kd">::</span>                       <span class="n">rf</span>       <span class="c">!&lt; Real file index.</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">)</span><span class="kd">::</span>                       <span class="n">n1</span>       <span class="c">!&lt; Counter.</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I8P</span><span class="p">)</span><span class="kd">::</span>                       <span class="n">Nvarp</span>    <span class="c">!&lt; Dimension of varp, packed data.</span>
  <span class="c">!---------------------------------------------------------------------------------------------------------------------------------</span>

  <span class="c">!---------------------------------------------------------------------------------------------------------------------------------</span>
  <span class="n">E_IO</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1_I4P</span>
  <span class="n">rf</span> <span class="o">=</span> <span class="n">f</span>
  <span class="k">if</span> <span class="p">(</span><span class="nb">present</span><span class="p">(</span><span class="n">cf</span><span class="p">))</span> <span class="k">then</span>
<span class="k">    </span><span class="n">rf</span> <span class="o">=</span> <span class="n">cf</span> <span class="p">;</span> <span class="n">f</span> <span class="o">=</span> <span class="n">cf</span>
  <span class="n">endif</span>
  <span class="k">select case</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">f</span><span class="p">)</span>
  <span class="k">case</span><span class="p">(</span><span class="n">ascii</span><span class="p">)</span>
    <span class="n">s_buffer</span> <span class="o">=</span> <span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;DataArray type=&quot;Int32&quot; Name=&quot;&#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">varname</span><span class="p">)</span><span class="o">//</span><span class="p">&amp;</span>
               <span class="s1">&#39;&quot; NumberOfComponents=&quot;3&quot; format=&quot;ascii&quot;&gt;&#39;</span>
    <span class="k">write</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="s1">&#39;(A)&#39;</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">trim</span><span class="p">(</span><span class="n">s_buffer</span><span class="p">)</span>
    <span class="k">do </span><span class="n">n1</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">NC_NN</span>
      <span class="k">write</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="s1">&#39;(A)&#39;</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="n">str</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">varX</span><span class="p">(</span><span class="n">n1</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39; &#39;</span><span class="o">//</span><span class="n">str</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">varY</span><span class="p">(</span><span class="n">n1</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39; &#39;</span><span class="o">//</span><span class="n">str</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">varZ</span><span class="p">(</span><span class="n">n1</span><span class="p">))</span>
    <span class="n">enddo</span>
    <span class="k">write</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="s1">&#39;(A)&#39;</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;/DataArray&gt;&#39;</span>
  <span class="k">case</span><span class="p">(</span><span class="n">raw</span><span class="p">,</span><span class="n">bin_app</span><span class="p">)</span>
    <span class="n">s_buffer</span> <span class="o">=</span> <span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;DataArray type=&quot;Int32&quot; Name=&quot;&#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">varname</span><span class="p">)</span><span class="o">//</span><span class="p">&amp;</span>
               <span class="s1">&#39;&quot; NumberOfComponents=&quot;3&quot; format=&quot;appended&quot; offset=&quot;&#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(.</span><span class="n">true</span><span class="p">.,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">ioffset</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39;&quot;/&gt;&#39;</span>
    <span class="k">write</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">trim</span><span class="p">(</span><span class="n">s_buffer</span><span class="p">)</span><span class="o">//</span><span class="n">end_rec</span>
    <span class="k">call </span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">byte_update</span><span class="p">(</span><span class="n">N_Byte</span> <span class="o">=</span> <span class="mi">3</span><span class="o">*</span><span class="n">NC_NN</span><span class="o">*</span><span class="n">BYI4P</span><span class="p">)</span>
    <span class="k">write</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">ua</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">N_Byte</span><span class="p">,</span><span class="s1">&#39;I4&#39;</span><span class="p">,</span><span class="mi">3</span><span class="o">*</span><span class="n">NC_NN</span>
    <span class="k">write</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">ua</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)(</span><span class="n">varX</span><span class="p">(</span><span class="n">n1</span><span class="p">),</span><span class="n">varY</span><span class="p">(</span><span class="n">n1</span><span class="p">),</span><span class="n">varZ</span><span class="p">(</span><span class="n">n1</span><span class="p">),</span><span class="n">n1</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">NC_NN</span><span class="p">)</span>
  <span class="k">case</span><span class="p">(</span><span class="n">binary</span><span class="p">)</span>
    <span class="n">s_buffer</span> <span class="o">=</span> <span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;DataArray type=&quot;Int32&quot; Name=&quot;&#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">varname</span><span class="p">)</span><span class="o">//</span><span class="p">&amp;</span>
               <span class="s1">&#39;&quot; NumberOfComponents=&quot;3&quot; format=&quot;binary&quot;&gt;&#39;</span>
    <span class="k">write</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">trim</span><span class="p">(</span><span class="n">s_buffer</span><span class="p">)</span><span class="o">//</span><span class="n">end_rec</span>
    <span class="k">allocate</span><span class="p">(</span><span class="n">var</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="o">*</span><span class="n">NC_NN</span><span class="p">))</span>
    <span class="k">do </span><span class="n">n1</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">NC_NN</span>
      <span class="n">var</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="p">(</span><span class="n">n1</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="mi">3</span><span class="p">:</span><span class="mi">1</span><span class="o">+</span><span class="p">(</span><span class="n">n1</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="mi">3</span><span class="o">+</span><span class="mi">2</span><span class="p">)</span><span class="o">=</span><span class="p">[</span><span class="n">varX</span><span class="p">(</span><span class="n">n1</span><span class="p">),</span><span class="n">varY</span><span class="p">(</span><span class="n">n1</span><span class="p">),</span><span class="n">varZ</span><span class="p">(</span><span class="n">n1</span><span class="p">)]</span>
    <span class="n">enddo</span>
    <span class="n">Nvarp</span><span class="o">=</span><span class="n">size</span><span class="p">(</span><span class="nb">transfer</span><span class="p">([</span><span class="nb">int</span><span class="p">(</span><span class="mi">3</span><span class="o">*</span><span class="n">NC_NN</span><span class="o">*</span><span class="n">BYI4P</span><span class="p">,</span><span class="n">I4P</span><span class="p">),</span><span class="n">var</span><span class="p">],</span><span class="n">varp</span><span class="p">),</span><span class="nb">kind</span><span class="o">=</span><span class="n">I8P</span><span class="p">)</span>
    <span class="k">if</span> <span class="p">(</span><span class="nb">allocated</span><span class="p">(</span><span class="n">varp</span><span class="p">))</span> <span class="k">deallocate</span><span class="p">(</span><span class="n">varp</span><span class="p">);</span> <span class="k">allocate</span><span class="p">(</span><span class="n">varp</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">Nvarp</span><span class="p">))</span>
    <span class="n">varp</span> <span class="o">=</span> <span class="nb">transfer</span><span class="p">([</span><span class="nb">int</span><span class="p">(</span><span class="mi">3</span><span class="o">*</span><span class="n">NC_NN</span><span class="o">*</span><span class="n">BYI4P</span><span class="p">,</span><span class="n">I4P</span><span class="p">),</span><span class="n">var</span><span class="p">],</span><span class="n">varp</span><span class="p">)</span> <span class="p">;</span> <span class="k">deallocate</span><span class="p">(</span><span class="n">var</span><span class="p">)</span>
    <span class="k">call </span><span class="n">b64_encode</span><span class="p">(</span><span class="n">nB</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">BYI1P</span><span class="p">,</span><span class="n">I4P</span><span class="p">),</span><span class="n">n</span><span class="o">=</span><span class="n">varp</span><span class="p">,</span><span class="n">code</span><span class="o">=</span><span class="n">var64</span><span class="p">)</span> <span class="p">;</span> <span class="k">deallocate</span><span class="p">(</span><span class="n">varp</span><span class="p">)</span>
    <span class="k">write</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="o">+</span><span class="mi">2</span><span class="p">)</span><span class="o">//</span><span class="n">tochar</span><span class="p">(</span><span class="n">var64</span><span class="p">)</span><span class="o">//</span><span class="n">end_rec</span> <span class="p">;</span> <span class="k">deallocate</span><span class="p">(</span><span class="n">var64</span><span class="p">)</span>
    <span class="k">write</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;/DataArray&gt;&#39;</span><span class="o">//</span><span class="n">end_rec</span>
  <span class="n">endselect</span>
  <span class="k">return</span>
  <span class="c">!---------------------------------------------------------------------------------------------------------------------------------</span>
  <span class="n">endfunction</span> <span class="n">VTK_VAR_XML_VECT_1DA_I4</span>

  <span class="c">!&gt; Function for saving field of vectorial variable (I4P, 3D arrays).</span>
  <span class="c">!&gt; @return E_IO: integer(I4P) error flag</span>
  <span class="k">function </span><span class="n">VTK_VAR_XML_VECT_3DA_I4</span><span class="p">(</span><span class="n">NC_NN</span><span class="p">,</span><span class="n">varname</span><span class="p">,</span><span class="n">varX</span><span class="p">,</span><span class="n">varY</span><span class="p">,</span><span class="n">varZ</span><span class="p">,</span><span class="n">cf</span><span class="p">)</span> <span class="k">result</span><span class="p">(</span><span class="n">E_IO</span><span class="p">)</span>
  <span class="c">!---------------------------------------------------------------------------------------------------------------------------------</span>
  <span class="k">implicit none</span>
<span class="k">  </span><span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span><span class="kd">::</span>           <span class="n">NC_NN</span>          <span class="c">!&lt; Number of cells or nodes.</span>
  <span class="kt">character</span><span class="p">(</span><span class="o">*</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span><span class="kd">::</span>           <span class="n">varname</span>        <span class="c">!&lt; Variable name.</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span><span class="kd">::</span>           <span class="n">varX</span><span class="p">(</span><span class="mi">1</span><span class="p">:,</span><span class="mi">1</span><span class="p">:,</span><span class="mi">1</span><span class="p">:)</span> <span class="c">!&lt; X component [1:Nx,1:Ny,1:Nz].</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span><span class="kd">::</span>           <span class="n">varY</span><span class="p">(</span><span class="mi">1</span><span class="p">:,</span><span class="mi">1</span><span class="p">:,</span><span class="mi">1</span><span class="p">:)</span> <span class="c">!&lt; Y component [1:Nx,1:Ny,1:Nz].</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span><span class="kd">::</span>           <span class="n">varZ</span><span class="p">(</span><span class="mi">1</span><span class="p">:,</span><span class="mi">1</span><span class="p">:,</span><span class="mi">1</span><span class="p">:)</span> <span class="c">!&lt; Z component [1:Nx,1:Ny,1:Nz].</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">),</span> <span class="k">optional</span><span class="kd">::</span> <span class="n">cf</span>             <span class="c">!&lt; Current file index (for concurrent files IO).</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">)</span><span class="kd">::</span>                       <span class="n">E_IO</span>           <span class="c">!&lt; Input/Output inquiring flag: $0$ if IO is done, $&gt; 0$ if IO is not done.</span>
  <span class="kt">character</span><span class="p">(</span><span class="nb">len</span><span class="o">=</span><span class="n">maxlen</span><span class="p">)</span><span class="kd">::</span>              <span class="n">s_buffer</span>       <span class="c">!&lt; Buffer string.</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">),</span> <span class="k">allocatable</span><span class="kd">::</span>          <span class="n">var</span><span class="p">(:)</span>         <span class="c">!&lt; X, Y, Z component.</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I1P</span><span class="p">),</span> <span class="k">allocatable</span><span class="kd">::</span>          <span class="n">varp</span><span class="p">(:)</span>        <span class="c">!&lt; Packed data.</span>
  <span class="kt">character</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="k">allocatable</span><span class="kd">::</span>          <span class="n">var64</span><span class="p">(:)</span>       <span class="c">!&lt; Variable encoded in base64.</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">)</span><span class="kd">::</span>                       <span class="n">rf</span>             <span class="c">!&lt; Real file index.</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">)</span><span class="kd">::</span>                       <span class="n">nx</span><span class="p">,</span><span class="n">ny</span><span class="p">,</span><span class="n">nz</span><span class="p">,</span><span class="n">n1</span>    <span class="c">!&lt; Counters.</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I8P</span><span class="p">)</span><span class="kd">::</span>                       <span class="n">Nvarp</span>          <span class="c">!&lt; Dimension of varp, packed data.</span>
  <span class="c">!---------------------------------------------------------------------------------------------------------------------------------</span>

  <span class="c">!---------------------------------------------------------------------------------------------------------------------------------</span>
  <span class="n">E_IO</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1_I4P</span>
  <span class="n">rf</span> <span class="o">=</span> <span class="n">f</span>
  <span class="k">if</span> <span class="p">(</span><span class="nb">present</span><span class="p">(</span><span class="n">cf</span><span class="p">))</span> <span class="k">then</span>
<span class="k">    </span><span class="n">rf</span> <span class="o">=</span> <span class="n">cf</span> <span class="p">;</span> <span class="n">f</span> <span class="o">=</span> <span class="n">cf</span>
  <span class="n">endif</span>
  <span class="k">select case</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">f</span><span class="p">)</span>
  <span class="k">case</span><span class="p">(</span><span class="n">ascii</span><span class="p">)</span>
    <span class="n">s_buffer</span> <span class="o">=</span> <span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;DataArray type=&quot;Int32&quot; Name=&quot;&#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">varname</span><span class="p">)</span><span class="o">//</span><span class="p">&amp;</span>
               <span class="s1">&#39;&quot; NumberOfComponents=&quot;3&quot; format=&quot;ascii&quot;&gt;&#39;</span>
    <span class="k">write</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="s1">&#39;(A)&#39;</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">trim</span><span class="p">(</span><span class="n">s_buffer</span><span class="p">)</span>
    <span class="k">do </span><span class="n">nz</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">size</span><span class="p">(</span><span class="n">varX</span><span class="p">,</span><span class="nb">dim</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span> <span class="p">;</span> <span class="k">do </span><span class="n">ny</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">size</span><span class="p">(</span><span class="n">varX</span><span class="p">,</span><span class="nb">dim</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span> <span class="p">;</span> <span class="k">do </span><span class="n">nx</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">size</span><span class="p">(</span><span class="n">varX</span><span class="p">,</span><span class="nb">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
      <span class="k">write</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="s1">&#39;(A)&#39;</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="p">&amp;</span>
                                        <span class="n">str</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">varX</span><span class="p">(</span><span class="n">nx</span><span class="p">,</span><span class="n">ny</span><span class="p">,</span><span class="n">nz</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39; &#39;</span><span class="o">//</span><span class="n">str</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">varY</span><span class="p">(</span><span class="n">nx</span><span class="p">,</span><span class="n">ny</span><span class="p">,</span><span class="n">nz</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39; &#39;</span><span class="o">//</span><span class="n">str</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">varZ</span><span class="p">(</span><span class="n">nx</span><span class="p">,</span><span class="n">ny</span><span class="p">,</span><span class="n">nz</span><span class="p">))</span>
    <span class="n">enddo</span> <span class="p">;</span> <span class="n">enddo</span> <span class="p">;</span> <span class="n">enddo</span>
    <span class="k">write</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="s1">&#39;(A)&#39;</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;/DataArray&gt;&#39;</span>
  <span class="k">case</span><span class="p">(</span><span class="n">raw</span><span class="p">,</span><span class="n">bin_app</span><span class="p">)</span>
    <span class="n">s_buffer</span> <span class="o">=</span> <span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;DataArray type=&quot;Int32&quot; Name=&quot;&#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">varname</span><span class="p">)</span><span class="o">//</span><span class="p">&amp;</span>
               <span class="s1">&#39;&quot; NumberOfComponents=&quot;3&quot; format=&quot;appended&quot; offset=&quot;&#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(.</span><span class="n">true</span><span class="p">.,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">ioffset</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39;&quot;/&gt;&#39;</span>
    <span class="k">write</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">trim</span><span class="p">(</span><span class="n">s_buffer</span><span class="p">)</span><span class="o">//</span><span class="n">end_rec</span>
    <span class="k">call </span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">byte_update</span><span class="p">(</span><span class="n">N_Byte</span> <span class="o">=</span> <span class="mi">3</span><span class="o">*</span><span class="n">NC_NN</span><span class="o">*</span><span class="n">BYI4P</span><span class="p">)</span>
    <span class="k">write</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">ua</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">N_Byte</span><span class="p">,</span><span class="s1">&#39;I4&#39;</span><span class="p">,</span><span class="mi">3</span><span class="o">*</span><span class="n">NC_NN</span>
    <span class="k">write</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">ua</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)(((</span><span class="n">varX</span><span class="p">(</span><span class="n">nx</span><span class="p">,</span><span class="n">ny</span><span class="p">,</span><span class="n">nz</span><span class="p">),</span><span class="n">varY</span><span class="p">(</span><span class="n">nx</span><span class="p">,</span><span class="n">ny</span><span class="p">,</span><span class="n">nz</span><span class="p">),</span><span class="n">varZ</span><span class="p">(</span><span class="n">nx</span><span class="p">,</span><span class="n">ny</span><span class="p">,</span><span class="n">nz</span><span class="p">),&amp;</span>
                                 <span class="n">nx</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">size</span><span class="p">(</span><span class="n">varX</span><span class="p">,</span><span class="nb">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)),</span><span class="n">ny</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">size</span><span class="p">(</span><span class="n">varX</span><span class="p">,</span><span class="nb">dim</span><span class="o">=</span><span class="mi">2</span><span class="p">)),</span><span class="n">nz</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">size</span><span class="p">(</span><span class="n">varX</span><span class="p">,</span><span class="nb">dim</span><span class="o">=</span><span class="mi">3</span><span class="p">))</span>
  <span class="k">case</span><span class="p">(</span><span class="n">binary</span><span class="p">)</span>
    <span class="n">s_buffer</span> <span class="o">=</span> <span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;DataArray type=&quot;Int32&quot; Name=&quot;&#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">varname</span><span class="p">)</span><span class="o">//</span><span class="p">&amp;</span>
               <span class="s1">&#39;&quot; NumberOfComponents=&quot;3&quot; format=&quot;binary&quot;&gt;&#39;</span>
    <span class="k">write</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">trim</span><span class="p">(</span><span class="n">s_buffer</span><span class="p">)</span><span class="o">//</span><span class="n">end_rec</span>
    <span class="k">allocate</span><span class="p">(</span><span class="n">var</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="o">*</span><span class="n">NC_NN</span><span class="p">))</span>
    <span class="n">n1</span> <span class="o">=</span> <span class="mi">0_I4P</span>
    <span class="k">do </span><span class="n">nz</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">size</span><span class="p">(</span><span class="n">varX</span><span class="p">,</span><span class="nb">dim</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span> <span class="p">;</span> <span class="k">do </span><span class="n">ny</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">size</span><span class="p">(</span><span class="n">varX</span><span class="p">,</span><span class="nb">dim</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span> <span class="p">;</span> <span class="k">do </span><span class="n">nx</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">size</span><span class="p">(</span><span class="n">varX</span><span class="p">,</span><span class="nb">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
      <span class="n">n1</span> <span class="o">=</span> <span class="n">n1</span> <span class="o">+</span> <span class="mi">1_I4P</span> <span class="p">;</span> <span class="n">var</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="p">(</span><span class="n">n1</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="mi">3</span><span class="p">:</span><span class="mi">1</span><span class="o">+</span><span class="p">(</span><span class="n">n1</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="mi">3</span><span class="o">+</span><span class="mi">2</span><span class="p">)</span><span class="o">=</span><span class="p">[</span><span class="n">varX</span><span class="p">(</span><span class="n">nx</span><span class="p">,</span><span class="n">ny</span><span class="p">,</span><span class="n">nz</span><span class="p">),</span><span class="n">varY</span><span class="p">(</span><span class="n">nx</span><span class="p">,</span><span class="n">ny</span><span class="p">,</span><span class="n">nz</span><span class="p">),</span><span class="n">varZ</span><span class="p">(</span><span class="n">nx</span><span class="p">,</span><span class="n">ny</span><span class="p">,</span><span class="n">nz</span><span class="p">)]</span>
    <span class="n">enddo</span> <span class="p">;</span> <span class="n">enddo</span> <span class="p">;</span> <span class="n">enddo</span>
    <span class="n">Nvarp</span><span class="o">=</span><span class="n">size</span><span class="p">(</span><span class="nb">transfer</span><span class="p">([</span><span class="nb">int</span><span class="p">(</span><span class="mi">3</span><span class="o">*</span><span class="n">NC_NN</span><span class="o">*</span><span class="n">BYI4P</span><span class="p">,</span><span class="n">I4P</span><span class="p">),</span><span class="n">var</span><span class="p">],</span><span class="n">varp</span><span class="p">),</span><span class="nb">kind</span><span class="o">=</span><span class="n">I8P</span><span class="p">)</span>
    <span class="k">if</span> <span class="p">(</span><span class="nb">allocated</span><span class="p">(</span><span class="n">varp</span><span class="p">))</span> <span class="k">deallocate</span><span class="p">(</span><span class="n">varp</span><span class="p">);</span> <span class="k">allocate</span><span class="p">(</span><span class="n">varp</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">Nvarp</span><span class="p">))</span>
    <span class="n">varp</span> <span class="o">=</span> <span class="nb">transfer</span><span class="p">([</span><span class="nb">int</span><span class="p">(</span><span class="mi">3</span><span class="o">*</span><span class="n">NC_NN</span><span class="o">*</span><span class="n">BYI4P</span><span class="p">,</span><span class="n">I4P</span><span class="p">),</span><span class="n">var</span><span class="p">],</span><span class="n">varp</span><span class="p">)</span> <span class="p">;</span> <span class="k">deallocate</span><span class="p">(</span><span class="n">var</span><span class="p">)</span>
    <span class="k">call </span><span class="n">b64_encode</span><span class="p">(</span><span class="n">nB</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">BYI1P</span><span class="p">,</span><span class="n">I4P</span><span class="p">),</span><span class="n">n</span><span class="o">=</span><span class="n">varp</span><span class="p">,</span><span class="n">code</span><span class="o">=</span><span class="n">var64</span><span class="p">)</span> <span class="p">;</span> <span class="k">deallocate</span><span class="p">(</span><span class="n">varp</span><span class="p">)</span>
    <span class="k">write</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="o">+</span><span class="mi">2</span><span class="p">)</span><span class="o">//</span><span class="n">tochar</span><span class="p">(</span><span class="n">var64</span><span class="p">)</span><span class="o">//</span><span class="n">end_rec</span> <span class="p">;</span> <span class="k">deallocate</span><span class="p">(</span><span class="n">var64</span><span class="p">)</span>
    <span class="k">write</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;/DataArray&gt;&#39;</span><span class="o">//</span><span class="n">end_rec</span>
  <span class="n">endselect</span>
  <span class="k">return</span>
  <span class="c">!---------------------------------------------------------------------------------------------------------------------------------</span>
  <span class="n">endfunction</span> <span class="n">VTK_VAR_XML_VECT_3DA_I4</span>

  <span class="c">!&gt; Function for saving field of vectorial variable (I2P, 1D arrays).</span>
  <span class="c">!&gt; @return E_IO: integer(I4P) error flag</span>
  <span class="k">function </span><span class="n">VTK_VAR_XML_VECT_1DA_I2</span><span class="p">(</span><span class="n">NC_NN</span><span class="p">,</span><span class="n">varname</span><span class="p">,</span><span class="n">varX</span><span class="p">,</span><span class="n">varY</span><span class="p">,</span><span class="n">varZ</span><span class="p">,</span><span class="n">cf</span><span class="p">)</span> <span class="k">result</span><span class="p">(</span><span class="n">E_IO</span><span class="p">)</span>
  <span class="c">!---------------------------------------------------------------------------------------------------------------------------------</span>
  <span class="k">implicit none</span>
<span class="k">  </span><span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span><span class="kd">::</span>           <span class="n">NC_NN</span>    <span class="c">!&lt; Number of cells or nodes.</span>
  <span class="kt">character</span><span class="p">(</span><span class="o">*</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span><span class="kd">::</span>           <span class="n">varname</span>  <span class="c">!&lt; Variable name.</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I2P</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span><span class="kd">::</span>           <span class="n">varX</span><span class="p">(</span><span class="mi">1</span><span class="p">:)</span> <span class="c">!&lt; X component [1:NC_NN].</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I2P</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span><span class="kd">::</span>           <span class="n">varY</span><span class="p">(</span><span class="mi">1</span><span class="p">:)</span> <span class="c">!&lt; Y component [1:NC_NN].</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I2P</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span><span class="kd">::</span>           <span class="n">varZ</span><span class="p">(</span><span class="mi">1</span><span class="p">:)</span> <span class="c">!&lt; Z component [1:NC_NN].</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">),</span> <span class="k">optional</span><span class="kd">::</span> <span class="n">cf</span>       <span class="c">!&lt; Current file index (for concurrent files IO).</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">)</span><span class="kd">::</span>                       <span class="n">E_IO</span>     <span class="c">!&lt; Input/Output inquiring flag: $0$ if IO is done, $&gt; 0$ if IO is not done.</span>
  <span class="kt">character</span><span class="p">(</span><span class="nb">len</span><span class="o">=</span><span class="n">maxlen</span><span class="p">)</span><span class="kd">::</span>              <span class="n">s_buffer</span> <span class="c">!&lt; Buffer string.</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I2P</span><span class="p">),</span> <span class="k">allocatable</span><span class="kd">::</span>          <span class="n">var</span><span class="p">(:)</span>   <span class="c">!&lt; X, Y, Z component.</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I1P</span><span class="p">),</span> <span class="k">allocatable</span><span class="kd">::</span>          <span class="n">varp</span><span class="p">(:)</span>  <span class="c">!&lt; Packed data.</span>
  <span class="kt">character</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="k">allocatable</span><span class="kd">::</span>          <span class="n">var64</span><span class="p">(:)</span> <span class="c">!&lt; Variable encoded in base64.</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">)</span><span class="kd">::</span>                       <span class="n">rf</span>       <span class="c">!&lt; Real file index.</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">)</span><span class="kd">::</span>                       <span class="n">n1</span>       <span class="c">!&lt; Counter.</span>
  <span class="c">!---------------------------------------------------------------------------------------------------------------------------------</span>

  <span class="c">!---------------------------------------------------------------------------------------------------------------------------------</span>
  <span class="n">E_IO</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1_I4P</span>
  <span class="n">rf</span> <span class="o">=</span> <span class="n">f</span>
  <span class="k">if</span> <span class="p">(</span><span class="nb">present</span><span class="p">(</span><span class="n">cf</span><span class="p">))</span> <span class="k">then</span>
<span class="k">    </span><span class="n">rf</span> <span class="o">=</span> <span class="n">cf</span> <span class="p">;</span> <span class="n">f</span> <span class="o">=</span> <span class="n">cf</span>
  <span class="n">endif</span>
  <span class="k">select case</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">f</span><span class="p">)</span>
  <span class="k">case</span><span class="p">(</span><span class="n">ascii</span><span class="p">)</span>
    <span class="n">s_buffer</span> <span class="o">=</span> <span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;DataArray type=&quot;Int16&quot; Name=&quot;&#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">varname</span><span class="p">)</span><span class="o">//</span><span class="p">&amp;</span>
               <span class="s1">&#39;&quot; NumberOfComponents=&quot;3&quot; format=&quot;ascii&quot;&gt;&#39;</span>
    <span class="k">write</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="s1">&#39;(A)&#39;</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">trim</span><span class="p">(</span><span class="n">s_buffer</span><span class="p">)</span>
    <span class="k">do </span><span class="n">n1</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">NC_NN</span>
      <span class="k">write</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="s1">&#39;(A)&#39;</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="n">str</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">varX</span><span class="p">(</span><span class="n">n1</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39; &#39;</span><span class="o">//</span><span class="n">str</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">varY</span><span class="p">(</span><span class="n">n1</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39; &#39;</span><span class="o">//</span><span class="n">str</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">varZ</span><span class="p">(</span><span class="n">n1</span><span class="p">))</span>
    <span class="n">enddo</span>
    <span class="k">write</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="s1">&#39;(A)&#39;</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;/DataArray&gt;&#39;</span>
  <span class="k">case</span><span class="p">(</span><span class="n">raw</span><span class="p">,</span><span class="n">bin_app</span><span class="p">)</span>
    <span class="n">s_buffer</span> <span class="o">=</span> <span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;DataArray type=&quot;Int16&quot; Name=&quot;&#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">varname</span><span class="p">)</span><span class="o">//</span><span class="p">&amp;</span>
               <span class="s1">&#39;&quot; NumberOfComponents=&quot;3&quot; format=&quot;appended&quot; offset=&quot;&#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(.</span><span class="n">true</span><span class="p">.,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">ioffset</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39;&quot;/&gt;&#39;</span>
    <span class="k">write</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">trim</span><span class="p">(</span><span class="n">s_buffer</span><span class="p">)</span><span class="o">//</span><span class="n">end_rec</span>
    <span class="k">call </span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">byte_update</span><span class="p">(</span><span class="n">N_Byte</span> <span class="o">=</span> <span class="mi">3</span><span class="o">*</span><span class="n">NC_NN</span><span class="o">*</span><span class="n">BYI2P</span><span class="p">)</span>
    <span class="k">write</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">ua</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">N_Byte</span><span class="p">,</span><span class="s1">&#39;I2&#39;</span><span class="p">,</span><span class="mi">3</span><span class="o">*</span><span class="n">NC_NN</span>
    <span class="k">write</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">ua</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)(</span><span class="n">varX</span><span class="p">(</span><span class="n">n1</span><span class="p">),</span><span class="n">varY</span><span class="p">(</span><span class="n">n1</span><span class="p">),</span><span class="n">varZ</span><span class="p">(</span><span class="n">n1</span><span class="p">),</span><span class="n">n1</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">NC_NN</span><span class="p">)</span>
  <span class="k">case</span><span class="p">(</span><span class="n">binary</span><span class="p">)</span>
    <span class="n">s_buffer</span> <span class="o">=</span> <span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;DataArray type=&quot;Int16&quot; Name=&quot;&#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">varname</span><span class="p">)</span><span class="o">//</span><span class="p">&amp;</span>
               <span class="s1">&#39;&quot; NumberOfComponents=&quot;3&quot; format=&quot;binary&quot;&gt;&#39;</span>
    <span class="k">write</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">trim</span><span class="p">(</span><span class="n">s_buffer</span><span class="p">)</span><span class="o">//</span><span class="n">end_rec</span>
    <span class="k">allocate</span><span class="p">(</span><span class="n">var</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="o">*</span><span class="n">NC_NN</span><span class="p">))</span>
    <span class="k">do </span><span class="n">n1</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">NC_NN</span>
      <span class="n">var</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="p">(</span><span class="n">n1</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="mi">3</span><span class="p">:</span><span class="mi">1</span><span class="o">+</span><span class="p">(</span><span class="n">n1</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="mi">3</span><span class="o">+</span><span class="mi">2</span><span class="p">)</span><span class="o">=</span><span class="p">[</span><span class="n">varX</span><span class="p">(</span><span class="n">n1</span><span class="p">),</span><span class="n">varY</span><span class="p">(</span><span class="n">n1</span><span class="p">),</span><span class="n">varZ</span><span class="p">(</span><span class="n">n1</span><span class="p">)]</span>
    <span class="n">enddo</span>
    <span class="k">call </span><span class="n">pack_data</span><span class="p">(</span><span class="n">a1</span><span class="o">=</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="mi">3</span><span class="o">*</span><span class="n">NC_NN</span><span class="o">*</span><span class="n">BYI2P</span><span class="p">,</span><span class="n">I4P</span><span class="p">)],</span><span class="n">a2</span><span class="o">=</span><span class="n">var</span><span class="p">,</span><span class="n">packed</span><span class="o">=</span><span class="n">varp</span><span class="p">)</span> <span class="p">;</span> <span class="k">deallocate</span><span class="p">(</span><span class="n">var</span><span class="p">)</span>
    <span class="k">call </span><span class="n">b64_encode</span><span class="p">(</span><span class="n">nB</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">BYI1P</span><span class="p">,</span><span class="n">I4P</span><span class="p">),</span><span class="n">n</span><span class="o">=</span><span class="n">varp</span><span class="p">,</span><span class="n">code</span><span class="o">=</span><span class="n">var64</span><span class="p">)</span> <span class="p">;</span> <span class="k">deallocate</span><span class="p">(</span><span class="n">varp</span><span class="p">)</span>
    <span class="k">write</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="o">+</span><span class="mi">2</span><span class="p">)</span><span class="o">//</span><span class="n">tochar</span><span class="p">(</span><span class="n">var64</span><span class="p">)</span><span class="o">//</span><span class="n">end_rec</span> <span class="p">;</span> <span class="k">deallocate</span><span class="p">(</span><span class="n">var64</span><span class="p">)</span>
    <span class="k">write</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;/DataArray&gt;&#39;</span><span class="o">//</span><span class="n">end_rec</span>
  <span class="n">endselect</span>
  <span class="k">return</span>
  <span class="c">!---------------------------------------------------------------------------------------------------------------------------------</span>
  <span class="n">endfunction</span> <span class="n">VTK_VAR_XML_VECT_1DA_I2</span>

  <span class="c">!&gt; Function for saving field of vectorial variable (I2P, 3D arrays).</span>
  <span class="c">!&gt; @return E_IO: integer(I4P) error flag</span>
  <span class="k">function </span><span class="n">VTK_VAR_XML_VECT_3DA_I2</span><span class="p">(</span><span class="n">NC_NN</span><span class="p">,</span><span class="n">varname</span><span class="p">,</span><span class="n">varX</span><span class="p">,</span><span class="n">varY</span><span class="p">,</span><span class="n">varZ</span><span class="p">,</span><span class="n">cf</span><span class="p">)</span> <span class="k">result</span><span class="p">(</span><span class="n">E_IO</span><span class="p">)</span>
  <span class="c">!---------------------------------------------------------------------------------------------------------------------------------</span>
  <span class="k">implicit none</span>
<span class="k">  </span><span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span><span class="kd">::</span>           <span class="n">NC_NN</span>          <span class="c">!&lt; Number of cells or nodes.</span>
  <span class="kt">character</span><span class="p">(</span><span class="o">*</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span><span class="kd">::</span>           <span class="n">varname</span>        <span class="c">!&lt; Variable name.</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I2P</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span><span class="kd">::</span>           <span class="n">varX</span><span class="p">(</span><span class="mi">1</span><span class="p">:,</span><span class="mi">1</span><span class="p">:,</span><span class="mi">1</span><span class="p">:)</span> <span class="c">!&lt; X component [1:Nx,1:Ny,1:Nz].</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I2P</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span><span class="kd">::</span>           <span class="n">varY</span><span class="p">(</span><span class="mi">1</span><span class="p">:,</span><span class="mi">1</span><span class="p">:,</span><span class="mi">1</span><span class="p">:)</span> <span class="c">!&lt; Y component [1:Nx,1:Ny,1:Nz].</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I2P</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span><span class="kd">::</span>           <span class="n">varZ</span><span class="p">(</span><span class="mi">1</span><span class="p">:,</span><span class="mi">1</span><span class="p">:,</span><span class="mi">1</span><span class="p">:)</span> <span class="c">!&lt; Z component [1:Nx,1:Ny,1:Nz].</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">),</span> <span class="k">optional</span><span class="kd">::</span> <span class="n">cf</span>             <span class="c">!&lt; Current file index (for concurrent files IO).</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">)</span><span class="kd">::</span>                       <span class="n">E_IO</span>           <span class="c">!&lt; Input/Output inquiring flag: $0$ if IO is done, $&gt; 0$ if IO is not done.</span>
  <span class="kt">character</span><span class="p">(</span><span class="nb">len</span><span class="o">=</span><span class="n">maxlen</span><span class="p">)</span><span class="kd">::</span>              <span class="n">s_buffer</span>       <span class="c">!&lt; Buffer string.</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I2P</span><span class="p">),</span> <span class="k">allocatable</span><span class="kd">::</span>          <span class="n">var</span><span class="p">(:)</span>         <span class="c">!&lt; X, Y, Z component.</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I1P</span><span class="p">),</span> <span class="k">allocatable</span><span class="kd">::</span>          <span class="n">varp</span><span class="p">(:)</span>        <span class="c">!&lt; Packed data.</span>
  <span class="kt">character</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="k">allocatable</span><span class="kd">::</span>          <span class="n">var64</span><span class="p">(:)</span>       <span class="c">!&lt; Variable encoded in base64.</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">)</span><span class="kd">::</span>                       <span class="n">rf</span>             <span class="c">!&lt; Real file index.</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">)</span><span class="kd">::</span>                       <span class="n">nx</span><span class="p">,</span><span class="n">ny</span><span class="p">,</span><span class="n">nz</span><span class="p">,</span><span class="n">n1</span>    <span class="c">!&lt; Counters.</span>
  <span class="c">!---------------------------------------------------------------------------------------------------------------------------------</span>

  <span class="c">!---------------------------------------------------------------------------------------------------------------------------------</span>
  <span class="n">E_IO</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1_I4P</span>
  <span class="n">rf</span> <span class="o">=</span> <span class="n">f</span>
  <span class="k">if</span> <span class="p">(</span><span class="nb">present</span><span class="p">(</span><span class="n">cf</span><span class="p">))</span> <span class="k">then</span>
<span class="k">    </span><span class="n">rf</span> <span class="o">=</span> <span class="n">cf</span> <span class="p">;</span> <span class="n">f</span> <span class="o">=</span> <span class="n">cf</span>
  <span class="n">endif</span>
  <span class="k">select case</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">f</span><span class="p">)</span>
  <span class="k">case</span><span class="p">(</span><span class="n">ascii</span><span class="p">)</span>
    <span class="n">s_buffer</span> <span class="o">=</span> <span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;DataArray type=&quot;Int16&quot; Name=&quot;&#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">varname</span><span class="p">)</span><span class="o">//</span><span class="p">&amp;</span>
               <span class="s1">&#39;&quot; NumberOfComponents=&quot;3&quot; format=&quot;ascii&quot;&gt;&#39;</span>
    <span class="k">write</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="s1">&#39;(A)&#39;</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">trim</span><span class="p">(</span><span class="n">s_buffer</span><span class="p">)</span>
    <span class="k">do </span><span class="n">nz</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">size</span><span class="p">(</span><span class="n">varX</span><span class="p">,</span><span class="nb">dim</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span> <span class="p">;</span> <span class="k">do </span><span class="n">ny</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">size</span><span class="p">(</span><span class="n">varX</span><span class="p">,</span><span class="nb">dim</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span> <span class="p">;</span> <span class="k">do </span><span class="n">nx</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">size</span><span class="p">(</span><span class="n">varX</span><span class="p">,</span><span class="nb">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
      <span class="k">write</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="s1">&#39;(A)&#39;</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="p">&amp;</span>
                                        <span class="n">str</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">varX</span><span class="p">(</span><span class="n">nx</span><span class="p">,</span><span class="n">ny</span><span class="p">,</span><span class="n">nz</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39; &#39;</span><span class="o">//</span><span class="n">str</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">varY</span><span class="p">(</span><span class="n">nx</span><span class="p">,</span><span class="n">ny</span><span class="p">,</span><span class="n">nz</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39; &#39;</span><span class="o">//</span><span class="n">str</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">varZ</span><span class="p">(</span><span class="n">nx</span><span class="p">,</span><span class="n">ny</span><span class="p">,</span><span class="n">nz</span><span class="p">))</span>
    <span class="n">enddo</span> <span class="p">;</span> <span class="n">enddo</span> <span class="p">;</span> <span class="n">enddo</span>
    <span class="k">write</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="s1">&#39;(A)&#39;</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;/DataArray&gt;&#39;</span>
  <span class="k">case</span><span class="p">(</span><span class="n">raw</span><span class="p">,</span><span class="n">bin_app</span><span class="p">)</span>
    <span class="n">s_buffer</span> <span class="o">=</span> <span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;DataArray type=&quot;Int16&quot; Name=&quot;&#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">varname</span><span class="p">)</span><span class="o">//</span><span class="p">&amp;</span>
               <span class="s1">&#39;&quot; NumberOfComponents=&quot;3&quot; format=&quot;appended&quot; offset=&quot;&#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(.</span><span class="n">true</span><span class="p">.,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">ioffset</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39;&quot;/&gt;&#39;</span>
    <span class="k">write</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">trim</span><span class="p">(</span><span class="n">s_buffer</span><span class="p">)</span><span class="o">//</span><span class="n">end_rec</span>
    <span class="k">call </span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">byte_update</span><span class="p">(</span><span class="n">N_Byte</span> <span class="o">=</span> <span class="mi">3</span><span class="o">*</span><span class="n">NC_NN</span><span class="o">*</span><span class="n">BYI2P</span><span class="p">)</span>
    <span class="k">write</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">ua</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">N_Byte</span><span class="p">,</span><span class="s1">&#39;I2&#39;</span><span class="p">,</span><span class="mi">3</span><span class="o">*</span><span class="n">NC_NN</span>
    <span class="k">write</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">ua</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)(((</span><span class="n">varX</span><span class="p">(</span><span class="n">nx</span><span class="p">,</span><span class="n">ny</span><span class="p">,</span><span class="n">nz</span><span class="p">),</span><span class="n">varY</span><span class="p">(</span><span class="n">nx</span><span class="p">,</span><span class="n">ny</span><span class="p">,</span><span class="n">nz</span><span class="p">),</span><span class="n">varZ</span><span class="p">(</span><span class="n">nx</span><span class="p">,</span><span class="n">ny</span><span class="p">,</span><span class="n">nz</span><span class="p">),&amp;</span>
                                 <span class="n">nx</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">size</span><span class="p">(</span><span class="n">varX</span><span class="p">,</span><span class="nb">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)),</span><span class="n">ny</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">size</span><span class="p">(</span><span class="n">varX</span><span class="p">,</span><span class="nb">dim</span><span class="o">=</span><span class="mi">2</span><span class="p">)),</span><span class="n">nz</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">size</span><span class="p">(</span><span class="n">varX</span><span class="p">,</span><span class="nb">dim</span><span class="o">=</span><span class="mi">3</span><span class="p">))</span>
  <span class="k">case</span><span class="p">(</span><span class="n">binary</span><span class="p">)</span>
    <span class="n">s_buffer</span> <span class="o">=</span> <span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;DataArray type=&quot;Int16&quot; Name=&quot;&#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">varname</span><span class="p">)</span><span class="o">//</span><span class="p">&amp;</span>
               <span class="s1">&#39;&quot; NumberOfComponents=&quot;3&quot; format=&quot;binary&quot;&gt;&#39;</span>
    <span class="k">write</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">trim</span><span class="p">(</span><span class="n">s_buffer</span><span class="p">)</span><span class="o">//</span><span class="n">end_rec</span>
    <span class="k">allocate</span><span class="p">(</span><span class="n">var</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="o">*</span><span class="n">NC_NN</span><span class="p">))</span>
    <span class="n">n1</span> <span class="o">=</span> <span class="mi">0_I4P</span>
    <span class="k">do </span><span class="n">nz</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">size</span><span class="p">(</span><span class="n">varX</span><span class="p">,</span><span class="nb">dim</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span> <span class="p">;</span> <span class="k">do </span><span class="n">ny</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">size</span><span class="p">(</span><span class="n">varX</span><span class="p">,</span><span class="nb">dim</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span> <span class="p">;</span> <span class="k">do </span><span class="n">nx</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">size</span><span class="p">(</span><span class="n">varX</span><span class="p">,</span><span class="nb">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
      <span class="n">n1</span> <span class="o">=</span> <span class="n">n1</span> <span class="o">+</span> <span class="mi">1_I4P</span> <span class="p">;</span> <span class="n">var</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="p">(</span><span class="n">n1</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="mi">3</span><span class="p">:</span><span class="mi">1</span><span class="o">+</span><span class="p">(</span><span class="n">n1</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="mi">3</span><span class="o">+</span><span class="mi">2</span><span class="p">)</span><span class="o">=</span><span class="p">[</span><span class="n">varX</span><span class="p">(</span><span class="n">nx</span><span class="p">,</span><span class="n">ny</span><span class="p">,</span><span class="n">nz</span><span class="p">),</span><span class="n">varY</span><span class="p">(</span><span class="n">nx</span><span class="p">,</span><span class="n">ny</span><span class="p">,</span><span class="n">nz</span><span class="p">),</span><span class="n">varZ</span><span class="p">(</span><span class="n">nx</span><span class="p">,</span><span class="n">ny</span><span class="p">,</span><span class="n">nz</span><span class="p">)]</span>
    <span class="n">enddo</span> <span class="p">;</span> <span class="n">enddo</span> <span class="p">;</span> <span class="n">enddo</span>
    <span class="k">call </span><span class="n">pack_data</span><span class="p">(</span><span class="n">a1</span><span class="o">=</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="mi">3</span><span class="o">*</span><span class="n">NC_NN</span><span class="o">*</span><span class="n">BYI2P</span><span class="p">,</span><span class="n">I4P</span><span class="p">)],</span><span class="n">a2</span><span class="o">=</span><span class="n">var</span><span class="p">,</span><span class="n">packed</span><span class="o">=</span><span class="n">varp</span><span class="p">)</span> <span class="p">;</span> <span class="k">deallocate</span><span class="p">(</span><span class="n">var</span><span class="p">)</span>
    <span class="k">call </span><span class="n">b64_encode</span><span class="p">(</span><span class="n">nB</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">BYI1P</span><span class="p">,</span><span class="n">I4P</span><span class="p">),</span><span class="n">n</span><span class="o">=</span><span class="n">varp</span><span class="p">,</span><span class="n">code</span><span class="o">=</span><span class="n">var64</span><span class="p">)</span> <span class="p">;</span> <span class="k">deallocate</span><span class="p">(</span><span class="n">varp</span><span class="p">)</span>
    <span class="k">write</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="o">+</span><span class="mi">2</span><span class="p">)</span><span class="o">//</span><span class="n">tochar</span><span class="p">(</span><span class="n">var64</span><span class="p">)</span><span class="o">//</span><span class="n">end_rec</span> <span class="p">;</span> <span class="k">deallocate</span><span class="p">(</span><span class="n">var64</span><span class="p">)</span>
    <span class="k">write</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;/DataArray&gt;&#39;</span><span class="o">//</span><span class="n">end_rec</span>
  <span class="n">endselect</span>
  <span class="k">return</span>
  <span class="c">!---------------------------------------------------------------------------------------------------------------------------------</span>
  <span class="n">endfunction</span> <span class="n">VTK_VAR_XML_VECT_3DA_I2</span>

  <span class="c">!&gt; Function for saving field of vectorial variable (I1P, 1D arrays).</span>
  <span class="c">!&gt; @return E_IO: integer(I4P) error flag</span>
  <span class="k">function </span><span class="n">VTK_VAR_XML_VECT_1DA_I1</span><span class="p">(</span><span class="n">NC_NN</span><span class="p">,</span><span class="n">varname</span><span class="p">,</span><span class="n">varX</span><span class="p">,</span><span class="n">varY</span><span class="p">,</span><span class="n">varZ</span><span class="p">,</span><span class="n">cf</span><span class="p">)</span> <span class="k">result</span><span class="p">(</span><span class="n">E_IO</span><span class="p">)</span>
  <span class="c">!---------------------------------------------------------------------------------------------------------------------------------</span>
  <span class="k">implicit none</span>
<span class="k">  </span><span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span><span class="kd">::</span>           <span class="n">NC_NN</span>    <span class="c">!&lt; Number of cells or nodes.</span>
  <span class="kt">character</span><span class="p">(</span><span class="o">*</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span><span class="kd">::</span>           <span class="n">varname</span>  <span class="c">!&lt; Variable name.</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I1P</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span><span class="kd">::</span>           <span class="n">varX</span><span class="p">(</span><span class="mi">1</span><span class="p">:)</span> <span class="c">!&lt; X component [1:NC_NN].</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I1P</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span><span class="kd">::</span>           <span class="n">varY</span><span class="p">(</span><span class="mi">1</span><span class="p">:)</span> <span class="c">!&lt; Y component [1:NC_NN].</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I1P</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span><span class="kd">::</span>           <span class="n">varZ</span><span class="p">(</span><span class="mi">1</span><span class="p">:)</span> <span class="c">!&lt; Z component [1:NC_NN].</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">),</span> <span class="k">optional</span><span class="kd">::</span> <span class="n">cf</span>       <span class="c">!&lt; Current file index (for concurrent files IO).</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">)</span><span class="kd">::</span>                       <span class="n">E_IO</span>     <span class="c">!&lt; Input/Output inquiring flag: $0$ if IO is done, $&gt; 0$ if IO is not done.</span>
  <span class="kt">character</span><span class="p">(</span><span class="nb">len</span><span class="o">=</span><span class="n">maxlen</span><span class="p">)</span><span class="kd">::</span>              <span class="n">s_buffer</span> <span class="c">!&lt; Buffer string.</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I1P</span><span class="p">),</span> <span class="k">allocatable</span><span class="kd">::</span>          <span class="n">var</span><span class="p">(:)</span>   <span class="c">!&lt; X, Y, Z component.</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I1P</span><span class="p">),</span> <span class="k">allocatable</span><span class="kd">::</span>          <span class="n">varp</span><span class="p">(:)</span>  <span class="c">!&lt; Packed data.</span>
  <span class="kt">character</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="k">allocatable</span><span class="kd">::</span>          <span class="n">var64</span><span class="p">(:)</span> <span class="c">!&lt; Variable encoded in base64.</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">)</span><span class="kd">::</span>                       <span class="n">rf</span>       <span class="c">!&lt; Real file index.</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">)</span><span class="kd">::</span>                       <span class="n">n1</span>       <span class="c">!&lt; Counter.</span>
  <span class="c">!---------------------------------------------------------------------------------------------------------------------------------</span>

  <span class="c">!---------------------------------------------------------------------------------------------------------------------------------</span>
  <span class="n">E_IO</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1_I4P</span>
  <span class="n">rf</span> <span class="o">=</span> <span class="n">f</span>
  <span class="k">if</span> <span class="p">(</span><span class="nb">present</span><span class="p">(</span><span class="n">cf</span><span class="p">))</span> <span class="k">then</span>
<span class="k">    </span><span class="n">rf</span> <span class="o">=</span> <span class="n">cf</span> <span class="p">;</span> <span class="n">f</span> <span class="o">=</span> <span class="n">cf</span>
  <span class="n">endif</span>
  <span class="k">select case</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">f</span><span class="p">)</span>
  <span class="k">case</span><span class="p">(</span><span class="n">ascii</span><span class="p">)</span>
    <span class="n">s_buffer</span><span class="o">=</span><span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;DataArray type=&quot;Int8&quot; Name=&quot;&#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">varname</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&quot; NumberOfComponents=&quot;3&quot; format=&quot;ascii&quot;&gt;&#39;</span>
    <span class="k">write</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="s1">&#39;(A)&#39;</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">trim</span><span class="p">(</span><span class="n">s_buffer</span><span class="p">)</span>
    <span class="k">do </span><span class="n">n1</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">NC_NN</span>
      <span class="k">write</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="s1">&#39;(A)&#39;</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="n">str</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">varX</span><span class="p">(</span><span class="n">n1</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39; &#39;</span><span class="o">//</span><span class="n">str</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">varY</span><span class="p">(</span><span class="n">n1</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39; &#39;</span><span class="o">//</span><span class="n">str</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">varZ</span><span class="p">(</span><span class="n">n1</span><span class="p">))</span>
    <span class="n">enddo</span>
    <span class="k">write</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="s1">&#39;(A)&#39;</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;/DataArray&gt;&#39;</span>
  <span class="k">case</span><span class="p">(</span><span class="n">raw</span><span class="p">,</span><span class="n">bin_app</span><span class="p">)</span>
    <span class="n">s_buffer</span><span class="o">=</span><span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;DataArray type=&quot;Int8&quot; Name=&quot;&#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">varname</span><span class="p">)</span><span class="o">//</span><span class="p">&amp;</span>
             <span class="s1">&#39;&quot; NumberOfComponents=&quot;3&quot; format=&quot;appended&quot; offset=&quot;&#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(.</span><span class="n">true</span><span class="p">.,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">ioffset</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39;&quot;/&gt;&#39;</span>
    <span class="k">write</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">trim</span><span class="p">(</span><span class="n">s_buffer</span><span class="p">)</span><span class="o">//</span><span class="n">end_rec</span>
    <span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">N_Byte</span> <span class="o">=</span> <span class="mi">3</span><span class="o">*</span><span class="n">NC_NN</span><span class="o">*</span><span class="n">BYI1P</span>
    <span class="k">call </span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">byte_update</span><span class="p">(</span><span class="n">N_Byte</span> <span class="o">=</span> <span class="mi">3</span><span class="o">*</span><span class="n">NC_NN</span><span class="o">*</span><span class="n">BYI1P</span><span class="p">)</span>
    <span class="k">write</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">ua</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">N_Byte</span><span class="p">,</span><span class="s1">&#39;I1&#39;</span><span class="p">,</span><span class="mi">3</span><span class="o">*</span><span class="n">NC_NN</span>
    <span class="k">write</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">ua</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)(</span><span class="n">varX</span><span class="p">(</span><span class="n">n1</span><span class="p">),</span><span class="n">varY</span><span class="p">(</span><span class="n">n1</span><span class="p">),</span><span class="n">varZ</span><span class="p">(</span><span class="n">n1</span><span class="p">),</span><span class="n">n1</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">NC_NN</span><span class="p">)</span>
  <span class="k">case</span><span class="p">(</span><span class="n">binary</span><span class="p">)</span>
    <span class="n">s_buffer</span> <span class="o">=</span> <span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;DataArray type=&quot;Int8&quot; Name=&quot;&#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">varname</span><span class="p">)</span><span class="o">//</span><span class="p">&amp;</span>
               <span class="s1">&#39;&quot; NumberOfComponents=&quot;3&quot; format=&quot;binary&quot;&gt;&#39;</span>
    <span class="k">write</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">trim</span><span class="p">(</span><span class="n">s_buffer</span><span class="p">)</span><span class="o">//</span><span class="n">end_rec</span>
    <span class="k">allocate</span><span class="p">(</span><span class="n">var</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="o">*</span><span class="n">NC_NN</span><span class="p">))</span>
    <span class="k">do </span><span class="n">n1</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">NC_NN</span>
      <span class="n">var</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="p">(</span><span class="n">n1</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="mi">3</span><span class="p">:</span><span class="mi">1</span><span class="o">+</span><span class="p">(</span><span class="n">n1</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="mi">3</span><span class="o">+</span><span class="mi">2</span><span class="p">)</span><span class="o">=</span><span class="p">[</span><span class="n">varX</span><span class="p">(</span><span class="n">n1</span><span class="p">),</span><span class="n">varY</span><span class="p">(</span><span class="n">n1</span><span class="p">),</span><span class="n">varZ</span><span class="p">(</span><span class="n">n1</span><span class="p">)]</span>
    <span class="n">enddo</span>
    <span class="k">call </span><span class="n">pack_data</span><span class="p">(</span><span class="n">a1</span><span class="o">=</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="mi">3</span><span class="o">*</span><span class="n">NC_NN</span><span class="o">*</span><span class="n">BYI1P</span><span class="p">,</span><span class="n">I4P</span><span class="p">)],</span><span class="n">a2</span><span class="o">=</span><span class="n">var</span><span class="p">,</span><span class="n">packed</span><span class="o">=</span><span class="n">varp</span><span class="p">)</span> <span class="p">;</span> <span class="k">deallocate</span><span class="p">(</span><span class="n">var</span><span class="p">)</span>
    <span class="k">call </span><span class="n">b64_encode</span><span class="p">(</span><span class="n">nB</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">BYI1P</span><span class="p">,</span><span class="n">I4P</span><span class="p">),</span><span class="n">n</span><span class="o">=</span><span class="n">varp</span><span class="p">,</span><span class="n">code</span><span class="o">=</span><span class="n">var64</span><span class="p">)</span> <span class="p">;</span> <span class="k">deallocate</span><span class="p">(</span><span class="n">varp</span><span class="p">)</span>
    <span class="k">write</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="o">+</span><span class="mi">2</span><span class="p">)</span><span class="o">//</span><span class="n">tochar</span><span class="p">(</span><span class="n">var64</span><span class="p">)</span><span class="o">//</span><span class="n">end_rec</span> <span class="p">;</span> <span class="k">deallocate</span><span class="p">(</span><span class="n">var64</span><span class="p">)</span>
    <span class="k">write</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;/DataArray&gt;&#39;</span><span class="o">//</span><span class="n">end_rec</span>
  <span class="n">endselect</span>
  <span class="k">return</span>
  <span class="c">!---------------------------------------------------------------------------------------------------------------------------------</span>
  <span class="n">endfunction</span> <span class="n">VTK_VAR_XML_VECT_1DA_I1</span>

  <span class="c">!&gt; Function for saving field of vectorial variable (I1P, 3D arrays).</span>
  <span class="c">!&gt; @return E_IO: integer(I4P) error flag</span>
  <span class="k">function </span><span class="n">VTK_VAR_XML_VECT_3DA_I1</span><span class="p">(</span><span class="n">NC_NN</span><span class="p">,</span><span class="n">varname</span><span class="p">,</span><span class="n">varX</span><span class="p">,</span><span class="n">varY</span><span class="p">,</span><span class="n">varZ</span><span class="p">,</span><span class="n">cf</span><span class="p">)</span> <span class="k">result</span><span class="p">(</span><span class="n">E_IO</span><span class="p">)</span>
  <span class="c">!---------------------------------------------------------------------------------------------------------------------------------</span>
  <span class="k">implicit none</span>
<span class="k">  </span><span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span><span class="kd">::</span>           <span class="n">NC_NN</span>          <span class="c">!&lt; Number of cells or nodes.</span>
  <span class="kt">character</span><span class="p">(</span><span class="o">*</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span><span class="kd">::</span>           <span class="n">varname</span>        <span class="c">!&lt; Variable name.</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I1P</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span><span class="kd">::</span>           <span class="n">varX</span><span class="p">(</span><span class="mi">1</span><span class="p">:,</span><span class="mi">1</span><span class="p">:,</span><span class="mi">1</span><span class="p">:)</span> <span class="c">!&lt; X component [1:Nx,1:Ny,1:Nz].</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I1P</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span><span class="kd">::</span>           <span class="n">varY</span><span class="p">(</span><span class="mi">1</span><span class="p">:,</span><span class="mi">1</span><span class="p">:,</span><span class="mi">1</span><span class="p">:)</span> <span class="c">!&lt; Y component [1:Nx,1:Ny,1:Nz].</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I1P</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span><span class="kd">::</span>           <span class="n">varZ</span><span class="p">(</span><span class="mi">1</span><span class="p">:,</span><span class="mi">1</span><span class="p">:,</span><span class="mi">1</span><span class="p">:)</span> <span class="c">!&lt; Z component [1:Nx,1:Ny,1:Nz].</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">),</span> <span class="k">optional</span><span class="kd">::</span> <span class="n">cf</span>             <span class="c">!&lt; Current file index (for concurrent files IO).</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">)</span><span class="kd">::</span>                       <span class="n">E_IO</span>           <span class="c">!&lt; Input/Output inquiring flag: $0$ if IO is done, $&gt; 0$ if IO is not done.</span>
  <span class="kt">character</span><span class="p">(</span><span class="nb">len</span><span class="o">=</span><span class="n">maxlen</span><span class="p">)</span><span class="kd">::</span>              <span class="n">s_buffer</span>       <span class="c">!&lt; Buffer string.</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I1P</span><span class="p">),</span> <span class="k">allocatable</span><span class="kd">::</span>          <span class="n">var</span><span class="p">(:)</span>         <span class="c">!&lt; X, Y, Z component.</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I1P</span><span class="p">),</span> <span class="k">allocatable</span><span class="kd">::</span>          <span class="n">varp</span><span class="p">(:)</span>        <span class="c">!&lt; Packed data.</span>
  <span class="kt">character</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="k">allocatable</span><span class="kd">::</span>          <span class="n">var64</span><span class="p">(:)</span>       <span class="c">!&lt; Variable encoded in base64.</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">)</span><span class="kd">::</span>                       <span class="n">rf</span>             <span class="c">!&lt; Real file index.</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">)</span><span class="kd">::</span>                       <span class="n">nx</span><span class="p">,</span><span class="n">ny</span><span class="p">,</span><span class="n">nz</span><span class="p">,</span><span class="n">n1</span>    <span class="c">!&lt; Counters.</span>
  <span class="c">!---------------------------------------------------------------------------------------------------------------------------------</span>

  <span class="c">!---------------------------------------------------------------------------------------------------------------------------------</span>
  <span class="n">E_IO</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1_I4P</span>
  <span class="n">rf</span> <span class="o">=</span> <span class="n">f</span>
  <span class="k">if</span> <span class="p">(</span><span class="nb">present</span><span class="p">(</span><span class="n">cf</span><span class="p">))</span> <span class="k">then</span>
<span class="k">    </span><span class="n">rf</span> <span class="o">=</span> <span class="n">cf</span> <span class="p">;</span> <span class="n">f</span> <span class="o">=</span> <span class="n">cf</span>
  <span class="n">endif</span>
  <span class="k">select case</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">f</span><span class="p">)</span>
  <span class="k">case</span><span class="p">(</span><span class="n">ascii</span><span class="p">)</span>
    <span class="n">s_buffer</span><span class="o">=</span><span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;DataArray type=&quot;Int8&quot; Name=&quot;&#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">varname</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&quot; NumberOfComponents=&quot;3&quot; format=&quot;ascii&quot;&gt;&#39;</span>
    <span class="k">write</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="s1">&#39;(A)&#39;</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">trim</span><span class="p">(</span><span class="n">s_buffer</span><span class="p">)</span>
    <span class="k">do </span><span class="n">nz</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">size</span><span class="p">(</span><span class="n">varX</span><span class="p">,</span><span class="nb">dim</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span> <span class="p">;</span> <span class="k">do </span><span class="n">ny</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">size</span><span class="p">(</span><span class="n">varX</span><span class="p">,</span><span class="nb">dim</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span> <span class="p">;</span> <span class="k">do </span><span class="n">nx</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">size</span><span class="p">(</span><span class="n">varX</span><span class="p">,</span><span class="nb">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
      <span class="k">write</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="s1">&#39;(A)&#39;</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="p">&amp;</span>
                                        <span class="n">str</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">varX</span><span class="p">(</span><span class="n">nx</span><span class="p">,</span><span class="n">ny</span><span class="p">,</span><span class="n">nz</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39; &#39;</span><span class="o">//</span><span class="n">str</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">varY</span><span class="p">(</span><span class="n">nx</span><span class="p">,</span><span class="n">ny</span><span class="p">,</span><span class="n">nz</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39; &#39;</span><span class="o">//</span><span class="n">str</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">varZ</span><span class="p">(</span><span class="n">nx</span><span class="p">,</span><span class="n">ny</span><span class="p">,</span><span class="n">nz</span><span class="p">))</span>
    <span class="n">enddo</span> <span class="p">;</span> <span class="n">enddo</span> <span class="p">;</span> <span class="n">enddo</span>
    <span class="k">write</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="s1">&#39;(A)&#39;</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;/DataArray&gt;&#39;</span>
  <span class="k">case</span><span class="p">(</span><span class="n">raw</span><span class="p">,</span><span class="n">bin_app</span><span class="p">)</span>
    <span class="n">s_buffer</span><span class="o">=</span><span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;DataArray type=&quot;Int8&quot; Name=&quot;&#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">varname</span><span class="p">)</span><span class="o">//</span><span class="p">&amp;</span>
             <span class="s1">&#39;&quot; NumberOfComponents=&quot;3&quot; format=&quot;appended&quot; offset=&quot;&#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(.</span><span class="n">true</span><span class="p">.,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">ioffset</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39;&quot;/&gt;&#39;</span>
    <span class="k">write</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">trim</span><span class="p">(</span><span class="n">s_buffer</span><span class="p">)</span><span class="o">//</span><span class="n">end_rec</span>
    <span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">N_Byte</span> <span class="o">=</span> <span class="mi">3</span><span class="o">*</span><span class="n">NC_NN</span><span class="o">*</span><span class="n">BYI1P</span>
    <span class="k">call </span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">byte_update</span><span class="p">(</span><span class="n">N_Byte</span> <span class="o">=</span> <span class="mi">3</span><span class="o">*</span><span class="n">NC_NN</span><span class="o">*</span><span class="n">BYI1P</span><span class="p">)</span>
    <span class="k">write</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">ua</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">N_Byte</span><span class="p">,</span><span class="s1">&#39;I1&#39;</span><span class="p">,</span><span class="mi">3</span><span class="o">*</span><span class="n">NC_NN</span>
    <span class="k">write</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">ua</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)(((</span><span class="n">varX</span><span class="p">(</span><span class="n">nx</span><span class="p">,</span><span class="n">ny</span><span class="p">,</span><span class="n">nz</span><span class="p">),</span><span class="n">varY</span><span class="p">(</span><span class="n">nx</span><span class="p">,</span><span class="n">ny</span><span class="p">,</span><span class="n">nz</span><span class="p">),</span><span class="n">varZ</span><span class="p">(</span><span class="n">nx</span><span class="p">,</span><span class="n">ny</span><span class="p">,</span><span class="n">nz</span><span class="p">),&amp;</span>
                                 <span class="n">nx</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">size</span><span class="p">(</span><span class="n">varX</span><span class="p">,</span><span class="nb">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)),</span><span class="n">ny</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">size</span><span class="p">(</span><span class="n">varX</span><span class="p">,</span><span class="nb">dim</span><span class="o">=</span><span class="mi">2</span><span class="p">)),</span><span class="n">nz</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">size</span><span class="p">(</span><span class="n">varX</span><span class="p">,</span><span class="nb">dim</span><span class="o">=</span><span class="mi">3</span><span class="p">))</span>
  <span class="k">case</span><span class="p">(</span><span class="n">binary</span><span class="p">)</span>
    <span class="n">s_buffer</span> <span class="o">=</span> <span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;DataArray type=&quot;Int8&quot; Name=&quot;&#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">varname</span><span class="p">)</span><span class="o">//</span><span class="p">&amp;</span>
               <span class="s1">&#39;&quot; NumberOfComponents=&quot;3&quot; format=&quot;binary&quot;&gt;&#39;</span>
    <span class="k">write</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">trim</span><span class="p">(</span><span class="n">s_buffer</span><span class="p">)</span><span class="o">//</span><span class="n">end_rec</span>
    <span class="k">allocate</span><span class="p">(</span><span class="n">var</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="o">*</span><span class="n">NC_NN</span><span class="p">))</span>
    <span class="n">n1</span> <span class="o">=</span> <span class="mi">0_I4P</span>
    <span class="k">do </span><span class="n">nz</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">size</span><span class="p">(</span><span class="n">varX</span><span class="p">,</span><span class="nb">dim</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span> <span class="p">;</span> <span class="k">do </span><span class="n">ny</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">size</span><span class="p">(</span><span class="n">varX</span><span class="p">,</span><span class="nb">dim</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span> <span class="p">;</span> <span class="k">do </span><span class="n">nx</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">size</span><span class="p">(</span><span class="n">varX</span><span class="p">,</span><span class="nb">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
      <span class="n">n1</span> <span class="o">=</span> <span class="n">n1</span> <span class="o">+</span> <span class="mi">1_I4P</span> <span class="p">;</span> <span class="n">var</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="p">(</span><span class="n">n1</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="mi">3</span><span class="p">:</span><span class="mi">1</span><span class="o">+</span><span class="p">(</span><span class="n">n1</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="mi">3</span><span class="o">+</span><span class="mi">2</span><span class="p">)</span><span class="o">=</span><span class="p">[</span><span class="n">varX</span><span class="p">(</span><span class="n">nx</span><span class="p">,</span><span class="n">ny</span><span class="p">,</span><span class="n">nz</span><span class="p">),</span><span class="n">varY</span><span class="p">(</span><span class="n">nx</span><span class="p">,</span><span class="n">ny</span><span class="p">,</span><span class="n">nz</span><span class="p">),</span><span class="n">varZ</span><span class="p">(</span><span class="n">nx</span><span class="p">,</span><span class="n">ny</span><span class="p">,</span><span class="n">nz</span><span class="p">)]</span>
    <span class="n">enddo</span> <span class="p">;</span> <span class="n">enddo</span> <span class="p">;</span> <span class="n">enddo</span>
    <span class="k">call </span><span class="n">pack_data</span><span class="p">(</span><span class="n">a1</span><span class="o">=</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="mi">3</span><span class="o">*</span><span class="n">NC_NN</span><span class="o">*</span><span class="n">BYI1P</span><span class="p">,</span><span class="n">I4P</span><span class="p">)],</span><span class="n">a2</span><span class="o">=</span><span class="n">var</span><span class="p">,</span><span class="n">packed</span><span class="o">=</span><span class="n">varp</span><span class="p">)</span> <span class="p">;</span> <span class="k">deallocate</span><span class="p">(</span><span class="n">var</span><span class="p">)</span>
    <span class="k">call </span><span class="n">b64_encode</span><span class="p">(</span><span class="n">nB</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">BYI1P</span><span class="p">,</span><span class="n">I4P</span><span class="p">),</span><span class="n">n</span><span class="o">=</span><span class="n">varp</span><span class="p">,</span><span class="n">code</span><span class="o">=</span><span class="n">var64</span><span class="p">)</span> <span class="p">;</span> <span class="k">deallocate</span><span class="p">(</span><span class="n">varp</span><span class="p">)</span>
    <span class="k">write</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="o">+</span><span class="mi">2</span><span class="p">)</span><span class="o">//</span><span class="n">tochar</span><span class="p">(</span><span class="n">var64</span><span class="p">)</span><span class="o">//</span><span class="n">end_rec</span> <span class="p">;</span> <span class="k">deallocate</span><span class="p">(</span><span class="n">var64</span><span class="p">)</span>
    <span class="k">write</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;/DataArray&gt;&#39;</span><span class="o">//</span><span class="n">end_rec</span>
  <span class="n">endselect</span>
  <span class="k">return</span>
  <span class="c">!---------------------------------------------------------------------------------------------------------------------------------</span>
  <span class="n">endfunction</span> <span class="n">VTK_VAR_XML_VECT_3DA_I1</span>

  <span class="c">!&gt; Function for saving field of list variable (R8P, 1D array).</span>
  <span class="c">!&gt; @return E_IO: integer(I4P) error flag</span>
  <span class="k">function </span><span class="n">VTK_VAR_XML_LIST_1DA_R8</span><span class="p">(</span><span class="n">NC_NN</span><span class="p">,</span><span class="n">N_COL</span><span class="p">,</span><span class="n">varname</span><span class="p">,</span><span class="n">var</span><span class="p">,</span><span class="n">cf</span><span class="p">)</span> <span class="k">result</span><span class="p">(</span><span class="n">E_IO</span><span class="p">)</span>
  <span class="c">!---------------------------------------------------------------------------------------------------------------------------------</span>
  <span class="k">implicit none</span>
<span class="k">  </span><span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span><span class="kd">::</span>           <span class="n">NC_NN</span>      <span class="c">!&lt; Number of cells or nodes.</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span><span class="kd">::</span>           <span class="n">N_COL</span>      <span class="c">!&lt; Number of columns.</span>
  <span class="kt">character</span><span class="p">(</span><span class="o">*</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span><span class="kd">::</span>           <span class="n">varname</span>    <span class="c">!&lt; Variable name.</span>
  <span class="kt">real</span><span class="p">(</span><span class="n">R8P</span><span class="p">),</span>    <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span><span class="kd">::</span>           <span class="n">var</span><span class="p">(</span><span class="mi">1</span><span class="p">:,</span><span class="mi">1</span><span class="p">:)</span> <span class="c">!&lt; Components [1:N_COL,1:NC_NN].</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">),</span> <span class="k">optional</span><span class="kd">::</span> <span class="n">cf</span>         <span class="c">!&lt; Current file index (for concurrent files IO).</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">)</span><span class="kd">::</span>                       <span class="n">E_IO</span>       <span class="c">!&lt; Input/Output inquiring flag: $0$ if IO is done, $&gt; 0$ if IO is not done.</span>
  <span class="kt">character</span><span class="p">(</span><span class="nb">len</span><span class="o">=</span><span class="n">maxlen</span><span class="p">)</span><span class="kd">::</span>              <span class="n">s_buffer</span>   <span class="c">!&lt; Buffer string.</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I1P</span><span class="p">),</span> <span class="k">allocatable</span><span class="kd">::</span>          <span class="n">varp</span><span class="p">(:)</span>    <span class="c">!&lt; Packed data.</span>
  <span class="kt">character</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="k">allocatable</span><span class="kd">::</span>          <span class="n">var64</span><span class="p">(:)</span>   <span class="c">!&lt; Variable encoded in base64.</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">)</span><span class="kd">::</span>                       <span class="n">rf</span>         <span class="c">!&lt; Real file index.</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">)</span><span class="kd">::</span>                       <span class="n">n1</span><span class="p">,</span><span class="n">n2</span>      <span class="c">!&lt; Counters.</span>
  <span class="c">!---------------------------------------------------------------------------------------------------------------------------------</span>

  <span class="c">!---------------------------------------------------------------------------------------------------------------------------------</span>
  <span class="n">E_IO</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1_I4P</span>
  <span class="n">rf</span> <span class="o">=</span> <span class="n">f</span>
  <span class="k">if</span> <span class="p">(</span><span class="nb">present</span><span class="p">(</span><span class="n">cf</span><span class="p">))</span> <span class="k">then</span>
<span class="k">    </span><span class="n">rf</span> <span class="o">=</span> <span class="n">cf</span> <span class="p">;</span> <span class="n">f</span> <span class="o">=</span> <span class="n">cf</span>
  <span class="n">endif</span>
  <span class="k">select case</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">f</span><span class="p">)</span>
  <span class="k">case</span><span class="p">(</span><span class="n">ascii</span><span class="p">)</span>
    <span class="n">s_buffer</span> <span class="o">=</span> <span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;DataArray type=&quot;Float64&quot; Name=&quot;&#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">varname</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&quot; NumberOfComponents=&quot;&#39;</span><span class="o">//</span> <span class="p">&amp;</span>
               <span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(.</span><span class="n">true</span><span class="p">.,</span><span class="n">N_COL</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39;&quot; format=&quot;ascii&quot;&gt;&#39;</span>
    <span class="k">write</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="s1">&#39;(A)&#39;</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">trim</span><span class="p">(</span><span class="n">s_buffer</span><span class="p">)</span>
    <span class="k">do </span><span class="n">n2</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">NC_NN</span>
      <span class="k">write</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="s1">&#39;(&#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(.</span><span class="n">true</span><span class="p">.,</span><span class="n">N_COL</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39;A)&#39;</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">),&amp;</span>
                                                                       <span class="p">(</span><span class="s1">&#39; &#39;</span><span class="o">//</span><span class="n">str</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">var</span><span class="p">(</span><span class="n">n1</span><span class="p">,</span><span class="n">n2</span><span class="p">)),</span><span class="n">n1</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">N_COL</span><span class="p">)</span>
    <span class="n">enddo</span>
    <span class="k">write</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="s1">&#39;(A)&#39;</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;/DataArray&gt;&#39;</span>
  <span class="k">case</span><span class="p">(</span><span class="n">raw</span><span class="p">,</span><span class="n">bin_app</span><span class="p">)</span>
    <span class="n">s_buffer</span> <span class="o">=</span> <span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;DataArray type=&quot;Float64&quot; Name=&quot;&#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">varname</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&quot; NumberOfComponents=&quot;&#39;</span><span class="o">//</span> <span class="p">&amp;</span>
               <span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(.</span><span class="n">true</span><span class="p">.,</span><span class="n">N_COL</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39;&quot; format=&quot;appended&quot; offset=&quot;&#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(.</span><span class="n">true</span><span class="p">.,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">ioffset</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39;&quot;/&gt;&#39;</span>
    <span class="k">write</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">trim</span><span class="p">(</span><span class="n">s_buffer</span><span class="p">)</span><span class="o">//</span><span class="n">end_rec</span>
    <span class="k">call </span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">byte_update</span><span class="p">(</span><span class="n">N_Byte</span> <span class="o">=</span> <span class="n">N_COL</span><span class="o">*</span><span class="n">NC_NN</span><span class="o">*</span><span class="n">BYR8P</span><span class="p">)</span>
    <span class="k">write</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">ua</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">N_Byte</span><span class="p">,</span><span class="s1">&#39;R8&#39;</span><span class="p">,</span><span class="n">N_COL</span><span class="o">*</span><span class="n">NC_NN</span>
    <span class="k">write</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">ua</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="n">var</span>
  <span class="k">case</span><span class="p">(</span><span class="n">binary</span><span class="p">)</span>
    <span class="n">s_buffer</span> <span class="o">=</span> <span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;DataArray type=&quot;Float64&quot; Name=&quot;&#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">varname</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&quot; NumberOfComponents=&quot;&#39;</span><span class="o">//</span> <span class="p">&amp;</span>
               <span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(.</span><span class="n">true</span><span class="p">.,</span><span class="n">N_COL</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39;&quot; format=&quot;binary&quot;&gt;&#39;</span>
    <span class="k">write</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">trim</span><span class="p">(</span><span class="n">s_buffer</span><span class="p">)</span><span class="o">//</span><span class="n">end_rec</span>
    <span class="k">call </span><span class="n">pack_data</span><span class="p">(</span><span class="n">a1</span><span class="o">=</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">N_COL</span><span class="o">*</span><span class="n">NC_NN</span><span class="o">*</span><span class="n">BYR8P</span><span class="p">,</span><span class="n">I4P</span><span class="p">)],</span><span class="n">a2</span><span class="o">=</span><span class="nb">reshape</span><span class="p">(</span><span class="n">var</span><span class="p">,[</span><span class="n">N_COL</span><span class="o">*</span><span class="n">NC_NN</span><span class="p">]),</span><span class="n">packed</span><span class="o">=</span><span class="n">varp</span><span class="p">)</span>
    <span class="k">call </span><span class="n">b64_encode</span><span class="p">(</span><span class="n">nB</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">BYI1P</span><span class="p">,</span><span class="n">I4P</span><span class="p">),</span><span class="n">n</span><span class="o">=</span><span class="n">varp</span><span class="p">,</span><span class="n">code</span><span class="o">=</span><span class="n">var64</span><span class="p">)</span> <span class="p">;</span> <span class="k">deallocate</span><span class="p">(</span><span class="n">varp</span><span class="p">)</span>
    <span class="k">write</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="o">+</span><span class="mi">2</span><span class="p">)</span><span class="o">//</span><span class="n">tochar</span><span class="p">(</span><span class="n">var64</span><span class="p">)</span><span class="o">//</span><span class="n">end_rec</span> <span class="p">;</span> <span class="k">deallocate</span><span class="p">(</span><span class="n">var64</span><span class="p">)</span>
    <span class="k">write</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;/DataArray&gt;&#39;</span><span class="o">//</span><span class="n">end_rec</span>
  <span class="n">endselect</span>
  <span class="k">return</span>
  <span class="c">!---------------------------------------------------------------------------------------------------------------------------------</span>
  <span class="n">endfunction</span> <span class="n">VTK_VAR_XML_LIST_1DA_R8</span>

  <span class="c">!&gt; Function for saving field of list variable (R8P, 3D array).</span>
  <span class="c">!&gt; @return E_IO: integer(I4P) error flag</span>
  <span class="k">function </span><span class="n">VTK_VAR_XML_LIST_3DA_R8</span><span class="p">(</span><span class="n">NC_NN</span><span class="p">,</span><span class="n">N_COL</span><span class="p">,</span><span class="n">varname</span><span class="p">,</span><span class="n">var</span><span class="p">,</span><span class="n">cf</span><span class="p">)</span> <span class="k">result</span><span class="p">(</span><span class="n">E_IO</span><span class="p">)</span>
  <span class="c">!---------------------------------------------------------------------------------------------------------------------------------</span>
  <span class="k">implicit none</span>
<span class="k">  </span><span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span><span class="kd">::</span>           <span class="n">NC_NN</span>            <span class="c">!&lt; Number of cells or nodes.</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span><span class="kd">::</span>           <span class="n">N_COL</span>            <span class="c">!&lt; Number of columns.</span>
  <span class="kt">character</span><span class="p">(</span><span class="o">*</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span><span class="kd">::</span>           <span class="n">varname</span>          <span class="c">!&lt; Variable name.</span>
  <span class="kt">real</span><span class="p">(</span><span class="n">R8P</span><span class="p">),</span>    <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span><span class="kd">::</span>           <span class="n">var</span><span class="p">(</span><span class="mi">1</span><span class="p">:,</span><span class="mi">1</span><span class="p">:,</span><span class="mi">1</span><span class="p">:,</span><span class="mi">1</span><span class="p">:)</span> <span class="c">!&lt; Components [1:N_COL,1:Nx,1:Ny,1:Nz].</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">),</span> <span class="k">optional</span><span class="kd">::</span> <span class="n">cf</span>               <span class="c">!&lt; Current file index (for concurrent files IO).</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">)</span><span class="kd">::</span>                       <span class="n">E_IO</span>             <span class="c">!&lt; Input/Output inquiring flag: $0$ if IO is done, $&gt; 0$ if IO is not done.</span>
  <span class="kt">character</span><span class="p">(</span><span class="nb">len</span><span class="o">=</span><span class="n">maxlen</span><span class="p">)</span><span class="kd">::</span>              <span class="n">s_buffer</span>         <span class="c">!&lt; Buffer string.</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I1P</span><span class="p">),</span> <span class="k">allocatable</span><span class="kd">::</span>          <span class="n">varp</span><span class="p">(:)</span>          <span class="c">!&lt; Packed data.</span>
  <span class="kt">character</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="k">allocatable</span><span class="kd">::</span>          <span class="n">var64</span><span class="p">(:)</span>         <span class="c">!&lt; Variable encoded in base64.</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">)</span><span class="kd">::</span>                       <span class="n">rf</span>               <span class="c">!&lt; Real file index.</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">)</span><span class="kd">::</span>                       <span class="n">nx</span><span class="p">,</span><span class="n">ny</span><span class="p">,</span><span class="n">nz</span><span class="p">,</span><span class="n">n1</span>      <span class="c">!&lt; Counters.</span>
  <span class="c">!---------------------------------------------------------------------------------------------------------------------------------</span>

  <span class="c">!---------------------------------------------------------------------------------------------------------------------------------</span>
  <span class="n">E_IO</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1_I4P</span>
  <span class="n">rf</span> <span class="o">=</span> <span class="n">f</span>
  <span class="k">if</span> <span class="p">(</span><span class="nb">present</span><span class="p">(</span><span class="n">cf</span><span class="p">))</span> <span class="k">then</span>
<span class="k">    </span><span class="n">rf</span> <span class="o">=</span> <span class="n">cf</span> <span class="p">;</span> <span class="n">f</span> <span class="o">=</span> <span class="n">cf</span>
  <span class="n">endif</span>
  <span class="k">select case</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">f</span><span class="p">)</span>
  <span class="k">case</span><span class="p">(</span><span class="n">ascii</span><span class="p">)</span>
    <span class="n">s_buffer</span> <span class="o">=</span> <span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;DataArray type=&quot;Float64&quot; Name=&quot;&#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">varname</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&quot; NumberOfComponents=&quot;&#39;</span><span class="o">//</span> <span class="p">&amp;</span>
               <span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(.</span><span class="n">true</span><span class="p">.,</span><span class="n">N_COL</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39;&quot; format=&quot;ascii&quot;&gt;&#39;</span>
    <span class="k">write</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="s1">&#39;(A)&#39;</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">trim</span><span class="p">(</span><span class="n">s_buffer</span><span class="p">)</span>
    <span class="k">do </span><span class="n">nz</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">size</span><span class="p">(</span><span class="n">var</span><span class="p">,</span><span class="nb">dim</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span> <span class="p">;</span> <span class="k">do </span><span class="n">ny</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">size</span><span class="p">(</span><span class="n">var</span><span class="p">,</span><span class="nb">dim</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span> <span class="p">;</span> <span class="k">do </span><span class="n">nx</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">size</span><span class="p">(</span><span class="n">var</span><span class="p">,</span><span class="nb">dim</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
      <span class="k">write</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="s1">&#39;(&#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(.</span><span class="n">true</span><span class="p">.,</span><span class="n">N_COL</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39;A)&#39;</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">),&amp;</span>
                                                                       <span class="p">(</span><span class="s1">&#39; &#39;</span><span class="o">//</span><span class="n">str</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">var</span><span class="p">(</span><span class="n">n1</span><span class="p">,</span><span class="n">nx</span><span class="p">,</span><span class="n">ny</span><span class="p">,</span><span class="n">nz</span><span class="p">)),</span><span class="n">n1</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">N_COL</span><span class="p">)</span>
    <span class="n">enddo</span> <span class="p">;</span> <span class="n">enddo</span> <span class="p">;</span> <span class="n">enddo</span>
    <span class="k">write</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="s1">&#39;(A)&#39;</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;/DataArray&gt;&#39;</span>
  <span class="k">case</span><span class="p">(</span><span class="n">raw</span><span class="p">,</span><span class="n">bin_app</span><span class="p">)</span>
    <span class="n">s_buffer</span> <span class="o">=</span> <span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;DataArray type=&quot;Float64&quot; Name=&quot;&#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">varname</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&quot; NumberOfComponents=&quot;&#39;</span><span class="o">//</span> <span class="p">&amp;</span>
               <span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(.</span><span class="n">true</span><span class="p">.,</span><span class="n">N_COL</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39;&quot; format=&quot;appended&quot; offset=&quot;&#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(.</span><span class="n">true</span><span class="p">.,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">ioffset</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39;&quot;/&gt;&#39;</span>
    <span class="k">write</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">trim</span><span class="p">(</span><span class="n">s_buffer</span><span class="p">)</span><span class="o">//</span><span class="n">end_rec</span>
    <span class="k">call </span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">byte_update</span><span class="p">(</span><span class="n">N_Byte</span> <span class="o">=</span> <span class="n">N_COL</span><span class="o">*</span><span class="n">NC_NN</span><span class="o">*</span><span class="n">BYR8P</span><span class="p">)</span>
    <span class="k">write</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">ua</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">N_Byte</span><span class="p">,</span><span class="s1">&#39;R8&#39;</span><span class="p">,</span><span class="n">N_COL</span><span class="o">*</span><span class="n">NC_NN</span>
    <span class="k">write</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">ua</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="n">var</span>
  <span class="k">case</span><span class="p">(</span><span class="n">binary</span><span class="p">)</span>
    <span class="n">s_buffer</span> <span class="o">=</span> <span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;DataArray type=&quot;Float64&quot; Name=&quot;&#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">varname</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&quot; NumberOfComponents=&quot;&#39;</span><span class="o">//</span> <span class="p">&amp;</span>
               <span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(.</span><span class="n">true</span><span class="p">.,</span><span class="n">N_COL</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39;&quot; format=&quot;binary&quot;&gt;&#39;</span>
    <span class="k">write</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">trim</span><span class="p">(</span><span class="n">s_buffer</span><span class="p">)</span><span class="o">//</span><span class="n">end_rec</span>
    <span class="k">call </span><span class="n">pack_data</span><span class="p">(</span><span class="n">a1</span><span class="o">=</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">N_COL</span><span class="o">*</span><span class="n">NC_NN</span><span class="o">*</span><span class="n">BYR8P</span><span class="p">,</span><span class="n">I4P</span><span class="p">)],</span><span class="n">a2</span><span class="o">=</span><span class="nb">reshape</span><span class="p">(</span><span class="n">var</span><span class="p">,[</span><span class="n">N_COL</span><span class="o">*</span><span class="n">NC_NN</span><span class="p">]),</span><span class="n">packed</span><span class="o">=</span><span class="n">varp</span><span class="p">)</span>
    <span class="k">call </span><span class="n">b64_encode</span><span class="p">(</span><span class="n">nB</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">BYI1P</span><span class="p">,</span><span class="n">I4P</span><span class="p">),</span><span class="n">n</span><span class="o">=</span><span class="n">varp</span><span class="p">,</span><span class="n">code</span><span class="o">=</span><span class="n">var64</span><span class="p">)</span> <span class="p">;</span> <span class="k">deallocate</span><span class="p">(</span><span class="n">varp</span><span class="p">)</span>
    <span class="k">write</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="o">+</span><span class="mi">2</span><span class="p">)</span><span class="o">//</span><span class="n">tochar</span><span class="p">(</span><span class="n">var64</span><span class="p">)</span><span class="o">//</span><span class="n">end_rec</span> <span class="p">;</span> <span class="k">deallocate</span><span class="p">(</span><span class="n">var64</span><span class="p">)</span>
    <span class="k">write</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;/DataArray&gt;&#39;</span><span class="o">//</span><span class="n">end_rec</span>
  <span class="n">endselect</span>
  <span class="k">return</span>
  <span class="c">!---------------------------------------------------------------------------------------------------------------------------------</span>
  <span class="n">endfunction</span> <span class="n">VTK_VAR_XML_LIST_3DA_R8</span>

  <span class="c">!&gt; Function for saving field of list variable (R4P, 1D array).</span>
  <span class="c">!&gt; @return E_IO: integer(I4P) error flag</span>
  <span class="k">function </span><span class="n">VTK_VAR_XML_LIST_1DA_R4</span><span class="p">(</span><span class="n">NC_NN</span><span class="p">,</span><span class="n">N_COL</span><span class="p">,</span><span class="n">varname</span><span class="p">,</span><span class="n">var</span><span class="p">,</span><span class="n">cf</span><span class="p">)</span> <span class="k">result</span><span class="p">(</span><span class="n">E_IO</span><span class="p">)</span>
  <span class="c">!---------------------------------------------------------------------------------------------------------------------------------</span>
  <span class="k">implicit none</span>
<span class="k">  </span><span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span><span class="kd">::</span>           <span class="n">NC_NN</span>      <span class="c">!&lt; Number of cells or nodes.</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span><span class="kd">::</span>           <span class="n">N_COL</span>      <span class="c">!&lt; Number of columns.</span>
  <span class="kt">character</span><span class="p">(</span><span class="o">*</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span><span class="kd">::</span>           <span class="n">varname</span>    <span class="c">!&lt; Variable name.</span>
  <span class="kt">real</span><span class="p">(</span><span class="n">R4P</span><span class="p">),</span>    <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span><span class="kd">::</span>           <span class="n">var</span><span class="p">(</span><span class="mi">1</span><span class="p">:,</span><span class="mi">1</span><span class="p">:)</span> <span class="c">!&lt; Components [1:N_COL,1:NC_NN].</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">),</span> <span class="k">optional</span><span class="kd">::</span> <span class="n">cf</span>         <span class="c">!&lt; Current file index (for concurrent files IO).</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">)</span><span class="kd">::</span>                       <span class="n">E_IO</span>       <span class="c">!&lt; Input/Output inquiring flag: $0$ if IO is done, $&gt; 0$ if IO is not done.</span>
  <span class="kt">character</span><span class="p">(</span><span class="nb">len</span><span class="o">=</span><span class="n">maxlen</span><span class="p">)</span><span class="kd">::</span>              <span class="n">s_buffer</span>   <span class="c">!&lt; Buffer string.</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I1P</span><span class="p">),</span> <span class="k">allocatable</span><span class="kd">::</span>          <span class="n">varp</span><span class="p">(:)</span>    <span class="c">!&lt; Packed data.</span>
  <span class="kt">character</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="k">allocatable</span><span class="kd">::</span>          <span class="n">var64</span><span class="p">(:)</span>   <span class="c">!&lt; Variable encoded in base64.</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">)</span><span class="kd">::</span>                       <span class="n">rf</span>         <span class="c">!&lt; Real file index.</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">)</span><span class="kd">::</span>                       <span class="n">n1</span><span class="p">,</span><span class="n">n2</span>      <span class="c">!&lt; Counters.</span>
  <span class="c">!---------------------------------------------------------------------------------------------------------------------------------</span>

  <span class="c">!---------------------------------------------------------------------------------------------------------------------------------</span>
  <span class="n">E_IO</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1_I4P</span>
  <span class="n">rf</span> <span class="o">=</span> <span class="n">f</span>
  <span class="k">if</span> <span class="p">(</span><span class="nb">present</span><span class="p">(</span><span class="n">cf</span><span class="p">))</span> <span class="k">then</span>
<span class="k">    </span><span class="n">rf</span> <span class="o">=</span> <span class="n">cf</span> <span class="p">;</span> <span class="n">f</span> <span class="o">=</span> <span class="n">cf</span>
  <span class="n">endif</span>
  <span class="k">select case</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">f</span><span class="p">)</span>
  <span class="k">case</span><span class="p">(</span><span class="n">ascii</span><span class="p">)</span>
    <span class="n">s_buffer</span> <span class="o">=</span> <span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;DataArray type=&quot;Float32&quot; Name=&quot;&#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">varname</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&quot; NumberOfComponents=&quot;&#39;</span><span class="o">//</span> <span class="p">&amp;</span>
               <span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(.</span><span class="n">true</span><span class="p">.,</span><span class="n">N_COL</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39;&quot; format=&quot;ascii&quot;&gt;&#39;</span>
    <span class="k">write</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="s1">&#39;(A)&#39;</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">trim</span><span class="p">(</span><span class="n">s_buffer</span><span class="p">)</span>
    <span class="k">do </span><span class="n">n2</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">NC_NN</span>
      <span class="k">write</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="s1">&#39;(&#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(.</span><span class="n">true</span><span class="p">.,</span><span class="n">N_COL</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39;A)&#39;</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">),&amp;</span>
                                                                       <span class="p">(</span><span class="s1">&#39; &#39;</span><span class="o">//</span><span class="n">str</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">var</span><span class="p">(</span><span class="n">n1</span><span class="p">,</span><span class="n">n2</span><span class="p">)),</span><span class="n">n1</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">N_COL</span><span class="p">)</span>
    <span class="n">enddo</span>
    <span class="k">write</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="s1">&#39;(A)&#39;</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;/DataArray&gt;&#39;</span>
  <span class="k">case</span><span class="p">(</span><span class="n">raw</span><span class="p">,</span><span class="n">bin_app</span><span class="p">)</span>
    <span class="n">s_buffer</span> <span class="o">=</span> <span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;DataArray type=&quot;Float32&quot; Name=&quot;&#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">varname</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&quot; NumberOfComponents=&quot;&#39;</span><span class="o">//</span> <span class="p">&amp;</span>
               <span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(.</span><span class="n">true</span><span class="p">.,</span><span class="n">N_COL</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39;&quot; format=&quot;appended&quot; offset=&quot;&#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(.</span><span class="n">true</span><span class="p">.,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">ioffset</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39;&quot;/&gt;&#39;</span>
    <span class="k">write</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">trim</span><span class="p">(</span><span class="n">s_buffer</span><span class="p">)</span><span class="o">//</span><span class="n">end_rec</span>
    <span class="k">call </span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">byte_update</span><span class="p">(</span><span class="n">N_Byte</span> <span class="o">=</span> <span class="n">N_COL</span><span class="o">*</span><span class="n">NC_NN</span><span class="o">*</span><span class="n">BYR4P</span><span class="p">)</span>
    <span class="k">write</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">ua</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">N_Byte</span><span class="p">,</span><span class="s1">&#39;R4&#39;</span><span class="p">,</span><span class="n">N_COL</span><span class="o">*</span><span class="n">NC_NN</span>
    <span class="k">write</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">ua</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="n">var</span>
  <span class="k">case</span><span class="p">(</span><span class="n">binary</span><span class="p">)</span>
    <span class="n">s_buffer</span> <span class="o">=</span> <span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;DataArray type=&quot;Float32&quot; Name=&quot;&#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">varname</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&quot; NumberOfComponents=&quot;&#39;</span><span class="o">//</span> <span class="p">&amp;</span>
               <span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(.</span><span class="n">true</span><span class="p">.,</span><span class="n">N_COL</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39;&quot; format=&quot;binary&quot;&gt;&#39;</span>
    <span class="k">write</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">trim</span><span class="p">(</span><span class="n">s_buffer</span><span class="p">)</span><span class="o">//</span><span class="n">end_rec</span>
    <span class="k">call </span><span class="n">pack_data</span><span class="p">(</span><span class="n">a1</span><span class="o">=</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">N_COL</span><span class="o">*</span><span class="n">NC_NN</span><span class="o">*</span><span class="n">BYR4P</span><span class="p">,</span><span class="n">I4P</span><span class="p">)],</span><span class="n">a2</span><span class="o">=</span><span class="nb">reshape</span><span class="p">(</span><span class="n">var</span><span class="p">,[</span><span class="n">N_COL</span><span class="o">*</span><span class="n">NC_NN</span><span class="p">]),</span><span class="n">packed</span><span class="o">=</span><span class="n">varp</span><span class="p">)</span>
    <span class="k">call </span><span class="n">b64_encode</span><span class="p">(</span><span class="n">nB</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">BYI1P</span><span class="p">,</span><span class="n">I4P</span><span class="p">),</span><span class="n">n</span><span class="o">=</span><span class="n">varp</span><span class="p">,</span><span class="n">code</span><span class="o">=</span><span class="n">var64</span><span class="p">)</span> <span class="p">;</span> <span class="k">deallocate</span><span class="p">(</span><span class="n">varp</span><span class="p">)</span>
    <span class="k">write</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="o">+</span><span class="mi">2</span><span class="p">)</span><span class="o">//</span><span class="n">tochar</span><span class="p">(</span><span class="n">var64</span><span class="p">)</span><span class="o">//</span><span class="n">end_rec</span> <span class="p">;</span> <span class="k">deallocate</span><span class="p">(</span><span class="n">var64</span><span class="p">)</span>
    <span class="k">write</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;/DataArray&gt;&#39;</span><span class="o">//</span><span class="n">end_rec</span>
  <span class="n">endselect</span>
  <span class="k">return</span>
  <span class="c">!---------------------------------------------------------------------------------------------------------------------------------</span>
  <span class="n">endfunction</span> <span class="n">VTK_VAR_XML_LIST_1DA_R4</span>

  <span class="c">!&gt; Function for saving field of list variable (R4P, 3D array).</span>
  <span class="c">!&gt; @return E_IO: integer(I4P) error flag</span>
  <span class="k">function </span><span class="n">VTK_VAR_XML_LIST_3DA_R4</span><span class="p">(</span><span class="n">NC_NN</span><span class="p">,</span><span class="n">N_COL</span><span class="p">,</span><span class="n">varname</span><span class="p">,</span><span class="n">var</span><span class="p">,</span><span class="n">cf</span><span class="p">)</span> <span class="k">result</span><span class="p">(</span><span class="n">E_IO</span><span class="p">)</span>
  <span class="c">!---------------------------------------------------------------------------------------------------------------------------------</span>
  <span class="k">implicit none</span>
<span class="k">  </span><span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span><span class="kd">::</span>           <span class="n">NC_NN</span>            <span class="c">!&lt; Number of cells or nodes.</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span><span class="kd">::</span>           <span class="n">N_COL</span>            <span class="c">!&lt; Number of columns.</span>
  <span class="kt">character</span><span class="p">(</span><span class="o">*</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span><span class="kd">::</span>           <span class="n">varname</span>          <span class="c">!&lt; Variable name.</span>
  <span class="kt">real</span><span class="p">(</span><span class="n">R4P</span><span class="p">),</span>    <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span><span class="kd">::</span>           <span class="n">var</span><span class="p">(</span><span class="mi">1</span><span class="p">:,</span><span class="mi">1</span><span class="p">:,</span><span class="mi">1</span><span class="p">:,</span><span class="mi">1</span><span class="p">:)</span> <span class="c">!&lt; Components [1:N_COL,1:Nx,1:Ny,1:Nz].</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">),</span> <span class="k">optional</span><span class="kd">::</span> <span class="n">cf</span>               <span class="c">!&lt; Current file index (for concurrent files IO).</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">)</span><span class="kd">::</span>                       <span class="n">E_IO</span>             <span class="c">!&lt; Input/Output inquiring flag: $0$ if IO is done, $&gt; 0$ if IO is not done.</span>
  <span class="kt">character</span><span class="p">(</span><span class="nb">len</span><span class="o">=</span><span class="n">maxlen</span><span class="p">)</span><span class="kd">::</span>              <span class="n">s_buffer</span>         <span class="c">!&lt; Buffer string.</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I1P</span><span class="p">),</span> <span class="k">allocatable</span><span class="kd">::</span>          <span class="n">varp</span><span class="p">(:)</span>          <span class="c">!&lt; Packed data.</span>
  <span class="kt">character</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="k">allocatable</span><span class="kd">::</span>          <span class="n">var64</span><span class="p">(:)</span>         <span class="c">!&lt; Variable encoded in base64.</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">)</span><span class="kd">::</span>                       <span class="n">rf</span>               <span class="c">!&lt; Real file index.</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">)</span><span class="kd">::</span>                       <span class="n">nx</span><span class="p">,</span><span class="n">ny</span><span class="p">,</span><span class="n">nz</span><span class="p">,</span><span class="n">n1</span>      <span class="c">!&lt; Counters.</span>
  <span class="c">!---------------------------------------------------------------------------------------------------------------------------------</span>

  <span class="c">!---------------------------------------------------------------------------------------------------------------------------------</span>
  <span class="n">E_IO</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1_I4P</span>
  <span class="n">rf</span> <span class="o">=</span> <span class="n">f</span>
  <span class="k">if</span> <span class="p">(</span><span class="nb">present</span><span class="p">(</span><span class="n">cf</span><span class="p">))</span> <span class="k">then</span>
<span class="k">    </span><span class="n">rf</span> <span class="o">=</span> <span class="n">cf</span> <span class="p">;</span> <span class="n">f</span> <span class="o">=</span> <span class="n">cf</span>
  <span class="n">endif</span>
  <span class="k">select case</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">f</span><span class="p">)</span>
  <span class="k">case</span><span class="p">(</span><span class="n">ascii</span><span class="p">)</span>
    <span class="n">s_buffer</span> <span class="o">=</span> <span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;DataArray type=&quot;Float32&quot; Name=&quot;&#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">varname</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&quot; NumberOfComponents=&quot;&#39;</span><span class="o">//</span> <span class="p">&amp;</span>
               <span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(.</span><span class="n">true</span><span class="p">.,</span><span class="n">N_COL</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39;&quot; format=&quot;ascii&quot;&gt;&#39;</span>
    <span class="k">write</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="s1">&#39;(A)&#39;</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">trim</span><span class="p">(</span><span class="n">s_buffer</span><span class="p">)</span>
    <span class="k">do </span><span class="n">nz</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">size</span><span class="p">(</span><span class="n">var</span><span class="p">,</span><span class="nb">dim</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span> <span class="p">;</span> <span class="k">do </span><span class="n">ny</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">size</span><span class="p">(</span><span class="n">var</span><span class="p">,</span><span class="nb">dim</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span> <span class="p">;</span> <span class="k">do </span><span class="n">nx</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">size</span><span class="p">(</span><span class="n">var</span><span class="p">,</span><span class="nb">dim</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
      <span class="k">write</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="s1">&#39;(&#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(.</span><span class="n">true</span><span class="p">.,</span><span class="n">N_COL</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39;A)&#39;</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">),&amp;</span>
                                                                       <span class="p">(</span><span class="s1">&#39; &#39;</span><span class="o">//</span><span class="n">str</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">var</span><span class="p">(</span><span class="n">n1</span><span class="p">,</span><span class="n">nx</span><span class="p">,</span><span class="n">ny</span><span class="p">,</span><span class="n">nz</span><span class="p">)),</span><span class="n">n1</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">N_COL</span><span class="p">)</span>
    <span class="n">enddo</span> <span class="p">;</span> <span class="n">enddo</span> <span class="p">;</span> <span class="n">enddo</span>
    <span class="k">write</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="s1">&#39;(A)&#39;</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;/DataArray&gt;&#39;</span>
  <span class="k">case</span><span class="p">(</span><span class="n">raw</span><span class="p">,</span><span class="n">bin_app</span><span class="p">)</span>
    <span class="n">s_buffer</span> <span class="o">=</span> <span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;DataArray type=&quot;Float32&quot; Name=&quot;&#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">varname</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&quot; NumberOfComponents=&quot;&#39;</span><span class="o">//</span> <span class="p">&amp;</span>
               <span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(.</span><span class="n">true</span><span class="p">.,</span><span class="n">N_COL</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39;&quot; format=&quot;appended&quot; offset=&quot;&#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(.</span><span class="n">true</span><span class="p">.,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">ioffset</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39;&quot;/&gt;&#39;</span>
    <span class="k">write</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">trim</span><span class="p">(</span><span class="n">s_buffer</span><span class="p">)</span><span class="o">//</span><span class="n">end_rec</span>
    <span class="k">call </span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">byte_update</span><span class="p">(</span><span class="n">N_Byte</span> <span class="o">=</span> <span class="n">N_COL</span><span class="o">*</span><span class="n">NC_NN</span><span class="o">*</span><span class="n">BYR4P</span><span class="p">)</span>
    <span class="k">write</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">ua</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">N_Byte</span><span class="p">,</span><span class="s1">&#39;R4&#39;</span><span class="p">,</span><span class="n">N_COL</span><span class="o">*</span><span class="n">NC_NN</span>
    <span class="k">write</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">ua</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="n">var</span>
  <span class="k">case</span><span class="p">(</span><span class="n">binary</span><span class="p">)</span>
    <span class="n">s_buffer</span> <span class="o">=</span> <span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;DataArray type=&quot;Float32&quot; Name=&quot;&#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">varname</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&quot; NumberOfComponents=&quot;&#39;</span><span class="o">//</span> <span class="p">&amp;</span>
               <span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(.</span><span class="n">true</span><span class="p">.,</span><span class="n">N_COL</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39;&quot; format=&quot;binary&quot;&gt;&#39;</span>
    <span class="k">write</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">trim</span><span class="p">(</span><span class="n">s_buffer</span><span class="p">)</span><span class="o">//</span><span class="n">end_rec</span>
    <span class="k">call </span><span class="n">pack_data</span><span class="p">(</span><span class="n">a1</span><span class="o">=</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">N_COL</span><span class="o">*</span><span class="n">NC_NN</span><span class="o">*</span><span class="n">BYR4P</span><span class="p">,</span><span class="n">I4P</span><span class="p">)],</span><span class="n">a2</span><span class="o">=</span><span class="nb">reshape</span><span class="p">(</span><span class="n">var</span><span class="p">,[</span><span class="n">N_COL</span><span class="o">*</span><span class="n">NC_NN</span><span class="p">]),</span><span class="n">packed</span><span class="o">=</span><span class="n">varp</span><span class="p">)</span>
    <span class="k">call </span><span class="n">b64_encode</span><span class="p">(</span><span class="n">nB</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">BYI1P</span><span class="p">,</span><span class="n">I4P</span><span class="p">),</span><span class="n">n</span><span class="o">=</span><span class="n">varp</span><span class="p">,</span><span class="n">code</span><span class="o">=</span><span class="n">var64</span><span class="p">)</span> <span class="p">;</span> <span class="k">deallocate</span><span class="p">(</span><span class="n">varp</span><span class="p">)</span>
    <span class="k">write</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="o">+</span><span class="mi">2</span><span class="p">)</span><span class="o">//</span><span class="n">tochar</span><span class="p">(</span><span class="n">var64</span><span class="p">)</span><span class="o">//</span><span class="n">end_rec</span> <span class="p">;</span> <span class="k">deallocate</span><span class="p">(</span><span class="n">var64</span><span class="p">)</span>
    <span class="k">write</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;/DataArray&gt;&#39;</span><span class="o">//</span><span class="n">end_rec</span>
  <span class="n">endselect</span>
  <span class="k">return</span>
  <span class="c">!---------------------------------------------------------------------------------------------------------------------------------</span>
  <span class="n">endfunction</span> <span class="n">VTK_VAR_XML_LIST_3DA_R4</span>

  <span class="c">!&gt; Function for saving field of list variable (I8P, 1D array).</span>
  <span class="c">!&gt; @return E_IO: integer(I4P) error flag</span>
  <span class="k">function </span><span class="n">VTK_VAR_XML_LIST_1DA_I8</span><span class="p">(</span><span class="n">NC_NN</span><span class="p">,</span><span class="n">N_COL</span><span class="p">,</span><span class="n">varname</span><span class="p">,</span><span class="n">var</span><span class="p">,</span><span class="n">cf</span><span class="p">)</span> <span class="k">result</span><span class="p">(</span><span class="n">E_IO</span><span class="p">)</span>
  <span class="c">!---------------------------------------------------------------------------------------------------------------------------------</span>
  <span class="k">implicit none</span>
<span class="k">  </span><span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span><span class="kd">::</span>           <span class="n">NC_NN</span>      <span class="c">!&lt; Number of cells or nodes.</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span><span class="kd">::</span>           <span class="n">N_COL</span>      <span class="c">!&lt; Number of columns.</span>
  <span class="kt">character</span><span class="p">(</span><span class="o">*</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span><span class="kd">::</span>           <span class="n">varname</span>    <span class="c">!&lt; Variable name.</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I8P</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span><span class="kd">::</span>           <span class="n">var</span><span class="p">(</span><span class="mi">1</span><span class="p">:,</span><span class="mi">1</span><span class="p">:)</span> <span class="c">!&lt; Components [1:N_COL,1:NC_NN].</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">),</span> <span class="k">optional</span><span class="kd">::</span> <span class="n">cf</span>         <span class="c">!&lt; Current file index (for concurrent files IO).</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">)</span><span class="kd">::</span>                       <span class="n">E_IO</span>       <span class="c">!&lt; Input/Output inquiring flag: $0$ if IO is done, $&gt; 0$ if IO is not done.</span>
  <span class="kt">character</span><span class="p">(</span><span class="nb">len</span><span class="o">=</span><span class="n">maxlen</span><span class="p">)</span><span class="kd">::</span>              <span class="n">s_buffer</span>   <span class="c">!&lt; Buffer string.</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I1P</span><span class="p">),</span> <span class="k">allocatable</span><span class="kd">::</span>          <span class="n">varp</span><span class="p">(:)</span>    <span class="c">!&lt; Packed data.</span>
  <span class="kt">character</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="k">allocatable</span><span class="kd">::</span>          <span class="n">var64</span><span class="p">(:)</span>   <span class="c">!&lt; Variable encoded in base64.</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">)</span><span class="kd">::</span>                       <span class="n">rf</span>         <span class="c">!&lt; Real file index.</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">)</span><span class="kd">::</span>                       <span class="n">n1</span><span class="p">,</span><span class="n">n2</span>      <span class="c">!&lt; Counters.</span>
  <span class="c">!---------------------------------------------------------------------------------------------------------------------------------</span>

  <span class="c">!---------------------------------------------------------------------------------------------------------------------------------</span>
  <span class="n">E_IO</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1_I4P</span>
  <span class="n">rf</span> <span class="o">=</span> <span class="n">f</span>
  <span class="k">if</span> <span class="p">(</span><span class="nb">present</span><span class="p">(</span><span class="n">cf</span><span class="p">))</span> <span class="k">then</span>
<span class="k">    </span><span class="n">rf</span> <span class="o">=</span> <span class="n">cf</span> <span class="p">;</span> <span class="n">f</span> <span class="o">=</span> <span class="n">cf</span>
  <span class="n">endif</span>
  <span class="k">select case</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">f</span><span class="p">)</span>
  <span class="k">case</span><span class="p">(</span><span class="n">ascii</span><span class="p">)</span>
    <span class="n">s_buffer</span> <span class="o">=</span> <span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;DataArray type=&quot;Int64&quot; Name=&quot;&#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">varname</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&quot; NumberOfComponents=&quot;&#39;</span><span class="o">//</span> <span class="p">&amp;</span>
               <span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(.</span><span class="n">true</span><span class="p">.,</span><span class="n">N_COL</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39;&quot; format=&quot;ascii&quot;&gt;&#39;</span>
    <span class="k">write</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="s1">&#39;(A)&#39;</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">trim</span><span class="p">(</span><span class="n">s_buffer</span><span class="p">)</span>
    <span class="k">do </span><span class="n">n2</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">NC_NN</span>
      <span class="k">write</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="s1">&#39;(&#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(.</span><span class="n">true</span><span class="p">.,</span><span class="n">N_COL</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39;A)&#39;</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">),&amp;</span>
                                                                       <span class="p">(</span><span class="s1">&#39; &#39;</span><span class="o">//</span><span class="n">str</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">var</span><span class="p">(</span><span class="n">n1</span><span class="p">,</span><span class="n">n2</span><span class="p">)),</span><span class="n">n1</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">N_COL</span><span class="p">)</span>
    <span class="n">enddo</span>
    <span class="k">write</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="s1">&#39;(A)&#39;</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;/DataArray&gt;&#39;</span>
  <span class="k">case</span><span class="p">(</span><span class="n">raw</span><span class="p">,</span><span class="n">bin_app</span><span class="p">)</span>
    <span class="n">s_buffer</span> <span class="o">=</span> <span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;DataArray type=&quot;Int64&quot; Name=&quot;&#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">varname</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&quot; NumberOfComponents=&quot;&#39;</span><span class="o">//</span> <span class="p">&amp;</span>
               <span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(.</span><span class="n">true</span><span class="p">.,</span><span class="n">N_COL</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39;&quot; format=&quot;appended&quot; offset=&quot;&#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(.</span><span class="n">true</span><span class="p">.,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">ioffset</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39;&quot;/&gt;&#39;</span>
    <span class="k">write</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">trim</span><span class="p">(</span><span class="n">s_buffer</span><span class="p">)</span><span class="o">//</span><span class="n">end_rec</span>
    <span class="k">call </span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">byte_update</span><span class="p">(</span><span class="n">N_Byte</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">N_COL</span><span class="o">*</span><span class="n">NC_NN</span><span class="o">*</span><span class="n">BYI8P</span><span class="p">,</span><span class="n">I4P</span><span class="p">))</span>
    <span class="k">write</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">ua</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">N_Byte</span><span class="p">,</span><span class="s1">&#39;I8&#39;</span><span class="p">,</span><span class="n">N_COL</span><span class="o">*</span><span class="n">NC_NN</span>
    <span class="k">write</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">ua</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="n">var</span>
  <span class="k">case</span><span class="p">(</span><span class="n">binary</span><span class="p">)</span>
    <span class="n">s_buffer</span> <span class="o">=</span> <span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;DataArray type=&quot;Int64&quot; Name=&quot;&#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">varname</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&quot; NumberOfComponents=&quot;&#39;</span><span class="o">//</span> <span class="p">&amp;</span>
               <span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(.</span><span class="n">true</span><span class="p">.,</span><span class="n">N_COL</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39;&quot; format=&quot;binary&quot;&gt;&#39;</span>
    <span class="k">write</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">trim</span><span class="p">(</span><span class="n">s_buffer</span><span class="p">)</span><span class="o">//</span><span class="n">end_rec</span>
    <span class="k">call </span><span class="n">pack_data</span><span class="p">(</span><span class="n">a1</span><span class="o">=</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">N_COL</span><span class="o">*</span><span class="n">NC_NN</span><span class="o">*</span><span class="n">BYI8P</span><span class="p">,</span><span class="n">I4P</span><span class="p">)],</span><span class="n">a2</span><span class="o">=</span><span class="nb">reshape</span><span class="p">(</span><span class="n">var</span><span class="p">,[</span><span class="n">N_COL</span><span class="o">*</span><span class="n">NC_NN</span><span class="p">]),</span><span class="n">packed</span><span class="o">=</span><span class="n">varp</span><span class="p">)</span>
    <span class="k">call </span><span class="n">b64_encode</span><span class="p">(</span><span class="n">nB</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">BYI1P</span><span class="p">,</span><span class="n">I4P</span><span class="p">),</span><span class="n">n</span><span class="o">=</span><span class="n">varp</span><span class="p">,</span><span class="n">code</span><span class="o">=</span><span class="n">var64</span><span class="p">)</span> <span class="p">;</span> <span class="k">deallocate</span><span class="p">(</span><span class="n">varp</span><span class="p">)</span>
    <span class="k">write</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="o">+</span><span class="mi">2</span><span class="p">)</span><span class="o">//</span><span class="n">tochar</span><span class="p">(</span><span class="n">var64</span><span class="p">)</span><span class="o">//</span><span class="n">end_rec</span> <span class="p">;</span> <span class="k">deallocate</span><span class="p">(</span><span class="n">var64</span><span class="p">)</span>
    <span class="k">write</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;/DataArray&gt;&#39;</span><span class="o">//</span><span class="n">end_rec</span>
  <span class="n">endselect</span>
  <span class="k">return</span>
  <span class="c">!---------------------------------------------------------------------------------------------------------------------------------</span>
  <span class="n">endfunction</span> <span class="n">VTK_VAR_XML_LIST_1DA_I8</span>

  <span class="c">!&gt; Function for saving field of list variable (I8P, 3D array).</span>
  <span class="c">!&gt; @return E_IO: integer(I4P) error flag</span>
  <span class="k">function </span><span class="n">VTK_VAR_XML_LIST_3DA_I8</span><span class="p">(</span><span class="n">NC_NN</span><span class="p">,</span><span class="n">N_COL</span><span class="p">,</span><span class="n">varname</span><span class="p">,</span><span class="n">var</span><span class="p">,</span><span class="n">cf</span><span class="p">)</span> <span class="k">result</span><span class="p">(</span><span class="n">E_IO</span><span class="p">)</span>
  <span class="c">!---------------------------------------------------------------------------------------------------------------------------------</span>
  <span class="k">implicit none</span>
<span class="k">  </span><span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span><span class="kd">::</span>           <span class="n">NC_NN</span>            <span class="c">!&lt; Number of cells or nodes.</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span><span class="kd">::</span>           <span class="n">N_COL</span>            <span class="c">!&lt; Number of columns.</span>
  <span class="kt">character</span><span class="p">(</span><span class="o">*</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span><span class="kd">::</span>           <span class="n">varname</span>          <span class="c">!&lt; Variable name.</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I8P</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span><span class="kd">::</span>           <span class="n">var</span><span class="p">(</span><span class="mi">1</span><span class="p">:,</span><span class="mi">1</span><span class="p">:,</span><span class="mi">1</span><span class="p">:,</span><span class="mi">1</span><span class="p">:)</span> <span class="c">!&lt; Components [1:N_COL,1:Nx,1:Ny,1:Nz].</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">),</span> <span class="k">optional</span><span class="kd">::</span> <span class="n">cf</span>               <span class="c">!&lt; Current file index (for concurrent files IO).</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">)</span><span class="kd">::</span>                       <span class="n">E_IO</span>             <span class="c">!&lt; Input/Output inquiring flag: $0$ if IO is done, $&gt; 0$ if IO is not done.</span>
  <span class="kt">character</span><span class="p">(</span><span class="nb">len</span><span class="o">=</span><span class="n">maxlen</span><span class="p">)</span><span class="kd">::</span>              <span class="n">s_buffer</span>         <span class="c">!&lt; Buffer string.</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I1P</span><span class="p">),</span> <span class="k">allocatable</span><span class="kd">::</span>          <span class="n">varp</span><span class="p">(:)</span>          <span class="c">!&lt; Packed data.</span>
  <span class="kt">character</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="k">allocatable</span><span class="kd">::</span>          <span class="n">var64</span><span class="p">(:)</span>         <span class="c">!&lt; Variable encoded in base64.</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">)</span><span class="kd">::</span>                       <span class="n">rf</span>               <span class="c">!&lt; Real file index.</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">)</span><span class="kd">::</span>                       <span class="n">nx</span><span class="p">,</span><span class="n">ny</span><span class="p">,</span><span class="n">nz</span><span class="p">,</span><span class="n">n1</span>      <span class="c">!&lt; Counters.</span>
  <span class="c">!---------------------------------------------------------------------------------------------------------------------------------</span>

  <span class="c">!---------------------------------------------------------------------------------------------------------------------------------</span>
  <span class="n">E_IO</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1_I4P</span>
  <span class="n">rf</span> <span class="o">=</span> <span class="n">f</span>
  <span class="k">if</span> <span class="p">(</span><span class="nb">present</span><span class="p">(</span><span class="n">cf</span><span class="p">))</span> <span class="k">then</span>
<span class="k">    </span><span class="n">rf</span> <span class="o">=</span> <span class="n">cf</span> <span class="p">;</span> <span class="n">f</span> <span class="o">=</span> <span class="n">cf</span>
  <span class="n">endif</span>
  <span class="k">select case</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">f</span><span class="p">)</span>
  <span class="k">case</span><span class="p">(</span><span class="n">ascii</span><span class="p">)</span>
    <span class="n">s_buffer</span> <span class="o">=</span> <span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;DataArray type=&quot;Int64&quot; Name=&quot;&#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">varname</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&quot; NumberOfComponents=&quot;&#39;</span><span class="o">//</span> <span class="p">&amp;</span>
               <span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(.</span><span class="n">true</span><span class="p">.,</span><span class="n">N_COL</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39;&quot; format=&quot;ascii&quot;&gt;&#39;</span>
    <span class="k">write</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="s1">&#39;(A)&#39;</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">trim</span><span class="p">(</span><span class="n">s_buffer</span><span class="p">)</span>
    <span class="k">do </span><span class="n">nz</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">size</span><span class="p">(</span><span class="n">var</span><span class="p">,</span><span class="nb">dim</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span> <span class="p">;</span> <span class="k">do </span><span class="n">ny</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">size</span><span class="p">(</span><span class="n">var</span><span class="p">,</span><span class="nb">dim</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span> <span class="p">;</span> <span class="k">do </span><span class="n">nx</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">size</span><span class="p">(</span><span class="n">var</span><span class="p">,</span><span class="nb">dim</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
      <span class="k">write</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="s1">&#39;(&#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(.</span><span class="n">true</span><span class="p">.,</span><span class="n">N_COL</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39;A)&#39;</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">),&amp;</span>
                                                                       <span class="p">(</span><span class="s1">&#39; &#39;</span><span class="o">//</span><span class="n">str</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">var</span><span class="p">(</span><span class="n">n1</span><span class="p">,</span><span class="n">nx</span><span class="p">,</span><span class="n">ny</span><span class="p">,</span><span class="n">nz</span><span class="p">)),</span><span class="n">n1</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">N_COL</span><span class="p">)</span>
    <span class="n">enddo</span> <span class="p">;</span> <span class="n">enddo</span> <span class="p">;</span> <span class="n">enddo</span>
    <span class="k">write</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="s1">&#39;(A)&#39;</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;/DataArray&gt;&#39;</span>
  <span class="k">case</span><span class="p">(</span><span class="n">raw</span><span class="p">,</span><span class="n">bin_app</span><span class="p">)</span>
    <span class="n">s_buffer</span> <span class="o">=</span> <span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;DataArray type=&quot;Int64&quot; Name=&quot;&#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">varname</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&quot; NumberOfComponents=&quot;&#39;</span><span class="o">//</span> <span class="p">&amp;</span>
               <span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(.</span><span class="n">true</span><span class="p">.,</span><span class="n">N_COL</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39;&quot; format=&quot;appended&quot; offset=&quot;&#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(.</span><span class="n">true</span><span class="p">.,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">ioffset</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39;&quot;/&gt;&#39;</span>
    <span class="k">write</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">trim</span><span class="p">(</span><span class="n">s_buffer</span><span class="p">)</span><span class="o">//</span><span class="n">end_rec</span>
    <span class="k">call </span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">byte_update</span><span class="p">(</span><span class="n">N_Byte</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">N_COL</span><span class="o">*</span><span class="n">NC_NN</span><span class="o">*</span><span class="n">BYI8P</span><span class="p">,</span><span class="n">I4P</span><span class="p">))</span>
    <span class="k">write</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">ua</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">N_Byte</span><span class="p">,</span><span class="s1">&#39;I8&#39;</span><span class="p">,</span><span class="n">N_COL</span><span class="o">*</span><span class="n">NC_NN</span>
    <span class="k">write</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">ua</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="n">var</span>
  <span class="k">case</span><span class="p">(</span><span class="n">binary</span><span class="p">)</span>
    <span class="n">s_buffer</span> <span class="o">=</span> <span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;DataArray type=&quot;Int64&quot; Name=&quot;&#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">varname</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&quot; NumberOfComponents=&quot;&#39;</span><span class="o">//</span> <span class="p">&amp;</span>
               <span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(.</span><span class="n">true</span><span class="p">.,</span><span class="n">N_COL</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39;&quot; format=&quot;binary&quot;&gt;&#39;</span>
    <span class="k">write</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">trim</span><span class="p">(</span><span class="n">s_buffer</span><span class="p">)</span><span class="o">//</span><span class="n">end_rec</span>
    <span class="k">call </span><span class="n">pack_data</span><span class="p">(</span><span class="n">a1</span><span class="o">=</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">N_COL</span><span class="o">*</span><span class="n">NC_NN</span><span class="o">*</span><span class="n">BYI8P</span><span class="p">,</span><span class="n">I4P</span><span class="p">)],</span><span class="n">a2</span><span class="o">=</span><span class="nb">reshape</span><span class="p">(</span><span class="n">var</span><span class="p">,[</span><span class="n">N_COL</span><span class="o">*</span><span class="n">NC_NN</span><span class="p">]),</span><span class="n">packed</span><span class="o">=</span><span class="n">varp</span><span class="p">)</span>
    <span class="k">call </span><span class="n">b64_encode</span><span class="p">(</span><span class="n">nB</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">BYI1P</span><span class="p">,</span><span class="n">I4P</span><span class="p">),</span><span class="n">n</span><span class="o">=</span><span class="n">varp</span><span class="p">,</span><span class="n">code</span><span class="o">=</span><span class="n">var64</span><span class="p">)</span> <span class="p">;</span> <span class="k">deallocate</span><span class="p">(</span><span class="n">varp</span><span class="p">)</span>
    <span class="k">write</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="o">+</span><span class="mi">2</span><span class="p">)</span><span class="o">//</span><span class="n">tochar</span><span class="p">(</span><span class="n">var64</span><span class="p">)</span><span class="o">//</span><span class="n">end_rec</span> <span class="p">;</span> <span class="k">deallocate</span><span class="p">(</span><span class="n">var64</span><span class="p">)</span>
    <span class="k">write</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;/DataArray&gt;&#39;</span><span class="o">//</span><span class="n">end_rec</span>
  <span class="n">endselect</span>
  <span class="k">return</span>
  <span class="c">!---------------------------------------------------------------------------------------------------------------------------------</span>
  <span class="n">endfunction</span> <span class="n">VTK_VAR_XML_LIST_3DA_I8</span>

  <span class="c">!&gt; Function for saving field of list variable (I4P, 1D array).</span>
  <span class="c">!&gt; @return E_IO: integer(I4P) error flag</span>
  <span class="k">function </span><span class="n">VTK_VAR_XML_LIST_1DA_I4</span><span class="p">(</span><span class="n">NC_NN</span><span class="p">,</span><span class="n">N_COL</span><span class="p">,</span><span class="n">varname</span><span class="p">,</span><span class="n">var</span><span class="p">,</span><span class="n">cf</span><span class="p">)</span> <span class="k">result</span><span class="p">(</span><span class="n">E_IO</span><span class="p">)</span>
  <span class="c">!---------------------------------------------------------------------------------------------------------------------------------</span>
  <span class="k">implicit none</span>
<span class="k">  </span><span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span><span class="kd">::</span>           <span class="n">NC_NN</span>      <span class="c">!&lt; Number of cells or nodes.</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span><span class="kd">::</span>           <span class="n">N_COL</span>      <span class="c">!&lt; Number of columns.</span>
  <span class="kt">character</span><span class="p">(</span><span class="o">*</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span><span class="kd">::</span>           <span class="n">varname</span>    <span class="c">!&lt; Variable name.</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span><span class="kd">::</span>           <span class="n">var</span><span class="p">(</span><span class="mi">1</span><span class="p">:,</span><span class="mi">1</span><span class="p">:)</span> <span class="c">!&lt; Components [1:N_COL,1:NC_NN].</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">),</span> <span class="k">optional</span><span class="kd">::</span> <span class="n">cf</span>         <span class="c">!&lt; Current file index (for concurrent files IO).</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">)</span><span class="kd">::</span>                       <span class="n">E_IO</span>       <span class="c">!&lt; Input/Output inquiring flag: $0$ if IO is done, $&gt; 0$ if IO is not done.</span>
  <span class="kt">character</span><span class="p">(</span><span class="nb">len</span><span class="o">=</span><span class="n">maxlen</span><span class="p">)</span><span class="kd">::</span>              <span class="n">s_buffer</span>   <span class="c">!&lt; Buffer string.</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I1P</span><span class="p">),</span> <span class="k">allocatable</span><span class="kd">::</span>          <span class="n">varp</span><span class="p">(:)</span>    <span class="c">!&lt; Packed data.</span>
  <span class="kt">character</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="k">allocatable</span><span class="kd">::</span>          <span class="n">var64</span><span class="p">(:)</span>   <span class="c">!&lt; Variable encoded in base64.</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">)</span><span class="kd">::</span>                       <span class="n">rf</span>         <span class="c">!&lt; Real file index.</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">)</span><span class="kd">::</span>                       <span class="n">n1</span><span class="p">,</span><span class="n">n2</span>      <span class="c">!&lt; Counters.</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I8P</span><span class="p">)</span><span class="kd">::</span>                       <span class="n">Nvarp</span>      <span class="c">!&lt; Dimension of varp, packed data.</span>
  <span class="c">!---------------------------------------------------------------------------------------------------------------------------------</span>

  <span class="c">!---------------------------------------------------------------------------------------------------------------------------------</span>
  <span class="n">E_IO</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1_I4P</span>
  <span class="n">rf</span> <span class="o">=</span> <span class="n">f</span>
  <span class="k">if</span> <span class="p">(</span><span class="nb">present</span><span class="p">(</span><span class="n">cf</span><span class="p">))</span> <span class="k">then</span>
<span class="k">    </span><span class="n">rf</span> <span class="o">=</span> <span class="n">cf</span> <span class="p">;</span> <span class="n">f</span> <span class="o">=</span> <span class="n">cf</span>
  <span class="n">endif</span>
  <span class="k">select case</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">f</span><span class="p">)</span>
  <span class="k">case</span><span class="p">(</span><span class="n">ascii</span><span class="p">)</span>
    <span class="n">s_buffer</span> <span class="o">=</span> <span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;DataArray type=&quot;Int32&quot; Name=&quot;&#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">varname</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&quot; NumberOfComponents=&quot;&#39;</span><span class="o">//</span> <span class="p">&amp;</span>
               <span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(.</span><span class="n">true</span><span class="p">.,</span><span class="n">N_COL</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39;&quot; format=&quot;ascii&quot;&gt;&#39;</span>
    <span class="k">write</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="s1">&#39;(A)&#39;</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">trim</span><span class="p">(</span><span class="n">s_buffer</span><span class="p">)</span>
    <span class="k">do </span><span class="n">n2</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">NC_NN</span>
      <span class="k">write</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="s1">&#39;(&#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(.</span><span class="n">true</span><span class="p">.,</span><span class="n">N_COL</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39;A)&#39;</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">),&amp;</span>
                                                                       <span class="p">(</span><span class="s1">&#39; &#39;</span><span class="o">//</span><span class="n">str</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">var</span><span class="p">(</span><span class="n">n1</span><span class="p">,</span><span class="n">n2</span><span class="p">)),</span><span class="n">n1</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">N_COL</span><span class="p">)</span>
    <span class="n">enddo</span>
    <span class="k">write</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="s1">&#39;(A)&#39;</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;/DataArray&gt;&#39;</span>
  <span class="k">case</span><span class="p">(</span><span class="n">raw</span><span class="p">,</span><span class="n">bin_app</span><span class="p">)</span>
    <span class="n">s_buffer</span> <span class="o">=</span> <span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;DataArray type=&quot;Int32&quot; Name=&quot;&#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">varname</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&quot; NumberOfComponents=&quot;&#39;</span><span class="o">//</span> <span class="p">&amp;</span>
               <span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(.</span><span class="n">true</span><span class="p">.,</span><span class="n">N_COL</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39;&quot; format=&quot;appended&quot; offset=&quot;&#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(.</span><span class="n">true</span><span class="p">.,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">ioffset</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39;&quot;/&gt;&#39;</span>
    <span class="k">write</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">trim</span><span class="p">(</span><span class="n">s_buffer</span><span class="p">)</span><span class="o">//</span><span class="n">end_rec</span>
    <span class="k">call </span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">byte_update</span><span class="p">(</span><span class="n">N_Byte</span> <span class="o">=</span> <span class="n">N_COL</span><span class="o">*</span><span class="n">NC_NN</span><span class="o">*</span><span class="n">BYI4P</span><span class="p">)</span>
    <span class="k">write</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">ua</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">N_Byte</span><span class="p">,</span><span class="s1">&#39;I4&#39;</span><span class="p">,</span><span class="n">N_COL</span><span class="o">*</span><span class="n">NC_NN</span>
    <span class="k">write</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">ua</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="n">var</span>
  <span class="k">case</span><span class="p">(</span><span class="n">binary</span><span class="p">)</span>
    <span class="n">s_buffer</span> <span class="o">=</span> <span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;DataArray type=&quot;Int32&quot; Name=&quot;&#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">varname</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&quot; NumberOfComponents=&quot;&#39;</span><span class="o">//</span> <span class="p">&amp;</span>
               <span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(.</span><span class="n">true</span><span class="p">.,</span><span class="n">N_COL</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39;&quot; format=&quot;binary&quot;&gt;&#39;</span>
    <span class="k">write</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">trim</span><span class="p">(</span><span class="n">s_buffer</span><span class="p">)</span><span class="o">//</span><span class="n">end_rec</span>
    <span class="n">Nvarp</span><span class="o">=</span><span class="n">size</span><span class="p">(</span><span class="nb">transfer</span><span class="p">([</span><span class="nb">int</span><span class="p">(</span><span class="n">N_COL</span><span class="o">*</span><span class="n">NC_NN</span><span class="o">*</span><span class="n">BYI4P</span><span class="p">,</span><span class="n">I4P</span><span class="p">),</span><span class="nb">reshape</span><span class="p">(</span><span class="n">var</span><span class="p">,[</span><span class="n">N_COL</span><span class="o">*</span><span class="n">NC_NN</span><span class="p">])],</span><span class="n">varp</span><span class="p">),</span><span class="nb">kind</span><span class="o">=</span><span class="n">I8P</span><span class="p">)</span>
    <span class="k">if</span> <span class="p">(</span><span class="nb">allocated</span><span class="p">(</span><span class="n">varp</span><span class="p">))</span> <span class="k">deallocate</span><span class="p">(</span><span class="n">varp</span><span class="p">);</span> <span class="k">allocate</span><span class="p">(</span><span class="n">varp</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">Nvarp</span><span class="p">))</span>
    <span class="n">varp</span> <span class="o">=</span> <span class="nb">transfer</span><span class="p">([</span><span class="nb">int</span><span class="p">(</span><span class="n">N_COL</span><span class="o">*</span><span class="n">NC_NN</span><span class="o">*</span><span class="n">BYI4P</span><span class="p">,</span><span class="n">I4P</span><span class="p">),</span><span class="nb">reshape</span><span class="p">(</span><span class="n">var</span><span class="p">,[</span><span class="n">N_COL</span><span class="o">*</span><span class="n">NC_NN</span><span class="p">])],</span><span class="n">varp</span><span class="p">)</span>
    <span class="k">call </span><span class="n">b64_encode</span><span class="p">(</span><span class="n">nB</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">BYI1P</span><span class="p">,</span><span class="n">I4P</span><span class="p">),</span><span class="n">n</span><span class="o">=</span><span class="n">varp</span><span class="p">,</span><span class="n">code</span><span class="o">=</span><span class="n">var64</span><span class="p">)</span> <span class="p">;</span> <span class="k">deallocate</span><span class="p">(</span><span class="n">varp</span><span class="p">)</span>
    <span class="k">write</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="o">+</span><span class="mi">2</span><span class="p">)</span><span class="o">//</span><span class="n">tochar</span><span class="p">(</span><span class="n">var64</span><span class="p">)</span><span class="o">//</span><span class="n">end_rec</span> <span class="p">;</span> <span class="k">deallocate</span><span class="p">(</span><span class="n">var64</span><span class="p">)</span>
    <span class="k">write</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;/DataArray&gt;&#39;</span><span class="o">//</span><span class="n">end_rec</span>
  <span class="n">endselect</span>
  <span class="k">return</span>
  <span class="c">!---------------------------------------------------------------------------------------------------------------------------------</span>
  <span class="n">endfunction</span> <span class="n">VTK_VAR_XML_LIST_1DA_I4</span>

  <span class="c">!&gt; Function for saving field of list variable (I4P, 3D array).</span>
  <span class="c">!&gt; @return E_IO: integer(I4P) error flag</span>
  <span class="k">function </span><span class="n">VTK_VAR_XML_LIST_3DA_I4</span><span class="p">(</span><span class="n">NC_NN</span><span class="p">,</span><span class="n">N_COL</span><span class="p">,</span><span class="n">varname</span><span class="p">,</span><span class="n">var</span><span class="p">,</span><span class="n">cf</span><span class="p">)</span> <span class="k">result</span><span class="p">(</span><span class="n">E_IO</span><span class="p">)</span>
  <span class="c">!---------------------------------------------------------------------------------------------------------------------------------</span>
  <span class="k">implicit none</span>
<span class="k">  </span><span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span><span class="kd">::</span>           <span class="n">NC_NN</span>            <span class="c">!&lt; Number of cells or nodes.</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span><span class="kd">::</span>           <span class="n">N_COL</span>            <span class="c">!&lt; Number of columns.</span>
  <span class="kt">character</span><span class="p">(</span><span class="o">*</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span><span class="kd">::</span>           <span class="n">varname</span>          <span class="c">!&lt; Variable name.</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span><span class="kd">::</span>           <span class="n">var</span><span class="p">(</span><span class="mi">1</span><span class="p">:,</span><span class="mi">1</span><span class="p">:,</span><span class="mi">1</span><span class="p">:,</span><span class="mi">1</span><span class="p">:)</span> <span class="c">!&lt; Components [1:N_COL,1:Nx,1:Ny,1:Nz].</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">),</span> <span class="k">optional</span><span class="kd">::</span> <span class="n">cf</span>               <span class="c">!&lt; Current file index (for concurrent files IO).</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">)</span><span class="kd">::</span>                       <span class="n">E_IO</span>             <span class="c">!&lt; Input/Output inquiring flag: $0$ if IO is done, $&gt; 0$ if IO is not done.</span>
  <span class="kt">character</span><span class="p">(</span><span class="nb">len</span><span class="o">=</span><span class="n">maxlen</span><span class="p">)</span><span class="kd">::</span>              <span class="n">s_buffer</span>         <span class="c">!&lt; Buffer string.</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I1P</span><span class="p">),</span> <span class="k">allocatable</span><span class="kd">::</span>          <span class="n">varp</span><span class="p">(:)</span>          <span class="c">!&lt; Packed data.</span>
  <span class="kt">character</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="k">allocatable</span><span class="kd">::</span>          <span class="n">var64</span><span class="p">(:)</span>         <span class="c">!&lt; Variable encoded in base64.</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">)</span><span class="kd">::</span>                       <span class="n">rf</span>               <span class="c">!&lt; Real file index.</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">)</span><span class="kd">::</span>                       <span class="n">nx</span><span class="p">,</span><span class="n">ny</span><span class="p">,</span><span class="n">nz</span><span class="p">,</span><span class="n">n1</span>      <span class="c">!&lt; Counters.</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I8P</span><span class="p">)</span><span class="kd">::</span>                       <span class="n">Nvarp</span>            <span class="c">!&lt; Dimension of varp, packed data.</span>
  <span class="c">!---------------------------------------------------------------------------------------------------------------------------------</span>

  <span class="c">!---------------------------------------------------------------------------------------------------------------------------------</span>
  <span class="n">E_IO</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1_I4P</span>
  <span class="n">rf</span> <span class="o">=</span> <span class="n">f</span>
  <span class="k">if</span> <span class="p">(</span><span class="nb">present</span><span class="p">(</span><span class="n">cf</span><span class="p">))</span> <span class="k">then</span>
<span class="k">    </span><span class="n">rf</span> <span class="o">=</span> <span class="n">cf</span> <span class="p">;</span> <span class="n">f</span> <span class="o">=</span> <span class="n">cf</span>
  <span class="n">endif</span>
  <span class="k">select case</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">f</span><span class="p">)</span>
  <span class="k">case</span><span class="p">(</span><span class="n">ascii</span><span class="p">)</span>
    <span class="n">s_buffer</span> <span class="o">=</span> <span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;DataArray type=&quot;Int32&quot; Name=&quot;&#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">varname</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&quot; NumberOfComponents=&quot;&#39;</span><span class="o">//</span> <span class="p">&amp;</span>
               <span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(.</span><span class="n">true</span><span class="p">.,</span><span class="n">N_COL</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39;&quot; format=&quot;ascii&quot;&gt;&#39;</span>
    <span class="k">write</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="s1">&#39;(A)&#39;</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">trim</span><span class="p">(</span><span class="n">s_buffer</span><span class="p">)</span>
    <span class="k">do </span><span class="n">nz</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">size</span><span class="p">(</span><span class="n">var</span><span class="p">,</span><span class="nb">dim</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span> <span class="p">;</span> <span class="k">do </span><span class="n">ny</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">size</span><span class="p">(</span><span class="n">var</span><span class="p">,</span><span class="nb">dim</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span> <span class="p">;</span> <span class="k">do </span><span class="n">nx</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">size</span><span class="p">(</span><span class="n">var</span><span class="p">,</span><span class="nb">dim</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
      <span class="k">write</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="s1">&#39;(&#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(.</span><span class="n">true</span><span class="p">.,</span><span class="n">N_COL</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39;A)&#39;</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">),&amp;</span>
                                                                       <span class="p">(</span><span class="s1">&#39; &#39;</span><span class="o">//</span><span class="n">str</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">var</span><span class="p">(</span><span class="n">n1</span><span class="p">,</span><span class="n">nx</span><span class="p">,</span><span class="n">ny</span><span class="p">,</span><span class="n">nz</span><span class="p">)),</span><span class="n">n1</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">N_COL</span><span class="p">)</span>
    <span class="n">enddo</span> <span class="p">;</span> <span class="n">enddo</span> <span class="p">;</span> <span class="n">enddo</span>
    <span class="k">write</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="s1">&#39;(A)&#39;</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;/DataArray&gt;&#39;</span>
  <span class="k">case</span><span class="p">(</span><span class="n">raw</span><span class="p">,</span><span class="n">bin_app</span><span class="p">)</span>
    <span class="n">s_buffer</span> <span class="o">=</span> <span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;DataArray type=&quot;Int32&quot; Name=&quot;&#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">varname</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&quot; NumberOfComponents=&quot;&#39;</span><span class="o">//</span> <span class="p">&amp;</span>
               <span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(.</span><span class="n">true</span><span class="p">.,</span><span class="n">N_COL</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39;&quot; format=&quot;appended&quot; offset=&quot;&#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(.</span><span class="n">true</span><span class="p">.,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">ioffset</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39;&quot;/&gt;&#39;</span>
    <span class="k">write</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">trim</span><span class="p">(</span><span class="n">s_buffer</span><span class="p">)</span><span class="o">//</span><span class="n">end_rec</span>
    <span class="k">call </span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">byte_update</span><span class="p">(</span><span class="n">N_Byte</span> <span class="o">=</span> <span class="n">N_COL</span><span class="o">*</span><span class="n">NC_NN</span><span class="o">*</span><span class="n">BYI4P</span><span class="p">)</span>
    <span class="k">write</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">ua</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">N_Byte</span><span class="p">,</span><span class="s1">&#39;I4&#39;</span><span class="p">,</span><span class="n">N_COL</span><span class="o">*</span><span class="n">NC_NN</span>
    <span class="k">write</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">ua</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="n">var</span>
  <span class="k">case</span><span class="p">(</span><span class="n">binary</span><span class="p">)</span>
    <span class="n">s_buffer</span> <span class="o">=</span> <span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;DataArray type=&quot;Int32&quot; Name=&quot;&#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">varname</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&quot; NumberOfComponents=&quot;&#39;</span><span class="o">//</span> <span class="p">&amp;</span>
               <span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(.</span><span class="n">true</span><span class="p">.,</span><span class="n">N_COL</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39;&quot; format=&quot;binary&quot;&gt;&#39;</span>
    <span class="k">write</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">trim</span><span class="p">(</span><span class="n">s_buffer</span><span class="p">)</span><span class="o">//</span><span class="n">end_rec</span>
    <span class="n">Nvarp</span><span class="o">=</span><span class="n">size</span><span class="p">(</span><span class="nb">transfer</span><span class="p">([</span><span class="nb">int</span><span class="p">(</span><span class="n">N_COL</span><span class="o">*</span><span class="n">NC_NN</span><span class="o">*</span><span class="n">BYI4P</span><span class="p">,</span><span class="n">I4P</span><span class="p">),</span><span class="nb">reshape</span><span class="p">(</span><span class="n">var</span><span class="p">,[</span><span class="n">N_COL</span><span class="o">*</span><span class="n">NC_NN</span><span class="p">])],</span><span class="n">varp</span><span class="p">),</span><span class="nb">kind</span><span class="o">=</span><span class="n">I8P</span><span class="p">)</span>
    <span class="k">if</span> <span class="p">(</span><span class="nb">allocated</span><span class="p">(</span><span class="n">varp</span><span class="p">))</span> <span class="k">deallocate</span><span class="p">(</span><span class="n">varp</span><span class="p">);</span> <span class="k">allocate</span><span class="p">(</span><span class="n">varp</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">Nvarp</span><span class="p">))</span>
    <span class="n">varp</span> <span class="o">=</span> <span class="nb">transfer</span><span class="p">([</span><span class="nb">int</span><span class="p">(</span><span class="n">N_COL</span><span class="o">*</span><span class="n">NC_NN</span><span class="o">*</span><span class="n">BYI4P</span><span class="p">,</span><span class="n">I4P</span><span class="p">),</span><span class="nb">reshape</span><span class="p">(</span><span class="n">var</span><span class="p">,[</span><span class="n">N_COL</span><span class="o">*</span><span class="n">NC_NN</span><span class="p">])],</span><span class="n">varp</span><span class="p">)</span>
    <span class="k">call </span><span class="n">b64_encode</span><span class="p">(</span><span class="n">nB</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">BYI1P</span><span class="p">,</span><span class="n">I4P</span><span class="p">),</span><span class="n">n</span><span class="o">=</span><span class="n">varp</span><span class="p">,</span><span class="n">code</span><span class="o">=</span><span class="n">var64</span><span class="p">)</span> <span class="p">;</span> <span class="k">deallocate</span><span class="p">(</span><span class="n">varp</span><span class="p">)</span>
    <span class="k">write</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="o">+</span><span class="mi">2</span><span class="p">)</span><span class="o">//</span><span class="n">tochar</span><span class="p">(</span><span class="n">var64</span><span class="p">)</span><span class="o">//</span><span class="n">end_rec</span> <span class="p">;</span> <span class="k">deallocate</span><span class="p">(</span><span class="n">var64</span><span class="p">)</span>
    <span class="k">write</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;/DataArray&gt;&#39;</span><span class="o">//</span><span class="n">end_rec</span>
  <span class="n">endselect</span>
  <span class="k">return</span>
  <span class="c">!---------------------------------------------------------------------------------------------------------------------------------</span>
  <span class="n">endfunction</span> <span class="n">VTK_VAR_XML_LIST_3DA_I4</span>

  <span class="c">!&gt; Function for saving field of list variable (I2P, 1D array).</span>
  <span class="c">!&gt; @return E_IO: integer(I4P) error flag</span>
  <span class="k">function </span><span class="n">VTK_VAR_XML_LIST_1DA_I2</span><span class="p">(</span><span class="n">NC_NN</span><span class="p">,</span><span class="n">N_COL</span><span class="p">,</span><span class="n">varname</span><span class="p">,</span><span class="n">var</span><span class="p">,</span><span class="n">cf</span><span class="p">)</span> <span class="k">result</span><span class="p">(</span><span class="n">E_IO</span><span class="p">)</span>
  <span class="c">!---------------------------------------------------------------------------------------------------------------------------------</span>
  <span class="k">implicit none</span>
<span class="k">  </span><span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span><span class="kd">::</span>           <span class="n">NC_NN</span>      <span class="c">!&lt; Number of cells or nodes.</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span><span class="kd">::</span>           <span class="n">N_COL</span>      <span class="c">!&lt; Number of columns.</span>
  <span class="kt">character</span><span class="p">(</span><span class="o">*</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span><span class="kd">::</span>           <span class="n">varname</span>    <span class="c">!&lt; Variable name.</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I2P</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span><span class="kd">::</span>           <span class="n">var</span><span class="p">(</span><span class="mi">1</span><span class="p">:,</span><span class="mi">1</span><span class="p">:)</span> <span class="c">!&lt; Components [1:N_COL,1:NC_NN].</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">),</span> <span class="k">optional</span><span class="kd">::</span> <span class="n">cf</span>         <span class="c">!&lt; Current file index (for concurrent files IO).</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">)</span><span class="kd">::</span>                       <span class="n">E_IO</span>       <span class="c">!&lt; Input/Output inquiring flag: $0$ if IO is done, $&gt; 0$ if IO is not done.</span>
  <span class="kt">character</span><span class="p">(</span><span class="nb">len</span><span class="o">=</span><span class="n">maxlen</span><span class="p">)</span><span class="kd">::</span>              <span class="n">s_buffer</span>   <span class="c">!&lt; Buffer string.</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I1P</span><span class="p">),</span> <span class="k">allocatable</span><span class="kd">::</span>          <span class="n">varp</span><span class="p">(:)</span>    <span class="c">!&lt; Packed data.</span>
  <span class="kt">character</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="k">allocatable</span><span class="kd">::</span>          <span class="n">var64</span><span class="p">(:)</span>   <span class="c">!&lt; Variable encoded in base64.</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">)</span><span class="kd">::</span>                       <span class="n">rf</span>         <span class="c">!&lt; Real file index.</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">)</span><span class="kd">::</span>                       <span class="n">n1</span><span class="p">,</span><span class="n">n2</span>      <span class="c">!&lt; Counters.</span>
  <span class="c">!---------------------------------------------------------------------------------------------------------------------------------</span>

  <span class="c">!---------------------------------------------------------------------------------------------------------------------------------</span>
  <span class="n">E_IO</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1_I4P</span>
  <span class="n">rf</span> <span class="o">=</span> <span class="n">f</span>
  <span class="k">if</span> <span class="p">(</span><span class="nb">present</span><span class="p">(</span><span class="n">cf</span><span class="p">))</span> <span class="k">then</span>
<span class="k">    </span><span class="n">rf</span> <span class="o">=</span> <span class="n">cf</span> <span class="p">;</span> <span class="n">f</span> <span class="o">=</span> <span class="n">cf</span>
  <span class="n">endif</span>
  <span class="k">select case</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">f</span><span class="p">)</span>
  <span class="k">case</span><span class="p">(</span><span class="n">ascii</span><span class="p">)</span>
    <span class="n">s_buffer</span> <span class="o">=</span> <span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;DataArray type=&quot;Int16&quot; Name=&quot;&#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">varname</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&quot; NumberOfComponents=&quot;&#39;</span><span class="o">//</span> <span class="p">&amp;</span>
               <span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(.</span><span class="n">true</span><span class="p">.,</span><span class="n">N_COL</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39;&quot; format=&quot;ascii&quot;&gt;&#39;</span>
    <span class="k">write</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="s1">&#39;(A)&#39;</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">trim</span><span class="p">(</span><span class="n">s_buffer</span><span class="p">)</span>
    <span class="k">do </span><span class="n">n2</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">NC_NN</span>
      <span class="k">write</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="s1">&#39;(&#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(.</span><span class="n">true</span><span class="p">.,</span><span class="n">N_COL</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39;A)&#39;</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">),&amp;</span>
                                                                       <span class="p">(</span><span class="s1">&#39; &#39;</span><span class="o">//</span><span class="n">str</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">var</span><span class="p">(</span><span class="n">n1</span><span class="p">,</span><span class="n">n2</span><span class="p">)),</span><span class="n">n1</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">N_COL</span><span class="p">)</span>
    <span class="n">enddo</span>
    <span class="k">write</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="s1">&#39;(A)&#39;</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;/DataArray&gt;&#39;</span>
  <span class="k">case</span><span class="p">(</span><span class="n">raw</span><span class="p">,</span><span class="n">bin_app</span><span class="p">)</span>
    <span class="n">s_buffer</span> <span class="o">=</span> <span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;DataArray type=&quot;Int16&quot; Name=&quot;&#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">varname</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&quot; NumberOfComponents=&quot;&#39;</span><span class="o">//</span> <span class="p">&amp;</span>
               <span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(.</span><span class="n">true</span><span class="p">.,</span><span class="n">N_COL</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39;&quot; format=&quot;appended&quot; offset=&quot;&#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(.</span><span class="n">true</span><span class="p">.,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">ioffset</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39;&quot;/&gt;&#39;</span>
    <span class="k">write</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">trim</span><span class="p">(</span><span class="n">s_buffer</span><span class="p">)</span><span class="o">//</span><span class="n">end_rec</span>
    <span class="k">call </span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">byte_update</span><span class="p">(</span><span class="n">N_Byte</span> <span class="o">=</span> <span class="n">N_COL</span><span class="o">*</span><span class="n">NC_NN</span><span class="o">*</span><span class="n">BYI2P</span><span class="p">)</span>
    <span class="k">write</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">ua</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">N_Byte</span><span class="p">,</span><span class="s1">&#39;I2&#39;</span><span class="p">,</span><span class="n">N_COL</span><span class="o">*</span><span class="n">NC_NN</span>
    <span class="k">write</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">ua</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="n">var</span>
  <span class="k">case</span><span class="p">(</span><span class="n">binary</span><span class="p">)</span>
    <span class="n">s_buffer</span> <span class="o">=</span> <span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;DataArray type=&quot;Int16&quot; Name=&quot;&#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">varname</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&quot; NumberOfComponents=&quot;&#39;</span><span class="o">//</span> <span class="p">&amp;</span>
               <span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(.</span><span class="n">true</span><span class="p">.,</span><span class="n">N_COL</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39;&quot; format=&quot;binary&quot;&gt;&#39;</span>
    <span class="k">write</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">trim</span><span class="p">(</span><span class="n">s_buffer</span><span class="p">)</span><span class="o">//</span><span class="n">end_rec</span>
    <span class="k">call </span><span class="n">pack_data</span><span class="p">(</span><span class="n">a1</span><span class="o">=</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">N_COL</span><span class="o">*</span><span class="n">NC_NN</span><span class="o">*</span><span class="n">BYI2P</span><span class="p">,</span><span class="n">I4P</span><span class="p">)],</span><span class="n">a2</span><span class="o">=</span><span class="nb">reshape</span><span class="p">(</span><span class="n">var</span><span class="p">,[</span><span class="n">N_COL</span><span class="o">*</span><span class="n">NC_NN</span><span class="p">]),</span><span class="n">packed</span><span class="o">=</span><span class="n">varp</span><span class="p">)</span>
    <span class="k">call </span><span class="n">b64_encode</span><span class="p">(</span><span class="n">nB</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">BYI1P</span><span class="p">,</span><span class="n">I4P</span><span class="p">),</span><span class="n">n</span><span class="o">=</span><span class="n">varp</span><span class="p">,</span><span class="n">code</span><span class="o">=</span><span class="n">var64</span><span class="p">)</span> <span class="p">;</span> <span class="k">deallocate</span><span class="p">(</span><span class="n">varp</span><span class="p">)</span>
    <span class="k">write</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="o">+</span><span class="mi">2</span><span class="p">)</span><span class="o">//</span><span class="n">tochar</span><span class="p">(</span><span class="n">var64</span><span class="p">)</span><span class="o">//</span><span class="n">end_rec</span> <span class="p">;</span> <span class="k">deallocate</span><span class="p">(</span><span class="n">var64</span><span class="p">)</span>
    <span class="k">write</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;/DataArray&gt;&#39;</span><span class="o">//</span><span class="n">end_rec</span>
  <span class="n">endselect</span>
  <span class="k">return</span>
  <span class="c">!---------------------------------------------------------------------------------------------------------------------------------</span>
  <span class="n">endfunction</span> <span class="n">VTK_VAR_XML_LIST_1DA_I2</span>

  <span class="c">!&gt; Function for saving field of list variable (I2P, 3D array).</span>
  <span class="c">!&gt; @return E_IO: integer(I4P) error flag</span>
  <span class="k">function </span><span class="n">VTK_VAR_XML_LIST_3DA_I2</span><span class="p">(</span><span class="n">NC_NN</span><span class="p">,</span><span class="n">N_COL</span><span class="p">,</span><span class="n">varname</span><span class="p">,</span><span class="n">var</span><span class="p">,</span><span class="n">cf</span><span class="p">)</span> <span class="k">result</span><span class="p">(</span><span class="n">E_IO</span><span class="p">)</span>
  <span class="c">!---------------------------------------------------------------------------------------------------------------------------------</span>
  <span class="k">implicit none</span>
<span class="k">  </span><span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span><span class="kd">::</span>           <span class="n">NC_NN</span>            <span class="c">!&lt; Number of cells or nodes.</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span><span class="kd">::</span>           <span class="n">N_COL</span>            <span class="c">!&lt; Number of columns.</span>
  <span class="kt">character</span><span class="p">(</span><span class="o">*</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span><span class="kd">::</span>           <span class="n">varname</span>          <span class="c">!&lt; Variable name.</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I2P</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span><span class="kd">::</span>           <span class="n">var</span><span class="p">(</span><span class="mi">1</span><span class="p">:,</span><span class="mi">1</span><span class="p">:,</span><span class="mi">1</span><span class="p">:,</span><span class="mi">1</span><span class="p">:)</span> <span class="c">!&lt; Components [1:N_COL,1:Nx,1:Ny,1:Nz].</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">),</span> <span class="k">optional</span><span class="kd">::</span> <span class="n">cf</span>               <span class="c">!&lt; Current file index (for concurrent files IO).</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">)</span><span class="kd">::</span>                       <span class="n">E_IO</span>             <span class="c">!&lt; Input/Output inquiring flag: $0$ if IO is done, $&gt; 0$ if IO is not done.</span>
  <span class="kt">character</span><span class="p">(</span><span class="nb">len</span><span class="o">=</span><span class="n">maxlen</span><span class="p">)</span><span class="kd">::</span>              <span class="n">s_buffer</span>         <span class="c">!&lt; Buffer string.</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I1P</span><span class="p">),</span> <span class="k">allocatable</span><span class="kd">::</span>          <span class="n">varp</span><span class="p">(:)</span>          <span class="c">!&lt; Packed data.</span>
  <span class="kt">character</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="k">allocatable</span><span class="kd">::</span>          <span class="n">var64</span><span class="p">(:)</span>         <span class="c">!&lt; Variable encoded in base64.</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">)</span><span class="kd">::</span>                       <span class="n">rf</span>               <span class="c">!&lt; Real file index.</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">)</span><span class="kd">::</span>                       <span class="n">nx</span><span class="p">,</span><span class="n">ny</span><span class="p">,</span><span class="n">nz</span><span class="p">,</span><span class="n">n1</span>      <span class="c">!&lt; Counters.</span>
  <span class="c">!---------------------------------------------------------------------------------------------------------------------------------</span>

  <span class="c">!---------------------------------------------------------------------------------------------------------------------------------</span>
  <span class="n">E_IO</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1_I4P</span>
  <span class="n">rf</span> <span class="o">=</span> <span class="n">f</span>
  <span class="k">if</span> <span class="p">(</span><span class="nb">present</span><span class="p">(</span><span class="n">cf</span><span class="p">))</span> <span class="k">then</span>
<span class="k">    </span><span class="n">rf</span> <span class="o">=</span> <span class="n">cf</span> <span class="p">;</span> <span class="n">f</span> <span class="o">=</span> <span class="n">cf</span>
  <span class="n">endif</span>
  <span class="k">select case</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">f</span><span class="p">)</span>
  <span class="k">case</span><span class="p">(</span><span class="n">ascii</span><span class="p">)</span>
    <span class="n">s_buffer</span> <span class="o">=</span> <span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;DataArray type=&quot;Int16&quot; Name=&quot;&#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">varname</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&quot; NumberOfComponents=&quot;&#39;</span><span class="o">//</span> <span class="p">&amp;</span>
               <span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(.</span><span class="n">true</span><span class="p">.,</span><span class="n">N_COL</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39;&quot; format=&quot;ascii&quot;&gt;&#39;</span>
    <span class="k">write</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="s1">&#39;(A)&#39;</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">trim</span><span class="p">(</span><span class="n">s_buffer</span><span class="p">)</span>
    <span class="k">do </span><span class="n">nz</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">size</span><span class="p">(</span><span class="n">var</span><span class="p">,</span><span class="nb">dim</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span> <span class="p">;</span> <span class="k">do </span><span class="n">ny</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">size</span><span class="p">(</span><span class="n">var</span><span class="p">,</span><span class="nb">dim</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span> <span class="p">;</span> <span class="k">do </span><span class="n">nx</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">size</span><span class="p">(</span><span class="n">var</span><span class="p">,</span><span class="nb">dim</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
      <span class="k">write</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="s1">&#39;(&#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(.</span><span class="n">true</span><span class="p">.,</span><span class="n">N_COL</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39;A)&#39;</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">),&amp;</span>
                                                                       <span class="p">(</span><span class="s1">&#39; &#39;</span><span class="o">//</span><span class="n">str</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">var</span><span class="p">(</span><span class="n">n1</span><span class="p">,</span><span class="n">nx</span><span class="p">,</span><span class="n">ny</span><span class="p">,</span><span class="n">nz</span><span class="p">)),</span><span class="n">n1</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">N_COL</span><span class="p">)</span>
    <span class="n">enddo</span> <span class="p">;</span> <span class="n">enddo</span> <span class="p">;</span> <span class="n">enddo</span>
    <span class="k">write</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="s1">&#39;(A)&#39;</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;/DataArray&gt;&#39;</span>
  <span class="k">case</span><span class="p">(</span><span class="n">raw</span><span class="p">,</span><span class="n">bin_app</span><span class="p">)</span>
    <span class="n">s_buffer</span> <span class="o">=</span> <span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;DataArray type=&quot;Int16&quot; Name=&quot;&#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">varname</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&quot; NumberOfComponents=&quot;&#39;</span><span class="o">//</span> <span class="p">&amp;</span>
               <span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(.</span><span class="n">true</span><span class="p">.,</span><span class="n">N_COL</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39;&quot; format=&quot;appended&quot; offset=&quot;&#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(.</span><span class="n">true</span><span class="p">.,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">ioffset</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39;&quot;/&gt;&#39;</span>
    <span class="k">write</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">trim</span><span class="p">(</span><span class="n">s_buffer</span><span class="p">)</span><span class="o">//</span><span class="n">end_rec</span>
    <span class="k">call </span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">byte_update</span><span class="p">(</span><span class="n">N_Byte</span> <span class="o">=</span> <span class="n">N_COL</span><span class="o">*</span><span class="n">NC_NN</span><span class="o">*</span><span class="n">BYI2P</span><span class="p">)</span>
    <span class="k">write</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">ua</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">N_Byte</span><span class="p">,</span><span class="s1">&#39;I2&#39;</span><span class="p">,</span><span class="n">N_COL</span><span class="o">*</span><span class="n">NC_NN</span>
    <span class="k">write</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">ua</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="n">var</span>
  <span class="k">case</span><span class="p">(</span><span class="n">binary</span><span class="p">)</span>
    <span class="n">s_buffer</span> <span class="o">=</span> <span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;DataArray type=&quot;Int16&quot; Name=&quot;&#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">varname</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&quot; NumberOfComponents=&quot;&#39;</span><span class="o">//</span> <span class="p">&amp;</span>
               <span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(.</span><span class="n">true</span><span class="p">.,</span><span class="n">N_COL</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39;&quot; format=&quot;binary&quot;&gt;&#39;</span>
    <span class="k">write</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">trim</span><span class="p">(</span><span class="n">s_buffer</span><span class="p">)</span><span class="o">//</span><span class="n">end_rec</span>
    <span class="k">call </span><span class="n">pack_data</span><span class="p">(</span><span class="n">a1</span><span class="o">=</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">N_COL</span><span class="o">*</span><span class="n">NC_NN</span><span class="o">*</span><span class="n">BYI2P</span><span class="p">,</span><span class="n">I4P</span><span class="p">)],</span><span class="n">a2</span><span class="o">=</span><span class="nb">reshape</span><span class="p">(</span><span class="n">var</span><span class="p">,[</span><span class="n">N_COL</span><span class="o">*</span><span class="n">NC_NN</span><span class="p">]),</span><span class="n">packed</span><span class="o">=</span><span class="n">varp</span><span class="p">)</span>
    <span class="k">call </span><span class="n">b64_encode</span><span class="p">(</span><span class="n">nB</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">BYI1P</span><span class="p">,</span><span class="n">I4P</span><span class="p">),</span><span class="n">n</span><span class="o">=</span><span class="n">varp</span><span class="p">,</span><span class="n">code</span><span class="o">=</span><span class="n">var64</span><span class="p">)</span> <span class="p">;</span> <span class="k">deallocate</span><span class="p">(</span><span class="n">varp</span><span class="p">)</span>
    <span class="k">write</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="o">+</span><span class="mi">2</span><span class="p">)</span><span class="o">//</span><span class="n">tochar</span><span class="p">(</span><span class="n">var64</span><span class="p">)</span><span class="o">//</span><span class="n">end_rec</span> <span class="p">;</span> <span class="k">deallocate</span><span class="p">(</span><span class="n">var64</span><span class="p">)</span>
    <span class="k">write</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;/DataArray&gt;&#39;</span><span class="o">//</span><span class="n">end_rec</span>
  <span class="n">endselect</span>
  <span class="k">return</span>
  <span class="c">!---------------------------------------------------------------------------------------------------------------------------------</span>
  <span class="n">endfunction</span> <span class="n">VTK_VAR_XML_LIST_3DA_I2</span>

  <span class="c">!&gt; Function for saving field of list variable (I1P, 1D array).</span>
  <span class="c">!&gt; @return E_IO: integer(I4P) error flag</span>
  <span class="k">function </span><span class="n">VTK_VAR_XML_LIST_1DA_I1</span><span class="p">(</span><span class="n">NC_NN</span><span class="p">,</span><span class="n">N_COL</span><span class="p">,</span><span class="n">varname</span><span class="p">,</span><span class="n">var</span><span class="p">,</span><span class="n">cf</span><span class="p">)</span> <span class="k">result</span><span class="p">(</span><span class="n">E_IO</span><span class="p">)</span>
  <span class="c">!---------------------------------------------------------------------------------------------------------------------------------</span>
  <span class="k">implicit none</span>
<span class="k">  </span><span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span><span class="kd">::</span>           <span class="n">NC_NN</span>      <span class="c">!&lt; Number of cells or nodes.</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span><span class="kd">::</span>           <span class="n">N_COL</span>      <span class="c">!&lt; Number of columns.</span>
  <span class="kt">character</span><span class="p">(</span><span class="o">*</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span><span class="kd">::</span>           <span class="n">varname</span>    <span class="c">!&lt; Variable name.</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I1P</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span><span class="kd">::</span>           <span class="n">var</span><span class="p">(</span><span class="mi">1</span><span class="p">:,</span><span class="mi">1</span><span class="p">:)</span> <span class="c">!&lt; Components [1:N_COL,1:NC_NN].</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">),</span> <span class="k">optional</span><span class="kd">::</span> <span class="n">cf</span>         <span class="c">!&lt; Current file index (for concurrent files IO).</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">)</span><span class="kd">::</span>                       <span class="n">E_IO</span>       <span class="c">!&lt; Input/Output inquiring flag: $0$ if IO is done, $&gt; 0$ if IO is not done.</span>
  <span class="kt">character</span><span class="p">(</span><span class="nb">len</span><span class="o">=</span><span class="n">maxlen</span><span class="p">)</span><span class="kd">::</span>              <span class="n">s_buffer</span>   <span class="c">!&lt; Buffer string.</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I1P</span><span class="p">),</span> <span class="k">allocatable</span><span class="kd">::</span>          <span class="n">varp</span><span class="p">(:)</span>    <span class="c">!&lt; Packed data.</span>
  <span class="kt">character</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="k">allocatable</span><span class="kd">::</span>          <span class="n">var64</span><span class="p">(:)</span>   <span class="c">!&lt; Variable encoded in base64.</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">)</span><span class="kd">::</span>                       <span class="n">rf</span>         <span class="c">!&lt; Real file index.</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">)</span><span class="kd">::</span>                       <span class="n">n1</span><span class="p">,</span><span class="n">n2</span>      <span class="c">!&lt; Counters.</span>
  <span class="c">!---------------------------------------------------------------------------------------------------------------------------------</span>

  <span class="c">!---------------------------------------------------------------------------------------------------------------------------------</span>
  <span class="n">E_IO</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1_I4P</span>
  <span class="n">rf</span> <span class="o">=</span> <span class="n">f</span>
  <span class="k">if</span> <span class="p">(</span><span class="nb">present</span><span class="p">(</span><span class="n">cf</span><span class="p">))</span> <span class="k">then</span>
<span class="k">    </span><span class="n">rf</span> <span class="o">=</span> <span class="n">cf</span> <span class="p">;</span> <span class="n">f</span> <span class="o">=</span> <span class="n">cf</span>
  <span class="n">endif</span>
  <span class="k">select case</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">f</span><span class="p">)</span>
  <span class="k">case</span><span class="p">(</span><span class="n">ascii</span><span class="p">)</span>
    <span class="n">s_buffer</span> <span class="o">=</span> <span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;DataArray type=&quot;Int8&quot; Name=&quot;&#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">varname</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&quot; NumberOfComponents=&quot;&#39;</span><span class="o">//</span> <span class="p">&amp;</span>
               <span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(.</span><span class="n">true</span><span class="p">.,</span><span class="n">N_COL</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39;&quot; format=&quot;ascii&quot;&gt;&#39;</span>
    <span class="k">write</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="s1">&#39;(A)&#39;</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">trim</span><span class="p">(</span><span class="n">s_buffer</span><span class="p">)</span>
    <span class="k">do </span><span class="n">n2</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">NC_NN</span>
      <span class="k">write</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="s1">&#39;(&#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(.</span><span class="n">true</span><span class="p">.,</span><span class="n">N_COL</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39;A)&#39;</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">),&amp;</span>
                                                                       <span class="p">(</span><span class="s1">&#39; &#39;</span><span class="o">//</span><span class="n">str</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">var</span><span class="p">(</span><span class="n">n1</span><span class="p">,</span><span class="n">n2</span><span class="p">)),</span><span class="n">n1</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">N_COL</span><span class="p">)</span>
    <span class="n">enddo</span>
    <span class="k">write</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="s1">&#39;(A)&#39;</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;/DataArray&gt;&#39;</span>
  <span class="k">case</span><span class="p">(</span><span class="n">raw</span><span class="p">,</span><span class="n">bin_app</span><span class="p">)</span>
    <span class="n">s_buffer</span> <span class="o">=</span> <span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;DataArray type=&quot;Int8&quot; Name=&quot;&#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">varname</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&quot; NumberOfComponents=&quot;&#39;</span><span class="o">//</span> <span class="p">&amp;</span>
               <span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(.</span><span class="n">true</span><span class="p">.,</span><span class="n">N_COL</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39;&quot; format=&quot;appended&quot; offset=&quot;&#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(.</span><span class="n">true</span><span class="p">.,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">ioffset</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39;&quot;/&gt;&#39;</span>
    <span class="k">write</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">trim</span><span class="p">(</span><span class="n">s_buffer</span><span class="p">)</span><span class="o">//</span><span class="n">end_rec</span>
    <span class="k">call </span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">byte_update</span><span class="p">(</span><span class="n">N_Byte</span> <span class="o">=</span> <span class="n">N_COL</span><span class="o">*</span><span class="n">NC_NN</span><span class="o">*</span><span class="n">BYI1P</span><span class="p">)</span>
    <span class="k">write</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">ua</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">N_Byte</span><span class="p">,</span><span class="s1">&#39;I1&#39;</span><span class="p">,</span><span class="n">N_COL</span><span class="o">*</span><span class="n">NC_NN</span>
    <span class="k">write</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">ua</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="n">var</span>
  <span class="k">case</span><span class="p">(</span><span class="n">binary</span><span class="p">)</span>
    <span class="n">s_buffer</span> <span class="o">=</span> <span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;DataArray type=&quot;Int8&quot; Name=&quot;&#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">varname</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&quot; NumberOfComponents=&quot;&#39;</span><span class="o">//</span> <span class="p">&amp;</span>
               <span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(.</span><span class="n">true</span><span class="p">.,</span><span class="n">N_COL</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39;&quot; format=&quot;binary&quot;&gt;&#39;</span>
    <span class="k">write</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">trim</span><span class="p">(</span><span class="n">s_buffer</span><span class="p">)</span><span class="o">//</span><span class="n">end_rec</span>
    <span class="k">call </span><span class="n">pack_data</span><span class="p">(</span><span class="n">a1</span><span class="o">=</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">N_COL</span><span class="o">*</span><span class="n">NC_NN</span><span class="o">*</span><span class="n">BYI1P</span><span class="p">,</span><span class="n">I4P</span><span class="p">)],</span><span class="n">a2</span><span class="o">=</span><span class="nb">reshape</span><span class="p">(</span><span class="n">var</span><span class="p">,[</span><span class="n">N_COL</span><span class="o">*</span><span class="n">NC_NN</span><span class="p">]),</span><span class="n">packed</span><span class="o">=</span><span class="n">varp</span><span class="p">)</span>
    <span class="k">call </span><span class="n">b64_encode</span><span class="p">(</span><span class="n">nB</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">BYI1P</span><span class="p">,</span><span class="n">I4P</span><span class="p">),</span><span class="n">n</span><span class="o">=</span><span class="n">varp</span><span class="p">,</span><span class="n">code</span><span class="o">=</span><span class="n">var64</span><span class="p">)</span> <span class="p">;</span> <span class="k">deallocate</span><span class="p">(</span><span class="n">varp</span><span class="p">)</span>
    <span class="k">write</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="o">+</span><span class="mi">2</span><span class="p">)</span><span class="o">//</span><span class="n">tochar</span><span class="p">(</span><span class="n">var64</span><span class="p">)</span><span class="o">//</span><span class="n">end_rec</span> <span class="p">;</span> <span class="k">deallocate</span><span class="p">(</span><span class="n">var64</span><span class="p">)</span>
    <span class="k">write</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;/DataArray&gt;&#39;</span><span class="o">//</span><span class="n">end_rec</span>
  <span class="n">endselect</span>
  <span class="k">return</span>
  <span class="c">!---------------------------------------------------------------------------------------------------------------------------------</span>
  <span class="n">endfunction</span> <span class="n">VTK_VAR_XML_LIST_1DA_I1</span>

  <span class="c">!&gt; Function for saving field of list variable (I1P, 3D array).</span>
  <span class="c">!&gt; @return E_IO: integer(I4P) error flag</span>
  <span class="k">function </span><span class="n">VTK_VAR_XML_LIST_3DA_I1</span><span class="p">(</span><span class="n">NC_NN</span><span class="p">,</span><span class="n">N_COL</span><span class="p">,</span><span class="n">varname</span><span class="p">,</span><span class="n">var</span><span class="p">,</span><span class="n">cf</span><span class="p">)</span> <span class="k">result</span><span class="p">(</span><span class="n">E_IO</span><span class="p">)</span>
  <span class="c">!---------------------------------------------------------------------------------------------------------------------------------</span>
  <span class="k">implicit none</span>
<span class="k">  </span><span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span><span class="kd">::</span>           <span class="n">NC_NN</span>            <span class="c">!&lt; Number of cells or nodes.</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span><span class="kd">::</span>           <span class="n">N_COL</span>            <span class="c">!&lt; Number of columns.</span>
  <span class="kt">character</span><span class="p">(</span><span class="o">*</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span><span class="kd">::</span>           <span class="n">varname</span>          <span class="c">!&lt; Variable name.</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I1P</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span><span class="kd">::</span>           <span class="n">var</span><span class="p">(</span><span class="mi">1</span><span class="p">:,</span><span class="mi">1</span><span class="p">:,</span><span class="mi">1</span><span class="p">:,</span><span class="mi">1</span><span class="p">:)</span> <span class="c">!&lt; Components [1:N_COL,1:Nx,1:Ny,1:Nz].</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">),</span> <span class="k">optional</span><span class="kd">::</span> <span class="n">cf</span>               <span class="c">!&lt; Current file index (for concurrent files IO).</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">)</span><span class="kd">::</span>                       <span class="n">E_IO</span>             <span class="c">!&lt; Input/Output inquiring flag: $0$ if IO is done, $&gt; 0$ if IO is not done.</span>
  <span class="kt">character</span><span class="p">(</span><span class="nb">len</span><span class="o">=</span><span class="n">maxlen</span><span class="p">)</span><span class="kd">::</span>              <span class="n">s_buffer</span>         <span class="c">!&lt; Buffer string.</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I1P</span><span class="p">),</span> <span class="k">allocatable</span><span class="kd">::</span>          <span class="n">varp</span><span class="p">(:)</span>          <span class="c">!&lt; Packed data.</span>
  <span class="kt">character</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="k">allocatable</span><span class="kd">::</span>          <span class="n">var64</span><span class="p">(:)</span>         <span class="c">!&lt; Variable encoded in base64.</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">)</span><span class="kd">::</span>                       <span class="n">rf</span>               <span class="c">!&lt; Real file index.</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">)</span><span class="kd">::</span>                       <span class="n">nx</span><span class="p">,</span><span class="n">ny</span><span class="p">,</span><span class="n">nz</span><span class="p">,</span><span class="n">n1</span>      <span class="c">!&lt; Counters.</span>
  <span class="c">!---------------------------------------------------------------------------------------------------------------------------------</span>

  <span class="c">!---------------------------------------------------------------------------------------------------------------------------------</span>
  <span class="n">E_IO</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1_I4P</span>
  <span class="n">rf</span> <span class="o">=</span> <span class="n">f</span>
  <span class="k">if</span> <span class="p">(</span><span class="nb">present</span><span class="p">(</span><span class="n">cf</span><span class="p">))</span> <span class="k">then</span>
<span class="k">    </span><span class="n">rf</span> <span class="o">=</span> <span class="n">cf</span> <span class="p">;</span> <span class="n">f</span> <span class="o">=</span> <span class="n">cf</span>
  <span class="n">endif</span>
  <span class="k">select case</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">f</span><span class="p">)</span>
  <span class="k">case</span><span class="p">(</span><span class="n">ascii</span><span class="p">)</span>
    <span class="n">s_buffer</span> <span class="o">=</span> <span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;DataArray type=&quot;Int8&quot; Name=&quot;&#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">varname</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&quot; NumberOfComponents=&quot;&#39;</span><span class="o">//</span> <span class="p">&amp;</span>
               <span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(.</span><span class="n">true</span><span class="p">.,</span><span class="n">N_COL</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39;&quot; format=&quot;ascii&quot;&gt;&#39;</span>
    <span class="k">write</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="s1">&#39;(A)&#39;</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">trim</span><span class="p">(</span><span class="n">s_buffer</span><span class="p">)</span>
    <span class="k">do </span><span class="n">nz</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">size</span><span class="p">(</span><span class="n">var</span><span class="p">,</span><span class="nb">dim</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span> <span class="p">;</span> <span class="k">do </span><span class="n">ny</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">size</span><span class="p">(</span><span class="n">var</span><span class="p">,</span><span class="nb">dim</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span> <span class="p">;</span> <span class="k">do </span><span class="n">nx</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">size</span><span class="p">(</span><span class="n">var</span><span class="p">,</span><span class="nb">dim</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
      <span class="k">write</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="s1">&#39;(&#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(.</span><span class="n">true</span><span class="p">.,</span><span class="n">N_COL</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39;A)&#39;</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">),&amp;</span>
                                                                       <span class="p">(</span><span class="s1">&#39; &#39;</span><span class="o">//</span><span class="n">str</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">var</span><span class="p">(</span><span class="n">n1</span><span class="p">,</span><span class="n">nx</span><span class="p">,</span><span class="n">ny</span><span class="p">,</span><span class="n">nz</span><span class="p">)),</span><span class="n">n1</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">N_COL</span><span class="p">)</span>
    <span class="n">enddo</span> <span class="p">;</span> <span class="n">enddo</span> <span class="p">;</span> <span class="n">enddo</span>
    <span class="k">write</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="s1">&#39;(A)&#39;</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;/DataArray&gt;&#39;</span>
  <span class="k">case</span><span class="p">(</span><span class="n">raw</span><span class="p">,</span><span class="n">bin_app</span><span class="p">)</span>
    <span class="n">s_buffer</span> <span class="o">=</span> <span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;DataArray type=&quot;Int8&quot; Name=&quot;&#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">varname</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&quot; NumberOfComponents=&quot;&#39;</span><span class="o">//</span> <span class="p">&amp;</span>
               <span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(.</span><span class="n">true</span><span class="p">.,</span><span class="n">N_COL</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39;&quot; format=&quot;appended&quot; offset=&quot;&#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(.</span><span class="n">true</span><span class="p">.,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">ioffset</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39;&quot;/&gt;&#39;</span>
    <span class="k">write</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">trim</span><span class="p">(</span><span class="n">s_buffer</span><span class="p">)</span><span class="o">//</span><span class="n">end_rec</span>
    <span class="k">call </span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">byte_update</span><span class="p">(</span><span class="n">N_Byte</span> <span class="o">=</span> <span class="n">N_COL</span><span class="o">*</span><span class="n">NC_NN</span><span class="o">*</span><span class="n">BYI1P</span><span class="p">)</span>
    <span class="k">write</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">ua</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">N_Byte</span><span class="p">,</span><span class="s1">&#39;I1&#39;</span><span class="p">,</span><span class="n">N_COL</span><span class="o">*</span><span class="n">NC_NN</span>
    <span class="k">write</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">ua</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="n">var</span>
  <span class="k">case</span><span class="p">(</span><span class="n">binary</span><span class="p">)</span>
    <span class="n">s_buffer</span> <span class="o">=</span> <span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;DataArray type=&quot;Int8&quot; Name=&quot;&#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">varname</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&quot; NumberOfComponents=&quot;&#39;</span><span class="o">//</span> <span class="p">&amp;</span>
               <span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(.</span><span class="n">true</span><span class="p">.,</span><span class="n">N_COL</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39;&quot; format=&quot;binary&quot;&gt;&#39;</span>
    <span class="k">write</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">trim</span><span class="p">(</span><span class="n">s_buffer</span><span class="p">)</span><span class="o">//</span><span class="n">end_rec</span>
    <span class="k">call </span><span class="n">pack_data</span><span class="p">(</span><span class="n">a1</span><span class="o">=</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">N_COL</span><span class="o">*</span><span class="n">NC_NN</span><span class="o">*</span><span class="n">BYI1P</span><span class="p">,</span><span class="n">I4P</span><span class="p">)],</span><span class="n">a2</span><span class="o">=</span><span class="nb">reshape</span><span class="p">(</span><span class="n">var</span><span class="p">,[</span><span class="n">N_COL</span><span class="o">*</span><span class="n">NC_NN</span><span class="p">]),</span><span class="n">packed</span><span class="o">=</span><span class="n">varp</span><span class="p">)</span>
    <span class="k">call </span><span class="n">b64_encode</span><span class="p">(</span><span class="n">nB</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">BYI1P</span><span class="p">,</span><span class="n">I4P</span><span class="p">),</span><span class="n">n</span><span class="o">=</span><span class="n">varp</span><span class="p">,</span><span class="n">code</span><span class="o">=</span><span class="n">var64</span><span class="p">)</span> <span class="p">;</span> <span class="k">deallocate</span><span class="p">(</span><span class="n">varp</span><span class="p">)</span>
    <span class="k">write</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="o">+</span><span class="mi">2</span><span class="p">)</span><span class="o">//</span><span class="n">tochar</span><span class="p">(</span><span class="n">var64</span><span class="p">)</span><span class="o">//</span><span class="n">end_rec</span> <span class="p">;</span> <span class="k">deallocate</span><span class="p">(</span><span class="n">var64</span><span class="p">)</span>
    <span class="k">write</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;/DataArray&gt;&#39;</span><span class="o">//</span><span class="n">end_rec</span>
  <span class="n">endselect</span>
  <span class="k">return</span>
  <span class="c">!---------------------------------------------------------------------------------------------------------------------------------</span>
  <span class="n">endfunction</span> <span class="n">VTK_VAR_XML_LIST_3DA_I1</span>
  <span class="c">!&gt; @}</span>

  <span class="c">!&gt; @brief Function for finalizing the VTK-XML file.</span>
  <span class="c">!&gt; @note An example of usage is: \n</span>
  <span class="c">!&gt; @code ...</span>
  <span class="c">!&gt; E_IO = VTK_END_XML()</span>
  <span class="c">!&gt; ... @endcode</span>
  <span class="c">!&gt; @return E_IO: integer(I4P) error flag</span>
  <span class="c">!&gt; @ingroup Lib_VTK_IOPublicProcedure</span>
  <span class="k">function </span><span class="n">VTK_END_XML</span><span class="p">(</span><span class="n">cf</span><span class="p">)</span> <span class="k">result</span><span class="p">(</span><span class="n">E_IO</span><span class="p">)</span>
  <span class="c">!---------------------------------------------------------------------------------------------------------------------------------</span>
  <span class="k">implicit none</span>
<span class="k">  </span><span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">INOUT</span><span class="p">),</span> <span class="k">optional</span><span class="kd">::</span> <span class="n">cf</span>       <span class="c">!&lt; Current file index (for concurrent files IO).</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">)</span><span class="kd">::</span>                          <span class="n">E_IO</span>     <span class="c">!&lt; Input/Output inquiring flag: $0$ if IO is done, $&gt; 0$ if IO is not done.</span>
  <span class="kt">character</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="kd">::</span>                          <span class="n">var_type</span> <span class="c">!&lt; Varable type = R8,R4,I8,I4,I2,I1.</span>
  <span class="kt">real</span><span class="p">(</span><span class="n">R8P</span><span class="p">),</span>    <span class="k">allocatable</span><span class="kd">::</span>             <span class="n">v_R8</span><span class="p">(:)</span>  <span class="c">!&lt; R8 vector for IO in AppendData.</span>
  <span class="kt">real</span><span class="p">(</span><span class="n">R4P</span><span class="p">),</span>    <span class="k">allocatable</span><span class="kd">::</span>             <span class="n">v_R4</span><span class="p">(:)</span>  <span class="c">!&lt; R4 vector for IO in AppendData.</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I8P</span><span class="p">),</span> <span class="k">allocatable</span><span class="kd">::</span>             <span class="n">v_I8</span><span class="p">(:)</span>  <span class="c">!&lt; I8 vector for IO in AppendData.</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">),</span> <span class="k">allocatable</span><span class="kd">::</span>             <span class="n">v_I4</span><span class="p">(:)</span>  <span class="c">!&lt; I4 vector for IO in AppendData.</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I2P</span><span class="p">),</span> <span class="k">allocatable</span><span class="kd">::</span>             <span class="n">v_I2</span><span class="p">(:)</span>  <span class="c">!&lt; I2 vector for IO in AppendData.</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I1P</span><span class="p">),</span> <span class="k">allocatable</span><span class="kd">::</span>             <span class="n">v_I1</span><span class="p">(:)</span>  <span class="c">!&lt; I1 vector for IO in AppendData.</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I1P</span><span class="p">),</span> <span class="k">allocatable</span><span class="kd">::</span>             <span class="n">varp</span><span class="p">(:)</span>  <span class="c">!&lt; Packed data.</span>
  <span class="kt">character</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="k">allocatable</span><span class="kd">::</span>             <span class="n">var64</span><span class="p">(:)</span> <span class="c">!&lt; Variable encoded in base64.</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">)</span><span class="kd">::</span>                          <span class="n">rf</span>       <span class="c">!&lt; Real file index.</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I8P</span><span class="p">)</span><span class="kd">::</span>                          <span class="n">Nvarp</span>    <span class="c">!&lt; Dimension of varp, packed data.</span>
<span class="cp">#ifdef HUGE</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I8P</span><span class="p">)</span><span class="kd">::</span>                          <span class="n">N_v</span>      <span class="c">!&lt; Vector dimension.</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I8P</span><span class="p">)</span><span class="kd">::</span>                          <span class="n">n1</span>       <span class="c">!&lt; Counter.</span>
<span class="cp">#else</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">)</span><span class="kd">::</span>                          <span class="n">N_v</span>      <span class="c">!&lt; Vector dimension.</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">)</span><span class="kd">::</span>                          <span class="n">n1</span>       <span class="c">!&lt; Counter.</span>
<span class="cp">#endif</span>
  <span class="c">!---------------------------------------------------------------------------------------------------------------------------------</span>

  <span class="c">!---------------------------------------------------------------------------------------------------------------------------------</span>
  <span class="n">E_IO</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1_I4P</span>
  <span class="n">rf</span> <span class="o">=</span> <span class="n">f</span>
  <span class="k">if</span> <span class="p">(</span><span class="nb">present</span><span class="p">(</span><span class="n">cf</span><span class="p">))</span> <span class="k">then</span>
<span class="k">    </span><span class="n">rf</span> <span class="o">=</span> <span class="n">cf</span> <span class="p">;</span> <span class="n">f</span> <span class="o">=</span> <span class="n">cf</span>
  <span class="n">endif</span>
  <span class="k">select case</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">f</span><span class="p">)</span>
  <span class="k">case</span><span class="p">(</span><span class="n">ascii</span><span class="p">)</span>
    <span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span> <span class="o">=</span> <span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span> <span class="o">-</span> <span class="mi">2</span>
    <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;(A)&#39;</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;/&#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">topology</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&gt;&#39;</span>
    <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;(A)&#39;</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="s1">&#39;&lt;/VTKFile&gt;&#39;</span>
  <span class="k">case</span><span class="p">(</span><span class="n">raw</span><span class="p">,</span><span class="n">bin_app</span><span class="p">)</span>
    <span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span> <span class="o">=</span> <span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span> <span class="o">-</span> <span class="mi">2</span>
    <span class="k">write</span><span class="p">(</span><span class="n">unit</span>  <span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span> <span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;/&#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">topology</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&gt;&#39;</span><span class="o">//</span><span class="n">end_rec</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">f</span><span class="o">==</span><span class="n">raw</span><span class="p">)</span> <span class="k">then</span>
<span class="k">      write</span><span class="p">(</span><span class="n">unit</span>  <span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span> <span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;AppendedData encoding=&quot;raw&quot;&gt;&#39;</span><span class="o">//</span><span class="n">end_rec</span>
    <span class="k">else</span>
<span class="k">      write</span><span class="p">(</span><span class="n">unit</span>  <span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span> <span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;AppendedData encoding=&quot;base64&quot;&gt;&#39;</span><span class="o">//</span><span class="n">end_rec</span>
    <span class="n">endif</span>
    <span class="k">write</span><span class="p">(</span><span class="n">unit</span>  <span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span> <span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="s1">&#39;_&#39;</span>
    <span class="n">endfile</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">ua</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span>
    <span class="k">rewind</span><span class="p">(</span><span class="n">unit</span> <span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">ua</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span>
    <span class="k">do</span>
<span class="k">      read</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">ua</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">,</span><span class="k">end</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">N_Byte</span><span class="p">,</span><span class="n">var_type</span><span class="p">,</span><span class="n">N_v</span>
      <span class="k">select case</span><span class="p">(</span><span class="n">var_type</span><span class="p">)</span>
      <span class="k">case</span><span class="p">(</span><span class="s1">&#39;R8&#39;</span><span class="p">)</span>
        <span class="k">allocate</span><span class="p">(</span><span class="n">v_R8</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">N_v</span><span class="p">))</span>
        <span class="k">read</span><span class="p">(</span><span class="n">unit</span> <span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">ua</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)(</span><span class="n">v_R8</span><span class="p">(</span><span class="n">n1</span><span class="p">),</span><span class="n">n1</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">N_v</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">f</span><span class="o">==</span><span class="n">raw</span><span class="p">)</span> <span class="k">then</span>
<span class="k">          write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">int</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">N_Byte</span><span class="p">,</span><span class="n">I4P</span><span class="p">),(</span><span class="n">v_R8</span><span class="p">(</span><span class="n">n1</span><span class="p">),</span><span class="n">n1</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">N_v</span><span class="p">)</span>
        <span class="k">else</span>
<span class="k">          call </span><span class="n">pack_data</span><span class="p">(</span><span class="n">a1</span><span class="o">=</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">N_Byte</span><span class="p">,</span><span class="n">I4P</span><span class="p">)],</span><span class="n">a2</span><span class="o">=</span><span class="n">v_R8</span><span class="p">,</span><span class="n">packed</span><span class="o">=</span><span class="n">varp</span><span class="p">)</span>
          <span class="k">call </span><span class="n">b64_encode</span><span class="p">(</span><span class="n">nB</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">BYI1P</span><span class="p">,</span><span class="n">I4P</span><span class="p">),</span><span class="n">n</span><span class="o">=</span><span class="n">varp</span><span class="p">,</span><span class="n">code</span><span class="o">=</span><span class="n">var64</span><span class="p">)</span> <span class="p">;</span> <span class="k">deallocate</span><span class="p">(</span><span class="n">varp</span><span class="p">)</span>
          <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="n">tochar</span><span class="p">(</span><span class="n">var64</span><span class="p">)</span> <span class="p">;</span> <span class="k">deallocate</span><span class="p">(</span><span class="n">var64</span><span class="p">)</span>
        <span class="n">endif</span>
        <span class="k">deallocate</span><span class="p">(</span><span class="n">v_R8</span><span class="p">)</span>
      <span class="k">case</span><span class="p">(</span><span class="s1">&#39;R4&#39;</span><span class="p">)</span>
        <span class="k">allocate</span><span class="p">(</span><span class="n">v_R4</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">N_v</span><span class="p">))</span>
        <span class="k">read</span><span class="p">(</span><span class="n">unit</span> <span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">ua</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)(</span><span class="n">v_R4</span><span class="p">(</span><span class="n">n1</span><span class="p">),</span><span class="n">n1</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">N_v</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">f</span><span class="o">==</span><span class="n">raw</span><span class="p">)</span> <span class="k">then</span>
<span class="k">          write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">int</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">N_Byte</span><span class="p">,</span><span class="n">I4P</span><span class="p">),(</span><span class="n">v_R4</span><span class="p">(</span><span class="n">n1</span><span class="p">),</span><span class="n">n1</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">N_v</span><span class="p">)</span>
        <span class="k">else</span>
<span class="k">          call </span><span class="n">pack_data</span><span class="p">(</span><span class="n">a1</span><span class="o">=</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">N_Byte</span><span class="p">,</span><span class="n">I4P</span><span class="p">)],</span><span class="n">a2</span><span class="o">=</span><span class="n">v_R4</span><span class="p">,</span><span class="n">packed</span><span class="o">=</span><span class="n">varp</span><span class="p">)</span>
          <span class="k">call </span><span class="n">b64_encode</span><span class="p">(</span><span class="n">nB</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">BYI1P</span><span class="p">,</span><span class="n">I4P</span><span class="p">),</span><span class="n">n</span><span class="o">=</span><span class="n">varp</span><span class="p">,</span><span class="n">code</span><span class="o">=</span><span class="n">var64</span><span class="p">)</span> <span class="p">;</span> <span class="k">deallocate</span><span class="p">(</span><span class="n">varp</span><span class="p">)</span>
          <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="n">tochar</span><span class="p">(</span><span class="n">var64</span><span class="p">)</span> <span class="p">;</span> <span class="k">deallocate</span><span class="p">(</span><span class="n">var64</span><span class="p">)</span>
        <span class="n">endif</span>
        <span class="k">deallocate</span><span class="p">(</span><span class="n">v_R4</span><span class="p">)</span>
      <span class="k">case</span><span class="p">(</span><span class="s1">&#39;I8&#39;</span><span class="p">)</span>
        <span class="k">allocate</span><span class="p">(</span><span class="n">v_I8</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">N_v</span><span class="p">))</span>
        <span class="k">read</span><span class="p">(</span><span class="n">unit</span> <span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">ua</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)(</span><span class="n">v_I8</span><span class="p">(</span><span class="n">n1</span><span class="p">),</span><span class="n">n1</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">N_v</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">f</span><span class="o">==</span><span class="n">raw</span><span class="p">)</span> <span class="k">then</span>
<span class="k">          write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">int</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">N_Byte</span><span class="p">,</span><span class="n">I4P</span><span class="p">),(</span><span class="n">v_I8</span><span class="p">(</span><span class="n">n1</span><span class="p">),</span><span class="n">n1</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">N_v</span><span class="p">)</span>
        <span class="k">else</span>
<span class="k">          call </span><span class="n">pack_data</span><span class="p">(</span><span class="n">a1</span><span class="o">=</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">N_Byte</span><span class="p">,</span><span class="n">I4P</span><span class="p">)],</span><span class="n">a2</span><span class="o">=</span><span class="n">v_I8</span><span class="p">,</span><span class="n">packed</span><span class="o">=</span><span class="n">varp</span><span class="p">)</span>
          <span class="k">call </span><span class="n">b64_encode</span><span class="p">(</span><span class="n">nB</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">BYI1P</span><span class="p">,</span><span class="n">I4P</span><span class="p">),</span><span class="n">n</span><span class="o">=</span><span class="n">varp</span><span class="p">,</span><span class="n">code</span><span class="o">=</span><span class="n">var64</span><span class="p">)</span> <span class="p">;</span> <span class="k">deallocate</span><span class="p">(</span><span class="n">varp</span><span class="p">)</span>
          <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="n">tochar</span><span class="p">(</span><span class="n">var64</span><span class="p">)</span> <span class="p">;</span> <span class="k">deallocate</span><span class="p">(</span><span class="n">var64</span><span class="p">)</span>
        <span class="n">endif</span>
        <span class="k">deallocate</span><span class="p">(</span><span class="n">v_I8</span><span class="p">)</span>
      <span class="k">case</span><span class="p">(</span><span class="s1">&#39;I4&#39;</span><span class="p">)</span>
        <span class="k">allocate</span><span class="p">(</span><span class="n">v_I4</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">N_v</span><span class="p">))</span>
        <span class="k">read</span><span class="p">(</span><span class="n">unit</span> <span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">ua</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)(</span><span class="n">v_I4</span><span class="p">(</span><span class="n">n1</span><span class="p">),</span><span class="n">n1</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">N_v</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">f</span><span class="o">==</span><span class="n">raw</span><span class="p">)</span> <span class="k">then</span>
<span class="k">          write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">int</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">N_Byte</span><span class="p">,</span><span class="n">I4P</span><span class="p">),(</span><span class="n">v_I4</span><span class="p">(</span><span class="n">n1</span><span class="p">),</span><span class="n">n1</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">N_v</span><span class="p">)</span>
        <span class="k">else</span>
<span class="k">          </span><span class="n">Nvarp</span><span class="o">=</span><span class="n">size</span><span class="p">(</span><span class="nb">transfer</span><span class="p">([</span><span class="nb">int</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">N_Byte</span><span class="p">,</span><span class="n">I4P</span><span class="p">),</span><span class="n">v_I4</span><span class="p">],</span><span class="n">varp</span><span class="p">),</span><span class="nb">kind</span><span class="o">=</span><span class="n">I8P</span><span class="p">)</span>
          <span class="k">if</span> <span class="p">(</span><span class="nb">allocated</span><span class="p">(</span><span class="n">varp</span><span class="p">))</span> <span class="k">deallocate</span><span class="p">(</span><span class="n">varp</span><span class="p">);</span> <span class="k">allocate</span><span class="p">(</span><span class="n">varp</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">Nvarp</span><span class="p">))</span>
          <span class="n">varp</span> <span class="o">=</span> <span class="nb">transfer</span><span class="p">([</span><span class="nb">int</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">N_Byte</span><span class="p">,</span><span class="n">I4P</span><span class="p">),</span><span class="n">v_I4</span><span class="p">],</span><span class="n">varp</span><span class="p">)</span>
          <span class="k">call </span><span class="n">b64_encode</span><span class="p">(</span><span class="n">nB</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">BYI1P</span><span class="p">,</span><span class="n">I4P</span><span class="p">),</span><span class="n">n</span><span class="o">=</span><span class="n">varp</span><span class="p">,</span><span class="n">code</span><span class="o">=</span><span class="n">var64</span><span class="p">)</span> <span class="p">;</span> <span class="k">deallocate</span><span class="p">(</span><span class="n">varp</span><span class="p">)</span>
          <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="n">tochar</span><span class="p">(</span><span class="n">var64</span><span class="p">)</span> <span class="p">;</span> <span class="k">deallocate</span><span class="p">(</span><span class="n">var64</span><span class="p">)</span>
        <span class="n">endif</span>
        <span class="k">deallocate</span><span class="p">(</span><span class="n">v_I4</span><span class="p">)</span>
      <span class="k">case</span><span class="p">(</span><span class="s1">&#39;I2&#39;</span><span class="p">)</span>
        <span class="k">allocate</span><span class="p">(</span><span class="n">v_I2</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">N_v</span><span class="p">))</span>
        <span class="k">read</span><span class="p">(</span><span class="n">unit</span> <span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">ua</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)(</span><span class="n">v_I2</span><span class="p">(</span><span class="n">n1</span><span class="p">),</span><span class="n">n1</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">N_v</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">f</span><span class="o">==</span><span class="n">raw</span><span class="p">)</span> <span class="k">then</span>
<span class="k">          write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">int</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">N_Byte</span><span class="p">,</span><span class="n">I4P</span><span class="p">),(</span><span class="n">v_I2</span><span class="p">(</span><span class="n">n1</span><span class="p">),</span><span class="n">n1</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">N_v</span><span class="p">)</span>
        <span class="k">else</span>
<span class="k">          call </span><span class="n">pack_data</span><span class="p">(</span><span class="n">a1</span><span class="o">=</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">N_Byte</span><span class="p">,</span><span class="n">I4P</span><span class="p">)],</span><span class="n">a2</span><span class="o">=</span><span class="n">v_I2</span><span class="p">,</span><span class="n">packed</span><span class="o">=</span><span class="n">varp</span><span class="p">)</span>
          <span class="k">call </span><span class="n">b64_encode</span><span class="p">(</span><span class="n">nB</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">BYI1P</span><span class="p">,</span><span class="n">I4P</span><span class="p">),</span><span class="n">n</span><span class="o">=</span><span class="n">varp</span><span class="p">,</span><span class="n">code</span><span class="o">=</span><span class="n">var64</span><span class="p">)</span> <span class="p">;</span> <span class="k">deallocate</span><span class="p">(</span><span class="n">varp</span><span class="p">)</span>
          <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="n">tochar</span><span class="p">(</span><span class="n">var64</span><span class="p">)</span> <span class="p">;</span> <span class="k">deallocate</span><span class="p">(</span><span class="n">var64</span><span class="p">)</span>
        <span class="n">endif</span>
        <span class="k">deallocate</span><span class="p">(</span><span class="n">v_I2</span><span class="p">)</span>
      <span class="k">case</span><span class="p">(</span><span class="s1">&#39;I1&#39;</span><span class="p">)</span>
        <span class="k">allocate</span><span class="p">(</span><span class="n">v_I1</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">N_v</span><span class="p">))</span>
        <span class="k">read</span><span class="p">(</span><span class="n">unit</span> <span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">ua</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)(</span><span class="n">v_I1</span><span class="p">(</span><span class="n">n1</span><span class="p">),</span><span class="n">n1</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">N_v</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">f</span><span class="o">==</span><span class="n">raw</span><span class="p">)</span> <span class="k">then</span>
<span class="k">          write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">int</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">N_Byte</span><span class="p">,</span><span class="n">I4P</span><span class="p">),(</span><span class="n">v_I1</span><span class="p">(</span><span class="n">n1</span><span class="p">),</span><span class="n">n1</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">N_v</span><span class="p">)</span>
        <span class="k">else</span>
<span class="k">          call </span><span class="n">pack_data</span><span class="p">(</span><span class="n">a1</span><span class="o">=</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">N_Byte</span><span class="p">,</span><span class="n">I4P</span><span class="p">)],</span><span class="n">a2</span><span class="o">=</span><span class="n">v_I1</span><span class="p">,</span><span class="n">packed</span><span class="o">=</span><span class="n">varp</span><span class="p">)</span>
          <span class="k">call </span><span class="n">b64_encode</span><span class="p">(</span><span class="n">nB</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">BYI1P</span><span class="p">,</span><span class="n">I4P</span><span class="p">),</span><span class="n">n</span><span class="o">=</span><span class="n">varp</span><span class="p">,</span><span class="n">code</span><span class="o">=</span><span class="n">var64</span><span class="p">)</span> <span class="p">;</span> <span class="k">deallocate</span><span class="p">(</span><span class="n">varp</span><span class="p">)</span>
          <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="n">tochar</span><span class="p">(</span><span class="n">var64</span><span class="p">)</span> <span class="p">;</span> <span class="k">deallocate</span><span class="p">(</span><span class="n">var64</span><span class="p">)</span>
        <span class="n">endif</span>
        <span class="k">deallocate</span><span class="p">(</span><span class="n">v_I1</span><span class="p">)</span>
      <span class="k">case </span><span class="n">default</span>
        <span class="n">E_IO</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">write</span> <span class="p">(</span><span class="n">stderr</span><span class="p">,</span><span class="s1">&#39;(A)&#39;</span><span class="p">)</span><span class="s1">&#39; bad var_type = &#39;</span><span class="o">//</span><span class="n">var_type</span>
        <span class="k">write</span> <span class="p">(</span><span class="n">stderr</span><span class="p">,</span><span class="s1">&#39;(A)&#39;</span><span class="p">)</span><span class="s1">&#39; N_Byte = &#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">N_Byte</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39; N_v = &#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">N_v</span><span class="p">))</span>
        <span class="k">return</span>
<span class="k">      </span><span class="n">endselect</span>
    <span class="n">enddo</span>
    <span class="mi">100</span> <span class="k">continue</span>
<span class="k">    write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="n">end_rec</span>
    <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;/AppendedData&gt;&#39;</span><span class="o">//</span><span class="n">end_rec</span>
    <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="s1">&#39;&lt;/VTKFile&gt;&#39;</span><span class="o">//</span><span class="n">end_rec</span>
    <span class="k">close</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">ua</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span>
  <span class="k">case</span><span class="p">(</span><span class="n">binary</span><span class="p">)</span>
    <span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span> <span class="o">=</span> <span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span> <span class="o">-</span> <span class="mi">2</span>
    <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;/&#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">topology</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&gt;&#39;</span><span class="o">//</span><span class="n">end_rec</span>
    <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="s1">&#39;&lt;/VTKFile&gt;&#39;</span><span class="o">//</span><span class="n">end_rec</span>
  <span class="n">endselect</span>
  <span class="k">close</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span>
  <span class="k">call </span><span class="n">vtk_update</span><span class="p">(</span><span class="n">act</span><span class="o">=</span><span class="s1">&#39;remove&#39;</span><span class="p">,</span><span class="n">cf</span><span class="o">=</span><span class="n">rf</span><span class="p">,</span><span class="n">Nvtk</span><span class="o">=</span><span class="n">Nvtk</span><span class="p">,</span><span class="n">vtk</span><span class="o">=</span><span class="n">vtk</span><span class="p">)</span>
  <span class="n">f</span> <span class="o">=</span> <span class="n">rf</span>
  <span class="k">if</span> <span class="p">(</span><span class="nb">present</span><span class="p">(</span><span class="n">cf</span><span class="p">))</span> <span class="n">cf</span> <span class="o">=</span> <span class="n">rf</span>
  <span class="k">return</span>
  <span class="c">!---------------------------------------------------------------------------------------------------------------------------------</span>
  <span class="n">endfunction</span> <span class="n">VTK_END_XML</span>

  <span class="c">!&gt; The VTK_VTM_XML function is used for initializing a VTM (VTK Multiblocks) XML file that is a wrapper to a set of VTK-XML files.</span>
  <span class="c">!&gt; @return E_IO: integer(I4P) error flag</span>
  <span class="c">!&gt; @ingroup Lib_VTK_IOPublicProcedure</span>
  <span class="k">function </span><span class="n">VTM_INI_XML</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span> <span class="k">result</span><span class="p">(</span><span class="n">E_IO</span><span class="p">)</span>
  <span class="c">!---------------------------------------------------------------------------------------------------------------------------------</span>
  <span class="k">implicit none</span>
<span class="k">  </span><span class="kt">character</span><span class="p">(</span><span class="o">*</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span><span class="kd">::</span> <span class="n">filename</span> <span class="c">!&lt; File name of output VTM file.</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">)</span><span class="kd">::</span>             <span class="n">E_IO</span>     <span class="c">!&lt; Input/Output inquiring flag: $0$ if IO is done, $&gt; 0$ if IO is not done.</span>
  <span class="kt">character</span><span class="p">(</span><span class="nb">len</span><span class="o">=</span><span class="n">maxlen</span><span class="p">)</span><span class="kd">::</span>    <span class="n">s_buffer</span> <span class="c">!&lt; Buffer string.</span>
  <span class="c">!---------------------------------------------------------------------------------------------------------------------------------</span>

  <span class="c">!---------------------------------------------------------------------------------------------------------------------------------</span>
  <span class="n">E_IO</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1_I4P</span>
  <span class="k">if</span> <span class="p">(.</span><span class="nb">not</span><span class="p">.</span><span class="n">ir_initialized</span><span class="p">)</span> <span class="k">call </span><span class="n">IR_Init</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">endian</span><span class="o">==</span><span class="n">endianL</span><span class="p">)</span> <span class="k">then</span>
<span class="k">    </span><span class="n">s_buffer</span><span class="o">=</span><span class="s1">&#39;&lt;VTKFile type=&quot;vtkMultiBlockDataSet&quot; version=&quot;1.0&quot; byte_order=&quot;LittleEndian&quot;&gt;&#39;</span>
  <span class="k">else</span>
<span class="k">    </span><span class="n">s_buffer</span><span class="o">=</span><span class="s1">&#39;&lt;VTKFile type=&quot;vtkMultiBlockDataSet&quot; version=&quot;1.0&quot; byte_order=&quot;BigEndian&quot;&gt;&#39;</span>
  <span class="n">endif</span>
  <span class="k">open</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">Get_Unit</span><span class="p">(</span><span class="n">vtm</span><span class="p">%</span><span class="n">u</span><span class="p">),</span><span class="k">file</span><span class="o">=</span><span class="nb">trim</span><span class="p">(</span><span class="n">filename</span><span class="p">),</span><span class="n">form</span><span class="o">=</span><span class="s1">&#39;FORMATTED&#39;</span><span class="p">,</span><span class="nb">access</span><span class="o">=</span><span class="s1">&#39;SEQUENTIAL&#39;</span><span class="p">,</span><span class="n">action</span><span class="o">=</span><span class="s1">&#39;WRITE&#39;</span><span class="p">,</span><span class="n">status</span><span class="o">=</span><span class="s1">&#39;REPLACE&#39;</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span>
  <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtm</span><span class="p">%</span><span class="n">u</span><span class="p">,</span><span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;(A)&#39;</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="s1">&#39;&lt;?xml version=&quot;1.0&quot;?&gt;&#39;</span>
  <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtm</span><span class="p">%</span><span class="n">u</span><span class="p">,</span><span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;(A)&#39;</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">trim</span><span class="p">(</span><span class="n">s_buffer</span><span class="p">)</span> <span class="p">;</span> <span class="n">vtm</span><span class="p">%</span><span class="n">indent</span> <span class="o">=</span> <span class="mi">2</span>
  <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtm</span><span class="p">%</span><span class="n">u</span><span class="p">,</span><span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;(A)&#39;</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtm</span><span class="p">%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;vtkMultiBlockDataSet&gt;&#39;</span> <span class="p">;</span> <span class="n">vtm</span><span class="p">%</span><span class="n">indent</span> <span class="o">=</span> <span class="n">vtm</span><span class="p">%</span><span class="n">indent</span> <span class="o">+</span> <span class="mi">2</span>
  <span class="n">vtm</span><span class="p">%</span><span class="n">blk</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
  <span class="k">return</span>
  <span class="c">!---------------------------------------------------------------------------------------------------------------------------------</span>
  <span class="n">endfunction</span> <span class="n">VTM_INI_XML</span>

  <span class="c">!&gt; The VTM_BLK_XML function is used for opening or closing a block level of a VTM file.</span>
  <span class="c">!&gt; @return E_IO: integer(I4P) error flag</span>
  <span class="c">!&gt; @ingroup Lib_VTK_IOPublicProcedure</span>
  <span class="k">function </span><span class="n">VTM_BLK_XML</span><span class="p">(</span><span class="n">block_action</span><span class="p">)</span> <span class="k">result</span><span class="p">(</span><span class="n">E_IO</span><span class="p">)</span>
  <span class="c">!---------------------------------------------------------------------------------------------------------------------------------</span>
  <span class="k">implicit none</span>
<span class="k">  </span><span class="kt">character</span><span class="p">(</span><span class="o">*</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span><span class="kd">::</span> <span class="n">block_action</span> <span class="c">!&lt; Block action: OPEN or CLOSE block.</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">)</span><span class="kd">::</span>             <span class="n">E_IO</span>         <span class="c">!&lt; Input/Output inquiring flag: $0$ if IO is done, $&gt; 0$ if IO is not done.</span>
  <span class="c">!---------------------------------------------------------------------------------------------------------------------------------</span>

  <span class="c">!---------------------------------------------------------------------------------------------------------------------------------</span>
  <span class="n">E_IO</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1_I4P</span>
  <span class="k">select case</span><span class="p">(</span><span class="nb">trim</span><span class="p">(</span><span class="n">Upper_Case</span><span class="p">(</span><span class="n">block_action</span><span class="p">)))</span>
  <span class="k">case</span><span class="p">(</span><span class="s1">&#39;OPEN&#39;</span><span class="p">)</span>
    <span class="n">vtm</span><span class="p">%</span><span class="n">blk</span> <span class="o">=</span> <span class="n">vtm</span><span class="p">%</span><span class="n">blk</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtm</span><span class="p">%</span><span class="n">u</span><span class="p">,</span><span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;(A)&#39;</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtm</span><span class="p">%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;Block index=&quot;&#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(.</span><span class="n">true</span><span class="p">.,</span><span class="n">vtm</span><span class="p">%</span><span class="n">blk</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39;&quot;&gt;&#39;</span>
    <span class="n">vtm</span><span class="p">%</span><span class="n">indent</span> <span class="o">=</span> <span class="n">vtm</span><span class="p">%</span><span class="n">indent</span> <span class="o">+</span> <span class="mi">2</span>
  <span class="k">case</span><span class="p">(</span><span class="s1">&#39;CLOSE&#39;</span><span class="p">)</span>
    <span class="n">vtm</span><span class="p">%</span><span class="n">indent</span> <span class="o">=</span> <span class="n">vtm</span><span class="p">%</span><span class="n">indent</span> <span class="o">-</span> <span class="mi">2</span> <span class="p">;</span> <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtm</span><span class="p">%</span><span class="n">u</span><span class="p">,</span><span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;(A)&#39;</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtm</span><span class="p">%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;/Block&gt;&#39;</span>
  <span class="n">endselect</span>
  <span class="k">return</span>
  <span class="c">!---------------------------------------------------------------------------------------------------------------------------------</span>
  <span class="n">endfunction</span> <span class="n">VTM_BLK_XML</span>

  <span class="c">!&gt; The VTM_WRF_XML function is used for saving the list of VTK-XML wrapped files by the actual block of the mutliblock VTM file.</span>
  <span class="c">!&gt; @return E_IO: integer(I4P) error flag</span>
  <span class="c">!&gt; @ingroup Lib_VTK_IOPublicProcedure</span>
  <span class="k">function </span><span class="n">VTM_WRF_XML</span><span class="p">(</span><span class="n">flist</span><span class="p">)</span> <span class="k">result</span><span class="p">(</span><span class="n">E_IO</span><span class="p">)</span>
  <span class="c">!---------------------------------------------------------------------------------------------------------------------------------</span>
  <span class="k">implicit none</span>
<span class="k">  </span><span class="kt">character</span><span class="p">(</span><span class="o">*</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span><span class="kd">::</span> <span class="n">flist</span><span class="p">(:)</span> <span class="c">!&lt; List of VTK-XML wrapped files.</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">)</span><span class="kd">::</span>             <span class="n">E_IO</span>     <span class="c">!&lt; Input/Output inquiring flag: 0 if IO is done, &gt; 0 if IO is not done.</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">)</span><span class="kd">::</span>             <span class="n">f</span>        <span class="c">!&lt; File counter.</span>
  <span class="c">!---------------------------------------------------------------------------------------------------------------------------------</span>

  <span class="c">!---------------------------------------------------------------------------------------------------------------------------------</span>
  <span class="n">E_IO</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1_I4P</span>
  <span class="k">do </span><span class="n">f</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">size</span><span class="p">(</span><span class="n">flist</span><span class="p">)</span>
    <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtm</span><span class="p">%</span><span class="n">u</span><span class="p">,</span><span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;(A)&#39;</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtm</span><span class="p">%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;DataSet index=&quot;&#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(.</span><span class="n">true</span><span class="p">.,</span><span class="n">f</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39;&quot; file=&quot;&#39;</span><span class="o">//</span> <span class="p">&amp;</span>
                                           <span class="nb">adjustl</span><span class="p">(</span><span class="nb">trim</span><span class="p">(</span><span class="n">flist</span><span class="p">(</span><span class="n">f</span><span class="p">)))</span><span class="o">//</span><span class="s1">&#39;&quot;/&gt;&#39;</span>
  <span class="n">enddo</span>
  <span class="k">return</span>
  <span class="c">!---------------------------------------------------------------------------------------------------------------------------------</span>
  <span class="n">endfunction</span> <span class="n">VTM_WRF_XML</span>

  <span class="c">!&gt; Function for finalizing open file, it has not inputs, @libvtk manages the file unit without the</span>
  <span class="c">!&gt; user&#39;s action.</span>
  <span class="c">!&gt; @return E_IO: integer(I4P) error flag</span>
  <span class="c">!&gt; @ingroup Lib_VTK_IOPublicProcedure</span>
  <span class="k">function </span><span class="n">VTM_END_XML</span><span class="p">()</span> <span class="k">result</span><span class="p">(</span><span class="n">E_IO</span><span class="p">)</span>
  <span class="c">!---------------------------------------------------------------------------------------------------------------------------------</span>
  <span class="k">implicit none</span>
<span class="k">  </span><span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">)</span><span class="kd">::</span> <span class="n">E_IO</span> <span class="c">!&lt; Input/Output inquiring flag: $0$ if IO is done, $&gt; 0$ if IO is not done.</span>
  <span class="c">!---------------------------------------------------------------------------------------------------------------------------------</span>

  <span class="c">!---------------------------------------------------------------------------------------------------------------------------------</span>
  <span class="n">E_IO</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1_I4P</span>
  <span class="n">vtm</span><span class="p">%</span><span class="n">indent</span> <span class="o">=</span> <span class="n">vtm</span><span class="p">%</span><span class="n">indent</span> <span class="o">-</span> <span class="mi">2</span>
  <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtm</span><span class="p">%</span><span class="n">u</span><span class="p">,</span><span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;(A)&#39;</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtm</span><span class="p">%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;/vtkMultiBlockDataSet&gt;&#39;</span>
  <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtm</span><span class="p">%</span><span class="n">u</span><span class="p">,</span><span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;(A)&#39;</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="s1">&#39;&lt;/VTKFile&gt;&#39;</span>
  <span class="k">close</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtm</span><span class="p">%</span><span class="n">u</span><span class="p">)</span>
  <span class="k">return</span>
  <span class="c">!---------------------------------------------------------------------------------------------------------------------------------</span>
  <span class="n">endfunction</span> <span class="n">VTM_END_XML</span>

  <span class="c">!&gt; @brief Function for initializing parallel (partitioned) VTK-XML file.</span>
  <span class="c">!&gt; @return E_IO: integer(I4P) error flag</span>
  <span class="c">!&gt; @ingroup Lib_VTK_IOPublicProcedure</span>
  <span class="k">function </span><span class="n">PVTK_INI_XML</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span><span class="n">mesh_topology</span><span class="p">,</span><span class="n">tp</span><span class="p">,</span><span class="n">cf</span><span class="p">,</span><span class="n">nx1</span><span class="p">,</span><span class="n">nx2</span><span class="p">,</span><span class="n">ny1</span><span class="p">,</span><span class="n">ny2</span><span class="p">,</span><span class="n">nz1</span><span class="p">,</span><span class="n">nz2</span><span class="p">)</span> <span class="k">result</span><span class="p">(</span><span class="n">E_IO</span><span class="p">)</span>
  <span class="c">!---------------------------------------------------------------------------------------------------------------------------------</span>
  <span class="k">implicit none</span>
<span class="k">  </span><span class="kt">character</span><span class="p">(</span><span class="o">*</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span><span class="kd">::</span>            <span class="n">filename</span>      <span class="c">!&lt; File name.</span>
  <span class="kt">character</span><span class="p">(</span><span class="o">*</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span><span class="kd">::</span>            <span class="n">mesh_topology</span> <span class="c">!&lt; Mesh topology.</span>
  <span class="kt">character</span><span class="p">(</span><span class="o">*</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span><span class="kd">::</span>            <span class="n">tp</span>            <span class="c">!&lt; Type of geometry representation (Float32, Float64, ecc).</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">OUT</span><span class="p">),</span> <span class="k">optional</span><span class="kd">::</span> <span class="n">cf</span>            <span class="c">!&lt; Current file index (for concurrent files IO).</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">),</span>  <span class="k">optional</span><span class="kd">::</span> <span class="n">nx1</span>           <span class="c">!&lt; Initial node of x axis.</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">),</span>  <span class="k">optional</span><span class="kd">::</span> <span class="n">nx2</span>           <span class="c">!&lt; Final node of x axis.</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">),</span>  <span class="k">optional</span><span class="kd">::</span> <span class="n">ny1</span>           <span class="c">!&lt; Initial node of y axis.</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">),</span>  <span class="k">optional</span><span class="kd">::</span> <span class="n">ny2</span>           <span class="c">!&lt; Final node of y axis.</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">),</span>  <span class="k">optional</span><span class="kd">::</span> <span class="n">nz1</span>           <span class="c">!&lt; Initial node of z axis.</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">),</span>  <span class="k">optional</span><span class="kd">::</span> <span class="n">nz2</span>           <span class="c">!&lt; Final node of z axis.</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">)</span><span class="kd">::</span>                        <span class="n">E_IO</span>          <span class="c">!&lt; Input/Output inquiring flag: $0$ if IO is done, $&gt; 0$ if IO is not done.</span>
  <span class="kt">character</span><span class="p">(</span><span class="nb">len</span><span class="o">=</span><span class="n">maxlen</span><span class="p">)</span><span class="kd">::</span>               <span class="n">s_buffer</span>      <span class="c">!&lt; Buffer string.</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">)</span><span class="kd">::</span>                        <span class="n">rf</span>            <span class="c">!&lt; Real file index.</span>
  <span class="c">!---------------------------------------------------------------------------------------------------------------------------------</span>

  <span class="c">!---------------------------------------------------------------------------------------------------------------------------------</span>
  <span class="n">E_IO</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1_I4P</span>
  <span class="k">if</span> <span class="p">(.</span><span class="nb">not</span><span class="p">.</span><span class="n">ir_initialized</span><span class="p">)</span> <span class="k">call </span><span class="n">IR_Init</span>
  <span class="k">call </span><span class="n">vtk_update</span><span class="p">(</span><span class="n">act</span><span class="o">=</span><span class="s1">&#39;add&#39;</span><span class="p">,</span><span class="n">cf</span><span class="o">=</span><span class="n">rf</span><span class="p">,</span><span class="n">Nvtk</span><span class="o">=</span><span class="n">Nvtk</span><span class="p">,</span><span class="n">vtk</span><span class="o">=</span><span class="n">vtk</span><span class="p">)</span>
  <span class="n">f</span> <span class="o">=</span> <span class="n">rf</span>
  <span class="k">if</span> <span class="p">(</span><span class="nb">present</span><span class="p">(</span><span class="n">cf</span><span class="p">))</span> <span class="n">cf</span> <span class="o">=</span> <span class="n">rf</span>
  <span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">topology</span> <span class="o">=</span> <span class="nb">trim</span><span class="p">(</span><span class="n">mesh_topology</span><span class="p">)</span>
  <span class="k">open</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">Get_Unit</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">),</span><span class="k">file</span><span class="o">=</span><span class="nb">trim</span><span class="p">(</span><span class="n">filename</span><span class="p">),&amp;</span>
       <span class="n">form</span><span class="o">=</span><span class="s1">&#39;FORMATTED&#39;</span><span class="p">,</span><span class="nb">access</span><span class="o">=</span><span class="s1">&#39;SEQUENTIAL&#39;</span><span class="p">,</span><span class="n">action</span><span class="o">=</span><span class="s1">&#39;WRITE&#39;</span><span class="p">,</span><span class="n">status</span><span class="o">=</span><span class="s1">&#39;REPLACE&#39;</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span>
  <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;(A)&#39;</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="s1">&#39;&lt;?xml version=&quot;1.0&quot;?&gt;&#39;</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">endian</span><span class="o">==</span><span class="n">endianL</span><span class="p">)</span> <span class="k">then</span>
<span class="k">    </span><span class="n">s_buffer</span> <span class="o">=</span> <span class="s1">&#39;&lt;VTKFile type=&quot;&#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">topology</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&quot; version=&quot;0.1&quot; byte_order=&quot;LittleEndian&quot;&gt;&#39;</span>
  <span class="k">else</span>
<span class="k">    </span><span class="n">s_buffer</span> <span class="o">=</span> <span class="s1">&#39;&lt;VTKFile type=&quot;&#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">topology</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&quot; version=&quot;0.1&quot; byte_order=&quot;BigEndian&quot;&gt;&#39;</span>
  <span class="n">endif</span>
  <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;(A)&#39;</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">trim</span><span class="p">(</span><span class="n">s_buffer</span><span class="p">)</span> <span class="p">;</span> <span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span> <span class="o">=</span> <span class="mi">2</span>
  <span class="k">select case</span><span class="p">(</span><span class="nb">trim</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">topology</span><span class="p">))</span>
  <span class="k">case</span><span class="p">(</span><span class="s1">&#39;PRectilinearGrid&#39;</span><span class="p">)</span>
    <span class="n">s_buffer</span> <span class="o">=</span> <span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;&#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">topology</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39; WholeExtent=&quot;&#39;</span><span class="o">//</span><span class="p">&amp;</span>
               <span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">nx1</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39; &#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">nx2</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39; &#39;</span><span class="o">//</span>                             <span class="p">&amp;</span>
               <span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">ny1</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39; &#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">ny2</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39; &#39;</span><span class="o">//</span>                             <span class="p">&amp;</span>
               <span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">nz1</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39; &#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">nz2</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39;&quot; GhostLevel=&quot;#&quot;&gt;&#39;</span>
    <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;(A)&#39;</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">trim</span><span class="p">(</span><span class="n">s_buffer</span><span class="p">)</span> <span class="p">;</span> <span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span> <span class="o">=</span> <span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span> <span class="o">+</span> <span class="mi">2</span>
    <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;(A)&#39;</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;PCoordinates&gt;&#39;</span> <span class="p">;</span> <span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span> <span class="o">=</span> <span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span> <span class="o">+</span> <span class="mi">2</span>
    <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;(A)&#39;</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;PDataArray type=&quot;&#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">tp</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&quot;/&gt;&#39;</span>
    <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;(A)&#39;</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;PDataArray type=&quot;&#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">tp</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&quot;/&gt;&#39;</span>
    <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;(A)&#39;</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;PDataArray type=&quot;&#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">tp</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&quot;/&gt;&#39;</span>
    <span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span> <span class="o">=</span> <span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span> <span class="o">-</span> <span class="mi">2</span> <span class="p">;</span> <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;(A)&#39;</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;/PCoordinates&gt;&#39;</span>
  <span class="k">case</span><span class="p">(</span><span class="s1">&#39;PStructuredGrid&#39;</span><span class="p">)</span>
    <span class="n">s_buffer</span> <span class="o">=</span> <span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;&#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">topology</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39; WholeExtent=&quot;&#39;</span><span class="o">//</span><span class="p">&amp;</span>
               <span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">nx1</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39; &#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">nx2</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39; &#39;</span><span class="o">//</span>                             <span class="p">&amp;</span>
               <span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">ny1</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39; &#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">ny2</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39; &#39;</span><span class="o">//</span>                             <span class="p">&amp;</span>
               <span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">nz1</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39; &#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">nz2</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39;&quot; GhostLevel=&quot;#&quot;&gt;&#39;</span>
    <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;(A)&#39;</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">trim</span><span class="p">(</span><span class="n">s_buffer</span><span class="p">)</span> <span class="p">;</span> <span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span> <span class="o">=</span> <span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span> <span class="o">+</span> <span class="mi">2</span>
    <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;(A)&#39;</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;PPoints&gt;&#39;</span> <span class="p">;</span> <span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span> <span class="o">=</span> <span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span> <span class="o">+</span> <span class="mi">2</span>
    <span class="n">s_buffer</span> <span class="o">=</span> <span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;PDataArray type=&quot;&#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">tp</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&quot; NumberOfComponents=&quot;3&quot; Name=&quot;Points&quot;/&gt;&#39;</span>
    <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;(A)&#39;</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">trim</span><span class="p">(</span><span class="n">s_buffer</span><span class="p">)</span>
    <span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span> <span class="o">=</span> <span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span> <span class="o">-</span> <span class="mi">2</span> <span class="p">;</span> <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;(A)&#39;</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;/PPoints&gt;&#39;</span>
  <span class="k">case</span><span class="p">(</span><span class="s1">&#39;PUnstructuredGrid&#39;</span><span class="p">)</span>
    <span class="n">s_buffer</span> <span class="o">=</span> <span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;&#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">topology</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39; GhostLevel=&quot;0&quot;&gt;&#39;</span>
    <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;(A)&#39;</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">trim</span><span class="p">(</span><span class="n">s_buffer</span><span class="p">)</span> <span class="p">;</span> <span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span> <span class="o">=</span> <span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span> <span class="o">+</span> <span class="mi">2</span>
    <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;(A)&#39;</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;PPoints&gt;&#39;</span> <span class="p">;</span> <span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span> <span class="o">=</span> <span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span> <span class="o">+</span> <span class="mi">2</span>
    <span class="n">s_buffer</span> <span class="o">=</span> <span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;PDataArray type=&quot;&#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">tp</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&quot; NumberOfComponents=&quot;3&quot; Name=&quot;Points&quot;/&gt;&#39;</span>
    <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;(A)&#39;</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">trim</span><span class="p">(</span><span class="n">s_buffer</span><span class="p">)</span>
    <span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span> <span class="o">=</span> <span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span> <span class="o">-</span> <span class="mi">2</span> <span class="p">;</span> <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;(A)&#39;</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;/PPoints&gt;&#39;</span>
  <span class="n">endselect</span>
  <span class="k">return</span>
  <span class="c">!---------------------------------------------------------------------------------------------------------------------------------</span>
  <span class="n">endfunction</span> <span class="n">PVTK_INI_XML</span>

  <span class="c">!&gt; Function for saving piece geometry source for parallel (partitioned) VTK-XML file.</span>
  <span class="c">!&gt; @return E_IO: integer(I4P) error flag</span>
  <span class="c">!&gt; @ingroup Lib_VTK_IOPublicProcedure</span>
  <span class="k">function </span><span class="n">PVTK_GEO_XML</span><span class="p">(</span><span class="n">source</span><span class="p">,</span><span class="n">cf</span><span class="p">,</span><span class="n">nx1</span><span class="p">,</span><span class="n">nx2</span><span class="p">,</span><span class="n">ny1</span><span class="p">,</span><span class="n">ny2</span><span class="p">,</span><span class="n">nz1</span><span class="p">,</span><span class="n">nz2</span><span class="p">)</span> <span class="k">result</span><span class="p">(</span><span class="n">E_IO</span><span class="p">)</span>
  <span class="c">!---------------------------------------------------------------------------------------------------------------------------------</span>
  <span class="k">implicit none</span>
<span class="k">  </span><span class="kt">character</span><span class="p">(</span><span class="o">*</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span><span class="kd">::</span>           <span class="n">source</span>   <span class="c">!&lt; Source file name containing the piece data.</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">),</span> <span class="k">optional</span><span class="kd">::</span> <span class="n">cf</span>       <span class="c">!&lt; Current file index (for concurrent files IO).</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">),</span> <span class="k">optional</span><span class="kd">::</span> <span class="n">nx1</span>      <span class="c">!&lt; Initial node of x axis.</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">),</span> <span class="k">optional</span><span class="kd">::</span> <span class="n">nx2</span>      <span class="c">!&lt; Final node of x axis.</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">),</span> <span class="k">optional</span><span class="kd">::</span> <span class="n">ny1</span>      <span class="c">!&lt; Initial node of y axis.</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">),</span> <span class="k">optional</span><span class="kd">::</span> <span class="n">ny2</span>      <span class="c">!&lt; Final node of y axis.</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">),</span> <span class="k">optional</span><span class="kd">::</span> <span class="n">nz1</span>      <span class="c">!&lt; Initial node of z axis.</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">),</span> <span class="k">optional</span><span class="kd">::</span> <span class="n">nz2</span>      <span class="c">!&lt; Final node of z axis.</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">)</span><span class="kd">::</span>                       <span class="n">E_IO</span>     <span class="c">!&lt; Input/Output inquiring flag: $0$ if IO is done, $&gt; 0$ if IO is not done.</span>
  <span class="kt">character</span><span class="p">(</span><span class="nb">len</span><span class="o">=</span><span class="n">maxlen</span><span class="p">)</span><span class="kd">::</span>              <span class="n">s_buffer</span> <span class="c">!&lt; Buffer string.</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">)</span><span class="kd">::</span>                       <span class="n">rf</span>       <span class="c">!&lt; Real file index.</span>
  <span class="c">!---------------------------------------------------------------------------------------------------------------------------------</span>

  <span class="c">!---------------------------------------------------------------------------------------------------------------------------------</span>
  <span class="n">E_IO</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1_I4P</span>
  <span class="n">rf</span> <span class="o">=</span> <span class="n">f</span>
  <span class="k">if</span> <span class="p">(</span><span class="nb">present</span><span class="p">(</span><span class="n">cf</span><span class="p">))</span> <span class="k">then</span>
<span class="k">    </span><span class="n">rf</span> <span class="o">=</span> <span class="n">cf</span> <span class="p">;</span> <span class="n">f</span> <span class="o">=</span> <span class="n">cf</span>
  <span class="n">endif</span>
  <span class="k">select case</span> <span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">topology</span><span class="p">)</span>
  <span class="k">case</span><span class="p">(</span><span class="s1">&#39;PRectilinearGrid&#39;</span><span class="p">,</span><span class="s1">&#39;PStructuredGrid&#39;</span><span class="p">)</span>
    <span class="n">s_buffer</span> <span class="o">=</span> <span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;Piece Extent=&quot;&#39;</span><span class="o">//</span> <span class="p">&amp;</span>
               <span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">nx1</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39; &#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">nx2</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39; &#39;</span><span class="o">//</span> <span class="p">&amp;</span>
               <span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">ny1</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39; &#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">ny2</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39; &#39;</span><span class="o">//</span> <span class="p">&amp;</span>
               <span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">nz1</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39; &#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">nz2</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39;&quot; Source=&quot;&#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">source</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&quot;/&gt;&#39;</span>
    <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;(A)&#39;</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">trim</span><span class="p">(</span><span class="n">s_buffer</span><span class="p">)</span>
  <span class="k">case</span><span class="p">(</span><span class="s1">&#39;PUnstructuredGrid&#39;</span><span class="p">)</span>
    <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;(A)&#39;</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;Piece Source=&quot;&#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">source</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&quot;/&gt;&#39;</span>
  <span class="n">endselect</span>
  <span class="k">return</span>
  <span class="c">!---------------------------------------------------------------------------------------------------------------------------------</span>
  <span class="n">endfunction</span> <span class="n">PVTK_GEO_XML</span>

  <span class="c">!&gt; Function that \b must be called before saving the data related to geometric mesh, this function initializes the</span>
  <span class="c">!&gt; saving of data variables indicating the \em type (node or cell centered) of variables that will be saved.</span>
  <span class="c">!&gt; @ingroup Lib_VTK_IOPublicProcedure</span>
  <span class="k">function </span><span class="n">PVTK_DAT_XML</span><span class="p">(</span><span class="n">var_location</span><span class="p">,</span><span class="n">var_block_action</span><span class="p">,</span><span class="n">cf</span><span class="p">)</span> <span class="k">result</span><span class="p">(</span><span class="n">E_IO</span><span class="p">)</span>
  <span class="c">!---------------------------------------------------------------------------------------------------------------------------------</span>
  <span class="k">implicit none</span>
<span class="k">  </span><span class="kt">character</span><span class="p">(</span><span class="o">*</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span><span class="kd">::</span>           <span class="n">var_location</span>     <span class="c">!&lt; Location of saving variables: CELL or NODE centered.</span>
  <span class="kt">character</span><span class="p">(</span><span class="o">*</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span><span class="kd">::</span>           <span class="n">var_block_action</span> <span class="c">!&lt; Variables block action: OPEN or CLOSE block.</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">),</span> <span class="k">optional</span><span class="kd">::</span> <span class="n">cf</span>               <span class="c">!&lt; Current file index (for concurrent files IO).</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">)</span><span class="kd">::</span>                       <span class="n">E_IO</span>             <span class="c">!&lt; Input/Output inquiring flag: $0$ if IO is done, $&gt; 0$ if IO is not done.</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">)</span><span class="kd">::</span>                       <span class="n">rf</span>               <span class="c">!&lt; Real file index.</span>
  <span class="c">!---------------------------------------------------------------------------------------------------------------------------------</span>

  <span class="c">!---------------------------------------------------------------------------------------------------------------------------------</span>
  <span class="n">E_IO</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1_I4P</span>
  <span class="n">rf</span> <span class="o">=</span> <span class="n">f</span>
  <span class="k">if</span> <span class="p">(</span><span class="nb">present</span><span class="p">(</span><span class="n">cf</span><span class="p">))</span> <span class="k">then</span>
<span class="k">    </span><span class="n">rf</span> <span class="o">=</span> <span class="n">cf</span> <span class="p">;</span> <span class="n">f</span> <span class="o">=</span> <span class="n">cf</span>
  <span class="n">endif</span>
  <span class="k">select case</span><span class="p">(</span><span class="nb">trim</span><span class="p">(</span><span class="n">Upper_Case</span><span class="p">(</span><span class="n">var_location</span><span class="p">)))</span>
  <span class="k">case</span><span class="p">(</span><span class="s1">&#39;CELL&#39;</span><span class="p">)</span>
    <span class="k">select case</span><span class="p">(</span><span class="nb">trim</span><span class="p">(</span><span class="n">Upper_Case</span><span class="p">(</span><span class="n">var_block_action</span><span class="p">)))</span>
    <span class="k">case</span><span class="p">(</span><span class="s1">&#39;OPEN&#39;</span><span class="p">)</span>
      <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;(A)&#39;</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;PCellData&gt;&#39;</span> <span class="p">;</span> <span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span> <span class="o">=</span> <span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span> <span class="o">+</span> <span class="mi">2</span>
    <span class="k">case</span><span class="p">(</span><span class="s1">&#39;CLOSE&#39;</span><span class="p">)</span>
      <span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span> <span class="o">=</span> <span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span> <span class="o">-</span> <span class="mi">2</span> <span class="p">;</span> <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;(A)&#39;</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;/PCellData&gt;&#39;</span>
    <span class="n">endselect</span>
  <span class="k">case</span><span class="p">(</span><span class="s1">&#39;NODE&#39;</span><span class="p">)</span>
    <span class="k">select case</span><span class="p">(</span><span class="nb">trim</span><span class="p">(</span><span class="n">Upper_Case</span><span class="p">(</span><span class="n">var_block_action</span><span class="p">)))</span>
    <span class="k">case</span><span class="p">(</span><span class="s1">&#39;OPEN&#39;</span><span class="p">)</span>
      <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;(A)&#39;</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;PPointData&gt;&#39;</span> <span class="p">;</span> <span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span> <span class="o">=</span> <span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span> <span class="o">+</span> <span class="mi">2</span>
    <span class="k">case</span><span class="p">(</span><span class="s1">&#39;CLOSE&#39;</span><span class="p">)</span>
      <span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span> <span class="o">=</span> <span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span> <span class="o">-</span> <span class="mi">2</span> <span class="p">;</span> <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;(A)&#39;</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;/PPointData&gt;&#39;</span>
    <span class="n">endselect</span>
  <span class="n">endselect</span>
  <span class="k">return</span>
  <span class="c">!---------------------------------------------------------------------------------------------------------------------------------</span>
  <span class="n">endfunction</span> <span class="n">PVTK_DAT_XML</span>

  <span class="c">!&gt; Function for saving variable associated to nodes or cells geometry.</span>
  <span class="c">!&gt; @return E_IO: integer(I4P) error flag</span>
  <span class="c">!&gt; @ingroup Lib_VTK_IOPublicProcedure</span>
  <span class="k">function </span><span class="n">PVTK_VAR_XML</span><span class="p">(</span><span class="n">varname</span><span class="p">,</span><span class="n">tp</span><span class="p">,</span><span class="n">cf</span><span class="p">,</span><span class="n">Nc</span><span class="p">)</span> <span class="k">result</span><span class="p">(</span><span class="n">E_IO</span><span class="p">)</span>
  <span class="c">!---------------------------------------------------------------------------------------------------------------------------------</span>
  <span class="k">implicit none</span>
<span class="k">  </span><span class="kt">character</span><span class="p">(</span><span class="o">*</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span><span class="kd">::</span>           <span class="n">varname</span>  <span class="c">!&lt; Variable name.</span>
  <span class="kt">character</span><span class="p">(</span><span class="o">*</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span><span class="kd">::</span>           <span class="n">tp</span>       <span class="c">!&lt; Type of data representation (Float32, Float64, ecc).</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">),</span> <span class="k">optional</span><span class="kd">::</span> <span class="n">cf</span>       <span class="c">!&lt; Current file index (for concurrent files IO).</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">),</span> <span class="k">optional</span><span class="kd">::</span> <span class="n">Nc</span>       <span class="c">!&lt; Number of components of variable.</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">)</span><span class="kd">::</span>                       <span class="n">E_IO</span>     <span class="c">!&lt; Input/Output inquiring flag: $0$ if IO is done, $&gt; 0$ if IO is not done.</span>
  <span class="kt">character</span><span class="p">(</span><span class="nb">len</span><span class="o">=</span><span class="n">maxlen</span><span class="p">)</span><span class="kd">::</span>              <span class="n">s_buffer</span> <span class="c">!&lt; Buffer string.</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">)</span><span class="kd">::</span>                       <span class="n">rf</span>       <span class="c">!&lt; Real file index.</span>
  <span class="c">!---------------------------------------------------------------------------------------------------------------------------------</span>

  <span class="c">!---------------------------------------------------------------------------------------------------------------------------------</span>
  <span class="n">E_IO</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1_I4P</span>
  <span class="n">rf</span> <span class="o">=</span> <span class="n">f</span>
  <span class="k">if</span> <span class="p">(</span><span class="nb">present</span><span class="p">(</span><span class="n">cf</span><span class="p">))</span> <span class="k">then</span>
<span class="k">    </span><span class="n">rf</span> <span class="o">=</span> <span class="n">cf</span> <span class="p">;</span> <span class="n">f</span> <span class="o">=</span> <span class="n">cf</span>
  <span class="n">endif</span>
  <span class="k">if</span> <span class="p">(</span><span class="nb">present</span><span class="p">(</span><span class="n">Nc</span><span class="p">))</span> <span class="k">then</span>
<span class="k">    </span><span class="n">s_buffer</span> <span class="o">=</span> <span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;PDataArray type=&quot;&#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">tp</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&quot; Name=&quot;&#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">varname</span><span class="p">)</span><span class="o">//</span><span class="p">&amp;</span>
               <span class="s1">&#39;&quot; NumberOfComponents=&quot;&#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(.</span><span class="n">true</span><span class="p">.,</span><span class="n">Nc</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39;&quot;/&gt;&#39;</span>
  <span class="k">else</span>
<span class="k">    </span><span class="n">s_buffer</span> <span class="o">=</span> <span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;PDataArray type=&quot;&#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">tp</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&quot; Name=&quot;&#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">varname</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&quot;/&gt;&#39;</span>
  <span class="n">endif</span>
  <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;(A)&#39;</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">trim</span><span class="p">(</span><span class="n">s_buffer</span><span class="p">)</span>
  <span class="k">return</span>
  <span class="c">!---------------------------------------------------------------------------------------------------------------------------------</span>
  <span class="n">endfunction</span> <span class="n">PVTK_VAR_XML</span>

  <span class="c">!&gt; @brief Function for finalizing the parallel (partitioned) VTK-XML file.</span>
  <span class="c">!&gt; @return E_IO: integer(I4P) error flag</span>
  <span class="c">!&gt; @ingroup Lib_VTK_IOPublicProcedure</span>
  <span class="k">function </span><span class="n">PVTK_END_XML</span><span class="p">(</span><span class="n">cf</span><span class="p">)</span> <span class="k">result</span><span class="p">(</span><span class="n">E_IO</span><span class="p">)</span>
  <span class="c">!---------------------------------------------------------------------------------------------------------------------------------</span>
  <span class="k">implicit none</span>
<span class="k">  </span><span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">INOUT</span><span class="p">),</span> <span class="k">optional</span><span class="kd">::</span> <span class="n">cf</span>   <span class="c">!&lt; Current file index (for concurrent files IO).</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">)</span><span class="kd">::</span>                          <span class="n">E_IO</span> <span class="c">!&lt; Input/Output inquiring flag: $0$ if IO is done, $&gt; 0$ if IO is not done.</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">)</span><span class="kd">::</span>                          <span class="n">rf</span>   <span class="c">!&lt; Real file index.</span>
  <span class="c">!---------------------------------------------------------------------------------------------------------------------------------</span>

  <span class="c">!---------------------------------------------------------------------------------------------------------------------------------</span>
  <span class="n">E_IO</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1_I4P</span>
  <span class="n">rf</span> <span class="o">=</span> <span class="n">f</span>
  <span class="k">if</span> <span class="p">(</span><span class="nb">present</span><span class="p">(</span><span class="n">cf</span><span class="p">))</span> <span class="k">then</span>
<span class="k">    </span><span class="n">rf</span> <span class="o">=</span> <span class="n">cf</span> <span class="p">;</span> <span class="n">f</span> <span class="o">=</span> <span class="n">cf</span>
  <span class="n">endif</span>
  <span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span> <span class="o">=</span> <span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span> <span class="o">-</span> <span class="mi">2</span>
  <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;(A)&#39;</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">repeat</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">indent</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&lt;/&#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">topology</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;&gt;&#39;</span>
  <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;(A)&#39;</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="s1">&#39;&lt;/VTKFile&gt;&#39;</span>
  <span class="k">close</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span>
  <span class="k">call </span><span class="n">vtk_update</span><span class="p">(</span><span class="n">act</span><span class="o">=</span><span class="s1">&#39;remove&#39;</span><span class="p">,</span><span class="n">cf</span><span class="o">=</span><span class="n">rf</span><span class="p">,</span><span class="n">Nvtk</span><span class="o">=</span><span class="n">Nvtk</span><span class="p">,</span><span class="n">vtk</span><span class="o">=</span><span class="n">vtk</span><span class="p">)</span>
  <span class="n">f</span> <span class="o">=</span> <span class="n">rf</span>
  <span class="k">if</span> <span class="p">(</span><span class="nb">present</span><span class="p">(</span><span class="n">cf</span><span class="p">))</span> <span class="n">cf</span> <span class="o">=</span> <span class="n">rf</span>
  <span class="k">return</span>
  <span class="c">!---------------------------------------------------------------------------------------------------------------------------------</span>
  <span class="n">endfunction</span> <span class="n">PVTK_END_XML</span>

  <span class="c">!&gt; @brief Function for initializing VTK-legacy file.</span>
  <span class="c">!&gt; @remark This function must be the first to be called.</span>
  <span class="c">!&gt; @note An example of usage is: \n</span>
  <span class="c">!&gt; @code ...</span>
  <span class="c">!&gt; E_IO=VTK_INI(&#39;Binary&#39;,&#39;example.vtk&#39;,&#39;VTK legacy file&#39;,&#39;UNSTRUCTURED_GRID&#39;)</span>
  <span class="c">!&gt; ... @endcode</span>
  <span class="c">!&gt; @return E_IO: integer(I4P) error flag</span>
  <span class="c">!&gt; @ingroup Lib_VTK_IOPublicProcedure</span>
  <span class="k">function </span><span class="n">VTK_INI</span><span class="p">(</span><span class="n">output_format</span><span class="p">,</span><span class="n">filename</span><span class="p">,</span><span class="n">title</span><span class="p">,</span><span class="n">mesh_topology</span><span class="p">,</span><span class="n">cf</span><span class="p">)</span> <span class="k">result</span><span class="p">(</span><span class="n">E_IO</span><span class="p">)</span>
  <span class="c">!---------------------------------------------------------------------------------------------------------------------------------</span>
  <span class="k">implicit none</span>
<span class="k">  </span><span class="kt">character</span><span class="p">(</span><span class="o">*</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span><span class="kd">::</span>            <span class="n">output_format</span> <span class="c">!&lt; Output format: ASCII or RAW.</span>
  <span class="kt">character</span><span class="p">(</span><span class="o">*</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span><span class="kd">::</span>            <span class="n">filename</span>      <span class="c">!&lt; Name of file.</span>
  <span class="kt">character</span><span class="p">(</span><span class="o">*</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span><span class="kd">::</span>            <span class="n">title</span>         <span class="c">!&lt; Title.</span>
  <span class="kt">character</span><span class="p">(</span><span class="o">*</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span><span class="kd">::</span>            <span class="n">mesh_topology</span> <span class="c">!&lt; Mesh topology.</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">OUT</span><span class="p">),</span> <span class="k">optional</span><span class="kd">::</span> <span class="n">cf</span>            <span class="c">!&lt; Current file index (for concurrent files IO).</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">)</span><span class="kd">::</span>                        <span class="n">E_IO</span>          <span class="c">!&lt; Input/Output inquiring flag: $0$ if IO is done, $&gt; 0$ if IO is not done.</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">)</span><span class="kd">::</span>                        <span class="n">rf</span>            <span class="c">!&lt; Real file index.</span>
  <span class="c">!---------------------------------------------------------------------------------------------------------------------------------</span>

  <span class="c">!---------------------------------------------------------------------------------------------------------------------------------</span>
  <span class="n">E_IO</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1_I4P</span>
  <span class="k">if</span> <span class="p">(.</span><span class="nb">not</span><span class="p">.</span><span class="n">ir_initialized</span><span class="p">)</span> <span class="k">call </span><span class="n">IR_Init</span>
  <span class="k">call </span><span class="n">vtk_update</span><span class="p">(</span><span class="n">act</span><span class="o">=</span><span class="s1">&#39;add&#39;</span><span class="p">,</span><span class="n">cf</span><span class="o">=</span><span class="n">rf</span><span class="p">,</span><span class="n">Nvtk</span><span class="o">=</span><span class="n">Nvtk</span><span class="p">,</span><span class="n">vtk</span><span class="o">=</span><span class="n">vtk</span><span class="p">)</span>
  <span class="n">f</span> <span class="o">=</span> <span class="n">rf</span>
  <span class="k">if</span> <span class="p">(</span><span class="nb">present</span><span class="p">(</span><span class="n">cf</span><span class="p">))</span> <span class="n">cf</span> <span class="o">=</span> <span class="n">rf</span>
  <span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">topology</span> <span class="o">=</span> <span class="nb">trim</span><span class="p">(</span><span class="n">mesh_topology</span><span class="p">)</span>
  <span class="k">select case</span><span class="p">(</span><span class="nb">trim</span><span class="p">(</span><span class="n">Upper_Case</span><span class="p">(</span><span class="n">output_format</span><span class="p">)))</span>
  <span class="k">case</span><span class="p">(</span><span class="s1">&#39;ASCII&#39;</span><span class="p">)</span>
    <span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">f</span> <span class="o">=</span> <span class="n">ascii</span>
    <span class="k">open</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">Get_Unit</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">),</span><span class="k">file</span><span class="o">=</span><span class="nb">trim</span><span class="p">(</span><span class="n">filename</span><span class="p">),</span><span class="n">form</span><span class="o">=</span><span class="s1">&#39;FORMATTED&#39;</span><span class="p">,&amp;</span>
         <span class="nb">access</span><span class="o">=</span><span class="s1">&#39;SEQUENTIAL&#39;</span><span class="p">,</span><span class="n">action</span><span class="o">=</span><span class="s1">&#39;WRITE&#39;</span><span class="p">,</span><span class="n">status</span><span class="o">=</span><span class="s1">&#39;REPLACE&#39;</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span>
    <span class="c">! writing header of file</span>
    <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;(A)&#39;</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="s1">&#39;# vtk DataFile Version 3.0&#39;</span>
    <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;(A)&#39;</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">trim</span><span class="p">(</span><span class="n">title</span><span class="p">)</span>
    <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;(A)&#39;</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">trim</span><span class="p">(</span><span class="n">Upper_Case</span><span class="p">(</span><span class="n">output_format</span><span class="p">))</span>
    <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;(A)&#39;</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="s1">&#39;DATASET &#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">topology</span><span class="p">)</span>
  <span class="k">case</span><span class="p">(</span><span class="s1">&#39;RAW&#39;</span><span class="p">)</span>
    <span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">f</span> <span class="o">=</span> <span class="n">raw</span>
    <span class="k">open</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">Get_Unit</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">),</span><span class="k">file</span><span class="o">=</span><span class="nb">trim</span><span class="p">(</span><span class="n">filename</span><span class="p">),&amp;</span>
         <span class="n">form</span><span class="o">=</span><span class="s1">&#39;UNFORMATTED&#39;</span><span class="p">,</span><span class="nb">access</span><span class="o">=</span><span class="s1">&#39;STREAM&#39;</span><span class="p">,</span><span class="n">action</span><span class="o">=</span><span class="s1">&#39;WRITE&#39;</span><span class="p">,</span><span class="n">status</span><span class="o">=</span><span class="s1">&#39;REPLACE&#39;</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span>
    <span class="c">! writing header of file</span>
    <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="s1">&#39;# vtk DataFile Version 3.0&#39;</span><span class="o">//</span><span class="n">end_rec</span>
    <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">trim</span><span class="p">(</span><span class="n">title</span><span class="p">)</span><span class="o">//</span><span class="n">end_rec</span>
    <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">trim</span><span class="p">(</span><span class="n">Upper_Case</span><span class="p">(</span><span class="n">output_format</span><span class="p">))</span><span class="o">//</span><span class="n">end_rec</span>
    <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="s1">&#39;DATASET &#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">topology</span><span class="p">)</span><span class="o">//</span><span class="n">end_rec</span>
  <span class="n">endselect</span>
  <span class="k">return</span>
  <span class="c">!---------------------------------------------------------------------------------------------------------------------------------</span>
  <span class="n">endfunction</span> <span class="n">VTK_INI</span>

  <span class="c">!&gt; @ingroup Lib_VTK_IOPrivateProcedure</span>
  <span class="c">!&gt; @{</span>
  <span class="c">!&gt; Function for saving mesh with \b STRUCTURED_POINTS topology (R8P).</span>
  <span class="c">!&gt; @return E_IO: integer(I4P) error flag</span>
  <span class="k">function </span><span class="n">VTK_GEO_STRP_R8</span><span class="p">(</span><span class="n">Nx</span><span class="p">,</span><span class="n">Ny</span><span class="p">,</span><span class="n">Nz</span><span class="p">,</span><span class="n">X0</span><span class="p">,</span><span class="n">Y0</span><span class="p">,</span><span class="n">Z0</span><span class="p">,</span><span class="n">Dx</span><span class="p">,</span><span class="n">Dy</span><span class="p">,</span><span class="n">Dz</span><span class="p">,</span><span class="n">cf</span><span class="p">)</span> <span class="k">result</span><span class="p">(</span><span class="n">E_IO</span><span class="p">)</span>
  <span class="c">!---------------------------------------------------------------------------------------------------------------------------------</span>
  <span class="k">implicit none</span>
<span class="k">  </span><span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span><span class="kd">::</span>           <span class="n">Nx</span>   <span class="c">!&lt; Number of nodes in x direction.</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span><span class="kd">::</span>           <span class="n">Ny</span>   <span class="c">!&lt; Number of nodes in y direction.</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span><span class="kd">::</span>           <span class="n">Nz</span>   <span class="c">!&lt; Number of nodes in z direction.</span>
  <span class="kt">real</span><span class="p">(</span><span class="n">R8P</span><span class="p">),</span>    <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span><span class="kd">::</span>           <span class="n">X0</span>   <span class="c">!&lt; X coordinate of origin.</span>
  <span class="kt">real</span><span class="p">(</span><span class="n">R8P</span><span class="p">),</span>    <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span><span class="kd">::</span>           <span class="n">Y0</span>   <span class="c">!&lt; Y coordinate of origin.</span>
  <span class="kt">real</span><span class="p">(</span><span class="n">R8P</span><span class="p">),</span>    <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span><span class="kd">::</span>           <span class="n">Z0</span>   <span class="c">!&lt; Z coordinate of origin.</span>
  <span class="kt">real</span><span class="p">(</span><span class="n">R8P</span><span class="p">),</span>    <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span><span class="kd">::</span>           <span class="n">Dx</span>   <span class="c">!&lt; Space step in x direction.</span>
  <span class="kt">real</span><span class="p">(</span><span class="n">R8P</span><span class="p">),</span>    <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span><span class="kd">::</span>           <span class="n">Dy</span>   <span class="c">!&lt; Space step in y direction.</span>
  <span class="kt">real</span><span class="p">(</span><span class="n">R8P</span><span class="p">),</span>    <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span><span class="kd">::</span>           <span class="n">Dz</span>   <span class="c">!&lt; Space step in z direction.</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">),</span> <span class="k">optional</span><span class="kd">::</span> <span class="n">cf</span>   <span class="c">!&lt; Current file index (for concurrent files IO).</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">)</span><span class="kd">::</span>                       <span class="n">E_IO</span> <span class="c">!&lt; Input/Output inquiring flag: $0$ if IO is done, $&gt; 0$ if IO is not done.</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">)</span><span class="kd">::</span>                       <span class="n">rf</span>   <span class="c">!&lt; Real file index.</span>
  <span class="c">!---------------------------------------------------------------------------------------------------------------------------------</span>

  <span class="c">!---------------------------------------------------------------------------------------------------------------------------------</span>
  <span class="n">E_IO</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1_I4P</span>
  <span class="n">rf</span> <span class="o">=</span> <span class="n">f</span>
  <span class="k">if</span> <span class="p">(</span><span class="nb">present</span><span class="p">(</span><span class="n">cf</span><span class="p">))</span> <span class="k">then</span>
<span class="k">    </span><span class="n">rf</span> <span class="o">=</span> <span class="n">cf</span> <span class="p">;</span> <span class="n">f</span> <span class="o">=</span> <span class="n">cf</span>
  <span class="n">endif</span>
  <span class="k">select case</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">f</span><span class="p">)</span>
  <span class="k">case</span><span class="p">(</span><span class="n">ascii</span><span class="p">)</span>
    <span class="k">write</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="s1">&#39;(A)&#39;</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="s1">&#39;DIMENSIONS &#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(.</span><span class="n">true</span><span class="p">.,</span><span class="n">Nx</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39; &#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(.</span><span class="n">true</span><span class="p">.,</span><span class="n">Ny</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39; &#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(.</span><span class="n">true</span><span class="p">.,</span><span class="n">Nz</span><span class="p">))</span>
    <span class="k">write</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="s1">&#39;(A)&#39;</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="s1">&#39;ORIGIN &#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">X0</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39; &#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">Y0</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39; &#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">Z0</span><span class="p">))</span>
    <span class="k">write</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="s1">&#39;(A)&#39;</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="s1">&#39;SPACING &#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">Dx</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39; &#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">Dy</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39; &#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">Dz</span><span class="p">))</span>
  <span class="k">case</span><span class="p">(</span><span class="n">raw</span><span class="p">)</span>
    <span class="k">write</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="s1">&#39;DIMENSIONS &#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(.</span><span class="n">true</span><span class="p">.,</span><span class="n">Nx</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39; &#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(.</span><span class="n">true</span><span class="p">.,</span><span class="n">Ny</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39; &#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(.</span><span class="n">true</span><span class="p">.,</span><span class="n">Nz</span><span class="p">))</span><span class="o">//</span><span class="n">end_rec</span>
    <span class="k">write</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="s1">&#39;ORIGIN &#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">X0</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39; &#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">Y0</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39; &#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">Z0</span><span class="p">))</span><span class="o">//</span><span class="n">end_rec</span>
    <span class="k">write</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="s1">&#39;SPACING &#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">Dx</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39; &#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">Dy</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39; &#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">Dz</span><span class="p">))</span><span class="o">//</span><span class="n">end_rec</span>
  <span class="n">endselect</span>
  <span class="k">return</span>
  <span class="c">!---------------------------------------------------------------------------------------------------------------------------------</span>
  <span class="n">endfunction</span> <span class="n">VTK_GEO_STRP_R8</span>

  <span class="c">!&gt; Function for saving mesh with \b STRUCTURED_POINTS topology (R4P).</span>
  <span class="c">!&gt; @return E_IO: integer(I4P) error flag</span>
  <span class="k">function </span><span class="n">VTK_GEO_STRP_R4</span><span class="p">(</span><span class="n">Nx</span><span class="p">,</span><span class="n">Ny</span><span class="p">,</span><span class="n">Nz</span><span class="p">,</span><span class="n">X0</span><span class="p">,</span><span class="n">Y0</span><span class="p">,</span><span class="n">Z0</span><span class="p">,</span><span class="n">Dx</span><span class="p">,</span><span class="n">Dy</span><span class="p">,</span><span class="n">Dz</span><span class="p">,</span><span class="n">cf</span><span class="p">)</span> <span class="k">result</span><span class="p">(</span><span class="n">E_IO</span><span class="p">)</span>
  <span class="c">!---------------------------------------------------------------------------------------------------------------------------------</span>
  <span class="k">implicit none</span>
<span class="k">  </span><span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span><span class="kd">::</span>           <span class="n">Nx</span>   <span class="c">!&lt; Number of nodes in x direction.</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span><span class="kd">::</span>           <span class="n">Ny</span>   <span class="c">!&lt; Number of nodes in y direction.</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span><span class="kd">::</span>           <span class="n">Nz</span>   <span class="c">!&lt; Number of nodes in z direction.</span>
  <span class="kt">real</span><span class="p">(</span><span class="n">R4P</span><span class="p">),</span>    <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span><span class="kd">::</span>           <span class="n">X0</span>   <span class="c">!&lt; X coordinate of origin.</span>
  <span class="kt">real</span><span class="p">(</span><span class="n">R4P</span><span class="p">),</span>    <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span><span class="kd">::</span>           <span class="n">Y0</span>   <span class="c">!&lt; Y coordinate of origin.</span>
  <span class="kt">real</span><span class="p">(</span><span class="n">R4P</span><span class="p">),</span>    <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span><span class="kd">::</span>           <span class="n">Z0</span>   <span class="c">!&lt; Z coordinate of origin.</span>
  <span class="kt">real</span><span class="p">(</span><span class="n">R4P</span><span class="p">),</span>    <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span><span class="kd">::</span>           <span class="n">Dx</span>   <span class="c">!&lt; Space step in x direction.</span>
  <span class="kt">real</span><span class="p">(</span><span class="n">R4P</span><span class="p">),</span>    <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span><span class="kd">::</span>           <span class="n">Dy</span>   <span class="c">!&lt; Space step in y direction.</span>
  <span class="kt">real</span><span class="p">(</span><span class="n">R4P</span><span class="p">),</span>    <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span><span class="kd">::</span>           <span class="n">Dz</span>   <span class="c">!&lt; Space step in z direction.</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">),</span> <span class="k">optional</span><span class="kd">::</span> <span class="n">cf</span>   <span class="c">!&lt; Current file index (for concurrent files IO).</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">)</span><span class="kd">::</span>                       <span class="n">E_IO</span> <span class="c">!&lt; Input/Output inquiring flag: $0$ if IO is done, $&gt; 0$ if IO is not done.</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">)</span><span class="kd">::</span>                       <span class="n">rf</span>   <span class="c">!&lt; Real file index.</span>
  <span class="c">!---------------------------------------------------------------------------------------------------------------------------------</span>

  <span class="c">!---------------------------------------------------------------------------------------------------------------------------------</span>
  <span class="n">E_IO</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1_I4P</span>
  <span class="n">rf</span> <span class="o">=</span> <span class="n">f</span>
  <span class="k">if</span> <span class="p">(</span><span class="nb">present</span><span class="p">(</span><span class="n">cf</span><span class="p">))</span> <span class="k">then</span>
<span class="k">    </span><span class="n">rf</span> <span class="o">=</span> <span class="n">cf</span> <span class="p">;</span> <span class="n">f</span> <span class="o">=</span> <span class="n">cf</span>
  <span class="n">endif</span>
  <span class="k">select case</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">f</span><span class="p">)</span>
  <span class="k">case</span><span class="p">(</span><span class="n">ascii</span><span class="p">)</span>
    <span class="k">write</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="s1">&#39;(A)&#39;</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="s1">&#39;DIMENSIONS &#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(.</span><span class="n">true</span><span class="p">.,</span><span class="n">Nx</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39; &#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(.</span><span class="n">true</span><span class="p">.,</span><span class="n">Ny</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39; &#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(.</span><span class="n">true</span><span class="p">.,</span><span class="n">Nz</span><span class="p">))</span>
    <span class="k">write</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="s1">&#39;(A)&#39;</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="s1">&#39;ORIGIN &#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">X0</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39; &#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">Y0</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39; &#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">Z0</span><span class="p">))</span>
    <span class="k">write</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="s1">&#39;(A)&#39;</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="s1">&#39;SPACING &#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">Dx</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39; &#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">Dy</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39; &#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">Dz</span><span class="p">))</span>
  <span class="k">case</span><span class="p">(</span><span class="n">raw</span><span class="p">)</span>
    <span class="k">write</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="s1">&#39;DIMENSIONS &#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(.</span><span class="n">true</span><span class="p">.,</span><span class="n">Nx</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39; &#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(.</span><span class="n">true</span><span class="p">.,</span><span class="n">Ny</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39; &#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(.</span><span class="n">true</span><span class="p">.,</span><span class="n">Nz</span><span class="p">))</span><span class="o">//</span><span class="n">end_rec</span>
    <span class="k">write</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="s1">&#39;ORIGIN &#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">X0</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39; &#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">Y0</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39; &#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">Z0</span><span class="p">))</span><span class="o">//</span><span class="n">end_rec</span>
    <span class="k">write</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="s1">&#39;SPACING &#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">Dx</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39; &#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">Dy</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39; &#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">Dz</span><span class="p">))</span><span class="o">//</span><span class="n">end_rec</span>
  <span class="n">endselect</span>
  <span class="k">return</span>
  <span class="c">!---------------------------------------------------------------------------------------------------------------------------------</span>
  <span class="n">endfunction</span> <span class="n">VTK_GEO_STRP_R4</span>

  <span class="c">!&gt; Function for saving mesh with \b STRUCTURED_GRID topology (R8P, 1D arrays).</span>
  <span class="c">!&gt; @return E_IO: integer(I4P) error flag</span>
  <span class="k">function </span><span class="n">VTK_GEO_STRG_1DA_R8</span><span class="p">(</span><span class="n">Nx</span><span class="p">,</span><span class="n">Ny</span><span class="p">,</span><span class="n">Nz</span><span class="p">,</span><span class="n">NN</span><span class="p">,</span><span class="n">X</span><span class="p">,</span><span class="n">Y</span><span class="p">,</span><span class="n">Z</span><span class="p">,</span><span class="n">cf</span><span class="p">)</span> <span class="k">result</span><span class="p">(</span><span class="n">E_IO</span><span class="p">)</span>
  <span class="c">!---------------------------------------------------------------------------------------------------------------------------------</span>
  <span class="k">implicit none</span>
<span class="k">  </span><span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span><span class="kd">::</span>           <span class="n">Nx</span>       <span class="c">!&lt; Number of nodes in x direction.</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span><span class="kd">::</span>           <span class="n">Ny</span>       <span class="c">!&lt; Number of nodes in y direction.</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span><span class="kd">::</span>           <span class="n">Nz</span>       <span class="c">!&lt; Number of nodes in z direction.</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span><span class="kd">::</span>           <span class="n">NN</span>       <span class="c">!&lt; Number of all nodes.</span>
  <span class="kt">real</span><span class="p">(</span><span class="n">R8P</span><span class="p">),</span>    <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span><span class="kd">::</span>           <span class="n">X</span><span class="p">(</span><span class="mi">1</span><span class="p">:)</span>    <span class="c">!&lt; X coordinates [1:NN].</span>
  <span class="kt">real</span><span class="p">(</span><span class="n">R8P</span><span class="p">),</span>    <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span><span class="kd">::</span>           <span class="n">Y</span><span class="p">(</span><span class="mi">1</span><span class="p">:)</span>    <span class="c">!&lt; Y coordinates [1:NN].</span>
  <span class="kt">real</span><span class="p">(</span><span class="n">R8P</span><span class="p">),</span>    <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span><span class="kd">::</span>           <span class="n">Z</span><span class="p">(</span><span class="mi">1</span><span class="p">:)</span>    <span class="c">!&lt; Z coordinates [1:NN].</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">),</span> <span class="k">optional</span><span class="kd">::</span> <span class="n">cf</span>       <span class="c">!&lt; Current file index (for concurrent files IO).</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">)</span><span class="kd">::</span>                       <span class="n">E_IO</span>     <span class="c">!&lt; Input/Output inquiring flag: $0$ if IO is done, $&gt; 0$ if IO is not done.</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">)</span><span class="kd">::</span>                       <span class="n">rf</span>       <span class="c">!&lt; Real file index.</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">)</span><span class="kd">::</span>                       <span class="n">n1</span>       <span class="c">!&lt; Counter.</span>
  <span class="c">!---------------------------------------------------------------------------------------------------------------------------------</span>

  <span class="c">!---------------------------------------------------------------------------------------------------------------------------------</span>
  <span class="n">E_IO</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1_I4P</span>
  <span class="n">rf</span> <span class="o">=</span> <span class="n">f</span>
  <span class="k">if</span> <span class="p">(</span><span class="nb">present</span><span class="p">(</span><span class="n">cf</span><span class="p">))</span> <span class="k">then</span>
<span class="k">    </span><span class="n">rf</span> <span class="o">=</span> <span class="n">cf</span> <span class="p">;</span> <span class="n">f</span> <span class="o">=</span> <span class="n">cf</span>
  <span class="n">endif</span>
  <span class="k">select case</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">f</span><span class="p">)</span>
  <span class="k">case</span><span class="p">(</span><span class="n">ascii</span><span class="p">)</span>
    <span class="k">write</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="s1">&#39;(A)&#39;</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="s1">&#39;DIMENSIONS &#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(.</span><span class="n">true</span><span class="p">.,</span><span class="n">Nx</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39; &#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(.</span><span class="n">true</span><span class="p">.,</span><span class="n">Ny</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39; &#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(.</span><span class="n">true</span><span class="p">.,</span><span class="n">Nz</span><span class="p">))</span>
    <span class="k">write</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="s1">&#39;(A)&#39;</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="s1">&#39;POINTS &#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(.</span><span class="n">true</span><span class="p">.,</span><span class="n">NN</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39; double&#39;</span>
    <span class="k">do </span><span class="n">n1</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">NN</span>
      <span class="k">write</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="s1">&#39;(A)&#39;</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="n">str</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">X</span><span class="p">(</span><span class="n">n1</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39; &#39;</span><span class="o">//</span><span class="n">str</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">Y</span><span class="p">(</span><span class="n">n1</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39; &#39;</span><span class="o">//</span><span class="n">str</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">Z</span><span class="p">(</span><span class="n">n1</span><span class="p">))</span>
    <span class="n">enddo</span>
  <span class="k">case</span><span class="p">(</span><span class="n">raw</span><span class="p">)</span>
    <span class="k">write</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="s1">&#39;DIMENSIONS &#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(.</span><span class="n">true</span><span class="p">.,</span><span class="n">Nx</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39; &#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(.</span><span class="n">true</span><span class="p">.,</span><span class="n">Ny</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39; &#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(.</span><span class="n">true</span><span class="p">.,</span><span class="n">Nz</span><span class="p">))</span><span class="o">//</span><span class="n">end_rec</span>
    <span class="k">write</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="s1">&#39;POINTS &#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(.</span><span class="n">true</span><span class="p">.,</span><span class="n">NN</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39; double&#39;</span><span class="o">//</span><span class="n">end_rec</span>
    <span class="k">write</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)(</span><span class="n">X</span><span class="p">(</span><span class="n">n1</span><span class="p">),</span><span class="n">Y</span><span class="p">(</span><span class="n">n1</span><span class="p">),</span><span class="n">Z</span><span class="p">(</span><span class="n">n1</span><span class="p">),</span><span class="n">n1</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">NN</span><span class="p">)</span>
    <span class="k">write</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="n">end_rec</span>
  <span class="n">endselect</span>
  <span class="k">return</span>
  <span class="c">!---------------------------------------------------------------------------------------------------------------------------------</span>
  <span class="n">endfunction</span> <span class="n">VTK_GEO_STRG_1DA_R8</span>

  <span class="c">!&gt; Function for saving mesh with \b STRUCTURED_GRID topology (R8P, 1D arrays, packed API).</span>
  <span class="c">!&gt; @return E_IO: integer(I4P) error flag</span>
  <span class="k">function </span><span class="n">VTK_GEO_STRG_1DAP_R8</span><span class="p">(</span><span class="n">Nx</span><span class="p">,</span><span class="n">Ny</span><span class="p">,</span><span class="n">Nz</span><span class="p">,</span><span class="n">NN</span><span class="p">,</span><span class="n">XYZ</span><span class="p">,</span><span class="n">cf</span><span class="p">)</span> <span class="k">result</span><span class="p">(</span><span class="n">E_IO</span><span class="p">)</span>
  <span class="c">!---------------------------------------------------------------------------------------------------------------------------------</span>
  <span class="k">implicit none</span>
<span class="k">  </span><span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span><span class="kd">::</span>           <span class="n">Nx</span>         <span class="c">!&lt; Number of nodes in x direction.</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span><span class="kd">::</span>           <span class="n">Ny</span>         <span class="c">!&lt; Number of nodes in y direction.</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span><span class="kd">::</span>           <span class="n">Nz</span>         <span class="c">!&lt; Number of nodes in z direction.</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span><span class="kd">::</span>           <span class="n">NN</span>         <span class="c">!&lt; Number of all nodes.</span>
  <span class="kt">real</span><span class="p">(</span><span class="n">R8P</span><span class="p">),</span>    <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span><span class="kd">::</span>           <span class="n">XYZ</span><span class="p">(</span><span class="mi">1</span><span class="p">:,</span><span class="mi">1</span><span class="p">:)</span> <span class="c">!&lt; X, Y and Z coordinates [1:3,1:NN].</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">),</span> <span class="k">optional</span><span class="kd">::</span> <span class="n">cf</span>         <span class="c">!&lt; Current file index (for concurrent files IO).</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">)</span><span class="kd">::</span>                       <span class="n">E_IO</span>       <span class="c">!&lt; Input/Output inquiring flag: $0$ if IO is done, $&gt; 0$ if IO is not done.</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">)</span><span class="kd">::</span>                       <span class="n">rf</span>         <span class="c">!&lt; Real file index.</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">)</span><span class="kd">::</span>                       <span class="n">n1</span>         <span class="c">!&lt; Counter.</span>
  <span class="c">!---------------------------------------------------------------------------------------------------------------------------------</span>

  <span class="c">!---------------------------------------------------------------------------------------------------------------------------------</span>
  <span class="n">E_IO</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1_I4P</span>
  <span class="n">rf</span> <span class="o">=</span> <span class="n">f</span>
  <span class="k">if</span> <span class="p">(</span><span class="nb">present</span><span class="p">(</span><span class="n">cf</span><span class="p">))</span> <span class="k">then</span>
<span class="k">    </span><span class="n">rf</span> <span class="o">=</span> <span class="n">cf</span> <span class="p">;</span> <span class="n">f</span> <span class="o">=</span> <span class="n">cf</span>
  <span class="n">endif</span>
  <span class="k">select case</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">f</span><span class="p">)</span>
  <span class="k">case</span><span class="p">(</span><span class="n">ascii</span><span class="p">)</span>
    <span class="k">write</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="s1">&#39;(A)&#39;</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="s1">&#39;DIMENSIONS &#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(.</span><span class="n">true</span><span class="p">.,</span><span class="n">Nx</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39; &#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(.</span><span class="n">true</span><span class="p">.,</span><span class="n">Ny</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39; &#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(.</span><span class="n">true</span><span class="p">.,</span><span class="n">Nz</span><span class="p">))</span>
    <span class="k">write</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="s1">&#39;(A)&#39;</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="s1">&#39;POINTS &#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(.</span><span class="n">true</span><span class="p">.,</span><span class="n">NN</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39; double&#39;</span>
    <span class="k">do </span><span class="n">n1</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">NN</span>
      <span class="k">write</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="s1">&#39;(A)&#39;</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="n">str</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">XYZ</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">n1</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39; &#39;</span><span class="o">//</span><span class="n">str</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">XYZ</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="n">n1</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39; &#39;</span><span class="o">//</span><span class="n">str</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">XYZ</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="n">n1</span><span class="p">))</span>
    <span class="n">enddo</span>
  <span class="k">case</span><span class="p">(</span><span class="n">raw</span><span class="p">)</span>
    <span class="k">write</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="s1">&#39;DIMENSIONS &#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(.</span><span class="n">true</span><span class="p">.,</span><span class="n">Nx</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39; &#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(.</span><span class="n">true</span><span class="p">.,</span><span class="n">Ny</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39; &#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(.</span><span class="n">true</span><span class="p">.,</span><span class="n">Nz</span><span class="p">))</span><span class="o">//</span><span class="n">end_rec</span>
    <span class="k">write</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="s1">&#39;POINTS &#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(.</span><span class="n">true</span><span class="p">.,</span><span class="n">NN</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39; double&#39;</span><span class="o">//</span><span class="n">end_rec</span>
    <span class="k">write</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="n">XYZ</span>
    <span class="k">write</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="n">end_rec</span>
  <span class="n">endselect</span>
  <span class="k">return</span>
  <span class="c">!---------------------------------------------------------------------------------------------------------------------------------</span>
  <span class="n">endfunction</span> <span class="n">VTK_GEO_STRG_1DAP_R8</span>

  <span class="c">!&gt; Function for saving mesh with \b STRUCTURED_GRID topology (R8P, 3D arrays).</span>
  <span class="c">!&gt; @return E_IO: integer(I4P) error flag</span>
  <span class="k">function </span><span class="n">VTK_GEO_STRG_3DA_R8</span><span class="p">(</span><span class="n">Nx</span><span class="p">,</span><span class="n">Ny</span><span class="p">,</span><span class="n">Nz</span><span class="p">,</span><span class="n">NN</span><span class="p">,</span><span class="n">X</span><span class="p">,</span><span class="n">Y</span><span class="p">,</span><span class="n">Z</span><span class="p">,</span><span class="n">cf</span><span class="p">)</span> <span class="k">result</span><span class="p">(</span><span class="n">E_IO</span><span class="p">)</span>
  <span class="c">!---------------------------------------------------------------------------------------------------------------------------------</span>
  <span class="k">implicit none</span>
<span class="k">  </span><span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span><span class="kd">::</span>           <span class="n">Nx</span>          <span class="c">!&lt; Number of nodes in x direction.</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span><span class="kd">::</span>           <span class="n">Ny</span>          <span class="c">!&lt; Number of nodes in y direction.</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span><span class="kd">::</span>           <span class="n">Nz</span>          <span class="c">!&lt; Number of nodes in z direction.</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span><span class="kd">::</span>           <span class="n">NN</span>          <span class="c">!&lt; Number of all nodes.</span>
  <span class="kt">real</span><span class="p">(</span><span class="n">R8P</span><span class="p">),</span>    <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span><span class="kd">::</span>           <span class="n">X</span><span class="p">(</span><span class="mi">1</span><span class="p">:,</span><span class="mi">1</span><span class="p">:,</span><span class="mi">1</span><span class="p">:)</span> <span class="c">!&lt; X coordinates [1:Nx,1:Ny,1:Nz].</span>
  <span class="kt">real</span><span class="p">(</span><span class="n">R8P</span><span class="p">),</span>    <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span><span class="kd">::</span>           <span class="n">Y</span><span class="p">(</span><span class="mi">1</span><span class="p">:,</span><span class="mi">1</span><span class="p">:,</span><span class="mi">1</span><span class="p">:)</span> <span class="c">!&lt; Y coordinates [1:Nx,1:Ny,1:Nz].</span>
  <span class="kt">real</span><span class="p">(</span><span class="n">R8P</span><span class="p">),</span>    <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span><span class="kd">::</span>           <span class="n">Z</span><span class="p">(</span><span class="mi">1</span><span class="p">:,</span><span class="mi">1</span><span class="p">:,</span><span class="mi">1</span><span class="p">:)</span> <span class="c">!&lt; Z coordinates [1:Nx,1:Ny,1:Nz].</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">),</span> <span class="k">optional</span><span class="kd">::</span> <span class="n">cf</span>          <span class="c">!&lt; Current file index (for concurrent files IO).</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">)</span><span class="kd">::</span>                       <span class="n">E_IO</span>        <span class="c">!&lt; Input/Output inquiring flag: $0$ if IO is done, $&gt; 0$ if IO is not done.</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">)</span><span class="kd">::</span>                       <span class="n">rf</span>          <span class="c">!&lt; Real file index.</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">)</span><span class="kd">::</span>                       <span class="n">n1</span><span class="p">,</span><span class="n">n2</span><span class="p">,</span><span class="n">n3</span>    <span class="c">!&lt; Counters.</span>
  <span class="c">!---------------------------------------------------------------------------------------------------------------------------------</span>

  <span class="c">!---------------------------------------------------------------------------------------------------------------------------------</span>
  <span class="n">E_IO</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1_I4P</span>
  <span class="n">rf</span> <span class="o">=</span> <span class="n">f</span>
  <span class="k">if</span> <span class="p">(</span><span class="nb">present</span><span class="p">(</span><span class="n">cf</span><span class="p">))</span> <span class="k">then</span>
<span class="k">    </span><span class="n">rf</span> <span class="o">=</span> <span class="n">cf</span> <span class="p">;</span> <span class="n">f</span> <span class="o">=</span> <span class="n">cf</span>
  <span class="n">endif</span>
  <span class="k">select case</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">f</span><span class="p">)</span>
  <span class="k">case</span><span class="p">(</span><span class="n">ascii</span><span class="p">)</span>
    <span class="k">write</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="s1">&#39;(A)&#39;</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="s1">&#39;DIMENSIONS &#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(.</span><span class="n">true</span><span class="p">.,</span><span class="n">Nx</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39; &#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(.</span><span class="n">true</span><span class="p">.,</span><span class="n">Ny</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39; &#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(.</span><span class="n">true</span><span class="p">.,</span><span class="n">Nz</span><span class="p">))</span>
    <span class="k">write</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="s1">&#39;(A)&#39;</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="s1">&#39;POINTS &#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(.</span><span class="n">true</span><span class="p">.,</span><span class="n">NN</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39; double&#39;</span>
    <span class="k">do </span><span class="n">n3</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">Nz</span>
      <span class="k">do </span><span class="n">n2</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">Ny</span>
        <span class="k">do </span><span class="n">n1</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">Nx</span>
          <span class="k">write</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="s1">&#39;(A)&#39;</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="n">str</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">X</span><span class="p">(</span><span class="n">n1</span><span class="p">,</span><span class="n">n2</span><span class="p">,</span><span class="n">n3</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39; &#39;</span><span class="o">//</span><span class="n">str</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">Y</span><span class="p">(</span><span class="n">n1</span><span class="p">,</span><span class="n">n2</span><span class="p">,</span><span class="n">n3</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39; &#39;</span><span class="o">//</span><span class="n">str</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">Z</span><span class="p">(</span><span class="n">n1</span><span class="p">,</span><span class="n">n2</span><span class="p">,</span><span class="n">n3</span><span class="p">))</span>
        <span class="n">enddo</span>
      <span class="n">enddo</span>
    <span class="n">enddo</span>
  <span class="k">case</span><span class="p">(</span><span class="n">raw</span><span class="p">)</span>
    <span class="k">write</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="s1">&#39;DIMENSIONS &#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(.</span><span class="n">true</span><span class="p">.,</span><span class="n">Nx</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39; &#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(.</span><span class="n">true</span><span class="p">.,</span><span class="n">Ny</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39; &#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(.</span><span class="n">true</span><span class="p">.,</span><span class="n">Nz</span><span class="p">))</span><span class="o">//</span><span class="n">end_rec</span>
    <span class="k">write</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="s1">&#39;POINTS &#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(.</span><span class="n">true</span><span class="p">.,</span><span class="n">NN</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39; double&#39;</span><span class="o">//</span><span class="n">end_rec</span>
    <span class="k">write</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)(((</span><span class="n">X</span><span class="p">(</span><span class="n">n1</span><span class="p">,</span><span class="n">n2</span><span class="p">,</span><span class="n">n3</span><span class="p">),</span><span class="n">Y</span><span class="p">(</span><span class="n">n1</span><span class="p">,</span><span class="n">n2</span><span class="p">,</span><span class="n">n3</span><span class="p">),</span><span class="n">Z</span><span class="p">(</span><span class="n">n1</span><span class="p">,</span><span class="n">n2</span><span class="p">,</span><span class="n">n3</span><span class="p">),</span><span class="n">n1</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">Nx</span><span class="p">),</span><span class="n">n2</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">Ny</span><span class="p">),</span><span class="n">n3</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">Nz</span><span class="p">)</span>
    <span class="k">write</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="n">end_rec</span>
  <span class="n">endselect</span>
  <span class="k">return</span>
  <span class="c">!---------------------------------------------------------------------------------------------------------------------------------</span>
  <span class="n">endfunction</span> <span class="n">VTK_GEO_STRG_3DA_R8</span>

  <span class="c">!&gt; Function for saving mesh with \b STRUCTURED_GRID topology (R8P, 3D arrays, packed API).</span>
  <span class="c">!&gt; @return E_IO: integer(I4P) error flag</span>
  <span class="k">function </span><span class="n">VTK_GEO_STRG_3DAP_R8</span><span class="p">(</span><span class="n">Nx</span><span class="p">,</span><span class="n">Ny</span><span class="p">,</span><span class="n">Nz</span><span class="p">,</span><span class="n">NN</span><span class="p">,</span><span class="n">XYZ</span><span class="p">,</span><span class="n">cf</span><span class="p">)</span> <span class="k">result</span><span class="p">(</span><span class="n">E_IO</span><span class="p">)</span>
  <span class="c">!---------------------------------------------------------------------------------------------------------------------------------</span>
  <span class="k">implicit none</span>
<span class="k">  </span><span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span><span class="kd">::</span>           <span class="n">Nx</span>               <span class="c">!&lt; Number of nodes in x direction.</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span><span class="kd">::</span>           <span class="n">Ny</span>               <span class="c">!&lt; Number of nodes in y direction.</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span><span class="kd">::</span>           <span class="n">Nz</span>               <span class="c">!&lt; Number of nodes in z direction.</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span><span class="kd">::</span>           <span class="n">NN</span>               <span class="c">!&lt; Number of all nodes.</span>
  <span class="kt">real</span><span class="p">(</span><span class="n">R8P</span><span class="p">),</span>    <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span><span class="kd">::</span>           <span class="n">XYZ</span><span class="p">(</span><span class="mi">1</span><span class="p">:,</span><span class="mi">1</span><span class="p">:,</span><span class="mi">1</span><span class="p">:,</span><span class="mi">1</span><span class="p">:)</span> <span class="c">!&lt; X, Y and Z coordinates [1:3,1:Nx,1:Ny,1:Nz].</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">),</span> <span class="k">optional</span><span class="kd">::</span> <span class="n">cf</span>               <span class="c">!&lt; Current file index (for concurrent files IO).</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">)</span><span class="kd">::</span>                       <span class="n">E_IO</span>             <span class="c">!&lt; Input/Output inquiring flag: $0$ if IO is done, $&gt; 0$ if IO is not done.</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">)</span><span class="kd">::</span>                       <span class="n">rf</span>               <span class="c">!&lt; Real file index.</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">)</span><span class="kd">::</span>                       <span class="n">n1</span><span class="p">,</span><span class="n">n2</span><span class="p">,</span><span class="n">n3</span>         <span class="c">!&lt; Counters.</span>
  <span class="c">!---------------------------------------------------------------------------------------------------------------------------------</span>

  <span class="c">!---------------------------------------------------------------------------------------------------------------------------------</span>
  <span class="n">E_IO</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1_I4P</span>
  <span class="n">rf</span> <span class="o">=</span> <span class="n">f</span>
  <span class="k">if</span> <span class="p">(</span><span class="nb">present</span><span class="p">(</span><span class="n">cf</span><span class="p">))</span> <span class="k">then</span>
<span class="k">    </span><span class="n">rf</span> <span class="o">=</span> <span class="n">cf</span> <span class="p">;</span> <span class="n">f</span> <span class="o">=</span> <span class="n">cf</span>
  <span class="n">endif</span>
  <span class="k">select case</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">f</span><span class="p">)</span>
  <span class="k">case</span><span class="p">(</span><span class="n">ascii</span><span class="p">)</span>
    <span class="k">write</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="s1">&#39;(A)&#39;</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="s1">&#39;DIMENSIONS &#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(.</span><span class="n">true</span><span class="p">.,</span><span class="n">Nx</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39; &#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(.</span><span class="n">true</span><span class="p">.,</span><span class="n">Ny</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39; &#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(.</span><span class="n">true</span><span class="p">.,</span><span class="n">Nz</span><span class="p">))</span>
    <span class="k">write</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="s1">&#39;(A)&#39;</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="s1">&#39;POINTS &#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(.</span><span class="n">true</span><span class="p">.,</span><span class="n">NN</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39; double&#39;</span>
    <span class="k">do </span><span class="n">n3</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">Nz</span>
      <span class="k">do </span><span class="n">n2</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">Ny</span>
        <span class="k">do </span><span class="n">n1</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">Nx</span>
         <span class="k">write</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="s1">&#39;(A)&#39;</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="n">str</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">XYZ</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">n1</span><span class="p">,</span><span class="n">n2</span><span class="p">,</span><span class="n">n3</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39; &#39;</span><span class="o">//</span><span class="n">str</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">XYZ</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="n">n1</span><span class="p">,</span><span class="n">n2</span><span class="p">,</span><span class="n">n3</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39; &#39;</span><span class="o">//</span><span class="n">str</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">XYZ</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="n">n1</span><span class="p">,</span><span class="n">n2</span><span class="p">,</span><span class="n">n3</span><span class="p">))</span>
        <span class="n">enddo</span>
      <span class="n">enddo</span>
    <span class="n">enddo</span>
  <span class="k">case</span><span class="p">(</span><span class="n">raw</span><span class="p">)</span>
    <span class="k">write</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="s1">&#39;DIMENSIONS &#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(.</span><span class="n">true</span><span class="p">.,</span><span class="n">Nx</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39; &#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(.</span><span class="n">true</span><span class="p">.,</span><span class="n">Ny</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39; &#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(.</span><span class="n">true</span><span class="p">.,</span><span class="n">Nz</span><span class="p">))</span><span class="o">//</span><span class="n">end_rec</span>
    <span class="k">write</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="s1">&#39;POINTS &#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(.</span><span class="n">true</span><span class="p">.,</span><span class="n">NN</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39; double&#39;</span><span class="o">//</span><span class="n">end_rec</span>
    <span class="k">write</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="n">XYZ</span>
    <span class="k">write</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="n">end_rec</span>
  <span class="n">endselect</span>
  <span class="k">return</span>
  <span class="c">!---------------------------------------------------------------------------------------------------------------------------------</span>
  <span class="n">endfunction</span> <span class="n">VTK_GEO_STRG_3DAP_R8</span>

  <span class="c">!&gt; Function for saving mesh with \b STRUCTURED_GRID topology (R4P, 1D arrays).</span>
  <span class="c">!&gt; @return E_IO: integer(I4P) error flag</span>
  <span class="k">function </span><span class="n">VTK_GEO_STRG_1DA_R4</span><span class="p">(</span><span class="n">Nx</span><span class="p">,</span><span class="n">Ny</span><span class="p">,</span><span class="n">Nz</span><span class="p">,</span><span class="n">NN</span><span class="p">,</span><span class="n">X</span><span class="p">,</span><span class="n">Y</span><span class="p">,</span><span class="n">Z</span><span class="p">,</span><span class="n">cf</span><span class="p">)</span> <span class="k">result</span><span class="p">(</span><span class="n">E_IO</span><span class="p">)</span>
  <span class="c">!---------------------------------------------------------------------------------------------------------------------------------</span>
  <span class="k">implicit none</span>
<span class="k">  </span><span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span><span class="kd">::</span>           <span class="n">Nx</span>       <span class="c">!&lt; Number of nodes in x direction.</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span><span class="kd">::</span>           <span class="n">Ny</span>       <span class="c">!&lt; Number of nodes in y direction.</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span><span class="kd">::</span>           <span class="n">Nz</span>       <span class="c">!&lt; Number of nodes in z direction.</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span><span class="kd">::</span>           <span class="n">NN</span>       <span class="c">!&lt; Number of all nodes.</span>
  <span class="kt">real</span><span class="p">(</span><span class="n">R4P</span><span class="p">),</span>    <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span><span class="kd">::</span>           <span class="n">X</span><span class="p">(</span><span class="mi">1</span><span class="p">:)</span>    <span class="c">!&lt; X coordinates [1:NN].</span>
  <span class="kt">real</span><span class="p">(</span><span class="n">R4P</span><span class="p">),</span>    <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span><span class="kd">::</span>           <span class="n">Y</span><span class="p">(</span><span class="mi">1</span><span class="p">:)</span>    <span class="c">!&lt; Y coordinates [1:NN].</span>
  <span class="kt">real</span><span class="p">(</span><span class="n">R4P</span><span class="p">),</span>    <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span><span class="kd">::</span>           <span class="n">Z</span><span class="p">(</span><span class="mi">1</span><span class="p">:)</span>    <span class="c">!&lt; Z coordinates [1:NN].</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">),</span> <span class="k">optional</span><span class="kd">::</span> <span class="n">cf</span>       <span class="c">!&lt; Current file index (for concurrent files IO).</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">)</span><span class="kd">::</span>                       <span class="n">E_IO</span>     <span class="c">!&lt; Input/Output inquiring flag: $0$ if IO is done, $&gt; 0$ if IO is not done.</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">)</span><span class="kd">::</span>                       <span class="n">rf</span>       <span class="c">!&lt; Real file index.</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">)</span><span class="kd">::</span>                       <span class="n">n1</span>       <span class="c">!&lt; Counter.</span>
  <span class="c">!---------------------------------------------------------------------------------------------------------------------------------</span>

  <span class="c">!---------------------------------------------------------------------------------------------------------------------------------</span>
  <span class="n">E_IO</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1_I4P</span>
  <span class="n">rf</span> <span class="o">=</span> <span class="n">f</span>
  <span class="k">if</span> <span class="p">(</span><span class="nb">present</span><span class="p">(</span><span class="n">cf</span><span class="p">))</span> <span class="k">then</span>
<span class="k">    </span><span class="n">rf</span> <span class="o">=</span> <span class="n">cf</span> <span class="p">;</span> <span class="n">f</span> <span class="o">=</span> <span class="n">cf</span>
  <span class="n">endif</span>
  <span class="k">select case</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">f</span><span class="p">)</span>
  <span class="k">case</span><span class="p">(</span><span class="n">ascii</span><span class="p">)</span>
    <span class="k">write</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="s1">&#39;(A)&#39;</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="s1">&#39;DIMENSIONS &#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(.</span><span class="n">true</span><span class="p">.,</span><span class="n">Nx</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39; &#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(.</span><span class="n">true</span><span class="p">.,</span><span class="n">Ny</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39; &#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(.</span><span class="n">true</span><span class="p">.,</span><span class="n">Nz</span><span class="p">))</span>
    <span class="k">write</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="s1">&#39;(A)&#39;</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="s1">&#39;POINTS &#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(.</span><span class="n">true</span><span class="p">.,</span><span class="n">NN</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39; float&#39;</span>
    <span class="k">do </span><span class="n">n1</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">NN</span>
      <span class="k">write</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="s1">&#39;(A)&#39;</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="n">str</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">X</span><span class="p">(</span><span class="n">n1</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39; &#39;</span><span class="o">//</span><span class="n">str</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">Y</span><span class="p">(</span><span class="n">n1</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39; &#39;</span><span class="o">//</span><span class="n">str</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">Z</span><span class="p">(</span><span class="n">n1</span><span class="p">))</span>
    <span class="n">enddo</span>
  <span class="k">case</span><span class="p">(</span><span class="n">raw</span><span class="p">)</span>
    <span class="k">write</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="s1">&#39;DIMENSIONS &#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(.</span><span class="n">true</span><span class="p">.,</span><span class="n">Nx</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39; &#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(.</span><span class="n">true</span><span class="p">.,</span><span class="n">Ny</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39; &#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(.</span><span class="n">true</span><span class="p">.,</span><span class="n">Nz</span><span class="p">))</span><span class="o">//</span><span class="n">end_rec</span>
    <span class="k">write</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="s1">&#39;POINTS &#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(.</span><span class="n">true</span><span class="p">.,</span><span class="n">NN</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39; float&#39;</span><span class="o">//</span><span class="n">end_rec</span>
    <span class="k">write</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)(</span><span class="n">X</span><span class="p">(</span><span class="n">n1</span><span class="p">),</span><span class="n">Y</span><span class="p">(</span><span class="n">n1</span><span class="p">),</span><span class="n">Z</span><span class="p">(</span><span class="n">n1</span><span class="p">),</span><span class="n">n1</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">NN</span><span class="p">)</span>
    <span class="k">write</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="n">end_rec</span>
  <span class="n">endselect</span>
  <span class="k">return</span>
  <span class="c">!---------------------------------------------------------------------------------------------------------------------------------</span>
  <span class="n">endfunction</span> <span class="n">VTK_GEO_STRG_1DA_R4</span>

  <span class="c">!&gt; Function for saving mesh with \b STRUCTURED_GRID topology (R4P, 1D arrays, packed API).</span>
  <span class="c">!&gt; @return E_IO: integer(I4P) error flag</span>
  <span class="k">function </span><span class="n">VTK_GEO_STRG_1DAP_R4</span><span class="p">(</span><span class="n">Nx</span><span class="p">,</span><span class="n">Ny</span><span class="p">,</span><span class="n">Nz</span><span class="p">,</span><span class="n">NN</span><span class="p">,</span><span class="n">XYZ</span><span class="p">,</span><span class="n">cf</span><span class="p">)</span> <span class="k">result</span><span class="p">(</span><span class="n">E_IO</span><span class="p">)</span>
  <span class="c">!---------------------------------------------------------------------------------------------------------------------------------</span>
  <span class="k">implicit none</span>
<span class="k">  </span><span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span><span class="kd">::</span>           <span class="n">Nx</span>         <span class="c">!&lt; Number of nodes in x direction.</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span><span class="kd">::</span>           <span class="n">Ny</span>         <span class="c">!&lt; Number of nodes in y direction.</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span><span class="kd">::</span>           <span class="n">Nz</span>         <span class="c">!&lt; Number of nodes in z direction.</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span><span class="kd">::</span>           <span class="n">NN</span>         <span class="c">!&lt; Number of all nodes.</span>
  <span class="kt">real</span><span class="p">(</span><span class="n">R4P</span><span class="p">),</span>    <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span><span class="kd">::</span>           <span class="n">XYZ</span><span class="p">(</span><span class="mi">1</span><span class="p">:,</span><span class="mi">1</span><span class="p">:)</span> <span class="c">!&lt; X, Y and Z coordinates [1:3,1:NN].</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">),</span> <span class="k">optional</span><span class="kd">::</span> <span class="n">cf</span>         <span class="c">!&lt; Current file index (for concurrent files IO).</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">)</span><span class="kd">::</span>                       <span class="n">E_IO</span>       <span class="c">!&lt; Input/Output inquiring flag: $0$ if IO is done, $&gt; 0$ if IO is not done.</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">)</span><span class="kd">::</span>                       <span class="n">rf</span>         <span class="c">!&lt; Real file index.</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">)</span><span class="kd">::</span>                       <span class="n">n1</span>         <span class="c">!&lt; Counter.</span>
  <span class="c">!---------------------------------------------------------------------------------------------------------------------------------</span>

  <span class="c">!---------------------------------------------------------------------------------------------------------------------------------</span>
  <span class="n">E_IO</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1_I4P</span>
  <span class="n">rf</span> <span class="o">=</span> <span class="n">f</span>
  <span class="k">if</span> <span class="p">(</span><span class="nb">present</span><span class="p">(</span><span class="n">cf</span><span class="p">))</span> <span class="k">then</span>
<span class="k">    </span><span class="n">rf</span> <span class="o">=</span> <span class="n">cf</span> <span class="p">;</span> <span class="n">f</span> <span class="o">=</span> <span class="n">cf</span>
  <span class="n">endif</span>
  <span class="k">select case</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">f</span><span class="p">)</span>
  <span class="k">case</span><span class="p">(</span><span class="n">ascii</span><span class="p">)</span>
    <span class="k">write</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="s1">&#39;(A)&#39;</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="s1">&#39;DIMENSIONS &#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(.</span><span class="n">true</span><span class="p">.,</span><span class="n">Nx</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39; &#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(.</span><span class="n">true</span><span class="p">.,</span><span class="n">Ny</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39; &#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(.</span><span class="n">true</span><span class="p">.,</span><span class="n">Nz</span><span class="p">))</span>
    <span class="k">write</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="s1">&#39;(A)&#39;</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="s1">&#39;POINTS &#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(.</span><span class="n">true</span><span class="p">.,</span><span class="n">NN</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39; float&#39;</span>
    <span class="k">do </span><span class="n">n1</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">NN</span>
      <span class="k">write</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="s1">&#39;(A)&#39;</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="n">str</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">XYZ</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">n1</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39; &#39;</span><span class="o">//</span><span class="n">str</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">XYZ</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="n">n1</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39; &#39;</span><span class="o">//</span><span class="n">str</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">XYZ</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="n">n1</span><span class="p">))</span>
    <span class="n">enddo</span>
  <span class="k">case</span><span class="p">(</span><span class="n">raw</span><span class="p">)</span>
    <span class="k">write</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="s1">&#39;DIMENSIONS &#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(.</span><span class="n">true</span><span class="p">.,</span><span class="n">Nx</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39; &#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(.</span><span class="n">true</span><span class="p">.,</span><span class="n">Ny</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39; &#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(.</span><span class="n">true</span><span class="p">.,</span><span class="n">Nz</span><span class="p">))</span><span class="o">//</span><span class="n">end_rec</span>
    <span class="k">write</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="s1">&#39;POINTS &#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(.</span><span class="n">true</span><span class="p">.,</span><span class="n">NN</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39; float&#39;</span><span class="o">//</span><span class="n">end_rec</span>
    <span class="k">write</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="n">XYZ</span>
    <span class="k">write</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="n">end_rec</span>
  <span class="n">endselect</span>
  <span class="k">return</span>
  <span class="c">!---------------------------------------------------------------------------------------------------------------------------------</span>
  <span class="n">endfunction</span> <span class="n">VTK_GEO_STRG_1DAP_R4</span>

  <span class="c">!&gt; Function for saving mesh with \b STRUCTURED_GRID topology (R4P, 3D arrays).</span>
  <span class="c">!&gt; @return E_IO: integer(I4P) error flag</span>
  <span class="k">function </span><span class="n">VTK_GEO_STRG_3DA_R4</span><span class="p">(</span><span class="n">Nx</span><span class="p">,</span><span class="n">Ny</span><span class="p">,</span><span class="n">Nz</span><span class="p">,</span><span class="n">NN</span><span class="p">,</span><span class="n">X</span><span class="p">,</span><span class="n">Y</span><span class="p">,</span><span class="n">Z</span><span class="p">,</span><span class="n">cf</span><span class="p">)</span> <span class="k">result</span><span class="p">(</span><span class="n">E_IO</span><span class="p">)</span>
  <span class="c">!---------------------------------------------------------------------------------------------------------------------------------</span>
  <span class="k">implicit none</span>
<span class="k">  </span><span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span><span class="kd">::</span>           <span class="n">Nx</span>          <span class="c">!&lt; Number of nodes in x direction.</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span><span class="kd">::</span>           <span class="n">Ny</span>          <span class="c">!&lt; Number of nodes in y direction.</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span><span class="kd">::</span>           <span class="n">Nz</span>          <span class="c">!&lt; Number of nodes in z direction.</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span><span class="kd">::</span>           <span class="n">NN</span>          <span class="c">!&lt; Number of all nodes.</span>
  <span class="kt">real</span><span class="p">(</span><span class="n">R4P</span><span class="p">),</span>    <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span><span class="kd">::</span>           <span class="n">X</span><span class="p">(</span><span class="mi">1</span><span class="p">:,</span><span class="mi">1</span><span class="p">:,</span><span class="mi">1</span><span class="p">:)</span> <span class="c">!&lt; X coordinates [1:Nx,1:Ny,1:Nz].</span>
  <span class="kt">real</span><span class="p">(</span><span class="n">R4P</span><span class="p">),</span>    <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span><span class="kd">::</span>           <span class="n">Y</span><span class="p">(</span><span class="mi">1</span><span class="p">:,</span><span class="mi">1</span><span class="p">:,</span><span class="mi">1</span><span class="p">:)</span> <span class="c">!&lt; Y coordinates [1:Nx,1:Ny,1:Nz].</span>
  <span class="kt">real</span><span class="p">(</span><span class="n">R4P</span><span class="p">),</span>    <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span><span class="kd">::</span>           <span class="n">Z</span><span class="p">(</span><span class="mi">1</span><span class="p">:,</span><span class="mi">1</span><span class="p">:,</span><span class="mi">1</span><span class="p">:)</span> <span class="c">!&lt; Z coordinates [1:Nx,1:Ny,1:Nz].</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">),</span> <span class="k">optional</span><span class="kd">::</span> <span class="n">cf</span>          <span class="c">!&lt; Current file index (for concurrent files IO).</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">)</span><span class="kd">::</span>                       <span class="n">E_IO</span>        <span class="c">!&lt; Input/Output inquiring flag: $0$ if IO is done, $&gt; 0$ if IO is not done.</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">)</span><span class="kd">::</span>                       <span class="n">rf</span>          <span class="c">!&lt; Real file index.</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">)</span><span class="kd">::</span>                       <span class="n">n1</span><span class="p">,</span><span class="n">n2</span><span class="p">,</span><span class="n">n3</span>    <span class="c">!&lt; Counters.</span>
  <span class="c">!---------------------------------------------------------------------------------------------------------------------------------</span>

  <span class="c">!---------------------------------------------------------------------------------------------------------------------------------</span>
  <span class="n">E_IO</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1_I4P</span>
  <span class="n">rf</span> <span class="o">=</span> <span class="n">f</span>
  <span class="k">if</span> <span class="p">(</span><span class="nb">present</span><span class="p">(</span><span class="n">cf</span><span class="p">))</span> <span class="k">then</span>
<span class="k">    </span><span class="n">rf</span> <span class="o">=</span> <span class="n">cf</span> <span class="p">;</span> <span class="n">f</span> <span class="o">=</span> <span class="n">cf</span>
  <span class="n">endif</span>
  <span class="k">select case</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">f</span><span class="p">)</span>
  <span class="k">case</span><span class="p">(</span><span class="n">ascii</span><span class="p">)</span>
    <span class="k">write</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="s1">&#39;(A)&#39;</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="s1">&#39;DIMENSIONS &#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(.</span><span class="n">true</span><span class="p">.,</span><span class="n">Nx</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39; &#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(.</span><span class="n">true</span><span class="p">.,</span><span class="n">Ny</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39; &#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(.</span><span class="n">true</span><span class="p">.,</span><span class="n">Nz</span><span class="p">))</span>
    <span class="k">write</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="s1">&#39;(A)&#39;</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="s1">&#39;POINTS &#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(.</span><span class="n">true</span><span class="p">.,</span><span class="n">NN</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39; float&#39;</span>
    <span class="k">do </span><span class="n">n3</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">Nz</span>
      <span class="k">do </span><span class="n">n2</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">Ny</span>
        <span class="k">do </span><span class="n">n1</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">Nx</span>
          <span class="k">write</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="s1">&#39;(A)&#39;</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="n">str</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">X</span><span class="p">(</span><span class="n">n1</span><span class="p">,</span><span class="n">n2</span><span class="p">,</span><span class="n">n3</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39; &#39;</span><span class="o">//</span><span class="n">str</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">Y</span><span class="p">(</span><span class="n">n1</span><span class="p">,</span><span class="n">n2</span><span class="p">,</span><span class="n">n3</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39; &#39;</span><span class="o">//</span><span class="n">str</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">Z</span><span class="p">(</span><span class="n">n1</span><span class="p">,</span><span class="n">n2</span><span class="p">,</span><span class="n">n3</span><span class="p">))</span>
        <span class="n">enddo</span>
      <span class="n">enddo</span>
    <span class="n">enddo</span>
  <span class="k">case</span><span class="p">(</span><span class="n">raw</span><span class="p">)</span>
    <span class="k">write</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="s1">&#39;DIMENSIONS &#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(.</span><span class="n">true</span><span class="p">.,</span><span class="n">Nx</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39; &#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(.</span><span class="n">true</span><span class="p">.,</span><span class="n">Ny</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39; &#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(.</span><span class="n">true</span><span class="p">.,</span><span class="n">Nz</span><span class="p">))</span><span class="o">//</span><span class="n">end_rec</span>
    <span class="k">write</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="s1">&#39;POINTS &#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(.</span><span class="n">true</span><span class="p">.,</span><span class="n">NN</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39; float&#39;</span><span class="o">//</span><span class="n">end_rec</span>
    <span class="k">write</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)(((</span><span class="n">X</span><span class="p">(</span><span class="n">n1</span><span class="p">,</span><span class="n">n2</span><span class="p">,</span><span class="n">n3</span><span class="p">),</span><span class="n">Y</span><span class="p">(</span><span class="n">n1</span><span class="p">,</span><span class="n">n2</span><span class="p">,</span><span class="n">n3</span><span class="p">),</span><span class="n">Z</span><span class="p">(</span><span class="n">n1</span><span class="p">,</span><span class="n">n2</span><span class="p">,</span><span class="n">n3</span><span class="p">),</span><span class="n">n1</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">Nx</span><span class="p">),</span><span class="n">n2</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">Ny</span><span class="p">),</span><span class="n">n3</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">Nz</span><span class="p">)</span>
    <span class="k">write</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="n">end_rec</span>
  <span class="n">endselect</span>
  <span class="k">return</span>
  <span class="c">!---------------------------------------------------------------------------------------------------------------------------------</span>
  <span class="n">endfunction</span> <span class="n">VTK_GEO_STRG_3DA_R4</span>

  <span class="c">!&gt; Function for saving mesh with \b STRUCTURED_GRID topology (R4P, 3D arrays, packed API).</span>
  <span class="c">!&gt; @return E_IO: integer(I4P) error flag</span>
  <span class="k">function </span><span class="n">VTK_GEO_STRG_3DAP_R4</span><span class="p">(</span><span class="n">Nx</span><span class="p">,</span><span class="n">Ny</span><span class="p">,</span><span class="n">Nz</span><span class="p">,</span><span class="n">NN</span><span class="p">,</span><span class="n">XYZ</span><span class="p">,</span><span class="n">cf</span><span class="p">)</span> <span class="k">result</span><span class="p">(</span><span class="n">E_IO</span><span class="p">)</span>
  <span class="c">!---------------------------------------------------------------------------------------------------------------------------------</span>
  <span class="k">implicit none</span>
<span class="k">  </span><span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span><span class="kd">::</span>           <span class="n">Nx</span>               <span class="c">!&lt; Number of nodes in x direction.</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span><span class="kd">::</span>           <span class="n">Ny</span>               <span class="c">!&lt; Number of nodes in y direction.</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span><span class="kd">::</span>           <span class="n">Nz</span>               <span class="c">!&lt; Number of nodes in z direction.</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span><span class="kd">::</span>           <span class="n">NN</span>               <span class="c">!&lt; Number of all nodes.</span>
  <span class="kt">real</span><span class="p">(</span><span class="n">R4P</span><span class="p">),</span>    <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span><span class="kd">::</span>           <span class="n">XYZ</span><span class="p">(</span><span class="mi">1</span><span class="p">:,</span><span class="mi">1</span><span class="p">:,</span><span class="mi">1</span><span class="p">:,</span><span class="mi">1</span><span class="p">:)</span> <span class="c">!&lt; X, Y and Z coordinates [1:3,1:Nx,1:Ny,1:Nz].</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">),</span> <span class="k">optional</span><span class="kd">::</span> <span class="n">cf</span>               <span class="c">!&lt; Current file index (for concurrent files IO).</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">)</span><span class="kd">::</span>                       <span class="n">E_IO</span>             <span class="c">!&lt; Input/Output inquiring flag: $0$ if IO is done, $&gt; 0$ if IO is not done.</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">)</span><span class="kd">::</span>                       <span class="n">rf</span>               <span class="c">!&lt; Real file index.</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">)</span><span class="kd">::</span>                       <span class="n">n1</span><span class="p">,</span><span class="n">n2</span><span class="p">,</span><span class="n">n3</span>         <span class="c">!&lt; Counters.</span>
  <span class="c">!---------------------------------------------------------------------------------------------------------------------------------</span>

  <span class="c">!---------------------------------------------------------------------------------------------------------------------------------</span>
  <span class="n">E_IO</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1_I4P</span>
  <span class="n">rf</span> <span class="o">=</span> <span class="n">f</span>
  <span class="k">if</span> <span class="p">(</span><span class="nb">present</span><span class="p">(</span><span class="n">cf</span><span class="p">))</span> <span class="k">then</span>
<span class="k">    </span><span class="n">rf</span> <span class="o">=</span> <span class="n">cf</span> <span class="p">;</span> <span class="n">f</span> <span class="o">=</span> <span class="n">cf</span>
  <span class="n">endif</span>
  <span class="k">select case</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">f</span><span class="p">)</span>
  <span class="k">case</span><span class="p">(</span><span class="n">ascii</span><span class="p">)</span>
    <span class="k">write</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="s1">&#39;(A)&#39;</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="s1">&#39;DIMENSIONS &#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(.</span><span class="n">true</span><span class="p">.,</span><span class="n">Nx</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39; &#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(.</span><span class="n">true</span><span class="p">.,</span><span class="n">Ny</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39; &#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(.</span><span class="n">true</span><span class="p">.,</span><span class="n">Nz</span><span class="p">))</span>
    <span class="k">write</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="s1">&#39;(A)&#39;</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="s1">&#39;POINTS &#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(.</span><span class="n">true</span><span class="p">.,</span><span class="n">NN</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39; float&#39;</span>
    <span class="k">do </span><span class="n">n3</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">Nz</span>
      <span class="k">do </span><span class="n">n2</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">Ny</span>
        <span class="k">do </span><span class="n">n1</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">Nx</span>
         <span class="k">write</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="s1">&#39;(A)&#39;</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="n">str</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">XYZ</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">n1</span><span class="p">,</span><span class="n">n2</span><span class="p">,</span><span class="n">n3</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39; &#39;</span><span class="o">//</span><span class="n">str</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">XYZ</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="n">n1</span><span class="p">,</span><span class="n">n2</span><span class="p">,</span><span class="n">n3</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39; &#39;</span><span class="o">//</span><span class="n">str</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">XYZ</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="n">n1</span><span class="p">,</span><span class="n">n2</span><span class="p">,</span><span class="n">n3</span><span class="p">))</span>
        <span class="n">enddo</span>
      <span class="n">enddo</span>
    <span class="n">enddo</span>
  <span class="k">case</span><span class="p">(</span><span class="n">raw</span><span class="p">)</span>
    <span class="k">write</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="s1">&#39;DIMENSIONS &#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(.</span><span class="n">true</span><span class="p">.,</span><span class="n">Nx</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39; &#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(.</span><span class="n">true</span><span class="p">.,</span><span class="n">Ny</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39; &#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(.</span><span class="n">true</span><span class="p">.,</span><span class="n">Nz</span><span class="p">))</span><span class="o">//</span><span class="n">end_rec</span>
    <span class="k">write</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="s1">&#39;POINTS &#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(.</span><span class="n">true</span><span class="p">.,</span><span class="n">NN</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39; float&#39;</span><span class="o">//</span><span class="n">end_rec</span>
    <span class="k">write</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="n">XYZ</span>
    <span class="k">write</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="n">end_rec</span>
  <span class="n">endselect</span>
  <span class="k">return</span>
  <span class="c">!---------------------------------------------------------------------------------------------------------------------------------</span>
  <span class="n">endfunction</span> <span class="n">VTK_GEO_STRG_3DAP_R4</span>

  <span class="c">!&gt; Function for saving mesh with \b RECTILINEAR_GRID topology (R8P).</span>
  <span class="c">!&gt; @return E_IO: integer(I4P) error flag</span>
  <span class="k">function </span><span class="n">VTK_GEO_RECT_R8</span><span class="p">(</span><span class="n">Nx</span><span class="p">,</span><span class="n">Ny</span><span class="p">,</span><span class="n">Nz</span><span class="p">,</span><span class="n">X</span><span class="p">,</span><span class="n">Y</span><span class="p">,</span><span class="n">Z</span><span class="p">,</span><span class="n">cf</span><span class="p">)</span> <span class="k">result</span><span class="p">(</span><span class="n">E_IO</span><span class="p">)</span>
  <span class="c">!---------------------------------------------------------------------------------------------------------------------------------</span>
  <span class="k">implicit none</span>
<span class="k">  </span><span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span><span class="kd">::</span>           <span class="n">Nx</span>       <span class="c">!&lt; Number of nodes in x direction.</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span><span class="kd">::</span>           <span class="n">Ny</span>       <span class="c">!&lt; Number of nodes in y direction.</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span><span class="kd">::</span>           <span class="n">Nz</span>       <span class="c">!&lt; Number of nodes in z direction.</span>
  <span class="kt">real</span><span class="p">(</span><span class="n">R8P</span><span class="p">),</span>    <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span><span class="kd">::</span>           <span class="n">X</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">Nx</span><span class="p">)</span>  <span class="c">!&lt; X coordinates.</span>
  <span class="kt">real</span><span class="p">(</span><span class="n">R8P</span><span class="p">),</span>    <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span><span class="kd">::</span>           <span class="n">Y</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">Ny</span><span class="p">)</span>  <span class="c">!&lt; Y coordinates.</span>
  <span class="kt">real</span><span class="p">(</span><span class="n">R8P</span><span class="p">),</span>    <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span><span class="kd">::</span>           <span class="n">Z</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">Nz</span><span class="p">)</span>  <span class="c">!&lt; Z coordinates.</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">),</span> <span class="k">optional</span><span class="kd">::</span> <span class="n">cf</span>       <span class="c">!&lt; Current file index (for concurrent files IO).</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">)</span><span class="kd">::</span>                       <span class="n">E_IO</span>     <span class="c">!&lt; Input/Output inquiring flag: $0$ if IO is done, $&gt; 0$ if IO is not done.</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">)</span><span class="kd">::</span>                       <span class="n">rf</span>       <span class="c">!&lt; Real file index.</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">)</span><span class="kd">::</span>                       <span class="n">n1</span>       <span class="c">!&lt; Counter.</span>
  <span class="c">!---------------------------------------------------------------------------------------------------------------------------------</span>

  <span class="c">!---------------------------------------------------------------------------------------------------------------------------------</span>
  <span class="n">E_IO</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1_I4P</span>
  <span class="n">rf</span> <span class="o">=</span> <span class="n">f</span>
  <span class="k">if</span> <span class="p">(</span><span class="nb">present</span><span class="p">(</span><span class="n">cf</span><span class="p">))</span> <span class="k">then</span>
<span class="k">    </span><span class="n">rf</span> <span class="o">=</span> <span class="n">cf</span> <span class="p">;</span> <span class="n">f</span> <span class="o">=</span> <span class="n">cf</span>
  <span class="n">endif</span>
  <span class="k">select case</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">f</span><span class="p">)</span>
  <span class="k">case</span><span class="p">(</span><span class="n">ascii</span><span class="p">)</span>
    <span class="k">write</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="s1">&#39;(A)&#39;</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="s1">&#39;DIMENSIONS &#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(.</span><span class="n">true</span><span class="p">.,</span><span class="n">Nx</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39; &#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(.</span><span class="n">true</span><span class="p">.,</span><span class="n">Ny</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39; &#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(.</span><span class="n">true</span><span class="p">.,</span><span class="n">Nz</span><span class="p">))</span>
    <span class="k">write</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="s1">&#39;(A)&#39;</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="s1">&#39;X_COORDINATES &#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(.</span><span class="n">true</span><span class="p">.,</span><span class="n">Nx</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39; double&#39;</span>
    <span class="k">do </span><span class="n">n1</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">Nx</span>
      <span class="k">write</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="s1">&#39;(A)&#39;</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="n">str</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">X</span><span class="p">(</span><span class="n">n1</span><span class="p">))</span>
    <span class="n">enddo</span>
    <span class="k">write</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="s1">&#39;(A)&#39;</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="s1">&#39;Y_COORDINATES &#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(.</span><span class="n">true</span><span class="p">.,</span><span class="n">Ny</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39; double&#39;</span>
    <span class="k">do </span><span class="n">n1</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">Ny</span>
      <span class="k">write</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="s1">&#39;(A)&#39;</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="n">str</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">Y</span><span class="p">(</span><span class="n">n1</span><span class="p">))</span>
    <span class="n">enddo</span>
    <span class="k">write</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="s1">&#39;(A)&#39;</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="s1">&#39;Z_COORDINATES &#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(.</span><span class="n">true</span><span class="p">.,</span><span class="n">Nz</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39; double&#39;</span>
    <span class="k">do </span><span class="n">n1</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">Nz</span>
      <span class="k">write</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="s1">&#39;(A)&#39;</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="n">str</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">Z</span><span class="p">(</span><span class="n">n1</span><span class="p">))</span>
    <span class="n">enddo</span>
  <span class="k">case</span><span class="p">(</span><span class="n">raw</span><span class="p">)</span>
    <span class="k">write</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="s1">&#39;DIMENSIONS &#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(.</span><span class="n">true</span><span class="p">.,</span><span class="n">Nx</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39; &#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(.</span><span class="n">true</span><span class="p">.,</span><span class="n">Ny</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39; &#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(.</span><span class="n">true</span><span class="p">.,</span><span class="n">Nz</span><span class="p">))</span><span class="o">//</span><span class="n">end_rec</span>
    <span class="k">write</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="s1">&#39;X_COORDINATES &#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(.</span><span class="n">true</span><span class="p">.,</span><span class="n">Nx</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39; double&#39;</span><span class="o">//</span><span class="n">end_rec</span>
    <span class="k">write</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="n">X</span>
    <span class="k">write</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="n">end_rec</span>
    <span class="k">write</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="s1">&#39;Y_COORDINATES &#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(.</span><span class="n">true</span><span class="p">.,</span><span class="n">Ny</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39; double&#39;</span><span class="o">//</span><span class="n">end_rec</span>
    <span class="k">write</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="n">Y</span>
    <span class="k">write</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="n">end_rec</span>
    <span class="k">write</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="s1">&#39;Z_COORDINATES &#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(.</span><span class="n">true</span><span class="p">.,</span><span class="n">Nz</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39; double&#39;</span><span class="o">//</span><span class="n">end_rec</span>
    <span class="k">write</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="n">Z</span>
    <span class="k">write</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="n">end_rec</span>
  <span class="n">endselect</span>
  <span class="k">return</span>
  <span class="c">!---------------------------------------------------------------------------------------------------------------------------------</span>
  <span class="n">endfunction</span> <span class="n">VTK_GEO_RECT_R8</span>

  <span class="c">!&gt; Function for saving mesh with \b RECTILINEAR_GRID topology (R4P).</span>
  <span class="c">!&gt; @return E_IO: integer(I4P) error flag</span>
  <span class="k">function </span><span class="n">VTK_GEO_RECT_R4</span><span class="p">(</span><span class="n">Nx</span><span class="p">,</span><span class="n">Ny</span><span class="p">,</span><span class="n">Nz</span><span class="p">,</span><span class="n">X</span><span class="p">,</span><span class="n">Y</span><span class="p">,</span><span class="n">Z</span><span class="p">,</span><span class="n">cf</span><span class="p">)</span> <span class="k">result</span><span class="p">(</span><span class="n">E_IO</span><span class="p">)</span>
  <span class="c">!---------------------------------------------------------------------------------------------------------------------------------</span>
  <span class="k">implicit none</span>
<span class="k">  </span><span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span><span class="kd">::</span>           <span class="n">Nx</span>       <span class="c">!&lt; Number of nodes in x direction.</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span><span class="kd">::</span>           <span class="n">Ny</span>       <span class="c">!&lt; Number of nodes in y direction.</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span><span class="kd">::</span>           <span class="n">Nz</span>       <span class="c">!&lt; Number of nodes in z direction.</span>
  <span class="kt">real</span><span class="p">(</span><span class="n">R4P</span><span class="p">),</span>    <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span><span class="kd">::</span>           <span class="n">X</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">Nx</span><span class="p">)</span>  <span class="c">!&lt; X coordinates.</span>
  <span class="kt">real</span><span class="p">(</span><span class="n">R4P</span><span class="p">),</span>    <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span><span class="kd">::</span>           <span class="n">Y</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">Ny</span><span class="p">)</span>  <span class="c">!&lt; Y coordinates.</span>
  <span class="kt">real</span><span class="p">(</span><span class="n">R4P</span><span class="p">),</span>    <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span><span class="kd">::</span>           <span class="n">Z</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">Nz</span><span class="p">)</span>  <span class="c">!&lt; Z coordinates.</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">),</span> <span class="k">optional</span><span class="kd">::</span> <span class="n">cf</span>       <span class="c">!&lt; Current file index (for concurrent files IO).</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">)</span><span class="kd">::</span>                       <span class="n">E_IO</span>     <span class="c">!&lt; Input/Output inquiring flag: $0$ if IO is done, $&gt; 0$ if IO is not done.</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">)</span><span class="kd">::</span>                       <span class="n">rf</span>       <span class="c">!&lt; Real file index.</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">)</span><span class="kd">::</span>                       <span class="n">n1</span>       <span class="c">!&lt; Counter.</span>
  <span class="c">!---------------------------------------------------------------------------------------------------------------------------------</span>

  <span class="c">!---------------------------------------------------------------------------------------------------------------------------------</span>
  <span class="n">E_IO</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1_I4P</span>
  <span class="n">rf</span> <span class="o">=</span> <span class="n">f</span>
  <span class="k">if</span> <span class="p">(</span><span class="nb">present</span><span class="p">(</span><span class="n">cf</span><span class="p">))</span> <span class="k">then</span>
<span class="k">    </span><span class="n">rf</span> <span class="o">=</span> <span class="n">cf</span> <span class="p">;</span> <span class="n">f</span> <span class="o">=</span> <span class="n">cf</span>
  <span class="n">endif</span>
  <span class="k">select case</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">f</span><span class="p">)</span>
  <span class="k">case</span><span class="p">(</span><span class="n">ascii</span><span class="p">)</span>
    <span class="k">write</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="s1">&#39;(A)&#39;</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="s1">&#39;DIMENSIONS &#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(.</span><span class="n">true</span><span class="p">.,</span><span class="n">Nx</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39; &#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(.</span><span class="n">true</span><span class="p">.,</span><span class="n">Ny</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39; &#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(.</span><span class="n">true</span><span class="p">.,</span><span class="n">Nz</span><span class="p">))</span>
    <span class="k">write</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="s1">&#39;(A)&#39;</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="s1">&#39;X_COORDINATES &#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(.</span><span class="n">true</span><span class="p">.,</span><span class="n">Nx</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39; float&#39;</span>
    <span class="k">do </span><span class="n">n1</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">Nx</span>
      <span class="k">write</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="s1">&#39;(A)&#39;</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="n">str</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">X</span><span class="p">(</span><span class="n">n1</span><span class="p">))</span>
    <span class="n">enddo</span>
    <span class="k">write</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="s1">&#39;(A)&#39;</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="s1">&#39;Y_COORDINATES &#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(.</span><span class="n">true</span><span class="p">.,</span><span class="n">Ny</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39; float&#39;</span>
    <span class="k">do </span><span class="n">n1</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">Ny</span>
      <span class="k">write</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="s1">&#39;(A)&#39;</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="n">str</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">Y</span><span class="p">(</span><span class="n">n1</span><span class="p">))</span>
    <span class="n">enddo</span>
    <span class="k">write</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="s1">&#39;(A)&#39;</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="s1">&#39;Z_COORDINATES &#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(.</span><span class="n">true</span><span class="p">.,</span><span class="n">Nz</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39; float&#39;</span>
    <span class="k">do </span><span class="n">n1</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">Nz</span>
      <span class="k">write</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="s1">&#39;(A)&#39;</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="n">str</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">Z</span><span class="p">(</span><span class="n">n1</span><span class="p">))</span>
    <span class="n">enddo</span>
  <span class="k">case</span><span class="p">(</span><span class="n">raw</span><span class="p">)</span>
    <span class="k">write</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="s1">&#39;DIMENSIONS &#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(.</span><span class="n">true</span><span class="p">.,</span><span class="n">Nx</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39; &#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(.</span><span class="n">true</span><span class="p">.,</span><span class="n">Ny</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39; &#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(.</span><span class="n">true</span><span class="p">.,</span><span class="n">Nz</span><span class="p">))</span><span class="o">//</span><span class="n">end_rec</span>
    <span class="k">write</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="s1">&#39;X_COORDINATES &#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(.</span><span class="n">true</span><span class="p">.,</span><span class="n">Nx</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39; float&#39;</span><span class="o">//</span><span class="n">end_rec</span>
    <span class="k">write</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="n">X</span>
    <span class="k">write</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="n">end_rec</span>
    <span class="k">write</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="s1">&#39;Y_COORDINATES &#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(.</span><span class="n">true</span><span class="p">.,</span><span class="n">Ny</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39; float&#39;</span><span class="o">//</span><span class="n">end_rec</span>
    <span class="k">write</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="n">Y</span>
    <span class="k">write</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="n">end_rec</span>
    <span class="k">write</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="s1">&#39;Z_COORDINATES &#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">str</span><span class="p">(.</span><span class="n">true</span><span class="p">.,</span><span class="n">Nz</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39; float&#39;</span><span class="o">//</span><span class="n">end_rec</span>
    <span class="k">write</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="n">Z</span>
    <span class="k">write</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="n">end_rec</span>
  <span class="n">endselect</span>
  <span class="k">return</span>
  <span class="c">!---------------------------------------------------------------------------------------------------------------------------------</span>
  <span class="n">endfunction</span> <span class="n">VTK_GEO_RECT_R4</span>

  <span class="c">!&gt; Function for saving mesh with \b UNSTRUCTURED_GRID topology (R8P).</span>
  <span class="c">!&gt; @return E_IO: integer(I4P) error flag</span>
  <span class="k">function </span><span class="n">VTK_GEO_UNST_R8</span><span class="p">(</span><span class="n">NN</span><span class="p">,</span><span class="n">X</span><span class="p">,</span><span class="n">Y</span><span class="p">,</span><span class="n">Z</span><span class="p">,</span><span class="n">cf</span><span class="p">)</span> <span class="k">result</span><span class="p">(</span><span class="n">E_IO</span><span class="p">)</span>
  <span class="c">!---------------------------------------------------------------------------------------------------------------------------------</span>
  <span class="k">implicit none</span>
<span class="k">  </span><span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span><span class="kd">::</span>           <span class="n">NN</span>       <span class="c">!&lt; Number of nodes.</span>
  <span class="kt">real</span><span class="p">(</span><span class="n">R8P</span><span class="p">),</span>    <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span><span class="kd">::</span>           <span class="n">X</span><span class="p">(</span><span class="mi">1</span><span class="p">:)</span>    <span class="c">!&lt; X coordinates of all nodes [1:NN].</span>
  <span class="kt">real</span><span class="p">(</span><span class="n">R8P</span><span class="p">),</span>    <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span><span class="kd">::</span>           <span class="n">Y</span><span class="p">(</span><span class="mi">1</span><span class="p">:)</span>    <span class="c">!&lt; Y coordinates of all nodes [1:NN].</span>
  <span class="kt">real</span><span class="p">(</span><span class="n">R8P</span><span class="p">),</span>    <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span><span class="kd">::</span>           <span class="n">Z</span><span class="p">(</span><span class="mi">1</span><span class="p">:)</span>    <span class="c">!&lt; Z coordinates of all nodes [1:NN].</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">),</span> <span class="k">optional</span><span class="kd">::</span> <span class="n">cf</span>       <span class="c">!&lt; Current file index (for concurrent files IO).</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">)</span><span class="kd">::</span>                       <span class="n">E_IO</span>     <span class="c">!&lt; Input/Output inquiring flag: $0$ if IO is done, $&gt; 0$ if IO is not done.</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">)</span><span class="kd">::</span>                       <span class="n">rf</span>       <span class="c">!&lt; Real file index.</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">)</span><span class="kd">::</span>                       <span class="n">n1</span>       <span class="c">!&lt; Counter.</span>
  <span class="c">!---------------------------------------------------------------------------------------------------------------------------------</span>

  <span class="c">!---------------------------------------------------------------------------------------------------------------------------------</span>
  <span class="n">E_IO</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1_I4P</span>
  <span class="n">rf</span> <span class="o">=</span> <span class="n">f</span>
  <span class="k">if</span> <span class="p">(</span><span class="nb">present</span><span class="p">(</span><span class="n">cf</span><span class="p">))</span> <span class="k">then</span>
<span class="k">    </span><span class="n">rf</span> <span class="o">=</span> <span class="n">cf</span> <span class="p">;</span> <span class="n">f</span> <span class="o">=</span> <span class="n">cf</span>
  <span class="n">endif</span>
  <span class="k">select case</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">f</span><span class="p">)</span>
  <span class="k">case</span><span class="p">(</span><span class="n">ascii</span><span class="p">)</span>
    <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;(A)&#39;</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="s1">&#39;POINTS &#39;</span><span class="o">//</span><span class="n">str</span><span class="p">(.</span><span class="n">true</span><span class="p">.,</span><span class="n">NN</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39; double&#39;</span>
    <span class="k">do </span><span class="n">n1</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">NN</span>
      <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;(A)&#39;</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="n">str</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">X</span><span class="p">(</span><span class="n">n1</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39; &#39;</span><span class="o">//</span><span class="n">str</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">Y</span><span class="p">(</span><span class="n">n1</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39; &#39;</span><span class="o">//</span><span class="n">str</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">Z</span><span class="p">(</span><span class="n">n1</span><span class="p">))</span>
    <span class="n">enddo</span>
  <span class="k">case</span><span class="p">(</span><span class="n">raw</span><span class="p">)</span>
    <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="s1">&#39;POINTS &#39;</span><span class="o">//</span><span class="n">str</span><span class="p">(.</span><span class="n">true</span><span class="p">.,</span><span class="n">NN</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39; double&#39;</span><span class="o">//</span><span class="n">end_rec</span>
    <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)(</span><span class="n">X</span><span class="p">(</span><span class="n">n1</span><span class="p">),</span><span class="n">Y</span><span class="p">(</span><span class="n">n1</span><span class="p">),</span><span class="n">Z</span><span class="p">(</span><span class="n">n1</span><span class="p">),</span><span class="n">n1</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">NN</span><span class="p">)</span>
    <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="n">end_rec</span>
  <span class="n">endselect</span>
  <span class="k">return</span>
  <span class="c">!---------------------------------------------------------------------------------------------------------------------------------</span>
  <span class="n">endfunction</span> <span class="n">VTK_GEO_UNST_R8</span>

  <span class="c">!&gt; Function for saving mesh with \b UNSTRUCTURED_GRID topology (R8P, packed API).</span>
  <span class="c">!&gt; @return E_IO: integer(I4P) error flag</span>
  <span class="k">function </span><span class="n">VTK_GEO_UNST_P_R8</span><span class="p">(</span><span class="n">NN</span><span class="p">,</span><span class="n">XYZ</span><span class="p">,</span><span class="n">cf</span><span class="p">)</span> <span class="k">result</span><span class="p">(</span><span class="n">E_IO</span><span class="p">)</span>
  <span class="c">!---------------------------------------------------------------------------------------------------------------------------------</span>
  <span class="k">implicit none</span>
<span class="k">  </span><span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span><span class="kd">::</span>           <span class="n">NN</span>         <span class="c">!&lt; Number of nodes.</span>
  <span class="kt">real</span><span class="p">(</span><span class="n">R8P</span><span class="p">),</span>    <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span><span class="kd">::</span>           <span class="n">XYZ</span><span class="p">(</span><span class="mi">1</span><span class="p">:,</span><span class="mi">1</span><span class="p">:)</span> <span class="c">!&lt; X, Y and Z coordinates of all nodes [1:3,1:NN].</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">),</span> <span class="k">optional</span><span class="kd">::</span> <span class="n">cf</span>         <span class="c">!&lt; Current file index (for concurrent files IO).</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">)</span><span class="kd">::</span>                       <span class="n">E_IO</span>       <span class="c">!&lt; Input/Output inquiring flag: $0$ if IO is done, $&gt; 0$ if IO is not done.</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">)</span><span class="kd">::</span>                       <span class="n">rf</span>         <span class="c">!&lt; Real file index.</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">)</span><span class="kd">::</span>                       <span class="n">n1</span>         <span class="c">!&lt; Counter.</span>
  <span class="c">!---------------------------------------------------------------------------------------------------------------------------------</span>

  <span class="c">!---------------------------------------------------------------------------------------------------------------------------------</span>
  <span class="n">E_IO</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1_I4P</span>
  <span class="n">rf</span> <span class="o">=</span> <span class="n">f</span>
  <span class="k">if</span> <span class="p">(</span><span class="nb">present</span><span class="p">(</span><span class="n">cf</span><span class="p">))</span> <span class="k">then</span>
<span class="k">    </span><span class="n">rf</span> <span class="o">=</span> <span class="n">cf</span> <span class="p">;</span> <span class="n">f</span> <span class="o">=</span> <span class="n">cf</span>
  <span class="n">endif</span>
  <span class="k">select case</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">f</span><span class="p">)</span>
  <span class="k">case</span><span class="p">(</span><span class="n">ascii</span><span class="p">)</span>
    <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;(A)&#39;</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="s1">&#39;POINTS &#39;</span><span class="o">//</span><span class="n">str</span><span class="p">(.</span><span class="n">true</span><span class="p">.,</span><span class="n">NN</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39; double&#39;</span>
    <span class="k">do </span><span class="n">n1</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">NN</span>
      <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;(A)&#39;</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="n">str</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">XYZ</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">n1</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39; &#39;</span><span class="o">//</span><span class="n">str</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">XYZ</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="n">n1</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39; &#39;</span><span class="o">//</span><span class="n">str</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">XYZ</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="n">n1</span><span class="p">))</span>
    <span class="n">enddo</span>
  <span class="k">case</span><span class="p">(</span><span class="n">raw</span><span class="p">)</span>
    <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="s1">&#39;POINTS &#39;</span><span class="o">//</span><span class="n">str</span><span class="p">(.</span><span class="n">true</span><span class="p">.,</span><span class="n">NN</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39; double&#39;</span><span class="o">//</span><span class="n">end_rec</span>
    <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="n">XYZ</span>
    <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="n">end_rec</span>
  <span class="n">endselect</span>
  <span class="k">return</span>
  <span class="c">!---------------------------------------------------------------------------------------------------------------------------------</span>
  <span class="n">endfunction</span> <span class="n">VTK_GEO_UNST_P_R8</span>

  <span class="c">!&gt; Function for saving mesh with \b UNSTRUCTURED_GRID topology (R4P).</span>
  <span class="c">!&gt; @return E_IO: integer(I4P) error flag</span>
  <span class="k">function </span><span class="n">VTK_GEO_UNST_R4</span><span class="p">(</span><span class="n">NN</span><span class="p">,</span><span class="n">X</span><span class="p">,</span><span class="n">Y</span><span class="p">,</span><span class="n">Z</span><span class="p">,</span><span class="n">cf</span><span class="p">)</span> <span class="k">result</span><span class="p">(</span><span class="n">E_IO</span><span class="p">)</span>
  <span class="c">!---------------------------------------------------------------------------------------------------------------------------------</span>
  <span class="k">implicit none</span>
<span class="k">  </span><span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span><span class="kd">::</span>           <span class="n">NN</span>       <span class="c">!&lt; number of nodes.</span>
  <span class="kt">real</span><span class="p">(</span><span class="n">R4P</span><span class="p">),</span>    <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span><span class="kd">::</span>           <span class="n">X</span><span class="p">(</span><span class="mi">1</span><span class="p">:)</span>    <span class="c">!&lt; X coordinates of all nodes [1:NN].</span>
  <span class="kt">real</span><span class="p">(</span><span class="n">R4P</span><span class="p">),</span>    <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span><span class="kd">::</span>           <span class="n">Y</span><span class="p">(</span><span class="mi">1</span><span class="p">:)</span>    <span class="c">!&lt; Y coordinates of all nodes [1:NN].</span>
  <span class="kt">real</span><span class="p">(</span><span class="n">R4P</span><span class="p">),</span>    <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span><span class="kd">::</span>           <span class="n">Z</span><span class="p">(</span><span class="mi">1</span><span class="p">:)</span>    <span class="c">!&lt; Z coordinates of all nodes [1:NN].</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">),</span> <span class="k">optional</span><span class="kd">::</span> <span class="n">cf</span>       <span class="c">!&lt; Current file index (for concurrent files IO).</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">)</span><span class="kd">::</span>                       <span class="n">E_IO</span>     <span class="c">!&lt; Input/Output inquiring flag: $0$ if IO is done, $&gt; 0$ if IO is not done.</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">)</span><span class="kd">::</span>                       <span class="n">rf</span>       <span class="c">!&lt; Real file index.</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">)</span><span class="kd">::</span>                       <span class="n">n1</span>       <span class="c">!&lt; counter.</span>
  <span class="c">!---------------------------------------------------------------------------------------------------------------------------------</span>

  <span class="c">!---------------------------------------------------------------------------------------------------------------------------------</span>
  <span class="n">E_IO</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1_I4P</span>
  <span class="n">rf</span> <span class="o">=</span> <span class="n">f</span>
  <span class="k">if</span> <span class="p">(</span><span class="nb">present</span><span class="p">(</span><span class="n">cf</span><span class="p">))</span> <span class="k">then</span>
<span class="k">    </span><span class="n">rf</span> <span class="o">=</span> <span class="n">cf</span> <span class="p">;</span> <span class="n">f</span> <span class="o">=</span> <span class="n">cf</span>
  <span class="n">endif</span>
  <span class="k">select case</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">f</span><span class="p">)</span>
  <span class="k">case</span><span class="p">(</span><span class="n">ascii</span><span class="p">)</span>
    <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;(A)&#39;</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="s1">&#39;POINTS &#39;</span><span class="o">//</span><span class="n">str</span><span class="p">(.</span><span class="n">true</span><span class="p">.,</span><span class="n">NN</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39; float&#39;</span>
    <span class="k">do </span><span class="n">n1</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">NN</span>
      <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;(A)&#39;</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="n">str</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">X</span><span class="p">(</span><span class="n">n1</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39; &#39;</span><span class="o">//</span><span class="n">str</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">Y</span><span class="p">(</span><span class="n">n1</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39; &#39;</span><span class="o">//</span><span class="n">str</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">Z</span><span class="p">(</span><span class="n">n1</span><span class="p">))</span>
    <span class="n">enddo</span>
  <span class="k">case</span><span class="p">(</span><span class="n">raw</span><span class="p">)</span>
    <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="s1">&#39;POINTS &#39;</span><span class="o">//</span><span class="n">str</span><span class="p">(.</span><span class="n">true</span><span class="p">.,</span><span class="n">NN</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39; float&#39;</span><span class="o">//</span><span class="n">end_rec</span>
    <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)(</span><span class="n">X</span><span class="p">(</span><span class="n">n1</span><span class="p">),</span><span class="n">Y</span><span class="p">(</span><span class="n">n1</span><span class="p">),</span><span class="n">Z</span><span class="p">(</span><span class="n">n1</span><span class="p">),</span><span class="n">n1</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">NN</span><span class="p">)</span>
    <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="n">end_rec</span>
  <span class="n">endselect</span>
  <span class="k">return</span>
  <span class="c">!---------------------------------------------------------------------------------------------------------------------------------</span>
  <span class="n">endfunction</span> <span class="n">VTK_GEO_UNST_R4</span>

  <span class="c">!&gt; Function for saving mesh with \b UNSTRUCTURED_GRID topology (R4P, packed API).</span>
  <span class="c">!&gt; @return E_IO: integer(I4P) error flag</span>
  <span class="k">function </span><span class="n">VTK_GEO_UNST_P_R4</span><span class="p">(</span><span class="n">NN</span><span class="p">,</span><span class="n">XYZ</span><span class="p">,</span><span class="n">cf</span><span class="p">)</span> <span class="k">result</span><span class="p">(</span><span class="n">E_IO</span><span class="p">)</span>
  <span class="c">!---------------------------------------------------------------------------------------------------------------------------------</span>
  <span class="k">implicit none</span>
<span class="k">  </span><span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span><span class="kd">::</span>           <span class="n">NN</span>         <span class="c">!&lt; number of nodes.</span>
  <span class="kt">real</span><span class="p">(</span><span class="n">R4P</span><span class="p">),</span>    <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span><span class="kd">::</span>           <span class="n">XYZ</span><span class="p">(</span><span class="mi">1</span><span class="p">:,</span><span class="mi">1</span><span class="p">:)</span> <span class="c">!&lt; X, Y and Z coordinates of all nodes [1:3,1:NN].</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">),</span> <span class="k">optional</span><span class="kd">::</span> <span class="n">cf</span>         <span class="c">!&lt; Current file index (for concurrent files IO).</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">)</span><span class="kd">::</span>                       <span class="n">E_IO</span>       <span class="c">!&lt; Input/Output inquiring flag: $0$ if IO is done, $&gt; 0$ if IO is not done.</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">)</span><span class="kd">::</span>                       <span class="n">rf</span>         <span class="c">!&lt; Real file index.</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">)</span><span class="kd">::</span>                       <span class="n">n1</span>         <span class="c">!&lt; counter.</span>
  <span class="c">!---------------------------------------------------------------------------------------------------------------------------------</span>

  <span class="c">!---------------------------------------------------------------------------------------------------------------------------------</span>
  <span class="n">E_IO</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1_I4P</span>
  <span class="n">rf</span> <span class="o">=</span> <span class="n">f</span>
  <span class="k">if</span> <span class="p">(</span><span class="nb">present</span><span class="p">(</span><span class="n">cf</span><span class="p">))</span> <span class="k">then</span>
<span class="k">    </span><span class="n">rf</span> <span class="o">=</span> <span class="n">cf</span> <span class="p">;</span> <span class="n">f</span> <span class="o">=</span> <span class="n">cf</span>
  <span class="n">endif</span>
  <span class="k">select case</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">f</span><span class="p">)</span>
  <span class="k">case</span><span class="p">(</span><span class="n">ascii</span><span class="p">)</span>
    <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;(A)&#39;</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="s1">&#39;POINTS &#39;</span><span class="o">//</span><span class="n">str</span><span class="p">(.</span><span class="n">true</span><span class="p">.,</span><span class="n">NN</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39; float&#39;</span>
    <span class="k">do </span><span class="n">n1</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">NN</span>
      <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;(A)&#39;</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="n">str</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">XYZ</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">n1</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39; &#39;</span><span class="o">//</span><span class="n">str</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">XYZ</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="n">n1</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39; &#39;</span><span class="o">//</span><span class="n">str</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">XYZ</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="n">n1</span><span class="p">))</span>
    <span class="n">enddo</span>
  <span class="k">case</span><span class="p">(</span><span class="n">raw</span><span class="p">)</span>
    <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="s1">&#39;POINTS &#39;</span><span class="o">//</span><span class="n">str</span><span class="p">(.</span><span class="n">true</span><span class="p">.,</span><span class="n">NN</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39; float&#39;</span><span class="o">//</span><span class="n">end_rec</span>
    <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="n">XYZ</span>
    <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="n">end_rec</span>
  <span class="n">endselect</span>
  <span class="k">return</span>
  <span class="c">!---------------------------------------------------------------------------------------------------------------------------------</span>
  <span class="n">endfunction</span> <span class="n">VTK_GEO_UNST_P_R4</span>
  <span class="c">!&gt; @}</span>

  <span class="c">!&gt; Function that \b must be used when unstructured grid is used, it saves the connectivity of the unstructured gird.</span>
  <span class="c">!&gt; @note The vector \b connect must follow the VTK-legacy standard. It is passed as \em assumed-shape array</span>
  <span class="c">!&gt; because its dimensions is related to the mesh dimensions in a complex way. Its dimensions can be calculated by the following</span>
  <span class="c">!&gt; equation: \f$dc = NC + \sum\limits_{i = 1}^{NC} {nvertex_i }\f$</span>
  <span class="c">!&gt; where \f$dc\f$ is connectivity vector dimension and \f$nvertex_i\f$ is the number of vertices of \f$i^{th}\f$ cell. The VTK-</span>
  <span class="c">!&gt; legacy standard for the mesh connectivity is quite obscure at least at first sight. It is more simple analyzing an example.</span>
  <span class="c">!&gt; Suppose we have a mesh composed by 2 cells, one hexahedron (8 vertices) and one pyramid with square basis (5 vertices) and</span>
  <span class="c">!&gt; suppose that the basis of pyramid is constitute by a face of the hexahedron and so the two cells share 4 vertices.</span>
  <span class="c">!&gt; The above equation !&gt; gives \f$dc=2+8+5=15\f$. The connectivity vector for this mesh can be: \n</span>
  <span class="c">!&gt; first cell \n</span>
  <span class="c">!&gt; connect(1)  = 8  number of vertices of \f$1^\circ\f$ cell \n</span>
  <span class="c">!&gt; connect(2)  = 0  identification flag of \f$1^\circ\f$ vertex of 1° cell \n</span>
  <span class="c">!&gt; connect(3)  = 1  identification flag of \f$2^\circ\f$ vertex of 1° cell \n</span>
  <span class="c">!&gt; connect(4)  = 2  identification flag of \f$3^\circ\f$ vertex of 1° cell \n</span>
  <span class="c">!&gt; connect(5)  = 3  identification flag of \f$4^\circ\f$ vertex of 1° cell \n</span>
  <span class="c">!&gt; connect(6)  = 4  identification flag of \f$5^\circ\f$ vertex of 1° cell \n</span>
  <span class="c">!&gt; connect(7)  = 5  identification flag of \f$6^\circ\f$ vertex of 1° cell \n</span>
  <span class="c">!&gt; connect(8)  = 6  identification flag of \f$7^\circ\f$ vertex of 1° cell \n</span>
  <span class="c">!&gt; connect(9)  = 7  identification flag of \f$8^\circ\f$ vertex of 1° cell \n</span>
  <span class="c">!&gt; second cell \n</span>
  <span class="c">!&gt; connect(10) = 5  number of vertices of \f$2^\circ \f$cell \n</span>
  <span class="c">!&gt; connect(11) = 0  identification flag of \f$1^\circ\f$ vertex of 2° cell \n</span>
  <span class="c">!&gt; connect(12) = 1  identification flag of \f$2^\circ\f$ vertex of 2° cell \n</span>
  <span class="c">!&gt; connect(13) = 2  identification flag of \f$3^\circ\f$ vertex of 2° cell \n</span>
  <span class="c">!&gt; connect(14) = 3  identification flag of \f$4^\circ\f$ vertex of 2° cell \n</span>
  <span class="c">!&gt; connect(15) = 8  identification flag of \f$5^\circ\f$ vertex of 2° cell \n</span>
  <span class="c">!&gt; Note that the first 4 identification flags of pyramid vertices as the same of the first 4 identification flags of</span>
  <span class="c">!&gt; the hexahedron because the two cells share this face. It is also important to note that the identification flags start</span>
  <span class="c">!&gt; form $0$ value: this is impose to the VTK standard. The function VTK_CON does not calculate the connectivity vector: it</span>
  <span class="c">!&gt; writes the connectivity vector conforming the VTK standard, but does not calculate it.</span>
  <span class="c">!&gt; The vector variable \em cell_type must conform the VTK-legacy standard (see the file VTK-Standard at the</span>
  <span class="c">!&gt; Kitware homepage). It contains the</span>
  <span class="c">!&gt; \em type of each cells. For the above example this vector is: \n</span>
  <span class="c">!&gt; first cell \n</span>
  <span class="c">!&gt; cell_type(1) = 12 hexahedron type of \f$1^\circ\f$ cell \n</span>
  <span class="c">!&gt; second cell \n</span>
  <span class="c">!&gt; cell_type(2) = 14 pyramid type of \f$2^\circ\f$ cell \n</span>
  <span class="c">!&gt; @return E_IO: integer(I4P) error flag</span>
  <span class="c">!&gt; @ingroup Lib_VTK_IOPublicProcedure</span>
  <span class="k">function </span><span class="n">VTK_CON</span><span class="p">(</span><span class="n">NC</span><span class="p">,</span><span class="n">connect</span><span class="p">,</span><span class="n">cell_type</span><span class="p">,</span><span class="n">cf</span><span class="p">)</span> <span class="k">result</span><span class="p">(</span><span class="n">E_IO</span><span class="p">)</span>
  <span class="c">!---------------------------------------------------------------------------------------------------------------------------------</span>
  <span class="k">implicit none</span>
<span class="k">  </span><span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span><span class="kd">::</span>           <span class="n">NC</span>              <span class="c">!&lt; Number of cells.</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span><span class="kd">::</span>           <span class="n">connect</span><span class="p">(:)</span>      <span class="c">!&lt; Mesh connectivity.</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span><span class="kd">::</span>           <span class="n">cell_type</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">NC</span><span class="p">)</span> <span class="c">!&lt; VTK cell type.</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">),</span> <span class="k">optional</span><span class="kd">::</span> <span class="n">cf</span>              <span class="c">!&lt; Current file index (for concurrent files IO).</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">)</span><span class="kd">::</span>                       <span class="n">E_IO</span>            <span class="c">!&lt; Input/Output inquiring flag: $0$ if IO is done, $&gt; 0$ if IO is not done.</span>
  <span class="kt">character</span><span class="p">(</span><span class="nb">len</span><span class="o">=</span><span class="n">maxlen</span><span class="p">)</span><span class="kd">::</span>              <span class="n">s_buffer</span>        <span class="c">!&lt; Buffer string.</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">)</span><span class="kd">::</span>                       <span class="n">ncon</span>            <span class="c">!&lt; Dimension of connectivity vector.</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">)</span><span class="kd">::</span>                       <span class="n">rf</span>              <span class="c">!&lt; Real file index.</span>
  <span class="c">!---------------------------------------------------------------------------------------------------------------------------------</span>

  <span class="c">!---------------------------------------------------------------------------------------------------------------------------------</span>
  <span class="n">E_IO</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1_I4P</span>
  <span class="n">rf</span> <span class="o">=</span> <span class="n">f</span>
  <span class="k">if</span> <span class="p">(</span><span class="nb">present</span><span class="p">(</span><span class="n">cf</span><span class="p">))</span> <span class="k">then</span>
<span class="k">    </span><span class="n">rf</span> <span class="o">=</span> <span class="n">cf</span> <span class="p">;</span> <span class="n">f</span> <span class="o">=</span> <span class="n">cf</span>
  <span class="n">endif</span>
  <span class="n">ncon</span> <span class="o">=</span> <span class="n">size</span><span class="p">(</span><span class="n">connect</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
  <span class="k">select case</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">f</span><span class="p">)</span>
  <span class="k">case</span><span class="p">(</span><span class="n">ascii</span><span class="p">)</span>
    <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;(A,2&#39;</span><span class="o">//</span><span class="n">FI4P</span><span class="o">//</span><span class="s1">&#39;)&#39;</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="s1">&#39;CELLS &#39;</span><span class="p">,</span><span class="n">NC</span><span class="p">,</span><span class="n">ncon</span>
    <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">fmt</span><span class="o">=</span><span class="n">FI4P</span><span class="p">,</span>             <span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="n">connect</span>
    <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;(A,&#39;</span><span class="o">//</span><span class="n">FI4P</span><span class="o">//</span><span class="s1">&#39;)&#39;</span><span class="p">,</span> <span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="s1">&#39;CELL_TYPES &#39;</span><span class="p">,</span><span class="n">NC</span>
    <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">fmt</span><span class="o">=</span><span class="n">FI4P</span><span class="p">,</span>             <span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="n">cell_type</span>
  <span class="k">case</span><span class="p">(</span><span class="n">raw</span><span class="p">)</span>
    <span class="k">write</span><span class="p">(</span><span class="n">s_buffer</span><span class="p">,</span>      <span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;(A,2&#39;</span><span class="o">//</span><span class="n">FI4P</span><span class="o">//</span><span class="s1">&#39;)&#39;</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="s1">&#39;CELLS &#39;</span><span class="p">,</span><span class="n">NC</span><span class="p">,</span><span class="n">ncon</span>
    <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span>                      <span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">trim</span><span class="p">(</span><span class="n">s_buffer</span><span class="p">)</span><span class="o">//</span><span class="n">end_rec</span>
    <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span>                      <span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="n">connect</span>
    <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span>                      <span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="n">end_rec</span>
    <span class="k">write</span><span class="p">(</span><span class="n">s_buffer</span><span class="p">,</span>      <span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;(A,&#39;</span><span class="o">//</span><span class="n">FI4P</span><span class="o">//</span><span class="s1">&#39;)&#39;</span><span class="p">,</span> <span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="s1">&#39;CELL_TYPES &#39;</span><span class="p">,</span><span class="n">NC</span>
    <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span>                      <span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">trim</span><span class="p">(</span><span class="n">s_buffer</span><span class="p">)</span><span class="o">//</span><span class="n">end_rec</span>
    <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span>                      <span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="n">cell_type</span>
    <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span>                      <span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="n">end_rec</span>
  <span class="n">endselect</span>
  <span class="k">return</span>
  <span class="c">!---------------------------------------------------------------------------------------------------------------------------------</span>
  <span class="n">endfunction</span> <span class="n">VTK_CON</span>

  <span class="c">!&gt; Function that \b must be called before saving the data related to geometric mesh, this function initializes the</span>
  <span class="c">!&gt; saving of data variables indicating the \em type (node or cell centered) of variables that will be saved.</span>
  <span class="c">!&gt; @note A single file can contain both cell and node centered variables. In this case the VTK_DAT function must be</span>
  <span class="c">!&gt; called two times, before saving cell-centered variables and before saving node-centered variables.</span>
  <span class="c">!&gt; Examples of usage are: \n</span>
  <span class="c">!&gt; \b Node piece: \n</span>
  <span class="c">!&gt; @code ...</span>
  <span class="c">!&gt; E_IO=VTK_DAT(50,&#39;node&#39;)</span>
  <span class="c">!&gt; ... @endcode</span>
  <span class="c">!&gt; \b Cell piece: \n</span>
  <span class="c">!&gt; @code ...</span>
  <span class="c">!&gt; E_IO=VTK_DAT(50,&#39;cell&#39;)</span>
  <span class="c">!&gt; ... @endcode</span>
  <span class="c">!&gt; @return E_IO: integer(I4P) error flag</span>
  <span class="c">!&gt; @ingroup Lib_VTK_IOPublicProcedure</span>
  <span class="k">function </span><span class="n">VTK_DAT</span><span class="p">(</span><span class="n">NC_NN</span><span class="p">,</span><span class="n">var_location</span><span class="p">,</span><span class="n">cf</span><span class="p">)</span> <span class="k">result</span><span class="p">(</span><span class="n">E_IO</span><span class="p">)</span>
  <span class="c">!---------------------------------------------------------------------------------------------------------------------------------</span>
  <span class="k">implicit none</span>
<span class="k">  </span><span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span><span class="kd">::</span>           <span class="n">NC_NN</span>        <span class="c">!&lt; Number of cells or nodes of field.</span>
  <span class="kt">character</span><span class="p">(</span><span class="o">*</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span><span class="kd">::</span>           <span class="n">var_location</span> <span class="c">!&lt; Location of saving variables: cell for cell-centered, node for node-centered.</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">),</span> <span class="k">optional</span><span class="kd">::</span> <span class="n">cf</span>           <span class="c">!&lt; Current file index (for concurrent files IO).</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">)</span><span class="kd">::</span>                       <span class="n">E_IO</span>         <span class="c">!&lt; Input/Output inquiring flag: $0$ if IO is done, $&gt; 0$ if IO is not done.</span>
  <span class="kt">character</span><span class="p">(</span><span class="nb">len</span><span class="o">=</span><span class="n">maxlen</span><span class="p">)</span><span class="kd">::</span>              <span class="n">s_buffer</span>     <span class="c">!&lt; Buffer string.</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">)</span><span class="kd">::</span>                       <span class="n">rf</span>           <span class="c">!&lt; Real file index.</span>
  <span class="c">!---------------------------------------------------------------------------------------------------------------------------------</span>

  <span class="c">!---------------------------------------------------------------------------------------------------------------------------------</span>
  <span class="n">E_IO</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1_I4P</span>
  <span class="n">rf</span> <span class="o">=</span> <span class="n">f</span>
  <span class="k">if</span> <span class="p">(</span><span class="nb">present</span><span class="p">(</span><span class="n">cf</span><span class="p">))</span> <span class="k">then</span>
<span class="k">    </span><span class="n">rf</span> <span class="o">=</span> <span class="n">cf</span> <span class="p">;</span> <span class="n">f</span> <span class="o">=</span> <span class="n">cf</span>
  <span class="n">endif</span>
  <span class="k">select case</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">f</span><span class="p">)</span>
  <span class="k">case</span><span class="p">(</span><span class="n">ascii</span><span class="p">)</span>
    <span class="k">select case</span><span class="p">(</span><span class="nb">trim</span><span class="p">(</span><span class="n">Upper_Case</span><span class="p">(</span><span class="n">var_location</span><span class="p">)))</span>
    <span class="k">case</span><span class="p">(</span><span class="s1">&#39;CELL&#39;</span><span class="p">)</span>
      <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;(A,&#39;</span><span class="o">//</span><span class="n">FI4P</span><span class="o">//</span><span class="s1">&#39;)&#39;</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="s1">&#39;CELL_DATA &#39;</span><span class="p">,</span><span class="n">NC_NN</span>
    <span class="k">case</span><span class="p">(</span><span class="s1">&#39;NODE&#39;</span><span class="p">)</span>
      <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;(A,&#39;</span><span class="o">//</span><span class="n">FI4P</span><span class="o">//</span><span class="s1">&#39;)&#39;</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="s1">&#39;POINT_DATA &#39;</span><span class="p">,</span><span class="n">NC_NN</span>
    <span class="n">endselect</span>
  <span class="k">case</span><span class="p">(</span><span class="n">raw</span><span class="p">)</span>
    <span class="k">select case</span><span class="p">(</span><span class="nb">trim</span><span class="p">(</span><span class="n">Upper_Case</span><span class="p">(</span><span class="n">var_location</span><span class="p">)))</span>
    <span class="k">case</span><span class="p">(</span><span class="s1">&#39;CELL&#39;</span><span class="p">)</span>
      <span class="k">write</span><span class="p">(</span><span class="n">s_buffer</span><span class="p">,</span><span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;(A,&#39;</span><span class="o">//</span><span class="n">FI4P</span><span class="o">//</span><span class="s1">&#39;)&#39;</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="s1">&#39;CELL_DATA &#39;</span><span class="p">,</span><span class="n">NC_NN</span>
      <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">trim</span><span class="p">(</span><span class="n">s_buffer</span><span class="p">)</span><span class="o">//</span><span class="n">end_rec</span>
    <span class="k">case</span><span class="p">(</span><span class="s1">&#39;NODE&#39;</span><span class="p">)</span>
      <span class="k">write</span><span class="p">(</span><span class="n">s_buffer</span><span class="p">,</span><span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;(A,&#39;</span><span class="o">//</span><span class="n">FI4P</span><span class="o">//</span><span class="s1">&#39;)&#39;</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="s1">&#39;POINT_DATA &#39;</span><span class="p">,</span><span class="n">NC_NN</span>
      <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">trim</span><span class="p">(</span><span class="n">s_buffer</span><span class="p">)</span><span class="o">//</span><span class="n">end_rec</span>
    <span class="n">endselect</span>
  <span class="n">endselect</span>
  <span class="k">return</span>
  <span class="c">!---------------------------------------------------------------------------------------------------------------------------------</span>
  <span class="n">endfunction</span> <span class="n">VTK_DAT</span>

  <span class="c">!&gt; @ingroup Lib_VTK_IOPrivateProcedure</span>
  <span class="c">!&gt; @{</span>
  <span class="c">!&gt; Function for saving field of scalar variable (R8P).</span>
  <span class="c">!&gt; @return E_IO: integer(I4P) error flag</span>
  <span class="k">function </span><span class="n">VTK_VAR_SCAL_R8</span><span class="p">(</span><span class="n">NC_NN</span><span class="p">,</span><span class="n">varname</span><span class="p">,</span><span class="n">var</span><span class="p">,</span><span class="n">cf</span><span class="p">)</span> <span class="k">result</span><span class="p">(</span><span class="n">E_IO</span><span class="p">)</span>
  <span class="c">!---------------------------------------------------------------------------------------------------------------------------------</span>
  <span class="k">implicit none</span>
<span class="k">  </span><span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span><span class="kd">::</span>           <span class="n">NC_NN</span>        <span class="c">!&lt; Number of nodes or cells.</span>
  <span class="kt">character</span><span class="p">(</span><span class="o">*</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span><span class="kd">::</span>           <span class="n">varname</span>      <span class="c">!&lt; Variable name.</span>
  <span class="kt">real</span><span class="p">(</span><span class="n">R8P</span><span class="p">),</span>    <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span><span class="kd">::</span>           <span class="n">var</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">NC_NN</span><span class="p">)</span> <span class="c">!&lt; Variable to be saved.</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">),</span> <span class="k">optional</span><span class="kd">::</span> <span class="n">cf</span>           <span class="c">!&lt; Current file index (for concurrent files IO).</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">)</span><span class="kd">::</span>                       <span class="n">E_IO</span>         <span class="c">!&lt; Input/Output inquiring flag: $0$ if IO is done, $&gt; 0$ if IO is not done.</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">)</span><span class="kd">::</span>                       <span class="n">rf</span>           <span class="c">!&lt; Real file index.</span>
  <span class="c">!---------------------------------------------------------------------------------------------------------------------------------</span>

  <span class="c">!---------------------------------------------------------------------------------------------------------------------------------</span>
  <span class="n">E_IO</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1_I4P</span>
  <span class="n">rf</span> <span class="o">=</span> <span class="n">f</span>
  <span class="k">if</span> <span class="p">(</span><span class="nb">present</span><span class="p">(</span><span class="n">cf</span><span class="p">))</span> <span class="k">then</span>
<span class="k">    </span><span class="n">rf</span> <span class="o">=</span> <span class="n">cf</span> <span class="p">;</span> <span class="n">f</span> <span class="o">=</span> <span class="n">cf</span>
  <span class="n">endif</span>
  <span class="k">select case</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">f</span><span class="p">)</span>
  <span class="k">case</span><span class="p">(</span><span class="n">ascii</span><span class="p">)</span>
    <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;(A)&#39;</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="s1">&#39;SCALARS &#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">varname</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39; double 1&#39;</span>
    <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;(A)&#39;</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="s1">&#39;LOOKUP_TABLE default&#39;</span>
    <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">fmt</span><span class="o">=</span><span class="n">FR8P</span><span class="p">,</span> <span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="n">var</span>
  <span class="k">case</span><span class="p">(</span><span class="n">raw</span><span class="p">)</span>
    <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="s1">&#39;SCALARS &#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">varname</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39; double 1&#39;</span><span class="o">//</span><span class="n">end_rec</span>
    <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="s1">&#39;LOOKUP_TABLE default&#39;</span><span class="o">//</span><span class="n">end_rec</span>
    <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="n">var</span>
    <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="n">end_rec</span>
  <span class="n">endselect</span>
  <span class="k">return</span>
  <span class="c">!---------------------------------------------------------------------------------------------------------------------------------</span>
  <span class="n">endfunction</span> <span class="n">VTK_VAR_SCAL_R8</span>

  <span class="c">!&gt; Function for saving field of scalar variable (R4P).</span>
  <span class="c">!&gt; @return E_IO: integer(I4P) error flag</span>
  <span class="k">function </span><span class="n">VTK_VAR_SCAL_R4</span><span class="p">(</span><span class="n">NC_NN</span><span class="p">,</span><span class="n">varname</span><span class="p">,</span><span class="n">var</span><span class="p">,</span><span class="n">cf</span><span class="p">)</span> <span class="k">result</span><span class="p">(</span><span class="n">E_IO</span><span class="p">)</span>
  <span class="c">!---------------------------------------------------------------------------------------------------------------------------------</span>
  <span class="k">implicit none</span>
<span class="k">  </span><span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span><span class="kd">::</span>           <span class="n">NC_NN</span>        <span class="c">!&lt; Number of nodes or cells.</span>
  <span class="kt">character</span><span class="p">(</span><span class="o">*</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span><span class="kd">::</span>           <span class="n">varname</span>      <span class="c">!&lt; Variable name.</span>
  <span class="kt">real</span><span class="p">(</span><span class="n">R4P</span><span class="p">),</span>    <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span><span class="kd">::</span>           <span class="n">var</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">NC_NN</span><span class="p">)</span> <span class="c">!&lt; Variable to be saved.</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">),</span> <span class="k">optional</span><span class="kd">::</span> <span class="n">cf</span>           <span class="c">!&lt; Current file index (for concurrent files IO).</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">)</span><span class="kd">::</span>                       <span class="n">E_IO</span>         <span class="c">!&lt; Input/Output inquiring flag: $0$ if IO is done, $&gt; 0$ if IO is not done.</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">)</span><span class="kd">::</span>                       <span class="n">rf</span>           <span class="c">!&lt; Real file index.</span>
  <span class="c">!---------------------------------------------------------------------------------------------------------------------------------</span>

  <span class="c">!---------------------------------------------------------------------------------------------------------------------------------</span>
  <span class="n">E_IO</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1_I4P</span>
  <span class="n">rf</span> <span class="o">=</span> <span class="n">f</span>
  <span class="k">if</span> <span class="p">(</span><span class="nb">present</span><span class="p">(</span><span class="n">cf</span><span class="p">))</span> <span class="k">then</span>
<span class="k">    </span><span class="n">rf</span> <span class="o">=</span> <span class="n">cf</span> <span class="p">;</span> <span class="n">f</span> <span class="o">=</span> <span class="n">cf</span>
  <span class="n">endif</span>
  <span class="k">select case</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">f</span><span class="p">)</span>
  <span class="k">case</span><span class="p">(</span><span class="n">ascii</span><span class="p">)</span>
    <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;(A)&#39;</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="s1">&#39;SCALARS &#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">varname</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39; float 1&#39;</span>
    <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;(A)&#39;</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="s1">&#39;LOOKUP_TABLE default&#39;</span>
    <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">fmt</span><span class="o">=</span><span class="n">FR4P</span><span class="p">,</span> <span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="n">var</span>
  <span class="k">case</span><span class="p">(</span><span class="n">raw</span><span class="p">)</span>
    <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="s1">&#39;SCALARS &#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">varname</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39; float 1&#39;</span><span class="o">//</span><span class="n">end_rec</span>
    <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="s1">&#39;LOOKUP_TABLE default&#39;</span><span class="o">//</span><span class="n">end_rec</span>
    <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="n">var</span>
    <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="n">end_rec</span>
  <span class="n">endselect</span>
  <span class="k">return</span>
  <span class="c">!---------------------------------------------------------------------------------------------------------------------------------</span>
  <span class="n">endfunction</span> <span class="n">VTK_VAR_SCAL_R4</span>

  <span class="c">!&gt; Function for saving field of scalar variable (I4P).</span>
  <span class="c">!&gt; @return E_IO: integer(I4P) error flag</span>
  <span class="k">function </span><span class="n">VTK_VAR_SCAL_I4</span><span class="p">(</span><span class="n">NC_NN</span><span class="p">,</span><span class="n">varname</span><span class="p">,</span><span class="n">var</span><span class="p">,</span><span class="n">cf</span><span class="p">)</span> <span class="k">result</span><span class="p">(</span><span class="n">E_IO</span><span class="p">)</span>
  <span class="c">!---------------------------------------------------------------------------------------------------------------------------------</span>
  <span class="k">implicit none</span>
<span class="k">  </span><span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span><span class="kd">::</span>           <span class="n">NC_NN</span>        <span class="c">!&lt; Number of nodes or cells.</span>
  <span class="kt">character</span><span class="p">(</span><span class="o">*</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span><span class="kd">::</span>           <span class="n">varname</span>      <span class="c">!&lt; Variable name.</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span><span class="kd">::</span>           <span class="n">var</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">NC_NN</span><span class="p">)</span> <span class="c">!&lt; Variable to be saved.</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">),</span> <span class="k">optional</span><span class="kd">::</span> <span class="n">cf</span>           <span class="c">!&lt; Current file index (for concurrent files IO).</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">)</span><span class="kd">::</span>                       <span class="n">E_IO</span>         <span class="c">!&lt; Input/Output inquiring flag: $0$ if IO is done, $&gt; 0$ if IO is not done.</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">)</span><span class="kd">::</span>                       <span class="n">rf</span>           <span class="c">!&lt; Real file index.</span>
  <span class="c">!---------------------------------------------------------------------------------------------------------------------------------</span>

  <span class="c">!---------------------------------------------------------------------------------------------------------------------------------</span>
  <span class="n">E_IO</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1_I4P</span>
  <span class="n">rf</span> <span class="o">=</span> <span class="n">f</span>
  <span class="k">if</span> <span class="p">(</span><span class="nb">present</span><span class="p">(</span><span class="n">cf</span><span class="p">))</span> <span class="k">then</span>
<span class="k">    </span><span class="n">rf</span> <span class="o">=</span> <span class="n">cf</span> <span class="p">;</span> <span class="n">f</span> <span class="o">=</span> <span class="n">cf</span>
  <span class="n">endif</span>
  <span class="k">select case</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">f</span><span class="p">)</span>
  <span class="k">case</span><span class="p">(</span><span class="n">ascii</span><span class="p">)</span>
    <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;(A)&#39;</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="s1">&#39;SCALARS &#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">varname</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39; int 1&#39;</span>
    <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;(A)&#39;</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="s1">&#39;LOOKUP_TABLE default&#39;</span>
    <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">fmt</span><span class="o">=</span><span class="n">FI4P</span><span class="p">,</span> <span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="n">var</span>
  <span class="k">case</span><span class="p">(</span><span class="n">raw</span><span class="p">)</span>
    <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="s1">&#39;SCALARS &#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">varname</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39; int 1&#39;</span><span class="o">//</span><span class="n">end_rec</span>
    <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="s1">&#39;LOOKUP_TABLE default&#39;</span><span class="o">//</span><span class="n">end_rec</span>
    <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="n">var</span>
    <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="n">end_rec</span>
  <span class="n">endselect</span>
  <span class="k">return</span>
  <span class="c">!---------------------------------------------------------------------------------------------------------------------------------</span>
  <span class="n">endfunction</span> <span class="n">VTK_VAR_SCAL_I4</span>

  <span class="c">!&gt; Function for saving field of vectorial variable (R8P).</span>
  <span class="c">!&gt; @return E_IO: integer(I4P) error flag</span>
  <span class="k">function </span><span class="n">VTK_VAR_VECT_R8</span><span class="p">(</span><span class="n">vec_type</span><span class="p">,</span><span class="n">NC_NN</span><span class="p">,</span><span class="n">varname</span><span class="p">,</span><span class="n">varX</span><span class="p">,</span><span class="n">varY</span><span class="p">,</span><span class="n">varZ</span><span class="p">,</span><span class="n">cf</span><span class="p">)</span> <span class="k">result</span><span class="p">(</span><span class="n">E_IO</span><span class="p">)</span>
  <span class="c">!---------------------------------------------------------------------------------------------------------------------------------</span>
  <span class="k">implicit none</span>
<span class="k">  </span><span class="kt">character</span><span class="p">(</span><span class="o">*</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span><span class="kd">::</span>           <span class="n">vec_type</span>      <span class="c">!&lt; Vector type: vect = generic vector , norm = normal vector.</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span><span class="kd">::</span>           <span class="n">NC_NN</span>         <span class="c">!&lt; Number of nodes or cells.</span>
  <span class="kt">character</span><span class="p">(</span><span class="o">*</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span><span class="kd">::</span>           <span class="n">varname</span>       <span class="c">!&lt; Variable name.</span>
  <span class="kt">real</span><span class="p">(</span><span class="n">R8P</span><span class="p">),</span>    <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span><span class="kd">::</span>           <span class="n">varX</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">NC_NN</span><span class="p">)</span> <span class="c">!&lt; X component of vector.</span>
  <span class="kt">real</span><span class="p">(</span><span class="n">R8P</span><span class="p">),</span>    <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span><span class="kd">::</span>           <span class="n">varY</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">NC_NN</span><span class="p">)</span> <span class="c">!&lt; Y component of vector.</span>
  <span class="kt">real</span><span class="p">(</span><span class="n">R8P</span><span class="p">),</span>    <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span><span class="kd">::</span>           <span class="n">varZ</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">NC_NN</span><span class="p">)</span> <span class="c">!&lt; Z component of vector.</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">),</span> <span class="k">optional</span><span class="kd">::</span> <span class="n">cf</span>            <span class="c">!&lt; Current file index (for concurrent files IO).</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">)</span><span class="kd">::</span>                       <span class="n">E_IO</span>          <span class="c">!&lt; Input/Output inquiring flag: $0$ if IO is done, $&gt; 0$ if IO is not done.</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">)</span><span class="kd">::</span>                       <span class="n">rf</span>            <span class="c">!&lt; Real file index.</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">)</span><span class="kd">::</span>                       <span class="n">n1</span>            <span class="c">!&lt; Counter.</span>
  <span class="c">!---------------------------------------------------------------------------------------------------------------------------------</span>

  <span class="c">!---------------------------------------------------------------------------------------------------------------------------------</span>
  <span class="n">E_IO</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1_I4P</span>
  <span class="n">rf</span> <span class="o">=</span> <span class="n">f</span>
  <span class="k">if</span> <span class="p">(</span><span class="nb">present</span><span class="p">(</span><span class="n">cf</span><span class="p">))</span> <span class="k">then</span>
<span class="k">    </span><span class="n">rf</span> <span class="o">=</span> <span class="n">cf</span> <span class="p">;</span> <span class="n">f</span> <span class="o">=</span> <span class="n">cf</span>
  <span class="n">endif</span>
  <span class="k">select case</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">f</span><span class="p">)</span>
  <span class="k">case</span><span class="p">(</span><span class="n">ascii</span><span class="p">)</span>
    <span class="k">select case</span><span class="p">(</span><span class="n">Upper_Case</span><span class="p">(</span><span class="nb">trim</span><span class="p">(</span><span class="n">vec_type</span><span class="p">)))</span>
    <span class="k">case</span><span class="p">(</span><span class="s1">&#39;VECT&#39;</span><span class="p">)</span>
      <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;(A)&#39;</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="s1">&#39;VECTORS &#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">varname</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39; double&#39;</span>
    <span class="k">case</span><span class="p">(</span><span class="s1">&#39;NORM&#39;</span><span class="p">)</span>
      <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;(A)&#39;</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="s1">&#39;NORMALS &#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">varname</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39; double&#39;</span>
    <span class="n">endselect</span>
    <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;(3&#39;</span><span class="o">//</span><span class="n">FR8P</span><span class="o">//</span><span class="s1">&#39;)&#39;</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)(</span><span class="n">varX</span><span class="p">(</span><span class="n">n1</span><span class="p">),</span><span class="n">varY</span><span class="p">(</span><span class="n">n1</span><span class="p">),</span><span class="n">varZ</span><span class="p">(</span><span class="n">n1</span><span class="p">),</span><span class="n">n1</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">NC_NN</span><span class="p">)</span>
  <span class="k">case</span><span class="p">(</span><span class="n">raw</span><span class="p">)</span>
    <span class="k">select case</span><span class="p">(</span><span class="n">Upper_Case</span><span class="p">(</span><span class="nb">trim</span><span class="p">(</span><span class="n">vec_type</span><span class="p">)))</span>
    <span class="k">case</span><span class="p">(</span><span class="s1">&#39;VECT&#39;</span><span class="p">)</span>
      <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="s1">&#39;VECTORS &#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">varname</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39; double&#39;</span><span class="o">//</span><span class="n">end_rec</span>
    <span class="k">case</span><span class="p">(</span><span class="s1">&#39;NORM&#39;</span><span class="p">)</span>
      <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="s1">&#39;NORMALS &#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">varname</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39; double&#39;</span><span class="o">//</span><span class="n">end_rec</span>
    <span class="n">endselect</span>
    <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)(</span><span class="n">varX</span><span class="p">(</span><span class="n">n1</span><span class="p">),</span><span class="n">varY</span><span class="p">(</span><span class="n">n1</span><span class="p">),</span><span class="n">varZ</span><span class="p">(</span><span class="n">n1</span><span class="p">),</span><span class="n">n1</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">NC_NN</span><span class="p">)</span>
    <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="n">end_rec</span>
  <span class="n">endselect</span>
  <span class="k">return</span>
  <span class="c">!---------------------------------------------------------------------------------------------------------------------------------</span>
  <span class="n">endfunction</span> <span class="n">VTK_VAR_VECT_R8</span>

  <span class="c">!&gt; Function for saving field of vectorial variable (R4P).</span>
  <span class="c">!&gt; @return E_IO: integer(I4P) error flag</span>
  <span class="k">function </span><span class="n">VTK_VAR_VECT_R4</span><span class="p">(</span><span class="n">vec_type</span><span class="p">,</span><span class="n">NC_NN</span><span class="p">,</span><span class="n">varname</span><span class="p">,</span><span class="n">varX</span><span class="p">,</span><span class="n">varY</span><span class="p">,</span><span class="n">varZ</span><span class="p">,</span><span class="n">cf</span><span class="p">)</span> <span class="k">result</span><span class="p">(</span><span class="n">E_IO</span><span class="p">)</span>
  <span class="c">!---------------------------------------------------------------------------------------------------------------------------------</span>
  <span class="k">implicit none</span>
<span class="k">  </span><span class="kt">character</span><span class="p">(</span><span class="o">*</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span><span class="kd">::</span>           <span class="n">vec_type</span>      <span class="c">!&lt; Vector type: vect = generic vector , norm = normal vector.</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span><span class="kd">::</span>           <span class="n">NC_NN</span>         <span class="c">!&lt; Number of nodes or cells.</span>
  <span class="kt">character</span><span class="p">(</span><span class="o">*</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span><span class="kd">::</span>           <span class="n">varname</span>       <span class="c">!&lt; Variable name.</span>
  <span class="kt">real</span><span class="p">(</span><span class="n">R4P</span><span class="p">),</span>    <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span><span class="kd">::</span>           <span class="n">varX</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">NC_NN</span><span class="p">)</span> <span class="c">!&lt; X component of vector.</span>
  <span class="kt">real</span><span class="p">(</span><span class="n">R4P</span><span class="p">),</span>    <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span><span class="kd">::</span>           <span class="n">varY</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">NC_NN</span><span class="p">)</span> <span class="c">!&lt; Y component of vector.</span>
  <span class="kt">real</span><span class="p">(</span><span class="n">R4P</span><span class="p">),</span>    <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span><span class="kd">::</span>           <span class="n">varZ</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">NC_NN</span><span class="p">)</span> <span class="c">!&lt; Z component of vector.</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">),</span> <span class="k">optional</span><span class="kd">::</span> <span class="n">cf</span>            <span class="c">!&lt; Current file index (for concurrent files IO).</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">)</span><span class="kd">::</span>                       <span class="n">E_IO</span>          <span class="c">!&lt; Input/Output inquiring flag: $0$ if IO is done, $&gt; 0$ if IO is not done.</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">)</span><span class="kd">::</span>                       <span class="n">rf</span>            <span class="c">!&lt; Real file index.</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">)</span><span class="kd">::</span>                       <span class="n">n1</span>            <span class="c">!&lt; Counter.</span>
  <span class="c">!---------------------------------------------------------------------------------------------------------------------------------</span>

  <span class="c">!---------------------------------------------------------------------------------------------------------------------------------</span>
  <span class="n">E_IO</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1_I4P</span>
  <span class="n">rf</span> <span class="o">=</span> <span class="n">f</span>
  <span class="k">if</span> <span class="p">(</span><span class="nb">present</span><span class="p">(</span><span class="n">cf</span><span class="p">))</span> <span class="k">then</span>
<span class="k">    </span><span class="n">rf</span> <span class="o">=</span> <span class="n">cf</span> <span class="p">;</span> <span class="n">f</span> <span class="o">=</span> <span class="n">cf</span>
  <span class="n">endif</span>
  <span class="k">select case</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">f</span><span class="p">)</span>
  <span class="k">case</span><span class="p">(</span><span class="n">ascii</span><span class="p">)</span>
    <span class="k">select case</span><span class="p">(</span><span class="n">Upper_Case</span><span class="p">(</span><span class="nb">trim</span><span class="p">(</span><span class="n">vec_type</span><span class="p">)))</span>
    <span class="k">case</span><span class="p">(</span><span class="s1">&#39;vect&#39;</span><span class="p">)</span>
      <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;(A)&#39;</span><span class="p">,</span>          <span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="s1">&#39;VECTORS &#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">varname</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39; float&#39;</span>
    <span class="k">case</span><span class="p">(</span><span class="s1">&#39;norm&#39;</span><span class="p">)</span>
      <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;(A)&#39;</span><span class="p">,</span>          <span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="s1">&#39;NORMALS &#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">varname</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39; float&#39;</span>
    <span class="n">endselect</span>
    <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;(3&#39;</span><span class="o">//</span><span class="n">FR4P</span><span class="o">//</span><span class="s1">&#39;)&#39;</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)(</span><span class="n">varX</span><span class="p">(</span><span class="n">n1</span><span class="p">),</span><span class="n">varY</span><span class="p">(</span><span class="n">n1</span><span class="p">),</span><span class="n">varZ</span><span class="p">(</span><span class="n">n1</span><span class="p">),</span><span class="n">n1</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">NC_NN</span><span class="p">)</span>
  <span class="k">case</span><span class="p">(</span><span class="n">raw</span><span class="p">)</span>
    <span class="k">select case</span><span class="p">(</span><span class="n">Upper_Case</span><span class="p">(</span><span class="nb">trim</span><span class="p">(</span><span class="n">vec_type</span><span class="p">)))</span>
    <span class="k">case</span><span class="p">(</span><span class="s1">&#39;vect&#39;</span><span class="p">)</span>
      <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="s1">&#39;VECTORS &#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">varname</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39; float&#39;</span><span class="o">//</span><span class="n">end_rec</span>
    <span class="k">case</span><span class="p">(</span><span class="s1">&#39;norm&#39;</span><span class="p">)</span>
      <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="s1">&#39;NORMALS &#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">varname</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39; float&#39;</span><span class="o">//</span><span class="n">end_rec</span>
    <span class="n">endselect</span>
    <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)(</span><span class="n">varX</span><span class="p">(</span><span class="n">n1</span><span class="p">),</span><span class="n">varY</span><span class="p">(</span><span class="n">n1</span><span class="p">),</span><span class="n">varZ</span><span class="p">(</span><span class="n">n1</span><span class="p">),</span><span class="n">n1</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">NC_NN</span><span class="p">)</span>
    <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="n">end_rec</span>
  <span class="n">endselect</span>
  <span class="k">return</span>
  <span class="c">!---------------------------------------------------------------------------------------------------------------------------------</span>
  <span class="n">endfunction</span> <span class="n">VTK_VAR_VECT_R4</span>

  <span class="c">!&gt; Function for saving field of vectorial variable (I4P).</span>
  <span class="c">!&gt; @return E_IO: integer(I4P) error flag</span>
  <span class="k">function </span><span class="n">VTK_VAR_VECT_I4</span><span class="p">(</span><span class="n">NC_NN</span><span class="p">,</span><span class="n">varname</span><span class="p">,</span><span class="n">varX</span><span class="p">,</span><span class="n">varY</span><span class="p">,</span><span class="n">varZ</span><span class="p">,</span><span class="n">cf</span><span class="p">)</span> <span class="k">result</span><span class="p">(</span><span class="n">E_IO</span><span class="p">)</span>
  <span class="c">!---------------------------------------------------------------------------------------------------------------------------------</span>
  <span class="k">implicit none</span>
<span class="k">  </span><span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span><span class="kd">::</span>           <span class="n">NC_NN</span>         <span class="c">!&lt; Number of nodes or cells.</span>
  <span class="kt">character</span><span class="p">(</span><span class="o">*</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span><span class="kd">::</span>           <span class="n">varname</span>       <span class="c">!&lt; Variable name.</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span><span class="kd">::</span>           <span class="n">varX</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">NC_NN</span><span class="p">)</span> <span class="c">!&lt; X component of vector.</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span><span class="kd">::</span>           <span class="n">varY</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">NC_NN</span><span class="p">)</span> <span class="c">!&lt; Y component of vector.</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span><span class="kd">::</span>           <span class="n">varZ</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">NC_NN</span><span class="p">)</span> <span class="c">!&lt; Z component of vector.</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">),</span> <span class="k">optional</span><span class="kd">::</span> <span class="n">cf</span>            <span class="c">!&lt; Current file index (for concurrent files IO).</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">)</span><span class="kd">::</span>                       <span class="n">E_IO</span>          <span class="c">!&lt; Input/Output inquiring flag: $0$ if IO is done, $&gt; 0$ if IO is not done.</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">)</span><span class="kd">::</span>                       <span class="n">rf</span>            <span class="c">!&lt; Real file index.</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">)</span><span class="kd">::</span>                       <span class="n">n1</span>            <span class="c">!&lt; Counter.</span>
  <span class="c">!---------------------------------------------------------------------------------------------------------------------------------</span>

  <span class="c">!---------------------------------------------------------------------------------------------------------------------------------</span>
  <span class="n">E_IO</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1_I4P</span>
  <span class="n">rf</span> <span class="o">=</span> <span class="n">f</span>
  <span class="k">if</span> <span class="p">(</span><span class="nb">present</span><span class="p">(</span><span class="n">cf</span><span class="p">))</span> <span class="k">then</span>
<span class="k">    </span><span class="n">rf</span> <span class="o">=</span> <span class="n">cf</span> <span class="p">;</span> <span class="n">f</span> <span class="o">=</span> <span class="n">cf</span>
  <span class="n">endif</span>
  <span class="k">select case</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">f</span><span class="p">)</span>
  <span class="k">case</span><span class="p">(</span><span class="n">ascii</span><span class="p">)</span>
    <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;(A)&#39;</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="s1">&#39;VECTORS &#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">varname</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39; int&#39;</span>
    <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;(3&#39;</span><span class="o">//</span><span class="n">FI4P</span><span class="o">//</span><span class="s1">&#39;)&#39;</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)(</span><span class="n">varX</span><span class="p">(</span><span class="n">n1</span><span class="p">),</span><span class="n">varY</span><span class="p">(</span><span class="n">n1</span><span class="p">),</span><span class="n">varZ</span><span class="p">(</span><span class="n">n1</span><span class="p">),</span><span class="n">n1</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">NC_NN</span><span class="p">)</span>
  <span class="k">case</span><span class="p">(</span><span class="n">raw</span><span class="p">)</span>
    <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="s1">&#39;VECTORS &#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">varname</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39; int&#39;</span><span class="o">//</span><span class="n">end_rec</span>
    <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)(</span><span class="n">varX</span><span class="p">(</span><span class="n">n1</span><span class="p">),</span><span class="n">varY</span><span class="p">(</span><span class="n">n1</span><span class="p">),</span><span class="n">varZ</span><span class="p">(</span><span class="n">n1</span><span class="p">),</span><span class="n">n1</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">NC_NN</span><span class="p">)</span>
    <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="n">end_rec</span>
  <span class="n">endselect</span>
  <span class="k">return</span>
  <span class="c">!---------------------------------------------------------------------------------------------------------------------------------</span>
  <span class="n">endfunction</span> <span class="n">VTK_VAR_VECT_I4</span>

  <span class="c">!&gt; Function for saving texture variable (R8P).</span>
  <span class="c">!&gt; @return E_IO: integer(I4P) error flag</span>
  <span class="k">function </span><span class="n">VTK_VAR_TEXT_R8</span><span class="p">(</span><span class="n">NC_NN</span><span class="p">,</span><span class="n">dimm</span><span class="p">,</span><span class="n">varname</span><span class="p">,</span><span class="n">textCoo</span><span class="p">,</span><span class="n">cf</span><span class="p">)</span> <span class="k">result</span><span class="p">(</span><span class="n">E_IO</span><span class="p">)</span>
  <span class="c">!---------------------------------------------------------------------------------------------------------------------------------</span>
  <span class="k">implicit none</span>
<span class="k">  </span><span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span><span class="kd">::</span>           <span class="n">NC_NN</span>                   <span class="c">!&lt; Number of nodes or cells.</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span><span class="kd">::</span>           <span class="n">dimm</span>                    <span class="c">!&lt; Texture dimensions.</span>
  <span class="kt">character</span><span class="p">(</span><span class="o">*</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span><span class="kd">::</span>           <span class="n">varname</span>                 <span class="c">!&lt; Variable name.</span>
  <span class="kt">real</span><span class="p">(</span><span class="n">R8P</span><span class="p">),</span>    <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span><span class="kd">::</span>           <span class="n">textCoo</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">NC_NN</span><span class="p">,</span><span class="mi">1</span><span class="p">:</span><span class="n">dimm</span><span class="p">)</span> <span class="c">!&lt; Texture.</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">),</span> <span class="k">optional</span><span class="kd">::</span> <span class="n">cf</span>                      <span class="c">!&lt; Current file index (for concurrent files IO).</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">)</span><span class="kd">::</span>                       <span class="n">E_IO</span>              <span class="c">!&lt; Input/Output inquiring flag: $0$ if IO is done, $&gt; 0$ if IO is not done.</span>
  <span class="kt">character</span><span class="p">(</span><span class="nb">len</span><span class="o">=</span><span class="n">maxlen</span><span class="p">)</span><span class="kd">::</span>              <span class="n">s_buffer</span>                <span class="c">!&lt; Buffer string.</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">)</span><span class="kd">::</span>                       <span class="n">rf</span>                      <span class="c">!&lt; Real file index.</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">)</span><span class="kd">::</span>                       <span class="n">n1</span><span class="p">,</span><span class="n">n2</span>                   <span class="c">!&lt; Counters.</span>
  <span class="c">!---------------------------------------------------------------------------------------------------------------------------------</span>

  <span class="c">!---------------------------------------------------------------------------------------------------------------------------------</span>
  <span class="n">E_IO</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1_I4P</span>
  <span class="n">rf</span> <span class="o">=</span> <span class="n">f</span>
  <span class="k">if</span> <span class="p">(</span><span class="nb">present</span><span class="p">(</span><span class="n">cf</span><span class="p">))</span> <span class="k">then</span>
<span class="k">    </span><span class="n">rf</span> <span class="o">=</span> <span class="n">cf</span> <span class="p">;</span> <span class="n">f</span> <span class="o">=</span> <span class="n">cf</span>
  <span class="n">endif</span>
  <span class="k">select case</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">f</span><span class="p">)</span>
  <span class="k">case</span><span class="p">(</span><span class="n">ascii</span><span class="p">)</span>
    <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;(A,1X,&#39;</span><span class="o">//</span><span class="n">FI4P</span><span class="o">//</span><span class="s1">&#39;,1X,A)&#39;</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="s1">&#39;TEXTURE_COORDINATES &#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">varname</span><span class="p">),</span><span class="n">dimm</span><span class="p">,</span><span class="s1">&#39; double&#39;</span>
    <span class="k">write</span><span class="p">(</span><span class="n">s_buffer</span><span class="p">,</span><span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;(I1)&#39;</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="n">dimm</span>
    <span class="n">s_buffer</span><span class="o">=</span><span class="s1">&#39;(&#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">s_buffer</span><span class="p">)</span><span class="o">//</span><span class="n">FR4P</span><span class="o">//</span><span class="s1">&#39;)&#39;</span>
    <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">fmt</span><span class="o">=</span><span class="nb">trim</span><span class="p">(</span><span class="n">s_buffer</span><span class="p">),</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)((</span><span class="n">textCoo</span><span class="p">(</span><span class="n">n1</span><span class="p">,</span><span class="n">n2</span><span class="p">),</span><span class="n">n2</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">dimm</span><span class="p">),</span><span class="n">n1</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">NC_NN</span><span class="p">)</span>
  <span class="k">case</span><span class="p">(</span><span class="n">raw</span><span class="p">)</span>
    <span class="k">write</span><span class="p">(</span><span class="n">s_buffer</span><span class="p">,</span><span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;(A,1X,&#39;</span><span class="o">//</span><span class="n">FI4P</span><span class="o">//</span><span class="s1">&#39;,1X,A)&#39;</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="s1">&#39;TEXTURE_COORDINATES &#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">varname</span><span class="p">),</span><span class="n">dimm</span><span class="p">,</span><span class="s1">&#39; double&#39;</span>
    <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">trim</span><span class="p">(</span><span class="n">s_buffer</span><span class="p">)</span><span class="o">//</span><span class="n">end_rec</span>
    <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)((</span><span class="n">textCoo</span><span class="p">(</span><span class="n">n1</span><span class="p">,</span><span class="n">n2</span><span class="p">),</span><span class="n">n2</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">dimm</span><span class="p">),</span><span class="n">n1</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">NC_NN</span><span class="p">)</span>
    <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="n">end_rec</span>
  <span class="n">endselect</span>
  <span class="k">return</span>
  <span class="c">!---------------------------------------------------------------------------------------------------------------------------------</span>
  <span class="n">endfunction</span> <span class="n">VTK_VAR_TEXT_R8</span>

  <span class="c">!&gt; Function for saving texture variable (R4P).</span>
  <span class="c">!&gt; @return E_IO: integer(I4P) error flag</span>
  <span class="k">function </span><span class="n">VTK_VAR_TEXT_R4</span><span class="p">(</span><span class="n">NC_NN</span><span class="p">,</span><span class="n">dimm</span><span class="p">,</span><span class="n">varname</span><span class="p">,</span><span class="n">textCoo</span><span class="p">,</span><span class="n">cf</span><span class="p">)</span> <span class="k">result</span><span class="p">(</span><span class="n">E_IO</span><span class="p">)</span>
  <span class="c">!---------------------------------------------------------------------------------------------------------------------------------</span>
  <span class="c">!! Function for saving texture variable (R4P).</span>
  <span class="c">!---------------------------------------------------------------------------------------------------------------------------------</span>

  <span class="c">!---------------------------------------------------------------------------------------------------------------------------------</span>
  <span class="k">implicit none</span>
<span class="k">  </span><span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span><span class="kd">::</span>           <span class="n">NC_NN</span>                   <span class="c">!&lt; Number of nodes or cells.</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span><span class="kd">::</span>           <span class="n">dimm</span>                    <span class="c">!&lt; Texture dimensions.</span>
  <span class="kt">character</span><span class="p">(</span><span class="o">*</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span><span class="kd">::</span>           <span class="n">varname</span>                 <span class="c">!&lt; Variable name.</span>
  <span class="kt">real</span><span class="p">(</span><span class="n">R4P</span><span class="p">),</span>    <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span><span class="kd">::</span>           <span class="n">textCoo</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">NC_NN</span><span class="p">,</span><span class="mi">1</span><span class="p">:</span><span class="n">dimm</span><span class="p">)</span> <span class="c">!&lt; Texture.</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">IN</span><span class="p">),</span> <span class="k">optional</span><span class="kd">::</span> <span class="n">cf</span>                      <span class="c">!&lt; Current file index (for concurrent files IO).</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">)</span><span class="kd">::</span>                       <span class="n">E_IO</span>              <span class="c">!&lt; Input/Output inquiring flag: $0$ if IO is done, $&gt; 0$ if IO is not done.</span>
  <span class="kt">character</span><span class="p">(</span><span class="nb">len</span><span class="o">=</span><span class="n">maxlen</span><span class="p">)</span><span class="kd">::</span>              <span class="n">s_buffer</span>                <span class="c">!&lt; Buffer string.</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">)</span><span class="kd">::</span>                       <span class="n">rf</span>                      <span class="c">!&lt; Real file index.</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">)</span><span class="kd">::</span>                       <span class="n">n1</span><span class="p">,</span><span class="n">n2</span>                   <span class="c">!&lt; Counters.</span>
  <span class="c">!---------------------------------------------------------------------------------------------------------------------------------</span>

  <span class="c">!---------------------------------------------------------------------------------------------------------------------------------</span>
  <span class="n">E_IO</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1_I4P</span>
  <span class="n">rf</span> <span class="o">=</span> <span class="n">f</span>
  <span class="k">if</span> <span class="p">(</span><span class="nb">present</span><span class="p">(</span><span class="n">cf</span><span class="p">))</span> <span class="k">then</span>
<span class="k">    </span><span class="n">rf</span> <span class="o">=</span> <span class="n">cf</span> <span class="p">;</span> <span class="n">f</span> <span class="o">=</span> <span class="n">cf</span>
  <span class="n">endif</span>
  <span class="k">select case</span><span class="p">(</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">f</span><span class="p">)</span>
  <span class="k">case</span><span class="p">(</span><span class="n">ascii</span><span class="p">)</span>
    <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;(A,1X,&#39;</span><span class="o">//</span><span class="n">FI4P</span><span class="o">//</span><span class="s1">&#39;,1X,A)&#39;</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="s1">&#39;TEXTURE_COORDINATES &#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">varname</span><span class="p">),</span><span class="n">dimm</span><span class="p">,</span><span class="s1">&#39; float&#39;</span>
    <span class="k">write</span><span class="p">(</span><span class="n">s_buffer</span><span class="p">,</span><span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;(I1)&#39;</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="n">dimm</span>
    <span class="n">s_buffer</span><span class="o">=</span><span class="s1">&#39;(&#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">s_buffer</span><span class="p">)</span><span class="o">//</span><span class="n">FR4P</span><span class="o">//</span><span class="s1">&#39;)&#39;</span>
    <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">fmt</span><span class="o">=</span><span class="nb">trim</span><span class="p">(</span><span class="n">s_buffer</span><span class="p">),</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)((</span><span class="n">textCoo</span><span class="p">(</span><span class="n">n1</span><span class="p">,</span><span class="n">n2</span><span class="p">),</span><span class="n">n2</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">dimm</span><span class="p">),</span><span class="n">n1</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">NC_NN</span><span class="p">)</span>
  <span class="k">case</span><span class="p">(</span><span class="n">raw</span><span class="p">)</span>
    <span class="k">write</span><span class="p">(</span><span class="n">s_buffer</span><span class="p">,</span><span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;(A,1X,&#39;</span><span class="o">//</span><span class="n">FI4P</span><span class="o">//</span><span class="s1">&#39;,1X,A)&#39;</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="s1">&#39;TEXTURE_COORDINATES &#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">varname</span><span class="p">),</span><span class="n">dimm</span><span class="p">,</span><span class="s1">&#39; float&#39;</span>
    <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="nb">trim</span><span class="p">(</span><span class="n">s_buffer</span><span class="p">)</span><span class="o">//</span><span class="n">end_rec</span>
    <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)((</span><span class="n">textCoo</span><span class="p">(</span><span class="n">n1</span><span class="p">,</span><span class="n">n2</span><span class="p">),</span><span class="n">n2</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">dimm</span><span class="p">),</span><span class="n">n1</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">NC_NN</span><span class="p">)</span>
    <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span><span class="n">end_rec</span>
  <span class="n">endselect</span>
  <span class="k">return</span>
  <span class="c">!---------------------------------------------------------------------------------------------------------------------------------</span>
  <span class="n">endfunction</span> <span class="n">VTK_VAR_TEXT_R4</span>
  <span class="c">!&gt; @}</span>

  <span class="c">!&gt;Function for finalizing open file,  it has not inputs, @libvtk manages the file unit without the</span>
  <span class="c">!&gt;user&#39;s action.</span>
  <span class="c">!&gt; @note An example of usage is: \n</span>
  <span class="c">!&gt; @code ...</span>
  <span class="c">!&gt; E_IO=VTK_END()</span>
  <span class="c">!&gt; ... @endcode</span>
  <span class="c">!&gt; @return E_IO: integer(I4P) error flag</span>
  <span class="c">!&gt; @ingroup Lib_VTK_IOPublicProcedure</span>
  <span class="k">function </span><span class="n">VTK_END</span><span class="p">(</span><span class="n">cf</span><span class="p">)</span> <span class="k">result</span><span class="p">(</span><span class="n">E_IO</span><span class="p">)</span>
  <span class="c">!---------------------------------------------------------------------------------------------------------------------------------</span>
  <span class="k">implicit none</span>
<span class="k">  </span><span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">INOUT</span><span class="p">),</span> <span class="k">optional</span><span class="kd">::</span> <span class="n">cf</span>   <span class="c">!&lt; Current file index (for concurrent files IO).</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">)</span><span class="kd">::</span>                          <span class="n">E_IO</span> <span class="c">!&lt; Input/Output inquiring flag: $0$ if IO is done, $&gt; 0$ if IO is not done.</span>
  <span class="kt">integer</span><span class="p">(</span><span class="n">I4P</span><span class="p">)</span><span class="kd">::</span>                          <span class="n">rf</span>   <span class="c">!&lt; Real file index.</span>
  <span class="c">!---------------------------------------------------------------------------------------------------------------------------------</span>

  <span class="c">!---------------------------------------------------------------------------------------------------------------------------------</span>
  <span class="n">E_IO</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1_I4P</span>
  <span class="n">rf</span> <span class="o">=</span> <span class="n">f</span>
  <span class="k">if</span> <span class="p">(</span><span class="nb">present</span><span class="p">(</span><span class="n">cf</span><span class="p">))</span> <span class="k">then</span>
<span class="k">    </span><span class="n">rf</span> <span class="o">=</span> <span class="n">cf</span> <span class="p">;</span> <span class="n">f</span> <span class="o">=</span> <span class="n">cf</span>
  <span class="n">endif</span>
  <span class="k">close</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">vtk</span><span class="p">(</span><span class="n">rf</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">E_IO</span><span class="p">)</span>
  <span class="k">call </span><span class="n">vtk_update</span><span class="p">(</span><span class="n">act</span><span class="o">=</span><span class="s1">&#39;remove&#39;</span><span class="p">,</span><span class="n">cf</span><span class="o">=</span><span class="n">rf</span><span class="p">,</span><span class="n">Nvtk</span><span class="o">=</span><span class="n">Nvtk</span><span class="p">,</span><span class="n">vtk</span><span class="o">=</span><span class="n">vtk</span><span class="p">)</span>
  <span class="n">f</span> <span class="o">=</span> <span class="n">rf</span>
  <span class="k">if</span> <span class="p">(</span><span class="nb">present</span><span class="p">(</span><span class="n">cf</span><span class="p">))</span> <span class="n">cf</span> <span class="o">=</span> <span class="n">rf</span>
  <span class="k">return</span>
  <span class="c">!---------------------------------------------------------------------------------------------------------------------------------</span>
  <span class="n">endfunction</span> <span class="n">VTK_END</span>
<span class="n">endmodule</span> <span class="n">Lib_VTK_IO</span>
</pre></div>

    </div>
  </div>

    <hr>
    <footer>
        <div class="row">
        <div class="col-md-6">&copy; 2015 Lib_VTK_IO was written by Stefano Zaghi. </div>
        <div class="col-md-6"><span class="pull-right">Documentation generated by <a href="https://github.com/cmacmackin/ford">FORD</a>.</span></div>
        </div>
        <br>
    </footer>
    </div> <!-- /container -->


    <!-- Bootstrap core JavaScript
    ================================================== -->
    <!-- Placed at the end of the document so the pages load faster -->
<!--
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
-->
    <script src="../js/bootstrap.min.js"></script>
    <!-- IE10 viewport hack for Surface/desktop Windows 8 bug -->
    <script src="../js/ie10-viewport-bug-workaround.js"></script>

    <!-- MathJax JavaScript
    ================================================== -->
    <!-- Placed at the end of the document so the pages load faster -->
    <script type="text/x-mathjax-config">
      MathJax.Hub.Config({
        TeX: { extensions: ['AMSmath.js','AMSsymbols.js','noErrors.js','noUndefined.js'], equationNumbers: { autoNumber: 'AMS' } },
        jax: ['input/TeX','input/MathML','output/HTML-CSS'],
        extensions: ['tex2jax.js','mml2jax.js','MathMenu.js','MathZoom.js'],
        'HTML-CSS': { 
           styles: { '.MathJax_Display, .MathJax .mo, .MathJax .mi, .MathJax .mn': {color: '#000000 ! important'} }
        }
      });
    </script>
    <script src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
  </body>
</html>